// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("esri/core/declare dojo/_base/lang dojo/Deferred ../support/Field ../support/Raster ../support/PixelBlock ../support/MosaicRule ../support/RasterFunction ../../geometry/Extent ../../geometry/Point ../../geometry/SpatialReference ../../tasks/QueryTask ../../tasks/ImageServiceIdentifyTask ../../tasks/support/ImageServiceIdentifyParameters ../../request ../../Graphic ../../core/lang ../../core/Accessor ../../core/JSONSupport".split(" "),function(r,m,s,u,v,w,t,x,p,y,z,A,B,C,q,D,g,E,F){var G=r(E,
{toJSON:function(){return{bandIds:this.layer.bandIds?this.layer.bandIds.join(","):null,format:this.layer.format,compressionQuality:this.layer.compressionQuality,compressionTolerance:this.layer.compressionTolerance,interpolation:this.layer.interpolation,noData:this.layer.noData,noDataInterpretation:this.layer.noDataInterpretation,mosaicRule:this.layer.mosaicRule?JSON.stringify(this.layer.mosaicRule.toJSON()):null,renderingRule:this.layer.renderingRule?JSON.stringify(this.layer.renderingRule.toJSON()):
null,adjustAspectRatio:this.layer.adjustAspectRatio}}});return r(F,{declaredClass:"esri.layers.mixins.ArcGISImageService",classMetadata:{properties:{version:{readOnly:!0},queryTask:{readOnly:!0},rasterFields:{readOnly:!0},defaultMosaicRule:{readOnly:!0},defaultRenderingRule:{readOnly:!0},pixelData:{}},computed:{parsedUrl:["url"],queryTask:["url"],rasterFields:["fields","rasterAttributeTable","rasterAttributeTableFieldPrefix"],domainFields:["fields"]},reader:{exclude:["id","copyrightText","currentVersion",
"extent","defaultMosaicMethod"],add:"copyright defaultDefinitionExpression version initialExtent fullExtent spatialReference objectIdField defaultMosaicRule defaultRenderingRule mosaicRule renderingRule".split(" ")}},constructor:function(){this._exportImageServiceParameters=new G({layer:this})},_exportImageServiceParameters:null,_raster:null,_rawPixelData:null,copyright:null,_copyrightReader:function(a,b){return b.copyrightText},_fieldsReader:function(a){return a.map(function(a){return new u(a)})},
fullExtent:null,_fullExtentReader:function(a,b){return b.extent&&p.fromJSON(b.extent)},_initialExtentReader:function(a,b){return b.extent&&p.fromJSON(b.extent)},_defaultDefinitionExpressionReader:function(a,b){return b.definitionExpression},_definitionExpressionReader:function(a,b){return this._defaultDefinitionExpressionReader(a,b)},_versionReader:function(a,b){(a=b.currentVersion)||(a=b.hasOwnProperty("fields")||b.hasOwnProperty("objectIdField")||b.hasOwnProperty("timeInfo")?10:9.3);return a},_objectIdFieldReader:function(a,
b){a||b.fields.some(function(b){"esriFieldTypeOID"===b.type&&(a=b.name);return!!a});return a},_spatialReferenceReader:function(a,b){return(a=b.extent&&b.extent.spatialReference)&&z.fromJSON(a)},popupTemplates:null,format:"lerc",compressionTolerance:0.01,rasterAttributeTableFieldPrefix:"Raster.",rasterAttributeTable:null,_rasterFieldsGetter:function(){var a=this.rasterAttributeTableFieldPrefix,b={name:"Raster.ItemPixelValue",alias:"Item Pixel Value",domain:null,editable:!1,length:50,type:"esriFieldTypeString"},
d=this.fields?m.clone(this.fields):[],c=d.length;d[c]={name:"Raster.ServicePixelValue",alias:"Service Pixel Value",domain:null,editable:!1,length:50,type:"esriFieldTypeString"};if(this.capabilities&&-1<this.capabilities.toLowerCase().indexOf("catalog")||this.fields&&0<this.fields.length)d[c+1]=b;if(g.isDefined(this.pixelFilter)&&("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType))d[c+2]={name:"Raster.Magnitude",alias:"Magnitude",
domain:null,editable:!1,type:"esriFieldTypeDouble"},d[c+3]={name:"Raster.Direction",alias:"Direction",domain:null,editable:!1,type:"esriFieldTypeDouble"};if((b=this.rasterAttributeTable&&this.rasterAttributeTable.fields||null)&&0<b.length)b=b.filter(function(a){return"esriFieldTypeOID"!==a.type&&"value"!==a.name.toLowerCase()}).map(function(b){var d=m.clone(b);d.name=a+b.name;return d}),d=d.concat(b);return d},_domainFieldsGetter:function(){return this.fields&&this.fields.filter(function(a){return a.domain})||
[]},_queryTaskGetter:function(){return new A({url:this.url})},_defaultMosaicRuleReader:function(a,b){var d={};b.defaultMosaicMethod?(d.method=b.defaultMosaicMethod,d.operation=b.mosaicOperator,d.sortField=b.sortField,d.sortValue=b.sortValue):d.method=t.METHOD_NONE;a=new t(d);a.ascending=!0;return a},_defaultRenderingRuleReader:function(a,b){var d=b.rasterFunctionInfos;d&&(d.length&&"None"!==d[0].name)&&(a=new x,a.functionName=b.rasterFunctionInfos[0].name);return a},mosaicRule:null,_mosaicRuleReader:function(a,
b){return this._defaultMosaicRuleReader(a,b)},renderingRule:null,_renderingRuleReader:function(a,b){return this._defaultRenderingRuleReader(a,b)},getKeyProperties:function(){return q({url:this.parsedUrl.path+"/keyProperties",content:m.mixin({f:"json"}),handleAs:"json",callbackParamName:"callback"})},getExportImageServiceParameters:function(a){var b=a.extent.shiftCentralMeridian(),d=a.width;a=a.height;var c=b&&b.spatialReference,c=c&&(c.wkid||JSON.stringify(c.toJSON()));return m.mixin({bbox:b&&b.xmin+
","+b.ymin+","+b.xmax+","+b.ymax,bboxSR:c,imageSR:c,size:d+","+a},this._exportImageServiceParameters.toJSON())},queryRasters:function(a){return this.queryTask.execute(a)},queryVisibleRasters:function(a,b){this._visibleRasters=[];var d=!1,c=this.popupTemplate;c&&(c.fieldInfos&&0<c.fieldInfos.length)&&(d=1<c.fieldInfos.length||"raster.servicepixelvalue"!==c.fieldInfos[0].toLowerCase());!d&&this.rasterFields&&(d=this.rasterFields.some(function(a){return(a=a&&a.name?a.name.toLowerCase():null)&&"raster.servicepixelvalue"!==
a&&(c.title&&-1<c.title.toLowerCase().indexOf(a)||c.content&&-1<c.content.toLowerCase().indexOf(a))}));var e=b.layerView,f=(e=e&&e.view&&e.view.state||null)&&0.5*e.resolution,d=new C({geometry:a.geometry,returnCatalogItems:d,timeExtent:a.timeExtent,mosaicRule:this.mosaicRule||null,renderingRule:this.renderingRule||null,returnGeometry:e&&e.spatialReference.equals(this.spatialReference),outSpatialReference:e&&e.spatialReference.clone(),pixelSize:f&&new y(f,f,e.spatialReference)}),k=new s;(new B({url:this.url})).execute(d).then(function(a){k.resolve(this._queryVisibleRasters(a,
b))}.bind(this),function(a){throw Error("Error querying for visible rasters");});return k},_fetchService:function(){return q({url:this.parsedUrl.path,content:m.mixin({f:"json"},this.parsedUrl.query),handleAs:"json",callbackParamName:"callback"}).then(function(a){a._ssl&&(delete a._ssl,this.url=this.url.replace(/^http:/i,"https:"));this.read(a);this._raster=new v(this.url)}.bind(this)).then(function(){if(10<this.version&&this.hasRasterAttributeTable)return q({url:this.parsedUrl.path+"/rasterAttributeTable",
content:{f:"json"},handleAs:"json"}).then(function(a){a&&(a.features&&a.fields)&&this.read({rasterAttributeTable:a})}.bind(this))})},_fetchImage:function(a){if(!g.isDefined(this._raster)||!g.isDefined(a.extent)||!g.isDefined(a.width)||!g.isDefined(a.height))return a=new s,a.reject(Error("Insufficient parameters for requesting an image. A valid extent, width and height values are required.")),a.promise;a={imageServiceParameters:this.getExportImageServiceParameters(a),nBands:Math.min(this.bandCount,
3),pixelType:this.pixelType};return this._raster.read(a,this._fetchImageHandler.bind(this),this._fetchImageErrorHandler.bind(this))},_fetchImageHandler:function(a){this._rawPixelData=a;this._applyFilter(a)},_fetchImageErrorHandler:function(a){if("CancelError"!==a.name)throw Error("Error in requesting image. "+a);},_applyFilter:function(a){a=this._clonePixelData(a);this.pixelFilter&&this.pixelFilter(a);this.pixelData=a},_clonePixelData:function(a){if(null===a||void 0===a)return a;var b={};a.extent&&
(b.extent=a.extent.clone());a=a.pixelBlock;if(null===a||void 0===a)return b;b.pixelBlock=a.clone();return b},_queryVisibleRasters:function(a,b){var d=a.value,c,e,f=0,k,h=this.objectIdField,g;if(a.catalogItems&&a.catalogItems.features){var m=0,l,n;l=0;k=a.catalogItems.features.length;e=[k];c=[k];g=[k];for(f=0;f<k;f++)-1<a.properties.Values[f].toLowerCase().indexOf("nodata")&&l++;l=k-l;for(f=0;f<k;f++)n=-1<a.properties.Values[f].toLowerCase().indexOf("nodata")?l++:m++,e[n]=a.catalogItems.features[f],
c[n]=a.properties.Values[f],g[n]=e[n].attributes[h]}this._visibleRasters=[];f=-1<d.toLowerCase().indexOf("nodata");d&&(!e&&!f)&&(e=[],h=new D(new p(this.fullExtent),null,{ObjectId:0}),e.push(h));g=[];if(!e)return g;m=b&&b.returnDomainValues||!1;f=0;for(k=e.length;f<k;f++)h=e[f],h.popupTemplate=this.popupTemplate,h._layer=this,d&&(l=d,c&&c.length>=f&&(l=c[f],l=l.replace(/ /gi,", ")),h.attributes["Raster.ItemPixelValue"]=l,h.attributes["Raster.ServicePixelValue"]=d,this._updateFeatureWithMagDirValues(h,
l),this._updateFeatureWithRasterAttributeTableValues(h,l)),m&&this._updateFeatureWithDomainValues(h),g.push(h);return g},_updateFeatureWithRasterAttributeTableValues:function(a,b){var d=this.rasterAttributeTable&&this.rasterAttributeTable.features;if(d&&!(1>d.length)&&this.rasterAttributeTableFieldPrefix){var c=null;d.forEach(function(a){a&&a.attributes&&(c=a.attributes.hasOwnProperty("Value")&&a.attributes.Value==b?a:a.attributes.VALUE==b?a:null)});if(c){for(var e in c.attributes)c.attributes.hasOwnProperty(e);
a.attributes=m.mixin(a.attributes,c.attributes)}}},_updateFeatureWithMagDirValues:function(a,b){if(this.pixelFilter&&!("esriImageServiceDataTypeVector-UV"!==this.serviceDataType&&"esriImageServiceDataTypeVector-MagDir"!==this.serviceDataType)){var d=b.replace(" ","").split(","),c=new w({height:1,width:1,pixelType:"F32",pixels:[],statistics:[]});d.forEach(function(a){c.addData({pixels:[a],statistics:{minValue:a,maxValue:a,noDataValue:null}})});this.pixelFilter({pixelBlock:c,extent:new p(0,0,0,0,this.spatialReference)});
a.attributes["Raster.Magnitude"]=c.pixels[0][0];a.attributes["Raster.Direction"]=c.pixels[1][0]}},_updateFeatureWithDomainValues:function(a){var b=this.domainFields;g.isDefined(b)&&b.forEach(function(b){if(b){var c=a.attributes[b.name];g.isDefined(c)&&(c=this._findMatchingDomainValue(b.domain,c),g.isDefined(c)&&(a.attributes[b.name]=c))}},this)},_findMatchingDomainValue:function(a,b){var d=a&&a.codedValues;if(d){var c;d.some(function(a){return a.code===b?(c=a.name,!0):!1});return c}}})});