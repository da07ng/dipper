// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../../../core/declare dojox/gfx dojo/dom-style ./LayerView2D ../../layers/GraphicsLayerView ../../../geometry/support/webMercatorUtils ../VectorGroup ../Vector".split(" "),function(g,h,k,l,m,f,n,p){return g([l,m],{declaredClass:"esri.views.2d.layers.GraphicsLayerView2D",classMetadata:{computed:{graphics:["controller"],needsRedraw:["gfx","view.stationary"]}},constructor:function(a){this._vectors=[];var b=this.container.render;this.container.render=function(a){b.call(this.container,a);this.render()}.bind(this);
this.container.watch("surface",this._surfaceCreateHandler.bind(this));this.watch("needsRedraw,graphics",this.redraw.bind(this))},initialize:function(){this.layer.createGraphicsController({layerView:this}).then(function(a){this.controller=a}.bind(this))},destroy:function(){this.controller&&this.controller.destroy&&this.controller.destroy();this.controller=null},_graphicsGetter:function(a){var b=this.controller&&this.controller.graphicsCollection;if(a===b)return a;a&&(this._colChgHandle.remove(),this._colChgHandle=
null,this.clear());b&&(this.add(b.getAll()),this._colChgHandle=b.on("change",function(a){this.add(a.added);this.remove(a.removed)}.bind(this)));return b},_needsRedrawGetter:function(){return this.group&&this.get("view.stationary")},hitTest:function(a,b){var d=this.container.surface,c=null,e;d&&(e=d.style.zIndex,d.style.zIndex="10000",k.getComputedStyle(d),c=(c=document.elementFromPoint(a,b))&&c.vector&&c.vector.parent===this.group&&c.vector.graphic||null,d.style.zIndex=e);return c},redraw:function(){if(this.needsRedraw&&
!this.suspended){var a=this.get("view.state");this.gfx.setDimensions(a.width,a.height);this.view.stationary&&a.resolution!==this.group.resolution&&(this.group.set({x:a.x,y:a.y,resolution:a.resolution}),this.group.draw(),this.render())}},render:function(){!this.suspended&&this.group&&this.group.applyState(this.get("view.state"))},add:function(a){if(a&&this.group){var b,d=a.length,c,e,f=this.view.extent.spatialReference;for(b=0;b<d;b++)if(c=a[b],e=this.getRenderingInfo(c))this._vectors[c.id]=new p({graphic:c,
symbol:e.symbol,color:e.color,size:e.size,projectedGeometry:this._projectGeometry(c.geometry,f)}),this.group.addVector(this._vectors[c.id]);this.group.draw()}},remove:function(a){if(a){var b,d=a.length,c;for(b=0;b<d;b++)c=a[b],c=this._vectors[c.id],this.group.removeVector(c)}},clear:function(){},_projectGeometry:function(a,b){var d=a&&a.spatialReference,c;d&&(b&&!d.equals(b)&&f.canProject(d,b))&&(c=b.isWebMercator()?f.geographicToWebMercator(a):f.webMercatorToGeographic(a,!0));return c},_surfaceCreateHandler:function(a,
b,d,c){a=this.get("view.state");this.gfx=h.createSurface(this.container.surface,a.width,a.height);this.group=new n({view:this.view,x:a.x,y:a.y,resolution:a.resolution,surface:this.gfx.createGroup(),layer:this.layer});this.graphics&&this.add(this.graphics.getAll());this.render()}})});