// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/ItemPropertiesDlg","dojo/_base/declare dojo/on dojo/dom-attr dojo/query dojo/dom dojo/dom-style dojo/_base/lang dijit/_WidgetBase dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dojo/dom-construct dojo/string dojo/_base/window dojo/promise/all dojo/when dojo/Deferred dojo/_base/array dojo/cookie dojo/dom-class dojo/json dojox/form/Uploader dijit/registry dijit/form/TextBox dijit/ConfirmDialog dijit/focus dgrid/OnDemandGrid dgrid/editor dojo/store/Observable dojo/store/Memory esri/dijit/Tags arcgisonline/sharing/dijit/dialog/_AddItemDlgMixin arcgisonline/sharing/dijit/dialog/_CreateItemUtilMixin dijit/form/SimpleTextarea dijit/form/Select dojo/topic esri/Evented esri/arcgis/Portal arcgisonline/sharing/geow/Account arcgisonline/sharing/util arcgisonline/map/mapUtil arcgisonline/sharing/geow/Folder dojo/i18n!arcgisonline/nls/arcgisonline".split(" "),
function(x,n,p,e,y,I,d,z,A,B,J,K,L,C,M,l,s,t,h,q,N,u,O,P,r,Q,R,S,T,U,D,m,V,W,k,E,v,F,w,G,H,f){return x("arcgisonline.sharing.dijit.dialog.ItemPropertiesDlg",[z,A,B,D,E],{baseClass:"esriItemPropertiesDlg",templateString:'\x3cdiv data-dojo-attach-point\x3d"contentNode"\x3e\x3cp data-dojo-attach-point\x3d"_message"\x3e\x3c/p\x3e\x3cform id\x3d"_createForm" data-dojo-attach-point\x3d"_form" enctype\x3d"multipart/form-data" action\x3d"" method\x3d"POST"\x3e\x3cfieldset\x3e\x3clabel for\x3d"uploader" class\x3d"file"\x3e${i18n.addLayerFromFileDlg.fileLabel}\x3c/label\x3e\x3cdiv data-dojo-attach-point\x3d"_files" class\x3d"file" data-dojo-type\x3d"dojox/form/Uploader" data-dojo-props\x3d\'label:"Browse", name:"file", showInput:"before"\'\x3e\x3c/div\x3e\x3cbr class\x3d"file" /\x3e\x3cdiv data-dojo-attach-point\x3d"_zip" class\x3d"zip esriLeadingMargin80 hide"\x3e\x3clabel for\x3d"archiveSelect"\x3e${i18n.addItemFrm.itemContents}\x3c/label\x3e\x3cselect data-dojo-attach-point\x3d"_zipContents" data-dojo-type\x3d"dijit/form/Select" style\x3d"width:25%;"\x3e\x3coption value\x3d"shapefile" selected\x3e${i18n.addItemFrm.typeShapefile}\x3c/option\x3e\x3coption value\x3d"filegeodatabase"\x3e${i18n.addItemFrm.itemFileGeodatabase}\x3c/option\x3e\x3c/select\x3e\x3c/div\x3e\x3clabel for\x3d"${id}-url" class\x3d"url hide"\x3e${i18n.publishWizard.urlItemLbl}\x3c/label\x3e\x3cdiv id\x3d"${id}-url" class\x3d"required url hide" data-dojo-attach-point\x3d"_url" data-dojo-type\x3d"dijit/form/TextBox" data-dojo-props\x3d\'disabled:true, name:"url", trim:true, placeHolder:"${i18n.addLayerFromUrlDlg.enterUrl}"\'\x3e\x3c/div\x3e\x3cbr class\x3d"url hide" /\x3e\x3clabel for\x3d"${id}-title"\x3e${i18n.publishWizard.titleLbl}\x3c/label\x3e\x3cdiv id\x3d"${id}-title" tabindex\x3d"0" class\x3d"required title" data-dojo-attach-point\x3d"_title" data-dojo-type\x3d"dijit/form/TextBox" data-dojo-props\x3d\'name:"title", trim:true, placeHolder:"${i18n.publishWizard.titlePlaceHolder}"\'\x3e\x3c/div\x3e\x3cbr /\x3e\x3clabel for\x3d"${id}-tags" data-dojo-attach-point\x3d"_tagsDijitLbl" class\x3d"tagsLbl"\x3e${i18n.publishWizard.tagsLbl}\x3c/label\x3e\x3cdiv id\x3d"${id}-tags" tabindex\x3d"0" class\x3d"required" data-dojo-attach-point\x3d"_tagsDijit" data-dojo-type\x3d"esri/dijit/Tags" data-dojo-props\x3d"name: \'tags\', width:\'100%\', minWidth:\'100%\', maxWidth:\'100%\'"\x3e\x3c/div\x3e\x3cbr /\x3e\x3clabel for\x3d"${id}-summary"\x3e${i18n.publishWizard.summaryLbl}\x3c/label\x3e\x3ctextarea id\x3d"${id}-summary" tabindex\x3d"0" class\x3d"required" data-dojo-attach-point\x3d"_summaryDijit" class\x3d"summaryTextBox dijitPlaceHolder" data-dojo-type\x3d"dijit/form/Textarea" data-dojo-props\x3d\'name:"snippet", trim:true, placeHolder:"${i18n.publishWizard.summaryPlaceHolder}", value: "${i18n.publishWizard.summaryPlaceHolder}"\'\x3e\x3c/textarea\x3e\x3cbr /\x3e\x3clabel for\x3d"${id}-folders" data-dojo-attach-point\x3d"_foldersDijitLbl" class\x3d"folderDropdown hide"\x3e${i18n.publishWizard.saveFolderLbl}\x3c/label\x3e\x3cselect id\x3d"${id}-folders" tabindex\x3d"0"  class\x3d"folderDropdown hide" data-dojo-attach-point\x3d"_folders" data-dojo-type\x3d"dijit/form/Select" style\x3d"width:77%;" data-dojo-props\x3d\'maxHeight:"200"\'\x3e\x3c/select\x3e\x3c/fieldset\x3e\x3c/form\x3e\x3c/div\x3e',
onOk:function(){},onCancel:function(){},onLoad:function(){},postMixInProperties:function(){this.inherited(arguments);this._errorDlg=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();this.i18n=d.mixin({},f);this._maxFileSize=1E9;this._analyzeTypes={csv:1};this._type=this.typeInfo;var a=t("ESRI_Content");this._selectedFolderId=(a?q.parse(a):{}).folderId||null},postCreate:function(){this.inherited(arguments);h.add(this._summaryDijit.domNode,"dijitPlaceHolder");var a=this._files.displayInput;
h.add(a,"placeHolder");p.set(a,"value","Select File");F.getSelf(d.hitch(this,function(a){this._loadConnections();this._portal=new v.Portal({url:esriGeowConfig.restBaseUrl,self:a});this._connect=this._portal.on("load",d.hitch(this,function(a){this._connect.remove();this._portalUser=this._portal.getPortalUser();return C([w.loadUserTags(this._portalUser.username),this._getFolders()]).then(d.hitch(this,function(a){a&&a[0]&&this._tagsDijit.set("knownTags",a[0]);this._tagsDijit.set("value",this.item&&this.item.tags||
"");this._summaryDijit.set("value",f.publishWizard.summaryPlaceHolder);this._loadFolders(a[1]&&a[1].folders||[],this._folders);this.onLoad()}))}))}))},destroy:function(){e(".dijit",this.contentNode).map(dijit.byNode).forEach(function(a){a.destroyRecursive?a.destroyRecursive():a.destroy&&a.destroy()});this.inherited(arguments);this._grid&&(this._grid.destroy(),this._grid=null);this._tagsDijit&&(this._tagsDijit.destroyRecursive(),this._tagsDijit=null);this._analyzedFile?m.deleteItem(this._analyzedFile,
this._portal).then(d.hitch(this,function(a){this._tagsDijit=this._portalUser=this._portal=this._analyzedFile=null})):this._tagsDijit=this._portalUser=this._portal=null},addItem:function(){var a=new l,b;this._validate().then(d.hitch(this,function(){k.publish("/esri/disable",!0,f.addItemFrm.addingItem);b=this._analyzedFile?this._updateItem().then(d.hitch(this,function(a){return a})):"webmap"===this._type?this._fetchBaseMap().then(d.hitch(this,function(a){var b=this.get("item");b.text=a?q.stringify(a):
b.text;b.extent=m.getPortalDefaultExtentAsGCS(this._portal);return m.addItem(b,this.get("folder"),this._portal)})):m.addItem(this.showFile?this.get("form"):this.get("item"),this.get("folder"),this._portal);b.then(d.hitch(this,function(b){k.publish("/esri/disable",!1);a.resolve(b)}),d.hitch(this,function(b){k.publish("/esri/disable",!1);b&&409===b.code&&(b=this.get("item"),b={title:f.addItemFrm.errors.error.title,message:esri.substitute({type:b.type,title:b.title},f.addItemFrm.errors.itemExists.message)});
a.reject(b)}))}),d.hitch(this,function(b){k.publish("/esri/disable",!1);a.reject(b)}));return a},_fetchBaseMap:function(){var a=this._portal&&this._portal.defaultBasemap||null,b,c,g,e,f=function(){g=dojo.map(a.baseMapLayers||[],d.hitch(this,function(a,b){c=dojo.clone(a);c=dojo.mixin(c,{opacity:1,layerType:"ArcGISTiledMapServiceLayer",visibility:!0,id:"defaultBasemap_"+b});e=0===b?a.spatialReference||a.resourceInfo&&a.resourceInfo.spatialReference:e;delete c.resourceInfo;return c}));return d.mixin({operationalLayers:[],
spatialReference:e||this._portal&&this.portal.defaultExtent&&this.portal.defaultExtent.spatialReference,baseMap:d.mixin(a,{baseMapLayers:g})},G.getWebMapAuthoringInfo())};a&&a.id?b=v.PortalUtil.request(this._portal.portalUrl+"content/items/"+a.id+"/data").then(d.hitch(this,function(a){return a}),d.hitch(this,function(a){return f()})):a?(b=new l,b.resolve(f())):(b=new l,b.resolve());return b},_loadConnections:function(){this.own(k.subscribe("/esri/disable",d.hitch(this,function(a){this.set("readOnly",
a)})),e(".dijitTextArea",this.contentNode).on("focus",d.hitch(this,function(a){a=this._summaryDijit;a.get("value")===f.publishWizard.summaryPlaceHolder&&(h.remove(a.domNode,"dijitPlaceHolder"),a.set("value",""))})),e(".dijitTextArea",this.contentNode).on("blur",d.hitch(this,function(a){a=this._summaryDijit;""===a.get("value")&&(h.add(a.domNode,"dijitPlaceHolder"),a.set("value",f.publishWizard.summaryPlaceHolder))})),n(this._errorDlg,"hide",d.hitch(this,function(){this._focusNode&&setTimeout(d.hitch(this,
function(){r.focus(this._focusNode)}),250)})),n(this._tagsDijitLbl,"click",dojo.hitch(this,function(a){this._tagsDijit._inputTextBox.focus()})),n(this._tagsDijit.domNode,"focusout",dojo.hitch(this,function(a){dojo.query(".select2-choices",this._tagsDijit.domNode).removeClass("focus")})),n(this._tagsDijit.domNode,"focusin",dojo.hitch(this,function(a){dojo.query(".select2-choices",this._tagsDijit.domNode).addClass("focus");this._tagsDijit._inputTextBox.focus()})),n(this._foldersDijitLbl,"click",dojo.hitch(this,
function(a){this._folders.focus()})))},_setTitleAttr:function(a){return this._title.set("value",a||"")},_getTitleAttr:function(){return this._title.get("value")},_setShowFileAttr:function(a){a||(e(".file",this.contentNode).style("display","none"),e(".dijitUploader input",this.contentNode).attr("disabled","disabled"),this._files.set("disabled",!0))},_setShowUrlAttr:function(a){a&&(e(".url",this.contentNode).removeClass("hide"),this._url.set("disabled",!1))},_setShowFoldersAttr:function(a){e(".folderDropdown",
this.domNode)[a?"removeClass":"addClass"]("hide")},_setMessageAttr:{node:"_message",type:"innerHTML"},_setTypeAttr:function(a){p.set(this._type,"value",a)},_setTagsAttr:function(a){this._tagsDijit.set("value",a||"")},_setSummaryAttr:function(a){h[a?"remove":"add"](this._summaryDijit.domNode,"dijitPlaceHolder");this._summaryDijit.set("value",a||f.publishWizard.summaryPlaceHolder);this._summaryDijit.resize()},_setBatchGeocodersAttr:function(a){this._geocoders.set("options",a);this._geocoders.set("value",
a[0].value,!1);this._batchGeocoders=a;this._selectedGeocoder=a[0]},_setFocusAttr:function(a){var b,c=u.byId(this.id+"-"+a);c?setTimeout(d.hitch(this,function(){c.focus()}),250):(b=e(a,this.domNode),setTimeout(d.hitch(this,function(){r.focus(b&&b.length?b[0]:this._title.domNode)}),250))},_setDisabledAttr:function(a){this._disable(a)},_setReadOnlyAttr:function(a){e(".dijit",this.domNode).map(dijit.byNode).forEach(function(b){b.set("readOnly",a)});e(".dijitButtonContents",this._files.domNode).forEach(function(b){p.set(b,
"readonly",a);h[a?"add":"remove"](b,"dijitDisabled dijitTextBoxDisabled")});h[a?"add":"remove"](this._tagsDijit.domNode,"dijitDisabled dijitTextBoxDisabled");e("input",this._tagsDijit.domNode).forEach(function(b){p.set(b,"readonly",a)});e("a",this.contentNode)[a?"addClass":"removeClass"]("disabledLink");e(".dijitSelect .dijitButtonText",this.contentNode)[a?"addClass":"removeClass"]("dijitTextBoxDisabled");this._folders.set("disabled",a);this._summaryDijit.set("disabled",a);e(".dijitUploader input",
this.contentNode).attr("readonly","readonly")},_getFormAttr:function(){var a=this._checkThumbnailURL(this.itemInfo[this._type]),b=dojo.create("div",null,this._form),a=dojo.mixin(a,{tags:this._tagsDijit.get("tags"),snippet:this._summaryDijit.get("value")!==f.publishWizard.summaryPlaceHolder?this._summaryDijit.get("value"):""}),c;for(c in a)dojo.place(dojo.create("input",{name:c,type:"text",value:a[c],"class":"hide"}),b);return y.byId("_createForm")},_getItemAttr:function(){var a=this._checkThumbnailURL(this.itemInfo[this._type]);
return d.mixin(a,{title:this._title.get("value"),tags:this._tagsDijit.get("tags"),snippet:this._summaryDijit.get("value")!==f.publishWizard.summaryPlaceHolder?this._summaryDijit.get("value"):"",folderId:this.get("folder")})},_getFolderAttr:function(){return!this.showFolders?this._selectedFolderId:"/"==this._folders.get("value")?null:this._folders.get("value")},_getFolders:function(){var a=new l;H.getFolders(d.hitch(this,function(b){a.resolve(b)}),d.hitch(this,function(b){a.reject(b)}),!1);return a},
_getFileInfo:function(a){var b=new l,c=/(?:\.([^.]+))?$/;a=a&&a.length&&a[0]||{};var g=a.name.replace(/^.*(\\|\/|:)/,""),c=g?c.exec(g)[1].toLowerCase():"",e=g?g.substring(0,g.lastIndexOf(".")):"";this._isValidFileType(c)||b.reject(f.addItemFrm.errors.unknownType);window&&window.FileReader&&a.size>this._maxFileSize&&b.reject(f.addItemFrm.errors.fileToLarge);b.resolve(d.mixin(a,{title:e,fileType:c,origName:g}));return b},_deleteAnalyzedFile:function(){var a;this._analyzedFile?a=m.deleteItem(this._analyzedFile,
this._portal).then(d.hitch(this,function(){this._analyzeResult=this._analyzedFile=null})):(a=new l,a.resolve(!0));return a},_toOptions:function(a,b){var c=[];b&&(a=d.mixin({},f.addItemFrm.notUsed,a));for(var g in a)c.push({label:a[g],value:g});return c},_addFile:function(){var a=this.get("form");if(a)return a=m.addItem(a,this.get("folder"),this._portal),a.then(dojo.hitch(this,function(a){k.publish("/esri/disable",!1);return a}),dojo.hitch(this,function(a){k.publish("/esri/disable",!1);this._showError(a)}))},
_updateItem:function(){var a=this._analyzedFile,b=this.get("item"),c=!1,g;for(g in b)!a[g]||a[g]!==b[g]?c=!0:delete b[g];c?b=m.updateItem(d.mixin(b,{id:a.id,folderId:a.folderId}),this._portal).then(d.hitch(this,function(b){return d.mixin(a,b)})):(b=new l,b.resolve(a));return b},_getPublishParameters:function(a){var b=this._geocoder||"none";a=this._getDefaultPublishParameters(a);var c=this._analyzeResult&&this._analyzeResult.publishParameters,d=c&&c.standardizedFieldNames,e=this._grid&&this._grid.store;
if(c)if("addressTypes"===b){var f=0,l={},k=d;e.query(function(a){"unknown"!==a.locationType&&a.locationType in k&&(l[a.locationType]=a.name,f++)});if(1>f)return{error:this.i18n.errors.noAddressFields};a.publishParameters.locationType="address";a.publishParameters.addressFields=l}else if("locationTypes"===b){var h={locationType:"coordinates",latitudeFieldName:null,longitudeFieldName:null},k=dojo.mixin({},this.i18n.addItemFrm[b]);e.query(function(a){"unknown"!==a.locationType&&a.locationType in k&&
(h[a.locationType+"FieldName"]=a.name)});if(!h.latitudeFieldName||!h.longitudeFieldName)return{error:this.i18n.errors.noLocationFields};dojo.mixin(a,h)}else a.publishParameters.locationType="none";return a},_getDefaultPublishParameters:function(a){var b=a.type.toLowerCase(),c={itemId:a.id,filetype:b},d=this._analyzeResult&&this._analyzeResult.publishParameters;"tile package"===b&&(c.filetype="tilePackage",c.buildInitialCache=!0);c.publishParameters=dojo.mixin(d||{},{name:a.title.replace(/ /g,"_"),
maxRecordCount:2E3});d&&(c.hasStaticData=!0,c.publishParameters.layerInfo=dojo.mixin(d.layerInfo||{},{capabilities:"Query"}),c.publishParameters.persistErrorRecordsForReview=!0);return c},_analyze:function(){var a={};k.publish("/esri/disable",!0,"Uploading file...");return this._addFile().then(d.hitch(this,function(b){k.publish("/esri/disable",!0,"Analyzing file...");this._analyzedFile=b;this._portal._isPortal||!this._selectedGeocoder.isWorldGeocodeServer?a.geocodeServiceUrl=encodeURI(this._selectedGeocoder):
this._selectedGeocoder.isWorldGeocodeServer&&(a.sourceCountry=this._analyzeResult?this._countries.get("value").toLowerCase():"",a.sourceCountryHint=this._analyzeResult?"":this._sourceCountry);return m.analyzeItem(b,a,this._portal).then(d.hitch(this,function(a){this._analyzeResult=this._analyzedFile.analyzeResult=a;this._createGrid(a);h.remove(this.geocoding,"hide");k.publish("/esri/disable",!1);return this._analyzedFile}))}))},_validate:function(){var a=new l,b;b=this._itemExists(this.get("item"));
b=b.then(d.hitch(this,"_checkRequired"));b=b.then(d.hitch(this,function(b){a.resolve(b)}),d.hitch(this,function(b){this._focusNode&&r.focus(this._focusNode);a.reject(b)}));return a},_isValidFileType:function(a){var b=!0;this.showFile&&this.validTypes?(this.validTypes=this.validTypes instanceof Array?this.validTypes:[this.validTypes],-1===s.indexOf(this.validTypes,a)&&(b=!1)):this.itemInfo[type.toLowerCase()]||(b=!1);return b},_checkThumbnailURL:function(a){a.thumbnailURL&&(a.thumbnailURL=w.getStaticImagesUrl()+
a.thumbnailURL);this._portal.isPortal&&(a.thumbnailURL&&!a.thumbnailURL.startsWith("http"))&&(a.thumbnailURL=window.location.protocol+"//"+window.location.host+a.thumbnailURL);return a},_isEmpty:function(a){return(this.trim?/^\s*$/:/^$/).test(a)},_disable:function(a){this._folders.set("disabled",a);this._summaryDijit.set("disabled",a);!this.showFiles&&a&&e(".dijitUploader input",this.contentNode).attr("disabled","disabled")},_loadFolders:function(a,b){var c=t("ESRI_Content"),c=c?q.parse(c):{},d=c.folderId||
null;this._selectedFolderId=c.folderId||null;a.unshift({title:this._portalUser.username,id:"/"});b.options=s.map(a,"return {label:item.title, value:item.id};");b.set("value",d||this._portalUser.username)},_loadCountries:function(a,b){var c=this._portal.getPortalUser(),d=[],c=(this._portal.region||c.region||portal.ipCntryCode||"world").toLowerCase(),c="wo"===c?"world":c,e;for(e in a)d.push({label:a[e],value:e.toLowerCase()});d=d.sort(function(a,b){return a.label<b.label?-1:a.label>b.label?1:0});b.set("options",
d);b.set("value",c,!1);this._sourceCountry=c},_checkRequired:function(){var a=new l,b,c;e(".required",this.contentNode).map(u.byNode).every(d.hitch(this,function(a){return!h.contains(a.domNode,"hide")&&this._isEmpty(a.get("value"))?(c=a.domNode||a,this._focusNode=e("input",c)[0],b=d.mixin({},f.publishWizard.errors.error,f.publishWizard.errors.required[a.get("name")]),!1):!0}));b?a.reject(b):a.resolve(!0);return a},_itemExists:function(a){var b=new l,c=this.existingItems||[],d="mapserver"===this._type||
"featureserver"===this._type?/[.@#%&*+=\-\\';,\/|\\":<>\?]/g.test(a.title):!1,h=this.itemInfo[a.type.toLowerCase()]?this.itemInfo[a.type.toLowerCase()].type:a.type,c=dojo.filter(c,function(b){b.item=b.name||b.title;a.item=(a.name?a.name.replace(" ","_"):a.name)||a.title||a.url;return b.type===h&&(b.name===a.item||b.item===a.item||b.title===a.title)&&b.ownerFolder===a.folderId});d?(this._focusNode=e("input",this._title.domNode)[0],b.reject(f.addItemFrm.errors.invalidServiceTitle)):c&&c.length?(this._focusNode=
e("input",this._title.domNode)[0],d=esri.substitute({type:c[0].type,item:a.item,title:c[0].title},f.addItemFrm.errors.itemExists.message),b.reject({title:f.addItemFrm.errors.error.title,message:d})):b.resolve(!1);return b},_showError:function(a){a=d.mixin(d.mixin({},f.publishWizard.errors.error),a);this._errorDlg.show(a);this._disable(!1);return!1}})});