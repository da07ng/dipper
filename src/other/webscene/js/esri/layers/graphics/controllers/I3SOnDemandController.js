// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../../../core/declare dojo/promise/all ../../../views/3d/support/ResourceController ../../../views/3d/support/PreallocArray ../../../geometry/SpatialReference ../../../views/3d/layers/i3s/I3SNodeLoader ../../../views/3d/layers/i3s/I3SIndexTraversal ../../../views/3d/layers/i3s/I3SUtil ../../../views/3d/layers/i3s/I3SLodHandling ../../../core/Accessor ../../../core/Evented ../../../core/Promise ../../../views/3d/support/PromiseLightweight ../../../views/3d/support/projectionUtils ../../../views/3d/lib/glMatrix".split(" "),
function(n,p,q,r,l,s,t,h,u,v,w,x,y,z,m){var g=m.vec3d,A=m.vec3;return n([v,w,x],{constructor:function(a){this._nodeIndex={};this._animFrameFunctionQueue=[[],[]];this.updateEventListener={needsUpdate:this._needsAnimationFrameHandler.bind(this),idleFrame:this._animationFrameHandler.bind(this),idleBegin:this._startNodeLoading.bind(this),idleEnd:this.cancelNodeLoading.bind(this)};this.updateEventListenerWhileSuspended={idleBegin:this._startNodeLoadingWhileSuspended.bind(this)};this._lodHandling=new u},
initialize:function(){this.layerView._controller=this;this._streamDataSupplier=this.layerView.view.resourceController.registerClient(this,q.ClientType.SCENE,this.addUrlTokenFunction);var a=p([this.layer,this.layerView]).then(function(){this.graphicsSource=this.layer.graphicsSource;this._layerViewHandles=[this.layerView.on("suspend",function(a){a.target.view.resourceController.deregisterIdleFrameWorker(this);this.updateEventListener.idleEnd();a.target.view.resourceController.registerIdleFrameWorker(this,
this.updateEventListenerWhileSuspended);null!=a.target.setVisibility&&a.target.setVisibility(!1)}.bind(this)),this.layerView.on("resume",function(a){null!=a.target.setVisibility&&a.target.setVisibility(!0);a.target.view.resourceController.deregisterIdleFrameWorker(this);a.target.view.resourceController.registerIdleFrameWorker(this,this.updateEventListener);this.updateEventListener.idleBegin()}.bind(this))];this.layerView.suspended?this.layerView.view.resourceController.registerIdleFrameWorker(this,
this.updateEventListenerWhileSuspended):(null!=this.layerView.setVisibility&&this.layerView.setVisibility(!0),this.layerView.view.resourceController.registerIdleFrameWorker(this,this.updateEventListener));this._clippingAreaChangedHandles=[this.layerView.view.watch("clippingArea",this._clippingAreaChanged.bind(this))];this._clippingAreaChanged();this.layerViewOptionalFunctions.traversalOptions.elevationInfo&&this._basemapTerrainChangeHandler()}.bind(this));this.addResolvingPromise(a)},destroy:function(){this.layerView.view.resourceController.deregisterIdleFrameWorker(this);
this.layerView.view.resourceController.deregisterClient(this.layerView);this._removeHandles(this._layerViewHandles);this._removeHandles(this._requiredAttributesChangedHandles);this._removeHandles(this._clippingAreaChangedHandles);this._removeHandles(this._elevationHandles);this._nodeIndex=this._nodeLoader=this._streamDataSupplier=null},updateEventListener:null,updateEventListenerWhileSuspended:null,_lodHandling:null,_nodeIndex:null,_numNodesLoading:0,_progressMaxNumNodes:1,_animFrameFunctionQueue:null,
_nodeLoader:null,_crsVertex:null,_crsIndex:null,_camPos:null,_screenSizeFactor:null,_defaultGeometrySchema:null,_rootNodeUrl:null,_poi:null,_requiredAttributes:null,_layerViewHandles:[],_requiredAttributesChangedHandles:[],_clippingAreaChangedHandles:[],_elevationHandles:[],_elevationUpdateNodes:null,_clippingArea:null,_updatesDisabled:!1,_removeHandles:function(a){a&&(a.forEach(function(a){a.remove()}),a.length=0)},_isMeshPyramid:null,_isMeshPyramidGetter:function(){return this._isMeshPyramid},_streamDataSupplier:null,
_streamDataSupplierGetter:function(){return this._streamDataSupplier},_crsVertexGetter:function(){return this._crsVertex},_crsIndexGetter:function(){return this._crsIndex},_camPosGetter:function(){return this._camPos},_nodeIndexGetter:function(){return this._nodeIndex},_screenSizeFactorGetter:function(){return this._screenSizeFactor},_modifyNumNodesLoading:function(a){this._numNodesLoading+=a},_getRequiredAttributes:function(){if(null==this._attributeStorageInfo||!this._fields)return[];var a=Object.create(null);
this.layer.renderer&&this.layer.renderer.collectRequiredFields(a);this.layer.showLabels&&this.layer.labelingInfo&&this.layer.labelingInfo.forEach(function(b){b.collectRequiredFields(a)});var b=this._attributeStorageInfo,d=this._fields;return Object.keys(a).map(function(a){var f=b.findIndex(function(b){return b.name===a}),e=d.find(function(b){return b.name===a});return{index:f,name:a,field:e,attributeStorageInfo:b[f]}}).filter(function(a){return-1!==a.index&&null!=a.field})},_rendererChanged:function(){var a=
this._getRequiredAttributes();this.cancelNodeLoading();this._requiredAttributes=a;this._startNodeLoading()},_showLabelsChanged:function(){var a=this._getRequiredAttributes(),b=!0;a.length==this._requiredAttributes.length&&(b=!this._requiredAttributes.every(function(b){return a.find(function(a){return b.name===a.name})}));b&&(this.cancelNodeLoading(),this._requiredAttributes=a,this._startNodeLoading())},_labelingInfoChanged:function(){},_clippingAreaChanged:function(){var a=[];z.extentToBoundingBox(this.layerView.view.clippingArea,
a,this.layerView.view.renderSpatialReference)?this._clippingArea=a:this._clippingArea=null;this.cancelNodeLoading();this._startNodeLoading()},_basemapTerrainChangeHandler:function(){this._removeHandles(this._elevationHandles);this._elevationHandles.push(this.layerView.view.watch("basemapTerrain",this._basemapTerrainChangeHandler.bind(this)));null!=this.layerView.view.basemapTerrain&&this._elevationHandles.push(this.layerView.view.basemapTerrain.on("elevation-change",this._elevationUpdateHandler.bind(this)))},
_elevationUpdateHandler:function(a){a=[a.extent[0],a.extent[1],-Infinity,a.extent[2],a.extent[3],Infinity];var b=this.layerView.view.basemapTerrain.spatialReference;null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=new r(10));var d=this._elevationUpdateNodes;d.clear();h.findIntersectingNodes(a,b,this.nodeIndex.root,this._crsIndex,this.nodeIndex,d);for(var c=this.layerViewOptionalFunctions.nodeElevationUpdate,f=d.length,e=0;e<f;e++){var k=d.data[e];k.computedMbs&&(k.computedMbs[3]=-1);
c&&c(k.id,a,b)}this.cancelNodeLoading();this._startNodeLoading()},queueAnimationFrameFunctionCall:function(a,b,d,c,f){null!=this._nodeLoader&&this._animFrameFunctionQueue[f||0].push({fct:a,that:b,args:d,cancelFunc:c})},getBaseUrl:function(){return h.addTrailingSlash(this.layer.url)},_needsAnimationFrameHandler:function(){return!0},_animationFrameHandler:function(a){if(!(null==this._nodeLoader||this.layerViewOptionalFunctions.areUpdatesDisabled&&!0===this.layerViewOptionalFunctions.areUpdatesDisabled())){for(var b;0<
this._animFrameFunctionQueue[0].length&&!a.done();)b=this._animFrameFunctionQueue[0].shift(),b.fct.apply(b.that,b.args);b=5-this._numNodesLoading;for(null!=this._indexLoader&&0<b&&this._indexLoader.continueTraversal(b);0<this._animFrameFunctionQueue[1].length&&!a.done();)b=this._animFrameFunctionQueue[1].shift(),b.fct.apply(b.that,b.args);this._evaluateUpdating();this._lodHandling.lodGlobalHandling()}},_evaluateUpdating:function(){var a=null!=this._indexLoader?this._indexLoader.getQueueSize()+3*this._numNodesLoading:
0,b=0<a;0===a&&(this._progressMaxNumNodes=1);this._progressMaxNumNodes=Math.max(a,this._progressMaxNumNodes);this.layerView.updating!==b&&(this.layerView.updating=b);a=100*a/this._progressMaxNumNodes;this.layerView.updatingPercentage!==a&&(this.layerView.updatingPercentage=a)},_initViewData:function(){if(null==this._crsIndex||null==this._isMeshPyramid){var a=this.layer;this._isMeshPyramid="MeshPyramid"===a.store.lodType;this._defaultGeometrySchema=a.store.defaultGeometrySchema;this._fields=a.fields;
this._attributeStorageInfo=a.attributeStorageInfo;this._rootNodeUrl=a.store.rootNode;null==a.store.indexCRS&&null==a.store.geographicCRS&&this.warningEvent("Input data invalid: layer.store.indexCRS is undefined.",1);null==a.store.vertexCRS&&null==a.store.projectedCRS&&this.warningEvent("Input data invalid: layer.store.vertexCRS is undefined.",1);this._crsIndex=new l(h.extractWkid(a.store.indexCRS||a.store.geographicCRS));this._crsVertex=new l(h.extractWkid(a.store.vertexCRS||a.store.projectedCRS));
this._crsIndex.equals(a.spatialReference)&&(this._crsIndex=a.spatialReference);this._crsVertex.equals(a.spatialReference)&&(this._crsVertex=a.spatialReference)}a=this.layerView.view.navigation.targetCamera;this._camPos=a.eye;this._screenSizeFactor=1/a.perPixelRatio;this._poi=g.create();var b=g.create();g.subtract(a.center,a.eye,b);g.normalize(b);b=Math.acos(g.dot(a.center,b)/g.length(a.center))-0.5*Math.PI;A.lerp(a.eye,a.center,Math.max(0,Math.min(1,b/(0.5*Math.PI))),this._poi);b=this.layerViewOptionalFunctions.traversalOptions.elevationInfo;
this._viewportQueries=new h.ViewportQueries(this._crsIndex,this.layerView.view.renderCoordsHelper,a,25E7,this._clippingArea,!1,void 0,void 0,void 0,1,null!=this.layerViewOptionalFunctions.traversalOptions?this.layerViewOptionalFunctions.traversalOptions.errorMetricToUse:null,b?this.layerView.view.basemapTerrain:null,b)},_startNodeLoadingWhileSuspended:function(){this._initViewData();this._removeInvisibleNodes()},warningEvent:function(a,b){this.emit("i3s-load-log",{type:1===b?"fatal":"warning",msg:a});
console.warn("i3s-load-log warningEvent severity "+b," message "+a)},_startNodeLoading:function(){if(!this._updatesDisabled&&null!=this._streamDataSupplier){this._initViewData();var a=null!=this.layerViewOptionalFunctions.getTexturePrefetchFunctions?this.layerViewOptionalFunctions.getTexturePrefetchFunctions():void 0,b=this.isMeshPyramid&&null!=this._defaultGeometrySchema&&null!=this._defaultGeometrySchema.ordering;null!=this.layerViewOptionalFunctions.getLoadedAttributes&&null==this._requiredAttributes&&
(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesChangedHandles=[this.layer.watch("renderer",this._rendererChanged.bind(this)),this.layer.watch("showLabels",this._showLabelsChanged.bind(this)),this.layer.watch("labelingInfo",this._labelingInfoChanged.bind(this))]);this._nodeLoader=new s(this._streamDataSupplier,this._bundleLoadedCallback.bind(this),this.getBaseUrl(),this.queueAnimationFrameFunctionCall.bind(this),void 0,this.layerView.view.renderCoordsHelper,this._crsIndex,
a?a._calcDesiredTextureLOD:void 0,a?a._imageIsPartOfTextureBundle:void 0,a?a._matId2Meta:void 0,a?a._texId2Meta:void 0,a?a.useCompressedTextures:void 0,this.warningEvent,this._defaultGeometrySchema,this._requiredAttributes,b);a=this._rootNodeUrl.split("/");a=a[a.length-1];this._indexLoader=new t(this.getBaseUrl(),this._rootNodeUrl,a,this._poi,this._nodeIndex,this._streamDataSupplier,this._viewportQueries,this._processNodeIndexDocument.bind(this),this._lodHandling.finishedLevel.bind(this._lodHandling),
this.layerViewOptionalFunctions._nodeDebugVisualizer,this.warningEvent,this.layer._addTrailingSlash,this.layerViewOptionalFunctions.traversalOptions);this._indexLoader.start();var b=this._removeInvisibleNodes(),d=null!=this.layerViewOptionalFunctions.traversalOptions&&!0===this.layerViewOptionalFunctions.traversalOptions.perLevelTraversal?"perLevel":this._isMeshPyramid?"global":"swap";this._lodHandling.startNodeLoading(this.layerViewRequiredFunctions,this.layerViewOptionalFunctions,this._indexLoader.nodeIsVisible.bind(this._indexLoader),
this._indexLoader.nodeTraversalState.bind(this._indexLoader),d,this._nodeIndex,b,a);this.layerViewOptionalFunctions.additionalStartNodeLoadingHandler&&this.layerViewOptionalFunctions.additionalStartNodeLoadingHandler();this._evaluateUpdating()}},isNodeLoading:function(){return null!=this._nodeLoader&&null!=this._indexLoader},cancelNodeLoading:function(){if(this.isNodeLoading()){this._indexLoader.cancel();this._nodeLoader.cancel();this._streamDataSupplier.cancelRequestsBulk(this._streamDataSupplier.getRequestedURLs());
for(var a=0;a<this._animFrameFunctionQueue.length;a++)for(var b=0;b<this._animFrameFunctionQueue[a].length;b++)void 0!==this._animFrameFunctionQueue[a][b].cancelFunc&&this._animFrameFunctionQueue[a][b].cancelFunc();this._numNodesLoading=0;this._animFrameFunctionQueue=[[],[]];this._indexLoader=this._nodeLoader=void 0;this._lodHandling.cancelNodeLoading();this.layerViewOptionalFunctions.additionalCancelNodeLoadingHandler&&this.layerViewOptionalFunctions.additionalCancelNodeLoadingHandler();this._evaluateUpdating()}},
_removeInvisibleNodes:function(){var a={},b=this._viewportQueries.isNodeVisible,d;for(d in this._nodeIndex)if(this._nodeIndex.hasOwnProperty(d)){var c=this._nodeIndex[d];null!=this.layerViewRequiredFunctions.getAddedFeatures(c.id)&&(!1===b(c)?this._removeNodeData(c):a[d]=c)}return a},_removeNodeData:function(a){this._lodHandling.setLodGlobalDirty();this.layerViewRequiredFunctions.removeNodeData(a);delete this._nodeIndex[a.id]},_processNodeIndexDocument:function(a,b){var d=new y.Promise;if(null!=a.featureData&&
0<a.featureData.length)if(this.layerViewRequiredFunctions.areAllBundlesLoaded(a,!0)){var c=this.layerViewOptionalFunctions.getLoadedAttributes,c=null!=c?c(a):void 0;null!=c&&c!==this._requiredAttributes&&(c=h.getNodeURL(this.getBaseUrl(),a.id),this._nodeLoader.loadAttributes(a,c,this._requiredAttributes).then(function(b){this.layerViewOptionalFunctions.setAttributeData(a,this._requiredAttributes,b)}.bind(this),function(b){this.layerViewOptionalFunctions.setAttributeData(a,this._requiredAttributes,
{})}.bind(this)));this._lodHandling.shouldLoadNode(a,b)&&(c=this._lodHandling.lodSwapBuildInfoForNode(a))&&null==c.swapPairs&&this._lodHandling.lodSwapBundleLoaded(a,null,c)}else if(this._lodHandling.shouldLoadNode(a,b)){c=this._lodHandling.lodSwapBuildInfoForNode(a);if(this.layerViewRequiredFunctions.isOverMemory())return d.done(),!1;this._modifyNumNodesLoading(1);for(var f=[],e=0;e<a.featureData.length;e++){var k=this.layerViewRequiredFunctions.isBundleAlreadyAddedToStage(a,e),g=k.wasPartiallyHidden;
(!k.alreadyLoaded||g)&&f.push(e)}this.queueAnimationFrameFunctionCall(this._nodeLoader.loadNodeData,this._nodeLoader,[a,f,d,null!=this.layerViewOptionalFunctions.getTexturePrefetchFunctions,c],void 0,1);d.then(function(){this._modifyNumNodesLoading(-1)}.bind(this),function(){this._modifyNumNodesLoading(-1)}.bind(this));return d}d.done();return d},_bundleLoadedCallback:function(a,b,d,c,f,e,g,h){this._lodHandling.lodSwapBundleLoaded(a,b,h);this.layerViewRequiredFunctions.addBundle(a,b,d,c,f,e,g);null!=
this.layerViewOptionalFunctions.setPolygonOffset&&(b=this._lodHandling.shouldSetPolygonOffset(a))&&this.layerViewOptionalFunctions.setPolygonOffset(a,b)}})});