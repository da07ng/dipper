// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/save_open",["dijit","dojo","dojox","dojo/require!arcgisonline/map/main"],function(x,e,y){e.provide("arcgisonline.map.save_open");e.require("arcgisonline.map.main");arcgisonline.map.save_open={webMapInfo:null,webMapItemCard:null,itemCard:null,basemapWebMap:null,openedWebMap:null,folderTitle:null,folderId:null,itemCards:{},basemapSwitchInterval:null,openServiceItemCards:function(a,d){var c=a.split(","),f=e.map(c,function(a){return arcgisonline.map.save_open.openServiceItemCard(a)}),
g=!1;(new e.DeferredList(f)).addCallback(function(a){var b=null,f=null,n=0;e.forEach(c,function(c,d){var e=a[d][1];if((arcgisonline.map.save_open.itemCards[e.id]=e)&&(e.url||"KML"===e.type||"Feature Collection"===e.type||"Vector Tile Service"===e.type))if("WMS"==e.type&&(g=!0),e.url&&-1<e.url.indexOf("/MapServer?ts\x3d")&&(e.url=e.url.substring(0,e.url.indexOf("?ts\x3d"))),f=e,n++,null!=e.extent&&(arcgisonline.map.main.itemCardExtentValid(e.extent)&&(e=new esri.geometry.Extent(e.extent[0][0],e.extent[0][1],
e.extent[1][0],e.extent[1][1],new esri.SpatialReference({wkid:4326})),b=null==b?e:b.union(e)),null==b&&(b=arcgisonline.map.main.map.extent,!b||isNaN(b.xmin)||isNaN(b.ymin)||isNaN(b.xmax)||isNaN(b.ymax))))b=arcgisonline.map.main.defaultExtent});1<n&&(f=null);null==b&&!arcgisonline.map.main.mapInitialized&&arcgisonline.map.main.initMap();n=arcgisonline.map.main.numOperationalLayers();0==n&&(null!=f&&d)&&(arcgisonline.map.save_open.itemCard=f);g?arcgisonline.map.save_open.openServices(c,a):b&&arcgisonline.map.main.projectToMapAndZoom(b,
0,0,e.hitch(this,function(){arcgisonline.map.save_open.openServices(c,a,1===c.length)}))})},openServiceItemCard:function(a,d){return arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+a,null,e.hitch(this,function(a,d){console.log(a);e.publish("layerAddFailed",[]);setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.layerFailedToLoad})},
5E3)}))},openServices:function(a,d,c){for(var f=arcgisonline.sharing.util.getUser(),g=f&&f.accountId,f=[],h=0;h<a.length;h++){var b=d[h][1];!arcgisonline.map.role.isAllowed("add_require_credits")&&-1<e.indexOf(b.typeKeywords,"Requires Credits")||!arcgisonline.map.role.isAllowed("add_require_subscription")&&-1<e.indexOf(b.typeKeywords,"Requires Subscription")?setTimeout(e.hitch(this,function(a){e.publish("layerAddFailed",[]);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:e.string.substitute(g?esri.i18nBundle.viewer.error.missingPermissionsForItem:esri.i18nBundle.viewer.error.missingPermissionsForItemNonOrg,{title:a})})},b.title),5E3):(b.url||"KML"===b.type||"Feature Collection"===b.type||"Vector Tile Service"===b.type)&&b.extent&&f.push(e.hitch(arcgisonline.map.save_open,"openService",b,1===a.length,c))}0<f.length&&arcgisonline.map.layer.waitForServiceResponse(f)},openService:function(a,d,c){var e={title:a.title,snippet:a.snippet,extent:a.extent,description:a.description,
itemId:a.id,itemCard:a};"WMS"===a.type?arcgisonline.map.wms.addWMSItem(a):"KML"===a.type?arcgisonline.map.kml.addKMLItem(a):"Feature Collection"===a.type?arcgisonline.map.featColl.addFeatureCollectionItem(a):"Vector Tile Service"===a.type?arcgisonline.map.vectorTile.addVectorTileLayerItem(a):arcgisonline.map.save_open.addServiceByUrl(a.url,e,null,null,d,c)},addServiceByUrl:function(a,d,c,f,g,h){if((9>e.isIE||e.isOpera)&&-1<a.indexOf("https:")&&"https:"!==location.protocol)arcgisonline.map.main.reloadViewerSecureSSL(a);
else{if((esriGeowConfig.allSSL||"https:"==location.protocol)&&(arcgisonline.sharing.util.isHostedService(a)||arcgisonline.sharing.util.supportsHttps(a)))a=a.replace("http:","https:");var b=function(b,f,p){a=f;if(-1<a.toLowerCase().indexOf("/streamserver"))f={resourceInfo:b},d&&e.mixin(f,d),arcgisonline.map.stream.addStreamLayer(a,f);else if((b.mapName||""===b.mapName||b.pixelSizeX)&&(!d||!(d.itemCard&&"Feature Service"===d.itemCard.type)))b.capabilities&&-1==b.capabilities.toLowerCase().indexOf("map")&&
-1==b.capabilities.toLowerCase().indexOf("image")?m(b,p):arcgisonline.map.save_open.addServiceByUrl_MapAndImage(a,d,b,c,h);else if(b.layers&&-1===a.toLowerCase().indexOf("/globeserver")||"Feature Layer"===b.type||"Table"===b.type){if("Feature Layer"==b.type){if(b.capabilities&&-1<b.capabilities.toLowerCase().indexOf("map")&&(f=e.filter(b.fields,function(a){return"esriFieldTypeGeometry"===a.type}),!f||!f.length)){f=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();f.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:esri.i18nBundle.viewer.error.layerNoShapeField});return}f=!1;if(b.objectIdField)f=!0;else for(p=0;p<b.fields.length;p++)if("esriFieldTypeOID"==b.fields[p].type){f=!0;break}if(!f){f=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();f.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.layerNoObjectId});return}}if(d&&d.itemCard){var n={itemId:d.itemCard.id,onlyServiceToAdd:g,zoomToScale:h};arcgisonline.map.itemData.getItemLayerInfos(n,
e.hitch(this,function(c){d.itemData=arcgisonline.map.itemData.itemDataContents[c.itemId];arcgisonline.map.save_open.addServiceByUrl_Feature(a,d,b,null,b.layers&&1===b.layers.length?c.onlyServiceToAdd:!1,c.zoomToScale)},n),e.hitch(this,function(){arcgisonline.map.save_open.addServiceByUrl_Feature(a,d,b,null,null,n.zoomToScale)}))}else arcgisonline.map.save_open.addServiceByUrl_Feature(a,d,b,null,null,h)}else f=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),f.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:esri.i18nBundle.viewer.error.notSupportedLayerType})},m=function(c,b){e.publish("layerAddFailed",[]);var f=d?d.title:arcgisonline.map.main.getNameFromUrl(a);setTimeout(function(){var b=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();if(c&&c.details&&0<c.details.length&&"Unauthorized access"==c.details[0])b.show({title:esri.i18nBundle.viewer.error.noPermissionTitle,message:esri.i18nBundle.viewer.error.secureNotSupported});else if(c&&c.details&&0<c.details.length&&
"Missing spatial reference information."==c.details[0])b.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:e.string.substitute(esri.i18nBundle.viewer.error.layerMissingSP,{layer:f})});else if(null!=c&&c.capabilities&&-1==c.capabilities.toLowerCase().indexOf("map")&&-1==c.capabilities.toLowerCase().indexOf("image"))b.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:e.string.substitute(esri.i18nBundle.viewer.error.layerMissingMapCapabilities,{layer:f})});else{var d=e.string.substitute(esri.i18nBundle.viewer.error.layerNotAdded,
{layer:f});"http"===arcgisonline.sharing.util.parseUrl(a).protocol&&"https"===arcgisonline.sharing.util.parseUrl(window.location.href).protocol&&(d=e.string.substitute(esri.i18nBundle.viewer.error.layerNotAddedSecure,{layer:f}));b.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:d})}},5E3);arcgisonline.map.main.mapInitialized||arcgisonline.map.main.initMap();null==arcgisonline.map.save_open.webMapInfo&&null==arcgisonline.map.save_open.itemCard&&0==arcgisonline.map.main.numOperationalLayers()&&
arcgisonline.map.main.setTitle(esri.i18nBundle.viewer.defaultMapTitle)};if(f)b(f,a);else{f=d?d.title:arcgisonline.map.main.getNameFromUrl(a);var n=e.string.substitute(esri.i18nBundle.viewer.error.layerStillTrying,{layer:f}),p=n.indexOf("\x3cbr/\x3e");-1<p&&(f=n.substring(0,p),n=n.substring(p+5),n=f+'\x3cdiv class\x3d"throb-loading"\x3e\x3cdiv class\x3d"throb-loading-text"\x3e'+n+"\x3c/div\x3e\x3c/div\x3e");arcgisonline.map.layer.getServiceInfo(a,n,b,m)}}},addServiceByUrl_MapAndImage:function(a,d,
c,f,g){if(arcgisonline.sharing.util.isHostedService(a)||c.capabilities&&-1<c.capabilities.toLowerCase().indexOf("tilesonly")){var h=new esri.SpatialReference(c.spatialReference),h=arcgisonline.map.main.sameSpatialReference(h,arcgisonline.map.main.map.spatialReference),b=arcgisonline.map.layer.sameTilingSchemeAsBasemap(c);if(!h||!b){h=arcgisonline.map.main.numOperationalLayers();b=arcgisonline.map.main.mapLayers[0].url==esriGeowConfig.defaultBasemap.baseMapLayers[0].url;f=arcgisonline.map.layer.parseServiceInfo(c,
a);if(0<h||0==h&&!b)arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:e.string.substitute(esri.i18nBundle.viewer.error.layerDoesntFit,{layer:d?d.title:f.title})}),e.publish("layerAddedNoRemove",[]);else{h={layer:null,id:arcgisonline.map.layer.getIdFromUrl(a),type:"base",title:d?d.title:f.title,url:a,defaultVisibility:!0,minScale:0,maxScale:0,displayLevels:null,visibility:!0,snippet:"",identify:!1,itemId:d?d.itemId:
null,serviceInfo:c};arcgisonline.map.main.destroyMapObject();arcgisonline.map.main.defaultExtent=f.extent;arcgisonline.map.main.mapLods=c.tileInfo.lods;arcgisonline.map.main.baseTilingSchemeScales="|";for(i=0;i<c.tileInfo.lods.length;i++)arcgisonline.map.main.baseTilingSchemeScales+=c.tileInfo.lods[i].scale+"|";arcgisonline.map.main.mapLayers=[h];arcgisonline.map.main.currentBaseService=h.id;arcgisonline.map.main.defaultService=h;arcgisonline.map.main.createMapObject(e.hitch(this,function(){arcgisonline.map.save_open.onRecreateMapLoad(null);
arcgisonline.map.main.initMap(arcgisonline.map.main.defaultExtent)}),arcgisonline.map.main.defaultExtent);arcgisonline.map.layer.addLayer(h,0,e.hitch(this,function(a){e.publish("layerAddedNoRemove",[a]);e.publish("onLayerUpdate",[""]);d?(arcgisonline.map.main.setTitle(d.title),arcgisonline.map.save_open.itemCard=d.itemCard,arcgisonline.map.leftPanel.recreateAboutStack()):arcgisonline.map.main.setTitle(esri.i18nBundle.viewer.defaultMapTitle);arcgisonline.map.main.markMapAsChanged("addServiceByUrl_MapAndImage")},
h.id))}return}}var m,n,h=function(){var b={type:"user",visibility:!0,opacity:1,title:m,snippet:n,bandIds:null,serviceInfo:c};d&&(b.itemId=d.itemId);var f=arcgisonline.sharing.util.urlToObject(document.URL);f.query&&f.query.mode&&(b.mode=parseInt(f.query.mode));c&&(c.timeInfo&&c.timeInfo.hasLiveData)&&(b.timeAnimation=!1,b.timeChanged=!0);arcgisonline.map.layer.addLayerByURL(a,b,e.hitch(this,function(a){arcgisonline.map.save_open.itemCard&&d&&arcgisonline.map.save_open.itemCard.id==d.itemId?(null==
arcgisonline.map.save_open.webMapInfo&&arcgisonline.map.main.setTitle(d.title),arcgisonline.map.leftPanel.deleteAboutStack()):null==arcgisonline.map.save_open.webMapInfo&&null==arcgisonline.map.save_open.itemCard&&arcgisonline.map.main.setTitle(esri.i18nBundle.viewer.defaultMapTitle);g&&arcgisonline.map.main.zoomToScale(a.layer.minScale,a.layer.maxScale);e.forEach(a.layer.layerInfos,function(c){arcgisonline.map.popup.addPopupLayer(a,c.id)});arcgisonline.map.main.markMapAsChanged("addServiceByUrl_MapAndImage")}))};
d?(m=d.title,n=arcgisonline.sharing.util.getSnippet(d.snippet,d.description),h()):f?(f=arcgisonline.map.layer.parseServiceInfo(c,a),m=f.title,n=arcgisonline.sharing.util.getSnippet("",f.description),arcgisonline.map.main.mapInitialized||arcgisonline.map.main.initMap(),h()):(f=arcgisonline.map.layer.parseServiceInfo(c,a),m=f.title,n=arcgisonline.sharing.util.getSnippet("",f.description),arcgisonline.map.main.projectToMapAndZoom(f.extent,0,0,e.hitch(this,h)));c.tables&&c.tables.length&&e.forEach(c.tables,
function(c){var b=a;-1<b.indexOf("?")&&(b=b.substring(0,b.indexOf("?")));arcgisonline.map.save_open.addServiceByUrl(b+"/"+c.id,null)})},addServiceByUrl_Feature:function(a,d,c,f,g,h){var b=a.indexOf("/FeatureServer");-1==b&&(b=a.indexOf("/MapServer"));-1==b&&(b=a.indexOf("/service"));var m=a.substring(0,b),m=m.substring(m.lastIndexOf("/")+1,m.length);-1<m.indexOf("%")&&(m=arcgisonline.map.main.decodeUrl(m));if(c.tables&&c.tables.length||c.layers&&c.layers.length){var n=c.layers,b=!1;if(d&&d.itemData&&
d.itemData.layers){var p=[];e.forEach(d.itemData.layers,function(a){for(var c=0;c<n.length;c++)if(n[c].id===a.id){p.push(n[c]);break}});n.length!==p.length&&(b=!0);n=p}b||(n=n.concat(c.tables));b=e.map(n,function(c){return arcgisonline.map.save_open.getLayerInfo(c,a)});(new e.DeferredList(b)).addCallback(function(b){for(var p=null,r=n.length-1;0<=r;r--){var q=b[r][1];if("Table"===q.type){var t=!1,v;-1<a.indexOf("/FeatureServer")&&(v=a.replace("/FeatureServer","/MapServer")+"/"+q.id);e.forEach(arcgisonline.map.main.mapTables,
function(a){a.url===v&&!a.itemId&&(t=!0,e.publish("layerAdded",[a.id]))});if(!t&&("Review"!==q.name||!d||!d.itemCard||-1===e.indexOf(d.itemCard.typeKeywords,"Involved Lookup"))){var u=arcgisonline.map.main.addLayerId(a,q.id),w=arcgisonline.map.layer.getIdFromUrl(u),s={layer:new esri.layers.FeatureLayer(u,{id:w,outFields:["*"],resourceInfo:q}),id:w,url:u,title:m+" - "+q.name,serviceInfo:q};d&&d.itemCard&&(s.itemId=d.itemCard.id,s.itemCard=d.itemCard);q=function(){s.popupInfo=arcgisonline.map.popup.getDefaultPopupInfo(s.serviceInfo,
!1,s.layer);s.layer.setInfoTemplate(new esri.dijit.PopupTemplate(s.popupInfo));s.popupChanged=!0};s.layer.loaded?q():e.connect(s.layer,"onLoad",q);arcgisonline.map.main.mapTables.push(s);e.publish("layerAdded",[s.id])}}else 0<=q.id&&(d&&d.extent&&0<d.extent.length&&(-180!=d.extent[0][0]||-90!=d.extent[0][1]||180!=d.extent[1][0]||90!=d.extent[1][1])?arcgisonline.map.save_open.addFeatureLayerToMap(arcgisonline.map.main.addLayerId(a,q.id),c,q,d,f,g,h):(q=arcgisonline.map.layer.parseServiceInfo(q,arcgisonline.map.main.addLayerId(a,
c.layers[r].id)).extent,q||(q=c.fullExtent,q||(q=c.extent),q=esri.geometry.fromJson(q)),null==p?p=q:q&&(p=p.union(q))))}null!=p&&arcgisonline.map.save_open.zoomMapAndAddFeatureLayers(p,a,c.layers,b,c,null,f,d);c.layers&&(!c.layers.length&&c.tables&&c.tables.length)&&(e.publish("onLayerUpdate",[""]),e.publish("layerAdded",[s.id]))})}else if(d&&"Table"!==c.type)arcgisonline.map.save_open.addFeatureLayerToMap(a,null,c,d,f,null,h);else if("Table"===c.type){var t=!1,q;-1<a.indexOf("/MapServer/")?q=a.replace("/MapServer/",
"/FeatureServer/"):-1<a.indexOf("/FeatureServer/")&&(q=a.replace("/FeatureServer/","/MapServer/"));e.forEach(arcgisonline.map.main.mapTables,function(a){a.url===q&&!a.itemId&&(t=!0,e.publish("layerAdded",[a.id]))});if(!t){var b=arcgisonline.map.layer.getIdFromUrl(a),r={layer:new esri.layers.FeatureLayer(a,{id:b,outFields:["*"],resourceInfo:c}),id:b,url:a,title:m+" - "+c.name,serviceInfo:c};d&&(r.itemId=d.itemId,r.itemCard=d.itemCard);b=function(){r.popupInfo=arcgisonline.map.popup.getDefaultPopupInfo(r.serviceInfo,
!1,r.layer);r.layer.setInfoTemplate(new esri.dijit.PopupTemplate(r.popupInfo));r.popupChanged=!0};r.layer.loaded?b():e.connect(r.layer,"onLoad",b);arcgisonline.map.main.mapTables.push(r);e.publish("onLayerUpdate",[""]);e.publish("layerAdded",[r.id])}}else(b=arcgisonline.map.layer.parseServiceInfo(c,a).extent)?arcgisonline.map.save_open.zoomMapAndAddFeatureLayers(b,a,[{id:c.id,name:c.name}],[["",c]],null,c):arcgisonline.map.save_open.addFeatureLayerToMap(a,c,c,null,null,null,h)},getLayerInfo:function(a,
d,c){var f=function(c,d){e.publish("layerAddFailed",[]);setTimeout(function(){esri.id.isBusy()||arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:e.string.substitute(esri.i18nBundle.viewer.error.layerNotAvailable,{layer:a.name})})},5E3)};d=arcgisonline.map.main.addLayerId(d,a.id);d+=(-1<d.indexOf("?")?"\x26":"?")+"f\x3djson";return esri.request({url:d,callbackParamName:"callback",error:function(a,c){arcgisonline.sharing.util.errorHandler(a,
c,d,e.hitch(this,f))}})},addFeatureLayerToMap:function(a,d,c,f,g,h,b){var m;if(f){if(f.title===c.name||-1<f.title.indexOf(c.name)&&10>Math.abs(f.title.length-c.name.length))m=f.title;else{m=f.title.replace(/\s+/g,"").replace(/_+/g,"").toLowerCase();var n=c.name.replace(/\s+/g,"").replace(/_+/g,"").toLowerCase();m=m===n?f.title:f.itemData&&f.itemData.layers&&1===f.itemData.layers.length||f.itemData&&!f.itemData.layers&&d&&d.layers&&1===d.layers.length?f.title:f.title+" - "+c.name}n=arcgisonline.sharing.util.getSnippet(f.snippet,
f.description);g={type:"user",visibility:esri.isDefined(c.defaultVisibility)?c.defaultVisibility:!0,opacity:c&&c.drawingInfo&&c.drawingInfo.transparency?(100-c.drawingInfo.transparency)/100:1,title:m,snippet:n,itemId:f.itemId,itemCard:f.itemCard,bandIds:null,mode:g,serviceInfo:c,zoomToOneLayer:h,__createDefaultPopup:!0}}else m=a.indexOf("/FeatureServer"),-1==m&&(m=a.indexOf("/MapServer")),-1==m&&(m=a.indexOf("/service")),d=a.substring(0,m),d=d.substring(d.lastIndexOf("/")+1,d.length),-1<d.indexOf("%")&&
(d=arcgisonline.map.main.decodeUrl(d)),m=d.replace(/\s+/g,"").replace(/_+/g,"").toLowerCase(),n=c.name.replace(/\s+/g,"").replace(/_+/g,"").toLowerCase(),m=m===n?c.name:d+" - "+c.name,n=arcgisonline.sharing.util.getSnippet("",c.description),g={type:"user",visibility:!0,opacity:c&&c.drawingInfo&&c.drawingInfo.transparency?(100-c.drawingInfo.transparency)/100:1,title:m,snippet:n,bandIds:null,mode:g,serviceInfo:c,zoomToOneLayer:h,__createDefaultPopup:!0};c&&(c.timeInfo&&c.timeInfo.hasLiveData)&&(g.timeAnimation=
!1,g.timeChanged=!0);arcgisonline.map.layer.addLayerByURL(a,g,e.hitch(this,function(a){a.layer&&(a.layer.timeInfo&&a.layer.timeInfo.hasLiveData)&&(a.layer.setUseMapTime(!1),a.timeChanged=!0);arcgisonline.map.save_open.itemCard&&f&&arcgisonline.map.save_open.itemCard.id==f.itemId?(null==arcgisonline.map.save_open.webMapInfo&&arcgisonline.map.main.setTitle(f.title),arcgisonline.map.leftPanel.deleteAboutStack()):!arcgisonline.map.save_open.webMapInfo&&!arcgisonline.map.save_open.itemCard&&arcgisonline.map.main.setTitle(esri.i18nBundle.viewer.defaultMapTitle);
b&&h&&arcgisonline.map.main.zoomToScale(a.layer.minScale,a.layer.maxScale);f&&f.itemCard&&(a.itemCard=f.itemCard,a.layer.isEditable()&&(-1<e.indexOf(a.itemCard.typeKeywords,"Location Tracking")&&-1<e.indexOf(a.itemCard.typeKeywords,"Collector"))&&(a.isTrackingInfoLayer=!0));var c=arcgisonline.sharing.util.urlToObject(document.URL).query;if(!a.itemId||!c||!(c.layers&&-1<c.layers.indexOf(a.itemId)))c&&c.url&&-1<c.url.indexOf(a.url)||c.urls&&-1<c.urls.indexOf(a.url)||arcgisonline.map.main.markMapAsChanged("addFeatureLayerToMap")}))},
zoomMapAndAddFeatureLayers:function(a,d,c,f,g,h,b,m){var n=b=0,p=!1;null!=h?(n=arcgisonline.map.layer.parseServiceInfo(h,arcgisonline.map.main.addLayerId(d,h.id)),b=n.minScale,n=n.maxScale,p=!0):c&&1===c.length&&(p=!0);arcgisonline.map.main.projectToMapAndZoom(a,b,n,e.hitch(this,function(a){var b=[];if(!e&&0!=e){e=arcgisonline.sharing.util.urlToObject(document.URL);if(e.query&&e.query.mode){var e=e.query.mode;-1<e.indexOf(",")?b=e.split(","):b[0]=e}for(e=0;e<b.length;e++)if(isNaN(b[e])){b=[];break}}else b[0]=
e;for(e=c.length-1;0<=e;e--){h=f[e][1];var p=null;b.length>e?p=parseInt(b[e]):1==b.length&&(p=parseInt(b[0]));null!=h.id&&(null==g?arcgisonline.map.save_open.addFeatureLayerToMap(d,g,h,m,p,a):arcgisonline.map.save_open.addFeatureLayerToMap(arcgisonline.map.main.addLayerId(d,h.id),g,h,m,p,a))}},p))},openWebMapItemCard:function(a){e.style(x.byId("webmap-save").domNode,"display","none");arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+a,e.hitch(this,function(d,c){arcgisonline.map.save_open.webMapItemCard=
d;arcgisonline.map.save_open.openWebMapData(a,d)}),e.hitch(this,function(a,c){console.log(a);if(a&&a.error){var e=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();e.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.downloadFailed})}else e=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),e.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.mapNotLoaded}),arcgisonline.map.layer.loadDefaultMap()}))},
openWebMapData:function(a,d){arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+a+"/data",e.hitch(this,function(a,e){arcgisonline.map.save_open.openWebMap(d,a||{})}),e.hitch(this,function(a,d){console.log(a);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.downloadFailed})}))},openWebMap:function(a,d){arcgisonline.map.save_open.webMapInfo={id:a.id,owner:a.owner,
ownerFolder:a.ownerFolder,itemControl:a.itemControl,item:a.item,url:a.url,name:a.name,title:a.title,description:a.description,tags:a.tags,snippet:a.snippet,thumbnail:a.thumbnail,typeKeywords:a.typeKeywords,accessInformation:a.accessInformation,licenseInfo:a.licenseInfo,deleteExplorerSlides:!1};arcgisonline.map.main.setTitle(a.title);var c=arcgisonline.sharing.util.urlToObject(document.URL);c.query&&c.query.basemapUrl&&(d.baseMap={baseMapLayers:[{id:"basemap",opacity:1,visibility:!0,url:arcgisonline.map.main.decodeUrl(baseUrl)}],
title:"Basemap"});arcgisonline.map.vectorTile.checkFallBackVectorTileLayers(d).then(function(c){arcgisonline.map.save_open.openedWebMap=c;arcgisonline.map.main.hasMapOnly()||arcgisonline.map.leftPanel.openLeftAboutPanel();e.publish("onWebmapRead",[c]);var d=null;a.extent&&0<a.extent.length&&(d=new esri.geometry.Extent(a.extent[0][0],a.extent[0][1],a.extent[1][0],a.extent[1][1],new esri.SpatialReference({wkid:4326})));arcgisonline.map.save_open.startupWebMap(d,c)})},startupWebMap:function(a,d){var c=
arcgisonline.sharing.util.getUser(),f=c&&c.accountId,g=[];e.forEach(d.baseMap.baseMapLayers,function(a){a.itemId&&g.push(a.itemId)});e.forEach(d.operationalLayers,function(a){a.itemId&&g.push(a.itemId)});if(g.length){var h=[];e.forEach(g,function(a){a&&-1==e.indexOf(h,a)&&h.push(a)});for(var b=function(c){var b=!0;e.forEach(c.results,function(a,c){if(a.typeKeywords){if(!arcgisonline.map.role.isAllowed("add_require_credits")&&-1<e.indexOf(a.typeKeywords,"Requires Credits")||!arcgisonline.map.role.isAllowed("add_require_subscription")&&
-1<e.indexOf(a.typeKeywords,"Requires Subscription"))d.baseMap.baseMapLayers[0].itemId===a.id?(b=!1,setTimeout(e.hitch(this,function(a){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:e.string.substitute(f?esri.i18nBundle.viewer.error.missingPermissionsForBasemapInWebMap:esri.i18nBundle.viewer.error.missingPermissionsForBasemapInWebMapNonOrg,{title:a})})},a.title),5E3),arcgisonline.map.layer.loadDefaultMap()):
b&&(d.operationalLayers=e.filter(d.operationalLayers,function(c){return c.itemId!==a.id}),setTimeout(e.hitch(this,function(a){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:e.string.substitute(f?esri.i18nBundle.viewer.error.missingPermissionsForItem:esri.i18nBundle.viewer.error.missingPermissionsForItemNonOrg,{title:a})})},a.title),5E3));arcgisonline.map.save_open.itemCards[a.id]=a}});b&&arcgisonline.map.save_open.startupWebMapAfterPermissionCheck(a,
d)},c=[],m=[],n=0;n<h.length;n++)if(m.push(h[n]),10===m.length||n===h.length-1)c.push(arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"content/itemlist?ids\x3d"+m.toString())),m=[];if(c.length){var p=[];(new e.DeferredList(c)).addCallback(function(a){e.forEach(a,function(a){p=p.concat(a[1].items)});b({results:p})})}}else arcgisonline.map.save_open.startupWebMapAfterPermissionCheck(a,d)},startupWebMapAfterPermissionCheck:function(a,d){var c=function(a,c,e,d){setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:d||
esri.i18nBundle.generalDlg.errorDlgTitle,message:e||esri.i18nBundle.viewer.error.webMapNoBingKey})},2E3)};if(d.baseMap.baseMapLayers[0].type&&d.baseMap.baseMapLayers[0].type.startsWith("BingMaps"))if(d.baseMap.baseMapLayers[0].portalUrl){var e=arcgisonline.sharing.util.getUser(),g=d.baseMap.baseMapLayers[0].portalUrl.substring(d.baseMap.baseMapLayers[0].portalUrl.lastIndexOf("/")+1);e&&e.accountId===g?esriGeowConfig.self.bingKey?(d.baseMap.baseMapLayers[0].bingKey=esriGeowConfig.self.bingKey,arcgisonline.map.save_open.startupWebMapAfterBingCheck(a,
d)):arcgisonline.map.save_open.webMapItemCard&&e.email===arcgisonline.map.save_open.webMapItemCard.owner?(d=arcgisonline.map.main.switchBingToEsriBasemap(d),arcgisonline.map.save_open.startupWebMap(a,d),c(a,d,esri.i18nBundle.viewer.error.webMapBadBingKey,esri.i18nBundle.common.warning)):(d=arcgisonline.map.main.switchBingToEsriBasemap(d),arcgisonline.map.save_open.startupWebMap(a,d)):(g=d.baseMap.baseMapLayers[0].portalUrl,"https:"===location.protocol&&(g=g.replace("http:","https:")),esri.request({url:g+
"?f\x3djson",callbackParamName:"callback",load:function(g,b){g.bingKey?(d.baseMap.baseMapLayers[0].bingKey=g.bingKey,arcgisonline.map.save_open.startupWebMapAfterBingCheck(a,d)):e&&arcgisonline.map.save_open.webMapItemCard&&e.email===arcgisonline.map.save_open.webMapItemCard.owner?(d=arcgisonline.map.main.switchBingToEsriBasemap(d),arcgisonline.map.save_open.startupWebMap(a,d),c(a,d,esri.i18nBundle.viewer.error.webMapNoFreeBingKey)):(d=arcgisonline.map.main.switchBingToEsriBasemap(d),arcgisonline.map.save_open.startupWebMap(a,
d))},error:function(c,b){d=arcgisonline.map.main.switchBingToEsriBasemap(d);arcgisonline.map.save_open.startupWebMap(a,d)}},{disableIdentityLookup:!0}))}else d.baseMap.baseMapLayers[0].bingKey=esriGeowConfig.bingMapsKey,arcgisonline.map.save_open.startupWebMapAfterBingCheck(a,d);else arcgisonline.map.save_open.startupWebMapAfterBingCheck(a,d)},startupWebMapAfterBingCheck:function(a,d){d.widgets&&(d.widgets.timeSlider&&d.widgets.timeSlider.properties)&&(arcgisonline.map.time.timeSliderProperties=d.widgets.timeSlider.properties);
var c=d.baseMap.baseMapLayers[0];if("WMS"==c.type){var f=arcgisonline.map.wms.buildResourceInfo(c,a);f.resourceInfo.title=d.baseMap.title;f.resourceInfo.refreshInterval=c.refreshInterval;arcgisonline.map.wms.addWMSAsBaseLayer(f.resourceInfo,f.visibleLayers,null,e.hitch(arcgisonline.map.save_open,"onWebMapBaseLayerLoadHandler",a,d))}else"WebTiledLayer"==c.type?(c=e.clone(c),c.title=d.baseMap.title||c.title,arcgisonline.map.webTile.addWebTiledAsBaseLayer(c,null,e.hitch(arcgisonline.map.save_open,"onWebMapBaseLayerLoadHandler",
a,d))):"VectorTileLayer"===c.layerType?(c=e.clone(c),c.title=d.baseMap.title||c.title,arcgisonline.map.vectorTile.addVectorTileAsBaseLayer(c,null,e.hitch(arcgisonline.map.save_open,"onWebMapBaseLayerLoadHandler",a,d))):(f={url:c.url,exclusionAreas:c.exclusionAreas,type:c.type,opacity:c.opacity,visibility:c.visibility,bingKey:c.bingKey,minScale:c.minScale,maxScale:c.maxScale,displayLevels:c.displayLevels,startVisibleLayers:c.visibleLayers,title:d.baseMap.title,id:c.id,itemId:c.itemId,showLegend:c.showLegend},
esri.isDefined(c.refreshInterval)&&(f.refreshInterval=c.refreshInterval,f.refreshIntervalChanged=!0),esri.isDefined(c.timeAnimation)&&(f.timeChanged=!0,f.timeAnimation=c.timeAnimation),arcgisonline.map.layer.addUserBaseLayer(f,e.hitch(arcgisonline.map.save_open,"onWebMapBaseLayerLoadHandler",a,d)))},onWebMapBaseLayerLoadHandler:function(a,d,c){d.baseMap.baseMapLayers[0].itemId&&(c.itemId=d.baseMap.baseMapLayers[0].itemId);a&&null==a.spatialReference&&(a.spatialReference=null==arcgisonline.map.main.map.extent?
arcgisonline.map.main.defaultExtent.spatialReference:arcgisonline.map.main.map.extent.spatialReference);if(arcgisonline.map.main.defaultService.layer.loaded)arcgisonline.map.save_open.onWebMapDefaultServiceLoaded(a,d);else e.connect(arcgisonline.map.main.defaultService.layer,"onLoad",e.hitch(arcgisonline.map.save_open,"onWebMapDefaultServiceLoaded",a,d))},onWebMapDefaultServiceLoaded:function(a,d){null!=a?arcgisonline.map.main.sameSpatialReference(arcgisonline.map.main.defaultExtent.spatialReference,
a.spatialReference)?arcgisonline.map.main.zoomMap(a,0,0,e.hitch(arcgisonline.map.save_open,"addWebMapOperationalLayers",d)):arcgisonline.map.main.projectExtent(a,arcgisonline.map.main.defaultExtent.spatialReference,e.hitch(this,function(a,f){arcgisonline.map.main.zoomMap(a[0],0,0,e.hitch(arcgisonline.map.save_open,"addWebMapOperationalLayers",d))}),e.hitch(this,function(a,f){arcgisonline.map.main.zoomMap(arcgisonline.map.main.defaultExtent,0,0,e.hitch(arcgisonline.map.save_open,"addWebMapOperationalLayers",
d))})):arcgisonline.map.main.zoomMap(arcgisonline.map.main.defaultExtent,0,0,e.hitch(arcgisonline.map.save_open,"addWebMapOperationalLayers",d))},addWebMapOperationalLayers:function(a){for(var d=[],c=1;c<a.baseMap.baseMapLayers.length;c++){var f=a.baseMap.baseMapLayers[c];if(!f.isReference){if((esriGeowConfig.allSSL||"https:"==location.protocol)&&f.url&&(arcgisonline.sharing.util.isHostedService(f.url)||arcgisonline.sharing.util.supportsHttps(f.url)))f.url=f.url.replace("http:","https:");if("WebTiledLayer"===
f.type){var g=e.clone(f);g.type="base";arcgisonline.map.webTile.addWebTiledLayer(f.templateUrl,g,arcgisonline.map.save_open.onLayerLoadHandler)}else"VectorTileLayer"===f.layerType?arcgisonline.map.vectorTile.checkSupport().then(e.hitch(this,function(a,c){if(c){var b=e.clone(a);b.type="base";arcgisonline.map.vectorTile.addVectorTileLayer(a.styleUrl,b,arcgisonline.map.save_open.onLayerLoadHandler)}else console.log("One of the basemap layers is a Vector Tile Layer which is not supported.")},f)):(g={type:"base",
visibility:f.visibility,opacity:f.opacity,title:a.baseMap.title,minScale:f.minScale,maxScale:f.maxScale,displayLevels:f.displayLevels,startVisibleLayers:f.visibleLayers,exclusionAreas:f.exclusionAreas,snippet:"",bandIds:f.bandIds,serviceInfo:null,showLegend:f.showLegend},f.id&&(g.id=f.id),esri.isDefined(f.refreshInterval)&&(g.refreshInterval=f.refreshInterval,g.refreshIntervalChanged=!0),esri.isDefined(f.timeAnimation)&&(g.timeChanged=!0,g.timeAnimation=f.timeAnimation),d.push(e.hitch(arcgisonline.map.layer,
"addLayerByURL",f.url,g)))}}for(var h=a.operationalLayers,f=0;f<h.length;f++){var b=h[f];if(!b.url&&!b.featureCollection&&"Feature Collection"!==b.type&&(!b.templateUrl||!b.templateUrl.length||"WebTiledLayer"!==b.type)&&"VectorTileLayer"!==b.layerType||b.url&&!b.url.length||b.url&&-1==b.url.toLowerCase().indexOf("/mapserver")&&-1==b.url.toLowerCase().indexOf("/imageserver")&&-1==b.url.toLowerCase().indexOf("/featureserver")&&-1==b.url.toLowerCase().indexOf("/service")&&"CSV"!==b.type&&"WMS"!==b.type&&
"KML"!==b.type&&"GeoRSS"!==b.type&&!b.featureCollection)setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.layersOmitted})},3E3);else{g={type:"user",layerType:b.layerType,id:b.id,visibility:!1==b.visibility?!1:!0,opacity:b.opacity,title:b.title,snippet:"",bandIds:b.bandIds,exclusionAreas:b.exclusionAreas,format:b.format,compressionQuality:b.compressionQuality,renderingRule:b.renderingRule,
mosaicRule:b.mosaicRule,layerDefinition:b.layerDefinition,serviceInfo:null};b.id&&(g.id=b.id);b.visibleLayers&&(g.visibleLayers=b.visibleLayers.toString(),"WMS"!==b.type&&(g.visibleLayersChanged=!0));null!=b.mode&&(g.mode=b.mode);b.infoTemplate&&(g.infoTemplate=b.infoTemplate);b.itemId&&(g.itemId=b.itemId);esri.isDefined(b.refreshInterval)&&(g.refreshInterval=b.refreshInterval,g.refreshIntervalChanged=!0);esri.isDefined(b.timeAnimation)&&(g.timeChanged=!0,g.timeAnimation=b.timeAnimation);b.showLabels&&
(g.showLabels=!0);b.layers&&(g.itemLayers=b.layers,g.layersChanged=!0,e.forEach(b.layers,function(a){a.layerDefinition&&a.layerDefinition.definitionExpression&&(g.defExpChanged=!0);if(a.layerDefinition&&(esri.isDefined(a.layerDefinition.minScale)||esri.isDefined(a.layerDefinition.maxScale)))g.scaleChanged=!0;a.layerDefinition&&a.layerDefinition.drawingInfo&&(g.rendererChanged=!0)}),b.thematicGroup&&(g.thematicGroup=b.thematicGroup));b.definitionEditor&&(g.definitionEditor=b.definitionEditor);b.popupInfo&&
(g.popupInfo=b.popupInfo,g.popupChanged=!0);esri.isDefined(b.minScale)&&esri.isDefined(b.maxScale)&&(g.minScale=b.minScale,g.maxScale=b.maxScale);b.disablePopup&&(g.disablePopup=b.disablePopup,g.popupChanged=!0);b.capabilities&&(g.capabilities=b.capabilities);b.tileInfo&&(g.tileInfo=b.tileInfo);if((esriGeowConfig.allSSL||"https:"==location.protocol)&&b.url&&(arcgisonline.sharing.util.isHostedService(b.url)||arcgisonline.sharing.util.supportsHttps(b.url)))b.url=b.url.replace("http:","https:");if(b.featureCollection&&
!b.url&&!b.itemId)c=arcgisonline.map.mapNotes.isMapNotesLayer(b)?function(a){arcgisonline.map.mapNotes.addFeatureLayers(a)}:function(a){arcgisonline.map.featColl.addFeatureLayers(a)},arcgisonline.map.main.map.loaded?c(b):e.connect(arcgisonline.map.main.map,"onLoad",e.hitch(this,c,b));else if("CSV"==b.type)c={layer:null,url:b.url,id:b.id,type:"user",subType:"csv",title:b.title,defaultVisibility:b.visibility,defaultOpacity:b.opacity,snippet:"",showLegend:!1===b.showLegend?!1:!0,identify:!1,popupInfo:b.popupInfo,
layerDefinition:b.layerDefinition,locationInfo:b.locationInfo,columnDelimiter:b.columnDelimiter,refreshInterval:b.refreshInterval},b=arcgisonline.map.layer.getLayerPosition(c),arcgisonline.map.main.mapLayers.splice(b.list,0,c),b=b.map,c.layer=new esri.layers.CSVLayer(c.url,{infoTemplate:c.popupInfo?new esri.dijit.PopupTemplate(c.popupInfo):null,id:c.id,outFields:["*"],visible:c.defaultVisibility,opacity:c.defaultOpacity,displayOnPan:9>e.isIE?!1:!0,columnDelimiter:c.columnDelimiter,latitudeFieldName:c.locationInfo.latitudeFieldName,
longitudeFieldName:c.locationInfo.longitudeFieldName,layerDefinition:e.clone(c.layerDefinition),refreshInterval:c.refreshInterval}),arcgisonline.map.main.map.addLayer(c.layer,b),c.layer.loaded?c.layer.labelingInfo&&arcgisonline.map.labels.addLabelsForLayer(c.layer):e.connect(c.layer,"onLoad",function(a){a.labelingInfo&&arcgisonline.map.labels.addLabelsForLayer(a)});else if("Feature Collection"===b.type)arcgisonline.map.featColl.addFeatCollByReferenceLayerFromJson(b),e.subscribe("layerAdded",e.hitch(this,
function(a,c){a===c&&arcgisonline.map.main.checkLayerOrder()},b.id));else if("KML"==b.type)null!==b.showLegend&&void 0!==b.showLegend&&(g.showLegend=b.showLegend),b.visibleFolders&&(g.visibleFolders=b.visibleFolders),arcgisonline.map.kml.addKMLLayer(b.url,g,arcgisonline.map.save_open.onLayerLoadHandler);else if("WMS"===b.type)g.wmsInfo=b,d.push(e.hitch(arcgisonline.map.wms,"loadWMSFromWebmapConfig",b.url,g));else if("GeoRSS"===b.type)esri.isDefined(b.showLegend)&&(g.showLegend=b.showLegend),esri.isDefined(b.pointSymbol)&&
(g.pointSymbol=b.pointSymbol),esri.isDefined(b.lineSymbol)&&(g.lineSymbol=b.lineSymbol),esri.isDefined(b.polygonSymbol)&&(g.polygonSymbol=b.polygonSymbol),arcgisonline.map.geoRSS.addGeoRSSLayer(b.url,g,arcgisonline.map.save_open.onLayerLoadHandler);else if("WebTiledLayer"===b.type)g=e.mixin(b,{type:"user"}),arcgisonline.map.webTile.addWebTiledLayer(b.templateUrl,g,arcgisonline.map.save_open.onLayerLoadHandler);else if("VectorTileLayer"===b.layerType)g=e.mixin(b,{type:"user"}),arcgisonline.map.vectorTile.addVectorTileLayerConfig(b,
arcgisonline.map.save_open.onLayerLoadHandler);else if("ArcGISStreamLayer"===b.layerType)g=e.mixin(b,{type:"user"}),arcgisonline.map.stream.addStreamLayer(b.url,g,arcgisonline.map.save_open.onLayerLoadHandler);else{esri.isDefined(b)&&(g.showLegend=b.showLegend);if(a.editTrackingFilter)for(c=0;c<a.editTrackingFilter.length;c++)if(b.id==a.editTrackingFilter[c].id){g.editTrackingFilter=a.editTrackingFilter[f].filter;break}if(a.featureLimitReachedDlgDisabled)for(c=0;c<a.featureLimitReachedDlgDisabled.length;c++)if(b.id==
a.featureLimitReachedDlgDisabled[c].id){g.featureLimitExceededHandlerNotNeeded=!0;break}"ArcGISImageServiceVectorLayer"===b.layerType&&esri.isDefined(b.symbolTileSize)&&(g.symbolTileSize=b.symbolTileSize);d.push(e.hitch(arcgisonline.map.layer,"addLayerByURL",b.url,g,arcgisonline.map.save_open.onLayerLoadHandler))}}}for(c=0;c<a.baseMap.baseMapLayers.length;c++)if(f=a.baseMap.baseMapLayers[c],!0==f.isReference){if((esriGeowConfig.allSSL||"https:"==location.protocol)&&f.url&&(arcgisonline.sharing.util.isHostedService(f.url)||
arcgisonline.sharing.util.supportsHttps(f.url)))f.url=f.url.replace("http:","https:");if("WebTiledLayer"===f.type)g=e.clone(f),g.type="labels",arcgisonline.map.webTile.addWebTiledLayer(f.templateUrl,g,arcgisonline.map.save_open.onLayerLoadHandler);else if("VectorTileLayer"===f.layerType)arcgisonline.map.vectorTile.checkSupport().then(e.hitch(this,function(a,c){if(c){var b=e.clone(a);b.type="labels";arcgisonline.map.vectorTile.addVectorTileLayer(a.styleUrl,b,arcgisonline.map.save_open.onLayerLoadHandler)}else console.log("One of the basemap layers is a Vector Tile Layer which is not supported.")},
f));else{g={type:"labels",visibility:f.visibility,opacity:f.opacity,title:"Reference",minScale:esri.isDefined(f.minScale)?f.minScale:0,maxScale:esri.isDefined(f.maxScale)?f.maxScale:0,displayLevels:f.displayLevels,exclusionAreas:f.exclusionAreas,startVisibleLayers:f.visibleLayers,snippet:"",bandIds:f.bandIds,serviceInfo:null,showLegend:f.showLegend};f.id&&(g.id=f.id);f.itemId&&(g.itemId=f.itemId);if((esriGeowConfig.allSSL||"https:"==location.protocol)&&f.url&&(arcgisonline.sharing.util.isHostedService(f.url)||
arcgisonline.sharing.util.supportsHttps(f.url)))f.url=f.url.replace("http:","https:");d.push(e.hitch(arcgisonline.map.layer,"addLayerByURL",f.url,g))}}h=arcgisonline.sharing.util.urlToObject(document.URL);h.query=h.query||{};if(h.query.layers||h.query.services)d.push(e.hitch(arcgisonline.map.save_open,"openServiceItemCards",h.query.layers||h.query.services));h.query.url&&d.push(e.hitch(arcgisonline.map.save_open,"addServiceByUrl",arcgisonline.map.main.decodeUrl(h.query.url),null,!1));h.query.urls&&
(f=arcgisonline.map.main.decodeUrl(h.query.urls).split(",http"),d=[],e.forEach(f,function(a){if(a.startsWith("://")||a.startsWith("s://"))a="http"+a;d.push(e.hitch(arcgisonline.map.save_open,"addServiceByUrl",a,null,!1))}));if(a.tables)for(f=0;f<a.tables.length;f++)c=a.tables[f],g={id:c.id,itemId:c.itemId,title:c.title,layerDefinition:c.layerDefinition,popupInfo:c.popupInfo,capabilities:c.capabilities},d.push(e.hitch(arcgisonline.map.layer,"addTableByURL",c.url,g));0<d.length&&arcgisonline.map.layer.waitForServiceResponse(d);
h.query.featurecollection&&arcgisonline.map.featColl.addFeatureCollectionByUrl(arcgisonline.map.main.decodeUrl(h.query.featurecollection));(a=arcgisonline.sharing.util.getUser())&&arcgisonline.map.save_open.webMapInfo&&arcgisonline.map.save_open.webMapInfo.owner===a.email&&"contentStack"!==arcgisonline.map.leftPanel.getLeftContentPanelStack()&&!arcgisonline.map.main.hasMapOnly()&&arcgisonline.map.leftPanel.openLeftTOCPanel()},onLayerLoadHandler:function(a){var d=arcgisonline.map.main.getParameterList(a);
if(d.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer){if(!esri.isDefined(d.visibleLayers)){var c="";if(arcgisonline.map.main.hasDynamicLayers(d))e.forEach(d.layer.dynamicLayerInfos,function(a,f){esri.isDefined(a.source.mapLayerId)&&e.forEach(d.layer.layerInfos,function(b){a.source.mapLayerId==b.id&&!0==b.defaultVisibility&&(c+=(0<c.length?",":"")+a.id)})});else{a=d.layer.layerInfos;for(var f=0;f<a.length;f++)!0==a[f].defaultVisibility&&(c+=(0<c.length?",":"")+a[f].id)}d.visibleLayers=c}a=
arcgisonline.map.main.buildExportLayers(d);0==a.length&&d.serviceInfo&&d.serviceInfo.singleFusedMapCache||d.layer.setVisibleLayers(a)}},switchBaseMapWithWebMap:function(a){arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+a.id+"/data",e.hitch(this,function(e,c){arcgisonline.map.save_open.switchOrRecreateBasemap(e||{},a.extent)}),e.hitch(this,function(a,c){console.log(a);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:esri.i18nBundle.viewer.error.basemapNotOpened})}))},switchOrRecreateBasemap:function(a,d){(esriGeowConfig.allSSL||"https:"==location.protocol)&&e.forEach(a.baseMap.baseMapLayers,function(a){if(arcgisonline.sharing.util.isHostedService(a.url)||arcgisonline.sharing.util.supportsHttps(a.url))a.url=a.url.replace("http:","https:")});var c=function(a){for(var c=1;c<a.baseMap.baseMapLayers.length;c++){var b=a.baseMap.baseMapLayers[c];if(!b.isReference)if("WebTiledLayer"===b.type){var d=e.clone(b);
arcgisonline.map.webTile.addWebTiledLayer(b.templateUrl,d,e.hitch(this,function(a){arcgisonline.map.main.getParameterList(a).type="base";arcgisonline.map.save_open.onLayerLoadHandler(a)}),null,{map:c,list:c})}else"VectorTileLayer"===b.layerType?arcgisonline.map.vectorTile.checkSupport().then(e.hitch(this,function(a,b){if(b){var d=e.clone(a);arcgisonline.map.vectorTile.addVectorTileLayer(a.styleUrl,d,e.hitch(this,function(a){arcgisonline.map.main.getParameterList(a).type="base";arcgisonline.map.save_open.onLayerLoadHandler(a)}),
null,{map:c,list:c})}else console.log("One of the basemap layers is a Vector Tile Layer which is not supported.")},b)):(d={layer:null,id:b.id?b.id:"basemap_"+c,url:b.url,type:"base",title:b.title||a.baseMap.title,defaultVisibility:b.visibility,defaultOpacity:b.opacity,snippet:"",serviceInfo:null,itemId:b.itemId,minScale:esri.isDefined(b.minScale)?b.minScale:0,maxScale:esri.isDefined(b.maxScale)?b.maxScale:0,startVisibleLayers:b.visibleLayers},b.exclusionAreas&&(d.exclusionAreas=b.exclusionAreas),
b.displayLevels&&(d.displayLevels=b.displayLevels),b.bandIds&&(d.defaultBandIds=b.bandIds),arcgisonline.map.main.mapLayers.splice(c,0,d),arcgisonline.map.layer.addLayer(d,c))}arcgisonline.map.layer.removeLabelsLayers();for(var f=1;f<a.baseMap.baseMapLayers.length;f++)b=a.baseMap.baseMapLayers[f],!0==b.isReference&&("WebTiledLayer"===b.type?(d=e.clone(b),d.type="labels",arcgisonline.map.webTile.addWebTiledLayer(b.templateUrl,d,arcgisonline.map.save_open.onLayerLoadHandler)):"VectorTileLayer"===b.layerType?
arcgisonline.map.vectorTile.checkSupport().then(e.hitch(this,function(a,c){if(c){var b=e.clone(a);b.type="labels";arcgisonline.map.vectorTile.addVectorTileLayer(a.styleUrl,b,arcgisonline.map.save_open.onLayerLoadHandler)}else console.log("One of the basemap layers is a Vector Tile Layer which is not supported.")},b)):arcgisonline.map.layer.addLabelsLayer(b.url,b));var g=function(){if(1<a.baseMap.baseMapLayers.length){var c=0;e.forEach(arcgisonline.map.main.mapLayers,function(a){var b=e.indexOf(arcgisonline.map.main.map.layerIds,
a.id);-1<b&&(b!==c&&arcgisonline.map.main.map.reorderLayer(a.layer,c),c++)})}};g();arcgisonline.map.save_open.basemapSwitchInterval&&clearInterval(arcgisonline.map.save_open.basemapSwitchInterval);var h=0;arcgisonline.map.save_open.basemapSwitchInterval=setInterval(e.hitch(this,function(){g();5<h&&(clearInterval(arcgisonline.map.save_open.basemapSwitchInterval),arcgisonline.map.save_open.basemapSwitchInterval=null);h++},h),5E3)},f=function(a,b,d,f,g){f=arcgisonline.map.layer.parseServiceInfo(d,f);
g=f.extent;if(arcgisonline.map.save_open.checkIfOpLayersFitToNewBasemap(f.spatialReference,d)){var h=function(a,b,d){var f=arcgisonline.map.main.sameSpatialReference(arcgisonline.map.main.defaultExtent.spatialReference,d.spatialReference),g=arcgisonline.map.layer.sameTilingSchemeAsBasemap(a);arcgisonline.map.save_open.basemapWebMap=b;g&&f?arcgisonline.map.main.getIntersectionPercent(d,arcgisonline.map.main.map.extent).then(e.hitch(this,function(f){5>f&&arcgisonline.map.main.map.setExtent(d,!0);arcgisonline.map.layer.switchBaseLayer(b.baseMap.baseMapLayers[0].url,
null,b.baseMap.title,a,null,b.baseMap.baseMapLayers[0],e.hitch(this,function(){e.publish("basemapSwitch")}));c(b)})):arcgisonline.map.save_open.openBaseMapService(b.baseMap.baseMapLayers[0].url,null,b.baseMap.title,null,a,null,d);arcgisonline.map.main.markMapAsChanged("switchOrRecreateBasemap")};b?(b=new esri.geometry.Extent(b[0][0],b[0][1],b[1][0],b[1][1],new esri.SpatialReference({wkid:4326})),arcgisonline.map.main.sameSpatialReference(g.spatialReference,b.spatialReference)?h(d,a,b):arcgisonline.map.main.projectExtent(b,
g.spatialReference,e.hitch(this,function(b,c){h(d,a,b[0])}),e.hitch(this,function(b,c,e){h(d,a,b)},g))):h(d,a,g)}},g=function(b,c){var d=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();b&&b.details&&0<b.details.length&&"Missing spatial reference information."==b.details[0]?d.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:e.string.substitute(esri.i18nBundle.viewer.error.basemapTitleMissingSR,{title:a.baseMap.title})}):d.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:e.string.substitute(esri.i18nBundle.viewer.error.basemapTitleNotAvailable2,{title:a.baseMap.title})})},h=a.baseMap.baseMapLayers[0].type;if("WMS"==h){if(a.baseMap.baseMapLayers[0].spatialReferences){var b=new esri.SpatialReference({wkid:a.baseMap.baseMapLayers[0].spatialReferences[0]}),m=arcgisonline.map.save_open.checkIfOpLayersFitToNewBasemap(b);if(!m)return}h=arcgisonline.map.wms.buildResourceInfo(a.baseMap.baseMapLayers[0],arcgisonline.map.main.map.extent);h.resourceInfo.title=a.baseMap.title;
arcgisonline.map.wms.addWMSAsBaseLayer(h.resourceInfo,h.visibleLayers)}else if("WebTiledLayer"==h){if(m=!0,m=a.baseMap.baseMapLayers[0].tileInfo&&a.baseMap.baseMapLayers[0].tileInfo.spatialReference?arcgisonline.map.save_open.checkIfOpLayersFitToNewBasemap(a.baseMap.baseMapLayers[0].tileInfo.spatialReference):arcgisonline.map.save_open.checkIfOpLayersFitToNewBasemap(new esri.SpatialReference({wkid:102100})))h=e.clone(a.baseMap.baseMapLayers[0]),h.title=a.baseMap.title||h.title,arcgisonline.map.webTile.addWebTiledAsBaseLayer(h,
null,e.hitch(this,function(){c(a)}),null,!0)}else if("VectorTileLayer"===h)arcgisonline.map.vectorTile.checkSupport().then(e.hitch(this,function(a,b){if(b){var h=e.clone(a.baseMap.baseMapLayers[0]);h.title=a.baseMap.title||h.title;arcgisonline.map.vectorTile.addVectorTileAsBaseLayer(h,null,e.hitch(this,function(){c(a)}),null,!0)}else{console.log("Basemap, "+(a.baseMap.title||a.baseMap.baseMapLayers[0].title)+", contains a Vector Tile layer which is not supported. Switching to Esri Streets basemap instead.");
a.baseMap.title="Streets";a.baseMap.baseMapLayers=[{id:"World_Street_Map_8421",url:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer",opacity:1,visibility:!0}];if(esriGeowConfig.allSSL||"https:"==location.protocol)a.baseMap.baseMapLayers[n].url=a.baseMap.baseMapLayers[n].url.replace("http:","https:");arcgisonline.map.layer.getServiceInfo(a.baseMap.baseMapLayers[0].url,e.string.substitute(esri.i18nBundle.viewer.error.basemapTitleNotAvailable2,{title:a.baseMap.title}),
e.hitch(this,f,a,d),e.hitch(this,g))}},a));else if(-1<e.indexOf(["BingMapsRoad","BingMapsHybrid","BingMapsAerial","OpenStreetMap"],h)){if(b=new esri.SpatialReference({wkid:102100}),h=new esri.layers.OpenStreetMapLayer,m=arcgisonline.map.save_open.checkIfOpLayersFitToNewBasemap(b,{tileInfo:h.tileInfo})){b=arcgisonline.map.main.sameSpatialReference(arcgisonline.map.main.defaultExtent.spatialReference,b);arcgisonline.map.main.defaultBaseLayerMapLods=h.tileInfo.lods;h=arcgisonline.map.layer.sameTilingSchemeAsBasemap2();
arcgisonline.map.save_open.basemapWebMap=a;if(h&&b){h=a.baseMap.baseMapLayers[0];arcgisonline.map.layer.switchBaseLayer(h.url,h.type||h.layerType,a.baseMap.title,null,null,null,e.hitch(this,function(){e.publish("basemapSwitch")}));for(h=1;h<a.baseMap.baseMapLayers.length;h++)b=a.baseMap.baseMapLayers[h],b.isReference||(m={type:"base",visibility:b.visibility,opacity:b.opacity,title:a.baseMap.title+" - "+h,minScale:b.minScale,maxScale:b.maxScale,displayLevels:b.displayLevels,startVisibleLayers:b.visibleLayers,
snippet:"",bandIds:b.bandIds,serviceInfo:null},b.id&&(m.id=b.id),arcgisonline.map.layer.addLayerByURL(b.url,m));arcgisonline.map.layer.removeLabelsLayers();for(var n=0;n<a.baseMap.baseMapLayers.length;n++)b=a.baseMap.baseMapLayers[n],!0==b.isReference&&("WebTiledLayer"===b.layerType?(m=e.clone(b),m.type="labels",arcgisonline.map.webTile.addWebTiledLayer(b.templateUrl,m,arcgisonline.map.save_open.onLayerLoadHandler)):"VectorTileLayer"===b.layerType?(m=e.clone(b),m.type="labels",arcgisonline.map.vectorTile.addVectorTileLayer(b.styleUrl,
m,arcgisonline.map.save_open.onLayerLoadHandler)):arcgisonline.map.layer.addLabelsLayer(b.url,b))}else arcgisonline.map.save_open.openBaseMapService(a.baseMap.baseMapLayers[0].url,a.baseMap.baseMapLayers[0].layerType,a.baseMap.title,null,null);arcgisonline.map.main.markMapAsChanged("switchOrRecreateBasemap")}}else arcgisonline.map.layer.getServiceInfo(a.baseMap.baseMapLayers[0].url,e.string.substitute(esri.i18nBundle.viewer.error.basemapTitleNotAvailable2,{title:a.baseMap.title}),e.hitch(this,f,a,
d),e.hitch(this,g))},switchBaseMap:function(a){arcgisonline.map.geocode.closeInfoWindow();arcgisonline.map.save_open.openBaseMapServiceItemCard(a)},openBaseMapServiceItemCard:function(a){arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+a,e.hitch(this,function(a,c){var f=arcgisonline.sharing.util.getUser(),g=f&&f.accountId;!arcgisonline.map.role.isAllowed("add_require_credits")&&-1<e.indexOf(a.typeKeywords,"Requires Credits")||!arcgisonline.map.role.isAllowed("add_require_subscription")&&
-1<e.indexOf(a.typeKeywords,"Requires Subscription")?setTimeout(e.hitch(this,function(a){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:e.string.substitute(g?esri.i18nBundle.viewer.error.missingPermissionsForBasemap:esri.i18nBundle.viewer.error.missingPermissionsForBasemapNonOrg,{title:a})})},a.title),5E3):(arcgisonline.map.save_open.basemapWebMap=null,"WMS"==a.type?arcgisonline.map.wms.addWMSItemAsBasemap(a):
"Vector Tile Service"==a.type?arcgisonline.map.vectorTile.addVectorTileLayerItemAsBasemap(a):(a.url&&-1<a.url.indexOf("/MapServer?ts\x3d")&&(a.url=a.url.substring(0,a.url.indexOf("?ts\x3d"))),arcgisonline.map.save_open.openBaseMapService(a.url,null,a.title,a)))}),e.hitch(this,function(a,c){console.log(a);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.basemapFailedToLoad})}))},switchBaseMapByUrl:function(a,
d){arcgisonline.map.save_open.basemapWebMap=null;arcgisonline.map.save_open.openBaseMapService(a,null,null,null,d)},openBaseMapService:function(a,d,c,f,g,h,b){if((esriGeowConfig.allSSL||"https:"==location.protocol)&&(arcgisonline.sharing.util.isHostedService(a)||arcgisonline.sharing.util.supportsHttps(a)))a=a.replace("http:","https:");var m=function(c,d,g,h,m){a=h;m=arcgisonline.map.layer.parseServiceInfo(g,a);var n=m.extent;h=m.spatialReference;d=d||m.title;if(!g.mapName&&!(""===g.mapName||g.pixelSizeX||
"indexedVector"===g.type))if(!(g.layers&&-1===a.toLowerCase().indexOf("/globeserver")||"Feature Layer"===g.type||"Table"===g.type)){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.notSupportedLayerType});return}arcgisonline.map.save_open.checkIfOpLayersFitToNewBasemap(h,g)&&(m=arcgisonline.map.main.sameSpatialReference(arcgisonline.map.main.defaultExtent.spatialReference,h),arcgisonline.map.layer.sameTilingSchemeAsBasemap(g)&&
m?(c=arcgisonline.map.main.map.extent,arcgisonline.map.main.getIntersectionPercent(n,c).then(e.hitch(this,function(b){5>b&&arcgisonline.map.main.map.setExtent(n,!0);arcgisonline.map.layer.removeLabelsLayers();arcgisonline.map.layer.switchBaseLayer(a,null,d,g,f)}))):(m={layer:null,id:arcgisonline.map.layer.getIdFromUrl(a),type:"base",title:d,url:a,defaultVisibility:!0,minScale:0,maxScale:0,displayLevels:null,snippet:"",identify:!1,serviceInfo:g},f&&f.id&&(m.itemCard=f,m.itemId=f.id),arcgisonline.map.main.defaultExtent=
n,b&&(arcgisonline.map.main.defaultExtent=b),arcgisonline.map.main.mapLods=null,arcgisonline.map.main.baseTilingSchemeScales="",arcgisonline.map.save_open.prepRecreateMap(m,h,c)),arcgisonline.map.main.markMapAsChanged("openBaseMapService"))},n=function(b,d){c||(c=arcgisonline.map.main.getNameFromUrl(a));var f=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();b&&b.details&&0<b.details.length&&"Missing spatial reference information."==b.details[0]?f.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:e.string.substitute(esri.i18nBundle.viewer.error.layerMissingSP,{layer:c})}):f.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:e.string.substitute(esri.i18nBundle.viewer.error.layerNotAvailable,{layer:c})})};if(null==d||0==d.length)if(null!=g)m(h,c,g,a,{args:{url:a}});else{c||(c=arcgisonline.map.main.getNameFromUrl(a));g=e.string.substitute(esri.i18nBundle.viewer.error.basemapStillTrying,{layer:c});var p=g.indexOf("\x3cbr/\x3e");-1<p&&(d=g.substring(0,p),g=g.substring(p+5),g=
d+'\x3cdiv class\x3d"throb-loading"\x3e\x3cdiv class\x3d"throb-loading-text"\x3e'+g+"\x3c/div\x3e\x3c/div\x3e");arcgisonline.map.layer.getServiceInfo(a,g,e.hitch(this,m,h,c),e.hitch(this,n))}else m=new esri.SpatialReference({wkid:102100}),arcgisonline.map.main.defaultExtent=new esri.geometry.Extent(-2.0037508342787E7,-2.003750834278E7,2.003750834278E7,2.0037508342787E7,m),arcgisonline.map.save_open.prepRecreateMap({layer:null,id:d,type:"base",title:c,url:null,defaultVisibility:!0,minScale:0,maxScale:0,
displayLevels:null,bingKey:esriGeowConfig.self.bingKey,snippet:"",identify:!1},m,h)},prepRecreateMap:function(a,d,c){arcgisonline.map.main.startup=!0;!c&&arcgisonline.map.main.map&&(c=arcgisonline.map.main.map.extent);var f=[];arcgisonline.map.main.currentBaseService=a.id;arcgisonline.map.main.isUserBaseService=!0;f=[];f[0]=a;for(k=0;k<arcgisonline.map.main.mapLayers.length;k++)if(a=arcgisonline.map.main.mapLayers[k],"base"!=a.type&&"labels"!=a.type){if(arcgisonline.map.featColl.isFeatureCollection(a))if(a.layer){a.visible=
a.layer.visible;a.opacity=a.layer.opacity;var g=a.layer.toJson();a.popupInfo&&(g.popupInfo=a.popupInfo);a.featureCollectionLayer=g;a.__isFootprintLayer=a.layer.__isFootprintLayer;a.layers=null}else a.visible=a.layers[0].visible,a.opacity=a.layers[0].opacity,a.featureCollectionLayers=[],e.forEach(a.layers,function(b){var c=b.toJson();b.__popupInfo&&(c.popupInfo=b.__popupInfo);a.featureCollectionLayers.push(c)},this),a.layers=[];else if(a.layer){a.defaultVisibility=a.layer.visible;null!=a.layer.opacity&&
(a.defaultOpacity=a.layer.opacity);if("esri.layers.FeatureLayer"==a.layer.declaredClass&&a.layer.url&&(arcgisonline.sharing.util.isHostedService(a.layer.url)||10.1<=a.layer.version)&&!a.featureLimitExceededHandler)a.featureLimitExceededHandlerNotNeeded=!0;if(a.layer instanceof esri.layers.WMSLayer)a.resourceInfo=arcgisonline.map.wms.getResourceInfoFromLayer(a.layer),a.refreshInterval=a.layer.refreshInterval,a.subType="wms";else if(a.layer instanceof esri.layers.KMLLayer){a.subType="kml";a.visibleFolders=
[];e.forEach(a.layer.folders,function(b){b.visible&&a.visibleFolders.push(b.id)},this);for(var g=a.layer.getLayers(),h=0;h<g.length;h++){var b=g[h];if("esri.layers.FeatureLayer"==b.declaredClass){a.defaultOpacity=b.opacity;break}}}else if(a.layer instanceof esri.layers.GeoRSSLayer){a.subType="GeoRSS";g=a.layer.getFeatureLayers();for(h=0;h<g.length;){b=g[h];a.defaultOpacity=b.opacity;break}}else a.layer instanceof esri.layers.CSVLayer?(a.subType="CSV",a.defaultOpacity=a.layer.opacity,a.defaultVisibility=
a.layer.visible,a.layerDefinition=e.mixin(a.layer.toJson().layerDefinition,a.layerDefinition)):a.layer instanceof esri.layers.WebTiledLayer&&(a.subType="WebTiledLayer");a.layer instanceof esri.layers.FeatureLayer&&a.rendererChanged&&(a.layerDefinition=a.layerDefinition||{},a.layerDefinition.drawingInfo=a.layerDefinition.drawingInfo||{},a.layerDefinition.drawingInfo.renderer=a.layer.renderer.toJson(),a.layer.labelingInfo&&(a.layerDefinition.drawingInfo.labelingInfo=e.map(a.layer.labelingInfo,function(a){return a.toJson()})));
a.refreshIntervalChanged&&esri.isDefined(a.layer.refreshInterval)&&(a.refreshInterval=a.layer.refreshInterval||0);a.timeChanged&&(a.timeAnimation=a.layer.useMapTime);if(a.scaleChanged)if(a.layer instanceof esri.layers.FeatureLayer)a.layerDefinition=a.layerDefinition||{},a.layerDefinition.minScale=a.layer.minScale?a.layer.minScale:0,a.layerDefinition.maxScale=a.layer.maxScale&&1!==a.layer.maxScale&&a.layerDefinition.minScale!==Number.POSITIVE_INFINITY?a.layer.maxScale:0;else if(a.layer instanceof esri.layers.WMSLayer||
a.layer instanceof esri.layers.KMLLayer){if(a.layer.minScale||a.layer.maxScale)a.minScale=a.layer.minScale,a.maxScale=a.layer.maxScale}else a.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer||(a.minScale=a.layer.minScale?a.layer.minScale:0,a.maxScale=a.layer.maxScale&&1!==a.layer.maxScale?a.layer.maxScale:0);a.layer instanceof esri.layers.ArcGISImageServiceLayer&&(a.layer.renderingRule&&a.renderingRuleChanged&&(a.renderingRule=a.layer.renderingRule.toJson()),a.layer.mosaicRule&&a.mosaicRuleChanged&&
(a.mosaicRule=a.layer.mosaicRule.toJson()),a.layer.bandIds&&a.renderingRuleChanged&&(a.defaultBandIds=a.layer.bandIds),a.layer.format&&a.imageQualityChanged&&(a.format=a.layer.format),a.layer.compressionQuality&&a.imageQualityChanged&&(a.compressionQuality=a.layer.compressionQuality));a.layer=null}f[f.length]=a}arcgisonline.map.main.mapLayers=f;arcgisonline.map.popup.disablePopupHandler();arcgisonline.map.main.destroyMapObject();var m=function(a,b){arcgisonline.map.main.getIntersectionPercent(a,b).then(e.hitch(this,
function(d){5>d?arcgisonline.map.save_open.recreateMap(a,c.spatialReference):arcgisonline.map.save_open.recreateMap(b,c.spatialReference)}))};arcgisonline.map.main.sameSpatialReference(c.spatialReference,d)?m(arcgisonline.map.main.defaultExtent,c):arcgisonline.map.main.projectWrapAroundExtent(c,d,function(a,b){m(arcgisonline.map.main.defaultExtent,a[0])},function(a,b){arcgisonline.map.save_open.recreateMap(arcgisonline.map.main.defaultExtent,c.spatialReference)})},recreateMap:function(a,d){arcgisonline.map.main.initialExtent=
a;var c=arcgisonline.map.main.mapLayers[0];if("OpenStreetMap"==c.id||-1<c.id.indexOf("BingMaps")){c.layer="OpenStreetMap"==c.id?new esri.layers.OpenStreetMapLayer({id:c.id,opacity:1,visible:!0}):new esri.virtualearth.VETiledLayer({bingMapsKey:c.bingKey,id:c.id,mapStyle:"BingMapsAerial"==c.id?esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL:"BingMapsRoad"==c.id?esri.virtualearth.VETiledLayer.MAP_STYLE_ROAD:esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL_WITH_LABELS,opacity:1,visible:!0});arcgisonline.map.main.mapLods=
c.layer.tileInfo.lods;arcgisonline.map.main.baseTilingSchemeScales="|";for(i=0;i<arcgisonline.map.main.mapLods.length;i++)arcgisonline.map.main.baseTilingSchemeScales+=arcgisonline.map.main.mapLods[i].scale+"|";arcgisonline.map.main.createMapObject(e.hitch(arcgisonline.map.save_open,"onRecreateMapLoad",d));arcgisonline.map.main.map.addLayer(c.layer,0);var f=function(){arcgisonline.map.main.defaultService=c;arcgisonline.map.main.initMap(a)};c.layer.loaded?f():e.connect(c.layer,"onLoad",f);e.connect(c.layer,
"onError",function(d){setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:e.string.substitute(esri.i18nBundle.viewer.error.basemapTitleNotAvailable,{title:c.title})})},2E3);arcgisonline.map.save_open.basemapWebMap=null;arcgisonline.map.save_open.openBaseMapService(arcgisonline.map.main.defaultBaseLayer.url,null,arcgisonline.map.main.defaultBaseLayer.title,null,null,a)})}else"wms"===c.subType?
(arcgisonline.map.main.createMapObject(e.hitch(arcgisonline.map.save_open,"onRecreateMapLoad",d),arcgisonline.map.main.defaultExtent),arcgisonline.map.wms.createWMSLayer(c,0,c.visibleLayers.split(","),c.resourceInfo)):"WebTiledLayer"===c.subType?(arcgisonline.map.main.createMapObject(e.hitch(arcgisonline.map.save_open,"onRecreateMapLoad",d),arcgisonline.map.main.defaultExtent),arcgisonline.map.webTile.createWebTiledLayer(c,0,function(){arcgisonline.map.main.defaultService=c;var d=c.layer.fullExtent;
d&&(a=d.intersects(a),arcgisonline.map.main.initialExtent=a);arcgisonline.map.main.initMap(a)},function(d){setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:e.string.substitute(esri.i18nBundle.viewer.error.basemapTitleNotAvailable,{title:c.title})})},1E3);arcgisonline.map.save_open.basemapWebMap=null;arcgisonline.map.save_open.openBaseMapService(arcgisonline.map.main.defaultBaseLayer.url,
null,arcgisonline.map.main.defaultBaseLayer.title,null,null,a)})):"VectorTileLayer"===c.subType?(arcgisonline.map.main.createMapObject(e.hitch(arcgisonline.map.save_open,"onRecreateMapLoad",d),arcgisonline.map.main.defaultExtent),arcgisonline.map.vectorTile.createVectorTileLayer(c,0,function(){arcgisonline.map.main.defaultService=c;var d=c.layer.fullExtent;d&&(a=d.intersects(a),arcgisonline.map.main.initialExtent=a);arcgisonline.map.main.initMap(a)},function(d){setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:e.string.substitute(esri.i18nBundle.viewer.error.basemapTitleNotAvailable,{title:c.title})})},1E3);arcgisonline.map.save_open.basemapWebMap=null;arcgisonline.map.save_open.openBaseMapService(arcgisonline.map.main.defaultBaseLayer.url,null,arcgisonline.map.main.defaultBaseLayer.title,null,null,a)})):(arcgisonline.map.main.createMapObject(e.hitch(arcgisonline.map.save_open,"onRecreateMapLoad",d)),arcgisonline.map.layer.addLayer(c,0,function(){arcgisonline.map.main.defaultService=c;var d=c.layer.fullExtent;
if(d){var e=!0;if(arcgisonline.map.main.map.wrapAround180){var b=a.spatialReference._getInfo();if(b&&a._getCM(b)){var f=1;a.spatialReference.isWebMercator()&&(f=1E3);if(Math.abs(b.valid[0]-d.xmin)<f||Math.abs(b.valid[1]-d.xmax)<f)e=!1}}e&&(a=d.intersects(a),arcgisonline.map.main.initialExtent=a)}arcgisonline.map.main.initMap(a)},function(d){setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:e.string.substitute(esri.i18nBundle.viewer.error.basemapTitleNotAvailable,
{title:c.title})})},1E3);arcgisonline.map.save_open.basemapWebMap=null;arcgisonline.map.save_open.openBaseMapService(arcgisonline.map.main.defaultBaseLayer.url,null,arcgisonline.map.main.defaultBaseLayer.title,null,null,a)}))},onRecreateMapLoad:function(a){arcgisonline.map.main.onMapLoad();arcgisonline.map.main.markMapAsChanged("onRecreateMapLoad");e.publish("basemapSwitch");var d=1;if(null!=arcgisonline.map.save_open.basemapWebMap)for(var c=arcgisonline.map.save_open.basemapWebMap,f=1;f<c.baseMap.baseMapLayers.length;f++){var g=
c.baseMap.baseMapLayers[f];if(!g.isReference){if("WebTiledLayer"===g.type){var h=e.clone(g);arcgisonline.map.webTile.addWebTiledLayer(g.templateUrl,h,e.hitch(this,function(a){arcgisonline.map.main.getParameterList(a).type="base";arcgisonline.map.save_open.onLayerLoadHandler(a)}),null,{map:f,list:f})}else"VectorTileLayer"===g.layerType?(h=e.clone(g),arcgisonline.map.vectorTile.addVectorTileLayer(g.styleUrl,h,e.hitch(this,function(a){arcgisonline.map.main.getParameterList(a).type="base";arcgisonline.map.save_open.onLayerLoadHandler(a)}),
null,{map:f,list:f})):(h={layer:null,id:g.id?g.id:"basemap_"+f,url:g.url,type:"base",title:g.title||c.baseMap.title,defaultVisibility:g.visibility,defaultOpacity:g.opacity,snippet:"",serviceInfo:null,itemId:g.itemId,minScale:esri.isDefined(g.minScale)?g.minScale:0,maxScale:esri.isDefined(g.maxScale)?g.maxScale:0,startVisibleLayers:g.visibleLayers},g.exclusionAreas&&(h.exclusionAreas=g.exclusionAreas),g.displayLevels&&(h.displayLevels=g.displayLevels),g.bandIds&&(h.defaultBandIds=g.bandIds),arcgisonline.map.main.mapLayers.splice(f,
0,h),arcgisonline.map.layer.addLayer(h,f));d++}}for(l=d;l<arcgisonline.map.main.mapLayers.length;l++)if(c=arcgisonline.map.main.mapLayers[l],c.featureCollectionLayer)g=function(a,c,d){a.layer=arcgisonline.map.featColl.addFeatureLayer(d,a.visible,a.opacity,c);arcgisonline.map.popup.setupPopupHandler();arcgisonline.map.main.map.addLayer(a.layer);a.__isFootprintLayer&&(a.layer.__isFootprintLayer=a.__isFootprintLayer)},d=c.id?c.id:"featColl_"+l,arcgisonline.map.featColl.projectFeatureSet(c.featureCollectionLayer,
a,e.hitch(this,g,c,d));else if(c.featureCollectionLayers)for(f=0;f<c.featureCollectionLayers.length;f++)g=function(a,c,d,f){c=arcgisonline.map.featColl.addFeatureLayer(f,a.visible,a.opacity,c);esri.isDefined(a.visibleLayers)&&(f=a.visibleLayers.split(","),-1==e.indexOf(f,d)&&c.hide());a.layers.push(c);arcgisonline.map.popup.setupPopupHandler();arcgisonline.map.main.map.addLayer(c)},d=(c.id?c.id:"featColl_"+l)+"_"+f,arcgisonline.map.featColl.projectFeatureSet(c.featureCollectionLayers[f],a,e.hitch(this,
g,c,d,f));else"wms"==c.subType?arcgisonline.map.wms.createWMSLayer(c,l,c.visibleLayers.split(","),c.resourceInfo):"kml"==c.subType?arcgisonline.map.kml.createKMLLayer(c,l,c.visibleFolders,null):"GeoRSS"==c.subType?arcgisonline.map.geoRSS.createGeoRSSLayer(c,l,null):"CSV"==c.subType?(c.layer=new esri.layers.CSVLayer(c.url,{infoTemplate:new esri.dijit.PopupTemplate(c.popupInfo),id:c.id,outFields:["*"],visible:c.defaultVisibility,opacity:c.defaultOpacity,displayOnPan:9>e.isIE?!1:!0,columnDelimiter:c.columnDelimiter,
latitudeFieldName:c.locationInfo.latitudeFieldName,longitudeFieldName:c.locationInfo.longitudeFieldName,layerDefinition:e.clone(c.layerDefinition),refreshInterval:c.refreshInterval}),arcgisonline.map.main.map.addLayer(c.layer,1)):"WebTiledLayer"==c.subType?arcgisonline.map.webTile.createWebTiledLayer(c,l,null):"VectorTileLayer"==c.subType?arcgisonline.map.vectorTile.createVectorTileLayer(c,l,null):"stream"==c.subType?arcgisonline.map.stream.createStreamLayer(c,l):arcgisonline.map.layer.addLayer(c,
l,function(a){arcgisonline.map.save_open.onLayerLoadHandler(a)});if(null!=arcgisonline.map.save_open.basemapWebMap){c=arcgisonline.map.save_open.basemapWebMap;arcgisonline.map.layer.removeLabelsLayers();for(a=0;a<c.baseMap.baseMapLayers.length;a++)g=c.baseMap.baseMapLayers[a],!0==g.isReference&&("WebTiledLayer"===g.type?(h=e.clone(g),h.type="labels",arcgisonline.map.webTile.addWebTiledLayer(g.templateUrl,h,arcgisonline.map.save_open.onLayerLoadHandler)):"VectorTileLayer"===g.layerType?(h=e.clone(g),
h.type="labels",arcgisonline.map.vectorTile.addVectorTileLayer(g.styleUrl,h,arcgisonline.map.save_open.onLayerLoadHandler)):arcgisonline.map.layer.addLabelsLayer(g.url,g))}arcgisonline.map.main.bookmarksTool&&(arcgisonline.map.main.bookmarksTool.map=arcgisonline.map.main.map,arcgisonline.map.main.projectBookmarks());"directionsStack"==arcgisonline.map.leftPanel.getLeftContentPanelStack()&&(arcgisonline.map.leftPanel.openLeftTOCPanel(),leftPanel&&leftPanel.destroyDirectionsStack());arcgisonline.map.geocode.recreateGeocoder()},
checkIfOpLayersFitToNewBasemap:function(a,d){for(var c="",f="",g=0,h=0;h<arcgisonline.map.main.mapLayers.length;h++){var b=arcgisonline.map.main.mapLayers[h];if("user"==b.type){var m=!0;if(b.layer instanceof esri.layers.WMSLayer)m=arcgisonline.map.wms.checkIfFitsToNewBasemap(b.layer,a);else if(b.layer instanceof esri.layers.WebTiledLayer)m=arcgisonline.map.webTile.checkIfFitsToNewService(b,a,d?d.tileInfo:null);else if(b.layer instanceof esri.layers.VectorTileLayer)m=arcgisonline.map.vectorTile.checkIfFitsToNewService(b,
a,b.layer.tileInfo);else if(b.url&&arcgisonline.sharing.util.isHostedService(b.url)&&"esri.layers.ArcGISTiledMapServiceLayer"==b.layer.declaredClass){var n=arcgisonline.map.main.sameSpatialReference(b.layer.spatialReference,a),p=!0;d&&(p=arcgisonline.map.layer.sameTilingSchemeAsBasemap(d));if(!n||!p)m=!1}m||(c+=f+b.title,f=", ",g++)}}return 0<c.length?(f=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),c=1<g?e.string.substitute(esri.i18nBundle.viewer.error.cantChangeBasemapN,
{titles:c}):e.string.substitute(esri.i18nBundle.viewer.error.cantChangeBasemap1,{title:c}),f.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:c}),!1):!0}}});