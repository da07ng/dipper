// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("dojo/promise/all dojo/Deferred dojo/_base/lang esri/layers/ArcGISElevationLayer esri/core/watchUtils esri/geometry/SpatialReference webSceneViewer/webScene/WebSceneLayers esri/Basemap esri/core/Collection webSceneViewer/widgets/MessageListWidget/MessageListWidget webSceneViewer/spatialReferenceUtils esri/layers/OpenStreetMapLayer esri/layers/GraphicsLayer esri/views/3d/terrain/TilingScheme esri/geometry/support/webMercatorUtils esri/geometry/support/scaleUtils esri/geometry/Extent ./environmentUtils dojo/i18n!webSceneViewer/nls/viewer".split(" "),
function(u,v,w,x,r,k,n,s,y,p,z,A,B,C,D,E,F,G,g){function q(a){var b=Error("Invalid basemap");b.errors=a;return b}function H(a){for(var b=[],c=[],f=0;f<a.length;f++){var e=a[f];if(e instanceof A)c.push({layer:e});else if(n.extrapolateTypeFromLayerInstance(e))if(e.url){var d=n.validateServerUrl(e.url);d.hasLayer?b.push({msg:g.messages.addLayerFailed,details:"unsupported url "+e.url}):c.push({layer:e,serviceDetails:d,url:e.url,params:{url:e.url}})}else b.push({msg:g.messages.addLayerFailed,details:"missing url"});
else b.push({msg:g.messages.onlyTiledLayerSupported,details:e.url})}if(0!==b.length)throw q(b);return c}function I(a){function b(){0===c.length?e.resolve(f):e.reject(q(c.filter(function(a){return!!a})))}for(var c=[],f=[],e=new v,d=a.length,h=0;h<a.length;h++){var g=a[h];g.serviceDetails?n.prepareOpLayerFromService(g,1).then(function(a,c){f[a]=c;0===--d&&b()}.bind(this,h),function(a,f){c[a]=f;0===--d&&b()}.bind(this,h)):(f[h]={layerType:n.extrapolateTypeFromLayerInstance(g.layer)},0===--d&&b())}0===
a.length&&b();return e.promise}function J(a){for(var b=[],c=0;c<a.length;c++){var f=a[c];"ArcGISTiledMapServiceLayer"!==f.layerType&&("ArcGISTiledImageServiceLayer"!==f.layerType&&"ArcGISTiledElevationServiceLayer"!==f.layerType&&"OpenStreetMap"!==f.layerType)&&b.push({msg:g.messages.onlyTiledLayerSupported,details:a[c].url})}if(0<b.length)throw q(b);}var m,t={},d={_basemapLayersEqual:function(a,b){return a.length!==b.length?!1:!!a.reduce(function(a,f,e){e=b.getItemAt(e);return a&&e&&e instanceof
f.constructor&&f.url===e.url},!0)},equals:function(a,b){return!b?!1:d._basemapLayersEqual(a.baseLayers,b.baseLayers)&&d._basemapLayersEqual(a.referenceLayers,b.referenceLayers)&&d._basemapLayersEqual(a.elevationLayers,b.elevationLayers)},turnOnElevation:function(a){var b=a.basemap;b.elevationLayers&&0<b.elevationLayers.length||(b?b.elevationLayers=b._elevationLayersCache&&0<b._elevationLayersCache.length?b._elevationLayersCache:[d.DefaultElevationLayer]:a.basemap=new s({elevationLayers:[d.DefaultElevationLayer]}))},
turnOffElevation:function(a){var b=a.basemap;b&&(b._elevationLayersCache=b.get("elevationLayers").getAll(),b.elevationLayers=[],0===b.baseLayers.length&&(a.basemap=null))},_copyBasemapLayers:function(a,b){return b.map(function(b){var f=a.find(function(a){return b instanceof a.constructor&&a.url===b.url});return f?f:b})},fixSSL:function(a,b){function c(a){Array.isArray(a)&&a.forEach(function(a){a.url=n.useSSLIfRequired(a.url,b)})}b||(b=d.portal);c(a.baseMapLayers);c(a.elevationLayers);c(a.referenceLayers)},
fixJSON:function(a,b){var c=w.clone(a);Array.isArray(c.baseMapLayers)&&c.baseMapLayers.forEach(function(a){!a.layerType&&a.type&&(a.layerType=a.type,delete a.type);!a.urlTemplate&&a.templateUrl&&(a.urlTemplate=a.templateUrl)});this.fixSSL(c,b);return c},fromJSON:function(a,b){try{return s.fromJSON(this.fixJSON(a,b))}catch(c){throw Error("");}},fromJSONAndCopySubLayers:function(a,b,c){b=this.fromJSON(b);a&&(b.baseLayers=d._copyBasemapLayers(a.baseLayers,b.baseLayers),b.elevationLayers=c?a.elevationLayers:
d._copyBasemapLayers(a.elevationLayers,b.elevationLayers),b.referenceLayers=d._copyBasemapLayers(a.referenceLayers,b.referenceLayers));return b},_handleBasemapSetError:function(a,b){if(!a.map.isFulfilled()){var c=d.spatialReferenceLocked?a.map.spatialReference:k.WebMercator,f=new B({spatialReference:c,id:"__basemapErrorFallbackLayer__"});if(!D.canProject(f.fullExtent,f.spatialReference)){var e=5E4*E.getUnitValueForSR(f.spatialReference);f.fullExtent=new F({xmin:-e,xmax:e,ymin:-e,ymax:e,spatialReference:f.spatialReference})}a.map.spatialReference=
c;if("planar"===a.globeMode)r.once(a,"fullExtent",function(){a.map.remove(f);setTimeout(function(){a.extent=a.fullExtent},0)});else a.then(function(){a.map.remove(f)});a.map.add(f)}if(b&&b.errors)for(c=0;c<b.errors.length;c++)e=b.errors[c],p.show({message:g.dialogs.unsupportedBasemap,type:p.MessageTypes.ERROR,details:(e.msg||e.message)+(e.details?"\n"+e.details:"")});else b&&p.show({message:g.dialogs.unsupportedBasemap,type:p.MessageTypes.ERROR,details:(b.msg||b.message)+(b.details?"\n"+b.details:
"")})},validateAndSet:function(a,b,c,f){var e=a.map;m&&(m.cancel(t),m=null);if(b&&d.equals(b,e.basemap))c!==a.basemapTransparency&&d.applyTransparency(a,c);else{if(b){var l=new y;l.addItems(b.baseLayers);l.addItems(b.referenceLayers);l.addItems(b.elevationLayers);var h;return h=m=u(l.getAll()).then(H).then(I).then(J).then(function(){if(m===h||void 0===h){m=null;var l=this.getBasemapSR(b),k=!1;if(l&&(!l.equals(a.map.spatialReference)||!this._tilingSchemeEquals(b,a)))if(this._allowBasemapToSwitchSR(f,
a))k=b.baseLayers&&0<b.baseLayers.length&&b.baseLayers.getItemAt(0).fullExtent,this._resetView(a.map,l),z.pingGeometryService(k.center),k=!0;else{p.show({message:g.messages.selectedBasemapMismatchTitle,type:p.MessageTypes.ERROR,details:g.messages.selectedBasemapMismatch});return}0===b.baseLayers.length&&0===b.elevationLayers.length&&(b=null);if(e.basemap=b)this.checkAndSetDefaultElevationAvailability(a,k),(l=d.getFirstLayer(b))&&G.adjustLightForLayer(a,l);r.whenOnce(a,"ready",function(){e.basemap===
b&&d.applyTransparency(a,c)})}}.bind(this),function(b){if(b!==t&&(m===h||void 0===h))m=null,d._handleBasemapSetError(a,b)})}this._handleBasemapSetError(a,null)}},checkAndSetDefaultElevationAvailability:function(a,b){var c=a.map;try{d._checkDefaultElevationCompatibility(a),b&&d.turnOnElevation(c)}catch(f){d.turnOffElevation(c)}},_checkDefaultElevationCompatibility:function(a){var b=a.map.basemap,c=a.spatialReference,f;b?f=(b=b.elevationLayers&&0<b.elevationLayers.length?b.elevationLayers.getItemAt(0):
b._elevationLayersCache&&0<b._elevationLayersCache.length?b._elevationLayersCache[0]:d.DefaultElevationLayer)?b.spatialReference:null:(b=d.DefaultElevationLayer,f=d.DefaultElevationLayer.spatialReference);if(f&&c&&!f.equals(c))throw{msg:g.messages.elevationBasemapTitle,details:g.messages.elevationBasemapSR};a=a.basemapTerrain?a.basemapTerrain.tilingScheme:null;c=b?b.tileInfo:null;if(a&&c&&!a.compatibleWith(c))throw{msg:g.messages.elevationBasemapTitle,details:g.messages.elevationBasemapTS};},getBasemapTS:function(a){return(a=
a.baseLayers&&a.baseLayers.length?a.baseLayers.getItemAt(0):null)?new C(a.tileInfo):null},_allowBasemapToSwitchSR:function(a,b){var c=!b.map.layers.some(function(a){return"__basemapErrorFallbackLayer__"!==a.id&&"SilentContentLayer"!==a.id});return!a&&!d.spatialReferenceLocked&&c},_tilingSchemeEquals:function(a,b){var c=a.baseLayers&&a.baseLayers.items.length?a.baseLayers.items[0]:null;return c?b.basemapTerrain&&b.basemapTerrain.tilingScheme?b.basemapTerrain.tilingScheme.compatibleWith(c.tileInfo):
!0:!0},_resetView:function(a,b){b=b instanceof k?b.clone():k.fromJSON(b);a.basemap&&(a.basemap=null);a.spatialReference=b.clone()},setFromJSON:function(a,b,c,f){var e,g=a.map;try{e=d.fromJSONAndCopySubLayers(g.basemap,b,c)}catch(h){d._handleBasemapSetError(a,h);return}return d.validateAndSet(a,e,b.transparency,f)},isBasemapGlobalCapable:function(a){return 0<a.baseMapLayers.length&&a.baseMapLayers[0].resourceInfo?(a=a.baseMapLayers[0].resourceInfo.spatialReference,a instanceof k||(a=k.fromJSON(a)),
a.isWebMercator()):!0},getJsonBasemapSR:function(a){return 0<a.baseMapLayers.length&&a.baseMapLayers[0].resourceInfo?(a=a.baseMapLayers[0].resourceInfo.spatialReference,a instanceof k||(a=k.fromJSON(a)),a):k.WebMercator},getBasemapSR:function(a){if(a){if(a.baseLayers&&0<a.baseLayers.length&&a.baseLayers.getItemAt(0).spatialReference)return a.baseLayers.getItemAt(0).spatialReference;if(a.elevationLayers&&0<a.elevationLayers.length&&a.elevationLayers.getItemAt(0).spatialReference)return a.elevationLayers.getItemAt(0).spatialReference}return null},
_basemapLayersToJSON:function(a,b,c){a.forEach(function(a){var e={id:a.id},d=n.extrapolateTypeFromLayerInstance(a);"OpenStreetMap"!==d&&(e.url=a.url);null!=d&&(e.layerType=d);c&&(e.isReference=!0);b.push(e)});return b},toJSON:function(a,b){var c;b?(c={},c.visibility=b.visibility,null!=b.id&&(c.id=b.id),null!=b.title&&(c.title=b.title),c.baseMapLayers=[],d._basemapLayersToJSON(b.baseLayers,c.baseMapLayers),d._basemapLayersToJSON(b.referenceLayers,c.baseMapLayers,!0),c.elevationLayers=[],d._basemapLayersToJSON(b.elevationLayers,
c.elevationLayers)):c={id:"empty-basemap",baseMapLayers:[],elevationLayers:[]};void 0!==a.basemapTransparency&&0!==a.basemapTransparency&&(c.transparency=a.basemapTransparency);return c},applyTransparency:function(a,b){void 0!==b&&0!==b?(a.basemapTerrain.opacity=0.99,a.basemapTerrain.wireframe={mode:"shader",wireOpacity:1,surfaceOpacity:0,width:1,subdivision:"constant",subdivisionReduceLevels:2},a.basemapTerrain.frontMostTransparent=!0):(a.basemapTerrain.wireframe=!1,a.basemapTerrain.frontMostTransparent=
!1,a.basemapTerrain.opacity=1);a.basemapTransparency=b},getFirstLayer:function(a){return a.baseLayers&&a.baseLayers.getItemAt(0)||a.elevationLayers&&a.elevationLayers.getItemAt(0)},portal:null,spatialReferenceLocked:!1};d.defaultArcGISWorldElevationService=location.protocol+"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer";d.DefaultElevationLayer=new x({id:"globalElevation",url:d.defaultArcGISWorldElevationService});d.DefaultBasemapJson={baseMapLayers:[{id:"worldTopoBase",
opacity:1,visibility:!0,url:location.protocol+"//services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer"}],elevationLayers:[{id:"globalElevation",url:d.defaultArcGISWorldElevationService,layerType:"ArcGISTiledElevationServiceLayer"}],title:"Topographic"};return d});