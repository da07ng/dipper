// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/PublishTileServiceDlg","dojo/_base/declare dojo/on dojo/dom-attr dojo/query dojo/dom dojo/dom-style dojo/_base/lang dijit/_WidgetBase dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dojo/dom-construct dojo/string dojo/_base/window dojo/promise/all dojo/when dojo/Deferred dojo/_base/array dojo/cookie dojo/dom-class dojo/json dijit/registry dijit/form/TextBox dijit/form/RadioButton dijit/form/Select ./ConfirmDialog dijit/focus dojo/_base/event dojo/keys dojo/store/Memory ./_CreateItemUtilMixin ./ItemPropertiesDlg dojo/topic esri/Evented esri/arcgis/Portal ../../geow/Account ./_PublishTileServiceDlgMixin ../../util dojo/i18n!arcgisonline/nls/arcgisonline".split(" "),
function(q,h,C,e,D,E,b,r,s,t,F,G,H,I,J,k,K,L,M,u,N,O,P,Q,v,n,w,x,p,f,R,l,y,z,A,B,S,m){return q("arcgisonline.sharing.dijit.dialog.PublishTilesDlg2",[r,s,t,B,y],{baseClass:"esriPublishTilesDlg",showFolders:!1,templateString:'\x3cdiv data-dojo-attach-point\x3d"contentNode"\x3e\x3cp data-dojo-attach-point\x3d"_message"\x3e\x3c/p\x3e\x3cdiv data-dojo-attach-point\x3d"_itemPropertiesDlg"  data-dojo-type\x3d"arcgisonline/sharing/dijit/dialog/ItemPropertiesDlg" data-dojo-props\x3d"typeInfo:\'mapserver\', showFile:false, showUrl:false, showFolders:${showFolders}"\x3e\x3c/div\x3e\x3cdiv class\x3d"tileProperties"\x3e\x3clabel\x3e${i18n.publishTileServiceDlg.tileSchemeLabel}\x3c/label\x3e\x3cdiv class\x3d"tilePropertiesRadios"\x3e\x3cinput id\x3d"${id}-agoBasemap" data-dojo-attach-point\x3d"_agoBasemapRadio" data-dojo-type\x3d"dijit/form/RadioButton" data-dojo-props\x3d"checked:true" value\x3d"ago"/\x3e\x3clabel for\x3d"${id}-agoBasemap"\x3e${i18n.publishTileServiceDlg.matchAGOLBasemaps}\x3c/label\x3e\x3cbr /\x3e\x3cbr /\x3e\x3cinput id\x3d"${id}-custom" data-dojo-attach-point\x3d"_customBasemapRadio" data-dojo-type\x3d"dijit/form/RadioButton" data-dojo-props\x3d"checked:false" value\x3d"custom"/\x3e\x3clabel for\x3d"${id}-custom"\x3e${i18n.publishTileServiceDlg.matchOwnBasemap}\x3c/label\x3e\x3cinput data-dojo-attach-point\x3d"_customBasemapUrl" class\x3d"custom esriLeadingMargin2" data-dojo-type\x3d"dijit/form/TextBox" data-dojo-props\x3d"disabled:true,placeholder:\'${i18n.publishTileServiceDlg.tileSchemePlaceholder}\'"/\x3e\x3c/div\x3e\x3cdiv class\x3d"tilePropertiesSelects hide"\x3e\x3clabel class\x3d"tileRange"\x3e${i18n.publishTileServiceDlg.scaleRangeLabel}\x3c/label\x3e\x3cinput class\x3d"ago" style\x3d"width:150px;" data-dojo-attach-point\x3d"_scaleFrom" data-dojo-type\x3d"dijit/form/Select" data-dojo-props\x3d"labelAttr:\'label\', searchAttr:\'label\', sortByLabel:false, maxHeight:-1"/\x3e\x3clabel class\x3d"tileRange toLabel"\x3e${i18n.publishTileServiceDlg.toLabel}\x3c/label\x3e\x3cinput class\x3d"tileRange" style\x3d"width:150px;" data-dojo-attach-point\x3d"_scaleTo" data-dojo-type\x3d"dijit/form/Select" data-dojo-props\x3d"labelAttr:\'label\', searchAttr:\'label\', sortByLabel:false, maxHeight:-1"/\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e',
onDone:function(){},postMixInProperties:function(){this.inherited(arguments);this.i18n=b.mixin({},m);this._fromLODStore=new p({idProperty:"level",data:this.lods});this._toLODStore=new p({idProperty:"level",data:this.lods})},postCreate:function(){this.inherited(arguments);A.getSelf(b.hitch(this,function(a){this._loadConnections();this._portal=new z.Portal({url:esriGeowConfig.restBaseUrl,self:a});this._connect=this._portal.on("load",b.hitch(this,function(){this._connect.remove();this._portalUser=this._portal.getPortalUser();
this._restBaseUrl=esriGeowConfig.allSSL?this._portal.portalUrl.replace("http:/","https:/"):this._portal.portalUrl;this._contentUrl=this._restBaseUrl+"content";this._publishUrl=this._contentUrl+"/users/"+this._portalUser.username;this._itemPropertiesDlg.on("load",b.hitch(this,function(){this._loadData().then(b.hitch(this,function(a){this._itemPropertiesDlg.set("focus","title")}))}))}))}))},destroy:function(){e(".dijit",this.contentNode).map(dijit.byNode).forEach(function(a){a.destroyRecursive?a.destroyRecursive():
a.destroy&&a.destroy()});this._errorDlg&&(this._errorDlg.destroyRecursive(),this._errorDlg=null);this.inherited(arguments);this._tagsDijit=this._portalUser=this._portal=null},_loadConnections:function(){this.own(l.subscribe("dlg/onOk",b.hitch(this,function(){this._focusNode&&setTimeout(b.hitch(this,function(){n.focus(this._focusNode)}),250)})),l.subscribe("/esri/disable",b.hitch(this,function(a,c){this.set("disabled",a,c,!0)})),h(this._agoBasemapRadio,"click",b.hitch(this,function(){this._isUserDefinedTileInfo=
!1;this._customBasemapUrl.set("disabled",!0);this._updateLODs(this.lods);this.set("calculatedScales",this._computeMinAndMaxScales(this.lods,this._computeScale(this._featureServiceJson.initialExtent||this._featureServiceJson.fullExtent,this._featureServiceJson.spatialReference)))})),h(this._customBasemapRadio,"click",b.hitch(this,function(){e(".tilePropertiesSelects",this.domNode).addClass("hide");this._isUserDefinedTileInfo=!0;this._customBasemapUrl.set("disabled",!1);this.userDefinedTileInfo&&this._updateLODs(this.userDefinedTileInfo.lods)})),
h(this._customBasemapUrl,"keyup",b.hitch(this,function(a){a.keyCode===x.ENTER&&(w.stop(a),this._customBasemapUrl.onChange(this._customBasemapUrl.get("value")))})),h(this._customBasemapUrl,"change",b.hitch(this,function(a){a&&a.length?(this._customBasemapUrl.set("disabled",!0),this.set("disabled",!0,this.i18n.publishWizard.fetchingServiceInfo),this._fetchTileLayerInfo(a).then(b.hitch(this,function(a){this.userDefinedTileInfo=a;this._updateLODs(a.lods);this._customBasemapUrl.set("disabled",!1);this.set("disabled",
!1)}),b.hitch(this,function(a){this.userDefinedTileInfo=null;this._showError(a)}))):(this.userDefinedTileInfo=null,e(".tilePropertiesSelects",this.domNode).addClass("hide"))})))},_updateLODs:function(a){if(a=a||this.lods)this._fromLODStore.setData(a),this._scaleFrom.set("store",this._fromLODStore),this._toLODStore.setData(a),this._scaleTo.set("store",this._toLODStore),this.set("calculatedScales",this._computeMinAndMaxScales(a))},_loadData:function(){var a=new k;this.fsItem?(this.set("disabled",!0,
this.i18n.publishWizard.fetchingServiceInfo),this._selectedService=b.mixin({},this.fsItem),this._fetchFSInfo(this._selectedService).then(b.hitch(this,function(b){this._featureServiceJson=b.serviceInfo;this._selectedService.itemData=b.itemData;this._itemPropertiesDlg.set("summary",this._selectedService.snippet||this._selectedService.description||"");this._itemPropertiesDlg.set("tags",this._selectedService.tags);this._scaleFrom.set("store",this._fromLODStore);this._scaleTo.set("store",this._toLODStore);
this.set("calculatedScales",this._computeMinAndMaxScales(this.lods,this._computeScale(this._featureServiceJson.initialExtent||this._featureServiceJson.fullExtent,this._featureServiceJson.spatialReference)));this.set("disabled",!1);a.resolve(this._selectedService)}),b.hitch(this,function(b){this._showError(b);a.reject(b)}))):a.resolve(this._selectedService);return a},_setMessageAttr:{node:"_message",type:"innerHTML"},_setTypeAttr:function(a){this._type=a},_setShowFoldersAttr:function(a){this._showFolders=
a},_setItemAttr:function(a){if(!this.fsItem||this.fsItem&&a.url!==this.fsItem.url)this.fsItem=b.mixin({},a),this._created&&this._loadData().then(b.hitch(this,function(a){this._isUserDefinedTileInfo=!1;this._customBasemapUrl.set("disabled",!0);this._agoBasemapRadio.set("checked",!0);this._itemPropertiesDlg.set("focus","title")}))},_setFocusAttr:function(a){a=e(a,this.domNode);n.focus(a&&a.length?a[0]:this._title.domNode)},_setDisabledAttr:function(a,b,d){this.set("readOnly",a,b,d)},_setReadOnlyAttr:function(a,
b,d){e(".dijit",this.domNode).map(dijit.byNode).forEach(function(b){b.set("disabled",a)});e("a",this.domNode)[a?"addClass":"removeClass"]("disabledLink");e("label",this.domNode)[a?"addClass":"removeClass"]("disabled");this._itemPropertiesDlg.set("disabled",a);d||(a&&b&&l.publish("/dlg/busyMessage",b),l.publish("/esri/disable",a,b))},_setCalculatedScalesAttr:function(a){var b=a.lods,d=a.minLevel+2<b.length?a.minLevel+2:b.length-1;this._scaleFrom.set("value",b[-1<a.maxLevel-2?a.maxLevel-2:0].level);
this._scaleTo.set("value",b[d].level);e(".tilePropertiesSelects",this.domNode).removeClass("hide")},_getItemAttr:function(){var a=this._toLODStore.get(this._scaleTo.get("value")).scale,c=this._fromLODStore.get(this._scaleFrom.get("value")).scale,d=this._isUserDefinedTileInfo?b.clone(this.userDefinedTileInfo):b.clone(this.tileCacheInfo),e=b.clone(this.cacheStorageInfo),c={minScale:c,maxScale:a},a=this._itemPropertiesDlg.get("item");d.dpi&&!d.preciseDpi&&(d.preciseDpi=d.dpi);for(var f=0;f<d.lods.length;f++)delete d.lods[f].label;
d=b.mixin(c,{name:a.title.replace(/ /g,"_"),tilingSchema:{tileCacheInfo:d,tileImageInfo:this.tileImageInfo,cacheStorageInfo:e}});return{item:a,tilePublishContent:{itemid:this.fsItem.id,filetype:"featureService",publishParameters:d,outputType:"scenes"===this._type?"sceneService":"tiles",buildInitialCache:!1},tilePublishParams:d}},_validate:function(){var a=new k,c;this._focusNode=null;c=this._itemPropertiesDlg._validate();c=c.then(b.hitch(this,"_checkRequired"));c=c.then(b.hitch(this,function(b){a.resolve(b)}),
b.hitch(this,function(b){this._showError(b);a.reject(b)}));return a},_checkRequired:function(){var a=new k,c;this._featureServiceJson||(c=this.i18n.publishWizard.errors.selectedServiceNotExist);this._isUserDefinedTileInfo&&!this.userDefinedTileInfo&&(this._focusNode=e("input",this._customBasemapUrl.domNode)[0],c=this.i18n.publishWizard.errors.customTileBasemapNotSpecified);if(c)return a.reject(c),a;f.serviceNameAvailable(this._itemPropertiesDlg.get("item"),this._portal).then(b.hitch(this,function(b){!b||
!b.available?(this._focusNode=e("input",this._itemPropertiesDlg._title.domNode)[0],a.reject(m.addItemFrm.errors.serviceNameExists)):a.resolve(!0)}));return a},publishTileService:function(){var a=this.get("item"),c=a.tilePublishContent,d,e=new k,h=new k;f.publishItem(a,c,this._portal).then(b.hitch(this,function(c){var g=c&&c.publishResult?c.publishResult[0]:null;g&&g.error?(f.deleteItem({id:g.serviceItemId,folderId:this.fsItem.ownerFolder},this._portal),this._showError(g.error||m.addItemFrm.errors.error),
e.reject()):(f.checkStatus({id:g.serviceItemId,jobId:g.jobId},h,500,this._portal),h.then(b.hitch(this,function(c){f.moveItem({id:c.id,folderId:this.fsItem.ownerFolder},a.item.folderId,this._portal).then(b.hitch(this,function(c){d=b.mixin(a.item,c,this._selectedService.itemData?{text:u.stringify(this._selectedService.itemData)}:{});f.updateItem(d,this._portal).then(b.hitch(this,function(){this.set("disable",!1);e.resolve({id:g.serviceItemId,jobId:g.jobId})}))}))}),b.hitch(this,function(a){f.deleteItem({id:g.serviceItemId,
folderId:this.fsItem.ownerFolder},this._portal);this._showError(a)})))}),b.hitch(this,function(a){this._showError(a)}));return e},_showError:function(a){a=b.mixin(b.mixin({},m.publishWizard.errors.error),a);this._errorDlg=new v({showCancel:!1,style:{width:"400px",height:"auto"}});this._errorDlg.show(a).then(b.hitch(this,function(){this.set("disabled",!1);this._errorDlg.hide();this._focusNode&&setTimeout(b.hitch(this,function(){n.focus(this._focusNode)}),250)}));return!1}})});