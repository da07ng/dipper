// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/geow/Content",["dijit","dojo","dojox","dojo/require!arcgisonline/sharing/util,esri/arcgis/Portal"],function(l,f,m){f.provide("arcgisonline.sharing.geow.Content");f.require("arcgisonline.sharing.util");f.require("esri.arcgis.Portal");arcgisonline.sharing.geow.Content={util:arcgisonline.sharing.util,i18n:function(){if(this._i18n)return this._i18n;this._i18n=f.i18n.getLocalization("arcgisonline","arcgisonline").common;f.mixin(this._i18n,{source:f.i18n.getLocalization("arcgisonline",
"arcgisonline").itemProperties.source});return this._i18n},getUserInfo:function(a,c){var b=this.util.getUser();null!=b&&this.util.getJson(esriGeowConfig.restBaseUrl+"content/users/"+b.email,a,c)},getUserItems:function(a,c,b){var d=this.util.getUser();null!=d&&(d=esriGeowConfig.restBaseUrl+"content/users/"+d.email,null!=a&&""!=a&&(d=d+"/"+a),this.util.getJson(d,c,b))},getUserItemsByUser:function(a,c,b,d){null!=this.util.getUser()&&(a=esriGeowConfig.restBaseUrl+"content/users/"+a,null!=c&&""!=c&&(a=
a+"/"+c),this.util.getJson(a,b,d))},getUserServers:function(a){void 0!==this._userServers&&a(this._userServers);this.util.getJson(esriGeowConfig.serversRestBaseUrl,function(c){a(this._userServers=c.servers)},function(c){a(null)})},addItem:function(a,c,b,d){var e=this.util.getUser();if(null!=e){e=esriGeowConfig.restBaseUrl+"content/users/"+e.email;null!=a&&(e=e+"/"+a);e+="/addItem";a=!1;for(var g=0;g<c.childNodes.length;g++){var h=c.childNodes[g];if("async"===h.name&&"true"===h.value){a=!0;break}}a?
this.util.postForm(c,e,f.hitch(arcgisonline.sharing.geow.Content,"addItemAsyncHandler",b,d),d):this.util.postForm(c,e,b,d)}},addItemByUser:function(a,c,b,d,e){if(null!=this.util.getUser()){a=esriGeowConfig.restBaseUrl+"content/users/"+a;null!=c&&(a=a+"/"+c);a+="/addItem";c=!1;for(var g=0;g<b.childNodes.length;g++){var h=b.childNodes[g];if("async"===h.name&&"true"===h.value){c=!0;break}}c?this.util.postForm(b,a,f.hitch(arcgisonline.sharing.geow.Content,"addItemByUserAsyncHandler",d,e),e):this.util.postForm(b,
a,d,e)}},addItemAsyncHandler:function(a,c,b,d){b&&b.success&&!0===b.success?arcgisonline.sharing.geow.Content.itemStatus(b,f.hitch(arcgisonline.sharing.geow.Content,"itemStatusHandler",0,b,a,c),c):c(b,d)},addItemByUserAsyncHandler:function(a,c,b,d){b&&b.success&&!0===b.success?arcgisonline.sharing.geow.Content.itemStatus(b,f.hitch(arcgisonline.sharing.geow.Content,"itemStatusByUserHandler",0,b,a,c),c):c(b,d)},deleteService:function(a,c){this.getUserServers(f.hitch(this,function(b){if(b&&b.length&&
-1<a.indexOf(esriGeowConfig.featuresRestBaseUrl+b[0].id+"/")){b=esriGeowConfig.serversRestBaseUrl+b[0].id+"/arcgis/admin/services/";b+=a.substr(a.indexOf(c)).replace("/",".")+"/delete";esri.config.defaults.io.proxyUrl=esriGeowConfig.proxyServer;var d=f.hitch(this,function(a){esri.config.defaults.io.proxyUrl=null});this.util.postJson("",b,d,d)}}))},publishService:function(a,c,b,d){a=this.util.getUser();if(null!=a){a=esriGeowConfig.restBaseUrl+"content/users/"+a.email+"/publish";c=c.params;var e=f.hitch(this,
function(a){b(a)});this.util.postJson(c,a,f.hitch(this,function(a){a=a.services[0];a.success=a.success||a.serviceurl&&0<a.serviceurl.length;a.success?(a.id=a.serviceItemId,b(a)):e(a)}),f.hitch(this,function(a){e({success:!1})}))}},itemStatus:function(a,c,b){var d=this.util.getUser();if(null!=d){var e=a.folder,d=esriGeowConfig.restBaseUrl+"content/users/"+(a.overrideUser||d.email);e&&(0<e.length&&"/"!=e)&&(d+="/"+e);d=d+"/items/"+a.id+"/status";a.jobid&&(d+="?jobid\x3d"+a.jobid);this.util.getJson(d,
c,b)}},itemStatusByUser:function(a,c,b){if(null!=this.util.getUser()){var d=a.folder,e=esriGeowConfig.restBaseUrl+"content/users/"+a.owner;d&&(0<d.length&&"/"!=d)&&(e+="/"+d);e=e+"/items/"+a.id+"/status";this.util.getJson(e,c,b)}},itemStatusHandler:function(a,c,b,d,e,g){e&&e.status&&"processing"===e.status?(a++,setTimeout(f.hitch(this,function(){arcgisonline.sharing.geow.Content.itemStatus(c,f.hitch(arcgisonline.sharing.geow.Content,"itemStatusHandler",a,c,b,d),d)}),Math.min(1E3*Math.pow(2,a),6E4))):
(f.mixin(e,c),b(e,g))},itemStatusByUserHandler:function(a,c,b,d,e,g){e&&e.status&&"processing"===e.status?(a++,setTimeout(f.hitch(this,function(){arcgisonline.sharing.geow.Content.itemStatusByUser(c,f.hitch(arcgisonline.sharing.geow.Content,"itemStatusByUserHandler",a,c,b,d),d)}),Math.min(1E3*Math.pow(2,a),6E4))):(f.mixin(e,c),b(e,g))},deleteItems:function(a,c,b){var d=this.util.getUser();if(null!=d)if(1==a.length)a=a[0],d=esriGeowConfig.restBaseUrl+"content/users/"+d.email,null!=a.folderId&&(""!=
a.folderId&&"/"!=a.folderId)&&(d+="/"+a.folderId),d=d+"/items/"+a.id+"/delete",this.util.postJson("",d,c,b);else if(1<a.length){var e="",g="";f.forEach(a,function(a){e+=g+a.id;g=","},this);a={items:e};d=esriGeowConfig.restBaseUrl+"content/users/"+d.email+"/deleteItems";this.util.postJson(a,d,c,b)}},deleteItemsByUser:function(a,c,b,d){if(null!=this.util.getUser())if(1==c.length)c=c[0],a=esriGeowConfig.restBaseUrl+"content/users/"+a,null!=c.folderId&&(""!=c.folderId&&"/"!=c.folderId)&&(a+="/"+c.folderId),
a=a+"/items/"+c.id+"/delete",this.util.postJson("",a,b,d);else if(1<c.length){var e="",g="";f.forEach(c,function(a){e+=g+a.id;g=","},this);c={items:e};a=esriGeowConfig.restBaseUrl+"content/users/"+a+"/deleteItems";this.util.postJson(c,a,b,d)}},getApplicationCode:function(a,c,b){var d=null,e="WMA2Code";f.isObject(a)?(d=a.id,"Mobile Application"===a.type&&(e="MobileApp2Code")):d=a;this.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+d+"/relatedItems?relationshipType\x3d"+e,c,b)},addApplicationCodeRelate:function(a,
c,b,d){var e=this.util.getUser();if(null==e)f.publish("globalMessage",[{message:this.i18n().mustLogIn,type:"error",duration:0}]);else{var g=null,h="WMA2Code";f.isObject(a)?(g=a.id,"Mobile Application"===a.type&&(h="MobileApp2Code")):g=a;this.util.postJson({relationshipType:h,originItemId:g,desinationItemId:c},esriGeowConfig.restBaseUrl+"content/users/"+e.email+"/addRelationship?relationshipType\x3d"+h+"\x26originItem\x3d"+g+"\x26destinationItemId\x3d"+c,b,d)}},getComments:function(a,c,b,d){this.util.getJson(esriGeowConfig.restBaseUrl+
"content/items/"+a+"/comments",b,d)},addComment:function(a,c,b,d){null==this.util.getUser()?f.publish("globalMessage",[{message:this.i18n().mustLogIn,type:"error",duration:0}]):this.util.postJson({comment:c},esriGeowConfig.restBaseUrl+"content/items/"+a+"/addComment",b,d)},deleteComment:function(a,c,b,d){null==this.util.getUser()?f.publish("globalMessage",[{message:this.i18n().mustLogIn,type:"error",duration:0}]):this.util.postJson({},esriGeowConfig.restBaseUrl+"content/items/"+a+"/comments/"+c+"/delete",
b,d)},addRating:function(a,c,b,d){null==this.util.getUser()?f.publish("globalMessage",[{message:this.i18n().mustLogIn,type:"error",duration:0}]):this.util.postJson({rating:c},esriGeowConfig.restBaseUrl+"content/items/"+a+"/addRating",b,d)},getRating:function(a,c,b){null!=this.util.getUser()&&this.util.postJson({},esriGeowConfig.restBaseUrl+"content/items/"+a+"/rating",c,b)},deleteItem:function(a,c,b){var d=this.util.getUser();if(null!=d){var d=esriGeowConfig.restBaseUrl+"content/users/"+(a.owner||
d.email),e=a.ownerFolder||a.folderId;e&&"/"!==e&&(d=d+"/"+e);d=d+"/items/"+a.id+"/delete";this.util.postJson("",d,c,b)}},deleteItemByUser:function(a,c,b){if(null!=this.util.getUser()){var d=esriGeowConfig.restBaseUrl+"content/users/"+a.owner;null!=a.folderId&&(d=d+"/"+a.folderId);d=d+"/items/"+a.id+"/delete";this.util.postJson("",d,c,b)}},updateItem:function(a,c,b,d){var e=this.util.getUser();null!=e&&(e=esriGeowConfig.restBaseUrl+"content/users/"+(a.owner||e.email),null!=a.folderId&&(e=e+"/"+a.folderId),
e=e+"/items/"+a.id+"/update",this.util.postForm(c,e,b,d))},updateItemByUser:function(a,c,b,d){if(null!=this.util.getUser()){var e=esriGeowConfig.restBaseUrl+"content/users/"+a.owner;null!=a.folderId&&(e=e+"/"+a.folderId);e=e+"/items/"+a.id+"/update";this.util.postForm(c,e,b,d)}},updateItemJson:function(a,c,b,d){var e=this.util.getUser();null!=e&&(e=esriGeowConfig.restBaseUrl+"content/users/"+(a.overrideUser||e.email),null!=a.folderId&&(e=e+"/"+a.folderId),e=e+"/items/"+a.id+"/update",this.util.postJson(c,
e,b,d))},updateItemJsonByUser:function(a,c,b,d){null!=this.util.getUser()&&(a=esriGeowConfig.restBaseUrl+"content/users/"+a,null!=c.folderId&&(a=a+"/"+c.folderId),a=a+"/items/"+c.id+"/update",this.util.postJson(b,a,d))},filterErrors:function(a){if((a=a&&a.results)&&a.length)if((a=f.filter(a,"return item.error"))&&a.length)return this.util.checkError(a[0].error),a;return!1},shareItems:function(a,c,b){var d=this.util.getUser();null!=d&&this.util.postJson(a,esriGeowConfig.restBaseUrl+"content/users/"+
(a.owner||d.email)+"/shareItems",f.hitch(this,function(a){var d=this.filterErrors(a);d?b(d):c(a)}),b)},shareItemsByUser:function(a,c,b,d){null!=this.util.getUser()&&this.util.postJson(c,esriGeowConfig.restBaseUrl+"content/users/"+a+"/shareItems",b,d)},shareItem:function(a,c,b,d){var e=this.util.getUser();null!=e&&(e=esriGeowConfig.restBaseUrl+"content/users/"+e.email,null!=a.folderId&&(e=e+"/"+a.folderId),e=e+"/items/"+a.id+"/share",this.util.postJson(c,e,b,d))},shareItemByID:function(a,c,b,d){null!=
this.util.getUser()&&this.util.postJson(c,esriGeowConfig.restBaseUrl+"content/items/"+a.id+"/share",b,d)},unshareItems:function(a,c,b){var d=this.util.getUser();null!=d&&this.util.postJson(a,esriGeowConfig.restBaseUrl+"content/users/"+(a.owner||d.email)+"/unshareItems",f.hitch(this,function(a){var d=this.filterErrors(a);d?b(d):c(a)}),b)},unshareItemsByUser:function(a,c,b,d){null!=this.util.getUser()&&this.util.postJson(c,esriGeowConfig.restBaseUrl+"content/users/"+a+"/unshareItems",b,d)},unshareItem:function(a,
c,b,d){var e=this.util.getUser();null!=e&&(e=esriGeowConfig.restBaseUrl+"content/users/"+e.email,null!=a.folderId&&(e=e+"/"+a.folderId),e=e+"/items/"+a.id+"/unshare",this.util.postJson(c,e,b,d))},unshareItemByID:function(a,c,b,d){null!=this.util.getUser()&&this.util.postJson(c,esriGeowConfig.restBaseUrl+"content/items/"+a.id+"/unshare",b,d)},moveItems:function(a,c,b,d){var e=this.util.getUser();if(null!=e){var g="",h="";f.forEach(a,function(a){g+=h+a.id;h=","},this);c.items=g;this.util.postJson(c,
esriGeowConfig.restBaseUrl+"content/users/"+e.email+"/moveItems",b,d)}},moveItemsByUser:function(a,c,b,d,e){if(null!=this.util.getUser()){var g="",h="";f.forEach(c,function(a){g+=h+a.id;h=","},this);b.items=g;this.util.postJson(b,esriGeowConfig.restBaseUrl+"content/users/"+a+"/moveItems",d,e)}},reassignItem:function(a,c,b,d,e){if(null!=this.util.getUser()){var g=esriGeowConfig.restBaseUrl+"content/users/"+a.owner;null!==a.folderId&&(g=g+"/"+a.folderId);g=g+"/items/"+a.id+"/reassign";this.util.postJson({targetUsername:c,
targetFolderName:b},g,d,e)}},moveItem:function(a,c,b,d){var e=this.util.getUser();null!=e&&(e=esriGeowConfig.restBaseUrl+"content/users/"+e.email,null!=a.folderId&&(e=e+"/"+a.folderId),e=e+"/items/"+a.id+"/move",this.util.postJson(c,e,b,d))},moveItemByUser:function(a,c,b,d){if(null!=this.util.getUser()){var e=esriGeowConfig.restBaseUrl+"content/users/"+a.owner;null!=a.folderId&&(e=e+"/"+a.folderId);e=e+"/items/"+a.id+"/move";this.util.postJson(c,e,b,d)}},search:function(a,c,b,d){if(a){d="";if(0>a.indexOf("community/groups")){var e=
this.util.userPreferences(null,"contentModePrefs"),g=f.queryToObject(window.location.search.slice(1));g.content&&"all"===g.content.toLowerCase()?e.contentMode="GIS":g.content&&"web"===g.content.toLowerCase()&&(e.contentMode="Web");d=e&&e.contentMode&&"GIS"===e.contentMode?esriGeowConfig.viewQueries.gis:d+esriGeowConfig.viewQueries.web;d+=esriGeowConfig.viewQueries.none}c.q+=d;this.util.getJsonWithContent(a,c,b)}},getFeaturedItems:function(a,c,b){this.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+
a+"/relatedItems?relationshipType\x3dFeaturedItems2Item\x26direction\x3dforward",c)},getUserItem:function(a,c,b){b=this.util.getUser();null!=b&&(b=esriGeowConfig.restBaseUrl+"content/users/"+b.email,null!=a.folderId&&(b=b+"/"+a.folderId),b=b+"/items/"+a.id,this.util.getJson(b,c))},getItem:function(a,c,b){this.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+a,c,b)},getItemData:function(a,c,b){this.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+a+"/data",c,b)},getItemFolder:function(a,
c){var b=this.util.getUser();null!=b&&this.util.getJson(esriGeowConfig.restBaseUrl+"content/users/"+b.email,f.hitch(this,function(d,e){for(var g=null,h=0;h<d.items.length;h++)if(d.items[h].id==a){g="";break}if(null!=g)c(g);else{var k=function(b,d){for(var e=b.currentFolder.id,f=0;f<b.items.length;f++)if(b.items[f].id==a){g=e;c(g);break}};f.forEach(d.folders,function(a,d){this.util.getJson(esriGeowConfig.restBaseUrl+"content/users/"+b.email+"/"+a.folderName,f.hitch(this,k))},this)}}))},itemsToStore:function(a){var c=
a.currentFolder?a.currentFolder.id:"",b=[];f.forEach(a.items,function(a,e){a.folderId=c;a.imageUrl=this._getItemIconUrl(a);a.selected=!1;a.item=a.name||a.url||a.title;if(a.snippet&&0<a.snippet.length&&"null"!=a.snippet)a.snippet=a.snippet;else if(a.description&&0<a.description.length&&"null"!=a.description){var f=arcgisonline.sharing.util.removeHTMLTags(a.description);a.snippet=150<f.length?f.substring(0,150)+"...":f}else a.snippet="";delete a.listingProperties;delete a.properties;b[e]=a},this);return new f.data.ItemFileWriteStore({data:{identifier:"id",
label:"item",items:b}})},searchToStore:function(a){var c=[];f.forEach(a.items?a.items:a.results,function(a,d){var e={id:a.id,owner:a.owner,title:a.title,description:a.description,tags:a.tags?a.tags.join(","):[],imageUrl:this._getItemImageUrl(a),created:a.created,modified:a.modified};c[d]=e},this);return new f.data.ItemFileReadStore({data:{identifier:"id",label:"item",items:c}})},_getPremiumItemNode:function(a){var c=(new esri.arcgis.PortalItem(a)).getTypeInfo();a=-1<f.indexOf(a.typeKeywords,"Requires Credits");
return c.isPremiumContent?(a=f.create("div",{className:"esri-premium-content",title:a?this.i18n().premiumcontentcreditstitle:this.i18n().premiumcontenttitle,innerHTML:a?this.i18n().premiumcontent:this.i18n().subscriptioncontent}),f.create("img",{className:"esri-premium-icon",src:c.premiumIconUrl},a,"first"),a):!1},_getItemIconUrl:function(a){return(new esri.arcgis.PortalItem(a)).iconUrl},_getItemImageUrl:function(a,c){var b=a.type?a.type.toLowerCase():"";return this.util.relativeToExplicitUrl("geocoding service"==
b||"network analysis service"==b||"geoprocessing service"==b||"geodata service"==b||"geometry service"==b||"workflow manager service"==b?c?"images/tool_16x16.png":"images/tool_32x32.png":"wms"==b||"kml"==b||"globe service"==b||"map service"==b||"image service"==b||"feature service"==b||"scene service"===b||"stream service"===b?c?"images/layer_16x16.png":"images/layer_32x32.png":"web mapping application"==b||"mobile application"==b||"web map"==b?c?"images/map_16x16.png":"images/map_32x32.png":"layer"==
b||"layer package"==b||"tile package"===b||"vector tile package"===b||"scene package"===b||"explorer layer"==b||"cad drawing"===b?c?"images/layer-download_16x16.png":"images/layer-download_32x32.png":"explorer add in"==b||"desktop add in"==b||"geoprocessing package"==b||"locator package"==b?c?"images/tool-download_16x16.png":"images/tool-download_32x32.png":c?"images/map-download_16x16.png":"images/map-download_32x32.png")},changeTypename:function(a,c){var b=new esri.arcgis.PortalItem(a),d=b.getTypeInfo(),
e=-1<f.indexOf(a.typeKeywords,"ArcGIS Server")||"Feature Collection"==a.type?this.i18n().source+" ":"";return c?"\x3cspan title\x3d'"+e+b.type+"'\x3e"+d.displayName+"\x3c/\x3e":d.displayName},getFavorites:function(){var a,c={};return this.util.request({url:esriGeowConfig.restBaseUrl+"content/groups/"+esriGeowConfig.self.user.favGroupId}).then(f.hitch(this,function(b){a=b.items||[];f.forEach(a,f.hitch(this,function(a){c[a.id]=!0}));return c}))},addToFavorites:function(a){var c=this.util.getUser().favGroupId;
return this.util.request({url:esriGeowConfig.restBaseUrl+"content/items/"+a.id+"/share",content:{f:"json",everyone:a.access&&"public"===a.access||a.sharing&&a.sharing.access&&"public"===a.sharing.access||!1,org:a.access&&"org"===a.access||a.sharing&&a.sharing.access&&"org"===a.sharing.access||!1,groups:[c],items:[a.id]}},{usePost:!0})},removeFromFavorites:function(a){var c=this.util.getUser().favGroupId;return this.util.request({url:esriGeowConfig.restBaseUrl+"content/items/"+a.id+"/unshare",content:{f:"json",
everyone:!1,org:!1,groups:[c],items:[a.id]}},{usePost:!0})}}});