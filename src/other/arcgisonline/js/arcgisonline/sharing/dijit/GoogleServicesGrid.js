// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/GoogleServicesGrid",["dijit","dojo","dojox","dojo/require!dijit/_Widget,dojox/rpc/Service,dojo/rpc/JsonService,dijit/Toolbar,dojox/wire/ml/Invocation,dojox/wire/ml/Transfer,dojox/wire/ml/Action,arcgisonline/sharing/geow/GoogleSearchStore,arcgisonline/sharing/geow/QueryReadStore,dojox/grid/DataGrid,arcgisonline/sharing/util"],function(l,b,p){b.provide("arcgisonline.sharing.dijit.GoogleServicesGrid");b.require("dijit._Widget");b.require("dojox.rpc.Service");b.require("dojo.rpc.JsonService");
b.require("dijit.Toolbar");b.require("dojox.wire.ml.Invocation");b.require("dojox.wire.ml.Transfer");b.require("dojox.wire.ml.Action");b.require("arcgisonline.sharing.geow.GoogleSearchStore");b.require("arcgisonline.sharing.geow.QueryReadStore");b.require("dojox.grid.DataGrid");b.require("arcgisonline.sharing.util");b.declare("arcgisonline.sharing.dijit.GoogleServicesGrid",[l._Widget],{i18n:null,id:"googleServicesGrid",isStarted:!1,searchGrid:null,initialized:!1,cleared:!1,ts:null,allItemsByIdentity:{},
lastQueryString:"",lastResultCount:-1,width:100,timerArray:[],lastOpenDropDown:null,gridScrollBox:null,scrollTopPos:0,listExpanded:!1,layerAddedHandler:null,layerAddFailedHandler:null,layerAddedIds:[],_eventConnections:[],_util:arcgisonline.sharing.util,constructor:function(a,b){null!=a&&a.w&&(this.width=a.w)},postMixInProperties:function(){this.inherited(arguments);this.i18n=b.i18n.getLocalization("arcgisonline","arcgisonline").common;b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").googleServicesGrid)},
postCreate:function(){var a=[[{get:arcgisonline.sharing.dijit.GoogleServicesGrid.formatters.blank,formatter:arcgisonline.sharing.util.fix,width:"auto"}]];this.searchGrid=new p.grid.DataGrid({store:new arcgisonline.sharing.geow.QueryReadStore,structure:a,region:"center",id:"googleServicesNode"});container.addChild(this.searchGrid);this.searchGrid.startup();this.searchGrid.showMessage("\x3cspan style\x3d'font-size:1em;color:#7a7979;'\x3e"+this.i18n.clickToStart+"\x3c/span\x3e");b.style(this.searchGrid.messagesNode,
"height","100%");this.gridScrollBox=this.searchGrid.views.views[0].scrollboxNode;b.connect(this.searchGrid,"onRowClick",b.hitch(this,"onRowClick"));esri.isTouchEnabled&&(a=esri.setScrollable(this.gridScrollBox),this._eventConnections.push(a[0],a[1]))},newSearch:function(a){this.layerAddedHandler&&b.unsubscribe(this.layerAddedHandler);this.layerAddFailedHandler&&b.unsubscribe(this.layerAddFailedHandler);this.allItemsByIdentity={};this.lastQueryString=a;0<a.length&&-1<a.indexOf(" ")&&(a='"'+a+'"');
this.initialized?(this.searchGrid.store._totalCount=0,this.searchGrid.setQuery({text:a+" "+esriGeowConfig.googleServiceSearchString})):(b.byId("googleServicesNode")&&(this.width=b.coords(b.byId("googleServicesNode")).w),this.searchGrid&&this.searchGrid.destroy(),this.createGrid(a))},createGrid:function(a){var g=[[{get:arcgisonline.sharing.dijit.GoogleServicesGrid.formatters.title,formatter:arcgisonline.sharing.util.fix,width:"auto"},{get:arcgisonline.sharing.dijit.GoogleServicesGrid.formatters.blank,
formatter:arcgisonline.sharing.util.fix,width:"10px"}]];this.ts=new arcgisonline.sharing.geow.GoogleSearchStore;this.allItemsByIdentity={};this.searchGrid=new p.grid.DataGrid({query:{text:a+" "+esriGeowConfig.googleServiceSearchString},store:this.ts,structure:g,rowsPerPage:8,noDataMessage:"\x3cspan style\x3d'font-size:1em;color:#7a7979;'\x3e"+this.i18n.error.noMatch+"\x3c/span\x3e",loadingMessage:'\x3cdiv class\x3d"throb-loading-grid"\x3e\x3cdiv class\x3d"throb-loading-grid-text"\x3e'+this.i18n.searching+
"\x3c/div\x3e\x3c/div\x3e",region:"center",id:"googleServicesNode",selectionMode:"none",style:"width:"+this.width+"px"});container.addChild(this.searchGrid);this.searchGrid.startup();this.initialized=!0;b.style(this.searchGrid.messagesNode,"height","100%");this.gridScrollBox=this.searchGrid.views.views[0].scrollboxNode;b.connect(this.searchGrid,"onRowClick",b.hitch(this,"onRowClick"));esri.isTouchEnabled&&(a=esri.setScrollable(this.gridScrollBox),this._eventConnections.push(a[0],a[1]))},clear:function(){this.lastQueryString=
"";this.searchGrid&&(this.lastResultCount=-1,this.width=b.coords(b.byId("googleServicesNode")).w,this.searchGrid&&(this.searchGrid.destroy(),this.searchGrid=null),b.forEach(this._eventConnections,b.disconnect),this.initialized=!1)},onRowClick:function(a){-1<a.target.id.indexOf("_title")&&(this.scrollTopPos=this.gridScrollBox.scrollTop)},hide:function(){},destroy:function(){this.inherited(arguments);b.forEach(this._eventConnections,b.disconnect)},onMouseOver:function(a){if(!1==this.listExpanded){this.listExpanded=
!0;var g=b.query(".dojoxGridContent","googleServicesNode");0<g.length&&b.style(g[0],"height",b.style(g[0],"height")+20+"px")}b.style(b.byId(a+"_addIcon"),"display","block")},onMouseOut:function(a){b.style(b.byId(a+"_addIcon"),"display","none")},tooltipInfo:function(a,g,d){if(l.byId(d+"_dropDownButton"))l.byId(d+"_dropDownButton")._openDropDown(b.byId(d+"_toolTipLaunch")),this.lastOpenDropDown=l.byId(d+"_dropDownButton"),this.gridScrollBox.scrollTop=this.scrollTopPos;else{var c;c='\x3cdiv dojoType\x3d"dijit.TooltipDialog" style\x3d"width:350px;"\x3e'+
('\x3cdiv style\x3d"float:right;"\x3e\x3cA href\x3d"JavaScript:dijit.byId(\''+this.id+"').hideTooltip('"+d+'\');" title\x3d"'+this.i18n.close+"\"\x3e\x3cimg src\x3d'"+this._util.relativeToExplicitUrl("images/close.gif")+'\' border\x3d"0"/\x3e\x3c/A\x3e\x3c/div\x3e');c+='\x3cdiv id\x3d"'+d+'_toolTip_message" class\x3d"tooltipLink" style\x3d"height:180px;"\x3e'+this.i18n.loading+"\x3c/div\x3e";c+="\x3c/div\x3e";b.parser.parse(b.byId(d+"_row"));l.byId(d+"_toolTip").set("content",c);l.byId(d+"_dropDownButton")._openDropDown(b.byId(d+
"_toolTipLaunch"));this.lastOpenDropDown=l.byId(d+"_dropDownButton");this.gridScrollBox.scrollTop=this.scrollTopPos;var k=this.id,h=function(a,c){clearTimeout(f);var h="",h=a&&a.details&&0<a.details.length?a.details[0]:a&&500==a.code?this.i18n.error.noResponse:b.string.substitute(this.i18n.error.inaccessible,{title:g});if(l.byId(d+"_toolTip_message"))l.byId(d+"_toolTip_message").set("content",h);else{var m;m='\x3cdiv dojoType\x3d"dijit.TooltipDialog" style\x3d"width:350px;"\x3e'+('\x3cdiv style\x3d"float:right;"\x3e\x3cA href\x3d"JavaScript:dijit.byId(\''+
k+"').hideTooltip('"+d+'\');" title\x3d"'+this.i18n.close+"\"\x3e\x3cimg src\x3d'"+this._util.relativeToExplicitUrl("images/close.gif")+'\' border\x3d"0"/\x3e\x3c/A\x3e\x3c/div\x3e');m+='\x3cdiv id\x3d"'+d+'_toolTip_message" class\x3d"tooltipLink" style\x3d"height:180px;"\x3e'+h+"\x3c/div\x3e";m+="\x3c/div\x3e";b.parser.parse(b.byId(d+"_row"));l.byId(d+"_toolTip").set("content",m);l.byId(d+"_dropDownButton")._openDropDown(b.byId(d+"_toolTipLaunch"))}},f=setTimeout(function(){clearTimeout(f);h()},
15E3);arcgisonline.sharing.util.getJson(a,b.hitch(this,function(c,k){clearTimeout(f);var h="",m="",n="",e="";if(-1<a.indexOf("/MapServer")||-1<a.indexOf("/ImageServer")){null!=c.documentInfo?(h=g,m=c.documentInfo.Author):h=c.name;h=h.replace(/^[\t\n\r\s]*|[\t\n\r\s]*$/g,"");0==h.length&&(h=a.toLowerCase().indexOf("/rest/services"),n=a.toLowerCase().indexOf("/",h+16),h=a.substring(h+15,n));g!=h&&(h=g+'\x3cbr/\x3e"'+h+'"');e=arcgisonline.sharing.util.removeHTMLTags(c.serviceDescription);if((null==e||
0==e.length)&&null!=c.description&&0<c.description.length)e=c.description;n=150<e.length?b.string.substitute(this.i18n.shortenedText,{text:e.substring(0,150)}):e}else h=g;e='\x3cdiv dojoType\x3d"dijit.TooltipDialog" style\x3d"width:350px;"\x3e'+('\x3cdiv class\x3d"esriFloatTrailing"\x3e\x3cA href\x3d"JavaScript:dijit.byId(\''+this.id+"').hideTooltip('"+d+'\');" title\x3d"'+this.i18n.close+"\"\x3e\x3cimg src\x3d'"+this._util.relativeToExplicitUrl("images/close.gif")+'\' border\x3d"0"/\x3e\x3c/A\x3e\x3c/div\x3e');
e=e+('\x3cdiv class\x3d"tooltipTitle"\x3e'+h+"\x3c/div\x3e")+"\x3ctable cellpadding\x3d'0' cellspacing\x3d'0' width\x3d'100%'\x3e\x3ctr width\x3d'100%'\x3e\x3ctd width\x3d'160'\x3e";e+='\t\x3cdiv id\x3d"'+d+'_item-thumbnail" class\x3d"esriWebThumbnail"\x3e\x3c/div\x3e';e+='\x3c/td\x3e\x3ctd width\x3d"15"\x3e';e+='\t\x3cdiv style\x3d"width:15px;"\x3e\x3c/div\x3e';e+='\x3c/td\x3e\x3ctd width\x3d"100%" valign\x3d"top"\x3e';e+="  \x3cspan class\x3d\"tooltipLink\"\x3e\x3ca href\x3d\"JavaScript:dijit.byId('googleServicesGrid').addLayer('"+
a+"','"+d+"');dijit.byId('"+this.id+"').hideTooltip('"+d+"');\"\x3e"+this.i18n.addToMap+"\x3c/A\x3e\x3c/span\x3e";e+='\t\x3cdiv style\x3d"height:7px;"\x3e\x26nbsp;\x3c/div\x3e';e+='\t\x3cspan class\x3d"tooltipLink"\x3e\x3ca href\x3d"'+a+'" target\x3d"_blank"\x3e'+this.i18n.serviceDetails+"\x3c/A\x3e\x3c/span\x3e";e+='\t\x3cdiv style\x3d"height:7px;"\x3e\x26nbsp;\x3c/div\x3e';e+="\t\x3cspan class\x3d\"tooltipLink\"\x3e\x3ca href\x3d\"JavaScript:dijit.byId('addContentPanel').exploreArcGISServer('"+
a.substring(0,a.toLowerCase().indexOf("/rest/services")+14)+"');dijit.byId('"+this.id+"').hideTooltip('"+d+"');\"\x3e"+this.i18n.explore+"\x3c/A\x3e\x3c/span\x3e";if(-1<a.indexOf("/MapServer")||-1<a.indexOf("/ImageServer"))e+='\t\x3cdiv style\x3d"height:7px;"\x3e\x26nbsp;\x3c/div\x3e',e+='\t\x3cspan class\x3d"tooltipLink"\x3e\x3ca href\x3d"JavaScript:arcgisonline.map.save_open.switchBaseMapByUrl(\''+a+"');dijit.byId('"+this.id+"').hideTooltip('"+d+"');\"\x3e"+this.i18n.useAsBasemap+"\x3c/A\x3e\x3c/span\x3e";
e+="\x3c/td\x3e\x3c/tr\x3e\x3c/table\x3e";e+="\x3cbr /\x3e";null!=c.documentInfo&&(e+='\x3ctable\x3e\x3ctbody\x3e\x3ctr\x3e\x3ctd nowrap valign\x3d"top"\x3e',e+='\x3cspan class\x3d"tooltipTitle"\x3e'+this.i18n.authorLabel+"\x3c/span\x3e",e+="\x3c/td\x3e\x3ctd\x3e",e+='\x3cspan id\x3d"item-owner" style\x3d"padding-left:10px;"\x3e'+m+"\x3c/span\x3e",e+="\x3c/td\x3e\x3c/tr\x3e\x3c/tbody\x3e\x3c/table\x3e",e+="\x3cbr /\x3e");if(-1<a.indexOf("/MapServer")||-1<a.indexOf("/ImageServer"))e+='\x3cspan class\x3d"tooltipTitle" style\x3d"line-height:20px;"\x3e'+
this.i18n.summaryLabel+"\x3c/span\x3e",e+="\x3cbr /\x3e",e+='\x3cdiv id\x3d"item-summary"\x3e'+n+"\x3c/div\x3e";e+="\x3c/div\x3e";b.parser.parse(b.byId(d+"_row"));l.byId(d+"_toolTip").set("content",e);l.byId(d+"_dropDownButton")._openDropDown(b.byId(d+"_toolTipLaunch"));-1<a.indexOf("/FeatureServer")?arcgisonline.sharing.util.getJson(a+"/"+c.layers[0].id,b.hitch(this,function(b,c){this.getThumbnailImage(a,b,d)})):this.getThumbnailImage(a,c,d)}),b.hitch(this,h))}},getThumbnailImage:function(a,g,d){var c=
g.initialExtent;null==c&&(c=g.extent);c=""+Math.round(1E3*c.xmin)/1E3+","+Math.round(1E3*c.ymin)/1E3+","+Math.round(1E3*c.xmax)/1E3+","+Math.round(1E3*c.ymax)/1E3;if(-1<a.indexOf("/FeatureServer")){var k=null,h=a.indexOf("/FeatureServer/");-1==h?a=a.replace("/FeatureServer","/MapServer"):(k=a.substring(h+15,a.length),a=a.substring(0,h)+"/MapServer");a=arcgisonline.map.main.buildExportCall(a,c,null,null,"150,100",null,"image",k,g)}else a=arcgisonline.map.main.buildExportCall(a,c,null,null,"150,100",
null,"image",null,g);b.byId(d+"_item-thumbnail").innerHTML='\x3cspan id\x3d"'+d+'_item-thumbnail_span" style\x3d"width:150px;height:100px;background-image:url(\''+this._util.relativeToExplicitUrl("images/web-thumbnail-loading.png")+'\');background-repeat:no-repeat;display:inline-block;"\x3e\x3cimg src\x3d"'+a+'" id\x3d"'+d+'_item-thumbnail_img" border\x3d"0"/\x3e\x3c/span\x3e';b.connect(b.byId(d+"_item-thumbnail_img"),"onload",b.hitch(this,"onImageLoad",d));this.timerArray[d]=setTimeout(b.hitch(this,
"onImageLoadTimeout",d),1E4)},onImageLoad:function(a){clearTimeout(this.timerArray[a]);b.byId(a+"_item-thumbnail_span").style.background="url('"+this._util.relativeToExplicitUrl("images/transparent.gif")+"') top left no-repeat"},onImageLoadTimeout:function(a){var g=this._util.relativeToExplicitUrl("images/web-thumbnail-error.png");b.style(b.byId(a+"_item-thumbnail_span"),"backgroundImage","url('"+g+"')")},hideTooltip:function(a){this.lastOpenDropDown&&this.lastOpenDropDown._closeDropDown();null==
this.lastOpenDropDown},addLayer:function(a,g){this.disconnectHandlers();b.byId(g+"_link").innerHTML="\x3cspan style\x3d'color:#999;'\x3e\x3cdiv class\x3d'circularLoadingIcon esriFloatTrailing'\x3e\x3c/div\x3e\x3c/span\x3e";this.layerAddedHandler=b.subscribe("layerAdded",b.hitch(this,"onLayerAdded",a,g));this.layerAddFailedHandler=b.subscribe("layerAddFailed",b.hitch(this,"onLayerAddFailed",g));arcgisonline.map.save_open.addServiceByUrl(a,null)},removeLayer:function(a,g,d){var c=this.allItemsByIdentity[g];
c&&(c.status="new");this.disconnectHandlers();d=d.split(",");for(c=0;c<d.length;c++)b.byId(g+"_link").innerHTML="\x3ca href\x3d\"JavaScript:dijit.byId('googleServicesGrid').addLayer('"+a+"','"+g+"');\"\x3e"+this.i18n.add+"\x3c/A\x3e",arcgisonline.map.layer.removeCompleteLayer(d[c])},onLayerAdded:function(a,g,d){this.layerAddedIds.push(d);if(d=this.allItemsByIdentity[g])d.status="added",d.layerAddedIds=this.layerAddedIds.toString();b.byId(g+"_link").innerHTML="\x3ca href\x3d\"JavaScript:dijit.byId('googleServicesGrid').removeLayer('"+
a+"','"+g+"','"+this.layerAddedIds.toString()+"');\"\x3e"+this.i18n.remove+"\x3c/A\x3e"},onLayerAddFailed:function(a){if(0==this.layerAddedIds.length){var g=this.allItemsByIdentity[a];g&&(g.status="unavailable");b.byId(a+"_link").innerHTML="\x3cspan style\x3d'color:#999;'\x3e"+this.i18n.unavailable+"\x3c/span\x3e"}},disconnectHandlers:function(){this.layerAddedIds=[];this.layerAddedHandler&&b.unsubscribe(this.layerAddedHandler);this.layerAddFailedHandler&&b.unsubscribe(this.layerAddFailedHandler)},
clearList:function(){this.cleared=!0},runLastQuery:function(){this.cleared&&(this.cleared=!1,this.newSearch(this.lastQueryString))}});arcgisonline.sharing.dijit.GoogleServicesGrid.formatters={title:function(a,g){this.i18n=b.i18n.getLocalization("arcgisonline","arcgisonline").common;b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").googleServicesGrid);if(!g)return this.defaultValue;var d=g.url,c=d.indexOf("/MapServer/");-1<c&&(d=d.substring(0,c+10));c=d.indexOf("/FeatureServer/");
-1<c&&(d=d.substring(0,c+14));var c=g._title,k=g._id,h=g._domain;if(!c||!k){var c=g.titleNoFormatting,f=c.indexOf(" (MapServer)");-1<f&&(c=c.substring(0,f));f=c.indexOf(" (ImageServer)");-1<f&&(c=c.substring(0,f));f=c.indexOf(" (FeatureServer)");-1<f&&(c=c.substring(0,f)+" (Feature Service)");f=c.indexOf("Feature Layer: ");0==f&&(k=c.indexOf(" (ID: "),-1<k&&(c=c.substring(0,k)),c=c.substring(15,c.length)+" (Feature Service)",k=d.indexOf("/services/"),h=d.lastIndexOf("/"),k=d.substring(k+10,h),k=k.replace("/",
" / "),c=k+" / "+c);f=c.indexOf("Layer: ");0==f&&(k=c.indexOf(" (ID: "),-1<k&&(c=c.substring(0,k)),c=c.substring(7,c.length),k=d.indexOf("/services/"),h=d.lastIndexOf("/"),k=d.substring(k+10,h),k=k.replace("/"," / "),c=k+" / "+c);k="gogl_"+g.visibleUrl+"_"+c.substring(c.lastIndexOf("/")+1,c.length)+"_"+a;h=d;f=h.indexOf("http://");-1<f&&(h=h.substring(f+7,h.length));f=h.indexOf("https://");-1<f&&(h=h.substring(f+8,h.length));f=h.indexOf("/");-1<f&&(h=h.substring(0,f));g._id=k;g._title=c;g._domain=
h;g.status="new";l.byId("googleServicesGrid").allItemsByIdentity[k]||(l.byId("googleServicesGrid").allItemsByIdentity[k]=g)}f="\x3cdiv id\x3d'"+k+"_row' class\x3d'listServiceTitle'\x3e\x3ctable cellpadding\x3d'0' cellspacing\x3d'0' width\x3d'100%'\x3e\x3ctr width\x3d'100%'\x3e\x3ctd nowrap\x3d'nowrap'\x3e";f+="  \x3cdiv id\x3d'"+k+'_toolTipLaunch\' style\x3d"position:absolute; left:80px; top:10px; width:1px; height:1px; background: transparent;"\x3e\x3c/div\x3e';f+="\t \x3cdiv style\x3d'overflow:hidden;'\x3e\x3ca id\x3d'"+
k+"_title' href\x3d\"JavaScript:dijit.byId('googleServicesGrid').tooltipInfo('"+d+"','"+c+"','"+k+'\');" style\x3d"height:16px;"\x3e'+c+"\x3c/a\x3e\x3c/div\x3e";f+="\t \x3cdiv id\x3d'"+k+'_dropDownButton\' dojoType\x3d"arcgisonline.sharing.dijit.DropDownButton" style\x3d"display:none;line-height:5px;"\x3e\x3cspan\x3e\x26nbsp;\x3c/span\x3e';f+="\t\t\t\x3cdiv id\x3d'"+k+"_toolTip' dojoType\x3d'dijit.TooltipDialog'\x3e\x3c/div\x3e";f+="\t \x3c/div\x3e";f+="\x3c/td\x3e\x3c/tr\x3e\x3c/table\x3e";f+="\x3ctable cellpadding\x3d'0' cellspacing\x3d'0' width\x3d'100%' class\x3d'bottomRowTable'\x3e\x3ctr width\x3d'100%'\x3e\x3ctd nowrap\x3d'nowrap'\x3e";
f+="  \x3cspan class\x3d'esriAlignLeading' style\x3d'color:#656565;'\x3e"+h+"\x3c/span\x3e";f+="\x3c/td\x3e\x3ctd style\x3d'padding-right:5px;padding-left:3px;'\x3e";f="added"===g.status?f+(" \x3cdiv class\x3d'esriAlignTrailing' id\x3d'"+k+"_link'\x3e\x3ca href\x3d\"JavaScript:dijit.byId('googleServicesGrid').removeLayer('"+d+"','"+k+"','"+g.layerAddedIds+"');\"\x3e"+this.i18n.remove+"\x3c/A\x3e\x3c/div\x3e"):"unavailable"===g.status?f+("  \x3cdiv class\x3d'esriAlignTrailing' id\x3d'"+k+"_link'\x3e\x3cspan style\x3d'color:#999;'\x3e"+
this.i18n.unavailable+"\x3c/span\x3e\x3c/div\x3e"):f+("  \x3cdiv class\x3d'esriAlignTrailing' id\x3d'"+k+"_link'\x3e\x3ca href\x3d\"JavaScript:dijit.byId('googleServicesGrid').addLayer('"+d+"','"+k+"');\"\x3e"+this.i18n.add+"\x3c/A\x3e\x3c/div\x3e");f+="\x3c/td\x3e\x3c/tr\x3e\x3c/table\x3e";return f+="\x3c/div\x3e"},blank:function(a,b){return""}}});