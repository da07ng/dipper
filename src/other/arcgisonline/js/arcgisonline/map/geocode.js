// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/geocode",["dijit","dojo","dojox","dojo/require!arcgisonline/map/main"],function(l,c,q){c.provide("arcgisonline.map.geocode");c.require("arcgisonline.map.main");arcgisonline.map.geocode={geocoder:null,popup:null,startupValue:null,startupActiveSourceIndex:null,lastSearch:"",directionsLinkHandler:null,featureLayers:{},handles:[],defaultIcon:window.location.href.substring(0,window.location.href.indexOf(window.location.pathname)+window.location.pathname.lastIndexOf("/"))+"/images/EsriBluePinCircle26.png",
pointSymbolJson:{type:"esriPMS",url:arcgisonline.map.geocode.defaultIcon,width:26,height:26,yoffset:13,contentType:"image/png"},lineSymbolJson:{color:[44,102,173,255],width:1.5,type:"esriSLS",style:"esriSLSSolid"},polygonSymbolJson:{color:[44,102,173,131],outline:{color:[44,102,173,255],width:1.5,type:"esriSLS",style:"esriSLSSolid"},type:"esriSFS",style:"esriSFSSolid"},createWidget:function(){var a=arcgisonline.map.geocode;if(a.geocoder)this.options=a.createSearchOptions(),a.geocoder.set("sources",
this.options.sources),arcgisonline.map.main.checkMinWidthOfPage();else{this.options=a.createSearchOptions();a.geocoder=new esri.dijit.Search(this.options,c.create("div",{id:"geocoder"},"locationDiv"));esri.isDefined(a.startupActiveSourceIndex)&&a.geocoder.set("activeSourceIndex",a.startupActiveSourceIndex);a.geocoder.on("load",function(){arcgisonline.map.main.checkMinWidthOfPage()});a.geocoder.startup();c.subscribe("onFilterChanged",arcgisonline.map.geocode,"updateSearchLayer");a.geocoder.on("select-result",
c.hitch(a,"showGeocodingResult"));c.aspect.before(a.geocoder,"search",function(b){l.byId("editorDiv")&&l.byId("editorDiv")._clearSelection()});a.handles.push(c.aspect.after(arcgisonline.map.popup,"addPopupLayer",arcgisonline.map.geocode.updateInfoTemplateSources,!0));a.handles.push(c.aspect.after(arcgisonline.map.popup,"removePopup",arcgisonline.map.geocode.updateInfoTemplateSources,!0));var e=function(b){if(arcgisonline.map.geocode.geocoder){var a=arcgisonline.map.geocode.geocoder.get("sources"),
e=[];c.forEach(a,function(a,c){a.featureLayer&&(esri.isDefined(a.featureLayer.id)&&(a.featureLayer.id===b.layer.id||0===a.featureLayer.id.indexOf(b.layer.id+"_")))&&e.push(c)});e.reverse();c.forEach(e,function(b){a.splice(b,1)});arcgisonline.map.geocode.geocoder.set("sources",a)}},b=arcgisonline.map.main.map.on("layer-remove",e);a.handles.push(b);a.handles.push(c.aspect.before(arcgisonline.map.save_open,"onRecreateMapLoad",function(){b.remove()}));a.handles.push(c.aspect.after(arcgisonline.map.save_open,
"onRecreateMapLoad",function(){b=arcgisonline.map.main.map.on("layer-remove",e)}))}},updateInfoTemplateSources:function(a,e){var b=arcgisonline.map.geocode.geocoder;if(b&&!arcgisonline.map.featColl.isFeatureCollection(a)){var b=c.filter(b.get("sources"),function(b){return!!b.featureLayer}),f=!isNaN(e),d,h;c.some(b,function(b){var c=f?b.layerId===a.id&&b.subLayerId===e:b.layerId===a.id;c&&(d=b);return c});if(d){if(f){var g=a.layer.infoTemplates,k;c.forEach(a.itemLayers,function(b){k=b.id;k===parseInt(e)&&
(b.popupInfo&&g&&g[k])&&(h=g[k].infoTemplate)})}else a.popupInfo&&(h=a.layer.infoTemplate);d.infoTemplate=h||arcgisonline.map.geocode.geocoder.options.infoTemplate}}},createSearchOptions:function(a){var e={map:arcgisonline.map.main.map,enableSuggestions:esri.isDefined(esriGeowConfig.geocodeAutoComplete)?esriGeowConfig.geocodeAutoComplete:!1,minCharacters:0,maxResults:5,suggestionDelay:100,value:arcgisonline.map.geocode.startupValue?arcgisonline.map.geocode.startupValue:null,autoNavigate:!1,activeSourceIndex:"all"},
b=[];"extent"!==a&&(b=arcgisonline.map.geocode.setupSearchLayers());var c=[],c=arcgisonline.map.geocode.setupSearchGeocoders(a);e.sources=b.concat(c);1===e.sources.length&&delete e.activeSourceIndex;return e},setupSearchLayers:function(){var a=[],e=arcgisonline.map.save_open.openedWebMap;e&&(e.applicationProperties&&e.applicationProperties.viewing&&e.applicationProperties.viewing.search&&e.applicationProperties.viewing.search.enabled)&&(arcgisonline.map.main.isMapFullyLoaded?c.forEach(e.applicationProperties.viewing.search.layers,
function(b){var f,d=arcgisonline.map.main.getParameterListById(b.id);if(d&&d.layer){var h=d.title,g=d.url,k=d.layer,n=["*"];if(esri.isDefined(b.subLayer)){if(d.itemLayers){var p=!1;c.forEach(d.itemLayers,function(a,e){a.id===parseInt(b.subLayer)&&(a.popupInfo&&(d.layer.infoTemplates&&d.layer.infoTemplates[a.id])&&(f=d.layer.infoTemplates[a.id].infoTemplate),p=!0,a.layerUrl?g=a.layerUrl:arcgisonline.map.main.hasDynamicLayers(d)?(g=d.url+"/"+d.layer.dynamicLayerInfos[e].source.mapLayerId,a.popupInfo&&
(n=[],c.forEach(a.popupInfo.fieldInfos,function(b){n.push(b.fieldName)}))):g+="/"+b.subLayer)});p||(g+="/"+b.subLayer)}else g+="/"+b.subLayer;c.forEach(d.layer.layerInfos,function(a){a.id===parseInt(b.subLayer)&&(h+=" - "+a.name)});k=new esri.layers.FeatureLayer(g,{id:d.id+"_"+b.subLayer,definitionExpression:(d.layer.layerDefinitions||[])[b.subLayer]})}else d.popupInfo&&(f=d.layer.infoTemplate);var m=!1;k.fields?c.forEach(k.fields,function(a){a.name===b.field.name&&(m=!0)}):m=!0;m&&(k={featureLayer:k,
exactMatch:b.field.exactMatch||!1,name:h,displayField:b.field.name,outFields:n,placeholder:e.applicationProperties.viewing.search.hintText,layerId:b.id},esri.isDefined(b.subLayer)&&(k.subLayerId=parseInt(b.subLayer)),f&&(k.infoTemplate=f),a.push(k))}}):c.subscribe("onMapFullyLoaded",c.hitch(arcgisonline.map.geocode,"recreateGeocoder")));return a},setupSearchGeocoders:function(a){a=c.clone(esriGeowConfig.self.helperServices.geocode);var e=!1;esri.isDefined(esriGeowConfig.geocodeAutoComplete)&&(e=esriGeowConfig.geocodeAutoComplete);
c.forEach(a,c.hitch(this,function(b){b.enableSuggestions=!0===b.suggest&&e?!0:!1;delete b.suggest;var a=arcgisonline.sharing.util.isEsriWorldGeocoder(b.url);if(a||b.enableSuggestions)a&&(b.name=b.name||esri.i18nBundle.common.esriWorldGeocoder,b.enableSuggestions=e,b.placefinding=b.batch=b.esri=!0,b.outFields=["Match_addr","Addr_type","StAddr","City"]),b.placeholder=b.placeholder||esri.i18nBundle.viewer.findLocationText,b.singleLineFieldName=b.singleLineFieldName||"SingleLine",b.highlightSymbol=null,
b.localSearchOptions={minScale:3E5,distance:5E4};b.locator=new esri.tasks.Locator(b.url)}));return a=c.filter(a,function(a){return esri.isDefined(a.singleLineFieldName)&&esri.isDefined(a.placefinding)&&a.placefinding})},destroyGeocoder:function(){var a=arcgisonline.map.geocode,c;if(a.geocoder){a.geocoder.destroy();a.geocoder=null;c=a.handles.length;for(var b=0;b<c;b++)a.handles.pop().remove()}},recreateGeocoder:function(){arcgisonline.map.geocode.createWidget()},updateSearchLayer:function(a,e,b){c.forEach(arcgisonline.map.geocode.geocoder.sources,
function(c){if(c.featureLayer&&c.featureLayer.id!==a.layer.id&&0===c.featureLayer.id.indexOf(a.layer.id)){var d=c.featureLayer.id.substring(c.featureLayer.id.lastIndexOf("_")+1);d&&(d=parseInt(d));e===d&&c.featureLayer.setDefinitionExpression(b)}})},doSearch:function(a){var c=arcgisonline.map.geocode;c.geocoder.set("value",a);c.geocoder.search()},setValue:function(a){var c=arcgisonline.map.geocode;c.geocoder?c.geocoder.set("value",a):c.startupValue=a},getValue:function(){var a=arcgisonline.map.geocode.geocoder;
return a?a.get("value"):""},showGeocodingResult:function(a){if(a&&a.result){var e=a.result,b=e.feature.geometry,f=e.extent,d;if(!b||b&&"point"==b.type&&(isNaN(b.x)||isNaN(b.y)))arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:c.string.substitute(esri.i18nBundle.viewer.geocode.notFound,{location:e.name||e.value})});else if("polygon"===b.type?(d=b.getExtent().expand(1.1),b=b.getCentroid()):"polyline"===b.type?(d=
b.getExtent().expand(1.1),b=b.getPoint(0,0)):"multipoint"===b.type?(d=b.getExtent().expand(1.1),b=b.getPoint(0)):d=arcgisonline.map.main.map.extent.centerAt(b).expand(0.0625),a=a.source,f=f&&!isNaN(f.xmin)&&!isNaN(f.ymin)&&!isNaN(f.xmax)&&!isNaN(f.ymax)&&!(0===f.xmin&&0===f.ymin&&0===f.xmax&&0===f.ymax)?f:d,a.featureLayer)if(d=arcgisonline.map.main.getParameterListById(a.layerId),isNaN(a.subLayerId)&&d.layer&&d.layer.isEditable()&&"editStack"===arcgisonline.map.leftPanel.getLeftContentPanelStack()){arcgisonline.map.main.map.setExtent(f);
e.feature.infoTemplate=d.layer.infoTemplate;e.feature._layer=d.layer;l.byId("editPanel").updateEditor({feature:e.feature,mapPoint:b});var h=arcgisonline.map.main.map.infoWindow.on("hide, show",function(){arcgisonline.map.geocode.geocoder.clearGraphics();h.remove()})}else{if(arcgisonline.map.main.map.setExtent(f),arcgisonline.map.main.map.infoWindow.resize(270,250),arcgisonline.map.geocode.setupInfoWindow(e,a),"editStack"===arcgisonline.map.leftPanel.getLeftContentPanelStack())var g=c.connect(arcgisonline.map.main.map.infoWindow,
"onHide",function(){c.disconnect(g);l.byId("editPanel").recreateAttributeInspector()})}else arcgisonline.map.main.map.setExtent(f),arcgisonline.map.main.map.infoWindow.resize(270,250),arcgisonline.map.geocode.setupInfoWindow(e,a),"editStack"===arcgisonline.map.leftPanel.getLeftContentPanelStack()&&(g=c.connect(arcgisonline.map.main.map.infoWindow,"onHide",function(){c.disconnect(g);l.byId("editPanel").recreateAttributeInspector()}))}},setupInfoWindow:function(a,e){var b=arcgisonline.map.main.map.infoWindow,
f=b.on("hide, show",function(){c.query(".zoomTo",b.domNode).style("display","");arcgisonline.map.geocode.geocoder.clearGraphics();f.remove()});c.query(".zoomTo",b.domNode).style("display","none");arcgisonline.map.role.canShowDirections()&&arcgisonline.map.geocode.addDirectionsLink(a);arcgisonline.map.geocode.addAddToLayerLink(a);arcgisonline.map.main.hideNoDataDisplay()},addDirectionsLink:function(a){arcgisonline.map.geocode.removeDirectionsLink();var e=c.byId("popupDirectionsLink");e||(e=c.create("a",
{id:"popupDirectionsLink","class":"action directions",innerHTML:esri.i18nBundle.viewer.popup.directions,href:"javascript:void(0);"},c.query(".actionList",arcgisonline.map.main.map.infoWindow.domNode)[0]),c.removeClass(arcgisonline.map.main.map.infoWindow._actionList,"hidden"),arcgisonline.map.geocode.directionsLinkHandler=c.connect(e,"onclick",c.hitch(this,function(a,c){c.preventDefault();arcgisonline.map.leftPanel.openLeftDirectionsPanel(null,{geocodeResult:a})},a)))},removeDirectionsLink:function(){arcgisonline.map.geocode.directionsLinkHandler&&
(c.disconnect(arcgisonline.map.geocode.directionsLinkHandler),arcgisonline.map.geocode.directionsLinkHandler=null);var a=c.byId("popupDirectionsLink");a&&c.destroy(a)},addAddToLayerLink:function(a){arcgisonline.map.geocode.removeAddToLayerLink();var e=function(a,b){esri.isDefined(b)&&0==b.length?arcgisonline.map.geocode.lastAddToMapNotesLayerId?arcgisonline.map.main.getParameterListById(arcgisonline.map.geocode.lastAddToMapNotesLayerId)?arcgisonline.map.geocode.addToMapNotesLayer(a,arcgisonline.map.geocode.lastAddToMapNotesLayerId):
arcgisonline.map.geocode.createNewMapNotesLayer(a):arcgisonline.map.geocode.createNewMapNotesLayer(a):b?(arcgisonline.map.geocode.lastAddToMapNotesLayerId=b,arcgisonline.map.geocode.addToMapNotesLayer(a,b)):arcgisonline.map.geocode.createNewMapNotesLayer(a);"contentStack"!==arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftTOCPanel();arcgisonline.map.main.map.infoWindow.hide()},b=c.query(".actionList",arcgisonline.map.main.map.infoWindow.domNode)[0],f=c.query(".zoomTo",
b);f&&f.length&&c.style(f[0],"whiteSpace","nowrap");c.create("span",{innerHTML:" "},b);f=c.create("span",{id:"addToLayerLink","class":"action addToLayer",style:"white-space: nowrap"},b);9>c.isIE&&c.create("br",null,f);for(var b=c.create("a",{innerHTML:esri.i18nBundle.viewer.geocode.addToMapNotes,alt:esri.i18nBundle.viewer.geocode.addToMapNotes,title:esri.i18nBundle.viewer.geocode.addToMapNotes,"class":"esriItemLinks",href:"JavaScript:void(0);",onclick:c.hitch(this,e,a,"")},f),f=c.create("div",{innerHTML:"",
"class":"dijitReset dijitInline esriArrows",title:esri.i18nBundle.siteHeader.moreOptions,alt:esri.i18nBundle.siteHeader.moreOptions,style:{marginLeft:"5px",cursor:"pointer"}},f),d=[{label:esri.i18nBundle.viewer.geocode.newMapNotesLayer,onClick:c.hitch(this,e,a,null)}],h=arcgisonline.map.main.mapLayers.length-1;0<=h;h--){var g=arcgisonline.map.main.mapLayers[h];arcgisonline.map.featColl.isFeatureCollection(g)&&arcgisonline.map.mapNotes.isMapNotesMapLayer(g)&&d.push({label:g.title,onClick:c.hitch(this,
e,a,g.id)})}new arcgisonline.sharing.dijit.TextMenu({triggerNode:f,labelNode:b,textMenuItems:d})},removeAddToLayerLink:function(){var a=c.byId("addToLayerLink");a&&c.destroy(a)},createNewMapNotesLayer:function(a){arcgisonline.map.geocode.pointSymbolJson.url=arcgisonline.map.geocode.defaultIcon;var e=esri.geometry.fromJson(a.feature.geometry.toJson());a={TITLE:a.name,DESCRIPTION:"",IMAGE_URL:null,IMAGE_LINK_URL:null};arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"community/groups?q\x3d"+
esriGeowConfig.layerTemplatesGroupQuery).then(c.hitch(this,function(a,e,d){arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"search?num\x3d50\x26q\x3dgroup:"+d.results[0].id+' AND type:"Feature Collection Template"').then(c.hitch(this,function(a,b,e){if(e.results&&0!==e.results.length){e.results.sort(function(a,b){return a.name==b.name?0:a.name<b.name?-1:1});var d=esri.i18nBundle.mapNotesDlg.mapNotes,f="||";c.forEach(arcgisonline.map.main.mapLayers,function(a){f+=a.title+"||"});f=f.toLowerCase();
if(-1<f.indexOf("||"+d.toLowerCase()+"||")){for(var m=1;-1<f.indexOf("||"+d.toLowerCase()+" "+m+"||");)m++;d+=" "+m}arcgisonline.map.mapNotes.getMapNotesConfig(e.results[0].id,d,!0);var l=c.connect(arcgisonline.map.main.map,"onLayersAddResult",c.hitch(this,function(a,b,e,d){for(var f=d.length-1;0<=f;f--){var g=d[f].layer,h=arcgisonline.map.main.getParameterList(g);if(h.title===e)if(c.disconnect(l),arcgisonline.map.geocode.lastAddToMapNotesLayerId=h.id,("point"===a.type||"multipoint"===a.type)&&("esriGeometryPoint"==
g.geometryType||"esriGeometryMultipoint"==g.geometryType)){g.applyEdits([new esri.Graphic(a,esri.symbol.fromJson(arcgisonline.map.geocode.pointSymbolJson),b)]);1===g.graphics.length&&arcgisonline.map.dijit.toc.options.updateToolOptions(h);break}else if("polyline"===a.type&&"esriGeometryPolyline"==g.geometryType){g.applyEdits([new esri.Graphic(a,esri.symbol.fromJson(arcgisonline.map.geocode.lineSymbolJson),b)]);1===g.graphics.length&&arcgisonline.map.dijit.toc.options.updateToolOptions(h);break}else if(("polygon"===
a.type||"extent"===a.type)&&"esriGeometryPolygon"==g.geometryType){g.applyEdits([new esri.Graphic(a,esri.symbol.fromJson(arcgisonline.map.geocode.polygonSymbolJson),b)]);1===g.graphics.length&&arcgisonline.map.dijit.toc.options.updateToolOptions(h);break}}},a,b,d))}},a,e))},e,a))},addToMapNotesLayer:function(a,c){arcgisonline.map.geocode.pointSymbolJson.url=arcgisonline.map.geocode.defaultIcon;for(var b=esri.geometry.fromJson(a.feature.geometry.toJson()),f={TITLE:a.name,DESCRIPTION:"",IMAGE_URL:null,
IMAGE_LINK_URL:null},d=arcgisonline.map.main.getParameterListById(c),h=d.layers.length-1;0<=h;h--){var g=d.layers[h];if(("point"===b.type||"multipoint"===b.type)&&("esriGeometryPoint"==g.geometryType||"esriGeometryMultipoint"==g.geometryType)){g.applyEdits([new esri.Graphic(b,esri.symbol.fromJson(arcgisonline.map.geocode.pointSymbolJson),f)]);break}else if("polyline"===b.type&&"esriGeometryPolyline"==g.geometryType){g.applyEdits([new esri.Graphic(b,esri.symbol.fromJson(arcgisonline.map.geocode.lineSymbolJson),
f)]);break}else if(("polygon"===b.type||"extent"===b.type)&&"esriGeometryPolygon"==g.geometryType){g.applyEdits([new esri.Graphic(b,esri.symbol.fromJson(arcgisonline.map.geocode.polygonSymbolJson),f)]);break}}},closeInfoWindow:function(){arcgisonline.map.main.map.infoWindow.hide()},isSearchField:function(a,c,b){for(var f=0;f<arcgisonline.map.geocode.geocoder.sources.length;f++){var d=arcgisonline.map.geocode.geocoder.sources[f];if(d.layerId&&a.id===d.layerId&&d.displayField===b&&(!esri.isDefined(c)||
c===d.subLayerId))return!0}return!1},getActiveSource:function(){var a=arcgisonline.map.geocode.geocoder;return a?a.activeSourceIndex:null},setActiveSource:function(a){var c=arcgisonline.map.geocode;c.geocoder?c.geocoder.set("activeSourceIndex",a):c.startupActiveSourceIndex=a}}});