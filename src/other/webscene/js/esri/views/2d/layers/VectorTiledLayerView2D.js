// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("require ../../../core/declare dojo/_base/lang ../../../geometry/SpatialReference ../../../geometry/support/webMercatorUtils ../../../core/Scheduler ./LayerView2D".split(" "),function(m,n,h,p,k,q,r){return n(r,{declaredClass:"esri.views.2d.layers.VectorTiledLayerView2D",constructor:function(a){this.update=this.update.bind(this);this._viewHdl=this.watch("view.viewpoint",this.update);this._updateTask=q.addFrameTask({update:this.update});this.container.watch("surface",function(a){m(["./vector-tile"],
function(f){var b=this.layer,c=b.serviceStyle;if(c){var d=c.sources,g;d.esri&&b.currentVersion&&(g=this._makeSource(b),d.esri=h.mixin(d.esri,g),d.esri.type="vector",delete d.esri.url);c.sources=d;d=this.view.state;this.gl=new f.Renderer({container:a,style:c,center:[d.longitude,d.latitude],zoom:this.getZoom(d.resolution),bearing:-d.rotation});this.gl.getCanvas().style["transform-origin"]="center";this.gl.getCanvas().style.transform="rotate(-"+d.rotation+"deg)";this.gl.setSize(d.width,d.height);this._applyStyles(b.styles||
[])}}.bind(this))}.bind(this))},getDefaults:function(){return h.mixin(this.inherited(arguments),{styles:[]})},initialize:function(a){this.layer.watch("styles",function(a){a=a||[];this._applyStyles(a)}.bind(this));this.layer.watch("serviceStyle",function(a){var f,b=a.sources;b.esri&&this.layer.currentVersion&&(f=this._makeSource(this.layer),b.esri=h.mixin(b.esri,f),delete b.esri.url);this.gl&&this.gl.setStyle(a)}.bind(this))},destroy:function(){this._updateTask.remove();this._updateTask=null;this.gl.destroy();
this.gl=null;this._viewHdl.remove();this._viewHdl=null},update:function(){if(this.gl){var a=this.view.state;this._version!==a.version&&(this._version=a.version,this.gl.setSize(a.width,a.height),this.gl.jumpTo({center:[a.longitude,a.latitude],zoom:this.getZoom(a.resolution),bearing:-a.rotation}),this.gl.getCanvas().style.transform="rotate(-"+a.rotation+"deg)")}},getZoom:function(a){var e=this.layer.tileInfo.lods,f=null,b=null,c=0,d=e.length-1;for(c;c<d;c++){f=e[c];b=e[c+1];if(f.resolution<=a)return c;
if(b.resolution===a)return c+1;if(f.resolution>a&&b.resolution<a){c=c+1-(a-b.resolution)/(f.resolution-b.resolution);c=Math.ceil(c)-Math.log(Math.abs(Math.ceil(c)-c+1))/Math.LN2;if(0.995<c-Math.floor(c)||0.0050>c-Math.floor(c))c=Math.round(c);return c}}},_makeSource:function(a){var e={scheme:"xyz",tilejson:"2.0.0"},f=p.WGS84,b,c=Infinity,d=-Infinity,g;e.description=a.description;e.name=a.name;"indexedVector"===a.type&&(e.index=a.url+a.tileMap+"/");e.format=a.tileInfo.format||"pbf";var h=[],l=a.token;
b=0;for(g=a.tiles.length;b<g;b++)h.push(a.url+a.tiles[b]+(l?"?token\x3d"+l:""));e.tiles=h;k.canProject(a.fullExtent,f)&&(b=k.project(a.fullExtent,f),e.bounds=[b.xmin,b.ymin,b.xmax,b.ymax]);if(a.tileInfo&&a.tileInfo.lods){b=0;for(g=a.tileInfo.lods.length;b<g;b++)f=a.tileInfo.lods[b],c=Math.min(f.level,c),d=Math.max(f.level,d);e.minZoom=c;e.maxZoom=d}if(Infinity===c||-Infinity===d)e.minZoom=0,e.maxZoom=20;return e},_applyStyles:function(a){var e=this.styles,f=this.gl,b,c,d,g=[];b=0;for(c=e.length;b<
c;b++)d=e[b],-1===a.indexOf(d)?f.removeClass(d):g.push(d);b=0;for(c=a.length;b<c;b++)d=a[b],-1===g.indexOf(d)&&(f.addClass(d),g.push(d));this.styles=g}})});