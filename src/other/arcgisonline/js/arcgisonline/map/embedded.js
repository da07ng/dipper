// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/embedded",["dijit","dojo","dojox","dojo/require!arcgisonline/map/main"],function(d,c,f){c.provide("arcgisonline.map.embedded");c.require("arcgisonline.map.main");arcgisonline.map.embedded={doEmbeddedCheck:function(b){var a=new c.Deferred;if(b)a.callback(!0);else if(b=arcgisonline.sharing.util.urlToObject(document.URL),b.query=b.query||{},"1"===b.query.embedded){window.addEventListener("message",arcgisonline.map.embedded.receiveMessage,!1);arcgisonline.map.embedded.setupEmbedded();
var e=location.hash;e.length&&(e=e.substring(1));e.length?(arcgisonline.sharing.geow.Account.getSelf(function(a){if(a.user){var b={email:a.user.username,privacy:null,token:e,culture:a.user.culture&&a.user.culture.toLowerCase()||"",region:a.user.region,expires:null,persistent:void 0,allSSL:a.allSSL};arcgisonline.sharing.geow.Geow.setAuthCookie(b);a.urlKey&&(!esriGeowConfig.isDebug&&-1===window.location.hostname.toLowerCase().indexOf(a.urlKey.toLowerCase()))&&(a={type:"newViewerBaseUrl",baseUrl:document.location.protocol+
"//"+a.urlKey+"."+a.customBaseUrl},arcgisonline.map.embedded.sendPostMessage(a))}else a={type:"message",message:"User could not be determined."},arcgisonline.map.embedded.sendPostMessage(a);arcgisonline.map.main.init(!0)},function(a){arcgisonline.map.embedded.sendPostMessage({type:"message",message:"Could not get self."});arcgisonline.map.main.init(!0)},e),a.callback(!1)):a.callback(!0)}else a.callback(!0);return a},setupEmbedded:function(){var b=arcgisonline.sharing.util.urlToObject(document.URL);
b.query=b.query||{};if("1"===b.query.embedded){isEmbedded={};if(b.query.hide){var a=b.query.hide;-1<a.indexOf("bm")&&(isEmbedded.hideBookmarks=!0);-1<a.indexOf("share")&&(isEmbedded.hideShare=!0);-1<a.indexOf("save")&&(isEmbedded.hideSave=!0);-1<a.indexOf("lnk")&&(isEmbedded.hideExternalLinks=!0);-1<a.indexOf("analysis")&&(isEmbedded.hideAnalysis=!0);-1<a.indexOf("directions")&&(isEmbedded.hideDirections=!0);-1<a.indexOf("measure")&&(isEmbedded.hideMeasure=!0)}c.style(c.byId("webmap-header"),"display",
"none");c.style(c.byId("header"),"display","none")}c.subscribe("onMapFullyLoaded",function(){"1"===b.query.embedded&&(b.query.title&&b.query.tags)&&arcgisonline.map.storage.saveNewWebMap(b.query.title,b.query.tags,b.query.folderId).then(function(a){a={type:"mapSaved",webmapId:arcgisonline.map.main.getWebmapId(),title:arcgisonline.map.main.getWebmapTitle()};embeddedSource&&embeddedSource.postMessage(JSON.stringify(a),embeddedOrigin)},function(a){a={type:"mapSaveError",message:a&&a.message,code:a&&
a.code,httpCode:a&&a.httpCode,messageCode:a&&a.messageCode};embeddedSource&&embeddedSource.postMessage(JSON.stringify(a),embeddedOrigin)})})},adjustUIForEmbedded:function(){isEmbedded&&(c.style(d.byId("webmap-print").domNode,"display","none"),c.style(d.byId("webmap-print-templates").domNode,"display","none"),isEmbedded.hideBookmarks&&c.style(d.byId("webmap-bookmarks").domNode,"display","none"),isEmbedded.hideShare&&c.style(d.byId("webmap-share").domNode,"display","none"),isEmbedded.hideSave&&c.style(d.byId("webmap-save").domNode,
"display","none"),isEmbedded.hideAnalysis&&(c.style(c.byId("webmap-spacer2"),"display","none"),c.style(d.byId("webmap-analysis").domNode,"display","none")),isEmbedded.hideDirections&&c.style(d.byId("webmap-directions").domNode,"display","none"),isEmbedded.hideMeasure&&c.style(d.byId("webmap-measure").domNode,"display","none"),(isEmbedded.hideBookmarks&&isEmbedded.hideMeasure&&isEmbedded.hideDirections||isEmbedded.hideSave&&isEmbedded.hideShare)&&c.style(c.byId("webmap-spacer3"),"display","none"))},
sendPostMessage:function(b){embeddedSource&&embeddedSource.postMessage(JSON.stringify(b),embeddedOrigin)},receiveMessage:function(b){if(b.origin){var a=b.origin.split("."),c=document.location.hostname.split(".");if(c[1]+"."+c[2]!==a[1]+"."+a[2]&&(!esriGeowConfig.embeddedViewerWhitelist||-1===esriGeowConfig.embeddedViewerWhitelist.indexOf(a[1]+"."+a[2])))a={type:"message",message:"Caller not on viewer's domain or in viewer's whitelist "+b.origin},b.source.postMessage(JSON.stringify(a),b.origin);else switch(embeddedSource=
b.source,embeddedOrigin=b.origin,a=JSON.parse(b.data),a.type){case "saveMap":arcgisonline.map.embedded.saveEmbeddedMap().then(function(a){a={type:"mapSaved",webmapId:a,title:arcgisonline.map.main.getWebmapTitle()};arcgisonline.map.embedded.sendPostMessage(a)},function(a){arcgisonline.map.embedded.sendPostMessage({type:"mapSaveError",message:a&&a.message})});break;case "saveNewMap":arcgisonline.map.embedded.saveNewEmbeddedMap(a.title,a.tags,a.folderId).then(function(a){a={type:"mapSaved",webmapId:a,
title:arcgisonline.map.main.getWebmapTitle()};arcgisonline.map.embedded.sendPostMessage(a)},function(a){arcgisonline.map.embedded.sendPostMessage({type:"mapSaveError",message:a&&a.message,code:a&&a.code,httpCode:a&&a.httpCode,messageCode:a&&a.messageCode})});break;case "getWebmapId":a={type:"webmapId",webmapId:arcgisonline.map.main.getWebmapId()};arcgisonline.map.embedded.sendPostMessage(a);break;case "isLoaded":a={type:"loaded",value:arcgisonline.map.main.isMapFullyLoaded};arcgisonline.map.embedded.sendPostMessage(a);
break;case "hasUnsavedChanges":a={type:"unsavedChanges",value:arcgisonline.map.main.mapHasChanged};arcgisonline.map.embedded.sendPostMessage(a);break;case "isWebmapEditable":b=arcgisonline.sharing.util.getUser();a=arcgisonline.map.save_open.webMapInfo;c=!1;if(b&&(!a||a&&(a.owner===b.email||"admin"===a.itemControl||"update"===a.itemControl)))c=!0;a={type:"webmapEditable",value:c};arcgisonline.map.embedded.sendPostMessage(a);break;case "updateToken":a=a.token,a.length&&(b=arcgisonline.sharing.util.getCookie("esri_auth"),
b.token=a,arcgisonline.sharing.geow.Geow.setAuthCookie(b))}}},saveEmbeddedMap:function(){var b=new c.Deferred;if(arcgisonline.map.role.isAllowed("tool_save"))arcgisonline.map.storage.saveWebMapClick("save",function(a){b.callback(a)},function(a){b.errback(a)});else{var a=Error("User has no permissions to save a map.");a.messageCode="VIEWER_0004";b.errback(a)}return b},saveNewEmbeddedMap:function(b,a,c){return arcgisonline.map.storage.saveNewWebMap(b,a,c)}}});