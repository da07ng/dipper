// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("dojo/_base/kernel dojo/_base/lang dojo/_base/array dojo/_base/Color dojo/has dojo/number dojo/on dojo/dom dojo/dom-construct dojo/dom-style dijit/_Widget dojox/gfx dojox/gfx/matrix dojox/html/entities ../request ../core/declare ../core/lang ../core/promiseList ../core/screenUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/ClassBreaksRenderer ../renderers/ScaleDependentRenderer ../renderers/DotDensityRenderer ../renderers/TemporalRenderer ../renderers/VectorFieldRenderer ../renderers/HeatmapRenderer ../symbols/PictureFillSymbol ../symbols/support/jsonUtils ../symbols/support/gfxUtils ./Widget dojo/i18n!../nls/jsapi dojo/i18n!dojo/cldr/nls/number".split(" "),
function(C,v,n,D,w,K,y,u,g,t,N,L,O,P,M,Q,E,R,S,A,G,F,T,U,V,H,W,X,I,Y,Z,J,$){var z=Q([Z,N],{declaredClass:"esri.widgets.Legend",widgetsInTemplate:!1,layers:null,alignRight:!1,hoverLabelShowing:!1,dotDensitySwatchSize:26,dotCoverage:75,gradientHeight:30,gradientWidth:34,colorRampBorder:"1px solid",reZeros:RegExp("\\"+$.decimal+"0+$","g"),reZerosFractional:/(\d)0*$/g,_specialChars:{lt:"\x3c",gt:"\x3e"},_ieTimer:100,_isRightToLeft:!1,_align:null,_legendAlign:null,_viewWatch:null,constructor:function(a,
b){v.mixin(this,J.widgets.legend);this._updateAllMapLayers=v.hitch(this,this._updateAllMapLayers);this._refreshLayers=v.hitch(this,this._refreshLayers);a=a||{};a.map=a.view.map;a.map?b?(this.basePath=require.toUrl("esri/widgets/"),this.map=a.map,this.layerInfos=a.layerInfos,this._respectCurrentMapScale=!1===a.respectCurrentMapScale?!1:!0,this.arrangement=a.arrangement===z.ALIGN_RIGHT?z.ALIGN_RIGHT:z.ALIGN_LEFT,this.arrangement===z.ALIGN_RIGHT&&(this.alignRight=!0),this.autoUpdate=!1===a.autoUpdate?
!1:!0,this._surfaceItems=[],this._handles=[]):console.error("esri.widgets.Legend: must specify a container for the legend"):console.error("esri.widgets.Legend: unable to find the 'map' property in parameters")},postMixInProperties:function(){this.inherited(arguments);var a=["ar","he"],b,c;for(b=0;b<a.length;b+=1)c=a[b],C.locale&&-1!==C.locale.indexOf(c)&&(-1!==C.locale.indexOf("-")?-1!==C.locale.indexOf(c+"-")&&(this._isRightToLeft=!0):this._isRightToLeft=!0);this._isRightToLeft?(this._align=this.alignRight?
"left":"right",this._legendAlign=this.alignRight?"esri-legend-left":"esri-legend-right"):(this._align=this.alignRight?"right":"left",this._legendAlign=this.alignRight?"esri-legend-right":"esri-legend-left")},startup:function(){this.inherited(arguments);this.layers=null;this.view?(this._initialize(),9>w("ie")&&(this._repaintItems=v.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))):this._viewWatch||(this._viewWatch=this.map.watch("view",function(){this._viewWatch.remove();
this._initialize();9>w("ie")&&(this._repaintItems=v.hitch(this,this._repaintItems),setTimeout(this._repaintItems,this._ieTimer))}.bind(this)))},destroy:function(){this._deactivate();this._removeHoverHandlers();this.inherited(arguments)},refresh:function(a){if(this.domNode){a?(this.layerInfos=a,this.layers=[],n.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&a.layer.showLegend&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,
a.hideLayers?(a.layer._hideLayersInLegend=a.hideLayers,this._addSubLayersToHide(a)):a.layer._hideLayersInLegend=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this)):this.useAllMapLayers&&(this.layers=this.layerInfos=null);for(a=this.domNode.children.length-1;0<=a;a--)g.destroy(this.domNode.children[a]);this._removeHoverHandlers();this.startup()}},_legendUrl:"http://utility.arcgis.com/sharing/tools/legend",_initialize:function(){this.layerInfos&&
(this.layers=[],n.forEach(this.layerInfos,function(a){this._isSupportedLayerType(a.layer)&&a.layer.showLegend&&(a.title&&(a.layer._titleForLegend=a.title),a.layer._hideDefaultSymbol=!1===a.defaultSymbol?!0:!1,a.hideLayers?(a.layer._hideLayersInLegend=a.hideLayers,this._addSubLayersToHide(a)):a.layer._hideLayersInLegend=[],a.hoverLabel&&(a.layer._hoverLabel=a.hoverLabel),a.hoverLabels&&(a.layer._hoverLabels=a.hoverLabels),this.layers.push(a.layer))},this));this.useAllMapLayers=!1;if(!this.layers){this.useAllMapLayers=
!0;this.layers=[];for(var a=0;a<this.map.layers.get("length");a++){var b=this.map.layers.getItemAt(a);if(b.showLegend)if(b.layers)for(var c=0;c<b.layers.get("length");c++){var d=b.layers.getItemAt(c);d.showLegend&&this._initializeLayer(d)}else this._initializeLayer(b)}}this._createLegend()},_initializeLayer:function(a){this._isSupportedLayerType(a)&&(a.title&&(a._titleForLegend=a.title),this.layers.push(a))},_activate:function(){if(this.autoUpdate){this._respectCurrentMapScale&&(this._ozeConnect=
this.map.on("zoom-end",this._refreshLayers.bind(this)));if(this.useAllMapLayers){this._handles.push(this.view.layerViewsFlat.on("change",this._updateAllMapLayers));this._handles.push(this.map.on("layer-add",this._updateAllMapLayers));this._handles.push(this.map.on("layer-remove",this._updateAllMapLayers));this._handles.push(this.map.on("layer-reorder",this._updateAllMapLayers));for(var a=0;a<this.map.layers.get("length");a++){var b=this.map.layers.getItemAt(a);if(b.layers){this._handles.push(y(b,
"layer-add",this._updateAllMapLayers));this._handles.push(y(b,"layer-remove",this._updateAllMapLayers));this._handles.push(y(b,"layer-reorder",this._updateAllMapLayers));for(var c=0;c<b.layers.get("length");c++){var d=b.layers.getItemAt(c);d.watch("scaleRange",this._refreshLayers);this._handles.push(d.watch("renderer",this._refreshLayers));this._handles.push(d.watch("title",this._refreshLayers));this._handles.push(d.watch("showLegend",this._refreshLayers));this._handles.push(d.watch("opacity",this._refreshLayers))}}this._handles.push(b.watch("renderer",
this._refreshLayers));this._handles.push(b.watch("title",this._refreshLayers));this._handles.push(b.watch("showLegend",this._refreshLayers));this._handles.push(b.watch("scaleRange",this._refreshLayers));this._handles.push(b.watch("opacity",this._refreshLayers))}}n.forEach(this.layers,function(a){},this)}},_deactivate:function(){this._handles.forEach(function(a){a.remove()});this._handles.length=0;this._ozeConnect&&this._ozeConnect.remove();n.forEach(this.layers,function(a){a.ovcConnect&&a.ovcConnect.remove();
a.oscConnect&&a.oscConnect.remove();a.odcConnect&&a.odcConnect.remove();a.oirConnect&&a.oirConnect.remove()},this)},_updateDynamicLayers:function(a){delete a.legendResponse;this._refreshLayers()},_updateImageServiceLayers:function(a,b){delete b.legendResponse;a._refreshLayers()},_refreshLayers:function(){this.refresh()},_isLayerVisible:function(a){return!this.view.getLayerView(a).get("suspended")},_updateAllMapLayers:function(){this.layers=[];for(var a=0;a<this.map.layers.get("length");a++){var b=
this.map.layers.getItemAt(a);if(b.layers)for(var c=0;c<b.layers.get("length");c++){var d=b.layers.getItemAt(c);this._initializeLayer(d)}else this._initializeLayer(b)}this.refresh()},_createLegend:function(){this._deactivate();var a=!1;t.set(this.domNode,"position","relative");g.create("div",{id:this.id+"_msg",className:"esri-legend-msg",innerHTML:0===this.layers.length?"":this.NLS_creatingLegend+"..."},this.domNode);var b=[];n.forEach(this.layers,function(c){if("esri.layers.KMLLayer"==c.declaredClass||
"esri.layers.GeoRSSLayer"==c.declaredClass){var d;this.view.getLayerView(c)&&(this._addLayerViewSuspendWatch(c),"esri.layers.KMLLayer"==c.declaredClass?d=c.getLayers():"esri.layers.GeoRSSLayer"==c.declaredClass&&(d=c.getFeatureLayers(),c._hideLayersInLegend&&(d=n.filter(d,function(a){return-1==n.indexOf(c._hideLayersInLegend,a.id)}))),n.forEach(d,function(a){"esri.layers.FeatureLayer"==a.declaredClass&&c._titleForLegend&&(a._titleForLegend=c._titleForLegend+" - ","esriGeometryPoint"==a.geometryType?
a._titleForLegend+=this.NLS_points:"esriGeometryPolyline"==a.geometryType?a._titleForLegend+=this.NLS_lines:"esriGeometryPolygon"==a.geometryType&&(a._titleForLegend+=this.NLS_polygons),b.push(a))},this))}else if("esri.layers.WMSLayer"===c.declaredClass){if(this.view.getLayerView(c)&&(this._addLayerViewSuspendWatch(c),this._isLayerVisible(c)&&0<c.layerInfos.length&&n.some(c.layerInfos,function(a){return a.legendURL}))){var k=!1;n.forEach(c.layerInfos,function(b){b.legendURL&&-1<n.indexOf(c.visibleLayers,
b.name)&&(k||(g.create("div",{innerHTML:"\x3cspan class\x3d'esri-legend-service-label'\x3e"+(c._titleForLegend||c.name||c.id)+"\x3c/span\x3e"},this.domNode),k=!0),g.create("div",{innerHTML:"\x3cimg src\x3d'"+b.legendURL+"'/\x3e"},this.domNode),a=!0)},this)}}else b.push(c)},this);var c=[],d=!1;n.forEach(b,function(a){if(this.view.getLayerView(a)&&(this._addLayerViewSuspendWatch(a),!0===this._isLayerVisible(a)&&(a.layerInfos||a.renderer||"esri.layers.ArcGISImageServiceLayer"==a.declaredClass))){var b=
g.create("div",{id:this.id+"_"+a.id,style:{display:"none"},"class":"esri-legend-service"});g.create("span",{innerHTML:this._getServiceTitle(a),"class":"esri-legend-service-label"},g.create("td",{align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},b)))));g.place(b,this.id,"first");a.legendResponse||a.renderer?(this._createLegendForLayer(a),d=!0):c.push(this._legendRequest(a))}},this);d?this.emit("legend-change",{empty:!1}):this.emit("legend-change",{empty:!0});0===
c.length&&!a?(u.byId(this.id+"_msg")&&(u.byId(this.id+"_msg").innerHTML=""),this._activate()):R(c).then(v.hitch(this,function(a){u.byId(this.id+"_msg").innerHTML=this.NLS_noLegend;this.emit("legend-change",{empty:null===a});this._activate()}))},_addLayerViewSuspendWatch:function(a){a=this.view.getLayerView(a);this._handles.push(y(a,"suspend",function(){this._refreshLayers()}.bind(this)));this._handles.push(y(a,"resume",function(){this._refreshLayers()}.bind(this)))},_createLegendForLayer:function(a){if(a.legendResponse||
a.renderer){var b=!1;if(a.legendResponse){var c=a.dynamicLayerInfos||a.layerInfos;c&&c.length?n.forEach(c,function(c,e){if(!a._hideLayersInLegend||-1==n.indexOf(a._hideLayersInLegend,c.id)){var f=this._buildLegendItems(a,c,e);b=b||f}},this):"esri.layers.ArcGISImageServiceLayer"==a.declaredClass&&(b=this._buildLegendItems(a,{id:0,name:null,title:a.name,subLayerIds:null,parentLayerId:-1},0))}else a.renderer&&(c=a.url?a.url.substring(a.url.lastIndexOf("/")+1,a.url.length):"fc_"+a.id,b=this._buildLegendItems(a,
{id:c,name:null,subLayerIds:null,parentLayerId:-1},0));b&&(t.set(u.byId(this.id+"_"+a.id),"display","block"),t.set(u.byId(this.id+"_msg"),"display","none"))}},_legendRequest:function(a){if(this.view.getLayerView(a))return 10.01<=a.version?this._legendRequestServer(a):this._legendRequestTools(a)},_legendRequestServer:function(a){var b=a.url,c=b.indexOf("?"),b=-1<c?b.substring(0,c)+"/legend"+b.substring(c):b+"/legend";(c=a.get("token"))&&(b+="?token\x3d"+c);var d=v.hitch(this,"_processLegendResponse"),
c={f:"json"};a._params||(a._params={});a._params.dynamicLayers&&(c.dynamicLayers=JSON.stringify(this._createDynamicLayers(a)),"[{}]"===c.dynamicLayers&&(c.dynamicLayers="[]"));a._params.bandIds&&(c.bandIds=a._params.bandIds);a._params.renderingRule&&(c.renderingRule=a._params.renderingRule);return M({url:b,content:c,callbackParamName:"callback",load:function(b,c){d(a,b,c)}})},_legendRequestTools:function(a){var b=a.url.toLowerCase().indexOf("/rest/"),b=a.url.substring(0,b)+a.url.substring(b+5,a.url.length),
b=this._legendUrl+"?soapUrl\x3d"+window.escape(b);if(!w("ie")||8<w("ie"))b+="\x26returnbytes\x3dtrue";var c=v.hitch(this,"_processLegendResponse");return M({url:b,content:{f:"json"},callbackParamName:"callback",load:function(b,e){c(a,b,e)}})},_processLegendResponse:function(a,b){b&&b.layers?(a.legendResponse=b,u.byId(this.id+"_"+a.id)&&g.empty(u.byId(this.id+"_"+a.id)),g.create("span",{innerHTML:this._getServiceTitle(a),"class":"esri-legend-service-label"},g.create("td",{align:this._align},g.create("tr",
{},g.create("tbody",{},g.create("table",{width:"95%"},u.byId(this.id+"_"+a.id)))))),this._createLegendForLayer(a)):console.log("Legend could not get generated for "+a.url+": "+JSON.stringify(b))},_buildLegendItems:function(a,b,c){var d=!1,e=u.byId(this.id+"_"+a.id),f=b.parentLayerId;if(b.subLayerIds)a=g.create("div",{id:this.id+"_"+a.id+"_"+b.id+"_group",style:{display:"none"},"class":-1==f?0<c?"esri-legend-group-layer":"":this._legendAlign},-1==f?e:u.byId(this.id+"_"+a.id+"_"+f+"_group")),g.create("td",
{innerHTML:b.name,align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%","class":"esri-legend-layer-label"},a))));else{if(a.visibleLayers&&-1==(","+a.visibleLayers+",").indexOf(","+b.id+","))return d;c=g.create("div",{id:this.id+"_"+a.id+"_"+b.id,style:{display:"none"},"class":-1<f?this._legendAlign:""},-1==f?e:u.byId(this.id+"_"+a.id+"_"+f+"_group"));g.create("td",{innerHTML:b.name||"",align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%",
"class":"esri-legend-layer-label"},c))));a.legendResponse?d=d||this._buildLegendItems_Tools(a,b,c):a.renderer&&(d=d||this._buildLegendItems_Renderer(a,b,c))}return d},_buildLegendItems_Tools:function(a,b,c){var d=b.parentLayerId,e=this.map.get("scale"),f=!1,k=function(a,b){var c,d;for(c=0;c<a.length;c++)if(b.dynamicLayerInfos)for(d=0;d<b.dynamicLayerInfos[d].length;d++){if(b.dynamicLayerInfos[d].mapLayerId==a[c].layerId)return a[c]}else if(b.id==a[c].layerId)return a[c];return{}};if(!this._respectCurrentMapScale||
this._respectCurrentMapScale&&this._isLayerInScale(a,b,e)){var l=!0;if("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISMapServiceLayer"===a.declaredClass){var m=this._getEffectiveScale(a,b);if(m.minScale&&m.minScale<e||m.maxScale&&m.maxScale>e)l=!1}if(l){var e=k(a.legendResponse.layers,b),h=e.legendType,r=e.legend;if(r){this._sanitizeLegendResponse(e,b);c=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esri-legend-layer"},c);var q=g.create("tbody",
{},c);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(c,a,b);n.forEach(r,function(c){if(!(10.1<=a.version&&!c.values&&1<r.length&&(a._hideDefaultSymbol||"\x3call other values\x3e"===c.label||!c.label&&!("esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.3<=a.version))))if(c.url&&0===c.url.indexOf("http")||c.imageData&&0<c.imageData.length)f=!0,this._buildRow_Tools(c,q,a,b.id,h)},this)}}}f&&(t.set(u.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<d&&(t.set(u.byId(this.id+"_"+
a.id+"_"+d+"_group"),"display","block"),this._findParentGroup(a.id,a,d)));return f},_sanitizeLegendResponse:function(a,b){if(!a._sanitized){var c=v.getObject("layerDefinition.drawingInfo.renderer",!1,b),d=a.legend,e,f;n.some(d,function(a,b){a.values||(f=b,e=a);return!!e});e&&(c?"uniqueValue"===c.type?(d.splice(f,1),d.push(e)):"classBreaks"===c.type&&(d.splice(f,1),d.reverse(),d.push(e)):(d.splice(f,1),d.push(e)));a._sanitized=!0}},_buildRow_Tools:function(a,b,c,d,e){var f=g.create("tr",{},b),k;this.alignRight?
(b=g.create("td",{align:this._isRightToLeft?"left":"right"},f),k=g.create("td",{align:this._isRightToLeft?"left":"right",width:35},f)):(k=g.create("td",{width:35,align:"center"},f),b=g.create("td",{},f));f=a.url;(!w("ie")||9<=w("ie")||9>w("ie")&&"esri.layers.ArcGISImageServiceLayer"===c.declaredClass)&&a.imageData&&0<a.imageData.length?f="data:image/png;base64,"+a.imageData:0!==a.url.indexOf("http")&&(f=c.url+"/"+d+"/images/"+a.url,(d=c._getToken())&&(f+="?token\x3d"+d));d=g.create("img",{src:f,alt:"",
border:0,style:"opacity:"+c.opacity},k);a=g.create("td",{innerHTML:a.label,align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%",dir:"ltr"},b))));e&&("Stretched"===e&&10.3<=c.version&&"esri.layers.ArcGISImageServiceLayer"===c.declaredClass)&&(a.style.verticalAlign="top",a.style.lineHeight="1",d.style.marginBottom="-1px",d.style.display="block",b.style.verticalAlign="top");9>w("ie")&&(d.style.filter="alpha(opacity\x3d"+100*c.opacity+")")},_getVariable:function(a,b){return a?
a[b]||n.filter(a.visualVariables,function(a){return a.type===b})[0]:null},_buildLegendItems_Renderer:function(a,b,c){var d=b.parentLayerId,e=this.map,f=this.view.get("scale"),k=!1;if(!this._respectCurrentMapScale||this._isLayerInScale(a,b,f)){var l,m,h="esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass?a.renderer.renderer:a.renderer,r,q,p,s,B;if(h instanceof T&&(h=(h="zoom"===h.rangeType?h.getRendererInfoByZoom(e.getZoom()):h.getRendererInfoByScale(f))&&h.renderer,!h))return!1;var e=this._getVariable(h,
"colorInfo"),f=this._getVariable(h,"opacityInfo"),x=this._getVariable(h,"sizeInfo");e?(r=this._getMedianColor(h,e),e.field&&(p=v.isFunction(e.field)?null:a._getField?a._getField(e.field,!0):e)):f&&(B=v.isFunction(f.field)?null:a._getField?a._getField(f.field,!0):f);x&&x.field&&(s=v.isFunction(x.field)?null:a._getField?a._getField(x.field,!0):x);if(h instanceof W)k=!0,this._showHeatRamp(a,b,h,c);else if(h instanceof U)k=!0,this._showDotDensityLegend(a,b,h,c);else if(h instanceof V)k=!0,m=g.create("table",
{cellpadding:0,cellspacing:0,width:"95%","class":"esri-legend-layer"},c),l=g.create("tbody",{},m),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(m,a,b),h.latestObservationRenderer&&h.latestObservationRenderer instanceof A&&this._buildRow_Renderer(a,h.latestObservationRenderer.symbol,r,h.latestObservationRenderer.label||this.NLS_currentObservations,null,l),h.observationRenderer&&h.observationRenderer instanceof A&&this._buildRow_Renderer(a,h.observationRenderer.symbol,r,h.observationRenderer.label||
this.NLS_previousObservations,null,l);else if(h instanceof G){if(h.infos&&0<h.infos.length){k=!0;m=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esri-legend-layer"},c);l=g.create("tbody",{},m);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(m,a,b);var w=[];n.forEach(h.infos,function(b){var c=null;a.editable&&a.types&&(c=this._getTemplateFromTypes(a.types,b.value));var d=b.label;null==d&&(d=b.value);-1===n.indexOf(w,d)&&(w.push(d),this._buildRow_Renderer(a,b.symbol,r,
d,c,l))},this)}}else if(h instanceof F){if(h.infos&&0<h.infos.length||"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass)k=!0,m=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esri-legend-layer"},c),l=g.create("tbody",{},m),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(m,a,b),m=h.infos.slice(0).reverse(),n.forEach(m,function(b){var c=b.label;null==c&&(c=b.minValue+" - "+b.maxValue);this._buildRow_Renderer(a,b.symbol,r,c,null,l)},this),"esri.layers.ArcGISImageServiceVectorLayer"===
a.declaredClass&&(a.rendererStyle===H.STYLE_SCALAR||a.rendererStyle===H.STYLE_SINGLE_ARROW)&&this._buildRow_Renderer(a,h.defaultSymbol,null,"",null,l)}else h instanceof A&&(k=!0,m=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esri-legend-layer"},c),l=g.create("tbody",{},m),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(m,a,b),q=null,a.editable&&(a.templates&&0<a.templates.length)&&(q=a.templates[0]),m=(p||B)&&s?null:p||B||s,this._buildRow_Renderer(a,h.symbol,r,m?m.alias||
m.name||m.field:h.label,q,l),q=h.symbol&&h.symbol.color,m&&(p=B=s=null));k&&(e&&e.field?(p&&this._isSmartRenderer(h,p.name)&&(p=null),this._showColorRamp(a,b,h,null,c,e,p)):f&&q&&this._showColorRamp(a,b,h,q,c,f,B),x&&x.field&&(s&&this._isSmartRenderer(h,s.name)&&(s=null),this._showSizeLegend(a,b,h,x,r,c,s)));!a._hideDefaultSymbol&&h.defaultSymbol&&(k=!0,m=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esri-legend-layer"},c),l=g.create("tbody",{},m),this._buildRow_Renderer(a,h.defaultSymbol,
null,h.defaultLabel||"others",null,l))}k&&(t.set(u.byId(this.id+"_"+a.id+"_"+b.id),"display","block"),-1<d&&(t.set(u.byId(this.id+"_"+a.id+"_"+d+"_group"),"display","block"),this._findParentGroup(a.id,d)));return k},_isSmartRenderer:function(a,b){return a instanceof F&&a.infos&&1===a.infos.length&&a.attributeField===b},_showColorRamp:function(a,b,c,d,e,f,k){var l;l=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esri-legend-layer"},e);e=g.create("tbody",{},l);(a._hoverLabel||a._hoverLabels)&&
this._createHoverAction(l,a,b);k&&this._addSubHeader(e,k.alias||k.name);b=this._getRampStops(c,f,d);b.length&&this._drawColorRamp(e,b,!0,a,this._getRampBorderColor(c))},_getMedianColor:function(a,b){var c,d;b.colors?(c=b.minDataValue,d=b.maxDataValue):b.stops&&(c=b.stops[0].value,d=b.stops[b.stops.length-1].value);return a.getColor(c+(d-c)/2,{colorInfo:b})},_getRampStops:function(a,b,c){var d,e,f,k,l=!1;b.colors||b.opacityValues?(e=b.maxDataValue-b.minDataValue,d=n.map([0,0.25,0.5,0.75,1],function(a){f=
b.minDataValue+a*e;return Number(f.toFixed(6))}),this._checkPrecision(0,4,d)):b.stops&&(d=n.map(b.stops,function(a){return a.value}),(l=n.some(b.stops,function(a){return!!a.label}))&&(k=n.map(b.stops,function(a){return a.label})));var g=d[0],h,r,q;e=d[d.length-1]-g;return n.map(d,function(f,n){c?(h=new D(c.toRgba()),r=a.getOpacity(f,{opacityInfo:b}),null!=r&&(h.a=r)):h=a.getColor(f,{colorInfo:b});q="";0===n?q=this._specialChars.lt+" ":n===d.length-1&&(q=this._specialChars.gt+" ");return{value:f,color:h,
offset:1-(f-g)/e,label:l?k[n]:q+K.format(f,{places:20,round:-1}).replace(this.reZerosFractional,"$1").replace(this.reZeros,"")}},this).reverse()},_checkPrecision:function(a,b,c){var d=a+(b-a)/2,e=c[a],f=c[d],k=c[b],l=Math.floor(e),g=Math.floor(f),h=Math.floor(k);l===e&&(h===k&&g!==f&&l!==g&&h!==g)&&(c[d]=g);a+1!==d&&this._checkPrecision(a,d,c);d+1!==b&&this._checkPrecision(d,b,c)},_getRampBorderColor:function(a){var b;if(a instanceof A)b=a.symbol;else if(a instanceof G||a instanceof F)b=a.infos[0].symbol;
a=null;if(b&&-1===b.type.indexOf("linesymbol"))if("PolygonSymbol3D"===b.type)for(var c=0;c<b.symbolLayers.length;c++){var d=b.symbolLayers[c];"Line"===d.type&&(a=this._getSymbolLayerStroke(d,0))}else a="LineSymbol3D"===b.type||"PointSymbol3D"===b.type?this._getSymbolLayerStroke(b.symbolLayers[0],0):b.get("stroke");return a&&a.color},_drawColorRamp:function(a,b,c,d,e){var f=g.create("tr",{},a),k,l,m,h,r,q=b.length-1,p;h=0;this.alignRight?(a=g.create("td",{align:this._isRightToLeft?"left":"right"},
f),k=g.create("td",{align:this._isRightToLeft?"left":"right",width:this.gradientWidth},f)):(k=g.create("td",{width:this.gradientWidth,align:"center"},f),a=g.create("td",{},f));var s=e&&0<e.a&&!(240<=e.r&&240<=e.g&&240<=e.b);l=g.create("div",{"class":s?"":"esri-legend-border-less-color-ramp",style:"position: relative; width:"+this.gradientWidth+"px;"},k);f=g.create("div",{"class":"esri-legend-color-ramp"},l);k=t.get(f,"width");s&&(e=9>w("ie")?e.toHex():"rgba("+e.toRgba().join(",")+")",t.set(f,"border",
this.colorRampBorder+" "+e));c?(e=this.gradientHeight*q,t.set(f,"height",e+"px")):e=t.get(f,"height");t.set(l,"height",e+"px");f=L.createSurface(f,k,e);9>w("ie")&&(h=f.getEventSource(),t.set(h,"position","relative"),t.set(h.parentNode,"position","relative"),h=1);try{c&&n.forEach(b,function(a,b){a.offset=b/q}),r=f.createRect({x:-h,y:-h,width:k+h,height:e+h}),r.setFill({type:"linear",x1:0,y1:0,x2:0,y2:e,colors:b}).setStroke(null),f.createRect({width:k,height:e}).setFill(new D([255,255,255,1-d.opacity])).setStroke(null),
this._surfaceItems.push(f)}catch(u){f.clear(),f.destroy()}n.forEach(b,function(a,c){if(a.label){p="top:"+100*a.offset+"%;";var d="";0===c&&(d+=" esri-legend-color-ramp-tick-first");c===b.length-1&&(d+=" esri-legend-color-ramp-tick-last");g.create("div",{"class":"esri-legend-color-ramp-tick"+d,innerHTML:"\x26nbsp;",style:p},l)}});m=g.create("div",{"class":"esri-legend-color-ramp-labels",style:{height:e+this.gradientHeight+"px"}},a);c?n.forEach(b,function(a){g.create("div",{"class":"esri-legend-color-ramp-label",
innerHTML:a.label||"\x26nbsp;"},m)}):(g.create("div",{"class":"esri-legend-color-ramp-label",innerHTML:J.widgets.legend.high},m),g.create("div",{"class":"esri-legend-color-ramp-label",innerHTML:J.widgets.legend.low,style:"top: "+(e+this.gradientHeight-2*this.gradientHeight)+"px;"},m))},_showHeatRamp:function(a,b,c,d){var e,f=c.field;e=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esri-legend-layer"},d);d=g.create("tbody",{},e);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(e,
a,b);(f=f&&a.getField(f))&&this._addSubHeader(d,f.alias||f.name);b=this._getHeatmapStops(c);b.length&&this._drawColorRamp(d,b,!1,a)},_getHeatmapStops:function(a){var b=a.colorStops;a=a.colors;var c,d,e,f;if(b&&b[0])if(c=b.length-1,a=b[0]&&null!=b[0].ratio){if((a=b[c])&&1!==a.ratio)b=b.slice(0),b.push({ratio:1,color:a.color}),c++}else d=b[0].value,e=b[c].value-d,b=n.map(b,function(a){return{color:a.color,ratio:(a.value-d)/e}});else a&&a[0]&&(c=a.length-1,f=1/(a.length-1),b=n.map(a,function(a,b){return{color:a,
ratio:b*f}}));b=n.map(b,function(a,b){var d="";0===b?d="Low":b===c&&(d="High");return{color:a.color,label:d,offset:1-a.ratio}});return b.reverse()},_showDotDensityLegend:function(a,b,c,d){var e=c.legendOptions,f,k,l,m,h,r,q,p=this.dotDensitySwatchSize,s=Math.round(p/2);e&&(k=e.backgroundColor,l=e.outline,m=e.valueUnit,h=e.dotCoverage);h=(h||this.dotCoverage)/100;q=Math.round(p*p/Math.pow(c.dotSize,2)*h);d=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esri-legend-layer"},d);r=
g.create("tbody",{},d);(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(d,a,b);this._addSubHeader(r,E.substitute({value:c.dotValue,unit:m||""},this.NLS_dotValue));n.forEach(c.fields,function(b){b=v.mixin({},b);b.numPoints=q;f=new X(c._generateImageSrc(p,p,[b],{x:0,y:0},{x:p,y:p},k),l||c.outline,p,p);b=a._getField(b.name,!0)||b;this._buildRow_Renderer(a,f,null,b.alias||b.name,null,r,{type:"path",path:"M "+-s+","+-s+" L "+s+","+-s+" L "+s+","+s+" L "+-s+","+s+" L "+-s+","+-s+" E"})},this)},
_showSizeLegend:function(a,b,c,d,e,f,k){var l=d.legendOptions,l=l&&l.customValues,m,h,r=d.minDataValue,q=d.maxDataValue,p=this._getSizeSymbol(c,e);"unknown"!==d.valueUnit||(!p||!l&&(null==r||null==q))||(e=g.create("table",{cellpadding:0,cellspacing:0,width:"95%","class":"esri-legend-layer"},f),m=g.create("tbody",{},e),(a._hoverLabel||a._hoverLabels)&&this._createHoverAction(e,a,b),k&&this._addSubHeader(m,k.alias||k.name),h=l||this._getDataValues(r,q),n.forEach(h,function(b,e){p=I.fromJSON(p.toJSON());
this._applySize(p,c,d,b);b=K.format(b,{places:20,round:-1}).replace(this.reZerosFractional,"$1").replace(this.reZeros,"");var f="";0===e?f=this._specialChars.gt+" ":e===h.length-1&&(f=this._specialChars.lt+" ");this._buildRow_Renderer(a,p,null,"\x3cspan class\x3d'esri-legend-size-ramp-label'\x3e"+f+b+"\x3c/span\x3e",null,m)},this))},_getSizeSymbol:function(a,b){var c;if(a instanceof A)c=a.symbol;else if(a instanceof H)c=a.defaultSymbol;else if(a instanceof G||a instanceof F)c=a.infos[0].symbol;if(c=
-1!==c.type.indexOf("fillsymbol")?null:c)c=I.fromJSON(c.toJSON()),b&&c.set("color",new D(b.toRgba()));return c},_applySize:function(a,b,c,d){var e=a.type;c={sizeInfo:c,shape:-1!==e.indexOf("markersymbol")?a.style:null};b=b.getSize(d,c);switch(e){case "simplemarkersymbol":a.size=b;break;case "picturemarkersymbol":e=a.width;d=a.height;a.height=b;a.width=b*(e/d);break;case "simplelinesymbol":case "cartographiclinesymbol":a.width=b;break;case "textsymbol":a.font&&(a.font.size=b)}},_getDataValues:function(a,
b){var c=[a,b],d=Math.LN10,e=Math.log(a),f=Math.log(b),k,g,m,h,r;n.forEach([1,2.5,5],function(a){h=Math.log(a);k=Math.ceil((e-h)/d);g=Math.floor((f-h)/d);if(!(Infinity===Math.abs(k)||Infinity===Math.abs(g)))for(m=k;m<g+1;m++)r=a*Math.pow(10,m),-1===n.indexOf(c,r)&&c.push(r)});c.sort(this._sorter);return c.reverse()},_sorter:function(a,b){return a-b},_buildRow_Renderer:function(a,b,c,d,e,f,k){var l=g.create("tr",{},f),m;this.alignRight?(f=g.create("td",{align:this._isRightToLeft?"left":"right"},l),
m=g.create("td",{align:this._isRightToLeft?"left":"right",width:22},l)):(m=g.create("td",{width:22,align:"center"},l),f=g.create("td",{},l));var h=l=22;"simplemarkersymbol"==b.type?(l=Math.min(Math.max(l,b.size+12),125),h=Math.min(Math.max(h,b.size+12),125)):"picturemarkersymbol"==b.type?(l=Math.min(Math.max(l,b.width),125),h=Math.min(Math.max(b.height,h),125)):"textsymbol"==b.type&&(l=Math.min(Math.max(l,b.getWidth()+12),125),h=Math.min(Math.max(h,b.getHeight()+12),125));m=g.create("div",{style:"width:"+
l+"px;height:"+h+"px;"},m);E.isDefined(d)&&"number"===typeof d&&(d=""+d);g.create("td",{innerHTML:d||"",align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},f))));(a=this._drawSymbol(m,b,c,l,h,e,a,k))&&this._surfaceItems.push(a)},_addSubHeader:function(a,b){var c=g.create("tr",{},a),c=g.create("td",{align:this._align,colspan:2},c);g.create("td",{innerHTML:b||"",align:this._align},g.create("tr",{},g.create("tbody",{},g.create("table",{width:"95%"},c))))},_drawSymbol:function(a,
b,c,d,e,f,k,g){b=I.fromJSON(b.toJSON());var m=k.opacity;c&&b.set("color",new D(c.toRgba()));if(b.symbolLayers){if(c)for(var h=0;h<b.symbolLayers.length;h++){var n=b.symbolLayers[h];n.material?n.material.color=c:n.material={color:c}}for(h=0;h<b.symbolLayers.length;h++)n=b.symbolLayers[h],n.material&&n.material.color&&(n.material.transparency=n.material.transparency?1-(1-n.material.transparency)*m:1-m)}if("simplelinesymbol"===b.type||"cartographiclinesymbol"===b.type||"textsymbol"===b.type){if(!b.color)return;
c=b.color.toRgba();c[3]*=m;b.color.setColor(c)}else"simplemarkersymbol"===b.type||"simplefillsymbol"===b.type?(b.color&&(c=b.color.toRgba(),c[3]*=m,b.color.setColor(c)),b.outline&&b.outline.color&&(c=b.outline.color.toRgba(),c[3]*=m,b.outline.color.setColor(c))):"picturemarkersymbol"===b.type?(a.style.opacity=m,a.style.filter="alpha(opacity\x3d("+100*m+"))"):"LineSymbol3D"==b.type?f={drawingTool:"LineSymbol3D"}:"PolygonSymbol3D"==b.type?f={drawingTool:"PolygonSymbol3D"}:"PointSymbol3D"==b.type?f=
{drawingTool:"PointSymbol3D"}:"MeshSymbol3D"==b.type&&(f={drawingTool:"PolygonSymbol3D"});a=L.createSurface(a,d,e);9>w("ie")&&(c=a.getEventSource(),t.set(c,"position","relative"),t.set(c.parentNode,"position","relative"));f=this._getDrawingToolShape(b,f)||Y.getShapeDescriptors(b);var q;if(f.defaultShapes&&0===f.defaultShapes.length)a.clear(),a.destroy();else{try{var p=a.createGroup();if(g)q=p.createShape(g).setFill(f.fill).setStroke(f.stroke),"text"===f.defaultShape.type&&q.setFont(f.font);else if(f.defaultShape)q=
p.createShape(f.defaultShape).setFill(f.fill).setStroke(f.stroke),"text"===f.defaultShape.type&&q.setFont(f.font);else for(h=0;h<f.defaultShapes.length;h++)q=p.createShape(f.defaultShapes[h]).setFill(f.fills[h]?f.fills[h]:{}).setStroke(f.strokes[h]?f.strokes[h]:{width:0}),"text"===f.defaultShapes[h].type&&q.setFont(f.font)}catch(s){a.clear();a.destroy();return}c=p.getBoundingBox();g=c.width;h=c.height;f=-(c.x+g/2);m=-(c.y+h/2);q=a.getDimensions();f={dx:f+q.width/2,dy:m+q.height/2};if("simplemarkersymbol"===
b.type&&"path"===b.style)d=k._getScaleMatrix(c,b.size),p.applyTransform(O.scaleAt(d.xx,d.yy,{x:q.width/2,y:q.height/2}));else if(g>d||h>e)k=g/d>h/e,d=((k?d:e)-5)/(k?g:h),v.mixin(f,{xx:d,yy:d});p.applyTransform(f);return a}},_getDrawingToolShape:function(a,b){var c=[],d=[],e=[];switch(b?b.drawingTool||null:null){case "esriFeatureEditToolArrow":c.push({type:"path",path:"M 10,1 L 3,8 L 3,5 L -15,5 L -15,-2 L 3,-2 L 3,-5 L 10,1 E"});d.push(a.getFill());e.push(a.get("stroke"));break;case "esriFeatureEditToolTriangle":c.push({type:"path",
path:"M -10,14 L 2,-10 L 14,14 L -10,14 E"});d.push(a.getFill());e.push(a.get("stroke"));break;case "esriFeatureEditToolRectangle":c.push({type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 E"});d.push(a.getFill());e.push(a.get("stroke"));break;case "esriFeatureEditToolCircle":c.push({type:"circle",cx:0,cy:0,r:10});d.push(a.getFill());e.push(a.get("stroke"));break;case "esriFeatureEditToolEllipse":c.push({type:"ellipse",cx:0,cy:0,rx:10,ry:5});d.push(a.getFill());e.push(a.get("stroke"));
break;case "LineSymbol3D":return this._getDrawingToolShapeLine3D(a,b);case "PolygonSymbol3D":return this._getDrawingToolShapePolygon3D(a,b);case "PointSymbol3D":return this._getDrawingToolShapePoint3D(a,b);default:return null}return{fills:d,strokes:e,defaultShapes:c}},_getDrawingToolShapePoint3D:function(a,b){if(0===a.symbolLayers.length)return{};for(var c=[],d=[],e=[],f=0;f<a.symbolLayers.length;f++){var k=a.symbolLayers[f];"Icon"===k.type?k.resource&&(k.resource.primitive?this._addResourcePrimitiveShapes(k,
c,d,e):(c.push({type:"image",src:k.resource.dataURI||k.resource.href,width:20,height:20}),d.push({}),e.push({}))):"Object"===k.type&&(k.resource&&k.resource.href?(c.push({type:"image",src:this.basePath+"/images/legend3dsymboldefault.png",width:20,height:20}),d.push({}),e.push({})):k.resource&&k.resource.primitive&&this._addResourcePrimitiveShapes(k,c,d,e))}return{fills:d,strokes:e,defaultShapes:c}},_addResourcePrimitiveShapes:function(a,b,c,d){switch(a.resource.primitive){case "circle":b.push({type:"circle",
cx:0,cy:0,r:10});c.push(this._getSymbolLayerFill(a,0));d.push(this._getSymbolLayerOutline(a));break;case "square":b.push({type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 Z"});c.push(this._getSymbolLayerFill(a,0));d.push(this._getSymbolLayerOutline(a));break;case "cross":b.push({type:"path",path:"M -10,0 L 10,0 E"});b.push({type:"path",path:"M 0,-10 L 0,10 E"});c.push({});c.push({});d.push(this._getSymbolLayerOutline(a));d.push(this._getSymbolLayerOutline(a));break;case "x":b.push({type:"path",
path:"M -10,-10 L 10,10 E"});b.push({type:"path",path:"M 10,-10 L -10,10 E"});c.push({});c.push({});d.push(this._getSymbolLayerOutline(a));d.push(this._getSymbolLayerOutline(a));break;case "kite":b.push({type:"path",path:"M 0,-10 L 10,0 L 0,10 L -10 0 L 0,-10 Z"});c.push(this._getSymbolLayerFill(a,0));d.push(this._getSymbolLayerOutline(a));break;case "cone":b.push({type:"path",path:"M 0,-10 L -8,5 L -4,6.5 L 0,7 L 4,6.5 L 8,5 Z"});var e=this._getSymbolLayerFill(a,0),f=this._getSymbolLayerFill(a,-0.6),
e=this._getGradientColor(e,f);e.x1=-5;e.y1=0;e.x2=5;e.y2=0;c.push(e);d.push({width:0});break;case "cube":b.push({type:"path",path:"M -10,-7 L 0,-12 L 10,-7 L 0,-2 L -10,-7 Z"});c.push(this._getSymbolLayerFill(a,0));d.push({width:0});b.push({type:"path",path:"M -10,-7 L 0,-2 L 0,12 L -10,7 L -10,-7 Z"});c.push(this._getSymbolLayerFill(a,-0.3));d.push({width:0});b.push({type:"path",path:"M 0,-2 L 10,-7 L 10,7 L 0,12 L 0,-2 Z"});c.push(this._getSymbolLayerFill(a,-0.5));d.push({width:0});break;case "cylinder":b.push({type:"path",
path:"M -8,-9 L -8,7 L -4,8.5 L 0,9 L 4,8.5 L 8,7 L 8,-9 Z"});e=this._getSymbolLayerFill(a,0);f=this._getSymbolLayerFill(a,-0.6);e=this._getGradientColor(e,f);e.x1=-5;e.y1=0;e.x2=5;e.y2=0;c.push(e);d.push({width:0});b.push({type:"ellipse",cx:0,cy:-9,rx:8,ry:2});d.push({width:0});c.push(this._getSymbolLayerFill(a,0));break;case "diamond":b.push({type:"path",path:"M 0,-10 L 10,-1 L -1,1 L 0,-10 Z"});c.push(this._getSymbolLayerFill(a,-0.3));b.push({type:"path",path:"M 0,-10 L -1,1 L -8,-1 L 0,-10 Z"});
c.push(this._getSymbolLayerFill(a,0));b.push({type:"path",path:"M -1,1 L 0,10 L -8,-1 L -1,1 Z"});c.push(this._getSymbolLayerFill(a,-0.3));b.push({type:"path",path:"M -1,0 L 0,10 L 10,-1 L -1,1 Z"});c.push(this._getSymbolLayerFill(a,-0.7));break;case "sphere":b.push({type:"circle",cx:0,cy:0,r:10});e=this._getSymbolLayerFill(a,0);f=this._getSymbolLayerFill(a,-0.6);c.push(this._getGradientColor(e,f));d.push({width:0});break;case "tetrahedron":b.push({type:"path",path:"M 0,-10 L 10,7 L 0,0 L 0,-10 Z"}),
c.push(this._getSymbolLayerFill(a,-0.3)),d.push({width:0}),b.push({type:"path",path:"M 0,-10 L 0,0 L -8,7 L 0,-10 Z"}),c.push(this._getSymbolLayerFill(a,0)),d.push({width:0}),b.push({type:"path",path:"M 10,7 L 0,0 L -8,7 L 10,7 Z"}),c.push(this._getSymbolLayerFill(a,-0.6)),d.push({width:0})}},_getDrawingToolShapePolygon3D:function(a,b){if(0===a.symbolLayers.length)return{};for(var c=[],d=[],e=[],f=0;f<a.symbolLayers.length;f++){var k=a.symbolLayers[f];if("Fill"===k.type)c.push({type:"path",path:"M -10,-10 L 10,0 L 10,10 L -10,10 L -10,-10 E"}),
d.push(this._getSymbolLayerFill(k,0)),1===a.symbolLayers.length&&e.push({width:0});else if("Line"===k.type)e.push(this._getSymbolLayerStroke(k,0)),1===a.symbolLayers.length&&(c.push({type:"path",path:"M -10,-10 L 10,0 L 10,10 L -10,10 L -10,-10 E"}),d.push({}));else if("Extrude"===k.type){this._getSymbolLayerStroke(k,0);var g=this._getSymbolLayerStroke(k,-0.4),m=this._getSymbolLayerFill(k,0),k=this._getSymbolLayerFill(k,0.4);g.width=1;c.push({type:"path",path:"M -7,-5 L -2,0 L -2,7 L -7,3 L -7,-5Z"});
d.push(m);e.push(g);c.push({type:"path",path:"M -2,0 L -2,7 L 10,-3 L 10,-10 L -2,0 Z"});d.push(m);e.push(g);c.push({type:"path",path:"M -7,-5 L -2,0 L 10,-10 L -2,-10 L -7,-5 Z"});d.push(k);e.push(g)}}return{fills:d,strokes:e,defaultShapes:c}},_getDrawingToolShapeLine3D:function(a,b){if(0===a.symbolLayers.length)return{};var c=a.symbolLayers[0],d=[],e=[],f=[],g=this._getSymbolLayerStroke(c,0),l=this._getSymbolLayerStroke(c,-0.4);"Line"===c.type?(d.push({type:"path",path:"M -2,5 L 12,5 E"}),f.push(g),
e.push([])):(g=this._getSymbolLayerFill(c,0),c=this._getSymbolLayerFill(c,0.4),l.width=1,d.push({type:"path",path:"M 3,12 L 12,0 L 11,-2 L -4,5 L -1,5 L 1,7 L 3,10 L 3,12 Z"}),e.push(g),f.push(l),d.push({type:"circle",cx:-2,cy:10,r:5}),e.push(c),f.push(l));return{fills:e,strokes:f,defaultShapes:d}},_getSymbolLayerStroke:function(a,b){if(!a.material)return{};for(var c=a.material.color.toRgb(),d="rgba(",e=0;3>e;e++)d+=this._getColorChangedLuminance(c[e],b)+",";d+=a.material.color.a+");";return{color:d,
width:S.px2pt(a.size?a.size:1)}},_getSymbolLayerFill:function(a,b){if(!a.material){var c=this._getColorChangedLuminance(255,b);return[c,c,c,100]}for(var c=a.material.color.toRgb(),d=0;3>d;d++)c[d]=this._getColorChangedLuminance(c[d],b);c.push(a.material.color.a);return c},_getSymbolLayerOutline:function(a){if(!a.outline)return{color:"rgba(0,0,0,1)",width:1.5};var b=null!=a.outline.size?a.outline.size:1.5;return{color:"rgba("+(null!=a.outline.color?a.outline.color.toRgba():"255,255,255,1")+")",width:b}},
_getGradientColor:function(a,b){return{type:"linear",x1:0,y1:0,x2:4,y2:4,colors:[{color:a,offset:0},{color:b,offset:1}]}},_getColorChangedLuminance:function(a,b){return Math.min(Math.max(a+(255-a+20)*b,0),255)},_repaintItems:function(){n.forEach(this._surfaceItems,function(a){this._repaint(a)},this)},_repaint:function(a){if(a){a.getStroke&&a.setStroke&&a.setStroke(a.getStroke());try{a.getFill&&a.setFill&&a.setFill(a.getFill())}catch(b){}a.children&&v.isArray(a.children)&&n.forEach(a.children,this._repaint,
this)}},_createHoverAction:function(a,b,c){var d=b._hoverLabel||b._hoverLabels[c.id];d&&(b.mouseMoveHandler=b.mouseMoveHandler||{},b.mouseMoveHandler[c.id]=y(a,"mousemove",v.hitch(this,function(a,b){this.mouseX=b.clientX;this.mouseY=b.clientY;this.hoverLabelShowing&&(this.hoverLabelShowing=!1,t.set(u.byId(this.id+"_hoverLabel"),"display","none"));setTimeout(v.hitch(this,function(a,b,c){if(a==this.mouseX&&b==this.mouseY&&!this.hoverLabelShowing)if(this.hoverLabelShowing=!0,u.byId(this.id+"_hoverLabel")){var d=
u.byId(this.id+"_hoverLabel");d.innerHTML="\x3cspan\x3e"+c+"\x3c/span\x3e";t.set(d,"top",b+"px");t.set(d,"left",a+15+"px");t.set(d,"display","")}else g.create("div",{innerHTML:"\x3cspan\x3e"+c+"\x3c/span\x3e",id:this.id+"_hoverLabel","class":"esri-legend-hover-label",style:{top:b+"px",left:a+15+"px"}},document.body)},b.clientX,b.clientY,a),500)},d)),b.mouseOutHandler=b.mouseOutHandler||{},b.mouseOutHandler[c.id]=y(a,"mouseout",v.hitch(this,function(a){this.mouseY=this.mouseX=-1;this.hoverLabelShowing&&
(this.hoverLabelShowing=!1,t.set(u.byId(this.id+"_hoverLabel"),"display","none"))})))},_removeHoverHandlers:function(){var a;n.forEach(this.layers,function(b){if(b.mouseMoveHandler)for(a in b.mouseMoveHandler)b.mouseMoveHandler[a].remove();if(b.mouseOutHandler)for(a in b.mouseOutHandler)b.mouseOutHandler[a].remove()})},_createDynamicLayers:function(a){var b=[],c;n.forEach(a.dynamicLayerInfos||a.layerInfos,function(d){c={id:d.id};c.source=d.source&&d.source.toJSON();var e;a.layerDefinitions&&a.layerDefinitions[d.id]&&
(e=a.layerDefinitions[d.id]);e&&(c.definitionExpression=e);var f;a.layerDrawingOptions&&a.layerDrawingOptions[d.id]&&(f=a.layerDrawingOptions[d.id]);f&&(c.drawingInfo=f.toJSON());c.minScale=d.minScale||0;c.maxScale=d.maxScale||0;b.push(c)});return b},_getTemplateFromTypes:function(a,b){var c;for(c=0;c<a.length;c++)if(a[c].id==b&&a[c].templates&&0<a[c].templates.length)return a[c].templates[0];return null},_findParentGroup:function(a,b,c){var d,e=b.dynamicLayerInfos||b.layerInfos;for(d=0;d<e.length;d++)if(c==
e[d].id){-1<e[d].parentLayerId&&(t.set(u.byId(this.id+"_"+a+"_"+e[d].parentLayerId+"_group"),"display","block"),this._findParentGroup(a,b,e[d].parentLayerId));break}},_addSubLayersToHide:function(a){function b(c,d){var e=a.layer.dynamicLayerInfos||a.layer.layerInfos,f,g;for(f=0;f<e.length;f++)if(e[f].id===c&&e[f].subLayerIds)for(g=0;g<e[f].subLayerIds.length;g++){var l=e[f].subLayerIds[g];-1===n.indexOf(d,l)&&(d.push(l),b(l,d))}}a.layer.layerInfos&&n.forEach(a.layer._hideLayersInLegend,function(c){b(c,
a.layer._hideLayersInLegend)})},_isLayerInScale:function(a,b,c){var d,e=!0;if(a.legendResponse&&a.legendResponse.layers)for(d=0;d<a.legendResponse.layers.length;d++){var f=a.legendResponse.layers[d];if(b.id==f.layerId){var g,l;!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale?(0===f.minScale&&a.tileInfo&&(g=a.tileInfo.lods[0].scale),0===f.maxScale&&a.tileInfo&&(l=a.tileInfo.lods[a.tileInfo.lods.length-1].scale)):(g=Math.min(a.minScale,f.minScale)||a.minScale||f.minScale,l=Math.max(a.maxScale,
f.maxScale));if(0<g&&g<c||l>c)e=!1;break}}else if(a.minScale||a.maxScale)if(a.minScale&&a.minScale<c||a.maxScale&&a.maxScale>c)e=!1;return e},_getServiceTitle:function(a){var b=a._titleForLegend;b||((b=a.url)?-1<a.url.indexOf("/MapServer")?(b=a.url.substring(0,a.url.indexOf("/MapServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/ImageServer")?(b=a.url.substring(0,a.url.indexOf("/ImageServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):-1<a.url.indexOf("/FeatureServer")&&
(b=a.url.substring(0,a.url.indexOf("/FeatureServer")),b=b.substring(b.lastIndexOf("/")+1,b.length)):b="",a.name&&(b=0<b.length?b+(" - "+a.name):a.name));"esri.layers.ArcGISImageServiceVectorLayer"===a.declaredClass&&a.vectorFieldPixelFilter&&(a=a.vectorFieldPixelFilter.outputUnit?this["NLS_"+a.vectorFieldPixelFilter.outputUnit]:this["NLS_"+a.vectorFieldPixelFilter.inputUnit],E.isDefined(a)&&(b+=" ("+a+")"));return P.encode(b)},_getEffectiveScale:function(a,b){var c=b.minScale,d=b.maxScale;if(E.isDefined(b.parentLayerId)){var e=
a.layerInfos,f=b.parentLayerId,g;for(g=e.length-1;0<=g;g--)if(e[g].id==f)if(0===c&&0<e[g].minScale?c=e[g].minScale:0<c&&0<e[g].minScale&&(c=Math.min(c,e[g].minScale)),d=Math.max(d||0,e[g].maxScale||0),-1<e[g].parentLayerId)f=e[g].parentLayerId;else break}return{minScale:c,maxScale:d}},_isSupportedLayerType:function(a){return a&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISImageServiceLayer"===a.declaredClass&&10.2<=a.version||"esri.layers.ArcGISImageServiceVectorLayer"===
a.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.declaredClass||"esri.layers.ArcGISTiledLayer"===a.declaredClass||"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass||"esri.layers.KMLLayer"===a.declaredClass||"esri.layers.GeoRSSLayer"===a.declaredClass||"esri.layers.WMSLayer"===a.declaredClass||"esri.layers.CSVLayer"===a.declaredClass||"esri.layers.SceneLayer"===a.declaredClass)?!0:!1}});v.mixin(z,{ALIGN_LEFT:0,ALIGN_RIGHT:1});return z});