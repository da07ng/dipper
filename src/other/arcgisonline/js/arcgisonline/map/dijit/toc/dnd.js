// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/dijit/toc/dnd",["dijit","dojo","dojox","dojo/require!arcgisonline/map/main"],function(p,a,q){a.provide("arcgisonline.map.dijit.toc.dnd");a.require("arcgisonline.map.main");arcgisonline.map.dijit.toc.dnd={_dndSourceNode:null,currentDragInfo:null,_connects:[],setup:function(b){arcgisonline.map.dijit.toc.dnd._dndSourceNode=b;arcgisonline.map.dijit.toc.dnd._dndSourceNode?arcgisonline.map.dijit.toc.dnd._dndSourceNode.checkAcceptance=function(a,b){return this===a?!0:!1}:console.log("checkAcceptance failed becasue of no DnD source");
arcgisonline.map.dijit.toc.dnd._dndSourceNode&&arcgisonline.map.role.isAllowed("toc_menu_move")&&(a.dnd.isFormElement=function(a){a=a.target;3==a.nodeType&&(a=a.parentNode);var b=0<=" button textarea input select option ".indexOf(" "+a.tagName.toLowerCase()+" ");!b&&("span"===a.tagName.toLowerCase()&&a.onclick)&&(b=!0);return b},arcgisonline.map.dijit.toc.dnd._dndSourceNode.creator=a.hitch(arcgisonline.map.dijit.toc.dnd,"avatarCreator"),a.forEach(arcgisonline.map.dijit.toc.dnd._connects,function(b){a.disconnect(b)}),
arcgisonline.map.dijit.toc.dnd._connects.push(a.connect(arcgisonline.map.dijit.toc.dnd._dndSourceNode,"onDndStart",a.hitch(arcgisonline.map.dijit.toc.dnd,"handleDragStart"))),arcgisonline.map.dijit.toc.dnd._connects.push(a.connect(arcgisonline.map.dijit.toc.dnd._dndSourceNode,"onMouseMove",a.hitch(arcgisonline.map.dijit.toc.dnd,"handleDragMove"))),arcgisonline.map.dijit.toc.dnd._connects.push(a.connect(arcgisonline.map.dijit.toc.dnd._dndSourceNode,"onMouseUp",a.hitch(arcgisonline.map.dijit.toc.dnd,
"handleMouseUp"))),arcgisonline.map.dijit.toc.dnd._connects.push(a.connect(arcgisonline.map.dijit.toc.dnd._dndSourceNode,"onDndCancel",a.hitch(arcgisonline.map.dijit.toc.dnd,"handleDragEnd"))),arcgisonline.map.dijit.toc.dnd._connects.push(a.connect(arcgisonline.map.dijit.toc.dnd._dndSourceNode,"onDropInternal",a.hitch(arcgisonline.map.dijit.toc.dnd,"handleDrop"))))},sync:function(){arcgisonline.map.dijit.toc.dnd._dndSourceNode&&arcgisonline.map.dijit.toc.dnd._dndSourceNode.sync()},avatarCreator:function(b,
d){var c=arcgisonline.map.dijit.toc.dnd._dndSourceNode.current,e=a.create("div",{innerHTML:""});e.id=a.dnd.getUniqueId();c=arcgisonline.map.main.getParameterListById(c.id);"avatar"==d&&(e.innerHTML=c.title);return{node:e,data:"",type:"something"}},handleDragStart:function(b,d,c){if(b===arcgisonline.map.dijit.toc.dnd._dndSourceNode&&"contentStack"===leftPanel.visibleStack){arcgisonline.map.dijit.toc.dnd._dndSourceNode||(arcgisonline.map.dijit.toc.dnd._dndSourceNode=b);d=0;var e;if(b=arcgisonline.map.dijit.toc.analysis.getOutFeatLyrArr())for(e in b)b.hasOwnProperty(e)&&
d++;if(!arcgisonline.map.dijit.toc.dnd._dndSourceNode.current||arcgisonline.map.dijit.toc.dnd._dndSourceNode.current.className&&-1<arcgisonline.map.dijit.toc.dnd._dndSourceNode.current.className.indexOf("toc_baseLayer")||b&&0<d)a.topic.publish("/dnd/cancel"),a.dnd.Manager.manager().stopDrag();else{e=arcgisonline.map.dijit.toc.dnd._dndSourceNode.current.id;d={id:e,idsToMoveAbove:arcgisonline.map.dijit.toc.dnd.getIdsToMoveAbove(e)};arcgisonline.map.dijit.toc.dnd.currentDragInfo=d;d=arcgisonline.map.dijit.toc.dnd._dndSourceNode.getAllNodes();
var h=[];a.forEach(d,function(a){h.push(a.id)});arcgisonline.map.dijit.toc.dnd.oldGenerateText=a.dnd.Avatar.prototype._generateText;a.dnd.Avatar.prototype._generateText=a.partial(function(a){return a},arcgisonline.map.main.getParameterListById(e).title);a.dnd.Manager.manager().updateAvatar();arcgisonline.map.dijit.toc.dnd.currentDragInfo.nodeIds=h;return!0}}},handleDragMove:function(b){if("contentStack"===leftPanel.visibleStack)if(!arcgisonline.map.dijit.toc.dnd._dndSourceNode.current&&a.dnd.Manager.manager().avatar)a.dnd.Manager.manager().canDropFlag=
!1,a.toggleClass(a.dnd.Manager.manager().avatar,"dojoDndAvatarCanDrop",a.dnd.Manager.manager().canDropFlag),a.dnd.Manager.manager().updateAvatar(),b=a.query(".dojoDndItemBefore",a.byId("toc-main")),b.length&&a.removeClass(b[0],"dojoDndItemBefore"),b=a.query(".dojoDndItemAfter",a.byId("toc-main")),b.length&&a.removeClass(b[0],"dojoDndItemAfter");else if(arcgisonline.map.dijit.toc.dnd._dndSourceNode&&arcgisonline.map.dijit.toc.dnd.currentDragInfo&&arcgisonline.map.dijit.toc.dnd._dndSourceNode.isDragging&&
arcgisonline.map.dijit.toc.dnd._dndSourceNode.current){b=arcgisonline.map.dijit.toc.dnd._dndSourceNode.current.id;var d=arcgisonline.map.dijit.toc.dnd.currentDragInfo;if(!arcgisonline.map.dijit.toc.dnd._dndSourceNode.before)for(var c=0;c<d.nodeIds.length;c++)if(d.nodeIds[c]===b){b=c<d.nodeIds.length-1?d.nodeIds[c+1]:-1;break}if(-1==b)a.dnd.Manager.manager().canDropFlag=!1,a.toggleClass(a.dnd.Manager.manager().avatar,"dojoDndAvatarCanDrop",a.dnd.Manager.manager().canDropFlag),a.dnd.Manager.manager().updateAvatar(),
b=a.query(".dojoDndItemBefore",a.byId("toc-main")),b.length&&a.removeClass(b[0],"dojoDndItemBefore"),b=a.query(".dojoDndItemAfter",a.byId("toc-main")),b.length&&a.removeClass(b[0],"dojoDndItemAfter");else if(a.query(".dummy",a.byId("toc-main")).forEach(function(b){a.removeClass(b,"dummy");b.style.borderTop="";b.style.borderBottom=""}),-1==a.indexOf(arcgisonline.map.dijit.toc.dnd.currentDragInfo.idsToMoveAbove,b))a.dnd.Manager.manager().canDropFlag=!1,a.toggleClass(a.dnd.Manager.manager().avatar,"dojoDndAvatarCanDrop",
a.dnd.Manager.manager().canDropFlag),a.dnd.Manager.manager().updateAvatar();else if(b=a.query(".dojoDndItemBefore",a.byId("toc-main")),b.length&&(a.addClass(b[0],"dummy"),b[0].style.borderTop="2px dashed #0079C1"),b=a.query(".dojoDndItemAfter",a.byId("toc-main")),b.length&&(d=a.byId(b[0].id+"_sub"),c=a.byId(b[0].id+"_legend"),!d&&!c||d&&"block"!==a.style(d,"display")||c&&"block"!==a.style(c,"display")))a.addClass(b[0],"dummy"),b[0].style.borderBottom="2px dashed #0079C1"}},handleDragEnd:function(){"contentStack"===
leftPanel.visibleStack&&(delete arcgisonline.map.dijit.toc.dnd.currentDragInfo,a.query(".canDragBefore",a.byId("toc-main")).forEach(function(b){a.removeClass(b,"canDragBefore")}),a.query(".canDragAfter",a.byId("toc-main")).forEach(function(b){a.removeClass(b,"canDragAfter")}),a.query(".dummy",a.byId("toc-main")).forEach(function(b){a.removeClass(b,"dummy");b.style.borderTop="";b.style.borderBottom=""}),arcgisonline.map.dijit.toc.dnd._dndSourceNode&&arcgisonline.map.dijit.toc.dnd._dndSourceNode.selectNone(),
arcgisonline.map.dijit.toc.dnd.oldGenerateText&&(a.dnd.Avatar.prototype._generateText=arcgisonline.map.dijit.toc.dnd.oldGenerateText,delete arcgisonline.map.dijit.toc.dnd.oldGenerateText))},handleMouseUp:function(a){"contentStack"===leftPanel.visibleStack&&arcgisonline.map.dijit.toc.dnd._dndSourceNode.selectNone()},handleDrop:function(b,d,c){if("contentStack"===leftPanel.visibleStack){var e=arcgisonline.map.dijit.toc.dnd._dndSourceNode.current.id,h=arcgisonline.map.dijit.toc.dnd.currentDragInfo;if(!arcgisonline.map.dijit.toc.dnd._dndSourceNode.before)for(c=
0;c<h.nodeIds.length-1;c++)if(h.nodeIds[c]===e){e=h.nodeIds[c+1];break}if(-1<a.indexOf(h.idsToMoveAbove,e)){var k=-1,g=-1;a.forEach(arcgisonline.map.main.mapLayers,function(a,b){a.id===e&&(g=b);a.id===h.id&&(k=b)});g<k&&(g+=1);b=arcgisonline.map.main.getParameterListById(h.id);var f=0;c=k+1;d=g;g<k&&(c=g,d=k-1);for(;c<=d;c++)var l=arcgisonline.map.main.mapLayers[c],f=l.layers?f+l.layers.length:l.layer instanceof esri.layers.GeoRSSLayer?f+l.layer.getFeatureLayers().length:f+1;g<k&&(f*=-1);var n=!1;
if(b.layers)m=a.indexOf(arcgisonline.map.main.map.graphicsLayerIds,0>f?b.layers[0].id:b.layers[b.layers.length-1].id),a.forEach(b.layers,function(a,b){arcgisonline.map.main.map.reorderLayer(a.id,m+f+(0>f?b:0));arcgisonline.map.labels.hasLayer(a)&&(n=!0)});else if(b.layer instanceof esri.layers.GeoRSSLayer){b=b.layer.getFeatureLayers();var m=a.indexOf(arcgisonline.map.main.map.graphicsLayerIds,0>f?b[0].id:b[b.length-1].id);a.forEach(b,function(a,b){arcgisonline.map.main.map.reorderLayer(a.id,m+f+(0>
f?b:0));arcgisonline.map.labels.hasLayer(a)&&(n=!0)})}else b.layer instanceof esri.layers.FeatureLayer?(m=a.indexOf(arcgisonline.map.main.map.graphicsLayerIds,b.id),arcgisonline.map.main.map.reorderLayer(b.id,m+f),arcgisonline.map.labels.hasLayer(b.layer)&&(n=!0)):(m=a.indexOf(arcgisonline.map.main.map.layerIds,b.id),arcgisonline.map.main.map.reorderLayer(b.id,m+f));n&&arcgisonline.map.labels.orderLayers();arcgisonline.map.main.mapLayers.splice(g,0,arcgisonline.map.main.mapLayers.splice(k,1)[0]);
a.publish("onLayerUpdate",[""]);arcgisonline.map.main.markMapAsChangedIfOwner("TOC:handleDrop")}return!1}},getIdsToMoveAbove:function(b){var d=[],c=arcgisonline.map.main.getParameterListById(b);if("user"!==c.type&&"mapNotes"!==c.type)return d;var e=!1;if(c.layer instanceof esri.layers.FeatureLayer||c.layers&&c.layers[0]instanceof esri.layers.FeatureLayer||c.layer instanceof esri.layers.GeoRSSLayer)e=!0;a.forEach(arcgisonline.map.main.mapLayers,function(a,b){if(c.id!==a.id&&c.type===a.type){var g=
!1;if(a.layer instanceof esri.layers.FeatureLayer||a.layers&&a.layers[0]instanceof esri.layers.FeatureLayer||a.layer instanceof esri.layers.GeoRSSLayer)g=!0;if(e&&g||!e&&!g)(b<arcgisonline.map.main.mapLayers.length-1&&arcgisonline.map.main.mapLayers[b+1].id!==c.id||b===arcgisonline.map.main.mapLayers.length-1)&&d.push(a.id)}if(0<b&&a.id!==c.id&&a.type===c.type&&g===e){var f=arcgisonline.map.main.mapLayers[b-1];if(f.type!==c.type)d.push(f.id);else{var l=!1;if(f.layer instanceof esri.layers.FeatureLayer||
f.layers&&f.layers[0]instanceof esri.layers.FeatureLayer||f.layer instanceof esri.layers.GeoRSSLayer)l=!0;l!==g&&d.push(f.id)}}});return d},isOneAbove:function(a,d,c){c=!1;for(var e=a+1;e<arcgisonline.map.main.mapLayers.length;e++)if(arcgisonline.map.main.mapLayers[e].type===d){c=!0;break}if(c&&"user"===d&&(d=arcgisonline.map.main.mapLayers[a],!(d.layer instanceof esri.layers.FeatureLayer||d.layers&&d.layers[0]instanceof esri.layers.FeatureLayer||d.layer instanceof esri.layers.GeoRSSLayer)))if(a=
arcgisonline.map.main.mapLayers[a+1],a.layer instanceof esri.layers.FeatureLayer||a.layers&&a.layers[0]instanceof esri.layers.FeatureLayer||a.layer instanceof esri.layers.GeoRSSLayer)c=!1;return c},isOneBelow:function(a,d){for(var c=!1,e=a-1;0<e;e--)if(arcgisonline.map.main.mapLayers[e].type===d){c=!0;break}if(c&&"user"===d&&(e=arcgisonline.map.main.mapLayers[a],e.layer instanceof esri.layers.FeatureLayer||e.layers&&e.layers[0]instanceof esri.layers.FeatureLayer||e.layer instanceof esri.layers.GeoRSSLayer))e=
arcgisonline.map.main.mapLayers[a-1],e.layer instanceof esri.layers.FeatureLayer||(e.layers&&e.layers[0]instanceof esri.layers.FeatureLayer||e.layer instanceof esri.layers.GeoRSSLayer)||(c=!1);return c}}});