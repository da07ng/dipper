// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("esri/core/declare dojo/_base/lang dojo/_base/array dojo/promise/all dojo/Deferred dojo/on dojo/string dojo/when esri/core/Accessor esri/core/Evented esri/core/watchUtils esri/request esri/core/lang esri/portal/support/PortalUtil esri/geometry/Extent esri/geometry/support/webMercatorUtils esri/geometry/SpatialReference webSceneViewer/spatialReferenceUtils esri/layers/GroupLayer esri/layers/FeatureLayer esri/layers/SceneLayer esri/layers/Layer esri/layers/support/TileInfo esri/layers/support/LayerDrawingOptions esri/Viewpoint esri/widgets/PopupLegacy/PopupTemplate esri/views/3d/support/cameraUtils esri/views/3d/support/viewpointUtils ../environmentUtils ../basemapUtils ../urlUtils ./WebSceneLayers ./Presentation ./LayerTemplates webSceneViewer/widgets/MessageListWidget/MessageListWidget webSceneViewer/widgets/Dialog/ConfirmDialog dojo/i18n!webSceneViewer/nls/viewer".split(" "),
function(Z,r,$,aa,s,I,y,J,ba,ca,K,da,L,ea,fa,M,u,N,O,P,Q,A,R,D,E,S,ga,ha,v,w,F,t,T,U,p,ia,n){function ja(a){if(a.renderer){var b=a.get("renderer");a._websceneEditorProperties.originalRenderer=new b.constructor(b.toJSON())}else a.then(function(b){b=a.get("renderer");a._websceneEditorProperties.originalRenderer=a.renderer?new b.constructor(b.toJSON()):null})}function ka(a){if(!(!0===a.disablePopup||null!=a.popupTemplate))if(a.isInstanceOf(P)||a.isInstanceOf(Q)&&null!=a._companionFeatureLayer){var b=
a.popupTemplate||new S({title:a.title,fieldInfos:a.fields&&a.fields.map(function(a){var b={fieldName:a.name,label:a.alias,visible:!0};"esriFieldTypeDate"===a.type&&(b.format={dateFormat:"longMonthDayYear"});return b})});a.set("disablePopup",!1);a.set("popupTemplate",b)}}function la(a,b,d){var e;if(b.layerDefinition&&b.layerDefinition.drawingInfo){var c=b.layerDefinition.drawingInfo,f=new D(r.clone(c));U.hasContentByReference(c.renderer)?e=U.createRenderer(c.renderer,d).then(function(b){a.renderer=
b;a.showLegend=!1},function(b){console.warn("Failed to create renderer by reference for "+a.title+": "+(b.message||b));p.show({message:'"'+a.title+'" '+n.messages.byReferenceRendererUnsupported,details:n.messages.layerDisplaysWithServiceSymbology+"\x3cbr\x3e"+a.url,type:p.MessageTypes.WARNING})}):f.renderer?(d=a instanceof Q,(a instanceof P||d)&&!t.isFeatureServiceRendererSupported(c.renderer.type)?p.show({message:'"'+a.title+'" '+n.messages.featureServiceNotSupportedRendererType+" "+c.renderer.type,
details:n.messages.layerDisplaysWithServiceSymbology+"\x3cbr\x3e"+a.url,type:p.MessageTypes.WARNING}):a.renderer=f.renderer):b.layerDefinition.drawingInfo.renderer&&p.show({message:'"'+a.title+'" '+n.messages.featureServiceNotSupportedRendererType+" "+c.renderer.type,details:n.messages.layerDisplaysWithServiceSymbology+"\x3cbr\x3e"+a.url,type:p.MessageTypes.WARNING});f.hasOwnProperty("labelingInfo")&&a.set("labelingInfo",f.labelingInfo)}null!=b.minScale?a.minScale=b.minScale:b.layerDefinition&&null!=
b.layerDefinition.minScale&&(a.minScale=b.layerDefinition.minScale);null!=b.maxScale?a.maxScale=b.maxScale:b.layerDefinition&&null!=b.layerDefinition.maxScale&&(a.maxScale=b.layerDefinition.maxScale);b.layerDefinition&&(b.layerDefinition.elevationInfo&&0<Object.keys(b.layerDefinition.elevationInfo).length)&&a.set("elevationInfo",r.clone(b.layerDefinition.elevationInfo));b.visibilityMode&&a.set("visibilityMode",b.visibilityMode);b.listMode&&a.set("listMode",b.listMode);b.popupInfo&&(0===Object.keys(b.popupInfo).length?
a.set("popupTemplate",null):a.set("popupTemplate",new S(b.popupInfo)));b.hasOwnProperty("disablePopup")&&a.set("disablePopup",b.disablePopup);b.showLabels&&a.set("showLabels",b.showLabels);return e}function G(a){return r.exists("spatialReference.wkid",a)?(a=a.spatialReference,a=a instanceof u?a.clone():u.fromJSON(a)):u.WGS84}function V(a,b,d,e){var c=[],f=t.create(a);if(void 0===f)return console.log("cannot apply layer to map "+a.id+" ",a.url),!1;var k=window._webSceneViewerView;switch(e){case 1:w._resetView(b,
G(a.serviceInfo),f.fullExtent);v.adjustLightForLayer(k,f);break;case 2:var l=G(a.serviceInfo);w._resetView(b,l,f.fullExtent);v.adjustLightForLayer(k,f);p.show({message:n.messages.BasemapDropWarningTitle,type:p.MessageTypes.WARNING,details:n.messages.BasemapDropWarning});l.isWebMercator()||(k.globeMode="planar")}f.on("graphics-controller-create",function(a){if(!r.exists("graphicsSource.layerDefinition.advancedQueryCapabilities.supportsPagination",f)||!1===f.graphicsSource.layerDefinition.advancedQueryCapabilities.supportsPagination)I.once(a.graphicsController,
"query-limit-exceeded",function(){var a={message:'"'+f.title+'" '+y.substitute(n.messages.layerDidNotDrawCompletely,{limit:f.maxRecordCount}),type:p.MessageTypes.WARNING,details:f.url};p.show(a)})});f._websceneEditorProperties={editedFlags:{renderer:!1,labelingInfo:!1,elevationInfo:!1,listMode:!1,visibilityMode:!1,popupInfo:!1,showLabels:!1,showLegend:!1}};a.thumbnailUrl&&(f._websceneEditorProperties.thumbnailUrl=a.thumbnailUrl);a.portalLayerItem&&(f._websceneEditorProperties.portalLayerItem=a.portalLayerItem);
a.originalOperationalLayer&&(f._websceneEditorProperties.originalOperationalLayer=a.originalOperationalLayer);f instanceof O&&a.layers.forEach(function(a,b){a.layerIndex=b;var e;a.itemId&&d?e=q.addContentByItemId(f,d,a.itemId,a):(a.itemId&&console.warn("Found item id in layer but no portal to query. Fallback to add by url.",a),e=q.addLayerToMapByUrl(f,a,d));c.push(e)});var m=F.urlParams();c.push(ma(b,f,a).then(function(){0<e&&(N.pingGeometryService(f.fullExtent),k.viewpoint=m.viewpoint&&2===e?F.viewpointFromUrlParameter(m.viewpoint):
k.createViewpoint({target:f.fullExtent,heading:0,tilt:0.5}));return la(f,a,d)}).then(function(){ja(f);ka(f)}).then(function(){return f}));return c}function ma(a,b,d){b._websceneIndex=d.layerIndex;a:{d=d.layerIndex;for(var e=a.layers.getAll(),c=0;c<e.length;c++){var f=e[c];if(d<f._websceneIndex){d=c;break a}else if(d>f._websceneIndex&&(f=e[c+1]?e[c+1]._websceneIndex:null,!f||d<f)){d=c+1;break a}}d=void 0}a.add(b,d);return b}function W(a){for(var b=0;b<t.layerHandlers.length;b++)if(t.layerHandlers[b].condition(a))return!0;
return!1}function X(a){a instanceof u||(a=u.fromJSON(a));return a.isWebMercator()}function na(a){return 4326===a.wkid||X(a)}var oa={title:n.defaultWebSceneName,type:"Web Scene",typeKeywords:"Web Scene, 3D, Map, Scene, Web, Streaming"},q=Z([ba,ca],{normalizeCtorArgs:function(a){a&&a.spatialReference&&(1.3<=a.version?a.spatialReference=u.fromJSON(a.spatialReference):delete a.spatialReference);a&&a.clippingArea&&(a.clippingArea.geometry=fa.fromJSON(a.clippingArea.geometry));a=r.mixin({},a);a.baseMap&&
null==a.baseMap.elevationLayers&&(a.baseMap.elevationLayers=w.DefaultBasemapJson.elevationLayers);return a},getDefaults:function(){return{baseMap:w.DefaultBasemapJson,operationalLayers:[],portalItemProperties:oa,presentation:new T,spatialReference:u.WebMercator,viewingMode:"global"}},initialize:function(){this._validate()},authoringApp:void 0,authoringAppVersion:void 0,baseMap:void 0,_initialStateSetter:function(a){a&&(a.environment&&!a.environment.declaredClass)&&(a.environment=v.fromJSON(a.environment));
return a},operationalLayers:void 0,portalItemProperties:void 0,presentation:void 0,_presentationSetter:function(a){if(!a)return a;a.declaredClass||(a=T.fromJSON(a));return a},_snippetGetter:function(){return this.portalItemProperties.snippet},_snippetSetter:function(a){this.portalItemProperties.snippet=a},_tagsGetter:function(){return this.portalItemProperties.tags},_tagsSetter:function(a){this.portalItemProperties.tags=a},_titleGetter:function(){return this.portalItemProperties.title},_titleSetter:function(a){this.portalItemProperties.title=
a},toc:void 0,version:void 0,addOperationalLayer:function(a){this.operationalLayers.push(a);return this.operationalLayers},removeOperationalLayer:function(a){for(var b=-1,d=0;d<this.operationalLayers.length;d++)if(this.operationalLayers[d].id===a){b=d;break}return this.operationalLayers.splice(b,1)},_updateLayerFromMap:function(a){var b=function(a,b){if(-1===a.indexOf("."))return b[a];var c=a.split(".");if(2==c.length)return b[c[0]][c[1]];if(3==c.length)return b[c[0]][c[1]][c[2]];if(4==c.length)return b[c[0]][c[1]][c[2]][c[3]];
if(5==c.length)return b[c[0]][c[1]][c[2]][c[3]][c[4]];if(5<c.length)throw Error("propName.length \x3e 5 is not implemented");},d=function(a,c){if(2<arguments.length)throw Error("get value if exists called with too many parameters");return r.exists(a,c)?b(a,c):void 0},e=function(a,b,c){return r.exists(a,b)?c:void 0},c=function(a,c,d){return r.exists(a,c)&&!0===b(a,c)?d:void 0},f=function(a){return a.elevationInfo&&0<Object.keys(a.elevationInfo).length?L.fixJson(a.elevationInfo):void 0},k=function(a){if(a.popupTemplate)return{title:a.popupTemplate.info.title,
fieldInfos:r.clone(a.popupTemplate.info.fieldInfos),description:a.popupTemplate.info.description,showAttachments:a.popupTemplate.info.showAttachments,mediaInfos:r.clone(a.popupTemplate.info.mediaInfos)}},l=function(a){if(a._websceneEditorProperties&&!1===a._websceneEditorProperties.editedFlags.labelingInfo)return d("originalOperationalLayer.layerDefinition.drawingInfo.labelingInfo",a._websceneEditorProperties);if(a._websceneEditorProperties&&!0===a._websceneEditorProperties.editedFlags.labelingInfo){var b=
new D;b.labelingInfo=a.labelingInfo;return(a=b.toJSON())&&a.labelingInfo}return null},m=function(a){if(a._websceneEditorProperties&&!1===a._websceneEditorProperties.editedFlags.renderer)return d("originalOperationalLayer.layerDefinition.drawingInfo.renderer",a._websceneEditorProperties);if(a._websceneEditorProperties&&!0===a._websceneEditorProperties.editedFlags.renderer){var b=new D;b.renderer=a.renderer;return(a=b.toJSON())&&a.renderer}return null},g={url:a.url,title:a.title,id:a.id,layerType:t.extrapolateTypeFromLayerInstance(a),
visibility:a.visible,opacity:a.opacity||1-a.transparency,layerDefinition:{drawingInfo:{}}},h=a._websceneEditorProperties&&a._websceneEditorProperties.originalOperationalLayer;g.itemId=d("portalLayerItem.item.id",a._websceneEditorProperties)||d("itemId",h);null!=h?(g.minScale=e("minScale",h,a.minScale),void 0===g.minScale&&(g.layerDefinition.minScale=e("layerDefinition.minScale",h,a.minScale)),g.maxScale=e("maxScale",h,a.maxScale),void 0===g.maxScale&&(g.layerDefinition.maxScale=e("layerDefinition.maxScale",
h,a.maxScale)),g.layerDefinition.definitionExpression=e("layerDefinition.definitionExpression",h,"string"===typeof a.definitionExpression&&0<a.definitionExpression.length?a.definitionExpression:void 0),g.layerDefinition.drawingInfo.labelingInfo=e("layerDefinition.drawingInfo.labelingInfo",h,l(a)),g.visibilityMode=c("_websceneEditorProperties.editedFlags.visibilityMode",a,a.visibilityMode)||d("visibilityMode",h),g.listMode=c("_websceneEditorProperties.editedFlags.listMode",a,a.listMode)||d("listMode",
h),g.popupInfo=c("_websceneEditorProperties.editedFlags.popupInfo",a,k(a))||d("popupInfo",h),g.showLabels=c("_websceneEditorProperties.editedFlags.showLabels",a,a.showLabels),g.showLegend=c("_websceneEditorProperties.editedFlags.showLegend",a,a.showLegend),void 0===g.showLabels&&(g.showLabels=d("showLabels",h)),void 0===g.showLegend&&(g.showLegend=d("showLegend",h)),g.layerDefinition.elevationInfo=c("_websceneEditorProperties.editedFlags.elevationInfo",a,f(a))||d("elevationInfo",h.layerDefinition),
g.layerDefinition.drawingInfo.renderer=m(a),g.disablePopup=c("_websceneEditorProperties.editedFlags.popupDisable",a,a.disablePopup),void 0===g.disablePopup&&(g.disablePopup=d("disablePopup",h))):(g.visibilityMode=c("_websceneEditorProperties.editedFlags.visibilityMode",a,a.visibilityMode),g.listMode=c("_websceneEditorProperties.editedFlags.listMode",a,a.listMode),g.popupInfo=c("_websceneEditorProperties.editedFlags.popupInfo",a,k(a)),g.showLabels=c("_websceneEditorProperties.editedFlags.showLabels",
a,a.showLabels),g.showLegend=c("_websceneEditorProperties.editedFlags.showLegend",a,a.showLegend),g.layerDefinition.elevationInfo=c("_websceneEditorProperties.editedFlags.elevationInfo",a,f(a)),g.layerDefinition.drawingInfo.renderer=m(a),g.disablePopup=c("_websceneEditorProperties.editedFlags.popupDisable",a,a.disablePopup));a instanceof O&&(delete g.url,g.layers=[],$.forEach(a.layers.getAll(),function(a){g.layers.push(this._updateLayerFromMap(a))}.bind(this)));a.url&&(0<a.url.indexOf("s3-eu-west-1.amazonaws.com")&&
a.resourceInfo)&&(g.resourceInfo=JSON.parse(a.resourceInfo));g=L.fixJson(g,!0);g.layerDefinition&&(g.layerDefinition.elevationInfo&&0===Object.keys(g.layerDefinition.elevationInfo).length)&&delete g.layerDefinition.elevationInfo;g.layerDefinition&&(g.layerDefinition.drawingInfo&&0===Object.keys(g.layerDefinition.drawingInfo).length)&&delete g.layerDefinition.drawingInfo;g.layerDefinition&&0===Object.keys(g.layerDefinition).length&&delete g.layerDefinition;return g},updateFromView:function(a,b){var d=
a.map;a.map.spatialReference&&(this.spatialReference=a.map.spatialReference.clone());this.viewingMode="spherical"===a.globeMode?"global":"local";var e=function(a,b){for(var c,d=0;d<b.length;d++)b[d].id===a&&(c=b[d]);return c},c=function(a,b){var d=e(a.id,b);d&&a.visibility!==d.visibility&&(console.debug("keeping visibility for layer "+d.id+" as "+d.visibility),a.visibility=d.visibility);d&&"GroupLayer"===a.layerType&&a.layers.forEach(function(a){c(a,d.layers)})},f=function(a){return"number"!==typeof a||
isNaN(a)?a:Math.round(1E6*a)/1E6};!1!==b&&(this.baseMap=w.toJSON(a,d.basemap));var k,l=[];k=this.calculateWebsceneExtent(d,b);d.layers.forEach(function(a){"SilentContentLayer"===a.id||"__basemapErrorFallbackLayer__"===a.id||(a=this._updateLayerFromMap(a),l.push(a))}.bind(this));if(!1===b&&this.operationalLayers&&0<this.operationalLayers.length)for(d=0;d<l.length;d++)c(l[d],this.operationalLayers);this.set("operationalLayers",l);k&&(k=M.webMercatorToGeographic(k),this.portalItemProperties.extent=f(k.xmin)+
", "+f(k.ymin)+", "+f(k.xmax)+", "+f(k.ymax))},calculateWebsceneExtent:function(a,b){var d=null;if(this.clippingArea&&this.clippingArea.clip&&this.clippingArea.geometry)d=this.clippingArea.geometry;else if(0<a.layers.length)a.layers.forEach(function(a){if(!("SilentContentLayer"===a.id||"__basemapErrorFallbackLayer__"===a.id))try{var b=a.get("fullExtent");b&&(b.spatialReference.isWebMercator()||(b=M.geographicToWebMercator(b)),d=null==d?b.clone():d.union(b))}catch(f){}}.bind(this));else if(b||!r.exists("portalItemProperties.extent",
this))d=ga.toExtent(view,ha.toCamera(view,E.fromJSON(this.initialState.viewpoint)));return d},toJSON:function(a){var b={operationalLayers:this.operationalLayers,baseMap:this.baseMap,version:(1).toString()+"."+(3).toString(),authoringApp:this.currentAuthoringApp,authoringAppVersion:this.currentAuthoringAppVersion,spatialReference:this.spatialReference.toJSON(),viewingMode:this.viewingMode};this.clippingArea&&(b.clippingArea={clip:this.clippingArea.clip,geometry:this.clippingArea.geometry.toJSON()});
this.initialState&&(b.initialState={viewpoint:this.initialState.viewpoint},this.initialState.environment&&(b.initialState.environment=v.toJSON(this.initialState.environment)));this.presentation&&(b.presentation=this.presentation.toJSON());return JSON.stringify(b,null,a)},_applyInitialState:function(a,b){var d=null,e=null;if(a){var c=window.location.hash;if(""!==c){var c=parseInt(c.substr(1),10)-1,f=this.presentation.slides.getAll();if((c=0>c||c>=f.length?null:f[c])&&c.viewpoint)e=E.fromJSON(c.viewpoint).camera}else if(b.viewpoint&&
(c=F.viewpointFromUrlParameter(b.viewpoint)))e=c.camera;this.initialState&&this.initialState.viewpoint&&(d=E.fromJSON(this.initialState.viewpoint).camera);if(d&&(this.initialState.environment||a.setInitialExtent(null,3)))a.camera=d;K.whenOnce(a,"ready",function(){e&&(a.camera=e);K.whenTrueOnce(a.environment.lighting,"ready",function(){this.get("initialState.environment.lighting")?v.applyToView(this.initialState.environment,a):v.adjustLightDateForLatitude(a.environment.lighting,a.camera.position)}.bind(this))}.bind(this))}},
applyToMap:function(a,b,d,e,c){var f=[];a.spatialReference=this.spatialReference||u.WebMercator;"local"===this.viewingMode&&(-1===this.portalItemProperties.typeKeywords.indexOf("viewingmode-local")&&(this.portalItemProperties.typeKeywords+=", ViewingMode-Local"),b.globeMode="planar",b.clippingArea=this.clippingArea&&this.clippingArea.clip?this.clippingArea.geometry:b.clippingArea);var k=[];if(!e||!0===e.basemap){var l=new s;J(w.setFromJSON(b,this.baseMap),function(){l.resolve()},function(a){l.reject({msg:a})});
f.push(l.promise)}(!e||!0===e.initialState)&&this._applyInitialState(b,c);this.operationalLayers.forEach(function(b,c){if(W(b))if(b.layerIndex=c,b.originalOperationalLayer=r.clone(b),"GroupLayer"===b.layerType){b.originalOperationalLayer.layers=null;for(var e=[],g=0;g<b.layers.length;g++)if(W(b.layers[g])){var k=b.layers[g];k.originalOperationalLayer=r.clone(b.layers[g]);e.push(k)}else p.show({message:n.messages.addLayerFailed+(""!==b.layers[g].title?": \x3ci\x3e"+b.layers[g].title+"\x3c/i\x3e":""),
type:p.MessageTypes.ERROR,details:n.messages.layerTypeNotSupported+" "+b.layers[g].layerType,collapsed:!1});b.layers=e;(e=V(b,a,d))&&(f=f.concat(e))}else b.itemId&&d?e=q.addContentByItemId(a,d,b.itemId,b):(b.itemId&&console.warn("Found item id in layer but no portal to query. Fallback to add by url.",b),e=q.addLayerToMapByUrl(a,b,d)),e&&f.push(e);else p.show({message:n.messages.addLayerFailed+(""!==b.title?": \x3ci\x3e"+b.title+"\x3c/i\x3e":""),type:p.MessageTypes.ERROR,details:n.messages.layerTypeNotSupported+
" "+b.layerType,collapsed:!1})}.bind(this));var m=new s,g=setTimeout(function(){m.reject("webscene not resolved on time")},2E4);if(0===f.length)return m.isResolved()||m.resolve({layers:k,slides:this.presentation.slides}),m;var h=f.length;for(b=0;b<f.length;b++)f[b].always(function(a,b){h--;a.isResolved()?b instanceof A?k.push(b):b&&b.layers&&(k=k.concat(b.layers)):p.show({message:n.messages.addLayerFailed,type:p.MessageTypes.ERROR,details:b.msg||b.message,collapsed:!1});0===h&&(clearTimeout(g),m.resolve({layers:k,
slides:this.presentation.slides}))}.bind(this,f[b]));m.then(function(b){a.layers.forEach(function(a){void 0!==a._websceneIndex&&delete a._websceneIndex})});return m},_validate:function(){if("global"===this.viewingMode){if(!X(this.spatialReference))throw Error(n.messages.websceneGlobalSR);var a=[];this.initialState&&this.initialState.viewpoint&&(this.initialState.viewpoint.camera&&a.push(this.initialState.viewpoint.camera.position.spatialReference),this.initialState.viewpoint.targetGeometry&&a.push(this.initialState.viewpoint.targetGeometry.spatialReference));
this.presentation&&this.presentation.slides&&this.presentation.slides.forEach(function(b){b.viewpoint&&(b.viewpoint.camera&&a.push(b.viewpoint.camera.position.spatialReference),b.viewpoint.targetGeometry&&a.push(b.viewpoint.targetGeometry.spatialReference))});if(!a.every(na))throw Error(n.messages.websceneGlobalEmbeddedSR);}else if(N.isGeographicCRS(this.spatialReference))throw Error(n.messages.websceneLocalSRGCS);}});r.mixin(q,{getFromUrl:function(a,b){var d=new s,e=new ea(a);da({url:e.useSSL(window.location.protocol,
b)}).then(function(a){var b=q.checkVersion(a.version);if(b.isCompatible)try{var e=new q(a);d.resolve(e)}catch(l){d.reject(l.message)}else d.reject(b.message)},function(a){d.reject(a)});return d},getFromPortalItem:function(a,b){var d=new s,e=a.getItem(b).then(function(c){e=c;a.getItemData(b).then(function(c){var k=q.checkVersion(c.version);if(k.isCompatible)try{var l=new q(c);l.set("portalItemProperties",e);d.resolve(l);a.isSignedIn()||I(a,"sign-in",function(){a.getItem(b).then(function(a){l.set("portalItemProperties",
a)})})}catch(m){d.reject(m.message)}else d.reject(k.message)})},function(a){d.reject(a)});return d},addLayerHandlers:function(a){for(var b=0;b<a.length;b++)t.addHandler(a[b])},_getLayerHandlers:function(){return t.getHandlers()},addLayerByItemId:function(a,b,d,e,c){var f=new s;this.addContentByItemId(a,b,d,e,c).then(function(b){a.layers.forEach(function(a){void 0!==a._websceneIndex&&delete a._websceneIndex});f.resolve(b)},function(a){f.reject(a)});return f},addContentByItemId:function(a,b,d,e,c,f){var k=
this,l=new s;b.getItem(d).then(function(m){b.getItemData(d).then(function(g){g&&g.hasOwnProperty("_ssl")&&delete g._ssl;"Scene Service"===m.type?k._addSceneServiceItem(a,b,m,d,g,e,f).then(l.resolve,l.reject):"Web Scene"==m.type?k._importWebSceneItem(a,b,c,m,g).then(l.resolve,l.reject):k._doAddLayerByItemId(a,b,d,m,g,e,f).then(l.resolve,l.reject)},function(a){l.reject(a)})},function(a){l.reject(a)});l.then(function(a){if(a&&0<a.length)for(var b=0;b<a.length;b++)a[b][0]&&a[b][0].warning&&p.show({message:a[b].warning,
type:p.MessageTypes.WARNING,details:n.messages.itemId+" "+d+"\x3cbr\x3e"+n.messages.itemType+" "+a[b].type});console.log("layer added by item id: "+d)},function(a){p.show({message:a.itemType&&"WebScene"===a.itemType?n.messages.sceneRejectTitle:n.messages.addLayerFailed,type:p.MessageTypes.ERROR,details:(a.msg?a.msg+"\x3cbr\x3e"||"":"")+n.messages.itemId+" "+d,collapsed:!1})});return l.promise},_doAddLayerByItemId:function(a,b,d,e,c,f,k){var l=this,m=[];k=k?k:this.spatialReferenceLocked?0:1;if(!c||
0===Object.keys(c).length){var g=r.mixin({url:e.url,itemId:d,title:e.title,opacity:e.opacity,visibility:e.visibility,thumbnailUrl:e.thumbnailUrl},f);g.portalLayerItem={item:e,itemData:c};for(var h in g)null==g[h]&&delete g[h];h=l.addLayerToMapByUrl(a,g,b,k);m.push(h)}else if(("Feature Service"===e.type||"Scene Service"===e.type)&&c){var B=function(g,k,h,m){h=f&&f.url||e.url;null==h.match(/\/\d+\/?$/)&&null!=g.id&&("Scene Service"===e.type&&(h+="/layers"),h=h+"/"+g.id);delete g.id;h=r.mixin(g,{url:h,
itemId:d,opacity:e.opacity,visibility:e.visibility,thumbnailUrl:e.thumbnailUrl});h=q.mixLayerItemWithWebSceneOverrides(h,f);h.portalLayerItem={item:e,itemData:c};h.layerIndex=void 0!==g.layerIndex?g.layerIndex:k;for(var n in h)null==h[n]&&delete h[n];return l.addLayerToMapByUrl(a,h,b,m)};if(c.layers)if(f&&f.url&&null!=f.url.match(/\/\d+\/?$/)&&0<f.url.match(/\/\d+\/?$/).length){h=f.url.match(/\/\d+\/?$/)[0];h=Number(h.replace(/\//g,""));for(g=0;g<c.layers.length;g++)if(c.layers[g]&&c.layers[g].id==
h){m.push(B(c.layers[g],h,c.layers,k));break}}else{if("Scene Service"===e.type&&k){var t=k,C=J(null),u=[];c.layers.forEach(function(a,b,c){C=C.then(function(){return B(a,b,c,t)}).then(function(a){a instanceof A?u.push(a):u=u.concat(a.layers);0<u.length&&(t=0)}).otherwise(function(a){this._showLayerAddError(a.msg)}.bind(this))}.bind(this));return C=C.then(function(){return{layers:u}})}c.layers.forEach(function(a,b,c){m.push(B(a,b,c,k))})}else m.push(B({},null,[],k))}else if("Map Service"===e.type){h=
r.mixin({url:e.url,itemId:d,title:e.title,opacity:e.opacity,visibility:e.visibility,thumbnailUrl:e.thumbnailUrl},f);c&&(h.layerDefinition={minScale:c.minScale,maxScale:c.maxScale});h.portalLayerItem={item:e,itemData:c};for(g in h)null==h[g]&&delete h[g];var H=new s;m.push(H);l.addLayerToMapByUrl(a,h,b,k).then(function(a){H.resolve(a);p.show({message:n.messages.layerItemPropertiesFromMapServer,type:p.MessageTypes.WARNING})},function(a){H.reject(a)})}else if("Image Service"===e.type){h=r.mixin(c,{url:e.url,
itemId:d,title:e.title,opacity:e.opacity,visibility:e.visibility,thumbnailUrl:e.thumbnailUrl});h=q.mixLayerItemWithWebSceneOverrides(h,f);h.portalLayerItem={item:e,itemData:c};for(var v in h)null==h[v]&&delete h[v];h=l.addLayerToMapByUrl(a,h,b,k);m.push(h)}else{var Y=new s;m.push(Y);setTimeout(function(){Y.reject({msg:n.messages.layerItemTypeNotSupported+" "+e.type})},0)}var x=m;if(1<x.length){var z=[],x=new s;for(h=0;h<m.length;h++)m[h].always(function(a,b){m.splice(m.indexOf(a),1);a.isResolved()?
b instanceof A?z.push(b):z=z.concat(b.layers):this._showLayerAddError(b.msg);0===m.length&&(0<z.length?x.resolve({layers:z}):x.reject())}.bind(this,m[h]))}else x=m[0];return x},_showLayerAddError:function(a){p.show({message:n.messages.addLayerFailed,type:p.MessageTypes.ERROR,details:a,collapsed:!1})},_addSceneServiceItem:function(a,b,d,e,c,f,k){var l=new s,m=this,g=new s;b.getRelatedItems(e).then(function(a){if(a&&1===a.total&&a.relatedItems&&0<a.relatedItems.length){for(var c=!1,d=0;!c&&d<a.relatedItems.length;)"Feature Service"===
a.relatedItems[d].type&&(c=!0,b.getItemData(a.relatedItems[d].id).then(function(a){a&&(a.layers&&1===a.layers.length)&&(null==f&&(f={}),f.popupInfo=a.layers[0].popupInfo,f.disablePopup=a.layers[0].disablePopup);g.resolve()},g.reject.bind(g))),d++;c||g.resolve()}else g.resolve()},g.reject.bind(g));g.promise.always(function(){m._doAddLayerByItemId(a,b,e,d,c,f,k).then(function(a){l.resolve(a)},function(a){l.reject(a)})});return l},_uniqueLayersIds:function(a,b,d){for(var e=0;e<a.length;e++){var c=a[e];
"GroupLayer"===c.layerType&&c.layers&&this._uniqueLayersIds(c.layers,b,d);var f=d[c.id];if(void 0!==f)c.id=f;else if(b.getLayer(c.id)){var f=c.id,k=f.match(/(.*-layer)(\d+)$/),l;k?(l=k[1],k=parseInt(k[2],10)):(l=f+"-",k=0);for(;b.getLayer(f);)k++,f=l+k.toString();f!==c.id&&(d[c.id]=f,c.id=f)}}},updateUniqueLayerIds:function(a,b){var d={};this._uniqueLayersIds(a.operationalLayers,b,d);a.presentation.slides.forEach(function(a){for(var b=0;b<a.visibleLayers.length;b++){var f=a.visibleLayers[b],k=d[f.id];
void 0!==k&&(f.id=k)}})},_importWebSceneItem:function(a,b,d,e,c){var f=new s,k=q.checkVersion(c.version);if(k.isCompatible)try{var l=new q(c),m=window._webSceneViewerView;if("spherical"===m.globeMode&&"local"===l.viewingMode)f.reject({itemType:"WebScene",msg:n.messages.sceneRejectL2G});else if("planar"===m.globeMode&&"global"===l.viewingMode)f.reject({itemType:"WebScene",msg:n.messages.sceneRejectG2L});else{if(l.spatialReference.equals(a.spatialReference))return q.updateUniqueLayerIds(l,a),l.set("portalItemProperties",
e),l.presentation.updateUniqueSlideIds(d.presentation.slides),l.presentation&&l.presentation.slides&&(l.presentation.slides.getAll().forEach(function(a){d.presentation.slides.addItem(a)}),d.set("presentation",d.presentation.toJSON())),l.applyToMap(a,null,b,{basemap:!1,initialState:!1});f.reject({itemType:"WebScene",msg:n.messages.sceneRejectSRTS})}}catch(g){f.reject({msg:g.message})}else f.reject({msg:k.message});return f},_updateDfd:function(a,b,d,e){if(0<b){if(a.resolve({layers:d}),0<e.length)for(b=
0;b<e.length;b++)this._showLayerAddError(e[b].msg)}else if(0<e.length){for(b=1;b<e.length;b++)this._showLayerAddError(e[b].msg);a.reject(e[0])}return a},_showBasemapDropConfirmDialog:function(a,b){var d=q._dropBasemapDialog.on("confirm",function(){e.remove();d.remove();a.resolve({dropBasemap:b})}.bind(this)),e=q._dropBasemapDialog.on("cancel",function(){e.remove();d.remove();a.resolve({dropBasemap:0})}.bind(this));q._dropBasemapDialog.show()},_checkForBasemapDropMapOrImageLayer:function(a,b,d,e,c,
f){e?(a=a instanceof u?a.clone():u.fromJSON(a),!a.equals(d)||b.basemapTerrain&&!b.basemapTerrain.tilingScheme.compatibleWith(e)?1===f&&"planar"===b.globeMode?this._showBasemapDropConfirmDialog(c,f):2===f?c.resolve({dropBasemap:f}):c.resolve({dropBasemap:0}):c.resolve({dropBasemap:0})):c.resolve({dropBasemap:0})},_checkForBasemapDropSceneLayer:function(a,b,d,e,c){a=G(a);d=a.equals(d)?!0:d.isWebMercator()&&4326===a.wkid?!0:!1;d?e.resolve({dropBasemap:0}):1===c&&"planar"===b.globeMode?this._showBasemapDropConfirmDialog(e,
c):2===c?e.resolve({dropBasemap:c}):e.resolve({dropBasemap:0})},_checkForBasemapDrop:function(a,b){var d=new s;0!==a&&0<b.length?t.prepareOpLayerFromService(b[0],a).then(function(e){e=e.serviceInfo;var c=e.tileInfo instanceof R?e.tileInfo:R.fromJSON(e.tileInfo),f=b[0].serviceDetails.serviceType,k=window._webSceneViewerView,l=k.map.spatialReference,m=e.spatialReference;"MapServer"===f?this._checkForBasemapDropMapOrImageLayer(m,k,l,c,d,a):"ImageServer"===f?this._checkForBasemapDropMapOrImageLayer(m,
k,l,c,d,a):"FeatureServer"===f?d.resolve({dropBasemap:0}):("SceneServerLocal"===f||"SceneServer"===f)&&this._checkForBasemapDropSceneLayer(e,k,l,d,a)}.bind(this),function(a){d.resolve({dropBasemap:0,error:a})}):d.resolve({dropBasemap:0});return d.promise},addLayerToMapByUrl:function(a,b,d,e){b.url=t.useSSLIfRequired(b.url,d);var c=new s,f=[],k=[],l=[],m=0;t.prepareFromServiceUrl(b.url,b).then(function(g,h){var p=[];this._checkForBasemapDrop(e,h.services).then(function(c,e){for(var q=0;q<h.services.length;q++)p.push(t.prepareOpLayerFromService(h.services[q],
e.dropBasemap));var r=h.services.length;if(0===p.length)return g.resolve(),g.promise;for(var u=p.slice(0),s=0;s<p.length;s++)p[s].promise.always(function(c,h){var q=p.indexOf(c);p.splice(q,1);var t;if(c.isResolved())m++,q=b.layerIndex,void 0===q&&(q=u.length-u.indexOf(c)),h.layerIndex=q,h.id=b.id,h.visibility=b.visibility,h.opacity=b.opacity,h.layerDefinition=b.layerDefinition,h.minScale=b.minScale,h.maxScale=b.maxScale,h.visibilityMode=b.visibilityMode,h.listMode=b.listMode,h.popupInfo=b.popupInfo,
h.showLabels=b.showLabels,h.showLegend=void 0===b.showLegend?!0:b.showLegend,h.portalLayerItem=b.portalLayerItem,h.originalOperationalLayer=b.originalOperationalLayer,h.thumbnailUrl=b.thumbnailUrl,h.disablePopup=b.disablePopup,t=V(h,a,d,e.dropBasemap),f.push(t);else if(c.isRejected()&&(0===q&&e.error?l.push(e.error):l.push(h)),r--,0===r)return g=this._updateDfd(g,m,k,l),g.promise;if(t){var v=0;aa(t).always(function(a,b){f.splice(f.indexOf(f[s]),1);for(var c=0;c<a.length;c++){var d=a[c],e=b[c];d.isResolved()?
(e instanceof A?k.push(e):k=k.concat(e.layers),v++):d.isRejected()&&(null==e&&(!Array.isArray(b)&&b.hasOwnProperty("error"))&&(console.error(n.messages.layerCreationErrorGeneric+" "+b.error),e={msg:n.messages.layerCreationErrorGeneric}),l.push(e))}r--;0===r&&(g=this._updateDfd(g,v,k,l))}.bind(this,t))}}.bind(this,p[s]),function(a,b){a.reject(b)}.bind(this,g))}.bind(this,c),function(a){g.reject(a)})}.bind(this,c),function(a,b){a.reject(b)}.bind(this,c));return c.promise},mixLayerItemWithWebSceneOverrides:function(a,
b){if(null==b)return a;if(null==a)return b;for(var d=Object.keys(a).concat(Object.keys(b)).concat(),e=0;e<d.length;++e)for(var c=e+1;c<d.length;++c)d[e]===d[c]&&d.splice(c--,1);for(e=0;e<d.length;e++)c=d[e],"layerDefinition"===c&&a.hasOwnProperty(c)&&b.hasOwnProperty(c)?a[c]=r.mixin(a[c],b[c]):b.hasOwnProperty(c)&&(a[c]=b[c]);return a},checkVersion:function(a){if(null==a)return{isCompatible:!1,version:{major:null,minor:null},message:n.messages.websceneLoadFail+"\x3cbr\x3e"+n.messages.websceneLoadFailNoVersion};
var b="string"===typeof a?a.split("."):[],d=2===b.length?parseInt(b[0],10):null,b=2===b.length?parseInt(b[1],10):null;return null===d||null===b?{isCompatible:!1,version:{major:null,minor:null},message:n.messages.websceneLoadFail+"\x3cbr\x3e"+y.substitute(n.messages.websceneLoadFailBadVersion,{websceneVersion:a})}:1>d&&!(0===d&&94===b)?{isCompatible:!1,version:{major:d,minor:b},message:n.messages.websceneLoadFail+"\x3cbr\x3e"+y.substitute(n.messages.websceneLoadFailIncompatVersion,{websceneVersion:a})+
" "+y.substitute(n.messages.websceneVersionRequires,{websceneRequiredVersion:"1.x"})}:1<d?{isCompatible:!1,version:{major:d,minor:b},message:n.messages.websceneLoadFail+"\x3cbr\x3e"+y.substitute(n.messages.websceneLoadFailIncompatVersion,{websceneVersion:a})+" (1.3)"}:{isCompatible:!0,version:{major:d,minor:b},message:""}}});q.spatialReferenceLocked=!1;q._dropBasemapDialog=new ia({title:n.messages.basemapDropTitle,message:n.messages.basemapDrop,confirm:n.messages.basemapDropConfirm});return q});