// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../../../core/declare dojo/on ../support/mathUtils ../support/projectionUtils ../lib/glMatrix ../webgl-engine/Stage ../webgl-engine/lib/Texture ../webgl-engine/lib/Util".split(" "),function(v,w,x,m,p,r,y,z){var s=p.vec2d,n=p.vec3d,g=p.vec4d,A=z.assert,k={width:0,height:0,pixelRatio:0,views:null},t=[{viewport:g.create(),extent:g.create()}],B=[t[0],{viewport:g.create(),extent:g.create()}],l=g.create(),u=n.create(),q=[g.create(),g.create()];return v(null,{constructor:function(b,a,d,c){this._view=
c;this._stage=c._stage;this._renderSR=this._overlaySR=null;this._overlaySREqualsRenderSR=!0;this.terrainSurface=d;this._renderer=this._stage.getTextureGraphicsRenderer();this._connectedLayers={};this._overlays=void 0;this._scale=0;this._dirty=!1;this._isSpherical=b;this._cyclical=a},destroy:function(){for(var b in this._connectedLayers)this.unregisterLayerView(this._connectedLayers[b]);this._disposeOverlays()},hasOverlays:function(){return!!this._overlays},setSpatialReference:function(b){(this._overlaySR=
b)?(this._renderSR=this._view.renderSpatialReference,this._overlaySREqualsRenderSR=this._overlaySR.equals(this._renderSR)):this._disposeOverlays()},registerLayerView:function(b){var a=b.layer.get("id");A(!this._connectedLayers[a],"layer already connected");var d=w(b,"draped-data-change",function(){this.setOverlayDirty()}.bind(this));this._connectedLayers[a]={eventHandles:[d],layerView:b};if(b.setDrapingExtent&&this._overlays)for(a=0;a<this._overlays.length;a++)b.setDrapingExtent(a,this._overlays[a].extent,
this._overlaySR,2048);this.setOverlayDirty()},unregisterLayerView:function(b){for(var a in this._connectedLayers){var d=this._connectedLayers[a];if(d.layerView===b){if(d.eventHandles)for(var c=0;c<d.eventHandles;c++)d.eventHandles[c].remove();delete this._connectedLayers[a];this.setOverlayDirty();b._overlayUpdating=!1;b._evaluateUpdatingState()}}},setOverlayDirty:function(){this._dirty||(this._setOverlayUpdating(!0),this._dirty=!0)},_setOverlayUpdating:function(b){for(var a in this._connectedLayers){var d=
this._connectedLayers[a].layerView;if(!b||!d.get("suspended")&&d.hasDraped)d._overlayUpdating=b,d._evaluateUpdatingState()}},updateOverlay:function(){if(this._overlaySR){var b=this._computeOverlayExtents();if(b){this._overlays||this._initOverlays();for(var a=0;a<this._overlays.length;a++){var d;a:{d=b[a];for(var c=this._overlays[a].extent,f=1E-5*Math.max(d[2]-d[0],d[3]-d[1],c[2]-c[0],c[3]-c[1]),e=0;4>e;e++)if(Math.abs(c[e]-d[e])>f){d=!0;break a}d=!1}if(d){g.set(b[a],this._overlays[a].extent);for(var h in this._connectedLayers)d=
this._connectedLayers[h].layerView,d.setDrapingExtent&&d.setDrapingExtent(a,b[a],this._overlaySR,2048)}}this._setOverlayUpdating(!1);this._drawOverlays();this.terrainSurface._updateTileOverlayParams();this._dirty=!1}}},overlaysNeedUpdate:function(){return this._dirty&&this._overlaySR},updateOpacity:function(b){var a=1;if(this._overlays){var d=this._scale;b=this._view.renderCoordsHelper.getAltitude(b);3.5*b<d&&(a=Math.sqrt(x.clamp((b-d/10)/(d/3.5-d/10),0,1)))}return a},setOverlayParamsOfTile:function(b,
a,d){b=b.extent;var c=-1;this._rectInsideRect(b,this._overlays[0].extent)?c=0:this._rectanglesOverlap(b,this._overlays[1].extent)&&(c=1);if(0<=c){var f=this._overlays[c].extent;a.overlayTexScale=(b[2]-b[0])/(f[2]-f[0]);var e=b[0];if(this._cyclical){var e=this._cyclical.minimalMonotonic(f[0],e),g=this._cyclical.minimalMonotonic(f[0],b[2]);e>g&&(e=g-(b[2]-b[0]))}s.set2((e-f[0])/(f[2]-f[0]),(b[1]-f[1])/(f[3]-f[1]),a.overlayTexOffset);a.overlayTexId=this._overlays[c].texture.getId();a.overlayOpacity=
void 0!==d?d:1}else a.overlayTexId=null},overlayPixelSizeInMapUnits:function(b){var a;this._overlays&&(this._overlays[0]&&this._pointIsInExtent(b,this._overlays[0].extent)?a=this._overlays[0].extent:this._overlays[1]&&(a=this._overlays[1].extent));return a?(a[2]-a[0])/2048:0},_initOverlays:function(){this._overlays=Array(2);for(var b=0;2>b;b++){var a=new y(null,"overlay",{wrapClamp:!0,mipmap:!0});this._stage.add(r.ModelContentType.TEXTURE,a);this._overlays[b]={texture:a,extent:g.create()}}},_disposeOverlays:function(){if(this._overlays){var b=
this._stage;this._overlays.forEach(function(a){b.remove(r.ModelContentType.TEXTURE,a.texture.getId())});this._overlays=null}},_overlayExtentIncTable:[[0,-1,2,1],[0,-2,2,0],[-1,-2,1,0],[-2,-2,0,0],[-2,-1,0,1],[-2,0,0,2],[-1,0,1,2],[0,0,2,2]],_computeOverlayExtents:function(){var b=this._view.navigation.currentCamera,a=n.create();n.set(b.center,a);this._scale=this._view.renderCoordsHelper.getAltitude(b.eye);var d=m.vectorToPoint(a,this._renderSR,this.terrainSurface.spatialReference);(d=this.terrainSurface.getElevation(d))?
this._view.renderCoordsHelper.setAltitude(d,a):this._view.navigation.getCenterIntersectManifold(b.eye,b.center,a);var c=n.dist(b.eye,a),d=b.angleOfElevation;if(!isNaN(d)){this._overlaySREqualsRenderSR||m.vectorToVector(a,this._renderSR,a,this._overlaySR);c=2*1024*b.perPixelRatio*c;this._isSpherical&&this._overlaySR.isWebMercator()&&(c/=Math.cos(m.webMercator.y2lat(a[1])),c=Math.min(c,Math.abs(this.terrainSurface.tilingScheme.origin[0])));var f=q[0];f[0]=a[0]-c;f[1]=a[1]-c;f[2]=a[0]+c;f[3]=a[1]+c;
var e=q[1];g.set(f,e);f=this.terrainSurface.extent;if(6*c>f[3]-f[1]){if(g.set(f,e),this._isSpherical){e[1]*=0.999;e[3]*=0.999;var h=this._cyclical;e.forEach(function(a,b){e[b]=h.clamp(a)})}}else d>0.25*Math.PI?(e[0]-=c,e[1]-=c,e[2]+=c,e[3]+=c):(m.vectorToVector(b.eye,this._renderSR,u,this._overlaySR),s.subtract(a,u,l),b=-Math.atan2(l[1],l[0])+0.125*Math.PI,0>b&&(b+=2*Math.PI),g.scale(this._overlayExtentIncTable[Math.floor(b/(0.25*Math.PI))],2*c,l),g.add(e,l,e));this.opacity=1;return q}},_drawOverlays:function(){for(var b=
this._overlays[0].extent[2]-this._overlays[0].extent[0],a=this._stage.getTextureGraphicsRenderer(),d=0;d<this._overlays.length;d++){var c=this._overlays[d].extent,f=this._cyclical?c[2]>this._cyclical.max:!1,e=this._cyclical?c[0]<this._cyclical.min:!1;if(f||e){k.views=B;var e=Math.round(2048*((f?this._cyclical.max-c[0]:this._cyclical.min-c[0])/(c[2]-c[0]))),h=k.views[0];g.set4(0,0,e,2048,h.viewport);g.set4(c[0],c[1],this._cyclical.max,c[3],h.extent);f||(h.extent[0]+=this._cyclical.range);h=k.views[1];
g.set4(e,0,2048-e,2048,h.viewport);g.set4(this._cyclical.min,c[1],c[2],c[3],h.extent);f&&(h.extent[2]-=this._cyclical.range)}else k.views=t,g.set(c,k.views[0].extent),g.set4(0,0,2048,2048,k.views[0].viewport);k.width=2048;k.height=2048;k.pixelRatio=b/(c[2]-c[0]);a.draw(this._overlays[d].texture,k)}},_rectanglesOverlap:function(b,a){return this._cyclical?(this._cyclical.contains(a[0],a[2],b[0])||this._cyclical.contains(a[0],a[2],b[2]))&&!(b[1]>a[3]||b[3]<a[1]):!(b[0]>a[2]||b[2]<a[0]||b[1]>a[3]||b[3]<
a[1])},_rectInsideRect:function(b,a){return this._cyclical?this._cyclical.contains(a[0],a[2],b[0])&&this._cyclical.contains(a[0],a[2],b[2])&&b[1]>a[1]&&b[3]<a[3]:b[0]>a[0]&&b[2]<a[2]&&b[1]>a[1]&&b[3]<a[3]},_pointIsInExtent:function(b,a){if(this._cyclical)return this._cyclical.contains(a[0],a[2],b.x)&&b.y>=a[1]&&b.y<=a[3];var d=b.x,c=b.y;return d>a[0]&&d<a[2]&&c>a[1]&&c<a[3]}})});