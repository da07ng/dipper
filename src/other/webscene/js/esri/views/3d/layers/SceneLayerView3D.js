// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("esri/core/declare esri/core/watchUtils dojo/_base/lang dojo/_base/array dojox/color dojo/promise/all dojo/has ../../layers/LayerView ./i3s/I3SUtil ./i3s/I3SProjectionUtil ./support/LayerViewUpdatingPercentage ../../../Graphic ../support/PromiseLightweight ../support/projectionUtils ../lib/glMatrix ../webgl-engine/Stage ../webgl-engine/lib/Base64Binary ../webgl-engine/lib/Layer ../webgl-engine/lib/Util ../webgl-engine/lib/Geometry ../webgl-engine/lib/GeometryData ../webgl-engine/lib/Object3D ../webgl-engine/materials/Material ../webgl-engine/lib/Texture".split(" "),
function(U,K,V,W,X,Y,Z,$,C,L,aa,M,ba,J,P,N,ka,ca,w,da,ea,fa,ga,B){function Q(a,b){var d=!1,c;b.encoding===C.DDS_ENCODING_STRING?c=B.DDS_ENCODING:d=!(R(a.width)&&R(a.height));return{mipmap:!(b.atlas||d),wrapClamp:b.atlas||!b.wrap,encoding:c,noUnpackFlip:!0}}var v=w.assert,H=P.mat4d,x=P.vec3,ha=w.clamp,R=w.isPowerOfTwo,F=w.fallbackIfUndefined,G=w.objectEmpty,t=w.VertexAttrConstants,s=N.ModelContentType,ia=[0.8,0.8,0.8],ja=[0.5,0.5,0.5];new M;return U([$,aa],{declaredClass:"esri.views.3d.layers.SceneLayerView3D",
initialize:function(){var a=this.get("layer.store.version");this.useCompressedTextures=this.view.has("s3tc")&&(!Z("trident")||"1.3"<a);this._initGraphicsController();this.dbg=!1;this.maxGpuMemory=1E3;this.geoMemoryEstimate=this.texMemoryEstimate=this.gpuMemoryEstimate=0;this.memEstimateTextureAdded=function(a){a=a.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate+=a;this.texMemoryEstimate+=a};this.memEstimateTextureRemoved=function(a){a=a.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate-=
a;this.texMemoryEstimate-=a};this.memEstimateGeometryAdded=function(a){a=a.estimateGpuMemoryUsage()/1E6;this.gpuMemoryEstimate+=a;this.geoMemoryEstimate+=a};this.memEstimateGeometryRemoved=function(a){a=a.estimateGpuMemoryUsage()/1E6;this.gpuMemoryEstimate-=a;this.geoMemoryEstimate-=a};this._stage=this.view._stage;this._matId2Meta={};this._texId2Meta={};this._requestedTexImageIds={};this._nodeId2Meta={};this._colorOverride=null;for(var a=new Uint8Array(256),b=0;b<a.length;b++)a[b]=255;this._whiteTexture=
new B(a,"white",{width:8,height:8});this._stage.add(N.ModelContentType.TEXTURE,this._whiteTexture);this._layerEventHandles=[K.init(this.layer,"renderer",this._rendererChange.bind(this)),K.watch(this.layer,"opacity",this._opacityChange.bind(this)),K.init(this.view,"clippingArea",this._clippingAreaChanged.bind(this))];this._addThisLayerToStage();this.setVisibility(!this.get("suspended"));this.debugLODVis=this.debugNodeVis=!1},destroy:function(){this._stage.remove(N.ModelContentType.TEXTURE,this._whiteTexture.getId());
this._removeThisLayerFromStage();var a=function(a){a.remove()};this._layerEventHandles.forEach(a);null!=this._extentEventHandles&&this._extentEventHandles.forEach(a);this._stage=null;this._controller.destroy();this._nodeId2Meta=this._texId2Meta=this._matId2Meta=null},isBundleAlreadyAddedToStage:function(a,b){var d=!1,c=!1;if(null!=this._nodeId2Meta[a.id]&&this._nodeId2Meta[a.id].engineObjectsPerBundle&&this._nodeId2Meta[a.id].engineObjectsPerBundle[b]){var c=!0,e;for(e in this._nodeId2Meta[a.id].engineObjectsPerBundle[b])if(d=
this._nodeId2Meta[a.id].engineObjectsPerBundle[b][e].isPartiallyHidden()||a._numFeaturesLoadedPerBundle<a.features.length)break}return{wasPartiallyHidden:d,alreadyLoaded:c}},_initGraphicsController:function(){var a={addBundle:this._addBundle.bind(this),isBundleAlreadyAddedToStage:this.isBundleAlreadyAddedToStage.bind(this),isOverMemory:this.isOverMemory.bind(this),removeNodeData:this._removeNodeDataFromStage.bind(this),removeFeatures:this._removeFeatures.bind(this),getAddedFeatures:this._getAddedFeatures.bind(this),
areAllBundlesLoaded:this._areAllBundlesLoaded.bind(this),wholeNodeSwitchEnabled:!0},b={additionalStartNodeLoadingHandler:this._startNodeLoading.bind(this),additionalCancelNodeLoadingHandler:this.cancelNodeLoading.bind(this),getTexturePrefetchFunctions:function(){return{_calcDesiredTextureLOD:this._calcDesiredTextureLOD.bind(this),_imageIsPartOfTextureBundle:this._imageIsPartOfTextureBundle.bind(this),_matId2Meta:this._matId2Meta,_texId2Meta:this._texId2Meta,useCompressedTextures:function(){return this.useCompressedTextures}.bind(this)}}.bind(this),
_nodeDebugVisualizer:this._nodeDebugVisualizer,setPolygonOffset:this._setPolygonOffset.bind(this),traversalOptions:{initDepthFirst:!0,neighborhood:!0,perLevelTraversal:!1,allowPartialOverlaps:!1},getLoadedAttributes:this.getLoadedAttributes.bind(this),setAttributeData:this.setAttributeData.bind(this)},a=this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:a,layerViewOptionalFunctions:b});Y([this,a]).then(function(a){}.bind(this))},setMaxGpuMemory:function(a){this.maxGpuMemory=
a},setVisibility:function(a){if(this._stage&&this._engineLayer){var b=this._engineLayer.getId(),d=this._stage.getViewContent();!(!1!==a&&0<=d.indexOf(b))&&!(!1===a&&-1==d.indexOf(b))&&(b=[b],null!=this._nodeDebugVisualizer&&b.push(this._nodeDebugVisualizer.engineLayer.getId()),!1!==a?this._stage.addToViewContent(b):this._stage.removeFromViewContent(b))}},setRemoveEnabled:function(a){this.removeEnabled=a},getEngineLayer:function(){return this._engineLayer},getStats:function(){var a,b={nodesInIndex:0,
knownFeatures:0,displayedFeatures:0,displayedGeometries:0,displayedComponents:0,geometryDataSize:0};if(!this._controller)return b;for(var d in this._controller.get("nodeIndex"))if(this._controller.get("nodeIndex").hasOwnProperty(d)){b.nodesInIndex++;var c=this._controller.get("nodeIndex")[d];if(null!=c.features)for(var e=0;e<c.features.length;e++){var f=c.features[e];b.knownFeatures++;if(null!=f.engineObject){b.displayedFeatures++;f=f.engineObject.getGeometryRecords();b.displayedGeometries+=f.length;
for(var k=0;k<f.length;k++){var h=f[k].geometry.getData(),g=h.getFaces();b.displayedComponents+=g.length;for(var m=0;m<g.length;m++){var l=g[m].indices;for(a in l)l.hasOwnProperty(a)&&(b.geometryDataSize+=l[a].byteLength)}h=h.getVertexAttr();for(a in h)h.hasOwnProperty(a)&&(b.geometryDataSize+=h[a].data.byteLength)}}}}b.activeMaterials=Object.keys(this._matId2Meta).length;return b},_addThisLayerToStage:function(){var a=this._stage;this._initTexture=new B(null,"i3sInitTexture");a.add(s.TEXTURE,this._initTexture);
var b=this.layer.get("id");this._engineLayer=b=new ca(b,{fullExtent:J.convertExtent(this.layer.fullExtent,this.view.renderSpatialReference),initialExtent:J.convertExtent(this.layer.initialExtent,this.view.renderSpatialReference)},b);a.add(s.LAYER,b);null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose()},_removeThisLayerFromStage:function(){this.cancelNodeLoading();if(null!=this._engineLayer){var a=this._stage;a.remove(s.TEXTURE,this._initTexture.getId());for(var b in this._controller.get("nodeIndex"))if(this._controller.get("nodeIndex").hasOwnProperty(b)){var d=
this._controller.get("nodeIndex")[b];this._removeNodeDataFromStage(d);delete this._controller.get("nodeIndex")[b]}v(G(this._nodeId2Meta));v(G(this._matId2Meta));v(G(this._texId2Meta));a.remove(s.LAYER,this._engineLayer.getId());null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose();this._nodeDebugVisualizer=void 0;this._matId2Meta={};this._texId2Meta={};this._requestedTexImageIds={};this._nodeId2Meta={};this._engineLayer=void 0;this.gpuMemoryEstimate=0}},_startNodeLoading:function(){this._updateAllTextureLOD()},
cancelNodeLoading:function(){null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.clear();this._requestedTexImageIds={}},_isAllHidden:function(a){for(var b in this._nodeId2Meta[a.id].engineObjects)if(!this._nodeId2Meta[a.id].engineObjects[b].isAllHidden())return!1;return!0},getLoadedAttributes:function(a){if((a=this._nodeId2Meta[a.id])&&1==a.engineObjects.length)return a.engineObjects[0].getMetadata().loadedAttributes},setAttributeData:function(a,b,d){if((a=this._nodeId2Meta[a.id])&&1==a.engineObjects.length){a=
a.engineObjects[0];var c=a.getMetadata();c.loadedAttributes=b;c.attributeData=d;this._setObjectSymbology(a)}},_createUnitTestData:function(a){var b={},d=this.view.navigation.targetCamera;b.viewParams={eye:d.eye,center:d.center,up:d.up,viewMatrix:d.viewMatrix,projectionMatrix:d.projectionMatrix,fovX:d.fovX,viewport:d.viewport,perPixelRatio:d.perPixelRatio};b.visibleObjects=[];a=a.getAll("objects");for(var c in a)if(d=a[c],d.getParentLayer()===this._engineLayer){var e=d.getMetadata(),d=e.i3sNode,e=
W.map(e.features,function(a){return a.id});e.sort();b.visibleObjects.push({featureIDs:e,nodeId:d})}console.debug(b.visibleObjects.length);return JSON.stringify(b)},isOverMemory:function(){return this.gpuMemoryEstimate>this.maxGpuMemory?(console.warn("over memory: "+this.gpuMemoryEstimate+" tex "+this.texMemoryEstimate+" geom "+this.geoMemoryEstimate),!0):!1},_getAddedFeatures:function(a){if(null==this._nodeId2Meta[a])return null;var b=[],d;for(d in this._nodeId2Meta[a].engineObjects){var c=this._nodeId2Meta[a].engineObjects[d],
e;for(e in c.getMetadata().features)b.push(c.getMetadata().features[e])}return b},_calcEngineMaterialTransparencyParams:function(a,b,d){var c=this.layer.get("opacity");null==c&&(c=1);var e=1-ha(F(b.transparency,0),0,1),c=c*e;a=1>c||a&&a.channels.endsWith("a")||!0===b.useVertexColorAlpha||d;return{opacity:c,transparent:a}},_calcEngineMaterialDoubleSidedParams:function(a){return null!=a.doubleSided?a.doubleSided:!0},_calcEngineMaterialCullFaceParams:function(a){return a.cullFace?a.cullFace:null!=a.doubleSided?
a.doubleSided?"none":"back":"none"},_createEngineMaterial:function(a,b,d,c,e,f,k,h,g){var m=h;if(null!=a)var l=f[b],m=l&&l.engineTex?l.engineTex.getId():h;h=d.params;var p=F(h.diffuse,ia);if(null!=a)var n=C.getAppropriateTextureEncoding(a.encoding,this.useCompressedTextures),q=-1<n?a.encoding[n]:a.encoding;var r="";"standard"!==d.type&&(r+="Unknown material type '"+h.type+"', must be 'standard'");void 0===h.reflectivity&&(r+="Material parameter 'reflectivity' is missing.");0<r.length&&this.layer.warningEvent(r,
1);d={ambient:this._colorOverride||p,diffuse:this._colorOverride||p,specular:F(h.specular,ja),shininess:F(h.shininess,64),atlasRegions:h.vertexRegions,textureId:m&&this._colorOverride?this._whiteTexture.getId():m,vertexColors:!0,flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(h),cullFace:this._calcEngineMaterialCullFaceParams(h)};m=this._calcEngineMaterialTransparencyParams(a,h);V.mixin(d,m);d=new ga(d);d.metadata={i3sMatId:c,i3sTexId:b,i3sTex:a,i3sMatParams:h};if(null!=a){l?l.usedByEngineMats.push(d):
(l={id:b,featureMBS:{},usedByEngineMats:[d],images:a.images,encoding:q,encodingIdx:n,atlas:!0===a.atlas,wrap:"none"!==a.wrap[0]||"none"!==a.wrap[1]},f[b]=l);for(a=0;a<e.length;a++)f=e[a],l.featureMBS[f.id]=f.engineMBS;if(void 0!==g[b]){null==l.engineTex&&(e=g[b].data,a=Q(e,l),l.engineTex=new B(e,l.id,a),this._stage.add(s.TEXTURE,l.engineTex),l.desiredLOD=g[b].desiredLOD,l.curLOD=l.desiredLOD,this.memEstimateTextureAdded(l.engineTex));e=l.engineTex.getId();for(a=0;a<l.usedByEngineMats.length;a++)f=
l.usedByEngineMats[a],null==this._colorOverride&&f.setParameterValues({textureId:e}),f.metadata.originalTextureId=e;g[b].createdTextureForDomImage();delete g[b]}else this._updateTextureLOD(l)}k[c]||(k[c]={});k[c][b]={engineMat:d,refCount:1};return d},_createVertexAndIndexArrays:function(a,b,d){var c,e=a.params.vertexAttributes,f={},k;for(k in e)if(e.hasOwnProperty(k)&&"classification"!==k){var h=e[k];c=C.valueType2TypedArrayClassMap[h.valueType];v(null!=c,"unsupported vertex attribute value type: "+
h.valueType);f[k]={data:new c(b,h.byteOffset,h.count*h.valuesPerElement),size:h.valuesPerElement}}if(null==f[t.COLOR]){c=C.valueType2TypedArrayClassMap.UInt8;f[t.COLOR]={data:new c(4*e.position.count),size:4};for(var g=0;g<f[t.COLOR].length;g++)f[t.COLOR][g]=0===g%3?255:0}h=!1;null==f[t.NORMAL]&&(h=!0,c=C.valueType2TypedArrayClassMap.Float32,f[t.NORMAL]={data:new c(3*e.position.count),size:3});var e=[],m=a.params.faces;if(null!=m&&"PerAttributeArray"!=a.params.topology){var l={};for(k in m)m.hasOwnProperty(k)&&
(c=m[k],v(0===c.count%3),v(c.count===m.position.count),v("UInt32"===c.valueType),l[k]=c.byteOffset);for(var p=a.params.components.length,n=Array(p),q=m.position.componentIndices,r=0;r<p;r++){var s=a.params.components[r],u=r<p-1?q[r+1]-q[r]:m.position.count-q[r];c={type:"triangle",positionKey:"position",indices:{},componentRange:[q[r],q[r]+u]};for(k in m)m.hasOwnProperty(k)&&(c.indices[k]=new Uint32Array(b,l[k],u),l[k]+=4*u);if(null==c.indices[t.COLOR]){c.indices[t.COLOR]=new Uint32Array(u);for(g=
0;g<u;g++)c.indices[t.COLOR][g]=g}if(h&&null==c.indices[t.NORMAL]){c.indices[t.NORMAL]=new Uint32Array(u);for(g=0;g<u;g++)c.indices[t.NORMAL][g]=g}n[r]=c;var g=s.textureID||"none",D;"none"!==g&&(D=d.textureDefinitions[g],v(void 0!==D,"geometry wants unknown texture "+g));if(D&&!0===D.atlas&&null!=D.regions){v(0<D.regions.length,"texture marked as atlas carries no region definition");g=D.regions[s.regionID].subimageRegion;e=e.concat([65536*g[0],65536*(g[2]-g[0]),65536*(1-g[3]),65536*(g[3]-g[1])]);
g=new Uint32Array(u);for(s=0;s<u;s++)g[s]=e.length/4-1;c.indices[t.REGION]=g}}}else{c={type:"triangle",positionKey:"position",indices:{}};for(l in f){a=f[l];a=new Uint32Array(a.data.length/a.size);b=a.length;for(g=0;g<b;g++)a[g]=g;c.indices[l]=a}a=c.indices[c.positionKey];c.componentRange=[0,null!=a?a.length-1:0];n=[c]}0<e.length&&(e=new Uint16Array(e),f[t.REGION]={data:e,size:4});return{indexArrays:n,vertexArrays:f}},_createEngineMats:function(a,b,d,c,e,f,k,h){for(var g=a.params.components.length,
m=Array(g),l=0;l<g;l++){var p=a.params.components[l],n=p.materialID,q=d.materialDefinitions[n];null!=q.href&&(q=c[q.hrefConcat].materialDefinitions[n]);v(void 0!==q,"geometry wants unknown material "+n);var p=p.textureID||"none",r;"none"!==p&&((null==d.textureDefinitions||null==d.textureDefinitions[p])&&this.layer.warningEvent("textureDefinitions missing in shared resource",1,p),r=d.textureDefinitions[p]);e[n]&&e[n][p]?(q=this._matId2Meta[n][p],n=q.engineMat,q.refCount++):n=this._createEngineMaterial(r,
p,q,n,b,f,e,k.getId(),h);m[l]=n}return m},_areAllBundlesLoaded:function(a,b){if(null==this._nodeId2Meta[a.id]||null==this._nodeId2Meta[a.id].engineObjectsPerBundle)return!1;for(var d=0;d<a.featureData.length;d++){if(null==this._nodeId2Meta[a.id].engineObjectsPerBundle[d])return!1;if(!0!==b)for(var c in this._nodeId2Meta[a.id].engineObjectsPerBundle[d])if(this._nodeId2Meta[a.id].engineObjectsPerBundle[d][c].isPartiallyHidden())return!1}return!0},getGraphicsFromStageObject:function(a,b){function d(a,
b){C.queryAttributesFromFeatureLayer(h,a).then(function(a){a=new M(null,null,a);a.layer=k;b.done(a)},function(a){b.reject(a)})}var c=new ba.Promise,e=a.getMetadata(),f=a.getFaceRangeIndexFromTriangleNr(b),k=this.layer,h=k._companionFeatureLayer;null!=f&&null!=e.graphics&&null!=e.graphics[0].attributes?c.done(e.graphics[f]):null!=f&&null!=e.featureIds&&null!=e.featureIds[f]?d(e.featureIds[f],c):(e=this._controller.get("nodeIndex")[e.i3sNode],null==e||null==e.featureData||1!==e.featureData.length?c.reject():
(f=C.getNodeURL(this._controller.getBaseUrl(),e.id),e=C.concatUrl(f,e.featureData[0].href),this._controller.get("streamDataSupplier").request(e,"json").then(function(a,e,f,h){if(!(null==e||null==e.featureData))for(a=0;a<e.featureData.length;a++){f=e.featureData[a];for(h=0;h<f.geometries.length;h++){var k=f.geometries[h];if(k.params.faceRange&&b>=k.params.faceRange[0]&&b<=k.params.faceRange[1]){d(f.id,c);return}}}c.reject()}.bind(this),function(a){c.reject()})));return c},_calculateNormals:function(a,
b){var d=b.normal,c=b.position,e=a[0].indices.normal,f=a[0].indices.position;v(e.length==f.length);for(var k=x.create(),h=x.create(),g=0;g<f.length;g+=3){var m=3*f[g+0],l=c.data[m+0],p=c.data[m+1],n=c.data[m+2],m=3*f[g+1];k[0]=c.data[m+0]-l;k[1]=c.data[m+1]-p;k[2]=c.data[m+2]-n;m=3*f[g+2];h[0]=c.data[m+0]-l;h[1]=c.data[m+1]-p;h[2]=c.data[m+2]-n;x.cross(k,h,k);x.normalize(k);for(m=0;3>m;m++)l=3*e[g+m],d.data[l+0]=k[0],d.data[l+1]=k[1],d.data[l+2]=k[2]}},_addBundle:function(a,b,d,c,e,f,k){if(!0===this.debugNodeVis&&
null!=this._nodeDebugVisualizer){var h="grey";switch(a.level){case 1:h="red";break;case 2:h="green";break;case 3:h="blue";break;case 4:h="yellow";break;case 5:h="magenta";break;case 6:h="brown"}this._nodeDebugVisualizer.show(a,this._controller._crsIndex,h)}var h=this._stage,g={};g[s.OBJECT]={};g[s.GEOMETRY]={};g[s.MATERIAL]={};g[s.TEXTURE]={};var m=this._engineLayer,l=m.getId(),p=c[a.sharedResource.hrefConcat];if(null!=this._nodeId2Meta[a.id]&&null!=this._nodeId2Meta[a.id].engineObjectsPerBundle&&
this._nodeId2Meta[a.id].engineObjectsPerBundle[k]){for(var n in this._nodeId2Meta[a.id].engineObjectsPerBundle[k])this._hideFaceRangesOutsideBoundingBox(a,this._clippingArea);null!=e&&e.done()}else if(!this.isOverMemory()){if(null==this._nodeId2Meta[a.id]||null==this._nodeId2Meta[a.id].engineObjectsPerBundle)this._nodeId2Meta[a.id]={},this._nodeId2Meta[a.id].engineObjects=[],this._nodeId2Meta[a.id].engineObjectsPerBundle=[];this._nodeId2Meta[a.id].engineObjectsPerBundle[k]=[];if(null!=b){for(n=0;n<
b.length;n++){var q=b[n].geometries,r=b[n].features,t=b[n].featureDataAttributes,u=c[a.geometryData[k].hrefConcat];v(u instanceof ArrayBuffer,"I3S: geometry data is not an ArrayBuffer");null==u._isReprojected&&(u._isReprojected={});for(var D=r[0].id.toString(),C=[],S=[],T=[],y=0;y<q.length;++y){var z=q[y],A=this._createVertexAndIndexArrays(z,u,p);if(0!==A.indexArrays.length){var O=this._createEngineMats(z,r,p,c,this._matId2Meta,this._texId2Meta,this._initTexture,f),E=L.reprojectPoints(this._controller.isMeshPyramid?
L.ReprojectionTypes.PER_VERTEX:L.ReprojectionTypes.BOUNDINGBOX,A.vertexArrays.position,A.vertexArrays.normal,a.mbs,u._isReprojected[z.id],this._controller.get("crsIndex"),this._controller.get("crsVertex"),this.view.renderSpatialReference);u._isReprojected[z.id]=!0;this._controller.isMeshPyramid&&this._calculateNormals(A.indexArrays,A.vertexArrays);z=H.create(z.transformation);H.multiply(E.localTrafo,z,z);for(var w=0;w<O.length;w++){var B=O[w];g[s.MATERIAL][B.getId()]=B}A=new da(new ea(A.indexArrays,
A.vertexArrays),D+"_"+y);this.memEstimateGeometryAdded(A.getData());g[s.GEOMETRY][A.getId()]=A;C[y]=A;S[y]=z;T[y]=O}}q={attributes:{},graphics:[]};for(u=0;u<r.length;u++)y=new M(void 0,void 0,t[u],void 0),y.set("layer",this.layer),q.graphics.push(y);q.i3sNode=a.id;q.ceLayer=l;q.features=r;q.faceRanges=b[n].faceRanges;q.featureIds=b[n].featureIds;q.attributeData=d?d.attributeData:null;q.loadedAttributes=d?d.loadedAttributes:null;q.layerId=this.layer.id;r=new fa({name:D,geometries:C,materials:T,transformations:S,
castShadow:!0,metadata:q});t=H.create();H.identity(t);H.multiply(t,E.globalTrafo,t);r.setObjectTransformation(t);this._nodeId2Meta[a.id].engineObjectsPerBundle[k].push(r);this._nodeId2Meta[a.id].engineObjects.push(r);g[s.OBJECT][r.getId()]=r;this._setObjectSymbology(r);null!=this._clippingArea&&this._hideFaceRangesOutsideBoundingBox(a,this._clippingArea)}h.beginMod();a=g[s.OBJECT];for(var I in a)a.hasOwnProperty(I)&&m.addObject(a[I]);for(var x in g)if(g.hasOwnProperty(x))for(I in a=g[x],a)a.hasOwnProperty(I)&&
null==h.get(x,I)&&h.add(x,a[I]);h.endMod()}null!=e&&e.done()}},_visualizeNode:function(a){null!=this._controller.get("nodeIndex")[a]&&null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.show(this._controller.get("nodeIndex")[a],"green")},_clippingAreaChanged:function(){var a=[];J.extentToBoundingBox(this.view.clippingArea,a,this.view.renderSpatialReference)?this._clippingArea=a:this._clippingArea=null;var b=this._controller&&this._controller.nodeIndex;if(null!=b){var d=this;Object.keys(this._nodeId2Meta).forEach(function(a){d._hideFaceRangesOutsideBoundingBox(b[a],
d._clippingArea)})}},_hideFaceRangesOutsideBoundingBox:function(a,b){if(this._nodeId2Meta[a.id]&&null!=this._nodeId2Meta[a.id].engineObjects){var d=[0,0,0,0];J.mbsToMbs(a.mbs,this._controller.crsIndex,d,this.view.renderSpatialReference);d=null!=b?C.intersectBoundingBoxWithMbs(b,d):2;if(0===d)for(var c in this._nodeId2Meta[a.id].engineObjects)d=this._nodeId2Meta[a.id].engineObjects[c],d.hideAllFaceRanges();else for(c in 2===d&&(b=null),this._nodeId2Meta[a.id].engineObjects)if(d=this._nodeId2Meta[a.id].engineObjects[c],
d.unhideAllFaceRange(),null!=b){var e=d.getObjectTransformation(),f=d.getGeometryRecords()[0].transformation;H.multiply(e,f);if(!(0!==e[1]||0!==e[2]||0!==e[3]||0!==e[4]||0!==e[6]||0!==e[7]||0!==e[8]||0!==e[9]||0!==e[11]||1!==e[15])){for(var f=(b[0]-e[12])/e[0],k=(b[1]-e[13])/e[5],h=(b[2]-e[14])/e[10],g=(b[3]-e[12])/e[0],m=(b[4]-e[13])/e[5],e=(b[5]-e[14])/e[10],l=d.getGeometryRecords()[0].geometry.getData(),p=l.getFaces()[0].indices.position,l=l.getVertexAttr().position.data,n=[],q=d.getMetadata().faceRanges,
r,s,u,t,v,w,x=0;x<q.length;x+=1){var y=q[x],z=y[0],A=y[1];r=s=u=Number.MAX_VALUE;for(t=v=w=-Number.MAX_VALUE;z<=A;z+=1)for(var B=0;3>B;B+=1){var E=3*p[3*z+B],F=l[E+0],G=l[E+1],E=l[E+2];r=Math.min(F,r);s=Math.min(G,s);u=Math.min(E,u);t=Math.max(F,t);v=Math.max(G,v);w=Math.max(E,w)}(r>g||t<f||s>m||v<k||u>e||w<h)&&n.push(y)}0<n.length&&d.hideFaceRange(d.getGeometryRecords()[0],n)}}}},_hideFeatures:function(a,b){for(var d in this._nodeId2Meta[a.id].engineObjects){for(var c=this._nodeId2Meta[a.id].engineObjects[d],
e=[],f=c.getMetadata().features,k=c.getMetadata().faceRanges,h=0;h<b.length;h++)for(var g=b[h],m=0;m<f.length;m++)g===f[m].id&&(null!=k&&1==c.getGeometryRecords().length?e.push(k[m]):c.hideAllFaceRanges());0<e.length&&c.hideFaceRange(c.getGeometryRecords()[0],e)}},_removeFeatures:function(a,b){null!=this._nodeId2Meta[a.id]&&(this._hideFeatures(a,b),!0===this._isAllHidden(a)&&this._removeNodeDataFromStage(a))},_removeNodeDataFromStage:function(a){if(!(null==this._nodeId2Meta[a.id]||null==this._nodeId2Meta[a.id].engineObjects)){for(var b=
this._stage,d=this._engineLayer,c=0;c<this._nodeId2Meta[a.id].engineObjects.length;++c){var e=this._nodeId2Meta[a.id].engineObjects[c];d.removeObject(e);for(var f=e.getGeometryRecords(),k=0;k<f.length;k++){var h=f[k];this.memEstimateGeometryRemoved(h.geometry.getData());b.remove(s.GEOMETRY,h.geometry.getId());for(var g=0;g<h.materials.length;g++){var m=h.materials[g],l=m.getId(),p=m.metadata.i3sMatId,n=m.metadata.i3sTexId||"none",q=this._matId2Meta[p][n];v(0<q.refCount);q.refCount--;0===q.refCount&&
this._removeMaterial(l,n,p,m,b)}}b.remove(s.OBJECT,e.getId())}delete this._nodeId2Meta[a.id]}},_removeMaterial:function(a,b,d,c,e){e.remove(s.MATERIAL,a);if("none"!==b){a=this._texId2Meta[b];var f=a.usedByEngineMats;c=f.indexOf(c);v(-1<c);f[c]=f[f.length-1];f.pop();if(1>f.length){if((c=a.engineTex)&&c!==this._initTexture)this.memEstimateTextureRemoved(c),e.remove(s.TEXTURE,a.engineTex.getId());a.engineTex=void 0;a.desiredLOD=-1;a.curLOD=-1;delete this._texId2Meta[b]}}delete this._matId2Meta[d][b];
G(this._matId2Meta[d])&&delete this._matId2Meta[d]},_updateAllTextureLOD:function(){for(var a in this._texId2Meta)this._texId2Meta.hasOwnProperty(a)&&this._updateTextureLOD(this._texId2Meta[a])},_calcDesiredTextureLOD:function(a,b){var d=0,c;for(c in a)if(a.hasOwnProperty(c)){var e=a[c],e=2*e[3]/x.dist(e,this._controller.get("camPos"))*this._controller.get("screenSizeFactor");e>d&&(d=e)}d/=9;for(c=b.length-1;0<c&&b[c].size<d;)c--;return c},_updateTextureLOD:function(a){a.desiredLOD=this._calcDesiredTextureLOD(a.featureMBS,
a.images);if(a.curLOD!==a.desiredLOD&&(0>a.curLOD||!a.curLOD||0===a.desiredLOD||a.desiredLOD>a.curLOD||a.desiredLOD<a.curLOD-1)){if(0===a.images.length)return;var b=a.images[a.desiredLOD],d=-1<a.encodingIdx?b.hrefConcat[a.encodingIdx]:b.hrefConcat;if(!this._requestedTexImageIds[b.id]){var c={metadata:{texMeta:a,image:b}};this._requestedTexImageIds[b.id]=!0;this._imageIsPartOfTextureBundle(b)?this._controller.get("streamDataSupplier").request(d,"binary",c).then(this._extractTextureImageFromBlob,null,
this):this._controller.get("streamDataSupplier").request(d,"image",c).then(function(a,b,c,d){this._textureImageLoaded(a,b,d.image,d.texMeta)}.bind(this))}}a.engineTex||(a.engineTex=this._initTexture,a.curLOD=-1);if(this.debugLODVis){b=X.fromHsv(270*(a.desiredLOD/a.images.length),100,100);b=b.toRgb();b=b.map(function(a){return a/255});for(d=0;d<a.usedByEngineMats.length;d++)a.usedByEngineMats[d].setParameterValues({ambient:b,diffuse:b})}},_extractTextureImageFromBlob:function(a,b,d,c){var e=c.texMeta;
if(0>e.desiredLOD||c.image.size>e.images[e.desiredLOD].size)delete this._requestedTexImageIds[c.image.id];else{var f=this;v("binary"===d);var k;try{var h,g;-1<e.encodingIdx?(h=c.image.byteOffset[e.encodingIdx],g=c.image.length[e.encodingIdx]):(h=c.image.byteOffset,g=c.image.length);var m=new Uint8Array(b,h,g),l=new Blob([m],{type:e.encoding});k=window.URL.createObjectURL(l)}catch(p){k="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4T2P8zyD6n4ECwDhqAMNoGDCMhgEwDw2DdAAAdzkhQdS8dl8AAAAASUVORK5CYII\x3d",
console.error("error loading texture "+a+" "+p)}var n=new Image;n.onerror=function(){window.URL.revokeObjectURL(k);n.url="";n.onerror=void 0;n.onload=void 0};n.onload=function(){f._controller.queueAnimationFrameFunctionCall(f._textureImageLoaded,f,[a,n,c.image,c.texMeta,k],void 0,1);window.URL.revokeObjectURL(k);n.url="";n.onerror=void 0;n.onload=void 0};n.src=k}},_textureImageLoaded:function(a,b,d,c,e){delete this._requestedTexImageIds[d.id];if(!(0>c.desiredLOD)&&(a=c.images[c.desiredLOD],e=c.images[c.curLOD],
!this.isOverMemory()||!(null==e||d.size>e.size)))if(!e||d.size>e.size&&d.size<=a.size||d.size<e.size&&d.size>=a.size){if((e=c.engineTex)&&e!==this._initTexture)this.memEstimateTextureRemoved(e),this._stage.remove(s.TEXTURE,c.engineTex.getId());e=Q(b,c);c.engineTex=new B(b,c.id,e);this._stage.add(s.TEXTURE,c.engineTex);c.curLOD=c.desiredLOD;this.memEstimateTextureAdded(c.engineTex);b=c.engineTex.getId();for(e=0;e<c.usedByEngineMats.length;e++){var f=c.usedByEngineMats[e];null==this._colorOverride&&
f.setParameterValues({textureId:b});f.metadata.originalTextureId=b}d!==a&&(c.curLOD=c.images.indexOf(d),v(-1<c.curLOD),this._requestedTexImageIds[a.id]||(d={metadata:{texMeta:c,image:a}},this._requestedTexImageIds[a.id]=!0,this._controller.get("streamDataSupplier").request(a.hrefConcat,"binary",d).then(this._extractTextureImageFromBlob,null,this)))}},_imageIsPartOfTextureBundle:function(a){return!this._controller.get("isMeshPyramid")},_setPolygonOffset:function(a,b){var d,c,e;if(null!=this._nodeId2Meta[a.id]&&
null!=this._nodeId2Meta[a.id].engineObjectsPerBundle)for(d=0;d<this._nodeId2Meta[a.id].engineObjectsPerBundle.length;d++)for(c in this._nodeId2Meta[a.id].engineObjectsPerBundle[d]){e=this._nodeId2Meta[a.id].engineObjectsPerBundle[d][c];for(var f=0;f<e.getGeometryRecords().length;f++)for(var k=e.getGeometryRecords()[f],h=0;h<k.materials.length;h++)k.materials[h].setParameterValues({polygonOffset:b})}},_rendererChange:function(a){(this._currentRenderer=a)&&(a.colorInfo||a.sizeInfo)&&console.warn("renderer.colorInfo and renderer.sizeInfo are not supported for Scene Services. Use visualVariables instead.")},
_getRenderer:function(a){if(!a||a.symbol)return null;var b=this._rndForScale||this._currentRenderer;a&&(b&&b.getObservationRenderer)&&(b=b.getObservationRenderer(a));return b},_getSymbol:function(a){if(a.symbol)return a.symbol;var b=this._getRenderer(a);return b&&b.getSymbol(a)},_getRenderingInfo:function(a){var b=this._getRenderer(a),d=this._getSymbol(a);if(!d)return null;d={symbol:d};if(b&&b.visualVariables){a=b.getVisualVariableValues(a);for(b=0;b<a.length;b++){var c=a[b];"colorInfo"===c.variable.type&&
(d.color=c.value)}}d&&d.color&&(a=d.color,d.color=[a.r/255,a.g/255,a.b/255,a.a]);return d},_getSymbolFillColor:function(a){a=a.symbolLayers;for(var b=0;b<a.length;b++){var d=a[b];if("Fill"===d.type&&d.material&&d.material.color)return a=d.material.color,[a.r/255,a.g/255,a.b/255,a.a]}},_setObjectSymbology:function(a){for(var b=a.getMetadata(),d=[],c=b.graphics,e=!1,f=c.length,k=b.faceRanges?b.faceRanges.length:f,h={attributes:{}},g=0;g<k;g++){k===f&&null==b.attributeData?h=c[g]:Object.keys(b.attributeData).forEach(function(a){h.attributes[a]=
b.attributeData[a][g]});var m=this._getRenderingInfo(h),l=null!=b.faceRanges?b.faceRanges[g]:null;if(m){var p=m.color;null==p&&m.symbol&&(p=this._getSymbolFillColor(m.symbol));p&&1>p[3]&&(e=!0);d.push({faceRanges:l,color:p})}else d.push({faceRanges:l,color:void 0})}this.layer.cachedDrawingInfo.color?a.setFacerangeColors(d,"replace"):a.setFacerangeColors(d,"blend");a=a.getGeometryRecords();for(d=0;d<a.length;d++){c=a[d];for(f=0;f<c.materials.length;f++)k=c.materials[f],m=k.getParams().transparent,
l=k.getParams().opacity,k.metadata.symbolIsTransparent=e,p=this._calcEngineMaterialTransparencyParams(k.metadata.i3sTex,k.metadata.i3sMatParams,k.metadata.symbolIsTransparent),(m!=p.transparent||l!=p.opacity)&&k.setParameterValues({transparent:p.transparent,opacity:p.opacity})}},_opacityChange:function(a){for(var b in this._matId2Meta)for(var d in this._matId2Meta[b]){a=this._matId2Meta[b][d].engineMat;var c=a.getParams().transparent,e=a.getParams().opacity,f=this._calcEngineMaterialTransparencyParams(a.metadata.i3sTex,
a.metadata.i3sMatParams,a.metadata.symbolIsTransparent);(c!=f.transparent||e!=f.opacity)&&a.setParameterValues({transparent:f.transparent,opacity:f.opacity})}}})});