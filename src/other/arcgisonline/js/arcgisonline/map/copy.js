// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/copy",["dijit","dojo","dojox","dojo/require!arcgisonline/map/main"],function(l,e,m){e.provide("arcgisonline.map.copy");e.require("arcgisonline.map.main");arcgisonline.map.copy={copyLayer:function(a){if(a.layer instanceof esri.layers.VectorTileLayer)arcgisonline.map.vectorTile.copyLayer(a);else{var g=function(b){arcgisonline.map.main.hasDynamicLayers(b)?arcgisonline.map.main.getLayersInfo(b,e.hitch(this,function(){e.forEach(b.layer.dynamicLayerInfos,function(a,c){arcgisonline.map.popup.addPopupLayer(b,
a.id)},this)})):b.layer&&b.layer.layerInfos&&e.forEach(b.layer.layerInfos,function(a){arcgisonline.map.popup.addPopupLayer(b,a.id)},this);if(b.layer)arcgisonline.map.save_open.onLayerLoadHandler(b.layer);b.timeChanged&&(b.layer.setUseMapTime(b.useMapTime),delete b.useMapTime,arcgisonline.map.time.checkOnTimeButton());a.refreshIntervalChanged&&(b.layer.setRefreshInterval(b.refreshInterval),delete b.refreshInterval);arcgisonline.map.main.markMapAsChanged("copyLayer")},d=Math.floor(10001*Math.random()),
b={id:a.id+"_"+d,title:a.title+" - "+esri.i18nBundle.viewer.copy.copy,url:a.url,type:a.type,subType:a.subType,itemLayers:e.clone(a.itemLayers),thematicGroup:a.thematicGroup,popupInfo:e.clone(a.popupInfo),defaultOpacity:a.layer?a.layer.opacity:a.layers[0].opacity,defaultVisibility:a.layer?a.layer.visible:a.visibility,visibility:a.visibility,visibleLayers:a.visibleLayers,serviceInfo:a.layer&&a.layer.url&&"esri.layers.FeatureLayer"===a.layer.declaredClass?null:a.serviceInfo,layersInfo:a.layersInfo,queryLayersInfo:a.queryLayersInfo,
queryServiceUrl:a.queryServiceUrl,noQueryServiceUrl:a.noQueryServiceUrl,locationInfo:a.locationInfo,identify:a.identify,legendInfo:a.legendInfo,columnDelimiter:a.columnDelimiter,hadError:!1,proxyCheck:a.proxyCheck,featureCount:a.featureCount,editTrackingFilter:a.editTrackingFilter,isTrackingInfoLayer:a.isTrackingInfoLayer,minScale:a.minScale,maxScale:a.maxScale,showLegend:a.showLegend,copyright:a.copyright,fullExtent:a.fullExtent?esri.geometry.Extent(a.fullExtent):null,subDomains:a.subDomains,tileInfo:a.tileInfo,
tileServers:a.tileServers,popupChanged:a.popupChanged,rendererChanged:a.rendererChanged,scaleChanged:a.scaleChanged,legendChanged:a.legendChanged,featureTemplatesChanged:a.featureTemplatesChanged,defExpChanged:a.defExpChanged,spatialFilterChanged:a.spatialFilterChanged,refreshIntervalChanged:a.refreshIntervalChanged,visibleLayersChanged:a.visibleLayersChanged,timeChanged:a.timeChanged,showLabels:a.showLabels};a.itemId&&(b.oldItemCard=e.clone(a.itemCard),b.visibleLayers&&(b.visibleLayersChanged=!0));
a.layer&&(esri.isDefined(a.layer.refreshInterval)&&a.refreshIntervalChanged)&&(b.refreshInterval=a.layer.refreshInterval||0);a.layer instanceof esri.layers.ArcGISImageServiceLayer&&(a.layer.renderingRule&&a.renderingRuleChanged&&(b.renderingRule=a.layer.renderingRule.toJson()),a.layer.mosaicRule&&a.mosaicRuleChanged&&(b.mosaicRule=a.layer.mosaicRule.toJson()),a.layer.bandIds&&a.renderingRuleChanged&&(b.bandIds=a.layer.bandIds),a.layer.format&&a.imageQualityChanged&&(b.format=a.layer.format),a.layer.compressionQuality&&
a.imageQualityChanged&&(b.compressionQuality=a.layer.compressionQuality));if(a.layer instanceof esri.layers.FeatureLayer||a.layer instanceof esri.layers.ArcGISImageServiceLayer){a.layerDefinition&&(b.layerDefinition=e.clone(a.layerDefinition));a.defExpChanged?b.layerDefinition&&(b.layerDefinition.definitionExpression&&a.definitionEditor)&&(b.definitionEditor=e.clone(a.definitionEditor)):b.layerDefinition&&(delete b.layerDefinition.definitionExpression,esri.isEmpty(b.layerDefinition)&&delete b.layerDefinition);
a.rendererChanged?(b.layerDefinition=b.layerDefinition?e.clone(b.layerDefinition):{},b.layerDefinition.drawingInfo=b.layerDefinition.drawingInfo||{},b.layerDefinition.drawingInfo.renderer=a.layer.renderer.toJson(),a.layer.labelingInfo&&(b.layerDefinition.drawingInfo.labelingInfo=e.map(a.layer.labelingInfo,function(a){return a.toJson()}))):b.layerDefinition&&(delete b.layerDefinition.drawingInfo,esri.isEmpty(b.layerDefinition)&&delete b.layerDefinition);if((!a.spatialFilterChanged||!a.layer.getFilter()||
!a.layer.getFilter().geometry)&&b.layerDefinition)delete b.layerDefinition.definitionGeometry,esri.isEmpty(b.layerDefinition)&&delete b.layerDefinition;!a.maximumTrackPointsChanged&&b.layerDefinition&&(delete b.layerDefinition.maximumTrackPoints,esri.isEmpty(b.layerDefinition)&&delete b.layerDefinition);if(a.itemId&&(d=arcgisonline.map.itemData.itemDataContents[a.itemId]))!a.defaultBandIds&&d.bandIds&&(b.bandIds=d.bandIds),!a.renderingRuleChanged&&d.renderingRule&&(b.renderingRule=d.renderingRule),
!a.mosaicRuleChanged&&d.mosaicRule&&(b.mosaicRule=d.mosaicRule),a.imageQualityChanged||(d.format&&(b.format=d.format),d.compressionQuality&&(b.compressionQuality=d.compressionQuality))}if(a.scaleChanged)if(a.layer instanceof esri.layers.FeatureLayer){if(b.layerDefinition=b.layerDefinition||{},b.layerDefinition.minScale=a.layer.minScale?a.layer.minScale:0,b.layerDefinition.maxScale=a.layer.maxScale&&1!==a.layer.maxScale&&b.layerDefinition.minScale!==Number.POSITIVE_INFINITY?a.layer.maxScale:0,0===
b.layerDefinition.minScale&&0===b.layerDefinition.maxScale&&(delete b.layerDefinition.minScale,delete b.layerDefinition.maxScale,esri.isEmpty(b.layerDefinition)))if(!a.itemId||!a.origItemLayers)delete b.layerDefinition;else if(a.origItemLayers){for(var d=parseInt(a.layer.url.substring(a.layer.url.lastIndexOf("/")+1)),f=!1,h=0;h<a.origItemLayers.length;h++){var c=a.origItemLayers[h];if(c.id===d&&esri.isDefined(c.minScale)&&esri.isDefined(c.maxScale)){f=!0;b.layerDefinition.minScale=0;b.layerDefinition.maxScale=
0;break}}f||delete b.layerDefinition}}else if(a.layer instanceof esri.layers.WMSLayer){if(a.layer.minScale||a.layer.maxScale)b.minScale=a.layer.minScale,b.maxScale=a.layer.maxScale}else if(a.layer&&(b.minScale=a.layer.minScale?a.layer.minScale:0,b.maxScale=a.layer.maxScale&&1!==a.layer.maxScale?a.layer.maxScale:0,(!a.itemId||!a.origItemLayers)&&0===b.minScale&&0===b.maxScale))delete b.minScale,delete b.maxScale;a.layer instanceof esri.layers.GeoRSSLayer&&(d=a.layer.getFeatureLayers(),e.forEach(d,
function(a){"esri.renderer.SimpleRenderer"==a.renderer.declaredClass&&("esriGeometryPoint"===a.geometryType?b.pointSymbol=a.renderer.symbol.toJson():"esriGeometryPolyline"===a.geometryType?b.lineSymbol=a.renderer.symbol.toJson():"esriGeometryPolygon"===a.geometryType&&(b.polygonSymbol=a.renderer.symbol.toJson()))}));f=arcgisonline.map.layer.getLayerPosition(b);arcgisonline.map.main.mapLayers.splice(f.list,0,b);if(a.layer&&"esri.layers.WMSLayer"===a.layer.declaredClass)d=arcgisonline.map.wms.getResourceInfoFromLayer(a.layer),
arcgisonline.map.wms.createWMSLayer(b,f.map,b.visibleLayers,d,null,g);else if(a.layer&&"esri.layers.KMLLayer"===a.layer.declaredClass){var k=null;e.forEach(a.layer.folders,function(a){a.visible&&(k=k||[],k.push(a.id))},this);arcgisonline.map.kml.createKMLLayer(b,f.map,k,g)}else if(a.layer&&"esri.layers.WebTiledLayer"===a.layer.declaredClass)arcgisonline.map.webTile.createWebTiledLayer(b,f.map,g);else if(a.layer&&"esri.layers.GeoRSSLayer"===a.layer.declaredClass)arcgisonline.map.geoRSS.createGeoRSSLayer(b,
f.map,g);else if(a.layer&&"esri.layers.StreamLayer"===a.layer.declaredClass)arcgisonline.map.stream.createStreamLayer(b,f.map,g);else if(arcgisonline.map.featColl.isFeatureCollection(a))g=arcgisonline.map.featColl.buildFeatureCollectionJson(a),arcgisonline.map.featColl.addFeatureLayersfromCollection(b,g,f.map);else if(b.url&&!b.subType){if(a.origItemLayers){d=parseInt(a.layer.url.substring(a.layer.url.lastIndexOf("/")+1));for(h=0;h<a.origItemLayers.length;h++)if(c=a.origItemLayers[h],c.id===d){!b.popupChanged&&
c.popupInfo&&(b.popupInfo=c.popupInfo,b.popupChanged=!0);if(!b.rendererChanged&&c.layerDefinition&&c.layerDefinition.drawingInfo&&(c.layerDefinition.drawingInfo.renderer||c.layerDefinition.drawingInfo.labelingInfo))b.layerDefinition=b.layerDefinition||{},b.layerDefinition.drawingInfo=e.clone(c.layerDefinition.drawingInfo),b.rendererChanged=!0;!b.defExpChanged&&(c.layerDefinition&&c.layerDefinition.definitionExpression)&&(b.layerDefinition=b.layerDefinition||{},b.layerDefinition.definitionExpression=
c.layerDefinition.definitionExpression,b.defExpChanged=!0,c.definitionEditor&&(b.definitionEditor=c.definitionEditor));!b.spatialFilterChanged&&(c.layerDefinition&&c.layerDefinition.definitionGeometry)&&(b.layerDefinition=b.layerDefinition||{},b.layerDefinition.definitionGeometry=c.layerDefinition.definitionGeometry,b.spatialFilterChanged=!0);!b.scaleChanged&&(c.layerDefinition&&esri.isDefined(c.layerDefinition.minScale)&&esri.isDefined(c.layerDefinition.maxScale))&&(b.layerDefinition=b.layerDefinition||
{},b.layerDefinition.minScale=c.layerDefinition.minScale,b.layerDefinition.maxScale=c.layerDefinition.maxScale,b.scaleChanged=!0);!b.maximumTrackPointsChanged&&(c.layerDefinition&&c.layerDefinition.maximumTrackPoints)&&(b.layerDefinition=b.layerDefinition||{},b.layerDefinition.maximumTrackPoints=c.layerDefinition.maximumTrackPoints,b.maximumTrackPointsChanged=!0);b.legendChanged||(!1===c.showLegend?b.showLegend=!1:delete b.showLegend,b.legendChanged=!0);!b.refreshIntervalChanged&&esri.isDefined(c.refreshInterval)&&
(b.refreshInterval=c.refreshInterval,b.refreshIntervalChanged=!0);break}}!b.timeChanged&&(a.layer.timeInfo&&!a.layer.timeInfo.hasLiveData)&&(b.useMapTime=a.layer.useMapTime,b.timeChanged=!0);arcgisonline.map.layer.addLayer(b,f.map,g)}}}}});