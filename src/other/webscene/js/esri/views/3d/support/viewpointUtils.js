// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../../../geometry/SpatialReference ../../../geometry/Geometry ../../../geometry/Point ../../../geometry/Extent ../../../geometry/support/webMercatorUtils ../../../Camera ../../../Viewpoint ../../../Graphic ../lib/glMatrix ./mathUtils ./projectionUtils ./cameraUtils".split(" "),function(t,H,n,I,C,x,D,J,K,y,q,g){function w(d){return 360-y.cyclicalDeg.normalize(d)}function u(d){return y.cyclicalDeg.normalize(360-d)}function E(d,a,c){var b;if(a.camera)return b=a.camera.clone(),null!=c&&(b.tilt=
c),a.camera;var e=d.map.spatialReference||t.WGS84,v=d.navigation.currentCamera,f=g.internalToExternal(d,v);b=!1;null!=a.rotation&&(f.heading=w(a.rotation),b=!0);null!=c&&(f.tilt=c);if(a.targetGeometry instanceof n){var k=a.targetGeometry,f;c=a.targetGeometry.clone();a=null!=a.scale?g.scaleToDistance(d,a.scale,k.latitude):v.distance;b=g.eyeHeadingTiltForCenterPointAtDistance(d,f.heading,f.tilt,c,a,{noReset:b});d=q.vectorToPoint(b.eye,d.renderSpatialReference,e);return new x(d,b.heading,b.tilt,f.fov)}return g.fromExtent(d,
a.targetGeometry.extent,f,{noReset:b})}function s(d,a,c){if(null!=d[a])return d[a];if(null!=c)return"function"===typeof c?c():c}function z(d,a,c){return s(a,"scale",function(){var b=s(a,"zoom",function(){if(null!=c)return"function"===typeof c&&(c=c()),{scale:c}});if(null!=b)return null!=b.scale?b.scale:g.zoomToScale(d,b)})}function L(d,a,c){return s(a,"heading",function(){var b=s(a,"rotation",function(){if(null!=c)return"function"===typeof c&&(c=c()),{heading:c}});if(null!=b)return null!=b.heading?
b.heading:w(b)})}function F(d,a,c,b,e){if(!(a&&c.position||a&&c.direction||c.position&&c.direction))return!1;var v=d.map.spatialReference||t.WGS84,f=d.renderSpatialReference,k=c.direction;a&&c.position&&(k=null);c.position&&q.pointToVector(c.position,h,f);a&&q.pointToVector(a,p,f);if(k){var r=new n(c.position||a);r.x+=k[0];r.y+=k[1];2<k.length&&(r.z+=k[2]);q.pointToVector(r,l,f);m.subtract(l,c.position?h:p)}c.position&&k?(e.camera.position=new n(c.position),g.directionToHeadingTilt(d,h,l,b.up,e.camera),
m.add(h,l,p),d.navigation.getCenterIntersectTerrain(h,p,p),e.targetGeometry=q.vectorToPoint(p,f,v),e.scale=g.distanceToScale(d,m.dist(h,p),e.targetGeometry.latitude)):a&&k?(e.targetGeometry=new n(a),e.scale=z(d,c,function(){return g.computeScale(d,b)}),a=g.scaleToDistance(d,e.scale,a.latitude),m.scale(l,a/m.length(l),h),m.add(h,p),e.camera.position=q.vectorToPoint(h,f,v),g.directionToHeadingTilt(d,h,l,b.up,e.camera)):(e.targetGeometry=new n(a),e.camera.position=new n(c.position),m.subtract(p,h,l),
g.directionToHeadingTilt(d,h,l,b.up,e.camera),e.scale=g.distanceToScale(d,m.dist(h,p),e.targetGeometry.latitude));e.rotation=u(e.camera.heading);return!0}function G(d,a){var c=d.map.spatialReference||t.WGS84,b=g.externalToInternal(d,a.camera);a.targetGeometry=q.vectorToPoint(b.center,d.renderSpatialReference,c);a.scale=g.computeScale(d,b);a.rotation=u(a.camera.heading);return a}function A(d,a,c,b){var e;if(Array.isArray(a)&&2===a.length&&"number"===typeof a[0]&&"number"===typeof a[1])e=new n(a[0],
a[1],t.WGS84);else{if(a.forEach){var g=!1;a.forEach(function(a){g||(b=A(d,a,c,b),b||(b=null,g=!0))});return b}if(Array.isArray(a)){for(e=0;e<a.length;e++)if(b=A(d,a[e],c,b),!b)return null;return b}a instanceof H?e=a:a instanceof J&&a.geometry&&(e=a.geometry)}if(!e)return null;a=e instanceof n?new I({xmin:e.x,ymin:e.y,zmin:e.z,xmax:e.x,ymax:e.y,zmax:e.z,spatialReference:e.spatialReference}):e.extent;if(!a||!C.canProject(a.spatialReference,c))return null;a=C.project(a,c);return b=b?b.union(a):a.clone()}
var m=K.vec3d,h=m.create(),p=m.create(),l=m.create(),B={heading:0,tilt:0};return{create:function(d,a,c){c=a;if(!a)return null;null==a.declaredClass&&(a.target?a=a.target:a.center&&(a=a.center));if(a instanceof D){var b;b=a.clone();null!=c.heading?b.rotation=u(c.heading):null!=c.rotation&&(b.rotation=c.rotation);var e=z(d,c);null!=e&&(b.scale=e);b.camera=E(d,b,c.tilt);return b}b=new D({targetGeometry:void 0,scale:void 0,rotation:void 0,camera:new x({position:void 0,heading:void 0,tilt:void 0,fov:y.rad2deg(d.navigation.currentCamera.fov)})});
var h=d.map.spatialReference||t.WGS84,f=A(d,a,h);if(f)if(f.xmin===f.xmax&&f.ymin===f.ymax&&f.zmin===f.zmax){if(b.targetGeometry=new n(f.xmin,f.ymin,f.zmin,f.spatialReference),f=null,e=d.navigation.getCameraIntersectTerrain(),F(d,b.targetGeometry,c,e,b))return b}else b.targetGeometry=f;else{if(a instanceof x)return b.camera=a.clone(),G(d,b);e=d.navigation.getCameraIntersectTerrain();if(F(d,null,c,e,b))return b;if(c.position)return e.computeDirection(l),g.directionToHeadingTilt(d,e.eye,l,e.up,B),b.camera.position=
new n(c.position),b.camera.heading=L(d,c,B.heading),b.camera.tilt=s(c,"tilt",B.tilt),b.camera.fov=s(c,"fov",b.camera.fov),G(d,b);b.targetGeometry=q.vectorToPoint(e.center,d.renderSpatialReference,h)}a=!1;e||(e=d.navigation.getCameraIntersectTerrain());g.internalToExternal(d,e,b.camera);var h=b.camera,k=!1;null!=c.heading?(h.heading=c.heading,k=!0):null!=c.rotation&&(h.heading=w(c.rotation),k=!0);null!=c.tilt&&(h.tilt=c.tilt,k=!0);null!=c.fov&&(h.fov=c.fov);k&&(a=!0);b.scale=z(d,c);if(f)if(c=f.center,
null!=b.scale)g.fromCenterScale(d,c,b.scale,b.camera,{noReset:a},b.camera);else{if(!g.fromExtent(d,f,b.camera,{noReset:a},b.camera))return null;b.scale=g.computeScale(d,b.camera,c)}else if(null==b.scale&&(b.scale=g.computeScale(d,e)),!g.fromCenterScale(d,b.targetGeometry,b.scale,b.camera,{noReset:a},b.camera))return null;b.rotation=u(b.camera.heading);return b},rotationToHeading:w,headingToRotation:u,toCamera:E}});