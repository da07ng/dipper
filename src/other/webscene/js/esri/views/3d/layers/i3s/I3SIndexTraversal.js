// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define(["./I3SUtil","../../support/PromiseLightweight","../../webgl-engine/lib/es6-shim","../../lib/glMatrix","./GoogPriorityQueue"],function(h,J,X,K,L){var M=!1;return function(N,O,x,m,n,P,p,E,Q,F,R,C,S){function T(){k.done()}function y(b,a,c,d){q++;n[a]?(c(b,n[a]),q--):P.request(b,"json").then(function(a,b){n[b.id]=b;c(a,b);q--},function(a){null!=d&&d(a);console.log("Error loading "+a);l===a&&R("Error loading root node "+a,1);q--},this)}function G(b,a){if(z)k.done();else if(this.nodeTraversalState(a.id),
this.enqueueConnected(b,a),null==a.children)k.done();else{for(var c=1E9,d,D=0;D<a.children.length;++D){var f=a.children[D];if(this.nodeIsVisible(f)&&(!H(a)||!I(a))){var g=r(f,m);g<c&&(c=g,d=f)}}d?(c=h.concatUrl(b,d.href),C&&(c=h.addTrailingSlash(c)),y(c,d.id,G.bind(this),T)):k.done()}}function A(b,a){b.hrefConcat=h.concatUrl(a,b.href);C&&(b.hrefConcat=h.addTrailingSlash(b.hrefConcat))}function s(b,a,c){t.perLevelTraversal||(c=0);for(u.add(a.id);e.length<=c;)e.push(new U.structs.PriorityQueue),v.push(0);
e[c].enqueue(b,a);M&&F&&F.show(a,"brown")}var u=new Set,U=L.goog,e=[],w=!1,z=!1,V=p.isNodeVisible,I=p.isTooHighLOD,W=p.isChosenLod,H=p.hasLOD,r=p.distToPOI;K.vec3d.create();var q=0,v=[],k,l,B=0,t=S||{initDepthFirst:!0,neighborhood:!0,perLevelTraversal:!1};this.start=function(){this._nodeTraversalState={};this._nodeIsVisibleCached={};v=[];B=0;l=h.concatUrl(N,O);C&&(l=h.addTrailingSlash(l));t.initDepthFirst?(k=new J.Promise,y(l,x,G.bind(this)),k.then(function(){z||(w=!0)})):(s(0,{id:x,hrefConcat:l},
0),w=!0)};this.continueTraversal=function(b){if(w){b=null==b?5:b;for(var a=this,c=0;c<e.length;c++)if(!(t.perLevelTraversal&&B!=c)){for(var d=e[c];0<b--&&!d.isEmpty();)(function(b){var c=d.dequeue();v[b]++;var g=function(){v[b]--};y(c.hrefConcat,c.id,function(c,d){null==d.parentNode?(a.nodeTraversalState(d.id),a.enqueueConnected(c,d,void 0,b),E(d,void 0).then(g,g)):(A(d.parentNode,c),y(d.parentNode.hrefConcat,d.parentNode.id,function(f,e){a.nodeTraversalState(d.id);a.enqueueConnected(c,d,e,b);E(d,
e).then(g,g)}))},g)})(c);t.perLevelTraversal&&(d.isEmpty()&&0===v[c])&&(Q(B),B++)}}};this.isQueueTraversalEnabled=function(){return w};this.getQueueSize=function(){for(var b=0,a=0;a<e.length;a++)b+=e[a].getCount();return b};this.cancel=function(){w=!1;for(var b=0;b<e.length;b++)e[b].clear();z=!0};this.isLoading=function(){return 0<q||0<this.getQueueSize()};this.nodeIsVisible=function(b){if(null!=this._nodeIsVisibleCached[b.id])return this._nodeIsVisibleCached[b.id];this._nodeIsVisibleCached[b.id]=
V(b);return this._nodeIsVisibleCached[b.id]};this.nodeTraversalState=function(b){if(null!=this._nodeTraversalState[b])return this._nodeTraversalState[b];var a=n[b];if(null==a)return null;var c=null,d=null;if(null!=a.parentNode){c=n[a.parentNode.id];if(null==c)return null;var e=this._nodeTraversalState[c.id];null!=e&&(d=e.nodeIsTooHighLOD)}var e=H(a),f=I(a),c=W(a,c,f,d);this._nodeTraversalState[a.id]={visited:!0,nodeHasLOD:e,nodeIsTooHighLOD:f,isChosenLod:c};return this._nodeTraversalState[b]};this.enqueueConnected=
function(b,a,c,d){if(!z&&null!=a){var e=this.nodeTraversalState(a.id);a.id!==x&&null!=a.parentNode&&!u.has(a.parentNode.id)?(A(a.parentNode,b),s(r(a.parentNode,m),a.parentNode,d-1)):a.id===x&&(!u.has(a.id)&&this.nodeIsVisible(a))&&(a.hrefConcat=b,s(r(a,m),a,d));for(var f in a.children){c=a.children[f];var g=this.nodeIsVisible(c);if(!u.has(c.id)&&(!e.nodeHasLOD||!e.nodeIsTooHighLOD)&&g)A(c,b),s(r(c,m),c,d+1)}if(t.neighborhood)for(var h in a.neighbors)c=a.neighbors[h],f=this.nodeIsVisible(c),!u.has(c.id)&&
f&&(A(c,b),s(r(c,m),c,d))}}}});