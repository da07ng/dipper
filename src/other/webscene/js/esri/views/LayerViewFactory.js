// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("dojo/_base/lang dojo/Deferred dojo/when ../core/Accessor ../core/Scheduler ../core/Collection".split(" "),function(p,s,t,h,u,q){return h.createSubclass({declaredClass:"esri.views.LayerViewFactory",classMetadata:{properties:{working:{}}},constructor:function(d){var g=new q,k=new q,e={},c=null,m=d.watch("ready",function(a){a?l():r()});this.create=function(a){var b;e[a.id]?b=e[a.id]:(e[a.id]=b=new s,k.addItem({dfd:b,layer:a}));d.ready&&l();return b.promise};this.dispose=function(a){d.ready?(g.addItem(a),
l()):n(a)};this.destroy=function(){r();m&&(m.remove(),m=null)};var h=function(){c=null;k.drain(function(a){var b=a.dfd,f=a.layer;(a=g.find(function(a){return f===a.layer}))?(g.removeItem(a),delete e[f.id],b.resolve(a)):f.createLayerView(d).then(p.partial(function(a,b){t(b,function(c){delete e[f.id];c.layerView&&(b=c.layerView);f.emit("layer-view-create",{view:d,layerView:b});d.emit("layer-view-create",{layer:f,layerView:b});a.resolve(b)},function(b){delete e[f.id];a.reject(b)})},b),p.partial(function(a,
b){delete e[f.id];a.reject(b)},b))});g.drain(n);this.working=!1}.bind(this),l=function(){c||(this.working=!0,c=u.schedule(h))}.bind(this),r=function(){c&&(c.remove(),c=null);g.drain(n);k.drain(function(a){a.dfd.reject()});this.working=!1}.bind(this),n=function(a){var b=a.layer;delete e[b.id];b.destroyLayerView(d,a);d.emit("layer-view-destroy",{layer:b,layerView:a})}.bind(this)},working:!1})});