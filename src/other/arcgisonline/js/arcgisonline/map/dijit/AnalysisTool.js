// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/dijit/AnalysisTool",["dijit","dojo","dojox","dojo/require!dijit/_Widget,dijit/_Templated,dijit/layout/BorderContainer,dijit/layout/ContentPane,esri/dijit/analysis/AggregatePoints,esri/dijit/analysis/FindHotSpots,esri/dijit/analysis/OverlayLayers,esri/dijit/analysis/CreateBuffers,esri/dijit/analysis/SummarizeWithin,esri/dijit/analysis/SummarizeNearby,esri/dijit/analysis/EnrichLayer,esri/dijit/analysis/CreateDriveTimeAreas,esri/dijit/analysis/ConnectOriginsToDestinations,esri/dijit/analysis/PlanRoutes,esri/dijit/analysis/DissolveBoundaries,esri/dijit/analysis/ExtractData,esri/dijit/analysis/FindNearest,esri/dijit/analysis/MergeLayers,esri/dijit/analysis/FindExistingLocations,esri/dijit/analysis/DeriveNewLocations,esri/dijit/analysis/FindSimilarLocations,esri/dijit/analysis/InterpolatePoints,esri/dijit/analysis/CalculateDensity,esri/dijit/analysis/TraceDownstream,esri/dijit/analysis/CreateWatersheds,esri/dijit/analysis/CreateViewshed,esri/dijit/analysis/utils,dojo/topic"],
function(f,b,l){b.provide("arcgisonline.map.dijit.AnalysisTool");b.require("dijit._Widget");b.require("dijit._Templated");b.require("dijit.layout.BorderContainer");b.require("dijit.layout.ContentPane");b.require("esri.dijit.analysis.AggregatePoints");b.require("esri.dijit.analysis.FindHotSpots");b.require("esri.dijit.analysis.OverlayLayers");b.require("esri.dijit.analysis.CreateBuffers");b.require("esri.dijit.analysis.SummarizeWithin");b.require("esri.dijit.analysis.SummarizeNearby");b.require("esri.dijit.analysis.EnrichLayer");
b.require("esri.dijit.analysis.CreateDriveTimeAreas");b.require("esri.dijit.analysis.ConnectOriginsToDestinations");b.require("esri.dijit.analysis.PlanRoutes");b.require("esri.dijit.analysis.DissolveBoundaries");b.require("esri.dijit.analysis.ExtractData");b.require("esri.dijit.analysis.FindNearest");b.require("esri.dijit.analysis.MergeLayers");b.require("esri.dijit.analysis.FindExistingLocations");b.require("esri.dijit.analysis.DeriveNewLocations");b.require("esri.dijit.analysis.FindSimilarLocations");
b.require("esri.dijit.analysis.InterpolatePoints");b.require("esri.dijit.analysis.CalculateDensity");b.require("esri.dijit.analysis.TraceDownstream");b.require("esri.dijit.analysis.CreateWatersheds");b.require("esri.dijit.analysis.CreateViewshed");b.require("esri.dijit.analysis.utils");b.require("dojo.topic");b.declare("arcgisonline.map.dijit.AnalysisTool",[f._Widget,f._Templated],{widgetsInTemplate:!0,templateString:'\x3cdiv dojoType\x3d"dijit.layout.BorderContainer" region\x3d"top"\x3e\r\n    \x3cdiv dojoAttachPoint\x3d"aggregateToolContentPane" dojoType\x3d"dijit.layout.ContentPane" region\x3d"center" class\x3d"panel panel_left panel_analysis" style\x3d"padding: 0 5px 0 5px;overflow-x:hidden;overflow-y:auto;"\x3e\r\n      \x3cdiv dojoAttachPoint\x3d"toolCtr" style\x3d"width:100%;height:90%"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv dojoAttachPoint\x3d"aggrFooterPane" dojoType\x3d"dijit.layout.ContentPane" region\x3d"bottom" style\x3d"height:40px; padding: 0 5px 0 5px;"\x3e\r\n      \x3cdiv class\x3d"footer" id \x3d"aggrfooter" dojoAttachPoint\x3d"aggrfooter" dojoType\x3d"arcgisonline.sharing.dijit.SiteFooterMap" style\x3d"white-space:normal;"\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n\x3c/div\x3e\r\n',
featureLayers:null,i18n:null,currentTool:null,topic:b.topic,utils:esri.dijit.analysis.utils,shareUtil:arcgisonline.sharing.util,constructor:function(a,b){a=a||{};this.container=a.containerNode;this.featureLayers=a.featureLayers;this._pbConnects=[];this._drawnPredictPtlayerCount=this._drawnInputPtlayerCount=this._drawnPtlayerCount=this._drawnBlayerCount=0},destroy:function(){this.inherited(arguments);b.forEach(this._pbConnects,b.disconnect);delete this._pbConnects},postMixInProperties:function(){this.inherited(arguments);
this.i18n=b.i18n.getLocalization("arcgisonline","arcgisonline").common;b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").tocPanel);b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").analysisTool)},postCreate:function(){this.container.addChild(f.byId(this.id))},startup:function(){this.inherited(arguments);this._init()},save:function(){console.log("saving")},_onClose:function(a){this.aggregateToolContentPane.scrollTop=0;a&&a.save&&this.save();this.currentTool&&
this.currentTool.domNode&&esri.hide(this.currentTool.domNode);a&&a.save?(arcgisonline.map.leftPanel.openLeftTOCPanel(),this._saveFolders()):(b.map(this.featureLayers,function(a){return{layer:a}}),a={showSelectedCategory:!0},this.analysisType&&(a.analysisType=this.analysisType),this.topic.publish("Analysis/ShowAnalysis",a))},clear:function(a){"block"===b.style(a.domNode,"display")&&-1!==b.indexOf("PlanRoutes FindHotSpots FindSimilarLocations ExtractData CalculateDensity InterpolatePoints TraceDownstream CreateViewshed CreateWaterSheds".split(" "),
a.toolName)&&(a.clear(),esri.hide(a.domNode));b.query(".esriAnalyisHelpWindow").forEach(function(a){f.popup.close(f.byNode(a))});this._saveFolders()},_init:function(){this._connect(f.byId("leftContentPanel"),"resize",b.hitch(this,"adjustHeight"));this.adjustHeight()},_saveFolders:function(){this.currentTool.folderStore&&(arcgisonline.map.main.analysisProps.folderStore=this.currentTool.folderStore,arcgisonline.map.main.analysisProps.selectedFolder=this.currentTool.get("folderId"))},_loadConnections:function(){this.currentTool.on("close",
b.hitch(this,this._onClose));this.currentTool.on("start",b.hitch(this,function(a){var c={},c=b.mixin({},a);c.tool=this.currentTool;if(this.currentTool.map){a=this.currentTool.get("drawLayer");var d=[];a instanceof Array?d=a:d.push(a);b.forEach(d,function(a,b){this._addLayertoMapLayer({layer:a})},this)}this.topic.publish("Analysis/OnExecute",c)}));this.currentTool.on("add-ready-to-use-layer",b.hitch(this,function(a){this._addLayertoMapLayer(a)}));this.currentTool.on("job-submit",b.hitch(this,function(a){this.topic.publish("Analysis/OnJobSubmit",
a)}));this.currentTool.on("job-status",b.hitch(this,function(a){this.topic.publish("Analysis/OnJobStatus",a)}));this.currentTool.on("job-result",b.hitch(this,function(a){this.topic.publish("Analysis/OnJobResult",a)}));this.currentTool.on("job-success",b.hitch(this,function(a){this.topic.publish("Analysis/OnJobSuccess",a)}));this.currentTool.on("job-fail",b.hitch(this,function(a){this._handleJobError(a);this.topic.publish("Analysis/OnJobFailed",a)}));this.currentTool.on("job-cancel",b.hitch(this,function(a){this.topic.publish("Analysis/OnJobSuccess",
a)}))},_addLayertoMapLayer:function(a){var c;a.layer&&(c={layer:a.layer,url:a.layer.url,id:a.layer.id,type:"user",title:a.layer.name,defaultVisibility:!0,defaultOpacity:1,snippet:"",showLegend:!0,identify:!1},a.layerInfo&&(c.serviceInfo=a.layerInfo),a.item&&(c.itemId=a.item.itemId,c.title=a.item.title),a=arcgisonline.map.layer.getLayerPosition(c),arcgisonline.map.main.mapLayers.splice(a.list,0,c),a=a.map,arcgisonline.map.main.map.removeLayer(c.layer),arcgisonline.map.main.map.addLayer(c.layer,a,function(){b.publish("onLayerUpdate",
[""])}))},_connect:function(a,c,d){this._pbConnects.push(b.connect(a,c,d))},adjustHeight:function(a){a=b.coords(b.byId("leftPanelDiv")).h;var c=b.coords(b.byId("aggrfooter_links")).h+10;b.style(this.aggrFooterPane.domNode,"height",c+"px");b.style(this.aggregateToolContentPane.domNode,"height",a-c+"px")},getGpServer:function(){var a="";return a=esriGeowConfig.isAnalysisDebugServer?esriGeowConfig.analysisDebugServerUrl:esriGeowConfig.self.helperServices.analysis&&esriGeowConfig.self.helperServices.analysis.url?
esriGeowConfig.self.helperServices.analysis.url:null},_getCurrentToolAttr:function(){return this.currentTool},isValidAnalysisLayer:function(a){a.showReadyToUseLayers=!this.shareUtil.isPortal();var b=this.utils.isValidAnalysisLayer(a),d=b.isValid,b=b.validationMessage;d?a.infoMsg&&arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.infoTitle,message:a.infoMsg}):(arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.validationError,
message:b}),this._onClose());return d},_setCurrentToolAttr:function(a){var c="english"===arcgisonline.map.main.scaleBarUnits;this.toolName=a.toolName;this.featureLayers=a.featureLayers;this.analysisLayer=a.analysisLayer;this.analysisGpServer=this.getGpServer();a.analysisType&&(this.analysisType=a.analysisType);var d=b.filter(this.featureLayers,function(a){return"esriGeometryPolygon"===a.geometryType}),e=b.filter(this.featureLayers,function(a){return"esriGeometryPoint"===a.geometryType||"esriGeometryMultipoint"===
a.geometryType}),f=b.filter(this.featureLayers,function(a){return"esriGeometryPolyline"===a.geometryType}),k=this.shareUtil.isPortal(),g=b.map(this.featureLayers,function(a){return a}),h=b.map(this.featureLayers,function(a){return a});if(!(a&&a.analysisLayer&&!k||k)||this.isValidAnalysisLayer(a))a={showSelectAnalysisLayer:!0},a.helperServices=esriGeowConfig.self.helperServices,a.portalSelf=esriGeowConfig.self,this.analysisGpServer?a.analysisGpServer=this.analysisGpServer:a.portalUrl=(esriGeowConfig.self.allSSL?
"https:":"http:")+"//"+esriGeowConfig.self.portalHostname,esriGeowConfig.isAnalysisDebugServer&&(a._isDebug=!0),arcgisonline.map.main.analysisProps.folderStore&&(a.folderStore=arcgisonline.map.main.analysisProps.folderStore),esri.isDefined(arcgisonline.map.main.analysisProps.selectedFolder)&&(a.folderId=arcgisonline.map.main.analysisProps.selectedFolder),a.showSelectFolder=!0,a.showCredits=!k,a.isSingleTenant=k,a.showReadyToUseLayers=!k,a.map=arcgisonline.map.main.map,"AggregatePoints"===this.toolName?
(b.mixin(a,{pointLayer:this.analysisLayer,polygonLayers:d,pointLayers:e}),this.currentTool=new esri.dijit.analysis.AggregatePoints(a,b.create("div",{style:{width:"100%"}},this.toolCtr))):"FindHotSpots"===this.toolName?(b.forEach(arcgisonline.map.main.mapLayers,function(a){a.layer&&(a.layer.name&&-1!==a.layer.name.indexOf(this.i18n.blayerName))&&(-1!==a.layer.name.indexOf("_")&&(a=a.layer.name.split("_"),this._drawnBlayerCount=parseInt(a[1],10)),this._drawnBlayerCount++)},this),b.mixin(a,{analysisLayer:this.analysisLayer,
boundingPolygonLayers:d,aggregationPolygonLayers:d,enableEnrichmentFields:arcgisonline.map.dijit.toc.analysis.canPerformGeoEnrichment(),allowChooseLabel:!1,analysisLayers:[].concat(e).concat(d)}),this.currentTool=new esri.dijit.analysis.FindHotSpots(a,b.create("div",{style:{width:"100%"}},this.toolCtr)),0<this._drawnBlayerCount&&this.currentTool.set("drawLayerName",this.i18n.blayerName+"_"+this._drawnBlayerCount),this.currentTool.on("drawtool-activate",function(){arcgisonline.map.edit.analysisDrawActivated=
!0;arcgisonline.map.popup.disablePopupHandler()}),this.currentTool.on("drawtool-deactivate",function(){arcgisonline.map.edit.analysisDrawActivated=!1;arcgisonline.map.popup.setupPopupHandler()})):"InterpolatePoints"===this.toolName?(b.forEach(arcgisonline.map.main.mapLayers,function(a){if(a.layer&&a.layer.name&&-1!==a.layer.name.indexOf(this.i18n.blayerName)){if(-1!==a.layer.name.indexOf("_")){var b=a.layer.name.split("_");this._drawnBlayerCount=parseInt(b[1],10)}this._drawnBlayerCount++}a.layer&&
(a.layer.name&&-1!==a.layer.name.indexOf(this.i18n.predictPointlayerName))&&(-1!==a.layer.name.indexOf("_")&&(b=a.layer.name.split("_"),this._drawnPredictPtlayerCount=parseInt(b[1],10)),this._drawnPredictPtlayerCount++)},this),b.mixin(a,{inputLayer:this.analysisLayer,boundingPolygonLayers:d,predictAtPointLayers:e,inputLayers:e}),this.currentTool=new esri.dijit.analysis.InterpolatePoints(a,b.create("div",{style:{width:"100%"}},this.toolCtr)),0<this._drawnBlayerCount&&this.currentTool.set("drawLayerName",
this.i18n.blayerName+"_"+this._drawnBlayerCount),0<this._drawnPredictPtlayerCount&&this.currentTool.set("drawPointLayerName",this.i18n.predictPointlayerName+"_"+this._drawnPredictPtlayerCount),this.currentTool.on("drawtool-activate",function(){arcgisonline.map.edit.analysisDrawActivated=!0;arcgisonline.map.popup.disablePopupHandler()}),this.currentTool.on("drawtool-deactivate",function(){arcgisonline.map.edit.analysisDrawActivated=!1;arcgisonline.map.popup.setupPopupHandler()})):"CalculateDensity"===
this.toolName?(b.forEach(arcgisonline.map.main.mapLayers,function(a){if(a.layer&&a.layer.name&&-1!==a.layer.name.indexOf(this.i18n.blayerName)){if(-1!==a.layer.name.indexOf("_")){var b=a.layer.name.split("_");this._drawnBlayerCount=parseInt(b[1],10)}this._drawnBlayerCount++}a.layer&&(a.layer.name&&-1!==a.layer.name.indexOf(this.i18n.ptlayerName))&&(-1!==a.layer.name.indexOf("_")&&(b=a.layer.name.split("_"),this._drawnPtlayerCount=parseInt(b[1],10)),this._drawnPtlayerCount++)},this),b.mixin(a,{inputLayer:this.analysisLayer,
boundingPolygonLayers:d,radiusUnits:c?"Miles":"Kilometers",areaUnits:c?"SquareMiles":"SquareKilometers",inputLayers:[].concat(e).concat(f)}),this.currentTool=new esri.dijit.analysis.CalculateDensity(a,b.create("div",{style:{width:"100%"}},this.toolCtr)),0<this._drawnBlayerCount&&this.currentTool.set("drawLayerName",this.i18n.blayerName+"_"+this._drawnBlayerCount),0<this._drawnPtlayerCount&&this.currentTool.set("drawPointLayerName",this.i18n.ptlayerName+"_"+this._drawnPtlayerCount),this.currentTool.on("drawtool-activate",
function(){arcgisonline.map.edit.analysisDrawActivated=!0;arcgisonline.map.popup.disablePopupHandler()}),this.currentTool.on("drawtool-deactivate",function(){arcgisonline.map.edit.analysisDrawActivated=!1;arcgisonline.map.popup.setupPopupHandler()})):"OverlayLayers"===this.toolName?(b.mixin(a,{inputLayer:this.analysisLayer,inputLayers:g,overlayLayer:h}),this.currentTool=new esri.dijit.analysis.OverlayLayers(a,b.create("div",{style:{width:"100%"}},this.toolCtr))):"CreateBuffers"===this.toolName?(b.mixin(a,
{inputLayer:this.analysisLayer,inputLayers:this.featureLayers,units:c?"Miles":"Kilometers"}),this.currentTool=new esri.dijit.analysis.CreateBuffers(a,b.create("div",{style:{width:"100%"}},this.toolCtr))):"SummarizeWithin"===this.toolName?(b.mixin(a,{sumWithinLayer:this.analysisLayer,sumWithinLayers:d,summaryLayers:this.featureLayers,shapeUnits:c?"Miles":"Kilometers"}),this.currentTool=new esri.dijit.analysis.SummarizeWithin(a,b.create("div",{style:{width:"100%"}},this.toolCtr))):"SummarizeNearby"===
this.toolName?(b.mixin(a,{sumNearbyLayer:this.analysisLayer,sumNearbyLayers:g,summaryLayers:h,units:c?"Miles":"Kilometers",enableTravelModes:arcgisonline.map.dijit.toc.analysis.canPerformDriveAnalysis()}),this.currentTool=new esri.dijit.analysis.SummarizeNearby(a,b.create("div",{style:{width:"100%"}},this.toolCtr))):"CreateDriveTimeAreas"===this.toolName?(b.mixin(a,{inputLayer:this.analysisLayer,inputLayers:e,distanceDefaultUnits:c?"Miles":"Kilometers"}),this.currentTool=new esri.dijit.analysis.CreateDriveTimeAreas(a,
b.create("div",{style:{width:"100%"}},this.toolCtr))):"ConnectOriginsToDestinations"===this.toolName?(b.mixin(a,{originsLayer:this.analysisLayer,originsLayers:e,featureLayers:this.featureLayers,distanceDefaultUnits:c?"Miles":"Kilometers"}),this.currentTool=new esri.dijit.analysis.ConnectOriginsToDestinations(a,b.create("div",{style:{width:"100%"}},this.toolCtr))):"PlanRoutes"===this.toolName?(b.mixin(a,{stopsLayer:this.analysisLayer,stopsLayers:e,featureLayers:this.featureLayers,distanceDefaultUnits:c?
"Miles":"Kilometers"}),this.currentTool=new esri.dijit.analysis.PlanRoutes(a,b.create("div",{style:{width:"100%"}},this.toolCtr)),this.currentTool.on("drawtool-activate",function(){arcgisonline.map.edit.analysisDrawActivated=!0;arcgisonline.map.popup.disablePopupHandler()}),this.currentTool.on("drawtool-deactivate",function(){arcgisonline.map.edit.analysisDrawActivated=!1;arcgisonline.map.popup.setupPopupHandler()})):"EnrichLayer"===this.toolName?(b.mixin(a,{inputLayer:this.analysisLayer,inputLayers:this.featureLayers,
enableTravelModes:arcgisonline.map.dijit.toc.analysis.canPerformDriveAnalysis()}),this.currentTool=new esri.dijit.analysis.EnrichLayer(a,b.create("div",{style:{width:"100%"}},this.toolCtr))):"DissolveBoundaries"===this.toolName?(b.mixin(a,{inputLayer:this.analysisLayer,inputLayers:d}),this.currentTool=new esri.dijit.analysis.DissolveBoundaries(a,b.create("div",{style:{width:"100%"}},this.toolCtr))):"FindNearest"===this.toolName?(b.mixin(a,{analysisLayer:this.analysisLayer,analysisLayers:g,nearLayers:h,
searchCutoffUnits:c?"Miles":"Kilometers",enableTravelModes:arcgisonline.map.dijit.toc.analysis.canPerformNearestAnalysis()}),this.currentTool=new esri.dijit.analysis.FindNearest(a,b.create("div",{style:{width:"100%"}},this.toolCtr))):"MergeLayers"===this.toolName?(b.mixin(a,{inputLayer:this.analysisLayer,inputLayers:g,mergeLayers:h}),this.currentTool=new esri.dijit.analysis.MergeLayers(a,b.create("div",{style:{width:"100%"}},this.toolCtr))):"ExtractData"===this.toolName?(b.mixin(a,{featureLayers:this.featureLayers,
inputLayers:[this.analysisLayer]}),this.currentTool=new esri.dijit.analysis.ExtractData(a,b.create("div",{style:{width:"100%"}},this.toolCtr)),b.forEach(this._pbConnects,b.disconnect),this.currentTool.on("close",b.hitch(this,this._onClose)),this.currentTool.on("start",b.hitch(this,function(a){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.infoTitle,message:this.i18n.runAnalysisMsg})})),this.currentTool.on("drawtool-activate",function(){arcgisonline.map.edit.analysisDrawActivated=
!0;arcgisonline.map.popup.disablePopupHandler()}),this.currentTool.on("drawtool-deactivate",function(){arcgisonline.map.edit.analysisDrawActivated=!1;arcgisonline.map.popup.setupPopupHandler()})):"FindExistingLocations"===this.toolName?(b.mixin(a,{analysisLayer:this.analysisLayer,analysisLayers:g,inputLayers:h,primaryActionButttonClass:"btn calcite blue"}),this.currentTool=new esri.dijit.analysis.FindExistingLocations(a,b.create("div",{style:{width:"100%"}},this.toolCtr))):"DeriveNewLocations"===
this.toolName?(b.mixin(a,{analysisLayer:esri.isDefined(this.analysisLayer)?this.analysisLayer:this.featureLayers[0],showSelectAnalysisLayer:!1,inputLayers:this.featureLayers,primaryActionButttonClass:"btn calcite blue"}),this.currentTool=new esri.dijit.analysis.DeriveNewLocations(a,b.create("div",{style:{width:"100%"}},this.toolCtr))):"FindSimilarLocations"===this.toolName?(b.mixin(a,{inputLayer:this.analysisLayer,inputLayers:g,searchLayers:h,primaryActionButttonClass:"btn calcite blue"}),this.currentTool=
new esri.dijit.analysis.FindSimilarLocations(a,b.create("div",{style:{width:"100%"}},this.toolCtr)),this.currentTool.on("selecttool-activate",function(){arcgisonline.map.edit.analysisDrawActivated=!0;arcgisonline.map.popup.disablePopupHandler()}),this.currentTool.on("selecttool-deactivate",function(){arcgisonline.map.edit.analysisDrawActivated=!1;arcgisonline.map.popup.setupPopupHandler()})):"TraceDownstream"===this.toolName?(b.forEach(arcgisonline.map.main.mapLayers,function(a){if(a.layer&&a.layer.name&&
-1!==a.layer.name.indexOf(this.i18n.blayerName)){if(-1!==a.layer.name.indexOf("_")){var b=a.layer.name.split("_");this._drawnBlayerCount=parseInt(b[1],10)}this._drawnBlayerCount++}a.layer&&(a.layer.name&&-1!==a.layer.name.indexOf(this.i18n.ptInputlayerName))&&(-1!==a.layer.name.indexOf("_")&&(b=a.layer.name.split("_"),this._drawnInputPtlayerCount=parseInt(b[1],10)),this._drawnInputPtlayerCount++)},this),b.mixin(a,{inputLayer:this.analysisLayer,inputLayers:e,boundingPolygonLayers:d,maxDistanceUnits:c?
"Miles":"Kilometers",splitUnits:c?"Miles":"Kilometers"}),this.currentTool=new esri.dijit.analysis.TraceDownstream(a,b.create("div",{style:{width:"100%"}},this.toolCtr)),0<this._drawnBlayerCount&&this.currentTool.set("drawLayerName",this.i18n.blayerName+"_"+this._drawnBlayerCount),0<this._drawnInputPtlayerCount&&this.currentTool.set("drawPointLayerName",this.i18n.ptInputlayerName+"_"+this._drawnInputPtlayerCount),this.currentTool.on("drawtool-activate",function(){arcgisonline.map.edit.analysisDrawActivated=
!0;arcgisonline.map.popup.disablePopupHandler()}),this.currentTool.on("drawtool-deactivate",function(){arcgisonline.map.edit.analysisDrawActivated=!1;arcgisonline.map.popup.setupPopupHandler()})):"CreateWatersheds"===this.toolName?(b.forEach(arcgisonline.map.main.mapLayers,function(a){a.layer&&(a.layer.name&&-1!==a.layer.name.indexOf(this.i18n.ptInputlayerName))&&(-1!==a.layer.name.indexOf("_")&&(a=a.layer.name.split("_"),this._drawnInputPtlayerCount=parseInt(a[1],10)),this._drawnInputPtlayerCount++)},
this),b.mixin(a,{inputLayer:this.analysisLayer,inputLayers:e,searchUnits:c?"Feet":"Meters"}),this.currentTool=new esri.dijit.analysis.CreateWatersheds(a,b.create("div",{style:{width:"100%"}},this.toolCtr)),0<this._drawnInputPtlayerCount&&this.currentTool.set("drawPointLayerName",this.i18n.ptInputlayerName+"_"+this._drawnInputPtlayerCount),this.currentTool.on("drawtool-activate",function(){arcgisonline.map.edit.analysisDrawActivated=!0;arcgisonline.map.popup.disablePopupHandler()}),this.currentTool.on("drawtool-deactivate",
function(){arcgisonline.map.edit.analysisDrawActivated=!1;arcgisonline.map.popup.setupPopupHandler()})):"CreateViewshed"===this.toolName&&(b.forEach(arcgisonline.map.main.mapLayers,function(a){a.layer&&(a.layer.name&&-1!==a.layer.name.indexOf(this.i18n.ptInputlayerName))&&(-1!==a.layer.name.indexOf("_")&&(a=a.layer.name.split("_"),this._drawnInputPtlayerCount=parseInt(a[1],10)),this._drawnInputPtlayerCount++)},this),b.mixin(a,{inputLayer:this.analysisLayer,inputLayers:e,maxDistanceUnits:c?"Miles":
"Kilometers",maximumDistance:c?9:15,observerHeightUnits:c?"Feet":"Meters",observerHeight:c?6:1.75,targetHeightUnits:c?"Feet":"Meters"}),this.currentTool=new esri.dijit.analysis.CreateViewshed(a,b.create("div",{style:{width:"100%"}},this.toolCtr)),0<this._drawnInputPtlayerCount&&this.currentTool.set("drawPointLayerName",this.i18n.ptInputlayerName+"_"+this._drawnInputPtlayerCount),this.currentTool.on("drawtool-activate",function(){arcgisonline.map.edit.analysisDrawActivated=!0;arcgisonline.map.popup.disablePopupHandler()}),
this.currentTool.on("drawtool-deactivate",function(){arcgisonline.map.edit.analysisDrawActivated=!1;arcgisonline.map.popup.setupPopupHandler()})),this.currentTool&&(b.replaceClass(b.query(".esriAnalysisCloseIcon",this.currentTool.domNode)[0],"panel panel_close panel_collapse"),b.replaceClass(b.query("a[esriHelpTopic\x3d'toolDescription']",this.currentTool.domNode)[0],"helpIcon"),b.query(".esriAnalysisSubmitButton",this.currentTool.domNode).forEach(function(a){b.addClass(a,"btn calcite small blue")},
this),b.query(".esriTertiaryActionBtn",this.currentTool.domNode).forEach(function(a){b.addClass(a,"calcite green tiny")},this),this.currentTool.startup()),"ExtractData"!==this.toolName?this._loadConnections():(this.currentTool.on("job-status",b.hitch(this,function(a){"esriJobFailed"===a.jobStatus&&this._handleJobError(a)})),this.currentTool.on("job-fail",b.hitch(this,this._handleJobError)))},_handleJobError:function(a){var c,d="";c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();
a.message&&(d=a.message);"warning"===a.type&&this.currentTool.set("disableRunAnalysis",!1);esri.isDefined(a.messageCode)&&-1!==b.indexOf(["AB_0003","AB_0001"],a.messageCode)&&this.currentTool.set("disableRunAnalysis",!0);c.show({title:this.i18n.errorTitle,message:d})}})});