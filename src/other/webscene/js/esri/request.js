// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("require dojo/_base/array dojo/_base/config dojo/_base/Deferred dojo/_base/lang dojo/_base/url dojo/_base/xhr dojo/io/script dojo/io/iframe dojo/dom-construct dojo/io-query dojo/when ./kernel ./config ./core/sniff ./core/lang ./core/urlUtils ./core/deferredUtils".split(" "),function(W,w,G,N,m,H,z,X,Y,Q,R,Z,h,$,n,x,f,aa){function I(a){a=new H(a);return(a.host+(a.port?":"+a.port:"")).toLowerCase()}function C(a,c,b,d){var O=!1,S=!1,p;x.isDefined(c)&&(m.isObject(c)?(O=!!c.useProxy,S=!!c.usePost,
p=c.crossOrigin):O=!!c);a=m.mixin({},a);a._ssl&&(a.url=a.url.replace(/^http:/i,"https:"));c=a.content;var l=a.url,e=b&&a.form;p=x.isDefined(p)?p:g.useCors;a.load=function(a){var b;a&&(a.error?(b=m.mixin(Error(),a.error),b.log=G.isDebug):"error"===a.status&&(b=m.mixin(Error(),a),b.log=G.isDebug),b&&!x.isDefined(b.httpCode)&&(b.httpCode=b.code));return b||a};a.error=function(a,b){b&&b.xhr&&b.xhr.abort();a instanceof Error||(a=m.mixin(Error(),a));a.log=G.isDebug;return a};a._token&&(a.content=a.content||
{},a.content.token=a._token);var q=0,k;c&&l&&(k=R.objectToQuery(c),q=k.length+l.length+1,n("esri-url-encodes-apostrophe")&&(q=k.replace(/'/g,"%27").length+l.length+1));a.timeout=x.isDefined(a.timeout)?a.timeout:g.timeout;a.handleAs=a.handleAs||"json";try{var r,s,t=p&&f.canUseXhr(a.urlObj)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(a.url),v=f.hasSameOrigin(a.urlObj,h.appUrl)||t,A=S||b||q>g.maxUrlLength?!0:!1,y=!v&&-1!==a.handleAs.indexOf("json")&&a.callbackParamName&&!b?!0:!1,B=f.getProxyRule(a.url)||
g.forceProxy||O||(!y||A)&&!v?!0:!1;b&&(!n("esri-file-upload")&&!B&&t)&&(B=!0);if(B)if(r=f.getProxyUrl(l,p),s=r.path,r._xo&&(t=!0),!A&&s.length+1+q>g.maxUrlLength&&(A=!0),a.url=s+"?"+l,A)a.content=m.mixin(r.query||{},c);else{var T=R.objectToQuery(m.mixin(r.query||{},c));T&&(a.url+=(-1===l.indexOf("?")?"?":"\x26")+T);a.content=null}if(y&&!A)return!x.isDefined(a.isAsync)&&4>n("ff")&&(a.isAsync=!0),X.get(u?u(a):a);var D=a.headers;if(t&&(!D||!D.hasOwnProperty("X-Requested-With")))D=a.headers=D||{},D["X-Requested-With"]=
null;if(b){var J=a.callbackParamName||"callback.html",U=a.callbackElementName||"textarea",E,K,F,L,H=e.elements?e.elements.length:0,P;if(c=a.content)for(E in c)if(F=c[E],x.isDefined(F)){K=null;for(L=0;L<H;L++)if(P=e.elements[L],P.name===E){K=P;break}K?K.value=F:d?e.append(E,F):e.appendChild(Q.create("input",{type:"hidden",name:E,value:F}))}if(n("esri-file-upload"))w.forEach(e.elements,function(a){a.name===J&&e.removeChild(a)}),a.contentType=!1,a.postData=d?e:new FormData(e),delete a.form;else{e.enctype=
"multipart/form-data";9>n("ie")&&(e.encoding="multipart/form-data");e.method="post";w.some(e.elements,function(a){return a.name===J})||e.appendChild(Q.create("input",{type:"hidden",name:J,value:U}));if(-1!==l.toLowerCase().indexOf("addattachment")||-1!==l.toLowerCase().indexOf("updateattachment"))a.url=l+(-1===l.indexOf("?")?"?":"\x26")+J+"\x3d"+U,B&&(a.url=s+"?"+a.url);delete a.content}}if(t&&!a.hasOwnProperty("withCredentials"))if(d=B?s:l,-1!==w.indexOf(g.webTierAuthServers,I(d)))a.withCredentials=
!0;else if(h.id){var C=h.id.findServerInfo(d);C&&C.webTierAuth&&(a.withCredentials=!0)}a=u?u(a):a;if(A){if(b&&!n("esri-file-upload"))return Y.send(a);!B&&n("safari")&&(a.url+=(-1===a.url.indexOf("?")?"?":"\x26")+"_ts\x3d"+(new Date).getTime()+ba++);return z.post(a)}return z.get(a)}catch(M){return b=new N,b.errback(a.error(M)),b}}function M(a){var c=g.corsStatus,b=f.canUseXhr(a,!0);-1<b&&g.corsEnabledServers.splice(b,1);c[I(a)]=1;return b}function V(a){var c=g.corsStatus;try{var b=I(a.url);if(g.corsDetection&&
g.useCors&&n("esri-cors")&&a.url&&-1!==a.url.toLowerCase().indexOf("/rest/services")&&!f.hasSameOrigin(a.urlObj,h.appUrl)&&!f.canUseXhr(a.urlObj)){if(c[b])return c[b];var d=new N;c[b]=d.promise;z.get({url:a.url.substring(0,a.url.toLowerCase().indexOf("/rest/")+6)+"info",content:{f:"json"},failOk:!0,handleAs:"json",headers:{"X-Requested-With":null},timeout:1E3*g.corsDetectionTimeout}).then(function(c){c?(f.canUseXhr(a.url)||g.corsEnabledServers.push(b),d.resolve()):d.reject()},function(a){d.reject()});
return d.promise}}catch(k){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}}function v(a,c,b,d){function k(a){a._pendingDfd=C(b,d,r,m);if(a._pendingDfd)a._pendingDfd.then(function(b){a.ioArgs=a._pendingDfd&&a._pendingDfd.ioArgs;a.callback(b);a._pendingDfd=null}).then(null,function(c){var y,e,f;c&&(y=c.code,e=c.subcode,f=(f=c.messageCode)&&f.toUpperCase());if(c&&403==y&&(4==e||c.message&&-1<c.message.toLowerCase().indexOf("ssl")&&-1===c.message.toLowerCase().indexOf("permission"))){if(!b._ssl){b._ssl=
b._sslFromServer=!0;v(a,!0,b,d);return}}else if(c&&415==c.status){if(M(b.url),!b._err415){b._err415=1;v(a,!0,b,d);return}}else if(h.id&&-1!==w.indexOf(h.id._errorCodes,y)&&!h.id._isPublic(b.url)&&!p&&(403!=y||-1===w.indexOf(ca,f)&&(!x.isDefined(e)||2==e&&b._token))){a._pendingDfd=h.id.getCredential(b.url,{token:b._token,error:c});a._pendingDfd.then(function(c){b._token=c.token;b._credential=c;b._ssl=b._sslFromServer||c.ssl;v(a,!0,b,d)}).then(null,function(b){a.errback(b);a._pendingDfd=null});return}a.ioArgs=
a._pendingDfd&&a._pendingDfd.ioArgs;a.errback(c);a._pendingDfd=null});else{a.ioArgs=a._pendingDfd&&a._pendingDfd.ioArgs;var c=Error("Deferred object is missing");c.log=G.isDebug;a.errback(c);a._pendingDfd=null}}var f=b.form,p=d.disableIdentityLookup,l=d._preLookup,e=!1;if(n("esri-workers")&&!1!==g.useWorkers)if(!0===d.useWorkers||!0===g.useWorkers)e=!0;else if(d.workerOptions){var q=d.workerOptions;if(q.callback||q.worker&&q.worker.worker instanceof Worker)e=!0}var m=f&&f.append,r=f&&(f.elements?
w.some(f.elements,function(a){return"file"===a.type}):m),s=-1!==b.url.toLowerCase().indexOf("token\x3d")||b.content&&b.content.token||r&&w.some(f.elements,function(a){return"token"===a.name})?1:0;if(!c){a.then(function(a){/\/sharing\/rest\/accounts\/self/i.test(b.url)&&(!s&&!b._token&&a.user&&a.user.username)&&g.webTierAuthServers.push(I(b.url));if(a=b._credential){var c=h.id.findServerInfo(a.server);if(c=c&&c.owningSystemUrl)c=c.replace(/\/?$/,"/sharing"),(a=h.id.findCredential(c,a.userId))&&-1===
h.id._getIdenticalSvcIdx(c,a)&&a.resources.splice(0,0,c)}}).always(function(a){delete b._credential;if(a&&(!n("ie")||!a.nodeType))a._ssl=b._ssl});var t=b.load,u=b.error;t&&a.then(function(b){var c=a._pendingDfd,c=c&&c.ioArgs;return t.call(c&&c.args,b,c)});u&&a.then(null,function(b){var c=a._pendingDfd,c=c&&c.ioArgs;return u.call(c&&c.args,b,c)})}if(h.id&&!s&&!b._token&&!h.id._isPublic(b.url)&&(!p||l))if(c=h.id.findCredential(b.url))b._token=c.token,b._ssl=c.ssl;e?d.workerOptions&&d.workerOptions.worker?
(z=d.workerOptions.worker,k(a)):W(["./workers/RequestClient"],function(b){if(d.workerOptions){var c=d.workerOptions;z=b.getClient(c.callback,c.cbFunction)}else z=b.getClient();k(a)}):k(a);return a.promise}function k(a,c){a.url=f.fixUrl(a.url);"file"!==h.appUrl.scheme&&(a.url=f.getAbsoluteUrl(a.url));a.urlObj=new H(a.url);c=c||{};var b=new N(aa._dfdCanceller);Z(V(a)).always(function(){v(b,!1,a,c)});return b.promise}var u,g=$.request,ca=["COM_0056","COM_0057"],ba=0;k._makeRequest=C;k._processRequest=
v;k._disableCors=M;k._detectCors=V;k.setRequestPreCallback=function(a){u=a};return k});