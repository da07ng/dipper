// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../../../core/declare dojo/_base/lang dojo/promise/all ../../../core/Accessor ../../../core/Promise ../../../core/Evented ../../../tasks/support/Query".split(" "),function(g,h,k,l,m,n,p){return g([l,m,n],{declaredClass:"esri.layers.graphics.controllers.SnapshotController",constructor:function(){this._addFeatures=this._addFeatures.bind(this);this._nextQuery=this._nextQuery.bind(this);this._queryError=this._queryError.bind(this);this._queryExtentHandle=this._queryExtent=null},initialize:function(){var a=
k([this.layer,this.layerView]).then(function(){this.graphicsSource=this.layer.graphicsSource;this.graphicsCollection=this.graphicsCollection}.bind(this));this.addResolvingPromise(a);this.then(this._startQuerying.bind(this))},destroy:function(){this.graphicsCollection=null},_startQuerying:function(){this._initializeExtent();this._queryAll()},_colChgHdl:null,_graphicsCollectionSetter:function(a,b){if(b===a)return b;b&&(this._colChgHdl.remove(),this._colChgHdl=null,this.clear());a&&(a.forEach(function(a){a.layer=
this.layer},this),this._colChgHdl=a.on("change",function(a){var c,b,e;e=a.added;for(c=0;b=e[c];c++)b.layer=this.layer;e=a.removed;for(c=0;b=e[c];c++)b.layer=null}.bind(this)));return a},_initializeExtent:function(){if(this.extentAccessor){var a=this.extentAccessor.get(this.extentProperty);if(this._queryExtent=a&&a.clone())this._queryExtentHandle=this.extentAccessor.watch(this.extentProperty,function(){this._queryExtent=null;this._queryExtentHandle.remove();this._queryExtentHandle=null;this.isFulfilled()&&
(this.graphicsCollection.clear(),this._queryAll())}.bind(this))}else this._queryExtentHandle=this._queryExtent=null},_extentsEqual:function(a,b){return null==a&&null==b?!0:null==a||null==b?!1:a.equals(b)},_queryAll:function(){var a=this.layer,b=this.layerView,d=!!(a.advancedQueryCapabilities||{}).supportsPagination,c=new p;c.where=a.definitionExpression||"1\x3d1";c.outFields=a.outFields;c.returnGeometry=!0;c.outSpatialReference=b.view.map.spatialReference;c.returnZ=a.hasZ&&a.returnZ||null;c.returnM=
a.hasM&&a.returnM||null;c.geometry=this._queryExtent;d&&(this.pageSize=null==this.maxPageSize?a.maxRecordCount:Math.min(a.maxRecordCount,this.maxPageSize),c.num=this.pageSize);this._query(c,d?0:void 0,this._queryExtent)},_query:function(a,b,d){var c;null!=b&&(a.start=b,c=b+this.pageSize);this.graphicsSource.queryFeatures(a).then(h.hitch(this,this._nextQuery,a,c,d)).then(this._addFeatures,this._queryError)},_addFeatures:function(a){if(this.featureTransform)for(var b=0;b<a.features.length;++b)this.featureTransform(a.features[b]);
this.graphicsCollection.addItems(a.features);return a},_nextQuery:function(a,b,d,c){var f=!1;if(this._extentsEqual(d,this._queryExtent))return c.exceededTransferLimit&&(void 0!==b&&(this._query(a,b,d),f=!0),this.emit("query-limit-exceeded")),f||this.emit("all-features-loaded"),c},_queryError:function(){}})});