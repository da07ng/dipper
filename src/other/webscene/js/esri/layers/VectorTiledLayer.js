// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../core/declare dojo/_base/lang ../request ../core/urlUtils ../core/JSONSupport ../geometry/SpatialReference ../geometry/Extent ../geometry/Point ./TiledLayer ./support/TileInfo ./support/LOD".split(" "),function(l,g,e,m,n,d,f,p,q,h,c){return l([q,n],{declaredClass:"esri.layers.VectorTiledLayer",classMetadata:{reader:{add:["spatialReference","tileInfo"]}},viewModulePaths:{"2d":"../views/2d/layers/VectorTiledLayerView2D"},_mapsWithAttribution:["World_Basemap"],normalizeCtorArgs:function(a,
b){return"string"===typeof a?g.mixin({url:a},b):a},getDefaults:function(a){var b=null;a.url&&(b=m.urlToObject(a.url).path.toLowerCase(),b=this._getDefaultAttribution(this._getMapName(b)));var k=new f(-2.0037508342787E7,-2.003750834278E7,2.003750834278E7,2.0037508342787E7,d.WebMercator);return g.mixin(this.inherited(arguments),{styles:[],attributionDataUrl:b,hasAttributionData:!!b,fullExtent:k,initialExtent:k,spatialReference:d.WebMercator,tileInfo:new h({rows:512,cols:512,dpi:96,format:"pbf",origin:new p({x:-2.0037508342787E7,
y:2.0037508342787E7,spatialReference:d.WebMercator}),spatialReference:d.WebMercator,lods:[new c({level:0,resolution:78271.51696399994,scale:2.95828763795777E8}),new c({level:1,resolution:39135.75848200009,scale:1.47914381897889E8}),new c({level:2,resolution:19567.87924099992,scale:7.3957190948944E7}),new c({level:3,resolution:9783.93962049996,scale:3.6978595474472E7}),new c({level:4,resolution:4891.96981024998,scale:1.8489297737236E7}),new c({level:5,resolution:2445.98490512499,scale:9244648.868618}),
new c({level:6,resolution:1222.992452562495,scale:4622324.434309}),new c({level:7,resolution:611.4962262813797,scale:2311162.217155}),new c({level:8,resolution:305.74811314055756,scale:1155581.108577}),new c({level:9,resolution:152.87405657041106,scale:577790.554289}),new c({level:10,resolution:76.43702828507324,scale:288895.277144}),new c({level:11,resolution:38.21851414253662,scale:144447.638572}),new c({level:12,resolution:19.10925707126831,scale:72223.819286}),new c({level:13,resolution:9.554628535634155,
scale:36111.909643}),new c({level:14,resolution:4.77731426794937,scale:18055.954822}),new c({level:15,resolution:2.388657133974685,scale:9027.977411}),new c({level:16,resolution:1.1943285668550503,scale:4513.988705}),new c({level:17,resolution:0.5971642835598172,scale:2256.994353}),new c({level:18,resolution:0.29858214164761665,scale:1128.497176})]})})},initialize:function(){if(this.serviceStyle)return this._setServiceStyle(this.serviceStyle);var a=e({url:this.url||this.styleUrl,content:{f:"json"},
handleAs:"json"});this.addResolvingPromise(a.then(function(a){return a.currentVersion?(this.styleUrl=this.styleUrl||this.url+(a.defaultStyles||"/styles/"),this.read(a),e({url:this.styleUrl,content:{f:"json"},handleAs:"json"}).then(this._setServiceStyle.bind(this))):this._setServiceStyle(a)}.bind(this)))},_fullExtentReader:f.fromJSON,_initialExtentReader:f.fromJSON,serviceStyle:null,_spatialReferenceReader:function(a,b){return(a=b.initialExtent&&b.initialExtent.spatialReference||b.fullExtent&&b.fullExtent.spatialReference)&&
d.fromJSON(a)},styles:null,_stylesSetter:function(a){if(a){if("string"===typeof a)return[a];if(Array.isArray(a))return a}else return[]},styleUrl:null,_styleUrlSetter:function(a,b){if(a===b)return b;if(!b)return a;this.loaded&&e({url:a,handleAs:"json"}).then(function(a){this._setServiceStyle(a)}.bind(this),function(a){this.emit("error",Error(a))}.bind(this));return a},_tileInfoReader:function(a){return a&&h.fromJSON(a)},addStyle:function(a){var b=this.styles;-1===b.indexOf(a)&&(this.styles=b.concat([a]))},
removeStyle:function(a){var b=this.styles;a=b.indexOf(a);-1!==a&&(b.splice(a,1),this.styles=b.concat())},hasStyle:function(a){return-1!==this.styles.indexOf(a)},_getMapName:function(a){return(a=a.match(/^https?\:\/\/(basemaps|basemapsbeta)\.arcgis\.com\/arcgis\/rest\/services\/([^\/]+(\/[^\/]+)*)\/vectortileserver/i))&&a[2]},_getDefaultAttribution:function(a){if(a){var b;a=a.toLowerCase();for(var c=0,d=this._mapsWithAttribution.length;c<d;c++)if(b=this._mapsWithAttribution[c],-1<b.toLowerCase().indexOf(a))return this._getProtocol()+
"//static.arcgis.com/attribution/Vector/"+b}},_getProtocol:function(){var a=window.location.protocol;return"file:"===a?"http:":a},_setServiceStyle:function(a){if(a){var b=this.styleUrl||this.url,c=b.match(/\/vectortileserver\/*\w*/i);c&&(b=this.url);a.glyphs&&(a.glyphs=this._getAbsolute(a.glyphs,b));a.sprite&&(a.sprite=this._getAbsolute(a.sprite,b),c&&(a.sprite=a.sprite.replace(/\/+$/,"")+"/sprite"));this.serviceStyle=a}},_getAbsolute:function(a,b){var c;if(/^https?:\/\//i.test(a)){if((c=b.match(/^https/))&&
0===location.protocol.indexOf("https"))console.log(a.replace(/^http:/i),"https:"),a=a.replace(/^http:/i,"https:");return a}if(0===a.indexOf("//"))return location.protocol+url;if(0===a.indexOf("/"))return b=b.replace(/(\/+\w+\.\w+)$/,""),b+a;if(0===a.indexOf("."))return b=b.replace(/(\/+\w+\.\w+)$/,""),b.replace(/\/+$/,"")+"/"+a}})});