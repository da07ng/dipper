// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
require({cache:{"url:esri/widgets/Popup/templates/PopupRenderer.html":'\x3cdiv class\x3d"${css.root}"\x3e\r\n  \x3cdiv class\x3d"${css.container}" data-dojo-attach-point\x3d"_container"\x3e\r\n    \x3cdiv class\x3d"${css.main}"\x3e\r\n      \x3cdiv class\x3d"${css.title}" data-dojo-attach-point\x3d"_title"\x3e\x3c/div\x3e\r\n      \x3cdiv class\x3d"${css.description}" data-dojo-attach-point\x3d"_description"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"${css.attachments}"\x3e\r\n      \x3cdiv\x3e${_i18n.attach}:\x3c/div\x3e\r\n      \x3cul data-dojo-attach-point\x3d"_attachmentsList"\x3e\x3c/ul\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"${css.media}"\x3e\r\n      \x3cdiv class\x3d"${css.mediaTitle}"\x3e${_i18n.media}\x3c/div\x3e\r\n      \x3cul class\x3d"${css.mediaSummary}"\x3e\r\n        \x3cli class\x3d"${css.mediaImageSummary}"\x3e\r\n          \x3cspan class\x3d"${css.mediaCount}" data-dojo-attach-point\x3d"_imageCount"\x3e\x3c/span\x3e\r\n          \x3cspan aria-hidden\x3d"true" class\x3d"${css.mediaImageIcon}"\x3e\x3c/span\x3e\r\n        \x3c/li\x3e\r\n        \x3cli class\x3d"${css.mediaChartSummary}"\x3e\r\n          \x3cspan class\x3d"${css.mediaCount}" data-dojo-attach-point\x3d"_chartCount"\x3e\x3c/span\x3e\r\n          \x3cspan aria-hidden\x3d"true" class\x3d"${css.mediaChartIcon}"\x3e\x3c/span\x3e\r\n        \x3c/li\x3e\r\n      \x3c/ul\x3e\r\n      \x3cdiv class\x3d"${css.mediaSlider}"\x3e\r\n        \x3cdiv class\x3d"${css.mediaSliderItems}" data-dojo-attach-point\x3d"_mediaSliderItems"\x3e\x3c/div\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"${css.edit}" data-dojo-attach-point\x3d"_editSummarySection"\x3e\r\n      \x3cdiv class\x3d"${css.editSummary}" data-dojo-attach-point\x3d"_editSummary"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("require ../Widget ../../core/declare ../../core/lang ../../core/urlUtils dojo/_base/lang dojo/_base/array dojo/dom-attr dojo/dom-class dojo/dom-construct dojo/on dojo/Deferred dojo/query dojo/sniff dojo/promise/all dojox/html/entities dijit/_TemplatedMixin dijit/a11yclick dojo/i18n!../../nls/jsapi dojo/text!./templates/PopupRenderer.html ../../request ../../tasks/support/Query ../../tasks/QueryTask ../../tasks/support/StatisticDefinition dojo/i18n!dojo/cldr/nls/number".split(" "),function(G,
H,I,k,J,s,m,p,u,r,C,D,K,L,w,M,N,O,P,Q,R,E,S,T,F){var U=0;return I([H,N],{declaredClass:"esri.widgets.Popup.PopupRenderer",templateString:Q,constructor:function(){this._i18n=P.widgets.popupRenderer},postCreate:function(){this.inherited(arguments);var a=this;this.own(C(this._mediaSliderItems,C.selector("["+this._mediaIndexAttr+"]",O),function(){a._openMediaItem(this)}))},destroy:function(){this._dfd&&this._dfd.cancel();this._destroyFrame();this.graphic=this._i18n=this._mediaInfos=this.mediaIndex=this._dfd=
null;this.inherited(arguments)},startup:function(){this.inherited(arguments);this.emit("load");this.set("loaded",!0)},css:{root:"esri-popup-renderer",container:"esri-popup-renderer-container",main:"esri-popup-renderer-main",title:"esri-popup-renderer-title",description:"esri-popup-renderer-description",attachments:"esri-popup-renderer-attachments",media:"esri-popup-renderer-media",mediaTitle:"esri-popup-renderer-media-title",mediaSummary:"esri-popup-renderer-media-summary",mediaCount:"esri-popup-renderer-media-count",
mediaImageSummary:"esri-popup-renderer-media-image-summary",mediaImageIcon:"esri-popup-renderer-media-image-icon esri-icon-media",mediaChartSummary:"esri-popup-renderer-media-chart-summary",mediaChartIcon:"esri-popup-renderer-MediaChartIcon esri-icon-chart",mediaSlider:"esri-popup-renderer-media-slider",mediaSliderItems:"esri-popup-renderer-media-slider-items",mediaSliderItem:"esri-popup-renderer-media-slider-item",mediaFrame:"esri-popup-renderer-media-frame",edit:"esri-popup-renderer-edit",editSummary:"esri-popup-renderer-summary",
showTitle:"esri-popup-renderer-show-title",showAttachments:"esri-popup-renderer-show-attachments",showMedia:"esri-popup-renderer-show-media",showEdit:"esri-popup-renderer-show-edit",numericValue:"esri-numeric-value",chart:"esri-chart",clearFix:"esri-clearfix"},_relatedFieldPrefix:"relationships/",_mediaIndexAttr:"data-media-index",graphic:null,showTitle:!0,showContent:!0,title:"",content:null,getComponents:function(){var a=this.graphic,b=a.popupTemplate,c=new D,d,e;b&&b.fieldInfos&&(e=m.filter(b.fieldInfos,
function(a){return-1!==a.fieldName.indexOf(this._relatedFieldPrefix)},this));e&&0<e.length&&(d=this._getRelatedRecords({graphic:a,fieldsInfo:e}));this.showContent?d?d.always(function(){c.resolve(this._getPopupValues())}):c.resolve(this._getPopupValues()):c.resolve();return c.promise},getAttachments:function(){var a=this.graphic,b=a.layer,a=a.attributes;if(this.showAttachments&&(b&&b.hasAttachments&&b.objectIdField)&&(a=a&&a[b.objectIdField]))return b.queryAttachmentInfos(a)},_openMediaItem:function(a){if(a=
p.get(a,this._mediaIndexAttr))a=parseInt(a,10),console.log(this._mediaInfos[a])},_goToPrevMedia:function(){var a=this._mediaInfos.length,b=this.mediaIndex-1;0>b&&(b=a-1);this.set("mediaIndex",b)},_goToNextMedia:function(){var a=this.mediaIndex+1;a===this._mediaInfos.length&&(a=0);this.set("mediaIndex",a)},_updateUI:function(){var a=0,b=0,c=this._mediaInfos;c&&(c.forEach(function(c,e){var f=c.value,g={className:this.css.mediaSliderItem};g[this._mediaIndexAttr]=e;g=r.create("div",g,this._mediaSliderItems);
if("image"===c.type){var l;f.linkURL&&(l=r.create("a",{href:f.linkURL,target:this._preventNewTab(f.linkURL)?"":"_blank"},g));r.create("img",{alt:"",src:f.sourceURL},l||g);a++}else-1!==c.type.indexOf("chart")&&(r.create("img",{alt:"",src:"http://findicons.com/files/icons/192/finance/64/pie_chart.png"},g),b++);r.create("div",{textContent:c.title},g)}.bind(this)),p.set(this._imageCount,"innerHTML","("+a+")"),p.set(this._chartCount,"innerHTML","("+b+")"))},_displayMedia:function(){var a=this._mediaInfos[this.mediaIndex];
this._rid=null;var b=this,c=["dojox/charting/Chart2D","dojox/charting/action2d/Tooltip"],d=a.value.theme||this.chartTheme;s.isString(d)&&(d=d.replace(/\./gi,"/"),-1===d.indexOf("/")&&(d="dojox/charting/themes/"+d));d||(d="dojox/charting/themes/Claro");c.push(d);try{var e=this._rid=U++;G(c,function(c,d,f){e===b._rid&&(b._rid=null,b._showChart(a.type,a.value,c,d,f))})}catch(f){console.log(this.declaredClass+"::error loading modules")}},_preventNewTab:function(a){return(a=a&&s.trim(a).toLowerCase())&&
(0===a.indexOf("mailto:")||0===a.indexOf("tel:"))},_showChart:function(a,b,c,d,e){c=this._chart=new c(r.create("div",{"class":this.css.chart},this._mediaFrame),{margins:{l:4,t:4,r:4,b:4}});e&&c.setTheme(e);switch(a){case "piechart":c.addPlot("default",{type:"Pie",labels:!1});c.addSeries("Series A",b.fields);break;case "linechart":c.addPlot("default",{type:"Markers"});c.addAxis("x",{min:0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1});c.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"});
m.forEach(b.fields,function(a,c){a.x=c+1});c.addSeries("Series A",b.fields);break;case "columnchart":c.addPlot("default",{type:"Columns",gap:3});c.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"});c.addSeries("Series A",b.fields);break;case "barchart":c.addPlot("default",{type:"Bars",gap:3}),c.addAxis("x",{includeZero:!0,fixUpper:"minor",minorLabels:!1}),c.addAxis("y",{vertical:!0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),c.addSeries("Series A",b.fields)}this._action=new d(c);
c.render()},_destroyFrame:function(){this._rid=null;this._chart&&(this._chart.destroy(),this._chart=null);this._action&&(this._action.destroy(),this._action=null);this._pswpNode&&r.destroy(this._pswpNode)},_attListHandler:function(a,b){if(a===this._dfd){this._dfd=null;var c="";!(b instanceof Error)&&(b&&b.length)&&m.forEach(b,function(a){c+="\x3cli\x3e";c+='\x3ca href\x3d"'+J.addProxy(a.url)+'" target\x3d"_blank"\x3e'+(a.name||"[No name]")+"\x3c/a\x3e";c+="\x3c/li\x3e"});p.set(this._attachmentsList,
"innerHTML",c||"\x3cli\x3e"+this._i18n.noAttach+"\x3c/li\x3e")}},_handleComponentsSuccess:function(a){if(a){var b=this.showTitle?a.title:"",c=a.description,d=a.fields,e=a.mediaInfos,f=this;p.set(this._title,"innerHTML",b);b&&u.add(this._container,this.css.showTitle);!c&&d&&(c="",d.length&&(c="\x3ctable\x3e\x3ctbody\x3e"),m.forEach(d,function(a){c+="\x3ctr\x3e";c+="\x3cth\x3e"+M.encode(a[0])+"\x3c/th\x3e";c+="\x3ctd\x3e"+a[1].replace(/^\s*(https?:\/\/[^\s]+)\s*$/i,'\x3ca target\x3d"_blank" href\x3d"$1" title\x3d"$1"\x3e'+
this._i18n.moreInfo+"\x3c/a\x3e")+"\x3c/td\x3e";c+="\x3c/tr\x3e"}),d.length&&(c+="\x3c/tbody\x3e\x3c/table\x3e"));p.set(this._description,"innerHTML",c);K("a",this._description).forEach(function(a){f._preventNewTab(a.href)?"_blank"===a.target&&p.remove(a,"target"):p.set(a,"target","_blank")});if(b=this._dfd=this.getAttachments())b.always(this._attListHandler.bind(this,b)),p.set(this._attachmentsList,"innerHTML","\x3cli\x3e"+this._i18n.searching+"\x26helip;\x3c/li\x3e"),u.add(this._container,this.css.showAttachments);
e&&e.length&&(u.add(this._container,this.css.showMedia),this._mediaInfos=e,this.set("mediaIndex",0));a.editSummary&&(p.set(this._editSummary,"innerHTML",a.editSummary),u.add(this._container,this.css.showEdit));this.set("content",this.domNode)}},_handleComponentsError:function(a){console.log(this.declaredClass+"::error loading template",a);this.set("content",null)},_getTitle:function(){var a="";this.graphic&&(a=this._getPopupValues(!0).title);return a},_relatedFeaturesAttributes:function(a,b,c,d){for(var e in d.attributes)if(d.attributes.hasOwnProperty(e)&&
"esriRelCardinalityOneToOne"===a.relation.cardinality){var f=this._toRelatedFieldName([a.relation.id,e]);b[f]=c[f]=d.attributes[e]}},_relatedStatsAttributes:function(a,b,c,d){for(var e in d.attributes)if(d.attributes.hasOwnProperty(e)){var f=this._toRelatedFieldName([a.relation.id,e]);b[f]=c[f]=d.attributes[e]}},_getPopupValues:function(a){var b=this.graphic,c=b.popupTemplate,d=b.layer,e=s.clone(b.attributes)||{},f=s.clone(e),g=c&&c.fieldInfos,l=c&&c.mediaInfos,h="",A="",x,q,n,v,p=d&&d._getDateOpts&&
d._getDateOpts().properties,t={dateFormat:{properties:p,formatter:"DateFormat"+this._insertOffset(this._dateFormats.shortDateShortTime)}};if(this._relatedInfo)for(v in this._relatedInfo)if(this._relatedInfo.hasOwnProperty(v)){var r=this._relatedInfo[v],u=this._relatedLayersInfo[v];r&&(m.forEach(r.relatedFeatures,function(a){this._relatedFeaturesAttributes(u,e,f,a)},this),m.forEach(r.relatedStatsFeatures,function(a){this._relatedStatsAttributes(u,e,f,a)},this))}g&&m.forEach(g,function(a){q=a.fieldName;
var c=this._getLayerFieldInfo(d,q);c&&(q=a.fieldName=c.name);f[q]=this._formatValue(f[q],q,t);p&&(a.format&&a.format.dateFormat)&&(a=m.indexOf(p,q),-1<a&&p.splice(a,1))},this);if(d){v=d.types;var w=(r=d.typeIdField)&&e[r];for(q in e)if(e.hasOwnProperty(q)&&-1===q.indexOf(this._relatedFieldPrefix)&&(n=e[q],k.isDefined(n))){var y=this._getDomainName(d,b,v,w,q,n);k.isDefined(y)?f[q]=y:q===r&&(y=this._getTypeName(d,b,n),k.isDefined(y)&&(f[q]=y))}}c&&c.title&&!(c.title&&-1!==c.title.indexOf("{"+this._relatedFieldPrefix))&&
(h=this._processFieldsInLinks(this._fixTokens(c.title,d),e),h=s.trim(k.substitute(f,h,t)||""));if(a)return{title:h};c&&c.content&&(A=this._processFieldsInLinks(this._fixTokens(c.content,d),e),A=s.trim(k.substitute(f,A,t)||""));g&&(x=[],m.forEach(g,function(a){(q=a.fieldName)&&a.visible&&x.push([a.label||q,k.substitute(f,"${"+q+"}",t)||""])}));var z,B;l&&(z=[],m.forEach(l,function(a){B=0;n=a.value;switch(a.type){case "image":var b=n.sourceURL,b=b&&s.trim(k.substitute(e,this._fixTokens(b,d)));B=!!b;
break;case "piechart":case "linechart":case "columnchart":case "barchart":var g,b=n.normalizeField;n.fields=m.map(n.fields,function(a){return(g=this._getLayerFieldInfo(d,a))?g.name:a},this);b&&(g=this._getLayerFieldInfo(d,b),n.normalizeField=g?g.name:b);B=m.some(n.fields,function(a){return k.isDefined(e[a])||-1!==a.indexOf(this._relatedFieldPrefix)&&this._relatedInfo},this);break;default:return}if(B){a=s.clone(a);n=a.value;var b=a.title?this._processFieldsInLinks(this._fixTokens(a.title,d),e):"",
q=a.caption?this._processFieldsInLinks(this._fixTokens(a.caption,d),e):"";a.title=b?s.trim(k.substitute(f,b,t)||""):"";a.caption=q?s.trim(k.substitute(f,q,t)||""):"";if("image"===a.type)n.sourceURL=k.substitute(e,this._fixTokens(n.sourceURL,d)),n.linkURL&&(n.linkURL=s.trim(k.substitute(e,this._fixTokens(n.linkURL,d))||""));else{var l,h;m.forEach(n.fields,function(a,b){if(-1!==a.indexOf(this._relatedFieldPrefix))h=this._getRelatedChartInfos(a,n,e,t),h instanceof Array?n.fields=h:n.fields[b]=h;else{var d=
e[a],d=void 0===d?null:d;l=e[n.normalizeField]||0;d&&l&&(d/=l);n.fields[b]={y:d,tooltip:(c._fieldLabels[a.toLowerCase()]||a)+":\x3cbr/\x3e"+this._formatValue(d,a,t,!!l)}}},this)}z.push(a)}},this));return{title:h,description:A,fields:x&&x.length?x:null,mediaInfos:z&&z.length?z:null,formatted:f,editSummary:d&&d.getEditSummary?d.getEditSummary(b):""}},_getRelatedChartInfos:function(a,b,c,d){var e,f,g,l,h,k,p=this.graphic.popupTemplate;e=[];k=this._fromRelatedFieldName(a);h=k[0];f=this._relatedInfo[h];
h=this._relatedLayersInfo[h];f&&m.forEach(f.relatedFeatures,function(f){f=f.attributes;var h,m;for(m in f)if(f.hasOwnProperty(m)&&m===k[1]){h={};l=f[m];b.normalizeField&&(g=-1!==b.normalizeField.indexOf(this._relatedFieldPrefix)?f[this._fromRelatedFieldName(b.normalizeField)[1]]:c[b.normalizeField]);l&&g&&(l/=g);if(b.tooltipField)if(-1!==b.tooltipField.indexOf(this._relatedFieldPrefix)){var r=this._fromRelatedFieldName(b.tooltipField)[1];h.tooltip=f[r]+":\x3cbr/\x3e"+this._formatValue(l,f[r],d,!!g)}else h.tooltip=
(p._fieldLabels[a.toLowerCase()]||a)+":\x3cbr/\x3e"+this._formatValue(l,b.tooltipField,d,!!g);else h.tooltip=l;h.y=l;e.push(h)}},this);return"esriRelCardinalityOneToMany"===h.relation.cardinality||"esriRelCardinalityManyToMany"===h.relation.cardinality?e:e[0]},_dateFormats:{shortDate:"(datePattern: 'M/d/y', selector: 'date')",shortDateLE:"(datePattern: 'd/M/y', selector: 'date')",longMonthDayYear:"(datePattern: 'MMMM d, y', selector: 'date')",dayShortMonthYear:"(datePattern: 'd MMM y', selector: 'date')",
longDate:"(datePattern: 'EEEE, MMMM d, y', selector: 'date')",shortDateShortTime:"(datePattern: 'M/d/y', timePattern: 'h:mm a', selector: 'date and time')",shortDateLEShortTime:"(datePattern: 'd/M/y', timePattern: 'h:mm a', selector: 'date and time')",shortDateShortTime24:"(datePattern: 'M/d/y', timePattern: 'H:mm', selector: 'date and time')",shortDateLEShortTime24:"(datePattern: 'd/M/y', timePattern: 'H:mm', selector: 'date and time')",shortDateLongTime:"(datePattern: 'M/d/y', timePattern: 'h:mm:ss a', selector: 'date and time')",
shortDateLELongTime:"(datePattern: 'd/M/y', timePattern: 'h:mm:ss a', selector: 'date and time')",shortDateLongTime24:"(datePattern: 'M/d/y', timePattern: 'H:mm:ss', selector: 'date and time')",shortDateLELongTime24:"(datePattern: 'd/M/y', timePattern: 'H:mm:ss', selector: 'date and time')",longMonthYear:"(datePattern: 'MMMM y', selector: 'date')",shortMonthYear:"(datePattern: 'MMM y', selector: 'date')",year:"(datePattern: 'y', selector: 'date')"},_reHref:/href\s*=\s*\"([^\"]+)\"/ig,_reHrefApos:/href\s*=\s*\'([^\']+)\'/ig,
_fixTokens:function(a,b){var c=this;return a.replace(/(\{([^\{\r\n]+)\})/g,function(a,e,f){a=c._getLayerFieldInfo(b,f);return"$"+(a?"{"+a.name+"}":e)})},_encodeAttributes:function(a){a=s.clone(a)||{};var b,c;for(b in a)if(a.hasOwnProperty(b)&&(c=a[b])&&"string"===typeof c)c=encodeURIComponent(c).replace(/\'/g,"\x26apos;"),a[b]=c;return a},_processFieldsInLinks:function(a,b){var c=this._encodeAttributes(b),d=this;a&&(a=a.replace(this._reHref,function(a,f){return d._addValuesToHref(a,f,b,c)}).replace(this._reHrefApos,
function(a,f){return d._addValuesToHref(a,f,b,c)}));return a},_addValuesToHref:function(a,b,c,d){b=b&&s.trim(b);return k.substitute(b&&0===b.indexOf("${")?c:d,a)},_getLayerFieldInfo:function(a,b){return a&&a.getField?a.getField(b):null},_formatValue:function(a,b,c,d){var e=this.graphic.popupTemplate._fieldsMap[b.toLowerCase()],f=e&&e.format;b="number"===typeof a&&-1===m.indexOf(c.dateFormat.properties,b)&&(!f||!f.dateFormat);if(!k.isDefined(a)||!e||!k.isDefined(f))return b?this._forceLTR(a):a;var g=
"",l=[],e=f.hasOwnProperty("places")||f.hasOwnProperty("digitSeparator"),h=f.hasOwnProperty("digitSeparator")?f.digitSeparator:!0;if(e)g="NumberFormat",l.push("places: "+(k.isDefined(f.places)&&(!d||0<f.places)?Number(f.places):"Infinity")),l.length&&(g+="("+l.join(",")+")");else if(f.dateFormat)g="DateFormat"+this._insertOffset(this._dateFormats[f.dateFormat]||this._dateFormats.shortDateShortTime);else return b?this._forceLTR(a):a;a=k.substitute({myKey:a},"${myKey:"+g+"}",c)||"";e&&!h&&F.group&&
(a=a.replace(RegExp("\\"+F.group,"g"),""));return b?this._forceLTR(a):a},_forceLTR:function(a){var b=L("ie");return b&&10>=b?a:'\x3cspan class\x3d"'+this.css.numericValue+'"\x3e'+a+"\x3c/span\x3e"},_insertOffset:function(a){a&&(a=k.isDefined(this.utcOffset)?a.replace(/\)\s*$/,", utcOffset:"+this.utcOffset+")"):a);return a},_getDomainName:function(a,b,c,d,e,f){return(a=a.getDomain&&a.getDomain(e,{feature:b}))&&a.codedValues?a.getName(f):null},_getTypeName:function(a,b){var c=a.getType&&a.getType(b);
return c&&c.name},_getRelatedRecords:function(a){var b=a.graphic,c=new D,d;this._relatedLayersInfo?this._queryRelatedLayers(b).then(function(a){this._setRelatedRecords(b,a);c.resolve(a)}.bind(this),this._handlerErrorResponse.bind(this,c)):this._getRelatedLayersInfo(a).then(function(a){for(d in a)a.hasOwnProperty(d)&&a[d]&&(this._relatedLayersInfo[d].relatedLayerInfo=a[d]);this._queryRelatedLayers(b).then(function(a){this._setRelatedRecords(b,a);c.resolve(a)}.bind(this),this._handlerErrorResponse.bind(this,
c))}.bind(this),this._handlerErrorResponse.bind(this,c));return c.promise},_getRelatedLayersInfo:function(a){var b=a.fieldsInfo,c,d,e={};c=a.graphic.layer;this._relatedLayersInfo||(this._relatedLayersInfo={});m.forEach(b,function(a){var b,d,e,k;b=this._fromRelatedFieldName(a.fieldName);d=b[0];b=b[1];d&&(this._relatedLayersInfo[d]||(m.some(c.relationships,function(a){if(a.id==d)return k=a,!0}),k&&(this._relatedLayersInfo[d]={relation:k,relatedFields:[],outStatistics:[]})),this._relatedLayersInfo[d]&&
(this._relatedLayersInfo[d].relatedFields.push(b),a.statisticType&&(e=new T,e.statisticType=a.statisticType,e.onStatisticField=b,e.outStatisticFieldName=b,this._relatedLayersInfo[d].outStatistics.push(e))))},this);for(d in this._relatedLayersInfo)this._relatedLayersInfo.hasOwnProperty(d)&&this._relatedLayersInfo[d]&&(a=this._relatedLayersInfo[d].relation,a=c.url.replace(/[0-9]+$/,a.relatedTableId),this._relatedLayersInfo[d].relatedLayerUrl=a,e[d]=R({url:a,content:{f:"json"},callbackParamName:"callback"}));
return w(e)},_queryRelatedLayers:function(a){var b={},c;for(c in this._relatedLayersInfo)this._relatedLayersInfo.hasOwnProperty(c)&&(b[c]=this._queryRelatedLayer({graphic:a,relatedInfo:this._relatedLayersInfo[c]}));return w(b)},_queryRelatedLayer:function(a){var b,c,d,e,f,g,l,h,k,p;b=a.graphic;c=b.layer.url.match(/[0-9]+$/g)[0];h=a.relatedInfo;l=h.relatedLayerInfo;k=h.relatedLayerUrl;p=h.relation;m.some(l.relationships,function(a){if(a.relatedTableId===parseInt(c,10))return d=a,!0},this);d&&(a=new E,
m.some(l.fields,function(a){if(a.name===d.keyField)return f=-1!==m.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],a.type)?"number":"string",!0}),e="string"===f?d.keyField+"\x3d'"+b.attributes[p.keyField]+"'":d.keyField+"\x3d"+b.attributes[p.keyField],a.where=e,a.outFields=h.relatedFields,h.outStatistics&&(0<h.outStatistics.length&&l.supportsStatistics)&&(g=new E,g.where=a.where,g.outFields=a.outFields,g.outStatistics=h.outStatistics),b=new S(k),
e=[],e.push(b.execute(a)),g&&e.push(b.execute(g)));return w(e)},_setRelatedRecords:function(a,b){this._relatedInfo=[];for(var c in b)if(b.hasOwnProperty(c)&&b[c]){var d=b[c];this._relatedInfo[c]={};this._relatedInfo[c].relatedFeatures=d[0].features;k.isDefined(d[1])&&(this._relatedInfo[c].relatedStatsFeatures=d[1].features)}},_handlerErrorResponse:function(a,b){a.reject(b)},_fromRelatedFieldName:function(a){var b=[];-1!==a.indexOf(this._relatedFieldPrefix)&&(a=a.split("/"),b=a.slice(1));return b},
_toRelatedFieldName:function(a){var b="";a&&0<a.length&&(b=this._relatedFieldPrefix+a[0]+"/"+a[1]);return b},_setMediaIndexAttr:function(a){this._set("mediaIndex",a);this._updateUI()},_setGraphicAttr:function(a){this._set("graphic",a);this.set("title",this._getTitle());this.getComponents().then(this._handleComponentsSuccess.bind(this),this._handleComponentsError.bind(this))}})});