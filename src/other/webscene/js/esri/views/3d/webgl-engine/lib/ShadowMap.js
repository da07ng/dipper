// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("./GLVBO ./GLSLProgram ./VertexBufferLayout ./GLUtil ./Camera ./Util ./gl-matrix".split(" "),function(pa,da,qa,ra,sa,k,u){var b=u.vec2d,J=u.vec3d,Z=u.vec4d,ta=u.mat3d,C=u.mat4d,G=u.mat4;return function(u,c){function v(a,c){J.set3(a[c],a[c+3],a[c+6],ea);return ea}var p,K=4096,D,U,L=1,$=2,M=[0,0,0,0,0],e=function(){this.camera=new sa;this.lightMat=C.create()},O=[],n,l,w;for(n=0;4>n;++n)O[n]=new e;this.getIsSupported=function(){return c.getExtension("OES_standard_derivatives")};this.setTextureResolution=
function(a){K=a};this.getTextureResolution=function(){return K};this.setMaxNumCascades=function(a){$=k.clamp(Math.floor(a),1,4)};this.getMaxNumCascades=function(){return $};this.setEnableState=function(a){k.assert(a!==this.getEnableState());a?this.enable():this.disable()};this.getEnableState=function(){return void 0!==p};this.enable=function(){k.assert(!this.getEnableState());k.assert(this.getIsSupported(),"Shadow maps not supported");p=c.createTexture();c.bindTexture(c.TEXTURE_2D,p);c.texParameteri(c.TEXTURE_2D,
c.TEXTURE_MIN_FILTER,c.NEAREST);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,K,K,0,c.RGBA,c.UNSIGNED_BYTE,null);D=c.createRenderbuffer();c.bindRenderbuffer(c.RENDERBUFFER,D);c.renderbufferStorage(c.RENDERBUFFER,c.DEPTH_COMPONENT16,K,K);U=c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,U);c.framebufferTexture2D(c.FRAMEBUFFER,
c.COLOR_ATTACHMENT0,c.TEXTURE_2D,p,0);c.framebufferRenderbuffer(c.FRAMEBUFFER,c.DEPTH_ATTACHMENT,c.RENDERBUFFER,D);ra.checkFramebufferStatus(c.FRAMEBUFFER,c);c.bindRenderbuffer(c.RENDERBUFFER,null);c.bindFramebuffer(c.FRAMEBUFFER,null)};this.disable=function(){k.assert(this.getEnableState());c.deleteFramebuffer(U);c.deleteRenderbuffer(D);c.deleteTexture(p);p=D=U=void 0};var fa=C.create(),ga=C.create(),ha=Z.create(),x=Array(8);for(n=0;8>n;++n)x[n]=Z.create();var H=J.create(),I=J.create(),ia=b.create(),
ja=b.create(),ua=b.create(),ka=b.create(),la=b.create(),ma=C.create(),na=J.create();this.prepare=function(y,Q,R,e,s){k.assert(this.getEnableState());C.multiply(y.projectionMatrix,y.viewMatrix,fa);var d=s[0],q=s[1];2>d&&(d=2);2>q&&(q=2);d>=q&&(d=2,q=4);L=Math.min(1+Math.floor(k.logWithBase(q/d,4)),$);R=Math.pow(q/d,1/L);for(s=0;s<L+1;++s)M[s]=d*Math.pow(R,s);C.inverse(fa,ga);C.lookAt([0,0,0],[-Q[0],-Q[1],-Q[2]],[0,1,0],ma);R=y.viewMatrix;y=y.projectionMatrix;for(s=0;s<L;++s){e=O[s];d=-M[s];q=-M[s+
1];d=(y[10]*d+y[14])/Math.abs(y[11]*d+y[15]);q=(y[10]*q+y[14])/Math.abs(y[11]*q+y[15]);k.assert(d<q);for(l=0;8>l;++l){Z.set4(0===l%4||3==l%4?-1:1,0===l%4||1==l%4?-1:1,4>l?d:q,1,ha);C.multiplyVec4(ga,ha,x[l]);for(w=0;3>w;++w)x[l][w]/=x[l][3]}J.negate(x[0],na);C.translate(ma,na,e.camera.viewMatrix);for(l=0;8>l;++l)C.multiplyVec3(e.camera.viewMatrix,x[l]);J.set(x[0],H);J.set(x[0],I);for(l=1;8>l;++l)for(w=0;3>w;++w)H[w]=Math.min(H[w],x[l][w]),I[w]=Math.max(I[w],x[l][w]);H[2]-=200;I[2]+=200;e.camera.near=
-I[2];e.camera.far=-H[2];d=1/x[0][3];q=1/x[4][3];k.assert(d<q);var h=d+Math.sqrt(d*q),m=Math.sin(Math.acos(R[2]*Q[0]+R[6]*Q[1]+R[10]*Q[2])),h=h/m,d=x,u=h,p=m,m=ia,z=ja,g=ua,E=ka,h=la;b.set2(0,0,B);for(var f=void 0,f=0;4>f;++f)b.add(B,d[f],B);b.scale(B,0.25);b.set2(0,0,V);for(f=4;8>f;++f)b.add(V,d[f],V);b.scale(V,0.25);b.lerp(d[4],d[5],0.5,P[0]);b.lerp(d[5],d[6],0.5,P[1]);b.lerp(d[6],d[7],0.5,P[2]);b.lerp(d[7],d[4],0.5,P[3]);for(var n=0,F=b.dist2(P[0],B),f=1;4>f;++f){var t=b.dist2(P[f],B);t<F&&(F=
t,n=f)}b.subtract(P[n],d[n+4],r);f=r[0];r[0]=-r[1];r[1]=f;b.subtract(V,B,oa);b.lerp(r,oa,p);b.normalize(r);n=p=void 0;p=n=b.dot(b.subtract(d[0],B,N),r);for(f=1;8>f;++f)F=b.dot(b.subtract(d[f],B,N),r),F<p?p=F:F>n&&(n=F);b.set(B,m);b.scale(r,p-u,N);b.add(m,N,m);for(var t=-1,G=1,f=u=F=0;8>f;++f){b.subtract(d[f],m,X);b.normalize(X);var D=r[0]*X[1]-r[1]*X[0];0<D?D>t&&(t=D,F=f):D<G&&(G=D,u=f)}k.verify(0<t,"leftArea");k.verify(0>G,"rightArea");b.scale(r,p,S);b.add(S,B,S);b.scale(r,n,T);b.add(T,B,T);Y[0]=
-r[1];Y[1]=r[0];z=k.rayRay2D(m,d[u],T,b.add(T,Y,N),1,z);g=k.rayRay2D(m,d[F],T,N,1,g);E=k.rayRay2D(m,d[F],S,b.add(S,Y,N),1,E);d=k.rayRay2D(m,d[u],S,N,1,h);k.verify(z,"rayRay");k.verify(g,"rayRay");k.verify(E,"rayRay");k.verify(d,"rayRay");g=ia;d=ja;m=ka;E=la;h=e.camera.projectionMatrix;b.scale(b.subtract(m,E,A),0.5);a[0]=A[0];a[1]=A[1];a[2]=0;a[3]=A[1];a[4]=-A[0];a[5]=0;a[6]=A[0]*A[0]+A[1]*A[1];a[7]=A[0]*A[1]-A[1]*A[0];a[8]=1;a[6]=-b.dot(v(a,0),g);a[7]=-b.dot(v(a,1),g);g=b.dot(v(a,0),m)+a[6];z=b.dot(v(a,
1),m)+a[7];f=b.dot(v(a,0),E)+a[6];E=b.dot(v(a,1),E)+a[7];g=-(g+f)/(z+E);a[0]+=a[1]*g;a[3]+=a[4]*g;a[6]+=a[7]*g;g=1/(b.dot(v(a,0),m)+a[6]);z=1/(b.dot(v(a,1),m)+a[7]);a[0]*=g;a[3]*=g;a[6]*=g;a[1]*=z;a[4]*=z;a[7]*=z;a[2]=a[1];a[5]=a[4];a[8]=a[7];a[7]+=1;g=b.dot(v(a,1),d)+a[7];z=b.dot(v(a,2),d)+a[8];f=b.dot(v(a,1),m)+a[7];E=b.dot(v(a,2),m)+a[8];g=-0.5*(g/z+f/E);a[1]+=a[2]*g;a[4]+=a[5]*g;a[7]+=a[8]*g;g=b.dot(v(a,1),d)+a[7];z=b.dot(v(a,2),d)+a[8];f=-z/g;a[1]*=f;a[4]*=f;a[7]*=f;h[0]=a[0];h[1]=a[1];h[2]=
0;h[3]=a[2];h[4]=a[3];h[5]=a[4];h[6]=0;h[7]=a[5];h[8]=0;h[9]=0;h[10]=1;h[11]=0;h[12]=a[6];h[13]=a[7];h[14]=0;h[15]=a[8];e.camera.projectionMatrix[10]=2/(H[2]-I[2]);e.camera.projectionMatrix[14]=-(H[2]+I[2])/(H[2]-I[2]);C.multiply(e.camera.projectionMatrix,e.camera.viewMatrix,e.lightMat);d=K/2;e.camera.viewport[0]=0===s%2?0:d;e.camera.viewport[1]=0===Math.floor(s/2)?0:d;e.camera.viewport[2]=d;e.camera.viewport[3]=d}M[L]=100*q;c.bindFramebuffer(c.FRAMEBUFFER,U);c.clearColor(1,1,1,1);c.clear(c.COLOR_BUFFER_BIT|
c.DEPTH_BUFFER_BIT)};var aa=[];this.getCascades=function(){for(var a=0;a<L;++a)aa[a]=O[a];aa.length=L;return aa};this.finish=function(a){k.assert(this.getEnableState());da.unuse(c);c.bindFramebuffer(c.FRAMEBUFFER,a)};this.bind=function(a){var b=this.getEnableState();c.activeTexture(c.TEXTURE7);c.bindTexture(c.TEXTURE_2D,b?p:null);c.activeTexture(c.TEXTURE0);a.use();a.uniform1i("depthTex",7);a.uniform1f("depthHalfPixelSz",b?0.5/K:-1);a.uniform1i("shadowMapNum",L);a.uniform4f("shadowMapDistance",M[0],
M[1],M[2],M[3])};this.bindAll=function(a){a=a.getProgramsUsingUniform("shadowMapDistance");for(var c=0;c<a.length;c++)this.bind(a[c])};var t=G.create(),W=new Float32Array(64);this.bindView=function(a,c){if(this.getEnableState()){var b;G.translate(O[0].lightMat,c,t);for(b=0;16>b;++b)W[b]=t[b];G.translate(O[1].lightMat,c,t);for(b=0;16>b;++b)W[16+b]=t[b];G.translate(O[2].lightMat,c,t);for(b=0;16>b;++b)W[32+b]=t[b];G.translate(O[3].lightMat,c,t);for(b=0;16>b;++b)W[48+b]=t[b];a.uniformMatrix4fv("shadowMapMatrix",
W)}};e=new Float32Array(16);e[0]=0;e[1]=0;e[2]=0;e[3]=0;e[4]=256;e[5]=0;e[6]=1;e[7]=0;e[8]=0;e[9]=256;e[10]=0;e[11]=1;e[12]=256;e[13]=256;e[14]=1;e[15]=1;var ba=qa.Defaults.Pos2Tex,ca=new pa(e,ba,c);this.drawDebugQuad=function(a){k.assert(this.getEnableState());var b=u.get("showDepth");c.disable(c.DEPTH_TEST);b.use();b.uniformMatrix4fv("proj",a);b.uniform1i("depthTex",0);c.bindTexture(c.TEXTURE_2D,p);ba.enableVertexAttribArrays(c,b);ca.bind();ca.setPointers(b);c.drawArrays(c.TRIANGLE_STRIP,0,ca.getNum());
c.bindBuffer(c.ARRAY_BUFFER,null);ba.disableVertexAttribArrays(c,b);da.unuse(c);c.enable(c.DEPTH_TEST)};var B=b.create(),V=b.create(),P=[b.create(),b.create(),b.create(),b.create()],r=b.create(),oa=b.create(),N=b.create(),X=b.create(),S=b.create(),T=b.create(),Y=b.create(),ea=J.create(),A=b.create(),a=ta.create()}});