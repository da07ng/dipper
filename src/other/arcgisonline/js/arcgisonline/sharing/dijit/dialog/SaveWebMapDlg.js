// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/SaveWebMapDlg",["dijit","dojo","dojox","dojo/require!arcgisonline/sharing/util,arcgisonline/sharing/dijit/dialog/GeneralDlg,arcgisonline/sharing/geow/Content,arcgisonline/sharing/geow/Folder,arcgisonline/map/mapUtil,dojo/data/ItemFileWriteStore,dijit/form/SimpleTextarea,dijit/form/TextBox,arcgisonline/sharing/dijit/ComboBox,dijit/Dialog,dijit/_Widget,dijit/_Templated,dijit/form/Form,dojo/cookie,esri/dijit/Tags"],function(l,a,m){a.provide("arcgisonline.sharing.dijit.dialog.SaveWebMapDlg");
a.require("arcgisonline.sharing.util");a.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");a.require("arcgisonline.sharing.geow.Content");a.require("arcgisonline.sharing.geow.Folder");a.require("arcgisonline.map.mapUtil");a.require("dojo.data.ItemFileWriteStore");a.require("dijit.form.SimpleTextarea");a.require("dijit.form.TextBox");a.require("arcgisonline.sharing.dijit.ComboBox");a.require("dijit.Dialog");a.require("dijit._Widget");a.require("dijit._Templated");a.require("dijit.form.Form");
a.require("dojo.cookie");a.require("esri.dijit.Tags");a.declare("arcgisonline.sharing.dijit.dialog.SaveWebMapDlg",[l._Widget,l._Templated],{widgetsInTemplate:!0,templateString:'\x3cdiv class\x3d"widgetContent"\x3e\r\n  \x3cdiv id\x3d"save-webmap-dialog" dojotype\x3d"dijit.Dialog" dojoAttachPoint\x3d"_saveWebMapDialog" title\x3d"${i18n.saveMap}" dojoAttachEvent\x3d"onHide:onHide" execute\x3d""\x3e\r\n    \x3cdiv dojoAttachPoint\x3d"_errorDiv"\x3e\r\n    \x3c/div\x3e\r\n    \x3cform dojotype\x3d"dijit.form.Form" dojoAttachPoint\x3d"_saveWebMapForm" enctype\x3d"multipart/form-data" name\x3d"upload-webmap-form" action\x3d"" method\x3d"post" dojoAttachEvent\x3d"onSubmit:uploadItem"\x3e\x3c!--,onKeyDown:onKeyDown--\x3e\r\n      \x3cdiv id\x3d"save-webmap-content"\x3e\r\n        \x3ctable cellspacing\x3d"6"\x3e\r\n        \t\x3ctbody\x3e\r\n        \t\t\x3ctr\x3e\r\n        \t\t\t\x3ctd\x3e\r\n                \x3clabel for\x3d"save-webmap-title"\x3e\r\n                  ${i18n.titleLabel}\r\n                \x3c/label\x3e\r\n        \t\t\t\x3c/td\x3e\r\n              \x3ctd width\x3d"70%"\x3e\r\n\t\t\t          \x3cdiv dojoAttachPoint\x3d"_webMapTitleInput" id\x3d"save-webmap-title" dojotype\x3d"dijit.form.TextBox" dojoAttachEvent\x3d"onFocus:focusTitle" trim\x3d"true" maxlength\x3d"250" required\x3d"true" style\x3d"width:100%;padding:2px 0 2px 0;"\x3e\r\n\t\t\t          \x3c/div\x3e\r\n              \x3c/td\x3e\r\n        \t\t\x3c/tr\x3e\r\n\t\t\t\t\t\t\x3ctr\x3e\r\n\t\t\t\t\t\t\t\x3ctd valign\x3d"top"\x3e\r\n\t\t            \x3clabel for\x3d"save-webmap-tags"\x3e\r\n\t\t              ${i18n.tagsLabel}\r\n\t\t            \x3c/label\x3e\r\n\t\t\t\t\t\t\t\x3c/td\x3e\r\n              \x3ctd\x3e\r\n\t\t\t          \x3cdiv data-dojo-attach-point\x3d"_webMapTagsInput" id\x3d"save-webmap-tags" data-dojo-type\x3d"esri/dijit/Tags" data-dojo-props\x3d"minWidth:\'377px\', maxWidth:\'377px\'"\x3e\r\n\t\t\t          \x3c/div\x3e\r\n\t\t\t          \x3c!--\x3cdiv dojoAttachPoint\x3d"_webMapTagsInput" id\x3d"save-webmap-tags" dojotype\x3d"dijit.form.TextBox" placeHolder\x3d"${defaultTextTags}" dojoAttachEvent\x3d"onFocus:focusTags" trim\x3d"true" required\x3d"true" style\x3d"width:100%;padding:2px 0 2px 0;"\x3e--\x3e\r\n\t\t\t          \x3c!--\x3c/div\x3e--\x3e\r\n\t\t\t          \x3c!--\x3cdiv class\x3d"esriItemLinks"\x3e--\x3e\r\n\t\t\t            \x3c!--\x3ca dojoAttachEvent\x3d"onclick:showUserTags" href\x3d"JavaScript:arcgisonline.sharing.util.doNothing();" style\x3d"line-height:20px;"\x3e${i18n.chooseTags}\x3c/a\x3e--\x3e\r\n\t\t\t          \x3c!--\x3c/div\x3e--\x3e\r\n              \x3c/td\x3e\r\n\t\t\t\t\t\t\x3c/tr\x3e\r\n            \x3ctr\x3e\r\n              \x3ctd\x3e\r\n\t\t            \x3clabel for\x3d"save-webmap-summary"\x3e\r\n\t\t              ${i18n.summaryLabel}\r\n\t\t            \x3c/label\x3e\r\n              \x3c/td\x3e\r\n              \x3ctd\x3e\r\n\t\t\t          \x3cdiv dojoAttachPoint\x3d"_webMapSummaryInput" id\x3d"save-webmap-summary" dojotype\x3d"dijit.form.TextBox" dojoAttachEvent\x3d"onFocus:focusSummary" trim\x3d"true" maxlength\x3d"250" required\x3d"true" style\x3d"width:100%;padding:2px 0 2px 0;"\x3e\r\n\t\t\t          \x3c/div\x3e\r\n              \x3c/td\x3e\r\n            \x3c/tr\x3e\r\n            \x3ctr\x3e\r\n              \x3ctd\x3e\r\n\t\t            \x3clabel for\x3d"save-webmap-folder"\x3e\r\n\t\t              ${i18n.saveFolder}\r\n\t\t            \x3c/label\x3e\r\n              \x3c/td\x3e\r\n              \x3ctd\x3e\r\n\t\t            \x3cdiv class\x3d"arrowSpaceMedium" dojoAttachPoint\x3d"_webMapFolderSelect" id\x3d"save-webmap-folder" dojotype\x3d"arcgisonline.sharing.dijit.ComboBox" dojoAttachEvent\x3d"onChange:onChangeFolder" trim\x3d"true" style\x3d"width:100%;"\x3e\r\n                \x3c/div\x3e\r\n              \x3c/td\x3e\r\n            \x3c/tr\x3e\r\n        \t\x3c/tbody\x3e\r\n\t\t\t\t\x3c/table\x3e\r\n        \x3cdiv style\x3d"clear:both;"\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv class\x3d"esriFloatTrailing"\x3e\r\n          \x3cbutton id\x3d"save-webmap-ok" dojotype\x3d"dijit.form.Button" class\x3d"primary" dojoAttachPoint\x3d"_saveMapBtn" dojoAttachEvent\x3d"onClick:uploadItem" type\x3d"submit"\x3e\r\n            ${i18n.saveMap}\r\n          \x3c/button\x3e\r\n          \x3cbutton dojotype\x3d"dijit.form.Button" class\x3d"cancel" dojoAttachPoint\x3d"_cancelBtn" dojoAttachEvent\x3d"onClick:_handleCancelBtn" type\x3d"button" tabindex\x3d"1"\x3e\r\n            ${i18n.cancel}\r\n          \x3c/button\x3e\r\n        \x3c/div\x3e\r\n        \x3cbr/\x3e\r\n        \x3cdiv dojoAttachPoint\x3d"_waitingDiv" style\x3d"clear:both;display:none;"\x3e\r\n          ${i18n.savingMapMsg}\r\n        \x3c/div\x3e\r\n        \x3cdiv dojoAttachPoint\x3d"_webMapDescriptionInput" dojotype\x3d"dijit.form.TextBox" type\x3d"hidden" value\x3d""\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv dojoAttachPoint\x3d"_webMapAccessInput" dojotype\x3d"dijit.form.TextBox" type\x3d"hidden" value\x3d""\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv dojoAttachPoint\x3d"_webMapLicenseInput" dojotype\x3d"dijit.form.TextBox" type\x3d"hidden" value\x3d""\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv style\x3d"clear:both;"\x3e\r\n        \x3c/div\x3e\r\n      \x3c/div\x3e\r\n    \x3c/form\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e\r\n',
mapLayers:null,mapExtent:null,folderId:"",allItemNames:[],init:!1,defaultTextTitle:"",defaultTextTags:"",defaultTextSummary:"",folders:{},foldersJson:null,_saveWebMapDialog:null,_saveWebMapForm:null,_errorDiv:null,_saveMapBtn:null,_cancelBtn:null,_webMapTitleInput:null,_webMapTagsInput:null,_webMapSummaryInput:null,_webMapFolderSelect:null,_webMapDescriptionInput:null,_webMapAccessInput:null,_webMapLicenseInput:null,_waitingDiv:null,i18n:null,statics:{_instance:null,getInstance:function(){null==this._instance&&
(this._instance=new arcgisonline.sharing.dijit.dialog.SaveWebMapDlg);return this._instance}},postMixInProperties:function(){this.inherited(arguments);this.i18n=a.i18n.getLocalization("arcgisonline","arcgisonline").common;a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").saveWebMapDlg);this.defaultTextTitle=this.i18n.enterMapTitle;this.defaultTextTags=this.i18n.separateTags;this.defaultTextSummary=this.i18n.descriptionOfMap},postCreate:function(){this.init||(this.getFolders(),
this.init=!0)},show:function(b){this.clear();this._saveMapBtn.set("disabled",!1);this._cancelBtn.set("disabled",!1);a.style(this._waitingDiv,"display","none");b=arcgisonline.sharing.util.getUser();arcgisonline.sharing.util.loadUserTags(b.username).then(a.hitch(this,function(a){this._webMapTagsInput.set("knownTags",a);this._saveWebMapDialog.show()}))},clear:function(){this._webMapTitleInput.set("value",this.defaultTextTitle);a.style(a.byId("save-webmap-title"),"color","#999999");this._webMapSummaryInput.set("value",
this.defaultTextSummary);a.style(this._webMapSummaryInput.domNode,"color","#999999");this._errorDiv.innerHTML="";a.removeClass(this._errorDiv,"error")},_handleCancelBtn:function(a){a.preventDefault();this.errorHandler&&this.errorHandler();this._saveWebMapDialog.hide()},hide:function(){this._saveWebMapDialog.hide()},getItemTitles:function(b){var c=arcgisonline.sharing.util.getUser();if(null!=c){var f=function(d,k){for(i=0;i<d.items.length;i++)"Web Map"===d.items[i].type&&this.allItemNames.push(d.items[i].title.toLowerCase());
if(0<d.nextStart){var h=esriGeowConfig.restBaseUrl+"content/users/"+c.email;this.folderId&&(h+="/"+this.folderId);h+="?num\x3d100\x26start\x3d"+d.nextStart;arcgisonline.sharing.util.getJson(h,a.hitch(this,f),a.hitch(this,e))}else b&&b()},e=function(a,b){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.errorTitle,message:"Search for all maps failed ("+a.message+")."})};this.allItemNames=[];var g=esriGeowConfig.restBaseUrl+"content/users/"+c.email;this.folderId&&
(g+="/"+this.folderId);arcgisonline.sharing.util.getJson(g+"?num\x3d100",a.hitch(this,f),a.hitch(this,e))}},getFolders:function(){var b=arcgisonline.sharing.util.getUser();if(null!=b){var c=new a.data.ItemFileWriteStore({data:{identifier:"name",items:[]}});c.newItem({name:b.email,id:""});this._webMapFolderSelect.set("store",c);this._webMapFolderSelect.set("value",b.email);arcgisonline.sharing.geow.Folder.getFolders(a.hitch(this,function(b,e){var g=null;if(a.cookie("ESRI_Content")){var d=arcgisonline.sharing.util.getCookie("ESRI_Content");
d.folderId&&(g=d.folderId)}this.foldersJson=b.folders;a.forEach(b.folders,function(a,b){c.newItem({name:a.title,id:a.id});eval("this.folders.id"+a.id+' \x3d "'+a.title.replace(/\"/g,'\\"')+'"');g===a.id&&(this._webMapFolderSelect.set("value",a.title),this.folderId=g)},this)}),a.hitch(this,function(b,e){console.error("Search for all folders failed "+(b?a.json.stringify(b):b))}))}},addWebMapItem:function(b,c,f,e,g,d){this.savedHandler=g;this.errorHandler=d;f=this._saveWebMapDialog;null==f?f=new arcgisonline.sharing.dijit.dialog.SaveWebMapDlg:
(this._saveMapBtn.set("disabled",!1),this._cancelBtn.set("disabled",!1),a.style(this._waitingDiv,"display","none"));f=arcgisonline.sharing.util.getUser();arcgisonline.sharing.util.loadUserTags(f.username).then(a.hitch(this,function(d){this._webMapTagsInput.set("knownTags",d);this.clear();this.mapLayers=b;this.mapExtent=c;null==this.folderId?(d=arcgisonline.sharing.util.getUser(),this._webMapFolderSelect.set("value",d.email)):eval("this.folders.id"+this.folderId)?this._webMapFolderSelect.set("value",
eval("this.folders.id"+this.folderId)):setTimeout(a.hitch(this,"selectCurrentFolder",this.folderId,0),1E3);this.getItemTitles(a.hitch(this,function(){if(null!=e){for(var b=e.title+"-Copy";-1<a.indexOf(this.allItemNames,b.toLowerCase());)b+="-Copy";this._webMapTitleInput.get("value")==e.title+"-Copy"&&this._webMapTitleInput.set("value",b)}}));null!=e&&(this._webMapTitleInput.set("value",e.title+this.i18n.copyTitle),a.style(a.byId("save-webmap-title"),"color","#000000"),this._webMapTagsInput.set("value",
e.tags),this._webMapSummaryInput.set("value",e.snippet),a.style(this._webMapSummaryInput.domNode,"color","#000000"),this._webMapDescriptionInput.set("value",e.description),this._webMapAccessInput.set("value",e.accessInformation),this._webMapLicenseInput.set("value",e.licenseInfo),"_r_"==e.description&&(this._webMapDescriptionInput.set("value",""),arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+e.id,a.hitch(this,function(a,b){this._webMapDescriptionInput.set("value",a.description)}))));
this._saveWebMapDialog.show()}))},selectCurrentFolder:function(b,c){!eval("this.folders.id"+b)&&10>c?setTimeout(a.hitch(this,"selectCurrentFolder",b,c+1),1E3):eval("this.folders.id"+b)&&this._webMapFolderSelect.set("value",eval("this.folders.id"+b))},onChangeFolder:function(){var a=this._webMapFolderSelect.item;a&&(this.folderId=this._webMapFolderSelect.store.getValue(a,"id"),this.getItemTitles())},uploadItem:function(b){b.preventDefault();var c=[];a.forEach(arcgisonline.map.main.mapLayers,function(a,
b){arcgisonline.map.featColl.isFeatureCollection(a)&&a.dataChanged&&c.push(arcgisonline.map.itemData.uploadItemLayerInfos(a))},this);c.length?(new a.DeferredList(c)).addCallback(a.hitch(this,function(a){this.uploadItem_AfterFCItemCheck()})):this.uploadItem_AfterFCItemCheck()},uploadItem_AfterFCItemCheck:function(){this._saveMapBtn.get("disabled")||(this._saveMapBtn.set("disabled",!0),this._cancelBtn.set("disabled",!0),a.style(this._waitingDiv,"display","inline-block"),this.mapExtent.spatialReference._isWrappable()?
esri.geometry.normalizeCentralMeridian([this.mapExtent],null,a.hitch(this,function(b){if(b[0].rings){var c=(new esri.geometry.Polygon(this.mapExtent.spatialReference)).addRing(b[0].rings[0]).getExtent();b=(new esri.geometry.Polygon(this.mapExtent.spatialReference)).addRing(b[0].rings[1]).getExtent();c=c.getWidth()>b.getWidth()?c:b;arcgisonline.map.main.extentToGCSString(c,a.hitch(this,"saveWebMap"))}else arcgisonline.map.main.extentToGCSString(b[0],a.hitch(this,"saveWebMap"))})):arcgisonline.map.main.extentToGCSString(this.mapExtent,
a.hitch(this,"saveWebMap")))},saveWebMap:function(b){var c=arcgisonline.map.storage.buildWebMapText(),f=arcgisonline.sharing.util.getUser(),e=a.trim(this._webMapTitleInput.get("value"));this._webMapTagsInput.set("value",this._webMapTagsInput.get("value"));var g=this.toFileCharacters(e)+"_"+(new Date).getTime(),d=this._webMapTagsInput.get("value");if(!e||!e.length||e===this.defaultTextTitle)this._webMapFolderSelect.focus(),b=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),
!d||0===d.length?b.show({title:this.i18n.errorTitle,message:this.i18n.error.provideTitleAndTags}):b.show({title:this.i18n.errorTitle,message:this.i18n.error.provideTitle}),this._saveMapBtn.set("disabled",!1),this._cancelBtn.set("disabled",!1),a.style(this._waitingDiv,"display","none");else if(-1<e.indexOf("\x3c")||-1<e.indexOf("\x3e"))this._webMapFolderSelect.focus(),b=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),b.show({title:this.i18n.errorTitle,message:this.i18n.error.specialCharaters}),
this._saveMapBtn.set("disabled",!1),this._cancelBtn.set("disabled",!1),a.style(this._waitingDiv,"display","none");else if(-1<a.indexOf(this.allItemNames,e.toLowerCase()))this._webMapFolderSelect.focus(),b=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),b.show({title:this.i18n.errorTitle,message:a.string.substitute(this.i18n.error.mapTitleExists,[e])}),this._saveMapBtn.set("disabled",!1),this._cancelBtn.set("disabled",!1),a.style(this._waitingDiv,"display","none");else if(!d||
0===d.length)this._webMapFolderSelect.focus(),b=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),b.show({title:this.i18n.errorTitle,message:this.i18n.error.provideTags}),this._saveMapBtn.set("disabled",!1),this._cancelBtn.set("disabled",!1),a.style(this._waitingDiv,"display","none");else{d=this._webMapSummaryInput.get("value");d==this.defaultTextSummary&&(d="",this._webMapSummaryInput.set("value",""),a.style(this._webMapSummaryInput.domNode,"color","#000000"));var k="Web Map,Explorer Web Map,Map,Online Map,ArcGIS Online";
arcgisonline.map.save_open.webMapItemCard&&arcgisonline.map.save_open.webMapItemCard.typeKeywords&&(k=arcgisonline.map.save_open.webMapItemCard.typeKeywords.toString());k=arcgisonline.map.main.adjustWebMapTypeKeywords(k);b={item:g,title:e,tags:this._webMapTagsInput.get("value"),snippet:d,description:this._webMapDescriptionInput.get("value"),accessInformation:this._webMapAccessInput.get("value"),licenseInfo:this._webMapLicenseInput.get("value"),extent:b,text:a.json.stringify(c),type:"Web Map",typeKeywords:k,
overwrite:!1};if(d=this._webMapFolderSelect.item)this.folderId=this._webMapFolderSelect.store.getValue(d,"id");else{var h=this._webMapFolderSelect.get("value");a.forEach(this.foldersJson,function(a,b){a.title==h&&(this.folderId=a.id)},this)}f=arcgisonline.sharing.util.getUser();d=esriGeowConfig.restBaseUrl+"content/users/"+f.email;esri.isDefined(this.folderId)&&this.folderId.length&&(d+="/"+this.folderId);arcgisonline.sharing.util.postJsonCheckProxy(b,d+"/addItem",a.hitch(this,function(b,d){b.success&&
(arcgisonline.map.save_open.openedWebMap=c,a.publish("onWebMapSave",[b.id,f.email,g,g,e,this._webMapDescriptionInput.get("value"),this._webMapTagsInput.get("value").split(","),this._webMapSummaryInput.get("value"),null,this._webMapAccessInput.get("value"),this._webMapLicenseInput.get("value"),this.folderId,k.split(",")]),arcgisonline.map.role.updateUIAfterSaveAs(),this.savedHandler&&this.savedHandler(b.id),arcgisonline.map.thumbnail.buildThumbnailURLFromMap(a.hitch(this,function(b){var c=esriGeowConfig.restBaseUrl+
"content/users/"+f.email;esri.isDefined(this.folderId)&&this.folderId.length&&(c+="/"+this.folderId);c+="/items/"+arcgisonline.map.save_open.webMapInfo.id+"/update";arcgisonline.sharing.util.postJsonCheckProxy({thumbnailURL:b},c,a.hitch(this,function(a){arcgisonline.map.save_open.webMapInfo&&(arcgisonline.map.save_open.webMapInfo.thumbnail="thumbnail/ago_downloaded.png")}))})),this._saveWebMapDialog.hide())}),a.hitch(this,function(b,c){if(409==b.code){this._webMapFolderSelect.focus();var d=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();
d.show({title:this.i18n.errorTitle,message:a.string.substitute(this.i18n.error.mapTitleExists,[e])})}else this._webMapFolderSelect.focus(),d=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),d.show({title:this.i18n.errorTitle,message:a.string.substitute(this.i18n.error.requestFailed,[e,b.message])});this._saveMapBtn.set("disabled",!1);this._cancelBtn.set("disabled",!1);a.style(this._waitingDiv,"display","none");this.errorHandler&&this.errorHandler(b)}))}},showUserTags:function(a){arcgisonline.sharing.dijit.dialog.TagsDlg.prototype.statics.getInstance().show()},
focusTitle:function(b){this._webMapTitleInput.get("value")==this.defaultTextTitle&&(this._webMapTitleInput.set("value",""),a.style(a.byId("save-webmap-title"),"color","#000000"))},focusTags:function(a){},focusSummary:function(b){this._webMapSummaryInput.get("value")==this.defaultTextSummary&&(this._webMapSummaryInput.set("value",""),a.style(this._webMapSummaryInput.domNode,"color","#000000"))},onHide:function(a){this.clear()},onKeyDown:function(a){var c;window.event?c=a.keyCode:a.which&&(c=a.which);
13==c&&this.uploadItem(a)},toFileCharacters:function(a){a=a.replace(/\ /g,"_");return a=a.toLowerCase()},checkString:function(a){var c=!1;return c=/[\u0021-\u002f\u003a-\u0040\u005b-\u005e\u0060\u007b-\u007e]/g.test(a)}})});