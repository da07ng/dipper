// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/dijit/renderer/_RatioMixin","dojo/_base/declare dojo/_base/lang dojo/_base/connect dojo/_base/array dojo/_base/Color dojo/dom dojo/Deferred dojo/dom-construct esri/lang esri/symbols/jsonUtils esri/styles/basic esri/numberUtils esri/renderers/smartMapping esri/styles/choropleth esri/plugins/FeatureLayerStatistics esri/dijit/ColorInfoSlider esri/dijit/ClassedColorSlider esri/renderers/SimpleRenderer esri/renderers/ClassBreaksRenderer esri/symbols/SimpleLineSymbol esri/symbols/SimpleFillSymbol arcgisonline/map/dijit/renderer/ColorGrid".split(" "),
function(p,e,q,r,s,t,m,u,v,w,x,l,n,y,z,A,B,C,D,E,F,G){return{buildRatioRenderer:function(d){var a=new m;setTimeout(function(){a.progress(a)},1);d=d||{};if(this.isFeatColl||this.isCSV||this.hasDynamic)this.buildRatioRendererGo(null,d,a);else if("esri.renderer.UniqueValueRenderer"===this.renderer.declaredClass)if(this.isOwnerOfHostedFS){var b=this.layer.getEditCapabilities();!this.layer.isEditable()||!b.canCreate&&(b.canUpdate||b.canDelete)||this.mapLayer.featureTemplatesChanged?this.buildRatioRendererGo(!0,
d,a):arcgisonline.map.edit.hasDefaultTypesAndTemplates(this.layer)?this.buildRatioRendererGo(!0,d,a):arcgisonline.sharing.dijit.dialog.ChoiceDlg.prototype.statics.getInstance().show({title:this.i18n.warning,message:this.i18n.featureTypesAndTemplatesWarning,choiceOneTitle:this.i18n.yesLabel,choiceOneHandler:e.hitch(this,function(){this.buildRatioRendererGo(!0,d,a)}),choiceTwoTitle:this.i18n.noLabel,choiceTwoHandler:e.hitch(this,function(){!a.isRejected()&&a.reject()})})}else this.buildRatioRendererGo(null,
d,a);else this.buildRatioRendererGo(null,d,a);return a},buildRatioRendererGo:function(d,a,b){arcgisonline.map.dynLayer.checkDynamicLayers(this.mapLayer);var g=a.attributeItem||this.attributeItem,h=a.attributeItem2||this.attributeItem2,k=null;this.renderer.visualVariables&&"ratio"===this.getRendererType(this.renderer)&&(k=this.getVisualVariablesExceptTypes([{type:"colorInfo"},{type:"sizeInfo",target:"outline"}],this.renderer.visualVariables));n.createColorRenderer({layer:this.fLayer||this.layer,field:g.name,
normalizationType:"field",normalizationField:h.name,theme:"above-and-below",basemap:this.getBasemapType(),optimizeOutline:!0,showOthers:!0}).then(e.hitch(this,function(c){b.isRejected()||(this.scheme=c.scheme,this.onCalculationsSource&&c.statistics&&this.onCalculationsSource(c.statistics.source),d&&(arcgisonline.map.edit.removeTypesAndTemplatesOnLayer(this.mapLayer.layer),this.mapLayer.featureTemplatesChanged=!0),this.authoringInfo={visualVariables:[{type:"colorInfo",minSliderValue:esri.isDefined(a.minValue)?
a.minValue:c.statistics.min,maxSliderValue:esri.isDefined(a.maxValue)?a.maxValue:c.statistics.max,theme:"above-and-below",style:"ratio"}]},k&&(c.renderer.visualVariables?c.renderer.setVisualVariables(c.renderer.visualVariables.concat(k)):c.renderer.setVisualVariables(k)),c.renderer=this.updateRendererProperties(a,c.renderer),b.resolve({renderer:c.renderer,statistics:c.statistics}))}),e.hitch(this,function(a){b.isRejected()||(this.handleError(a,"createRatioRenderer",!0),b.reject())}))},applyRatioRenderer:function(d,
a){d.authoringInfo&&(d.authoringInfo.classificationMethod?d.classificationMethod=d.authoringInfo.classificationMethod:delete d.classificationMethod);var b=this.getRendererStyle((this.fLayer||this.layer).renderer);this.setRenderer(d);!this.hasDynamic&&("ratio"!==b&&this.scheme&&esri.isDefined(this.scheme.opacity))&&(this.layer.setOpacity(this.scheme.opacity),this.transparencySlider&&this.transparencySlider.set("value",1-this.scheme.opacity));(arcgisonline.map.featColl.isFeatureCollection(this.mapLayer)||
this.isCSV)&&arcgisonline.map.main.markMapAsChanged("onRendererChange");this.isOwnerOfHostedFS&&!this.layer.templates.length&&arcgisonline.map.edit.createTypesAndTemplatesOnLayer(this.layer);this.updateLegendPopup()},switchStyleOnSlider:function(d){this.updateStopLabels(d);this.updateColorSlider(this.renderer);this.applyColorRenderer(this.renderer)},centerHandlesOnSlider:function(d){var a=this.getVisualVariableByType("colorInfo",null,this.renderer.visualVariables),b=this.getVisualVariableByType("colorInfo",
null,this.renderer.authoringInfo.visualVariables),g=b.style&&"percent"===b.style,h=b.style&&"percentTotal"===b.style;this.getStatistics({field:a.field,normalizationType:"field",normalizationField:a.normalizationField}).then(e.hitch(this,function(b){var c;if("average"===d){var e=b.avg,f=Math.max(e-b.stddev,b.min);c=Math.min(e+b.stddev,b.max);c=l.round([f,c]);f=c[0];c=c[1];c=[Math.max(f,b.min),Math.max(f+(e-f)/2,b.min),e,Math.min(e+(c-e)/2,b.max),Math.min(c,b.max)]}else{var f=Math.max(1-b.stddev,b.min);
c=Math.min(1+b.stddev,b.max);c=l.round([f,c]);f=c[0];c=c[1];c=[Math.max(f,b.min),Math.max(f+(1-f)/2,b.min),1,Math.min(1+(c-1)/2,b.max),Math.min(c,b.max)]}c=l.round(c);a.stops[0].value=c[0];a.stops[0].label="\x3c "+this.getStopLabel(c[0],g,h);a.stops[1].value=c[1];a.stops[1].label=null;a.stops[2].value=c[2];a.stops[2].label=this.getStopLabel(c[2],g,h);a.stops[3].value=c[3];a.stops[3].label=null;a.stops[4].value=c[4];a.stops[4].label="\x3e "+this.getStopLabel(c[4],g,h);this.replaceVisualVariable("colorInfo",
null,a,this.renderer);this.updateColorSlider(this.renderer);this.applyColorRenderer(this.renderer)}))},updateStopLabels:function(d){var a=this.getVisualVariableByType("colorInfo",null,this.renderer.visualVariables),b=this.getVisualVariableByType("colorInfo",null,this.renderer.authoringInfo.visualVariables);d=d||b.style;"percent"===d?(a.stops[0].label="\x3c "+this.getStopLabel(a.stops[0].value,!0,!1),a.stops[2].label=this.getStopLabel(a.stops[2].value,!0,!1),a.stops[4].label="\x3e "+this.getStopLabel(a.stops[4].value,
!0,!1)):"percentTotal"===d?(a.stops[0].label="\x3c "+this.getStopLabel(a.stops[0].value,!1,!0),a.stops[2].label=this.getStopLabel(a.stops[2].value,!1,!0),a.stops[4].label="\x3e "+this.getStopLabel(a.stops[4].value,!1,!0)):(a.stops[0].label="\x3c "+this.getStopLabel(a.stops[0].value,!1,!1),a.stops[2].label=this.getStopLabel(a.stops[2].value,!1,!1),a.stops[4].label="\x3e "+this.getStopLabel(a.stops[4].value,!1,!1));this.replaceVisualVariable("colorInfo",null,a,this.renderer)},getStopLabel:function(d,
a,b){return b?""+this.formatNumber(arcgisonline.map.main.roundValue(100*(d/(1+d)),100))+"%":a?""+this.formatNumber(arcgisonline.map.main.roundValue(100*d,100))+"%":""+this.formatNumber(arcgisonline.map.main.roundValue(d,100))},getStatistics:function(d){var a=new m;(this.fLayer||this.layer).addPlugin("esri/plugins/FeatureLayerStatistics").then(e.hitch(this,function(){(this.fLayer||this.layer).statisticsPlugin.getFieldStatistics(d).then(e.hitch(this,function(b){a.isRejected()||a.resolve(b)}),e.hitch(this,
function(b){a.isRejected()||(this.handleError(b,"getFieldStatistics",!1),e.hitch(this,createWidget,d,a)())}))}),e.hitch(this,function(b){a.isRejected()||(this.handleError(b,"addPlugin",!1),a.reject())}));return a}}});