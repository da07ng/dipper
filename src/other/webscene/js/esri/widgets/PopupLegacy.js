// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../core/declare dojo/_base/lang dojo/_base/array dojo/_base/kernel dojo/has dojo/on dojo/window dojo/Stateful dojo/dom dojo/dom-attr dojo/dom-class dojo/dom-construct dojo/dom-geometry dojo/dom-style dijit/registry ../core/lang ../core/domUtils ../geometry/Polyline ../geometry/Polygon ./PopupLegacy/InfoWindowBase ./PopupLegacy/PopupBase dojo/i18n!./PopupLegacy/nls/PopupLegacy dojo/NodeList-dom require require".split(" "),function(D,t,v,g,E,p,F,G,B,z,e,C,A,n,H,q,I,J,K,L,M,N){return D([L,M,
G],{declaredClass:"esri.widgets.Popup",offsetX:3,offsetY:3,zoomFactor:4,marginLeft:25,marginTop:25,highlight:!0,pagingControls:!0,pagingInfo:!0,keepHighlightOnHide:!1,popupWindow:!0,titleInBody:!0,anchor:"auto",visibleWhenEmpty:!0,hideDelay:1E3,location:null,constructor:function(a,c){this.initialize();t.mixin(this,a);this.domNode=B.byId(c);var b=this._nls=t.mixin({},N.widgets.popup),d=this.domNode;e.add(d,"esri-popup");(this._isRTL=!A.isBodyLtr())&&n.set(d,"direction","rtl");z.set(d,"innerHTML","\x3cdiv class\x3d'esri-popup-wrapper' style\x3d'position: absolute;'\x3e\x3cdiv class\x3d'sizer'\x3e\x3cdiv class\x3d'title-pane'\x3e\x3cdiv class\x3d'spinner hidden' title\x3d'"+
b.NLS_searching+"...'\x3e\x3c/div\x3e\x3cdiv class\x3d'title'\x3e\x3c/div\x3e\x3cdiv class\x3d'title-button prev hidden' title\x3d'"+b.NLS_prevFeature+"'\x3e\x3c/div\x3e\x3cdiv class\x3d'title-button next hidden' title\x3d'"+b.NLS_nextFeature+"'\x3e\x3c/div\x3e\x3cdiv class\x3d'title-button maximize' title\x3d'"+b.NLS_maximize+"'\x3e\x3c/div\x3e\x3cdiv class\x3d'title-button close' title\x3d'"+b.NLS_close+"'\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d'sizer content'\x3e\x3cdiv class\x3d'content-pane'\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d'sizer'\x3e\x3cdiv class\x3d'actions-pane'\x3e\x3cdiv class\x3d'action-list hidden'\x3e\x3ca title\x3d"+
b.NLS_zoomTo+" class\x3d'action zoom-to' href\x3d'javascript:void(0);'\x3e\x3cspan\x3e"+b.NLS_zoomTo+"\x3c/span\x3e\x3c/a\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d'pointer hidden'\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d'outer-pointer hidden'\x3e\x3c/div\x3e");this._sizers=g.query(".sizer",d);b=g.query(".title-pane",d)[0];B.setSelectable(b,!1);this._title=g.query(".title",b)[0];this._prevFeatureButton=g.query(".prev",b)[0];this._nextFeatureButton=g.query(".next",b)[0];this._maxButton=
g.query(".maximize",b)[0];this._spinner=g.query(".spinner",b)[0];this._contentPane=g.query(".content-pane",d)[0];this._positioner=g.query(".esri-popup-wrapper",d)[0];this._pointer=g.query(".pointer",d)[0];this._outerPointer=g.query(".outer-pointer",d)[0];this._actionList=g.query(".actions-pane .action-list",d)[0];this._eventConnections=[p(g.query(".close",b)[0],"click",this.hide.bind(this)),p(this._prevFeatureButton,"click",this.selectPrevious.bind(this)),p(this._nextFeatureButton,"click",this.selectNext.bind(this)),
p(this._maxButton,"click",this._toggleSize.bind(this)),p(g.query(".zoom-to",this._actionList)[0],"click",this._zoomToFeature.bind(this)),this.on("clear-features",this._featuresCleared.bind(this)),this.on("selection-change",this._featureSelected.bind(this)),this.on("dfd-complete",this._updateUI.bind(this))];E("esri-touch")&&(d=I.setScrollable(this._contentPane),this._eventConnections.push(d[0],d[1]));this._toggleVisibility(!1)},getTitle:function(a){return this._readTemplate(a,"title",!0)},getContent:function(a){return this._readTemplate(a,
"content",!0)},_readTemplate:function(a,c,b){var d=a.getEffectivePopupTemplate();c=d&&d[c];var f=typeof c;"function"===f?c=c.call(d,a):"string"===f&&(f=(d=a.layer)&&d._getDateOpts,c=q.substitute(a.attributes,c,{first:b,dateFormat:f&&f.call(d)}));return c},setMap:function(a){this.inherited(arguments);C.place(this.domNode,this.view.root);this.highlight&&this.enableHighlight(a);this._maxHeight=n.get(this._contentPane,"maxHeight")},unsetMap:function(){this.disableHighlight(this.map);this.inherited(arguments)},
setTitle:function(a){if(this.popupWindow){if(!q.isDefined(a)||""===a)a="\x26nbsp;";this.destroyDijits(this._title);this.place(a,this._title);this.isShowing&&(this.startupDijits(this._title),this.reposition())}},setContent:function(a){if(this.popupWindow){if(!q.isDefined(a)||""===a)a="\x26nbsp;";this.destroyDijits(this._contentPane);this.place(a,this._contentPane);this.isShowing&&(this.startupDijits(this._contentPane),this.reposition())}},show:function(a,c){if(this.popupWindow)if(this._delayHide=!1,
a){var b=this.map,d=this.view||b.view;a.spatialReference?(this.location=a,b=d.toScreen(a)):(this.location=d.toMap(a),b=a);var f=d._getFrameWidth?d._getFrameWidth():-1;if(-1!==f&&(b.x%=f,0>b.x&&(b.x+=f),d.width>f))for(d=(d.width-f)/2;b.x<d;)b.x+=f;this._maximized?this.restore():this._setPosition(b);c&&c.closestFirst&&this.showClosestFirst(this.location);this.isShowing||(this._toggleVisibility(!0),this._followMap(),this.startupDijits(this._title),this.startupDijits(this._contentPane),this.reposition(),
this.showHighlight(),this.inherited(arguments))}else this._toggleVisibility(!0)},hide:function(){this.isShowing&&(this._toggleVisibility(!1),this._unfollowMap(),this.keepHighlightOnHide||this.hideHighlight(),this.inherited(arguments))},resize:function(a,c){this.popupWindow&&(this._sizers.style({width:a+"px"}),n.set(this._contentPane,"maxHeight",c+"px"),this._maxHeight=c,this.isShowing&&this.reposition())},reposition:function(){this.popupWindow&&this.view&&(this.location&&!this._maximized&&this.isShowing)&&
this._setPosition(this.view.toScreen(this.location))},maximize:function(){var a=this.view;if(a&&!this._maximized&&this.popupWindow){this._maximized=!0;var c=this._maxButton;e.remove(c,"maximize");e.add(c,"restore");z.set(c,"title",this._nls.NLS_restore);var c=this.marginLeft,b=this.marginTop,d=a.width-2*c,a=a.height-2*b;n.set(this.domNode,{left:this._isRTL?null:c+"px",right:this._isRTL?c+"px":null,top:b+"px",bottom:null});n.set(this._positioner,{left:null,right:null,top:null,bottom:null});this._savedWidth=
n.get(this._sizers[0],"width");this._savedHeight=n.get(this._contentPane,"maxHeight");this._sizers.style({width:d+"px"});n.set(this._contentPane,{maxHeight:a-65+"px",height:a-65+"px"});this._showPointer("");this._unfollowMap();e.add(this.domNode,"esri-popup-maximized");this.emit("maximize")}},restore:function(){if(this.view&&this._maximized&&this.popupWindow){this._maximized=!1;var a=this._maxButton;e.remove(a,"restore");e.add(a,"maximize");z.set(a,"title",this._nls.NLS_maximize);n.set(this._contentPane,
"height",null);this.resize(this._savedWidth,this._savedHeight);this._savedWidth=this._savedHeight=null;this.show(this.location);this._followMap();e.remove(this.domNode,"esri-popup-maximized");this.emit("restore")}},startup:function(){},destroy:function(){this.map&&this.unsetMap();this.cleanup();this.isShowing&&this.hide();this.destroyDijits(this._title);this.destroyDijits(this._content);v.forEach(this._eventConnections,function(a){a.remove()});C.destroy(this.domNode);this._sizers=this._contentPane=
this._actionList=this._positioner=this._pointer=this._outerPointer=this._title=this._prevFeatureButton=this._nextFeatureButton=this._spinner=this._eventConnections=this._pagerScope=this._targetLocation=this._nls=this._maxButton=null},selectNext:function(){this.select(this.selectedIndex+1)},selectPrevious:function(){this.select(this.selectedIndex-1)},setFeatures:function(){this.inherited(arguments);this._updateUI()},postscript:null,_highlightSetter:function(a){var c=this.highlight,b=this.map;this.highlight=
a;if(b&&a!==c)if(a){if(this.enableHighlight(b),a=this.features&&this.features[this.selectedIndex])this.updateHighlight(b,a),this.showHighlight()}else this.disableHighlight(b)},_pagingControlsSetter:function(a){var c=this.pagingControls,b=this.map;this.pagingControls=a;b&&a!==c&&this._updatePagingControls()},_pagingInfoSetter:function(a){var c=this.pagingInfo,b=this.map;this.pagingInfo=a;b&&(a!==c&&this.features&&this.features.length)&&this._updatePagingInfo()},_popupWindowSetter:function(a){var c=
this.popupWindow,b=this.map;this.popupWindow=a;b&&a!==c&&(a?(this._updateUI(),this._updateWindow()):(this.hide(),this.showHighlight()))},_anchorSetter:function(a){var c=this.anchor;this.anchor=a;this.map&&a!==c&&this.reposition()},_featuresCleared:function(){this.setTitle("\x26nbsp;");this.setContent("\x26nbsp;");this._setPagerCallbacks(this);this._updateUI();this.hideHighlight()},_featureSelected:function(){this._updateUI();this._updateWindow()},_updateWindow:function(){var a=this.selectedIndex;
if(0<=a){var c=this.getContent(this.features[a]),b;!this.titleInBody&&c&&t.isString(c.id)&&(b=H.byId(c.id))&&(b.set&&/_PopupRenderer/.test(b.declaredClass))&&b.set("showTitle",!1);this.setContent(c);this.updateHighlight(this.map,this.features[a]);this.showHighlight()}},_toggleVisibility:function(a){this._setVisibility(a);this.isShowing=a},_setVisibility:function(a){n.set(this.domNode,"visibility",a?"visible":"hidden");e.toggle(this.domNode,"esri-popup-visible",a)},_waitAndHide:function(a){var c=this;
this._delayHide=!0;setTimeout(function(){c._delayHide&&(c._delayHide=!1,c.hide())},a)},_followMap:function(){this._unfollowMap();this._handles=[this.view.watch("viewpoint",this._viewChangeHandler.bind(this))]},_unfollowMap:function(){var a=this._handles;a&&(v.forEach(a,function(a){a.remove()}),this._handles=null)},_viewChangeHandler:function(a){this.show(this._targetLocation||this.location)},_onPanStart:function(){var a=this.domNode.style;this._panOrigin={left:a.left,top:a.top,right:a.right,bottom:a.bottom}},
_onPan:function(a,c){var b=this._panOrigin,d=c.x,f=c.y,e=b.left,h=b.top,r=b.right,b=b.bottom;e&&(e=parseFloat(e)+d+"px");h&&(h=parseFloat(h)+f+"px");r&&(r=parseFloat(r)-d+"px");b&&(b=parseFloat(b)-f+"px");n.set(this.domNode,{left:e,top:h,right:r,bottom:b})},_onZoomStart:function(){this._setVisibility(!1)},_onExtentChange:function(a,c,b){b&&(this._setVisibility(!0),this.show(this._targetLocation||this.location));this._targetLocation=null},_toggleSize:function(){this._maximized?this.restore():this.maximize()},
_setPosition:function(a){var c=a.x,b=a.y;a=this.offsetX||0;var d=this.offsetY||0,f=0,e=0,h=A.position(this.view.surface,!0),r=h.w,g=h.h,k="left",l="bottom",s=A.getContentBox(this._positioner),p=s.w/2,v=s.h/2,u=n.get(this._sizers[0],"height")+this._maxHeight+n.get(this._sizers[2],"height"),y=u/2,q=0,t=0,w=c,x=b,m=this.anchor.toLowerCase();if("auto"===m){if(m=F.getBox)m=m(),q=Math.max(m.l,h.x),r=Math.min(m.l+m.w,h.x+h.w),t=Math.max(m.t,h.y),g=Math.min(m.t+m.h,h.y+h.h),w+=h.x,x+=h.y;h=x-t>=u;u=g-x>=
u;m=r-w>=s.w;s=w-q>=s.w;x-t>y&&g-x>=y&&(m?(l="",k="left"):s&&(l="",k="right"));k&&l&&(w-q>p&&r-w>=p)&&(h?(k="",l="bottom"):u&&(k="",l="top"));k&&l&&(m&&h?(k="left",l="bottom"):m&&u?(k="left",l="top"):s&&u?(k="right",l="top"):s&&h&&(k="right",l="bottom"))}else l=k="",-1!==m.indexOf("top")?l="bottom":-1!==m.indexOf("bottom")&&(l="top"),-1!==m.indexOf("left")?k="right":-1!==m.indexOf("right")&&(k="left");y=l&&k?l+"-"+k:l||k;switch(y){case "top":case "bottom":e=14;break;case "left":case "right":f=13;
break;case "top-left":case "top-right":case "bottom-left":case "bottom-right":e=14,f=-16}n.set(this.domNode,{left:c+"px",top:b+"px",right:null,bottom:null});c={left:null,right:null,top:null,bottom:null};k?c[k]=f+a+"px":c.left=-p+"px";l?c[l]=e+d+"px":c.top=-v+"px";n.set(this._positioner,c);this._showPointer(y)},_showPointer:function(a){e.remove(this._pointer,"top bottom right left top-left top-right bottom-right bottom-left hidden".split(" "));e.remove(this._outerPointer,["right","left","hidden"]);
"right"===a||"left"===a?e.add(this._outerPointer,a):e.add(this._pointer,a)},_setPagerCallbacks:function(a,c,b){if(this.pagingControls&&!(a===this&&(!this._pagerScope||this._pagerScope===this))&&a!==this._pagerScope){this._pagerScope=a;a===this&&(c=this.selectPrevious,b=this.selectNext);var d=this._eventConnections;d[1].remove();d[2].remove();c&&(d[1]=p(this._prevFeatureButton,"click",c.bind(a)));b&&(d[2]=p(this._nextFeatureButton,"click",b.bind(a)))}},_getLocation:function(a){var c=this.view.map,
b,d,f=0,e;if(a=a&&a.geometry)switch(a.type){case "point":b=a;break;case "multipoint":b=a.getPoint(0);d=a.getExtent();break;case "polyline":b=a.getPoint(0,0);d=a.getExtent();v.forEach(a.paths,function(a){a=(new J({paths:[a,c.spatialReference]})).getExtent();var b=Math.abs(a.ymax-a.ymin),d=Math.abs(a.xmax-a.xmin),b=d>b?d:b;b>f&&(f=b,e=a)});e.spatialReference=d.spatialReference;d=e;break;case "polygon":b=a.getPoint(0,0),d=a.getExtent(),v.forEach(a.rings,function(a){a=(new K({rings:[a,c.spatialReference]})).getExtent();
var b=Math.abs(a.ymax-a.ymin),d=Math.abs(a.xmax-a.xmin),b=d>b?d:b;b>f&&(f=b,e=a)}),e.spatialReference=d.spatialReference,d=e}return[b,d]},_zoomToFeature:function(a){a.preventDefault();var c=this.features,b=this.selectedIndex;a=this.view;var d=this.zoomFactor||4;if(c){var c=this._getLocation(c[b]),e=c[0],c=c[1];e||(e=this.location);if(!c||!c.intersects(this.location))this.location=e;a&&(c&&e?a.animateTo({target:c}).then(function(){this.show(e)}.bind(this)):e&&a.animateTo({target:e,scale:a.scale/d}).then(function(){this.show(e)}.bind(this)))}},
_updatePagingControls:function(){var a=this._prevFeatureButton,c=this._nextFeatureButton,b=this.selectedIndex,d=this.features?this.features.length:0;this.pagingControls&&1<d?(0===b?e.add(a,"hidden"):e.remove(a,"hidden"),b===d-1?e.add(c,"hidden"):e.remove(c,"hidden")):(e.add(a,"hidden"),e.add(c,"hidden"))},_updatePagingInfo:function(){var a=this.features?this.features.length:0,c=this._nls,b="\x26nbsp;";this.pagingInfo&&(1<a&&c.NLS_pagingInfo)&&(b=q.substitute({index:this.selectedIndex+1,total:a},c.NLS_pagingInfo));
if(a&&(c=this.getSelectedFeature(),a=c.getEffectivePopupTemplate(),c=this.getTitle(c),(!a||/esri\.InfoTemplate/.test(a.declaredClass)||!this.titleInBody)&&c))b=c+("\x26nbsp;"===b?"":" "+b);this.setTitle(b)},_updateUI:function(){if(this.popupWindow){var a=this.features,c=this.promises,b=a?a.length:0,d=this._spinner,f=this._actionList,g=this._nls;this._updatePagingControls();this._updatePagingInfo();b?e.remove(f,"hidden"):e.add(f,"hidden");c&&c.length?a?e.remove(d,"hidden"):this.setContent("\x3cdiv style\x3d'text-align: center;'\x3e"+
g.NLS_searching+"...\x3c/div\x3e"):(e.add(d,"hidden"),b||(this.setContent("\x3cdiv style\x3d'text-align: center;'\x3e"+g.NLS_noInfo+".\x3c/div\x3e"),this.visibleWhenEmpty||this._waitAndHide(this.hideDelay)))}}})});