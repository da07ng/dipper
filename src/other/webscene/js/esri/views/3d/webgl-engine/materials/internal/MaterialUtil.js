// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define(["../../lib/IdGen","../../lib/gl-matrix","../../parts/Model","../../lib/VertexBufferLayout","../../lib/Util"],function(V,E,W,X,F){var x=E.vec3d,Y=E.mat4d,Q=E.mat4,z=F.VertexAttrConstants,c={};c.__Material_idGen=new V;c.__GLMaterial_id=0;c.IDENTITY=Y.identity();c.Layouts=X.Defaults;c.fill=function(a,e,d,f,b,g){if(void 0===b||3!==g)for(b=0;b<g;++b)d[f+b]=a[e+b];else{var t=a[e],n=a[e+1];a=a[e+2];d[f]=b[0]*t+b[4]*n+b[8]*a+b[12];d[f+1]=b[1]*t+b[5]*n+b[9]*a+b[13];d[f+2]=b[2]*t+b[6]*n+b[10]*a+b[14]}return g};
var R=function(a,e,d,f,b,g){for(var t=a.length,n=0;n<t;++n){for(var M=d*a[n],l=0;l<d;++l)f[b+l]=e[M+l];b+=g}};c.fillInterleaved=function(a,e,d,f,b,g,t,n){var M=b.getAttributes();b=b.getStride();for(var l in M){var k=t+M[l].offset;if(!(null!=n&&null==n[l])){var h;switch(l){case z.UV0:h=a.vertexAttr[l];null!=h&&R(a.faces.indices[l],h.data,h.size,g,k,b);break;case z.REGION:h=a.vertexAttr[l];var c=a.faces.indices[l],w=h.data,m=h.size;h=g;var p=b;h=new Uint16Array(h.buffer);for(var k=2*k,p=2*p,u=c.length,
r=0;r<u;++r){var v=m*c[r],q;for(q=0;q<m;++q)h[k+q]=w[v+q];k+=p}break;case z.COLOR:h=a.vertexAttr[l];if(f&&f.color){c=a.faces.indices[l];w=h.data;m=f.color;h=h.size;p=g;u=b;p=new Uint8Array(p.buffer);k*=4;u*=4;r=c.length;for(v=0;v<r;++v){q=h*c[v];var s;for(s=0;s<h;++s)p[k+s]=w[q+s]*m[s];4>s&&(p[k+3]=255*m[3]);k+=u}}else{c=a.faces.indices[l];w=h.data;m=h.size;h=g;p=b;h=new Uint8Array(h.buffer);k*=4;p*=4;u=c.length;for(r=0;r<u;++r){v=m*c[r];for(q=0;q<m;++q)h[k+q]=w[v+q];4>q&&(h[k+3]=255);k+=p}}break;
default:if(h=a.vertexAttr[l],m=l===z.POSITION?e:l===z.NORMAL?d:void 0,void 0!==m&&3===h.size){c=a.faces.indices[l];w=h.data;h=g;p=b;u=c.length;for(r=0;r<u;++r)s=3*c[r],v=w[s],q=w[s+1],s=w[s+2],h[k]=m[0]*v+m[4]*q+m[8]*s+m[12],h[k+1]=m[1]*v+m[5]*q+m[9]*s+m[13],h[k+2]=m[2]*v+m[6]*q+m[10]*s+m[14],k+=p}else R(a.faces.indices[l],h.data,h.size,g,k,b)}}}};var S=x.create(),Z=x.create(),$=x.create(),aa=x.create(),T=function(a,e,d,f,b){var g=a.getCenter();x.project(g,e,d,S);var g=x.dist2(S,g),t=a.getBSRadius();
if(g<t*t){var g=a.getPrimitiveIndices(),t=a.getIndices(),n=a.getPosition(),c=g?g.length:t.length/3;if(1E4<c&&(a=a.getChildren(),void 0!==a)){for(g=0;8>g;++g)void 0!==a[g]&&T(a[g],e,d,f,b);return}a=n.size;var n=n.data,l=e[0],k=e[1];e=e[2];var h=d[0]-l,z=d[1]-k;d=d[2]-e;for(var w=0;w<c;++w){var m=g?g[w]:w,p=a*t[3*m],u=a*t[3*m+1],r=a*t[3*m+2],v=n[p],q=n[p+1],p=n[p+2],s=n[u],C=n[u+1],u=n[u+2],D=n[r],E=n[r+1],r=n[r+2],G=s-v,H=C-q,I=u-p,J=D-v,A=E-q,B=r-p,K=z*B-A*d,L=d*J-B*h,F=h*A-J*z,y=G*K+H*L+I*F;if(!(y>
-f&&y<f)){var y=1/y,N=l-v,O=k-q,P=e-p,K=y*(N*K+O*L+P*F);0>K||1<K||(L=O*I-H*P,I=P*G-I*N,G=N*H-G*O,H=y*(h*L+z*I+d*G),0>H||1<K+H||(J=y*(J*L+A*I+B*G),0<=J&&(A=Z,B=$,y=aa,x.set3(v,q,p,A),x.set3(s,C,u,B),x.set3(D,E,r,y),x.subtract(B,A,B),x.subtract(y,A,y),x.normalize(x.cross(B,y,A)),b(J,A,m))))}}}};c.intersectTriangleGeometry=function(a,e,d,f,b,g,t,n,c,l,k){F.assert("triangle"===a.getData().getFaces()[e].type);T(a.getBoundingInfo(e),t,n,l,k)};c.basicMaterialConstructor=function(a,e){var d=!0,f=0,b=c.__Material_idGen.gen(e);
a.getId=function(){return b};var g;a.getParentStage=function(){return g};a.addParentStage=function(a){F.assert(void 0===g,"Material can only be added to a single Stage");g=a};a.removeParentStage=function(a){g=void 0};a.setVisible=function(b){d!==b&&(d=b,a.notifyDirty("matChanged"))};a.isVisible=function(){return d};a.notifyDirty=function(b){g&&g.notifyDirty(W.ContentType.MATERIAL,a,b)};a.setRenderPriority=function(a){f=a;this.notifyDirty("matChanged")};a.getRenderPriority=function(){return f}};var C=
c.aquireIfNotUndefined=function(a,e,d,f){return void 0===a?void 0:d.aquire(a,e,f)},D=c.releaseIfNotUndefined=function(a,e){void 0!==a&&e.release(a)},U=Q.create();c.bindView=function(a,e,d){Q.translate(e,a,U);d.uniformMatrix4fv("view",U)};c.bindCamPos=function(a,e,d){d.uniform3f("camPos",e[3]-a[0],e[7]-a[1],e[11]-a[2])};c.basicGLMaterialConstructor=function(a,e){var d=c.__GLMaterial_id++;a.getId=function(){return d};a.getMaterialId=function(){return e.getId()};var f=!0;a.isVisible=function(){return f};
a.updateVisibility=function(){f=e.isVisible()};a.getRenderPriority=function(){return e.getRenderPriority()}};c.singleTextureGLMaterialConstructor=function(a,e,d,f){var b=C(d.textureId,d.initTexture,e,f);a.updateTexture=function(a){d.textureId!==a&&(D(d.textureId,e),d.textureId=a,b=C(d.textureId,d.initTexture,e,f))};a.renderTexture=function(a){var f=e.getTexture(d.textureId);f&&f.renderGl&&f.renderGl(b,a)};a.bindTexture=function(a,d){void 0!==b&&(d.uniform1i("tex",0),a.bindTexture(a.TEXTURE_2D,b))};
a.dispose=function(){D(d.textureId,e)}};c.multiTextureGLMaterialConstructor=function(a,e,d,f){for(var b=f.length,g=Array(b),c=0;c<b;c++)g[c]=C(d[f[c][0]],d[f[c][1]],e);a.updateTextures=function(a){for(var c=0;c<b;c++){var l=d[f[c][0]],k=a[f[c][0]];l!==k&&(D(l,e),d[f[c][0]]=k,g[c]=C(k,d[f[c][1]],e))}};a.bindTextures=function(a,d){for(var c=0;c<b;c++)void 0!==g[c]&&(d.uniform1i(f[c][2],c),a.activeTexture(a.TEXTURE0+c),a.bindTexture(a.TEXTURE_2D,g[c]));a.activeTexture(a.TEXTURE0)};a.bindOneTexture=function(a,
c,b){c.uniform1i(f[b][2],b);a.activeTexture(a.TEXTURE0+b);a.bindTexture(a.TEXTURE_2D,g[b]);a.activeTexture(a.TEXTURE0)};a.disposeTextures=function(){for(var a=0;a<b;a++)D(d[f[a][0]],e)}};return c});