// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define(["../../../../core/declare"],function(m){return m(null,{startNodeLoading:function(a,d,b,c,e,g,h,f){this.layerViewRequiredFunctions=a;this.layerViewOptionalFunctions=d;this._lodGlobalDirty=!1;this._lodMode=e;this._lodSwapNodeIndex={};this._lodSwapFeatureLookup={};this._lodSwapRootFeatureLookup={};this._lodGlobalDirty=!1;this._nodeIndex=g;this._rootId=f;this._nodeTraversalState=c;this._nodeIsVisible=b;if("swap"===this._lodMode){for(var k in h)a=h[k],this._nodeTraversalState(a.id).nodeHasLOD&&
!this._nodeTraversalState(a.id).isChosenLod&&(this._lodSwapNodeIndex[k]=a);this._lodSwapBuildUnmatchingFeatureLookups()}},cancelNodeLoading:function(){this._lodSwapNodeIndex={}},shouldLoadNode:function(a,d){var b=this._nodeTraversalState(a.id),c=b.nodeHasLOD,b=b.isChosenLod;if("perLevel"!=this._lodMode)return b||!c;if(b||!c)return!0;c=!1;return(c=this.layerViewOptionalFunctions.traversalOptions.allowPartialOverlaps?this._someSubtreesIncomplete(a):this._allSubtreesIncomplete(a))?!0:!1},shouldSetPolygonOffset:function(a){return"perLevel"===
this._lodMode?!this._nodeTraversalState(a.id).isChosenLod:!1},_allSubtreesIncomplete:function(a){if(this.layerViewRequiredFunctions.areAllBundlesLoaded(a))return!1;var d=!0;if(null!=a.children&&0<a.children.length)for(var b=0;b<a.children.length;++b){var c=a.children[b];this._nodeIsVisible(c)&&(c=this._nodeIndex[c.id],d=d&&(null==c||this._allSubtreesIncomplete(c)))}return d},_someSubtreesIncomplete:function(a){if(this.layerViewRequiredFunctions.areAllBundlesLoaded(a))return!1;var d=!1;if(null!=a.children&&
0<a.children.length)for(var b=0;b<a.children.length;++b){var c=a.children[b];this._nodeIsVisible(c)&&(c=this._nodeIndex[c.id],d=d||null==c||this._allSubtreesIncomplete(c))}return d},setLodGlobalDirty:function(){this._lodGlobalDirty=!0},finishedLevel:function(a){"perLevel"===this._lodMode&&this._deleteUpToLevelRecurse(a-1,0,this._nodeIndex[this._rootId])},_deleteUpToLevelRecurse:function(a,d,b){if(null!=b&&!(d>a)&&(this._nodeTraversalState(b.id).isChosenLod||this.layerViewRequiredFunctions.removeNodeData(b),
null!=b.children))for(var c=0;c<b.children.length;++c)this._deleteUpToLevelRecurse(a,d+1,this._nodeIndex[b.children[c].id])},lodSwapBundleLoaded:function(a,d,b){if(null!=b)if(null!=b.swapPairs&&0<Object.keys(b.swapPairs).length){if(null!=d){a=b.swapPairs;b={};for(var c=0;c<d.length;c++)for(var e=d[c].features,g=0;g<e.length;g++)b[e[g].id]=!0;for(var h in a){d=a[h];c=[];e=d.features;for(g=0;g<e.length;g++)null!=b[e[g]]&&c.push(e[g]);this.layerViewRequiredFunctions.removeFeatures(d.node,d.features)}}}else{for(c in b.nodesHigherInTree)this.layerViewRequiredFunctions.removeNodeData(b.nodesHigherInTree[c]);
for(c in b.nodesDeeperInTree)this.layerViewRequiredFunctions.removeNodeData(b.nodesDeeperInTree[c])}this._lodGlobalDirty=!0},lodGlobalHandling:function(){if("global"===this._lodMode&&(!0===this._lodGlobalDirty||this.layerViewRequiredFunctions.isOverMemory())){var a=this._rootId;null!=a&&(this._lodGlobalHandlingRecursion({id:a},this._nodeIndex,!1,!1,0),this._lodGlobalHandlingRecursionRemoveIntermediate(a,this._nodeIndex,!1,0),this._lodGlobalDirty=!1)}},lodSwapBuildInfoForNode:function(a){if(!this._nodeTraversalState(a.id).nodeHasLOD)return null;
if("swap"===this._lodMode){var d={},b={},c,e,g=a.id+"",h;for(h in this._lodSwapNodeIndex){var f=this._lodSwapNodeIndex[h];null!=this.layerViewRequiredFunctions.getAddedFeatures(f.id)&&(c=null===a.parentNode||0===(f.id+"").indexOf(g),e=null==f.parentNode||0===g.indexOf(f.id+""),!0===e&&(b[f.id]=f),!0===c&&(d[f.id]=f))}return{nodesHigherInTree:b,nodesDeeperInTree:d}}if("perLevel"===this._lodMode&&this._nodeTraversalState(a.id).isChosenLod)return d={},this._getNodesRecurse(a,d),{nodesHigherInTree:null,
nodesDeeperInTree:d}},_getNodesRecurse:function(a,d){if(null!=a.children)for(var b=0;b<a.children.length;++b){var c=a.children[b],e=this._nodeIndex[c.id];null!=e&&(d[c.id]=e,this._getNodesRecurse(e,d))}},_lodSwapBuildUnmatchingFeatureLookups:function(){this._lodSwapFeatureLookup={};this._lodSwapRootFeatureLookup={};for(var a in this._lodSwapNodeIndex){var d=this._lodSwapNodeIndex[a],b=this.layerViewRequiredFunctions.getAddedFeatures(d.id);if(null!=b)for(var c=0;c<b.length;c++){var e=b[c];this._lodSwapFeatureLookup[e.id]=
d;null!=e.rootFeature&&(null==this._lodSwapRootFeatureLookup[e.rootFeature]&&(this._lodSwapRootFeatureLookup[e.rootFeature]=[]),this._lodSwapRootFeatureLookup[e.rootFeature].push({node:d,featureId:e.id}))}}},_validateLodTreeVisibilities:function(){var a=this._layerViewOptionalFunctions.getAllAddedFeatures;if(null!=a){a=a();console.debug("validating lod tree: ");var d={},b={},c=!0,e;for(e in a){var g=a[e],h;for(h in g){var f=g[h];null!=d[f.id]&&d[f.id]!=e&&(console.debug("node "+e+" !! encountered feature "+
f.id+" already in node "+d[f.id]),c=!1);null!=b[f.id]&&b[f.id]!=e&&(console.debug("node "+e+" !! encountered feature "+f.id+" already as rootFeature in node "+b[f.id]),c=!1);d[f.id]=e;null!=f.rootFeature&&b[f.rootFeature]!=e&&(null!=b[f.rootFeature]&&(console.debug("node "+e+" !! encountered rootFeature "+f.rootFeature+" already in node "+b[f.rootFeature]),c=!1),null!=d[f.rootFeature]&&(console.debug("node "+e+" !! encountered rootFeature "+f.rootFeature+" already as feature"),c=!1),b[f.rootFeature]=
e)}}return c}},_lodGlobalHandlingRecursion:function(a,d,b,c,e){var g=a.id,h=d[g];if(null==h)return a=null!=a.mbs?this._nodeIsVisible(a):!1,c||!a;g=this._nodeTraversalState(g);a=this._nodeIsVisible(h);var g=g.isChosenLod,f=this.layerViewRequiredFunctions.isBundleAlreadyAddedToStage(h,0).alreadyLoaded,k=!0;if(null!=h.children)for(var l=0;l<h.children.length;++l)this._lodGlobalHandlingRecursion(h.children[l],d,f&&g||b,g||c,e+1)||(k=!1);d=this.layerViewRequiredFunctions.isOverMemory();if(f&&!g&&((c?b:
k)||d))this.setLodGlobalDirty(),this.layerViewRequiredFunctions.removeNodeData(h),f=!1;f&&this.layerViewOptionalFunctions.setPolygonOffset&&this.layerViewOptionalFunctions.setPolygonOffset(h,!(g&&!c));b=k||f;if(g&&f||!a||c)b=!0;g&&(!f&&a)&&(b=!1);return b},_lodGlobalHandlingRecursionRemoveIntermediate:function(a,d,b,c){var e=d[a];if(null!=e){var g=this.layerViewRequiredFunctions.isBundleAlreadyAddedToStage(e,0).alreadyLoaded;a=this._nodeTraversalState(a).isChosenLod;if(null!=e.children)for(var h=
0;h<e.children.length;++h)this._lodGlobalHandlingRecursionRemoveIntermediate(e.children[h].id,d,g||b,c+1);b&&(!a&&g)&&(this.layerViewRequiredFunctions.removeNodeData(e),this.setLodGlobalDirty())}}})});