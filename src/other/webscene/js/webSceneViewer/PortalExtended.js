// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("esri/core/declare dojo/_base/lang dojo/Deferred dojo/cookie dojo/on esri/kernel esri/portal/Portal esri/portal/PortalItem esri/identity/IdentityManager".split(" "),function(e,g,k,f,p,q,h,l,m){function n(a,b){a.then(function(a){b.resolve(a)},function(a){b.reject(a)},function(a){b.progress(a)})}e=e([h],{_baseUrl:void 0,constructor:function(){this._baseUrl="undefined"!==typeof esriGeowConfig?esriGeowConfig.baseUrl:"../";p.once(this,"ready",function(){q.id.checkSignInStatus(this.portalUrl).then(function(a){this.signIn()}.bind(this)).otherwise(function(a){this.signOutAfterFailedSignIn(a)}.bind(this))}.bind(this))},
addItem:function(a,b){var c=g.mixin({},a);if(b&&b.data){var d=new FormData;d.append(b.identifier||"file",b.data,b.name);c.form=d}return this.portalUtil.request(this.portalUrl+"content/users/"+this.getPortalUser().username+"/addItem",c,{usePost:!0})},getItem:function(a){var b=new k;this._getItemAnonymous(a).then(function(a){a=l(g.mixin(a,{portal:this}));b.resolve(a)}.bind(this),function(c){c=this._getItemSignedIn(a);n(c,b)}.bind(this));return b.promise},getRelatedItems:function(a,b,c){return this.portalUtil.request(this.portalUrl+
"content/items/"+a+"/relatedItems",{relationshipType:b||"Service2Data",relationshipDirection:c||"forward",f:"json"})},_getItemAnonymous:function(a){return this.portalUtil.request(this.portalUrl+"content/items/"+a)},_getItemSignedIn:function(a){var b=this.getPortalUser();if(null==b){var c=new k;this.signIn().then(function(){var b=this._getItemSignedIn(a);n(b,c)}.bind(this));return c.promise}return b.getItem(a)},getItemData:function(a){return this.portalUtil.request(this.portalUrl+"content/items/"+
a+"/data")},updateItem:function(a,b,c,d,e){b=g.mixin({},b);if(d&&d.data){var f=new FormData;f.append(d.identifier||"file",d.data,d.name);b.form=f}d=e?e:this.getPortalUser().username;return this.portalUtil.request(this.portalUrl+"content/users/"+d+(c?"/"+c:"")+"/items/"+a+"/update",b,{usePost:!0})},signIn:function(){return this._signingInDfd?this._signingInDfd:this._signingInDfd=this.inherited(arguments).then(function(a){this._signingInDfd=void 0;this.emit("sign-in",a)}.bind(this),function(a){this._signingInDfd=
void 0;this.signOutAfterFailedSignIn(a)}.bind(this))},signOutAfterFailedSignIn:function(a){var b=m.credentials;b&&0<b.length&&m.destroyCredentials();this.deleteCookie("esri_auth");this.init(this.url).then(function(){this.emit("sign-in-error",{msg:a})}.bind(this)).otherwise(function(a){this.emit("sign-in-error",{msg:a})}.bind(this))},signOut:function(){return this.inherited(arguments).then(function(){this.deleteCookie("esri_auth");this.emit("sign-out")}.bind(this))},deleteCookie:function(a){if(f.isSupported()){f(a,
null,{expires:-1,path:"/",domain:document.domain});for(var b=document.domain.split(".");2<b.length;)b.shift(1),f(a,null,{expires:-1,path:"/",domain:b.join(".")})}},isSignedIn:function(){return null!=this.getPortalUser()},isOrg:function(){if(this.isSignedIn()){var a=this.getPortalUser();return void 0!==a.accountId||void 0!==a.orgId}return this.isPortal||this.urlKey},queryItems:function(a,b){var c=this.getPortalUser();null!=c&&c.credential&&g.mixin(a,{token:c.credential.token});return this.inherited(arguments)},
queryGroupItems:function(a,b,c){b=this.portalUtil.formatQueryParams({},b,c);b.q="group:"+a+(b.q?" "+b.q:"");return this._queryPortal(this.portalUrl+"search",this.portalUtil.formatQueryParams({},b,c),l)},getBaseUrl:function(){return this._baseUrl},getSceneViewerUrl:function(a){return a?document.location.protocol+"//"+this.portalHostname+"/home/webscene/viewer.html":this._baseUrl+"webscene/viewer.html"},getProfileLink:function(){return this._baseUrl+"user.html"},getHomeLink:function(){return!this.isPortal&&
!this.isSignedIn()?this._baseUrl+"../features/":this._baseUrl+"index.html"},getFeaturesLink:function(){return this._baseUrl.replace("/home/","/features/")+"features.html"},getPlansLink:function(){return this._baseUrl.replace("/home/","/features/")+"plans/pricing.html"},getGalleryLink:function(){return this._baseUrl+"gallery.html"},getScenesGalleryLink:function(){return this._baseUrl+"gallery.html#f\x3dscenes"},getGroupsLink:function(){return this._baseUrl+"groups.html"},getMyContentLink:function(){return this._baseUrl+
"content.html"},getMyOrgLink:function(){return this._baseUrl+"organization.html"},getloggedInAdminHelpLink:function(){if(this.isPortal)var a=this.helpBase.replace("/website/","/admin/");return a||this._baseUrl+"support.html"},getTrialLink:function(){return this._baseUrl.replace("/home/","/features/")+"free-trial.html"},userHasSharingPrivileges:function(){var a=this.getPortalUser();if(!this.isOrg())return!0;if(a&&void 0!==a.privileges)for(var b=0;b<a.privileges.length;b++)if("portal:user:shareToPublic"===
a.privileges[b]||"portal:user:shareToOrg"===a.privileges[b]||"portal:user:shareToGroup"===a.privileges[b])return!0},userCanShareWithPublic:function(){var a=this.getPortalUser();if(!this.isOrg())return!0;if(this.canSharePublic&&a&&void 0!==a.privileges)for(var b=0;b<a.privileges.length;b++)if("portal:user:shareToPublic"===a.privileges[b])return!0;return!1},userHasEditingPrivileges:function(a){var b=this.getPortalUser();if(!this.isOrg())return!0;if(b&&void 0!==b.privileges)for(var c=0;c<b.privileges.length;c++)if("portal:user:createItem"===
b.privileges[c])return!0;return a?a.portalItemProperties?this._canEditScene(a.portalItemProperties.itemControl):!1:!1},_canEditScene:function(a){return"update"===a||"admin"===a}});h.Portal=e;return h});