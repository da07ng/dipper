// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../../../../core/declare ./Canvas3DSymbolBase ./Canvas3DGraphic ./Canvas3DSymbolCommonCode ../../../../geometry/Polygon ../../support/projectionUtils ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/materials/Material ../../webgl-engine/lib/Util ./earcut/earcut".split(" "),function(K,Y,Z,G,$,aa,N,O,ba,ca,P,da,ea,fa){function ga(a,b,c,m,d,k,f,l,e,n,s,w,g,ha){var A=c.length/3,u=
0;s+=2*m.count;var h=m.index,D=m.count,p=e,v=s;r.set(g,q);var x=0<w?1:-1,h=3*h,t=p;g=3*t;for(var y=p+D,p=3*y,B=0;B<D;++B)ha&&(q[0]=a[h+0],q[1]=a[h+1],q[2]=a[h+2],r.normalize(q)),d[g+0]=a[h+0],d[g+1]=a[h+1],d[g+2]=a[h+2],k[g+0]=b[h+0],k[g+1]=b[h+1],k[g+2]=b[h+2],f[g+0]=-x*q[0],f[g+1]=-x*q[1],f[g+2]=-x*q[2],l[t]=0,d[p+0]=a[h+0]+w*q[0],d[p+1]=a[h+1]+w*q[1],d[p+2]=a[h+2]+w*q[2],k[p+0]=b[h+0],k[p+1]=b[h+1],k[p+2]=b[h+2],f[p+0]=x*q[0],f[p+1]=x*q[1],f[p+2]=x*q[2],l[y]=w,g+=3,p+=3,h+=3,t+=1,y+=1;h=0;g=3*
(v+A);p=3*v;a=Q;b=R;0>w&&(a=R,b=Q);for(B=0;B<A;++B)n[g+0]=c[h+a[0]],n[g+1]=c[h+a[1]],n[g+2]=c[h+a[2]],n[p+0]=c[h+b[0]]+D,n[p+1]=c[h+b[1]]+D,n[p+2]=c[h+b[2]]+D,g+=3,p+=3,h+=3;e+=2*m.count;s=s+2*A-(2*m.count+2*A);S(d,k,l,f,u,m.pathLengths[0],m.count,e,n,s,w);e+=4*m.pathLengths[0];s+=2*m.pathLengths[0];u+=m.pathLengths[0];for(c=1;c<m.pathLengths.length;++c)S(d,k,l,f,u,m.pathLengths[c],m.count,e,n,s,w),e+=4*m.pathLengths[c],s+=2*m.pathLengths[c],u+=m.pathLengths[c]}function J(a,b,c,m,d,k,f){m[k]=m[f];
f*=3;k*=3;a[k+0]=a[f+0];a[k+1]=a[f+1];a[k+2]=a[f+2];b[k+0]=b[f+0];b[k+1]=b[f+1];b[k+2]=b[f+2];c[k+0]=d[0];c[k+1]=d[1];c[k+2]=d[2]}function S(a,b,c,m,d,k,f,l,e,n,s){var w=d,g=d+1,q=d+f,A=d+f+1,u=l,h=l+1,D=l+2*k;l=l+2*k+1;0>s&&(w=d+f+1,A=d);n*=3;for(var p=0;p<k;++p){p===k-1&&(0<s?(g=d,A=d+f):(g=d,w=d+f));var v=a,x=w,t=g,y=q,B=H,x=3*x,t=3*t,y=3*y;r.set3(v[x++],v[x++],v[x++],L);r.set3(v[t++],v[t++],v[t++],T);r.set3(v[y++],v[y++],v[y++],U);r.subtract(T,L,V);r.subtract(U,L,W);r.cross(W,V,B);r.normalize(B,
B);J(a,b,m,c,H,u,w);J(a,b,m,c,H,h,g);J(a,b,m,c,H,D,q);J(a,b,m,c,H,l,A);e[n++]=u;e[n++]=D;e[n++]=l;e[n++]=u;e[n++]=l;e[n++]=h;w++;g++;q++;A++;u+=2;h+=2;D+=2;l+=2}}var z=ea.VertexAttrConstants,r=N.vec3d,X=N.mat4d,E=r.create();r.create();var q=r.create();r.create();var Q=[0,2,1],R=[0,1,2],I={};K=K([Y],{_prepareResources:function(){var a=this._getStageIdHint(),b=this._getMaterialOpacityAndColor(),c=r.create(b),b=b[3],c={diffuse:c,ambient:c,opacity:b,transparent:1>b||this._isPropertyDriven("opacity"),
vertexColors:!0};this._material=new da(c,a+"_3dlinemat");this._context.stage.add(O.ModelContentType.MATERIAL,this._material);this.resolve()},destroy:function(){this._context.stage.remove(O.ModelContentType.MATERIAL,this._material.getId())},createCanvas3DGraphic:function(a,b){var c=a.geometry;if("polygon"!==c.type&&"extent"!==c.type)return this._logWarning("unsupported geometry type for line symbol: "+c.type),null;var c="polygon"===c.type||"extent"===c.type?"rings":"paths",m="graphic"+a.id,d=this._getVertexOpacityAndColor(b,
Float32Array,255),k=this._getGraphicElevationInfo(a);return this._createAs3DShape(a,c,b,d,k,m,a.id)},layerPropertyChanged:function(a,b,c){if("opacity"===a)return b=this._getMaterialOpacity(),c=1>b||this._isPropertyDriven("opacity"),this._material.setParameterValues({opacity:b,transparent:c}),!0;if("elevationInfo"===a){this._updateElevationInfo();a=this._context.elevationProvider;var m=this._context.renderCoordsHelper,d=this._context.mapCoordsHelper,k=G.ELEV_MODES.ABSOLUTE_HEIGHT,f;for(f in b){var l=
b[f],e=l._graphics[c];e&&(l=this._getGraphicElevationInfo(l.graphic),e.elevationAligner=l.mode!==k?M:null,e.elevationInfo.set(l),M(e,a,m,d))}return!0}return!1},_getExtrusionSize:function(a,b){var c=a.size&&this._isPropertyDriven("size")?G.getSingleSizeDriver(a.size):this.symbol.size||1;return c/=this._context.mapCoordsHelper.mapUnitInMeters},_createAs3DShape:function(a,b,c,m,d,k,f){var l=a.geometry;"extent"===l.type&&(l=$.fromExtent(l));var e=l[b],n=l.hasZ;if(0<e.length){b=[];a=[];var s=[],w=r.create(),
g=Array(6),q=this._context.renderSpatialReference===aa.SphericalRenderSpatialReference;c=this._getExtrusionSize(c,this.symbol.size);var A=r.create();q||this._context.renderCoordsHelper.worldUpAtPosition(null,A);for(var n=G.getGeometryVertexData3D(e,n,l.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,d),l=n.geometryData.polygons,e=n.eleVertexData,n=n.vertexData,u=n.length/3,h=new Float64Array(18*u),D=new Float64Array(18*u),p=new Float64Array(18*u),u=new Float64Array(6*
u),v=0,x=0;x<l.length;++x){var t=l[x],y=t.count,B=t.index;if(this._context.clippingExtent&&(G.computeBoundingBox(e,B,y,g),G.boundingBoxClipped(g,this._context.clippingExtent)))continue;var z=new Float64Array(e.buffer,3*B*h.BYTES_PER_ELEMENT,3*y),C=t.holeIndices.map(function(a){return a-B}),z=fa(z,C,3);if(0<z.length){G.chooseOrigin(n,B,y,w);var C=new Uint32Array(6*y+2*z.length),E=6*y,F=new Float64Array(h.buffer,3*v*h.BYTES_PER_ELEMENT,3*E),H=new Float64Array(D.buffer,3*v*D.BYTES_PER_ELEMENT,3*E),I=
new Float64Array(p.buffer,3*v*p.BYTES_PER_ELEMENT,3*E),J=new Float64Array(u.buffer,1*v*u.BYTES_PER_ELEMENT,1*E);ga(n,e,z,t,F,I,H,J,0,C,0,c,A,q);G.subtractCoordinates(F,0,E,w);v+=6*y;t=this._createExtrudeGeometry(C,{positions:F,elevation:I,normals:H,heights:J},m,!1);t=new ca(t,k+"path"+x);t.singleUse=!0;b.push(t);a.push([this._material]);t=X.identity();X.translate(t,w,t);s.push(t)}}return 0<b.length?(m=this._context.layer.get("id"),k=new ba({geometries:b,materials:a,transformations:s,castShadow:!0,
metadata:{layerId:m,graphicId:f},idHint:k}),f=null,d.mode!==G.ELEV_MODES.ABSOLUTE_HEIGHT&&(f=M),new Z(this,k,b,null,null,f,d)):null}this._logWarning("no paths found for extrusion symbol");return null},_createExtrudeGeometry:function(a,b,c,m){for(var d=a.length,k=new Uint32Array(d),f=0;f<d;f++)k[f]=0;f={};d={};f[z.POSITION]=a;f[z.NORMAL]=a;f[z.COLOR]=k;d[z.POSITION]={size:3,data:b.positions};d[z.NORMAL]={size:3,data:b.normals};d[z.COLOR]={size:4,data:c};d[z.SIZE]={size:1,data:b.heights};b.elevation&&
(d.mapPos={size:3,data:b.elevation},f.mapPos=a);a=[{type:"triangle",indices:f,positionKey:z.POSITION}];return m?{faces:a[0],vertexAttr:d,id:P.getNewId().toString()}:new P(a,d)}});var H=r.create(),L=r.create(),T=r.create(),U=r.create(),V=r.create(),W=r.create(),F=r.create(),C=r.create(),M=function(a,b,c,m){var d=a.stageObject;a=a.elevationInfo;c=c.setAltitude;I.spatialReference=b.spatialReference;for(var k=d.getGeometryRecords(),f=k.length,l=0;l<f;l++){var e=k[l].geometry,n=k[l].transformation;C[0]=
n[12];C[1]=n[13];C[2]=n[14];e.invalidateBoundingInfo();for(var s=e.getData().getVertexAttr(),e=s[z.POSITION].data,n=s[z.SIZE].data,s=s.mapPos.data,r=e.length/3,g=0,q=0,A=!1,u=0;u<r;u++){I.x=s[q];I.y=s[q+1];I.z=s[q+2];F[0]=e[g];F[1]=e[g+1];F[2]=e[g+2];var h=G.computeElevation(b,I,a);E[0]=e[g]+C[0];E[1]=e[g+1]+C[1];E[2]=e[g+2]+C[2];c(h+n[g/3],E,0);e[g]=E[0]-C[0];e[g+1]=E[1]-C[1];e[g+2]=E[2]-C[2];h=0.01/m.mapUnitInMeters;if(Math.abs(F[0]-e[g])>h||Math.abs(F[1]-e[g+1])>h||Math.abs(F[2]-e[g+2])>h)A=!0;
q+=3;g+=3}A&&d.geometryVertexAttrsUpdated(l)}};return K});