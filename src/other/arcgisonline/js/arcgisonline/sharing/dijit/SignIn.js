// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/SignIn",["dijit","dojo","dojox","dojo/i18n!arcgisonline/nls/arcgisonline","dojo/require!dijit/_Widget,dijit/_Templated,dijit/form/Form,dijit/form/Button,dijit/form/ValidationTextBox,dojo/DeferredList,arcgisonline/sharing/util,arcgisonline/sharing/geow/Account,arcgisonline/sharing/geow/Geow,arcgisonline/sharing/dijit/dialog/ChoiceDlg,arcgisonline/sharing/dijit/dialog/GeneralDlg,arcgisonline/sharing/dijit/dialog/SubscriptionStatusDlg"],function(g,a,n){a.provide("arcgisonline.sharing.dijit.SignIn");
a.require("dijit._Widget");a.require("dijit._Templated");a.require("dijit.form.Form");a.require("dijit.form.Button");a.require("dijit.form.ValidationTextBox");a.require("dojo.DeferredList");a.require("arcgisonline.sharing.util");a.require("arcgisonline.sharing.geow.Account");a.require("arcgisonline.sharing.geow.Geow");a.require("arcgisonline.sharing.dijit.dialog.ChoiceDlg");a.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");a.require("arcgisonline.sharing.dijit.dialog.SubscriptionStatusDlg");
a.requireLocalization("arcgisonline","arcgisonline");a.declare("arcgisonline.sharing.dijit.SignIn",[g._Widget,g._Templated],{_util:arcgisonline.sharing.util,_geow:arcgisonline.sharing.geow.Geow,_account:arcgisonline.sharing.geow.Account,redirectUrl:esriGeowConfig.baseUrl+"index.html",orgRedirectUrl:esriGeowConfig.baseUrl+"organization.html",setupRedirectUrl:esriGeowConfig.baseUrl+"setup.html",widgetsInTemplate:!0,templateString:'\x3cdiv class\x3d"widgetContent"\x3e\r\n  \x3cdiv id\x3d"login-form" class\x3d"esriFloatLeading respond" style\x3d"display:block; clear:both;"\x3e\r\n    \x3cdiv dojotype\x3d"dijit.form.Form" id\x3d"sign-in-form" method\x3d"POST" action\x3d""\x3e\r\n      \x3cdiv id\x3d"organizationTitle" style\x3d"display:none; margin:10px 0 40px 0; text-align:center;"\x3e\x3c/div\x3e\r\n      \x3cdiv id\x3d"left" style\x3d"display:none;" class\x3d"grid_7 alpha first esriFloatLeading"\x3e\r\n        \x3ch1 id\x3d"leftPanelTitle"\x3e${i18n.firstTimeSign}\x3c/h1\x3e\r\n        \x3cbr/\x3e\r\n\r\n        \x3cdiv id\x3d"not_a_member_msg"\x3e\r\n        \x3c/div\x3e\r\n        \x3cbr/\x3e\r\n        \x3cbr/\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv id\x3d"leftAgo" style\x3d"display:none;font-size:14px;" class\x3d"grid_7 alpha first esriFloatLeading"\x3e\r\n        \x3ch1 style\x3d"font-size:24px;"\x3e${i18n.agsNoAccount}\x3c/h1\x3e\r\n        \x3cdiv id\x3d"trial" style\x3d"display:none;"\x3e\r\n          \x3cdiv style\x3d\'margin:20px 0 5px 0\'\x3e${i18n.agsTrial}\x3c/div\x3e\r\n          \x3c!--\x3cp\x3e${i18n.agsSubscriptionInfo}\x3c/p\x3e--\x3e\r\n          \x3cbutton dojoAttachPoint\x3d"_trialUrl" style\x3d"margin:10px 0 10px 0;" class\x3d"calcite blue" type\x3d"button" dojotype\x3d"dijit.form.Button"\x3e\r\n            ${i18n.ags30DayTrial}\r\n          \x3c/button\x3e\r\n          \x3cdiv style\x3d\'font-weight:bold;margin:20px 0 5px 0;padding-top:35px;border-top:1px solid #e5e5e5;\'\x3e${i18n.agsNoTrial}\x3c/div\x3e\r\n        \x3c/div\x3e\r\n        \x3c!--\x3cdiv\x3e--\x3e\r\n          \x3c!--\x3cdiv style\x3d"margin:10px 0 10px 0;"\x3e${i18n.agsCreatePersonalMsg}\x3c/div\x3e--\x3e\r\n          \x3c!--\x3cdiv style\x3d\'margin:15px 0 5px 0\'\x3e${i18n.agsHavePersonal}\x3c/div\x3e--\x3e\r\n          \x3c!--\x3cbutton dojoAttachPoint\x3d"_agoRegister" style\x3d"margin:10px 0 10px 0;" type\x3d"button" class\x3d"calcite light" dojotype\x3d"dijit.form.Button"\x3e--\x3e\r\n            \x3c!--${i18n.agsRegisterPersonalBtn}--\x3e\r\n          \x3c!--\x3c/button\x3e--\x3e\r\n        \x3c!--\x3c/div\x3e--\x3e\r\n        \x3cdiv\x3e\r\n          \x3cdiv style\x3d\'margin:15px 0 15px 0\'\x3e${i18n.createPublicAccountMsg}\x3c/div\x3e\r\n          \x3cbutton dojoAttachPoint\x3d"_agoCreate" class\x3d"calcite light" style\x3d"margin:10px 0 10px 0;" type\x3d"button" dojotype\x3d"dijit.form.Button"\x3e\r\n            ${i18n.agsCreatePersonalBtn}\r\n          \x3c/button\x3e\r\n          \x3cp style\x3d"font-size:11px;color:#999;"\x3e${!i18n.publicAccountMsg}\x3c/p\x3e\r\n        \x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv id\x3d"rightAgo" class\x3d"grid_7 omega last esriFloatTrailing"\x3e\r\n        \x3c!--\x3ch1 id\x3d"rightPanelTitle"\x3e${i18n.SignIn}\x3c/h1\x3e--\x3e\r\n        \x3cp id\x3d\'rightPanelSubTitle\'\x3e\x3c/p\x3e\r\n        \x3cbr/\x3e\r\n        \x3cdiv id\x3d"sign-in-error"\x3e\r\n        \x3c/div\x3e\r\n        \x3ciframe dojoattachpoint\x3d"_iFrame" id\x3d"oAuthFrame" scrolling\x3d"no" style\x3d"display:none; border:0" marginheight\x3d"0" marginwidth\x3d"0" frameborder\x3d"0" width\x3d"400" height\x3d"500"\x3e\r\n           Your browser does not support iframes.\r\n        \x3c/iframe\x3e\r\n        \x3ctable id\x3d"authTable" style\x3d"width:100%;display:none"\x3e\r\n          \x3ctbody\x3e\r\n            \x3ctr\x3e\r\n              \x3ctd class\x3d"grid_2 alpha"\x3e\r\n                \x3clabel for\x3d"user_username" style\x3d"padding:0;margin:0;"\x3e${i18n.userLabel}\x3c/label\x3e\r\n              \x3c/td\x3e\r\n              \x3ctd\x3e\r\n                \x3cdiv id\x3d"user_username" name\x3d"user_username" class\x3d"grid_5 omega" style\x3d"padding:2px;margin:0;" dojotype\x3d"dijit.form.TextBox" trim\x3d"true"\x3e\r\n                \x3c/div\x3e\r\n              \x3c/td\x3e\r\n            \x3c/tr\x3e\r\n            \x3ctr height\x3d"5"\x3e\r\n              \x3ctd colspan\x3d"2" height\x3d"5"\x3e\r\n              \x3c/td\x3e\r\n            \x3c/tr\x3e\r\n            \x3ctr\x3e\r\n              \x3ctd class\x3d"grid_2 alpha"\x3e\r\n                \x3clabel for\x3d"user_password" style\x3d"padding:0;margin:0;"\x3e${i18n.passwordLabel}\x3c/label\x3e\r\n              \x3c/td\x3e\r\n              \x3ctd\x3e\r\n                \x3cdiv id\x3d"user_password" name\x3d"user_password" class\x3d"grid_5 omega" style\x3d"padding:2px;margin:0;" type\x3d"password" dojotype\x3d"dijit.form.TextBox"trim\x3d"true"\x3e\r\n                \x3c/div\x3e\r\n              \x3c/td\x3e\r\n            \x3c/tr\x3e\r\n            \x3ctr\x3e\r\n              \x3ctd\x3e\r\n              \x3c/td\x3e\r\n              \x3ctd\x3e\r\n                \x3cdiv id\x3d"signInHelp"\x3e\r\n                  \x3ca id\x3d"signInHelpLink"\x3e${i18n.needHelpSign}\x3c/a\x3e\r\n                  \x3cbr/\x3e\r\n                  \x3cbr/\x3e\r\n                \x3c/div\x3e\r\n                \x3cinput id\x3d"remember-me" style\x3d"height:24px;margin:auto;" value\x3d"off" dojotype\x3d"dijit.form.CheckBox" /\x3e\r\n                \x3clabel id\x3d"remember-me-label" for\x3d"remember-me"\x3e${i18n.rememberMe}\x3c/label\x3e\r\n                \x3cdiv id\x3d"invitationReminder" style\x3d"display:none; font-size:0.9em;"\x3e\x3c/div\x3e\r\n                \x3cbr/\x3e\r\n                \x3cbr/\x3e\r\n                \x3cbutton id\x3d"button_sign_in" style\x3d"margin:0;padding:0;" type\x3d"submit" dojotype\x3d"dijit.form.Button"\x3e\r\n                  ${i18n.SignIn}\r\n                \x3c/button\x3e\r\n                \x3cimg dojoAttachPoint\x3d\'_keyImgicon\' class\x3d"esriLeadingMargin1" style\x3d"position:absolute;"/\x3e\r\n                \x3cbr/\x3e\r\n              \x3c/td\x3e\r\n            \x3c/tr\x3e\r\n          \x3c/tbody\x3e\r\n        \x3c/table\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n  \x3cdiv style\x3d"width:100%; clear:both;"\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e\r\n',
baseClass:"esriSignIn",activationId:null,defaultOrgTitleText:null,invitation:null,orgName:null,usr:null,pwd:null,exp:null,i18n:null,postMixInProperties:function(){this.inherited(arguments);this.i18n=a.i18n.getLocalization("arcgisonline","arcgisonline").common;a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").signInWidget);a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").signInForm);a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").troubleshoot);
this.defaultOrgTitleText=this.i18n.myAccount;this._viewTrialLink=["us"]},postCreate:function(){a.attr(this._keyImgicon,"src",this._util.relativeToExplicitUrl("images/goldKey.gif"));!1===esriGeowConfig.showSignUp&&(a.style(a.byId("left"),"display","none"),a.style(a.byId("leftAgo"),"display","none"),a.removeClass(a.byId("right"),"esriFloatTrailing"),a.addClass(a.byId("right"),"esriFloatLeading"),esriGeowConfig.isRightToLeft?a.style(a.byId("right"),"paddingRight","30%"):a.style(a.byId("right"),"paddingLeft",
"30%"));esriGeowConfig.portalName&&a.style(this._keyImgicon,"display","none");this._account.getSelf(a.hitch(this,function(b){!esriGeowConfig.self||!esriGeowConfig.self.supportsOAuth?(esri.show(a.byId("authTable")),esri.hide(a.byId("oAuthFrame"))):(window.onOAuthSignIn=a.hitch(this,"onOAuthSignIn"),window.checkOAuthResponse=a.hitch(this,"checkOAuthResponse"),window.onOAuthSignInError=a.hitch(this,"onOAuthSignInError"),this._oAuthInfo={url:esriGeowConfig.restBaseUrl+"oauth2/authorize",clientId:"arcgisonline",
redirectUri:esriGeowConfig.baseUrl+"postsignin.html",parent:window.location.protocol+"//"+window.location.host,expiration:20160,locale:a.locale,showSocialLogins:!1},this._oAuthInfo.url=arcgisonline.sharing.util.getSecureUrl(this._oAuthInfo.url),this._authorizeUrl=esri.substitute(this._oAuthInfo,"${url}?client_id\x3d${clientId}\x26redirect_uri\x3d${redirectUri}\x26response_type\x3dtoken\x26display\x3diframe\x26parent\x3d${parent}\x26expiration\x3d${expiration}\x26locale\x3d${locale}"),a.attr(this._iFrame,
"src",this._authorizeUrl),esri.hide(a.byId("authTable")),esri.show(a.byId("oAuthFrame")));document.referrer&&-1<document.referrer.indexOf("https://")?(this.redirectUrl=this.redirectUrl.replace("http:","https:"),this.orgRedirectUrl=this.orgRedirectUrl.replace("http:","https:"),this.setupRedirectUrl=this.setupRedirectUrl.replace("http:","https:")):(this.redirectUrl=this.redirectUrl.replace("https:","http:"),this.orgRedirectUrl=this.orgRedirectUrl.replace("https:","http:"),this.setupRedirectUrl=this.setupRedirectUrl.replace("https:",
"http:"))}))},startup:function(){this.inherited(arguments);a.mixin(this,a.queryToObject(window.location.search.slice(1)));if(this.returnUrl){var b=window.location.host.split(".").slice(-2).join(".")+"/";-1===this.returnUrl.indexOf(b)&&(-1===this.returnUrl.indexOf("arcgis.com/")&&-1===this.returnUrl.indexOf("esri.com/"))&&(this.returnUrl=null)}this.activationcode&&esriGeowConfig.userInfo&&this._geow.signout(window.location.href);esri.config.defaults.io.proxyUrl=esriGeowConfig.proxyServer;this._svcUrl=
esriGeowConfig.restBaseUrl+(esriGeowConfig.restBaseUrl.lastIndexOf("/")===esriGeowConfig.restBaseUrl.length-1?"":"/");this._communityUri=this._svcUrl+"community/";this._usersUri=this._communityUri+"users/";this._accountsUri=this._svcUrl+"portals/";this._geoIPUri=this._svcUrl+"geoip.jsp";this._optinlistUri=document.location.protocol+"//"+document.location.hostname+"/about/js/optinlist.js";this._requestParams={f:"json"};b=esriGeowConfig.portalName?esriGeowConfig.portalName:this.i18n.arcgisOnline;if(this.activationcode){a.style(a.byId("left"),
"display",!1===esriGeowConfig.showSignUp?"none":"block");a.create("h1",{id:"rightPanelTitle",innerHTML:a.string.substitute(this.i18n.alreadyUsingPortal,{portalName:b})},"rightPanelSubTitle","before");a.byId("rightPanelSubTitle").innerHTML=a.string.substitute(this.i18n.alreadyUserSignIn,{portalName:b});var c="\x3ch1\x3e"+this.i18n.activationTitle+"\x3c/h1\x3e";a.byId("organizationTitle").innerHTML=c;a.style(a.byId("organizationTitle"),{display:"block",textAlign:"left",marginBottom:"20px"});a.addClass(a.byId("left"),
"invitation");a.style(a.byId("left"),"width","47%");a.byId("leftPanelTitle").innerHTML=a.string.substitute(this.i18n.firstTimeWith,{portalName:b});a.byId("not_a_member_msg")&&(b="\x3cspan\x3e"+a.string.substitute(this.i18n.userNewToPortal,{portalName:b})+"\x3c/span\x3e",b+='\x3cbr/\x3e\x3cbr /\x3e\x3cspan\x3e\x3cbutton id\x3d"registerLink" class\x3d"calcite light" type\x3d"button" dojotype\x3d"dijit.form.Button"\x3e'+this.i18n.createNewAccount+"\x3c/button\x3e\x3c/span\x3e",c=a.byId("invitationReminder"),
a.create("strong",{innerHTML:"\x3cbr/\x3ePlease note\x3cbr/\x3e"},c),a.create("em",{innerHTML:this.i18n.signInExistingNewOrg},c),a.style(c,"display","block"),a.byId("not_a_member_msg").innerHTML=b,a.parser.parse(a.byId("not_a_member_msg")),a.connect(a.byId("registerLink"),"onclick",a.hitch(this,function(a){a=esriGeowConfig.createAccount;var b=this.activationcode;b&&(a+="?activationcode\x3d"+b);document.location=a})))}else this.invitation?(a.style(a.byId("left"),"display",!1===esriGeowConfig.showSignUp?
"none":"block"),this._fetchInvitation().then(a.hitch(this,function(b){b.account&&b.account.name&&(this.orgName=b.account.name,a.byId("organizationTitle").innerHTML="\x3ch1\x3e"+a.string.substitute(this.i18n.useOption,{orgName:this.orgName})+"\x3c/h1\x3e",a.style(a.byId("organizationTitle"),"display","block"),b=a.byId("invitationReminder"),a.create("strong",{innerHTML:"\x3cbr/\x3e\x3cbr/\x3e\x3cbr/\x3e"+this.i18n.pleaseNote+"\x3cbr/\x3e"},b),a.create("em",{innerHTML:a.string.substitute(this.i18n.signInExisting,
{orgName:this.orgName})},b),a.style(b,"display","block"))})),a.addClass(a.byId("left"),"invitation"),a.byId("leftPanelTitle").innerHTML=a.string.substitute(this.i18n.firstTimeWith,{portalName:b}),a.addClass(a.byId("leftPanelTitle"),"subtitle"),a.style(a.byId("left"),"width","47%"),a.addClass(a.byId("rightAgo"),"invitation"),a.create("h1",{id:"rightPanelTitle",innerHTML:a.string.substitute(this.i18n.alreadyUsingPortal,{portalName:b})},rightAgo,"first"),a.addClass(a.byId("rightPanelTitle"),"subtitle"),
a.place(a.create("br"),a.byId("rightPanelTitle"),"after"),a.byId("not_a_member_msg")&&(b="\x3cbr/\x3e\x3cbr/\x3e",esriGeowConfig.account_registration&&0<esriGeowConfig.account_registration.length?b+='\x3cspan\x3e\x3ca id\x3d"registerLink" class\x3d"calcite light"\x3e'+this.i18n.createAccount+"\x3c/a\x3e\x3c/span\x3e":esriGeowConfig.accountApi&&0<esriGeowConfig.accountApi.length&&(b+='\x3cspan\x3e\x3cbutton id\x3d"registerLink" class\x3d"calcite light" type\x3d"button" dojotype\x3d"dijit.form.Button"\x3e'+
this.i18n.createNewAccount+"\x3c/button\x3e\x3c/span\x3e"),a.byId("not_a_member_msg").innerHTML=b,a.parser.parse(a.byId("not_a_member_msg")),esriGeowConfig.accountApi&&0<esriGeowConfig.accountApi.length&&a.connect(a.byId("registerLink"),"onclick",a.hitch(this,function(a){a=esriGeowConfig.createAccount;this.invitation&&(a+="?invitation\x3d"+this.invitation);document.location=a})))):this._account.getSelf(a.hitch(this,function(b){function d(){var a=esriGeowConfig.signup,b=this.returnUrl;null!==b?a+=
"?returnUrl\x3d"+b:document.referrer&&-1<document.referrer.indexOf("https://")&&(a+="?returnUrl\x3d"+esriGeowConfig.baseUrl.replace("http:","https:")+"user.html?newUser\x3dtrue");document.location=a}function e(){document.location=esriGeowConfig.createAccount}if(b.urlKey||"singletenant"===b.portalMode){if(a.byId("not_a_member_msg")){var c="\x3cspan\x3e"+a.string.substitute(this.i18n.signinMsg,{account:esriGeowConfig.esriGlobalAccount?esriGeowConfig.esriGlobalAccount:this.i18n.esriGlobalAccount,portal:esriGeowConfig.portalName?
esriGeowConfig.portalName:this.i18n.arcgisOnline})+"\x3c/span\x3e",c=c+"     \x3cbr /\x3e\x3cbr /\x3e"+('    \x3cbutton id\x3d"registerButton" type\x3d"button" dojotype\x3d"dijit.form.Button"\x3e'+a.string.substitute(this.i18n.registerAccount,{account:esriGeowConfig.esriGlobalAccount?esriGeowConfig.esriGlobalAccount:this.i18n.esriGlobalAccount})+"\x3c/button\x3e");esriGeowConfig.account_registration&&0<esriGeowConfig.account_registration.length?(c+="     \x3cbr /\x3e\x3cbr /\x3e",c+='    \x3cspan style\x3d"line-height:20px;"\x3e\x3cb\x3e'+
a.string.substitute(this.i18n.dontHaveAccount,{account:esriGeowConfig.esriGlobalAccount?esriGeowConfig.esriGlobalAccount:this.i18n.esriGlobalAccount})+"\x3c/b\x3e\x3c/span\x3e",c+="     \x3cbr /\x3e",c+='    \x3cspan\x3e\x3ca id\x3d"registerLink"\x3e'+this.i18n.createAccount+"\x3c/a\x3e\x3c/span\x3e "):esriGeowConfig.accountApi&&0<esriGeowConfig.accountApi.length&&(c+="     \x3cbr /\x3e\x3cbr /\x3e",c+='    \x3cspan style\x3d"line-height:20px;"\x3e\x3cb\x3e'+a.string.substitute(this.i18n.dontHaveAccount,
{account:esriGeowConfig.esriGlobalAccount?esriGeowConfig.esriGlobalAccount:this.i18n.esriGlobalAccount})+"\x3c/b\x3e\x3c/span\x3e",c+="     \x3cbr /\x3e",c+='    \x3cspan\x3e\x3cbutton id\x3d"registerLink" type\x3d"button" dojotype\x3d"dijit.form.Button"\x3e'+this.i18n.createAccount+"\x3c/button\x3e\x3c/span\x3e ");a.byId("not_a_member_msg").innerHTML=c;a.parser.parse(a.byId("not_a_member_msg"));a.connect(g.byId("registerButton"),"onClick",d);esriGeowConfig.accountApi&&0<esriGeowConfig.accountApi.length&&
a.connect(g.byId("registerLink"),"onClick",e);a.style(a.byId("left"),"display","singletenant"!==b.portalMode||!1===esriGeowConfig.showSignUp?"none":"block");"singletenant"!==b.portalMode&&b.name&&(a.byId("signInTitle").innerHTML=this.i18n.signInTo+" "+b.name)}}else a.connect(this._agoRegister,"onClick",d),esriGeowConfig.accountApi&&0<esriGeowConfig.accountApi.length&&a.connect(this._agoCreate,"onClick",e),a.connect(this._trialUrl,"onClick",function(){window.location="http://"+document.location.hostname+
"/about/free-trial.html?origin\x3darcgis"}),a.style("trial","display","block"),a.style("left","display","none"),a.style("leftAgo","display",!1===esriGeowConfig.showSignUp?"none":"block")}));this.loadConnections();b=this.returnUrl||null;null!==b&&(this.redirectUrl=b);if(c=this.error){var d={code:c};if("400"!==c&&"403"!==c)this._showError(d);else if(b&&-1!==b.indexOf("viewer.html"))if("400"==c)this._account.getSelf(a.hitch(this,function(a){-1<document.location.href.indexOf(a.customBaseUrl)&&this.signInError({code:400})}));
else return"";else this._showError(d)}a.byId("registerLink")&&(a.byId("registerLink").href=esriGeowConfig.account_registration);this.checkCookieSupport();try{setTimeout(function(){a.byId("user_username").focus()},350)}catch(e){}},checkCookieSupport:function(){if(10>=a.isIE){a.cookie("test","enabled",{path:"/"});var b=a.cookie("test");a.cookie("test",null,{expires:-1});"enabled"!==b&&arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.errorTitle,message:this.i18n.error.cookiesRequired})}else a.cookie.isSupported()||
arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.errorTitle,message:this.i18n.error.cookiesRequired})},loadConnections:function(){a.connect(g.byId("sign-in-form"),"onSubmit",this,"signIn")},signIn:function(b){b.preventDefault();-1!==a.byId("sign-in-error").className.indexOf("error")&&(a.byId("sign-in-error").innerHTML="\x26nbsp;",a.removeClass("sign-in-error","error"));if(!1===this.validateForm())return!1;g.byId("button_sign_in").set("disabled",!0);
g.byId("button_sign_in").set("label",this.i18n.signingIn);this._user=this._user||{};a.mixin(this._user,{username:a.byId("user_username").value,password:a.byId("user_password").value,expiration:a.byId("remember-me").checked?esriGeowConfig.longTokenExpiration:esriGeowConfig.tokenExpiration});this._signin().then(a.hitch(this,"onSignIn"))},onOAuthSignIn:function(){-1!==a.byId("sign-in-error").className.indexOf("error")&&(a.byId("sign-in-error").innerHTML="\x26nbsp;",a.removeClass("sign-in-error","error"))},
checkOAuthResponse:function(b){b=new a._Url(b);b=b.fragment?a.queryToObject(b.fragment):null;b.error?(a.addClass("sign-in-error","error"),a.attr(a.byId("sign-in-error"),"innerHTML",b.error_description+"\x3cbr/\x3e\x3cbr/\x3e"),a.attr(this._iFrame,"src",this._authorizeUrl)):(this._user=a.mixin(this._user,a.mixin(b,{token:b.access_token})),this._geow.signInHandler2(this._user).then(a.hitch(this,"onSignIn")))},onOAuthSignInError:function(b){b&&b.length&&-1!==b[0].toLowerCase().indexOf("not a member")?
(a.addClass("sign-in-error","error"),a.attr(a.byId("sign-in-error"),"innerHTML",this.i18n.error.notOrgMember+"\x3cbr/\x3e\x3cbr/\x3e")):b&&b.length&&(-1!==b[0].toLowerCase().indexOf("too many invalid logins")||-1!==b[0].toLowerCase().indexOf("too many invalid attempts"))?(a.addClass("sign-in-error","error"),a.attr(a.byId("sign-in-error"),"innerHTML",this.i18n.error.tooManyAttempts+"\x3cbr/\x3e\x3cbr/\x3e")):b&&b.length&&-1!==b[0].toLowerCase().indexOf("invalid verification code")?(a.addClass("sign-in-error",
"error"),a.attr(a.byId("sign-in-error"),"innerHTML",this.i18n.error.invalidVerificationCode+"\x3cbr/\x3e\x3cbr/\x3e")):this.signInError({code:400})},onSignIn:function(b,c){this._user=a.mixin(this._user||{},b);this._requestParams.token=this._user.token;this.invitation?this._fetchInvitation().then(a.hitch(this,"onFetchInvitation")):this.activationcode?this._activateAccount().then(a.hitch(this,"_setCookie")).then(a.hitch(this,"routeUser")):(this.returnUrl=!b||!b.noSecurityQuestion?this.returnUrl:esriGeowConfig.baseUrl.replace("http:",
"https:")+"user.html?requireSecurity\x3dtrue",this.routeUser())},_setCookie:function(a){return this._geow.signInHandler2({username:this._user.username,token:this._user.token,expires_in:this._user.expires_in})},onFetchInvitation:function(b,c){var d;if(b&&b.code&&b.message&&(403===b.code||"IdentityManagerBase.1"===b.code)){var e="\x3cp\x3e"+this.i18n.emailInvitation+"\x3c/p\x3e\x3cp\x3e"+this.i18n.clickOkInstructions+"\x3c/p\x3e";d=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();
d.onOkClick=a.hitch(this,function(a,b){a.hide();this.routeUser()},d);d.show({title:this.i18n.notice,message:e})}else if(b&&b.code&&b.message&&400===b.code)e="\x3cp\x3e"+this.i18n.invitationUsedMsg+"\x3c/p\x3e\x3cp\x3e"+this.i18n.clickOkSignIn+"\x3c/p\x3e",d=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),d.onOkClick=a.hitch(this,function(a,b){a.hide();window.location=esriGeowConfig.baseUrl.replace("http:","https:")+esriGeowConfig.signin},d),d.show({title:this.i18n.notice,
message:e});else if(b&&b.id&&b.id===this.invitation){var f="\x3cp\x3e"+a.string.substitute(this.i18n.membershipPending,{account:"\x3cstrong\x3e"+b.account.name+"\x3c/strong\x3e"})+"\x3c/p\x3e";d="\x3cp\x3e\x3cstrong\x3e"+a.string.substitute(this.i18n.ByAcceptingInvite,{account:b.account.name,name:this._user.username})+"\x3c/strong\x3e\x3c/p\x3e\x3cp\x3e\x3cul\x3e\x3cli\x3e"+a.string.substitute(this.i18n.transferMsg,{account:b.account.name,name:this._user.username})+"\x3c/li\x3e\x3cli\x3e"+this.i18n.leaveOrganization+
"\x3c/li\x3e\x3cli\x3e"+a.string.substitute(this.i18n.itemsMsg,{beginStrong:"\x3cstrong\x3e",endStrong:"\x3c/strong\x3e"})+"\x3c/li\x3e\x3cli\x3e"+this.i18n.accountManagedMsg+"\x3c/li\x3e\x3c/ul\x3e\x3c/p\x3e\x3cp\x3e"+a.string.substitute(this.i18n.currentOrNewAccount,{account:b.account.name})+"\x3c/p\x3e";e={title:this.i18n.notice,message:d,choiceOneTitle:this.i18n.useCurrentAccount,choiceTwoTitle:this.i18n.createNewOne};e.choiceOneHandler=a.hitch(this,function(c){b.mustApprove&&!0===b.mustApprove?
(c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),c.onOkClick=a.hitch(this,function(b){b.hide();this._acceptInvitation().then(a.hitch(this,"_setCookie")).then(a.hitch(this,"routeUser"))},c),c.show({title:this.i18n.notice,message:f})):this._acceptInvitation().then(a.hitch(this,"_setCookie")).then(a.hitch(this,"routeUser"))});e.choiceTwoHandler=a.hitch(this,function(a){a=arcgisonline.sharing.util.getSecureUrl();this._geow.signout(a+esriGeowConfig.createAccount+"?invitation\x3d"+
this.invitation)});d=arcgisonline.sharing.dijit.dialog.ChoiceDlg.prototype.statics.getInstance();d.show(e)}else this.routeUser()},onInvitationAcceptedError:function(b,c){var d,e;if(b&&b.code&&b.message&&500===b.code&&"Invitation has already been accepted."===a.trim(b.message)){var f="\x3cp\x3e"+this.i18n.acceptedInvite+"\x3c/p\x3e\x3cp\x3e"+this.i18n.clickOk+"\x3c/p\x3e";d=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();d.onOkClick=a.hitch(this,function(a,b){a.hide();
window.location=e?esriGeowConfig.baseUrl.replace("http:","https:")+esriGeowConfig.signin:esriGeowConfig.baseUrl.replace("http:","https:")+esriGeowConfig.signin+"?invitation\x3d"+this.invitation+"\x26org\x3d"+this.orgName},d);d.show({title:this.i18n.notice,message:f})}else console.log(b),d=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),d.onOkClick=a.hitch(this,function(a,b){a.hide();window.location=e?esriGeowConfig.baseUrl.replace("http:","https:")+esriGeowConfig.signin:
esriGeowConfig.baseUrl.replace("http:","https:")+esriGeowConfig.signin+"?invitation\x3d"+this.invitation+"\x26org\x3d"+this.orgName},d),b.code&&b.message?("User already member of an account."===b.message&&(e=!0,b.message=this.i18n.userAnotheOrg),d.show({title:this.i18n.unableJoin,message:b.message})):d.show({title:this.i18n.unableJoin,message:this.i18n.problemJoingOrg})},onActivationAcceptedError:function(b){b.details=b.details&&b.details.length?a.filter(b.details,"return item !\x3d\x3d null"):null;
b.details&&b.details.length&&(b.details=b.details.join("\x3cbr /\x3e"),b.message=b.message?b.message+"\x3cbr /\x3e"+b.details:b.details);b=a.mixin(a.mixin({},this.i18n.errors.error),b);var c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();c.onOkClick=a.hitch(this,function(a){a.hide();this.routeUser()},c);c.show(b)},routeUser:function(){var b=this.returnUrl,c=esriGeowConfig.baseUrl+esriGeowConfig.signin;b&&-1<b.indexOf(c)&&(b=null);c=this._user=arcgisonline.sharing.util.getUser();
!esriGeowConfig.isDebug&&c&&c.accountId?this._fetchSelf().then(a.hitch(this,"routeOrg")):window.location=b?b:this.redirectUrl},routeOrg:function(b,c){var d=this._user,e=this.returnUrl,f=esriGeowConfig.baseUrl+esriGeowConfig.signin;e&&-1<e.indexOf(f)&&(e=null);var f=this._organization=b||{},g=f.allSSL,h;if(e)d=this._util.parseUrl(e).host,b&&!b.isPortal&&d===b.portalHostname?f.urlKey&&f.customBaseUrl&&-1===d.indexOf(f.urlKey+"."+f.customBaseUrl)&&(h=this._util.getCookie("esri_auth"),this._geow.setAuthCookie(h),
e=e.replace(d,f.urlKey+"."+f.customBaseUrl),e=g?e.replace("http:","https:"):e,e=this._util.getBridgeUrl(e,h)):f&&(!f.isPortal&&f.urlKey&&f.customBaseUrl)&&(h=this._util.getCookie("esri_auth"),this._geow.setAuthCookie(h)),window.location=g?e.replace("http:","https:"):e;else{var k;if(f.urlKey&&f.customBaseUrl){e=(g?"https:":"http:")+"//"+f.urlKey+"."+f.customBaseUrl;h=null;-1===window.location.host.indexOf(f.urlKey+"."+f.customBaseUrl)&&(h=this._util.getCookie("esri_auth"));var e=(g?"https:":"http:")+
"//"+f.urlKey+"."+f.customBaseUrl,m=esriGeowConfig.baseUrl.indexOf(location.host),e=-1<m?e+(esriGeowConfig.baseUrl.substring(m+location.host.length)+("account_admin"===d.role?"organization.html":"index.html")):g?this.redirectUrl.replace("http:","https:"):this.redirectUrl.replace("https:","http:");h&&(this._geow.setAuthCookie(h),e=this._util.getBridgeUrl(e,h));k=g?e.replace("http:","https:"):e}else k="account_admin"===d.role&&!f.urlKey?g?this.setupRedirectUrl.replace("http:","https:"):this.setupRedirectUrl.replace("https:",
"http:"):"account_admin"===d.role&&this.activationcode?g?this.orgRedirectUrl.replace("http:","https:"):this.orgRedirectUrl.replace("https:","http:"):g?this.redirectUrl.replace("http:","https:"):this.redirectUrl.replace("https:","http:");if(f.subscriptionInfo&&"active"!==f.subscriptionInfo.state){var l=arcgisonline.sharing.dijit.dialog.SubscriptionStatusDlg.prototype.statics.getInstance();l.onOkClick=a.hitch(this,function(){l.hide();window.location=k});l.show(f.subscriptionInfo)}else window.location=
k}},validateForm:function(){var a=g.byId("user_username").get("value"),c=g.byId("user_password").get("value"),d=null;if((null===a||""===a)&&(null===c||""===c))d=this.i18n.error.userNamePassRqd;else if(null===a||""===a)d=this.i18n.error.usernameRqd;else if(null===c||""===c)d=this.i18n.error.passRqd;if(null===d)return!0;this._showError({message:d});return!1},signInError:function(b,c){g.byId("button_sign_in").set("disabled",!1);g.byId("button_sign_in").set("label",this.i18n.SignIn);if(void 0!==b&&null!==
b&&""!==b)switch(a.addClass("sign-in-error","error"),b.code){case 400:var d='\x3cb style\x3d"font-size:1.2em;line-height:30px;"\x3e'+a.string.substitute(this.i18n.unableSignIn,{portalName:esriGeowConfig.portalName?esriGeowConfig.portalName:this.i18n.arcgisOnline})+"\x3c/b\x3e\x3cbr/\x3e",d=d+'\x3cspan style\x3d"color:#000000;"\x3e'+(this._util.isPortal()?this.i18n.usernamePasswordSpell+'\x26nbsp;\x26nbsp;\x3ca href\x3d"troubleshoot.html"\x3e'+this.i18n.troubleshootTitle+"\x3c/a\x3e":this.i18n.usernamePasswordSpell),
d=d+"\x3c/span\x3e";this._showError({title:"Sign in error",message:d});try{a.byId("user_username").focus()}catch(e){}break;default:this._showError({message:this.i18n.error.signinError})}},_activateAccount:function(){return this._request(this._accountsUri+"activate",{code:this.activationcode},{usePost:!0,errBack:a.hitch(this,"onActivationAcceptedError")})},_fetchSelf:function(){esriGeowConfig.self=null;return this._request(this._accountsUri+"self?culture\x3d"+a.locale).then(function(a){return esriGeowConfig.self=
a})},_fetchInvitation:function(){return this._request(this._communityUri+"invitations/"+this.invitation,null,{errBack:a.hitch(this,"onFetchInvitation")})},_acceptInvitation:function(){return this._request(this._communityUri+"invitations/"+this.invitation+"/accept",null,{usePost:!0,errBack:a.hitch(this,"onInvitationAcceptedError")})},_signin:function(){var b=new a.Deferred;this._geow.signin({username:this._user.username,password:this._user.password,expiration:this._user.expiration},a.hitch(this,"_resolveDfd",
b),a.hitch(this,"signInError"));return b},_resolveDfd:function(a,c){if(c.error)throw this.signInError(c.error),c.error;a.resolve(c)},_request:function(b,c,d){c=a.mixin(c||{},this._requestParams);return this._util.request({url:b,content:c},d||{}).then(a.hitch(this,function(a){return a.error?d.errBack?d.errBack(a.error):this._showError(a.error):a}),a.hitch(this,function(a){d&&d.errBack?d.errBack(a):this._showError(a);throw a;}))},_showError:function(b){b=b.error||b||{};b.code=b.code||0;var c=b.code;
b=this.i18n.errors[b.code]||b;b.details=b.details&&b.details.length?a.filter(b.details,"return item !\x3d\x3d null"):null;b.details&&b.details.length&&(b.details=b.details.join("\x3cbr /\x3e"),b.message=b.message?b.message+"\x3cbr /\x3e"+b.details:b.details);var d=a.mixin(a.mixin({},this.i18n.errors.error),b);this._account.getSelf(a.hitch(this,function(b){if(("400"===c||"403"===c)&&-1<document.location.href.indexOf(b.customBaseUrl)&&-1===document.location.href.indexOf("error\x3d403"))d.message=this.i18n.error.notOrgMember;
a.addClass("sign-in-error","error");a.attr(a.byId("sign-in-error"),"innerHTML",d.message+"\x3cbr/\x3e\x3cbr/\x3e")}));return!0}})});