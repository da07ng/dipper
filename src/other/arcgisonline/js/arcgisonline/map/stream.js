// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/stream",["dijit","dojo","dojox","dojo/require!arcgisonline/map/main"],function(m,d,n){d.provide("arcgisonline.map.stream");d.require("arcgisonline.map.main");arcgisonline.map.stream={maxTotalFeatures:4E3,addStreamLayer:function(a,b,h,l){var e=a.indexOf("/StreamServer"),g=a.substring(0,e),g=g.substring(g.lastIndexOf("/")+1,g.length);-1<g.indexOf("%")&&(g=arcgisonline.map.main.decodeUrl(g));if(9>=d.isIE)l&&l(),setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:d.string.substitute(esri.i18nBundle.viewer.error.streamLayerNotSupported,{layer:g})})},5E3),arcgisonline.map.main.mapInitialized||arcgisonline.map.main.initMap(),d.publish("layerAddFailed",[]);else{-1==a.indexOf("http")&&(a="http://"+a);b=b||{};b.id||(e=Math.floor(10001*Math.random()),d.mixin(b,{id:"stream_"+e,visibility:!0,opacity:1,title:g,_addedVia:"url",__createDefaultPopup:!0}));var c={layer:null,id:b.id,itemId:b.itemId,url:a,type:"user",subType:"stream",title:b.title,defaultVisibility:b.visibility,
defaultOpacity:b.opacity,layerDefinition:b.layerDefinition,definitionEditor:b.definitionEditor,snippet:"",identify:!1,_addedVia:b._addedVia};b.itemId&&(c.itemId=b.itemId);b.itemCard&&(c.itemCard=b.itemCard);b.popupInfo?(c.popupInfo=b.popupInfo,c.popupChanged=!0):b.disablePopup?(c.disablePopup=!0,c.popupChanged=!0):c.__createDefaultPopup=!0;null!==b.showLegend&&void 0!==b.showLegend&&(c.showLegend=b.showLegend);var f=arcgisonline.map.layer.getLayerPosition(c);arcgisonline.map.main.mapLayers.splice(f.list,
0,c);if(b.resourceInfo)c.serviceInfo=b.resourceInfo,c.serviceInfo.name=c.title,arcgisonline.map.stream.createStreamLayer(c,f.map,h,l);else{var k=d.string.substitute(esri.i18nBundle.viewer.error.layerStillTrying,{layer:c.title}),e=k.indexOf("\x3cbr/\x3e");-1<e&&(b=k.substring(0,e),e=k.substring(e+5),k=b+'\x3cdiv class\x3d"throb-loading"\x3e\x3cdiv class\x3d"throb-loading-text"\x3e'+e+"\x3c/div\x3e\x3c/div\x3e");arcgisonline.map.layer.getServiceInfo(a,k,function(a,b,d){c.serviceInfo=a;c.serviceInfo.name=
c.title;arcgisonline.map.stream.createStreamLayer(c,f.map,h,l)},function(a,b){d.publish("layerAddFailed",[]);setTimeout(function(){var a=d.string.substitute(esri.i18nBundle.viewer.error.layerNotAdded,{layer:c.title});"http"===arcgisonline.sharing.util.parseUrl(c.url).protocol&&"https"===arcgisonline.sharing.util.parseUrl(window.location.href).protocol&&(a=d.string.substitute(esri.i18nBundle.viewer.error.layerNotAddedSecure,{layer:c.title}));arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:a})},5E3);arcgisonline.map.main.mapInitialized||arcgisonline.map.main.initMap();null==arcgisonline.map.save_open.webMapInfo&&null==arcgisonline.map.save_open.itemCard&&0==arcgisonline.map.main.numOperationalLayers()&&arcgisonline.map.main.setTitle(esri.i18nBundle.viewer.defaultMapTitle)})}}},createStreamLayer:function(a,b,h,l){var e=function(a){a.popupInfo?a.layer.setInfoTemplate(new esri.dijit.PopupTemplate(a.popupInfo)):a.__createDefaultPopup&&(a.serviceInfo.fields=a.layer.fields.map(function(a){return{name:a.name,
alias:a.alias,nullable:a.nullable,type:a.type}}),a.popupInfo=arcgisonline.map.popup.getDefaultPopupInfo(a.serviceInfo,!1,a.layer),a.layer.setInfoTemplate(new esri.dijit.PopupTemplate(a.popupInfo)),a.popupChanged=!0);a.onFilterChangeHandler=d.connect(a.layer,"onFilterChange",d.hitch(this,function(a){a.layer.refresh()},a));arcgisonline.map.main.mapInitialized||arcgisonline.map.main.initMap();null!==a.defaultOpacity&&a.layer.setOpacity(a.defaultOpacity);if(a.layerDefinition){if(a.layerDefinition.drawingInfo){var c=
esri.renderer.fromJson(d.clone(a.layerDefinition.drawingInfo.renderer));"esri.renderer.ClassBreaksRenderer"===c.declaredClass&&c.setMaxInclusive(!0);a.layer.setRenderer(c);a.rendererChanged=!0}esri.isDefined(a.layerDefinition.minScale)&&esri.isDefined(a.layerDefinition.maxScale)&&(a.layer.setScaleRange(a.layerDefinition.minScale,a.layerDefinition.maxScale),a.scaleChanged=!0)}arcgisonline.map.itemData.checkItemDataContent(a);!arcgisonline.map.main.isMapFullyLoaded&&-1==document.location.href.indexOf("layers\x3d")&&
document.location.href.indexOf("services\x3d");arcgisonline.map.main.map.addLayer(a.layer,b);arcgisonline.map.popup.setupPopupHandler();null!=arcgisonline.map.save_open.itemCard&&null!=a.itemCard&&arcgisonline.map.save_open.itemCard.id==a.itemCard.id?(null==arcgisonline.map.save_open.webMapInfo&&arcgisonline.map.main.setTitle(a.itemCard.title),arcgisonline.map.main.hasMapOnly()||(arcgisonline.map.leftPanel.recreateAboutStack(),arcgisonline.map.leftPanel.openLeftTOCPanel())):null==arcgisonline.map.save_open.webMapInfo&&
null==arcgisonline.map.save_open.itemCard&&arcgisonline.map.main.setTitle(esri.i18nBundle.viewer.defaultMapTitle);d.publish("layerAdded",[a.id]);h&&h(a.layer)},g=a.url,c={resourceInfo:a.serviceInfo,opacity:a.defaultOpacity,visible:a.defaultVisibility,id:a.id,purgeOptions:{displayCount:arcgisonline.map.stream.maxTotalFeatures}},f,k=a.serviceInfo.timeInfo&&a.serviceInfo.timeInfo.trackIdField;a.layerDefinition?(a.layerDefinition.definitionGeometry&&(f=f||{},f.geometry=new esri.geometry.Extent(a.layerDefinition.definitionGeometry),
a.spatialFilterChanged=!0),esri.isDefined(a.layerDefinition.definitionExpression)&&(f=f||{},f.where=a.layerDefinition.definitionExpression,a.defExpChanged=!0),esri.isDefined(a.layerDefinition.maximumTrackPoints)?(c.maximumTrackPoints=a.layerDefinition.maximumTrackPoints,a.maximumTrackPointsChanged=!0):k&&(c.maximumTrackPoints=1)):k&&(c.maximumTrackPoints=1);f&&(c.filter=f);a.purgeOptions&&(c.purgeOptions=a.purgeOptions);a.layer=new esri.layers.StreamLayer(g,c);a.layer.loaded?e(a):d.connect(a.layer,
"onLoad",d.hitch(this,e,a));a.onError=d.connect(a.layer,"onError",d.hitch(this,function(a,b){console.log("err",d.json.stringify(b));b.msg&&console.log("err.msg",b.msg);if(a.successfulDraw)b.msg&&-1<b.msg.indexOf("WebSocket connection")&&(console.log("WebSocket connection error. Trying again."),setTimeout(d.hitch(this,function(){a.layer.connect();a.layer.resume()},a),1E3));else{l&&l();var c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),e=d.string.substitute(esri.i18nBundle.viewer.error.layerNotAdded,
{layer:a.title});"http"===arcgisonline.sharing.util.parseUrl(a.url).protocol&&"https"===arcgisonline.sharing.util.parseUrl(window.location.href).protocol&&(e=d.string.substitute(esri.i18nBundle.viewer.error.layerNotAddedSecure,{layer:a.title}));c.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:e});arcgisonline.map.layer.removeLayer(a);d.publish("layerAddFailed",[a.id]);arcgisonline.map.main.mapInitialized||arcgisonline.map.main.initMap()}},a));a.onConnect=d.connect(a.layer,"onConnect",
d.hitch(this,function(){a.successfulDraw=!0;d.disconnect(a.onConnect);a.onConnect=null},a))},buildConfig:function(a){var b={layerType:"ArcGISStreamLayer"};b.id=a.id;b.url=a.url;b.title=a.title;b.visibility=a.layer?a.layer.visible:a.defaultVisibility;b.opacity=a.layer&&(a.layer.opacity||0===a.layer.opacity)?a.layer.opacity:null==a.layer&&null!==a.defaultOpacity?a.defaultOpacity:1;a.itemId&&(b.itemId=a.itemId);if(a.defExpChanged||a.spatialFilterChanged||a.rendererChanged||a.scaleChanged||a.maximumTrackPointsChanged){if(a.itemId){var h=
arcgisonline.map.itemData.itemDataContents[a.itemId];b.layerDefinition=h&&h.layerDefinition?d.clone(h.layerDefinition):{};a.layerDefinition&&d.mixin(b.layerDefinition,a.layerDefinition)}else b.layerDefinition=a.layerDefinition?d.clone(a.layerDefinition):{};b.layerDefinition.drawingInfo=b.layerDefinition.drawingInfo||{};b.layerDefinition.drawingInfo.renderer=a.layer.renderer.toJson();b.layerDefinition.minScale=a.layer.minScale?a.layer.minScale:0;b.layerDefinition.maxScale=a.layer.maxScale&&1!==a.layer.maxScale?
a.layer.maxScale:0;0===b.layerDefinition.minScale&&0===b.layerDefinition.maxScale&&(delete b.layerDefinition.minScale,delete b.layerDefinition.maxScale)}a.defExpChanged&&(b.layerDefinition&&b.layerDefinition.definitionExpression&&a.definitionEditor)&&(b.definitionEditor=d.clone(a.definitionEditor));a.popupInfo&&a.popupChanged&&(b.popupInfo=a.popupInfo);a.disablePopup&&a.popupChanged&&(b.disablePopup=!0);a.legendChanged&&!1===a.showLegend&&(b.showLegend=!1);return b}}});