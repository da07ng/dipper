// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/dijit/Legend",["dijit","dojo","dojox","dojo/require!dijit/_Widget,dijit/_Templated"],function(e,b,k){b.provide("arcgisonline.map.dijit.Legend");b.require("dijit._Widget");b.require("dijit._Templated");b.declare("arcgisonline.map.dijit.Legend",[e._Widget,e._Templated],{widgetsInTemplate:!0,templateString:'\x3cdiv dojoType\x3d"dijit.layout.BorderContainer" region\x3d"top"\x3e\r\n    \x3cdiv id\x3d"legendContentHeader" class\x3d"panel panel_left" dojoType\x3d"dijit.layout.ContentPane" region\x3d"top"\x3e\r\n    \t\x3cdiv id\x3d"legendContentButtons" class\x3d"viewerPanelButtons"\x3e\r\n        \t\x3cdiv class\x3d"esriFloatLeading"\x3e\r\n           \t \t\x3cbutton dojotype\x3d"dijit.form.Button" type\x3d"button" id\x3d"webmap-details-legend-about" iconclass\x3d"esriDetailsAboutIcon" title\x3d"${i18n.about}"\x3e\x3c/button\x3e\r\n            \t\x3cbutton dojotype\x3d"dijit.form.Button" type\x3d"button" id\x3d"webmap-details-legend-content" iconclass\x3d"esriDetailsContentsIcon" title\x3d"${i18n.showContents}"\x3e\x3c/button\x3e\r\n            \t\x3cbutton dojotype\x3d"dijit.form.ToggleButton" id\x3d"webmap-details-legend" iconclass\x3d"esriDetailsLegendIcon" title\x3d"${i18n.showLegend}"\x3e\x3c/button\x3e\r\n            \x3c/div\x3e\r\n\t        \x3cdiv class\x3d"esriFloatTrailing" style\x3d"display:inline; padding-top:5px;"\x3e\x3ca href\x3d"JavaScript:void(0);" dojoAttachPoint\x3d"_closeBtn" title\x3d"${i18n.close}" class\x3d"panel panel_close panel_collapse"\x3e\x3cimg src\x3d"images/close.gif" border\x3d"0"/\x3e\x3c/a\x3e\x3c/div\x3e\r\n        \x3c/div\x3e\x3c!-- style\x3d"border-bottom: #333 thin solid;"--\x3e\r\n        \x3cdiv id\x3d"legendContentTitle" class\x3d"panelSubHeader panel_title panel_subtitle"\x3e${i18n.legendPanelTitle}\x3c/div\x3e\r\n    \x3c/div\x3e\r\n\r\n    \x3cdiv id\x3d"legendContentPane" dojoType\x3d"dijit.layout.ContentPane" region\x3d"center" style\x3d"overflow-x:hidden;overflow-y:auto;position:relative;" class\x3d"scrollPane"\x3e\r\n        \x3cdiv id\x3d"legend-main"\x3e\r\n        \x3c/div\x3e\r\n    \x3c/div\x3e \r\n   \r\n    \x3cdiv id\x3d"legendContentFooter" dojoType\x3d"dijit.layout.ContentPane" region\x3d"bottom" style\x3d"height:40px; padding: 0 5px 0 5px; display:none;"\x3e \r\n      \x3cdiv class\x3d"footer" id\x3d"legendSiteFooter" dojotype\x3d"arcgisonline.sharing.dijit.SiteFooterMap" style\x3d"white-space:normal;"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n\r\n\x3c/div\x3e',
i18n:null,legend:null,container:null,numCurrentLegendRequests:0,intervalTimer:null,needsRefresh:!1,_eventConnections:[],constructor:function(a,b){null!=a&&a.containerNode&&(this.container=a.containerNode)},postMixInProperties:function(){this.inherited(arguments);this.i18n=b.i18n.getLocalization("arcgisonline","arcgisonline").common;b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").legendPanel)},postCreate:function(){this.container.addChild(e.byId("legendPanel"));isEmbedded||
b.style(b.byId("legendContentFooter"),"display","");this.loadConnections()},loadConnections:function(){b.connect(e.byId("leftContentPanel"),"resize",this,"adjustHeight");b.connect(e.byId("webmap-details-legend-about"),"onClick",this,"openAboutStack");b.connect(e.byId("webmap-details-legend-content"),"onClick",this,"openContentStack");e.byId("webmap-details-legend").set("checked",!0);b.connect(this._closeBtn,"onclick",this,"onClose")},onClose:function(a){a.preventDefault();arcgisonline.map.leftPanel.hideLeftContentPanel()},
destroy:function(){this.inherited(arguments);b.forEach(this._eventConnections,b.disconnect)},loadContent:function(){if(arcgisonline.map.main.isMapFullyLoaded)this.loadLegend(),setTimeout(function(){e.byId("legendPanel").adjustHeight()},100);else var a=0,d=setInterval(b.hitch(this,function(){arcgisonline.map.main.isMapFullyLoaded&&(clearInterval(d),this.loadLegend(),setTimeout(function(){e.byId("legendPanel").adjustHeight()},100));a++;100<a&&clearInterval(d)}),500)},loadLegend:function(){this.buildLayersList().then(b.hitch(this,
function(a){this.legend=new esri.dijit.Legend({layerInfos:a,map:arcgisonline.map.main.map,arrangement:esri.dijit.Legend.ALIGN_LEFT},"legend-main");this.legend._legendUrl=esriGeowConfig.legend;this.legend.startup();this.onLayerAddHndl||(this.onLayerAddHndl=b.connect(arcgisonline.map.main.map,"onLayerAdd",b.hitch(this,"updateLegend")),this.onLayerRemoveHndl=b.connect(arcgisonline.map.main.map,"onLayerRemove",b.hitch(this,"updateLegend")),this.onLayerReorderHndl=b.connect(arcgisonline.map.main.map,"onLayersReordered",
b.hitch(this,"updateLegend")),this.onLayerUpdateHndl=b.subscribe("onLayerUpdate",null,b.hitch(this,"updateLegend")))}))},updateLegend:function(a){if(!a||!(a instanceof esri.layers.Layer&&a.mode===esri.layers.FeatureLayer.MODE_SELECTION))if(!a||!(a instanceof esri.layers.Layer&&!1===a.visible)){if(a&&b.isArray(a)&&a.length&&"string"==typeof a[0]){for(var d=!0,g=0;g<a.length;g++){var c=arcgisonline.map.main.map.getLayer(a[0]).mode;if(!c||c!==esri.layers.FeatureLayer.MODE_SELECTION){d=!1;break}}if(d)return}"legendStack"!==
leftPanel.visibleStack?this.needsRefresh=!0:this.buildLayersList().then(b.hitch(this,function(a){this.legend.refresh(a);this.needsRefresh=!1}))}},buildLayersList:function(){var a=new b.Deferred,d=[];b.forEach(arcgisonline.map.main.mapLayers,function(a){(!a||!(a.layer instanceof esri.layers.FeatureLayer&&a.layer.mode===esri.layers.FeatureLayer.MODE_SELECTION))&&d.push(this.buildOneLayer(a))},this);(new b.DeferredList(d)).addCallback(function(d){var c=[];b.forEach(d,function(a){a[1]&&(c=c.concat(a[1]))});
a.callback(c)});return a},buildOneLayer:function(a){var d=new b.Deferred,e=[];if(a&&("base"!=a.type&&"labels"!=a.type&&!1!==a.showLegend||("base"==a.type||"labels"==a.type)&&!0===a.showLegend))if(a.layers)b.forEach(a.layers,function(b){if("esri.layers.FeatureLayer"===b.declaredClass&&!b.url&&!1!==b.__showLegend){var c=b.name;-1==c.indexOf(a.title)&&(c=a.title+" - "+c);var d=b.renderer;e.push({layer:b,title:c,defaultSymbol:d&&d.defaultSymbol&&d.defaultLabel?!0:!1})}},this);else if(a.layer){var c=a.layer.renderer,
c={layer:a.layer,title:a.title,defaultSymbol:!c||c&&c.defaultSymbol&&c.defaultLabel?!0:!1};a.layer instanceof esri.layers.ArcGISImageServiceLayer&&(c.defaultSymbol=!0);if(a.layer instanceof esri.layers.GeoRSSLayer){var f=[],h=a.layer.getFeatureLayers();b.forEach(h,function(a){!1==a.__showLegend&&f.push(a.id)});f.length&&(c.hideLayers=f)}else a.itemLayers&&(f=b.map(b.filter(a.itemLayers,function(a){return!1===a.showLegend}),function(a){return a.id}),f.length&&(c.hideLayers=f),a.rendererChanged&&delete a.layer.legendResponse);
e.push(c)}d.callback(e);return d},openAboutStack:function(){leftPanel.showStack("aboutStack")},openContentStack:function(){leftPanel.showStack("contentStack")},adjustHeight:function(a){if(!("undefined"==typeof leftPanel||"legendStack"!=leftPanel.visibleStack)){a=b.coords(b.byId("leftPanelDiv")).h;var d=b.coords(b.byId("legendContentHeader")).h,e=b.coords(b.byId("legendSiteFooter_links")).h+10;b.style(b.byId("legendContentFooter"),"height",e+"px");b.style(b.byId("legendContentPane"),"height",a-(d+
e)+"px")}}})});