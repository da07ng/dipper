// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/dijit/toc/analysis",["dijit","dojo","dojox","dojo/require!esri/dijit/analysis/AnalysisBase,dojo/topic,dojo/Deferred,dojo/promise/all,arcgisonline/map/role,arcgisonline/sharing/util,arcgisonline/map/main"],function(h,c,p){c.provide("arcgisonline.map.dijit.toc.analysis");c.require("esri.dijit.analysis.AnalysisBase");c.require("dojo.topic");c.require("dojo.Deferred");c.require("dojo.promise.all");c.require("arcgisonline.map.role");c.require("arcgisonline.sharing.util");c.require("arcgisonline.map.main");
arcgisonline.map.dijit.toc.analysis={mapLayer:null,menuSubLayerPos:null,_gpSubscribeHandlers:null,_outFeatLyrArr:[],_isKmlNetworkLinkFolder:null,_kmlFcollbycurfolder:null,_kmlAnalysisLayer:null,util:arcgisonline.sharing.util,role:arcgisonline.map.role,i18n:null,destroy:function(){arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers&&(c.forEach(arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers,function(a){a.remove()}),arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers=null)},buildAnalysisJobNode:function(a){var d=
h.byId("tocPanel").hasAnySubLayers,b="",e=arcgisonline.sharing.util.relativeToExplicitUrl("js/arcgisonline/map/css/images/LoadingAnimation_circle16blue.gif"),b=b+('\x3cdiv id\x3d"'+a.id+'" class\x3d"toc_layer'+(d?"esriLeadingMargin102":"")+' analysisJobLayer" style\x3d"width:95%;"\x3e'),b=b+'\x3ctable cellpadding\x3d"0" cellspacing\x3d"0"\x3e\x3ctr\x3e\x3ctd width\x3d"9"\x3e\x3c/td\x3e',b=b+'\x3ctd valign\x3d"top" width\x3d"20"\x3e',b=b+('\x3cdiv id\x3d"'+a.id+'_check" class\x3d"esriFloatLeading" style\x3d"display:inline;width:17px;"\x3e\x3cinput id\x3d"'+
a.id+'_checkbox" dojotype\x3d"dijit.form.CheckBox" type\x3d"checkbox" disabled\x3d\'true\''),b=b+' checked\x3d"true"',b=b+"/\x3e\x3c/div\x3e",b=b+"\x3c/td\x3e\x3ctd\x3e",b=b+("\x3cspan\x3e"+p.html.entities.encode(a.title.replace(/\_/g," "))+"\x3c/span\x3e"),b=b+"\x3c/td\x3e",b=b+'\x3ctd class\x3d"esriFloatTrailing esriLeadingMargin05 esriTrailingMargin05" style\x3d\'\' valign\x3d"top"\x3e',b=b+("\x3cimg src\x3d"+e+" height\x3d'16' width\x3d'16'\x3e"),b=b+"\x3c/td\x3e",b=b+'\x3ctd valign\x3d"top"\x3e',
b=b+("\x3cdiv class\x3d'esriFloatTrailing' id\x3d\""+a.id+"_cancelDiv\" style\x3d'display:inline;opacity:1.0;z-index:1;visibility:hidden;'\x3e");if(a.isCancel||-1===c.indexOf("TraceDownstream CreateWatersheds CreateViewshed CreateDriveTimeAreas EnrichLayer SummarizeNearby FindNearest PlanRoutes".split(" "),a.toolName)||"SummarizeNearby"===a.toolName&&"StraightLine"===a.jobParams.nearType||("FindNearest"===a.toolName||"ConnectOriginsToDestinations"===a.toolName)&&"StraightLine"===a.jobParams.measurementType)b+=
"\x3ca href\x3d\"JavaScript:dijit.byId('tocPanel').cancelAnalysis('"+a.id+"');\" title\x3d'"+esri.i18nBundle.tocPanel.cancelAnalysis+'\'\x3e\x3cimg src\x3d"images/close.gif" border\x3d"0"/\x3e\x3c/a\x3e',a.isCancel=!0;b+="\x3c/div\x3e";b+="\x3c/td\x3e";b+="\x3c/tr\x3e\x3c/table\x3e";b+="\x3c/div\x3e";b+='\x3cdiv id\x3d"'+a.id+'_sub" class\x3d"toc_toggle_layer" style\x3d"display:none;"\x3e';b+="";return b+="\x3c/div\x3e"},cancelAnalysis:function(a){arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a]&&
(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a].tool.cancel(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a].jobInfo),c.destroy(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a].id),delete arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a])},checkAnalysisJobs:function(){this.i18n||(this.i18n={},this.i18n=c.i18n.getLocalization("arcgisonline","arcgisonline").common,c.mixin(this.i18n,c.i18n.getLocalization("arcgisonline","arcgisonline").tocPanel),c.mixin(this.i18n,c.i18n.getLocalization("arcgisonline",
"arcgisonline").analysisTool));this._setAnalysisHandlers();var a=this.getGpServer();if(esri.isDefined(this._outFeatLyrArr))for(var d in this._outFeatLyrArr)if(this._outFeatLyrArr.hasOwnProperty(d)){var b=this._outFeatLyrArr[d];if(esri.isDefined(b)){var e=new esri.dijit.analysis.AnalysisBase({analysisGpServer:a,toolName:b.toolName,toolServiceUrl:a+"/"+b.toolName,getResultLyrInfos:b.jobInfo.getResultLyrInfos,resultParameter:b.jobInfo.resultParameter,jobParams:b.jobInfo,currentGpItemId:b.jobInfo.currentGpItemId,
itemParams:b.jobInfo.itemParams});this._loadConnections(e);b.jobInfo&&b.jobInfo.jobId&&e.checkJobStatus(b.jobInfo.jobId);esri.isDefined(this._outFeatLyrArr[d].tool)||(this._outFeatLyrArr[d].tool=e)}}},_loadConnections:function(a){a.on("close",c.hitch(this,this._onClose));a.on("start",c.hitch(this,function(d){var b={},b=c.mixin({},d);b.tool=a;arcgisonline.map.dijit.toc.analysis.setToolWarningMessages();if(a.map){d=a.get("drawLayer");var e=[];d instanceof Array?e=d:e.push(d);c.forEach(e,function(a,
d){if(a){var b={layer:a,id:a.id,type:"user",title:a.name,defaultVisibility:!0,defaultOpacity:1,snippet:"",showLegend:!0,identify:!1},e=arcgisonline.map.layer.getLayerPosition(b);arcgisonline.map.main.mapLayers.splice(e.list,0,b);e=e.map;arcgisonline.map.main.map.removeLayer(b.layer);arcgisonline.map.main.map.addLayer(b.layer,e,function(){c.publish("onLayerUpdate",[""])})}})}c.topic.publish("Analysis/OnExecute",b)}));a.on("job-submit",c.hitch(this,function(a){c.topic.publish("Analysis/OnJobSubmit",
a)}));a.on("job-status",c.hitch(this,function(a){c.topic.publish("Analysis/OnJobStatus",a)}));a.on("job-result",c.hitch(this,function(a){c.topic.publish("Analysis/OnJobResult",a)}));a.on("job-success",c.hitch(this,function(a){c.topic.publish("Analysis/OnJobSuccess",a)}));a.on("job-fail",c.hitch(this,function(d){var b="";d.message&&(b=d.message);"warning"===d.type&&a.set("disableRunAnalysis",!1);arcgisonline.map.dijit.toc.analysis.showInfoDialog({title:this.i18n.errorTitle,message:b});c.topic.publish("Analysis/OnJobFailed",
d)}));a.on("job-cancel",c.hitch(this,function(a){c.topic.publish("Analysis/OnJobSuccess",a)}))},getGpServer:function(){var a="";return a=esriGeowConfig.isAnalysisDebugServer?esriGeowConfig.analysisDebugServerUrl:esriGeowConfig.self.helperServices.analysis&&esriGeowConfig.self.helperServices.analysis.url?esriGeowConfig.self.helperServices.analysis.url:null},isPerformAnalysisLayer:function(a,c){var b=arcgisonline.map.featColl.isFeatureCollection(a),e="mapNotes"===a.type,f=a.layer instanceof esri.layers.FeatureLayer&&
esri.isDefined(a.layer.geometryType)&&!(a.layer instanceof esri.layers.StreamLayer),g=a.layer instanceof esri.layers.GeoRSSLayer,m=a.layer instanceof esri.layers.CSVLayer,l=b&&!e&&-1!==c,k=esri.isDefined(a.analysisProxyCheck)?"failure"===a.analysisProxyCheck:!1;return(f||b&&l||g||m||e)&&!k},getRunningJobs:function(){return this._outFeatLyrArr},getToolWarningMessages:function(){return this._warnings},updateToolWarningMessages:function(a){this._warnings||(this._warnings=[]);return this._warnings.push(a)},
setToolWarningMessages:function(a){this._warnings||(this._warnings=a||[])},getJobsList:function(){var a=[],c;if(esri.isDefined(this._outFeatLyrArr))for(var b in this._outFeatLyrArr)this._outFeatLyrArr.hasOwnProperty(b)&&(c=this._outFeatLyrArr[b])&&(c.jobInfo&&c.jobInfo.jobId)&&a.push({id:c.id,title:c.title,toolName:c.toolName,jobInfo:{jobId:c.jobInfo.jobId,resultParameter:c.jobInfo.resultParameter,returnProcessInfo:c.jobInfo.returnProcessInfo,getResultLyrInfos:c.jobInfo.getResultLyrInfos,OutputName:c.jobInfo.jobParams.OutputName,
currentGpItemId:c.jobInfo.currentGpItemId,itemParams:c.jobInfo.itemParams},isCancel:c.isCancel});return a},setJobsList:function(a){this._outFeatLyrArr=[];c.forEach(a,c.hitch(this,function(a,c){this._outFeatLyrArr[a.id]=a}))},isAnalysisLayer:function(a){var c=arcgisonline.map.featColl.isFeatureCollection(a),b="mapNotes"===a.type,e=a.layer instanceof esri.layers.FeatureLayer&&!(a.layer instanceof esri.layers.StreamLayer),f=a.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer,g="base"===a.type||
"labels"===a.type,m=a.layer instanceof esri.layers.ArcGISTiledMapServiceLayer,l=a.layer instanceof esri.layers.GeoRSSLayer,k=a.layer instanceof esri.layers.CSVLayer,q=c&&!b,r=arcgisonline.map.main.hasDynamicLayers(a)&&a.thematicGroup,h=a.layer instanceof esri.layers.KMLLayer&&arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer;a=esri.isDefined(a.analysisProxyCheck)?"failure"===a.analysisProxyCheck:!1;return(e||c||l||k||q||m||f||b||h)&&!g&&!r&&!a},hasShapeField:function(a){return a.fields||0<a.fields.length?
c.some(a.fields,function(a){return a&&"esriFieldTypeGeometry"===a.type?!0:!1},this):!1},isPortalHostedService:function(a){var d=arcgisonline.sharing.util.getUser(),b=arcgisonline.sharing.util.portalSupportsHostedServices(),e=a.itemCard;a=a.itemId;return d&&b&&a&&e&&e.typeKeywords&&-1<c.indexOf(e.typeKeywords,"Hosted Service")},_getFlayers:function(a,d){if(d){var b=c.mixin({},d),e=[],f=!0;c.forEach(b.layers,function(b,d){if("Feature Layer"===b.type){f=arcgisonline.map.dijit.toc.analysis.hasShapeField(b)||
a.queryServiceUrl;var l;!f&&a.itemLayers&&c.forEach(a.itemLayers,function(a){a.id===b.id&&(a.layerUrl&&arcgisonline.sharing.util.isHostedService(a.layerUrl))&&(f=!0,l=a.layerUrl)});b._isAnalysisSubLayer=d===arcgisonline.map.dijit.toc.analysis.menuSubLayerPos;if(-1!==b.capabilities.toLowerCase().indexOf("query")&&b.geometryType&&f){b.url=l?l:a.queryLayersInfo?a.queryServiceUrl+"/"+b.id:a.url+"/"+b.id;a.layer.credential&&(b.credential=a.layer.credential);esri.isDefined(a.layer.layerDefinitions)&&a.layer.layerDefinitions[b.id]&&
(b.definitionExpression=a.layer.layerDefinitions[b.id]);var k=new esri.layers.FeatureLayer(b.url,{mode:esri.layers.FeatureLayer.MODE_SNAPSHOT});k._isAnalysisSubLayer=b._isAnalysisSubLayer;esri.isDefined(b.credential)&&(k.credential=b.credential);esri.isDefined(b.definitionExpression)&&(k.definitionExpression=b.definitionExpression);a.layer.getMap()&&(k._map=a.layer.getMap());b.timeInfo&&b.useStandardizedQueries&&(k._useStandardizedQueries=b.useStandardizedQueries);e.push(k)}}});return e}},_getLayers:function(a){var d=
new c.Deferred;if(arcgisonline.map.dijit.toc.analysis.isMS(a))if(a.queryServiceUrl)a.queryServiceUrl&&(a.queryLayersInfo?(a.flayers=arcgisonline.map.dijit.toc.analysis._getFlayers(a,a.queryLayersInfo),d.resolve(a)):arcgisonline.map.main.getQueryLayersInfo(a,function(b){a.flayers=arcgisonline.map.dijit.toc.analysis._getFlayers(a,b);d.resolve(a)}));else if(a.layersInfo&&(!a.itemLayers||0===a.itemLayers.length))a.flayers=arcgisonline.map.dijit.toc.analysis._getFlayers(a,a.layersInfo),d.resolve(a);else if(a.itemLayers&&
0<a.itemLayers.length){var b=[];c.forEach(a.itemLayers,function(a){var d;a._layerInfo&&(d=c.mixin({},a._layerInfo),d.url=a.layerUrl,b.push(d))});0<b.length?(a.flayers=arcgisonline.map.dijit.toc.analysis._getFlayers(a,{layers:b}),d.resolve(a)):arcgisonline.map.main.getLayersInfo(a,function(b){a.flayers=arcgisonline.map.dijit.toc.analysis._getFlayers(a,b);d.resolve(a)})}else arcgisonline.map.main.getLayersInfo(a,function(b){a.flayers=arcgisonline.map.dijit.toc.analysis._getFlayers(a,b);d.resolve(a)});
else d.resolve(a);return d},configureAnalysis:function(a,d){var b=[],e,f,g,m;(!esri.isDefined(d)||esri.isDefined(d)&&!d.isMenu)&&h.byId("webmap-analysis").set("checked",!0);arcgisonline.map.dijit.toc.analysis.i18n||(arcgisonline.map.dijit.toc.analysis.i18n={},arcgisonline.map.dijit.toc.analysis.i18n=c.i18n.getLocalization("arcgisonline","arcgisonline").common,c.mixin(this.i18n,c.i18n.getLocalization("arcgisonline","arcgisonline").tocPanel),c.mixin(this.i18n,c.i18n.getLocalization("arcgisonline","arcgisonline").analysisTool));
d&&!d.isMenu?(arcgisonline.map.dijit.toc.analysis.mapLayer=d.mapLayer,arcgisonline.map.dijit.toc.analysis.menuSubLayerPos=d.menuSubLayerPos,arcgisonline.map.dijit.toc.analysis._isKmlNetworkLinkFolder=d.isKmlNetworkLinkFolder,arcgisonline.map.dijit.toc.analysis._kmlFcollbycurfolder=d.kmlFcollbycurfolder,arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer=d.kmlAnalysisLayer):d&&d.isMenu&&arcgisonline.map.dijit.toc.analysis.clear();f=arcgisonline.map.main.mapLayers.slice(0);a&&a.analysisType&&(m=a.analysisType);
esri.isDefined(arcgisonline.map.main.analysisProps.selectedFolder)||(arcgisonline.map.save_open.webMapInfo&&arcgisonline.map.save_open.webMapInfo.ownerFolder?arcgisonline.map.main.analysisProps.selectedFolder=arcgisonline.map.save_open.webMapInfo.ownerFolder:c.cookie("ESRI_Content")&&c.fromJson(c.cookie("ESRI_Content")).folderId&&(arcgisonline.map.main.analysisProps.selectedFolder=c.fromJson(c.cookie("ESRI_Content")).folderId));if(arcgisonline.map.dijit.toc.analysis._isKmlNetworkLinkFolder){var l=
{};l.layer=arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer;l.id=arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer.id;l.title=arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer.title;e=l;f.push(e)}else e=arcgisonline.map.dijit.toc.analysis.mapLayer;arcgisonline.map.dijit.toc.analysis._setAnalysisHandlers();var k=[];c.forEach(f,function(a,b){arcgisonline.map.dijit.toc.analysis.isAnalysisLayer(a)&&k.push(arcgisonline.map.dijit.toc.analysis._getLayers(a))});(new c.promise.all(k)).then(function(f){b=
c.mixin([],f.reverse());c.forEach(f,function(a){e&&a.id===e.id&&(g=a)});c.forEach(b,function(a,d){var e=arcgisonline.sharing.util.getUser(),f="mapNotes"===a.type,l=a.layer instanceof esri.layers.GeoRSSLayer,k=a.layer instanceof esri.layers.CSVLayer,h=arcgisonline.map.featColl.isFeatureCollection(a)&&!f;if(arcgisonline.map.dijit.toc.analysis.isHostedFeatureLayer(a)){if(a.layer&&a.layer.fields){var p=arcgisonline.map.popup.getPopupInfo(a,null);c.forEach(a.layer.fields,function(a){a.alias=arcgisonline.map.dijit.toc.analysis.getLabelFromPopup(p,
a.name)||a.alias})}l||k?(a.userIsAdmin=!0,a.layer.capabilities?-1===a.layer.capabilities.indexOf("Extract")&&(a.layer.capabilities+=",Extract"):a.layer.capabilities="Extract"):f||h?(a.userIsAdmin=!0,a.layers&&0<a.layers.length?a.layers=c.map(a.layers,function(a){a.capabilities?-1===a.capabilities.indexOf("Extract")&&(a.capabilities+=",Extract"):a.capabilities="Extract";return a}):(a.userIsAdmin=!0,a.layer.capabilities?-1===a.layer.capabilities.indexOf("Extract")&&(a.layer.capabilities+=",Extract"):
a.layer.capabilities="Extract")):esriGeowConfig.userRole.isAdmin()&&a.url&&-1<a.url.indexOf("/"+e.accountId+"/")?(a.userIsAdmin=!0,a.layer.capabilities?-1===a.layer.capabilities.indexOf("Extract")&&(a.layer.capabilities+=",Extract"):a.layer.capabilities="Extract"):e&&(a.itemCard&&a.itemCard.owner&&a.itemCard.owner===e.email&&-1<a.url.indexOf("/"+e.accountId+"/"))&&(a.userIsAdmin=!0,a.layer.capabilities?-1===a.layer.capabilities.indexOf("Extract")&&(a.layer.capabilities+=",Extract"):a.layer.capabilities=
"Extract");g&&g.id===a.id&&(g=c.mixin({},a),h&&(g.layers&&0<g.layers.length)&&(g.layer=g.layers[arcgisonline.map.dijit.toc.analysis.menuSubLayerPos],delete g.layers))}else if(a.layer instanceof esri.layers.KMLLayer&&arcgisonline.map.dijit.toc.analysis._kmlFcollbycurfolder&&0<arcgisonline.map.dijit.toc.analysis._kmlFcollbycurfolder.length&&arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer&&arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer.id===a.id){var n=[];c.forEach(arcgisonline.map.dijit.toc.analysis._kmlFcollbycurfolder,
function(b,d){var e,f;e=new esri.layers.FeatureLayer(c.clone(b),{mode:esri.layers.FeatureLayer.MODE_SNAPSHOT});arcgisonline.map.dijit.toc.analysis._isKmlNetworkLinkFolder?(e.name=arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer.name,e.id=a.id):(f=a.layer.folders[arcgisonline.map.dijit.toc.analysis.menuSubLayerPos],e.name=a.title+"_"+f.name,e.id=f.name);n.push(e)});c.forEach(n,function(c,e){1<n.length&&c.geometryType===m&&g.id===a.id?(g={},g.layer=c,g.title=c.name,a=g,b.splice(d,1,g)):g.id===
a.id&&0===e&&(g={},g.layer=n[0],g.title=n[0].name,a=g,b.splice(d,1,g))})}});arcgisonline.map.dijit.toc.analysis._kmlFcollbycurfolder&&(0<arcgisonline.map.dijit.toc.analysis._kmlFcollbycurfolder.length&&arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer)&&(b=c.filter(b,function(a){return!(a.layer instanceof esri.layers.KMLLayer)}));d={analysisLayer:g,featureLayers:b};m&&(d.analysisType=m);a&&a.showSelectedCategory&&(d.showSelectedCategory=a.showSelectedCategory);arcgisonline.map.leftPanel.openLeftAnalysisPanel(d)})},
_handleAnalysisJobExceute:function(a){var d=c.fromJson(a.OutputName).serviceProperties.name,b={id:d,title:d,name:d,toolName:a.tool.toolName,jobParams:a.tool.jobParams,pos:arcgisonline.map.main.mapLayers.length+1,isCancel:!1},e=arcgisonline.map.dijit.toc.analysis.buildAnalysisJobNode(b);arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[d]=b;arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[d].tool=a.tool;c.place(e,c.byId("toc-main"),"first")},_handleAnalysisJobSubmit:function(a){a=c.fromJson(a.OutputName).serviceProperties.name;
c.byId(a+"_cancelDiv")&&c.style(c.byId(a+"_cancelDiv"),"visibility","visible")},_handleAnalysisJobStatus:function(a){var d=c.fromJson(a.jobParams.OutputName).serviceProperties.name;arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[d]&&(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[d].jobInfo=a,c.byId(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[d].id)?c.style(c.byId(d+"_cancelDiv"))&&"hidden"===c.style(c.byId(d+"_cancelDiv"),"visibility")&&c.style(c.byId(d+"_cancelDiv"),"visibility","visible"):
arcgisonline.map.dijit.toc.analysis.buildAnalysisJobNode(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[d]));if("esriJobFailed"===a.jobStatus){var b="";a.message&&(b=a.message);arcgisonline.map.dijit.toc.analysis.showInfoDialog({title:esri.i18nBundle.common.errorTitle,message:b});arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[d]&&(c.destroy(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[d].id),arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[d]=null,delete arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[d])}"warning"===
a.type&&a.message&&arcgisonline.map.dijit.toc.analysis.updateToolWarningMessages(a.message)},_handleAnalysisJobResult:function(a){var d=a.value;a=a.outputLayerName;arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a]&&(c.destroy(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a].id),arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a]=null,delete arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a]);var b=c.connect(arcgisonline.map.main.map,"onLayerAdd",c.hitch(this,function(a){var d=arcgisonline.map.dijit.toc.analysis.getToolWarningMessages();
c.disconnect(b);esri.isDefined(d)&&0<d.length&&arcgisonline.map.dijit.toc.analysis.showInfoDialog({title:arcgisonline.map.dijit.toc.analysis.i18n.warning,message:d});(a=arcgisonline.map.main.getParameterList(a))&&arcgisonline.map.thumbnail.recreateItemThumbnail(a)}));arcgisonline.map.save_open.openServiceItemCards(d.itemId)},_handleAnalysisJobFailed:function(a){a&&a.jobParams&&(a=c.fromJson(a.jobParams.OutputName).serviceProperties.name,arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a]&&(c.destroy(arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a].id),
arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a]=null,delete arcgisonline.map.dijit.toc.analysis._outFeatLyrArr[a]))},_setAnalysisHandlers:function(){arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers||(arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers=[],arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers.push(c.topic.subscribe("Analysis/ShowAnalysis",c.hitch(arcgisonline.map.dijit.toc.analysis,"configureAnalysis"))),arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers.push(c.topic.subscribe("Analysis/OnExecute",
c.hitch(arcgisonline.map.dijit.toc.analysis,"_handleAnalysisJobExceute"))),arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers.push(c.topic.subscribe("Analysis/OnJobSubmit",c.hitch(arcgisonline.map.dijit.toc.analysis,"_handleAnalysisJobSubmit"))),arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers.push(c.topic.subscribe("Analysis/OnJobStatus",c.hitch(arcgisonline.map.dijit.toc.analysis,"_handleAnalysisJobStatus"))),arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers.push(c.topic.subscribe("Analysis/OnJobResult",
c.hitch(arcgisonline.map.dijit.toc.analysis,"_handleAnalysisJobResult"))),arcgisonline.map.dijit.toc.analysis._gpSubscribeHandlers.push(c.topic.subscribe("Analysis/OnJobFailed",c.hitch(arcgisonline.map.dijit.toc.analysis,"_handleAnalysisJobFailed"))))},getLabelFromPopup:function(a,c){if(a&&a.fieldInfos&&0<a.fieldInfos.length)for(var b=0;b<a.fieldInfos.length;b++){var e=a.fieldInfos[b];if(e.fieldName==c)return e.label}return null},getOutFeatLyrArr:function(){return arcgisonline.map.dijit.toc.analysis._outFeatLyrArr},
isHostedFeatureLayer:function(a){var c=arcgisonline.map.featColl.isFeatureCollection(a),b="mapNotes"===a.type,e="base"===a.type||"labels"===a.type,f=a.layer instanceof esri.layers.GeoRSSLayer,g=a.layer instanceof esri.layers.CSVLayer;return(a.layer instanceof esri.layers.FeatureLayer&&!(a.layer instanceof esri.layers.StreamLayer)||c||f||g||b)&&!e},isMS:function(a){var c=a.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer,b=a.layer instanceof esri.layers.ArcGISTiledMapServiceLayer,e=arcgisonline.map.main.hasDynamicLayers(a),
f="base"===a.type||"labels"===a.type;a=e&&a.thematicGroup;return(b||c)&&!a&&!f},checkLayers:function(){var a,d;if(arcgisonline.map.dijit.toc.analysis.proxyCheckPromise)return arcgisonline.map.dijit.toc.analysis.proxyCheckPromise;d=new c.Deferred;arcgisonline.map.dijit.toc.analysis.proxyCheckPromise=d.promise;a=[];if(0<arcgisonline.map.main.mapLayers.length)for(var b=0;b<arcgisonline.map.main.mapLayers.length;b++){var e=arcgisonline.map.main.mapLayers[b];if("user"===e.type&&e.url&&!arcgisonline.map.featColl.isFeatureCollection(e)&&
!arcgisonline.sharing.util.isHostedService(e.url)&&!this.isPortalHostedService(e)&&!(e.layer instanceof esri.layers.CSVLayer)&&(e.layer instanceof esri.layers.FeatureLayer||arcgisonline.map.dijit.toc.analysis.isMS(e))&&!e.analysisProxyCheck&&!e._checkingProxy)a.push(this._getProxyServiceInfo(b)),e._checkingProxy=!0}0===a.length?(d.resolve({success:!0}),arcgisonline.map.dijit.toc.analysis.proxyCheckPromise=null):c.promise.all(a).then(c.hitch(this,function(a){d.resolve(a);arcgisonline.map.dijit.toc.analysis.proxyCheckPromise=
null}),c.hitch(this,function(a){d.resolve(a);arcgisonline.map.dijit.toc.analysis.proxyCheckPromise=null}));return d.promise},_getProxyServiceInfo:function(a){var d=new c.Deferred,b=arcgisonline.map.main.mapLayers[a],e,f,g;(!esri.isDefined(b)||!esri.isDefined(b.layer)||!esri.isDefined(b.layer.url))&&d.reject({error:"mapLayer is not defined"});a=b.layer.url+(-1<b.layer.url.indexOf("?")?"\x26":"?")+"f\x3djson";b.layer._findCredential();e=b.layer._getToken();f=b.layer.url;arcgisonline.map.dijit.toc.analysis.proxyCheckedServers||
(arcgisonline.map.dijit.toc.analysis.proxyCheckedServers=[]);c.some(arcgisonline.map.dijit.toc.analysis.proxyCheckedServers,function(a){g=f.substring(0,f.indexOf("/",9));if(a.server===g)return b.analysisProxyCheck=a.check,!0},this)?d.resolve({}):(e&&(a+="\x26token\x3d"+e),d=esri.request({url:a,content:null},{useProxy:!0}),d.then(c.hitch(this,function(){b.analysisProxyCheck="success";arcgisonline.map.dijit.toc.analysis.proxyCheckedServers.push({server:f.substring(0,f.indexOf("/",9)),check:"success"})}),
c.hitch(this,function(){b.analysisProxyCheck="failure";arcgisonline.map.dijit.toc.analysis.proxyCheckedServers.push({server:f.substring(0,f.indexOf("/",9)),check:"failure"})})));return d.promise},canPerformAnalysis:function(){var a=!1;esri.isDefined(this.role.userActions)?a=!0===this.role.isAllowed("toc_menu_analysis"):!arcgisonline.map.dijit.toc.analysis.role.isAnonymous()&&esri.isDefined(esriGeowConfig.userRole)&&(a=esriGeowConfig.userRole.canPublishFeatures()&&esriGeowConfig.userRole.canUseSpatialAnalysis());
this.util.isPortal()&&(a=a&&esri.isDefined(esriGeowConfig.self.helperServices.analysis)&&esri.isDefined(esriGeowConfig.self.helperServices.analysis.url));return a},_canAnalyzeMS:function(a){return c.some(a,function(a){return!0===a._canAnalyze})},canPerformNetworkAnalysis:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.asyncClosestFacility)&&esri.isDefined(esriGeowConfig.self.helperServices.asyncServiceArea)&&esri.isDefined(esriGeowConfig.self.helperServices.asyncVRP);return this.canPerformAnalysis()&&
arcgisonline.map.role.isAllowed("analysis_routing")&&a},canPerformPlanRoutesAnalysis:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.routingUtilities)&&esri.isDefined(esriGeowConfig.self.helperServices.asyncVRP);return this.canPerformAnalysis()&&arcgisonline.map.role.isAllowed("analysis_routing")&&a},canPerformODAnalysis:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.routingUtilities)&&esri.isDefined(esriGeowConfig.self.helperServices.asyncRoute);return this.canPerformAnalysis()&&
arcgisonline.map.role.isAllowed("analysis_routing")&&a},canPerformDriveAnalysis:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.routingUtilities)&&esri.isDefined(esriGeowConfig.self.helperServices.asyncServiceArea);return this.canPerformAnalysis()&&arcgisonline.map.role.isAllowed("analysis_routing")&&a},canPerformNearestAnalysis:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.routingUtilities)&&esri.isDefined(esriGeowConfig.self.helperServices.asyncClosestFacility);
return this.canPerformAnalysis()&&arcgisonline.map.role.isAllowed("analysis_routing")&&a},canPerformGeoEnrichment:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.geoenrichment);return this.canPerformAnalysis()&&arcgisonline.map.role.isAllowed("analysis_geoenrichment")&&a},canPerformElevationAnalysis:function(){var a=esri.isDefined(esriGeowConfig.self.helperServices.elevation);return this.canPerformAnalysis()&&arcgisonline.map.role.isAllowed("analysis_elevation")&&a},canPerformHydroAnalysis:function(){var a=
esri.isDefined(esriGeowConfig.self.helperServices.hydrology);return this.canPerformAnalysis()&&arcgisonline.map.role.isAllowed("analysis_elevation")&&a},checkOnAnalysisButton:function(){var a=this.canPerformAnalysis(),d=[],b,e=arcgisonline.map.main.mapLayers.slice(0),f=[];a?this.checkLayers().always(c.hitch(this,function(){var a=c.some(e,function(a){var b=!1;this.isMS(a)?esri.isDefined(a._canAnalyze)?b=!0===a._canAnalyze:f.push(a):b=this.isAnalysisLayer(a);return b},this);a?this.enableAnalysisButton():
0<f.length&&!this._canAnalyzeMS()?(c.forEach(f,function(a,b){arcgisonline.map.dijit.toc.analysis.isAnalysisLayer(a)&&d.push(arcgisonline.map.dijit.toc.analysis._getLayers(a))}),b=new c.promise.all(d),b.then(c.hitch(this,function(b){b&&0<b.length&&(a=c.some(b,function(a){return a.flayers&&0<a.flayers.length}),c.forEach(b,function(a){a._canAnalyze=esri.isDefined(a.flayers)&&0<a.flayers.length}),this.enableAnalysisButton())}))):this.util.isPortal()||this.enableAnalysisButton()})):this.disableAnalysisButton()},
enableAnalysisButton:function(){if((!isEmbedded||!isEmbedded.hideAnalysis)&&h.byId("webmap-analysis")&&"none"===c.style(h.byId("webmap-analysis").domNode,"display"))h.byId("webmap-analysis").set("disabled",!1),10>=c.isIE?c.style(h.byId("webmap-analysis").domNode,"display","inline-block"):c.style(h.byId("webmap-analysis").domNode,"display",""),arcgisonline.map.main.checkMinWidthOfPage()},disableAnalysisButton:function(){h.byId("webmap-analysis")&&"none"!==c.style(h.byId("webmap-analysis").domNode,
"display")&&(c.style(h.byId("webmap-analysis").domNode,"display","none"),arcgisonline.map.main.checkMinWidthOfPage())},showInfoDialog:function(a){esri.isDefined(a)&&arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:a.title||this.i18n.errorTitle,message:a.message||""})},clear:function(){arcgisonline.map.dijit.toc.analysis.mapLayer=null;arcgisonline.map.dijit.toc.analysis.menuSubLayerPos=null;arcgisonline.map.dijit.toc.analysis._isKmlNetworkLinkFolder=null;arcgisonline.map.dijit.toc.analysis._kmlFcollbycurfolder=
null;arcgisonline.map.dijit.toc.analysis._kmlAnalysisLayer=null}}});