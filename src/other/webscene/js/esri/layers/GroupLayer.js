// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../core/declare dojo/Deferred ../geometry/SpatialReference ../geometry/Extent ../geometry/support/webMercatorUtils ./Layer ../LayersMixin ../core/JSONSupport".split(" "),function(g,h,k,e,f,l,m,n){return g([l,m,n],{declaredClass:"esri.layers.GroupLayer",constructor:function(a){this._lyrPromises={};this._lyrResolveHandler=this._lyrResolveHandler.bind(this);this._lyrVisibleHandles={};this._lyrVisibleWatcher=this._lyrVisibleWatcher.bind(this);this._lyrFullExtentHandles={};this._lyrFullExtentWatcher=
this._lyrFullExtentWatcher.bind(this);this._promise=new h;this.addResolvingPromise(this._promise.promise)},initialize:function(){this._enforceVisibility(this.visibilityMode,this.visible);this.watch("visible",this._visibleWatcher)},viewModulePaths:{"2d":"../views/layers/GroupLayerView","3d":"../views/layers/GroupLayerView"},visibilityMode:"independent",_visibilityModeSetter:function(a,b){if(b===a)return b;this._enforceVisibility(a,this.visible);return a},_spatialReferenceReader:function(a){return a&&
new k(a)},_initialExtentReader:function(a){return a&&e.fromJSON(a)},_fullExtentReader:function(a){return a&&e.fromJSON(a)},layerAdded:function(a,b){this.isFulfilled()||(this._lyrPromises[a.id]=a.then(this._lyrResolveHandler));a.visible&&"exclusive"===this.visibilityMode?this._turnOffOtherLayers(a):"inherited"===this.visibilityMode&&(a.visible=this.visible);this._lyrFullExtentHandles[a.id]=a.watch("fullExtent",this._lyrFullExtentWatcher);this._lyrVisibleHandles[a.id]=a.watch("visible",this._lyrVisibleWatcher);
this._computeFullExtent()},layerRemoved:function(a,b){var c=this._lyrPromises[a.id];c&&(c.cancel(),delete this._lyrPromises[a.id]);if(c=this._lyrFullExtentHandles[a.id])c.remove(),delete this._lyrFullExtentHandles[a.id];if(c=this._lyrVisibleHandles[a.id])c.remove(),delete this._lyrVisibleHandles[a.id];this._enforceVisibility(this.visibilityMode,this.visible);this._computeFullExtent()},_turnOffOtherLayers:function(a){this.layers.forEach(function(b){b!==a&&(b.visible=!1)})},_enforceVisibility:function(a,
b){if(this._accessorProps.initialized){var c=this.layers,d=c.find(function(a){return a.visible});switch(a){case "exclusive":c.length&&!d&&(d=c.getItemAt(0),d.visible=!0);this._turnOffOtherLayers(d);break;case "inherited":c.forEach(function(a){a.visible=b},this)}}},_computeFullExtent:function(){var a=this.spatialReference;a&&this.layers.length&&(this.fullExtent=this.layers.map(function(b){if(!b.loaded)return null;b=b.fullExtent||b.initialExtent;!a.equals(b.spatialReference)&&f.canProject(b,a)&&(b=
f.project(b,a));return a.equals(b.spatialReference)?b:null}).reduce(function(a,c){return!a?c:!c?a:a.union(c)}))},_visibleWatcher:function(a){"inherited"===this.visibilityMode&&this.layers.forEach(function(b){b.visible=a})},_lyrResolveHandler:function(a){var b=this.layers.indexOf(a);delete this._lyrPromises[a.id];!this.isFulfilled()&&0===b&&(this.read({fullExtent:a.fullExtent&&a.fullExtent.toJSON(),initialExtent:a.initialExtent&&a.initialExtent.toJSON(),spatialReference:a.spatialReference&&a.spatialReference.toJSON()}),
this._promise.resolve())},_lyrVisibleWatcher:function(a,b,c,d){b=this.layers.some(function(a){return a.visible});switch(this.visibilityMode){case "exclusive":a?this._turnOffOtherLayers(d):b||(d.visible=!0);break;case "inherited":d.visible=this.visible}},_lyrFullExtentWatcher:function(){this._computeFullExtent()}})});