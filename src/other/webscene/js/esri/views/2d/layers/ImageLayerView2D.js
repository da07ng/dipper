// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define(["esri/core/declare","esri/core/watchUtils","esri/core/HandleRegistry","./LayerView2D","../engine/Bitmap"],function(d,e,f,g,h){return d(g,{declaredClass:"esri.views.2d.layers.ImageLayerView2D",constructor:function(){this._canvas=this._context=null;this._hdls=new f;this._hdls.add([e.watch(this,"view.state.version,view.stationary,suspended",this.redraw.bind(this))])},initialize:function(){this._createCanvas()},destroy:function(){this.clear();this.container.removeAll();this._canvas&&(this._canvas=
this._context=null);this._hdls.remove();this._hdls.destroy()},redraw:function(){if(this.view.stationary&&!this.suspended){var a=this.view.state,b=a.extent;this._imagePromise&&(this._imagePromise.cancel(),this._imagePromise=null);this._imagePromise=this.layer.fetchImage({extent:a.extent,width:a.width,height:a.height}).then(function(){var c=this.layer.pixelData;this._imagePromise=null;this.view.stationary&&!this.suspended&&(this._drawPixelData(c),c=new h({coords:[b.center.x,b.center.y],resolution:b.width/
a.width,size:[0.5*a.width,0.5*a.height],source:this._canvas,rotation:0}),this.container.removeAll(),this.container.addChild(c))}.bind(this),function(){this._imagePromise=null}.bind(this))}},clear:function(){var a=this.get("view.state");this._context&&"2d"===this.layer.drawType&&this._context.clearRect(0,0,a.width,a.height)},_drawPixelData:function(a){this.get("view.state");var b=this._context;if(!b||!a||!a.pixelBlock)this.clear();else{this._canvas.setAttribute("style","left: 0px; top: 0px; width: state.width + 'px'; state.height + 'px';");
this._canvas.style["transform-origin"]="left top";a=a.pixelBlock;var c=b.createImageData(a.width,a.height);c.data.set(a.getAsRGBA());b.putImageData(c,0,0)}},_createCanvas:function(){var a=this.get("view.state"),b=this._canvas=document.createElement("canvas");b.setAttribute("id","rasterCanvas2d");b.setAttribute("width",a.width+"px");b.setAttribute("height",a.height+"px");b.setAttribute("style","position: absolute; left: 0px; top: 0px;");this._context=b.getContext(this.layer.drawType);if(!this._context)throw Error("Unable to create the context. This browser might not support \x3ccanvas\x3e elements.");
}})});