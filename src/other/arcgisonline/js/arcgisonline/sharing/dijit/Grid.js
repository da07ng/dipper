// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/Grid","dojo/_base/declare dojo/_base/lang dojo/string dojo/_base/array dojo/date/locale dojo/on dojo/dom esri/lang dojo/aspect dijit/_WidgetBase dojo/_base/window dijit/TooltipDialog dijit/popup dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin dijit/form/DropDownButton dijit/DropDownMenu dijit/MenuItem dgrid/Grid dgrid/extensions/Pagination dgrid/extensions/DijitRegistry dgrid/OnDemandGrid dgrid/extensions/ColumnResizer dgrid/Keyboard ./_RefreshMixin ./Rating dojo/query dojo/dom-class dojo/dom-style dojo/dom-geometry dojo/dom-construct dojo/when dojo/store/Memory dgrid/Selection dgrid/selector dojo/store/Observable put-selector/put dgrid/util/mouse dgrid/util/touch arcgisonline/sharing/util arcgisonline/sharing/geow/Content dojo/i18n!arcgisonline/nls/arcgisonline".split(" "),
function(k,c,n,p,z,N,O,P,A,l,Q,B,t,q,r,u,C,D,v,E,F,R,G,S,H,T,d,g,I,U,V,J,s,K,W,w,m,x,y,L,M,f){esri.i18nBundle=f;return k("arcgisonline.sharing.dijit.Grid",[l],{postMixInProperties:function(){this.inherited(arguments);this._util=L;this._content=M;this._supportedViews=["gallery","details","table"];this._favorites={};this._portalUser=this._util.getUser();this._galleryTemplate=this._galleryTemplate||"\x3cdiv style\x3d'opacity:0;' class\x3d'grid-item gallery-view'\x3e${item:_formatThumbnail}\x3ch5\x3e${item:_formatItemTitle}\x3c/h5\x3e${item:_formatItemTypeIcon}\x3c/div\x3e";
this._detailsTemplate=this._detailsTemplate||'\x3cdiv style\x3d\'opacity:0;\' class\x3d\'grid-item detail-view\'\x3e${item:_formatThumbnail}\x3ch5\x3e${item:_formatItemTitle}\x3c/h5\x3e\x3cdiv class\x3d"rating-system"\x3e\x3cdiv data-dojo-type\x3d\'arcgisonline/sharing/dijit/Rating\' data-dojo-props\x3d\'numStars:5,value:${item.avgRating},disabled:true\'\x3e\x3c/div\x3e\x26nbsp;\x3cspan\x3e(${item.numRatings})\x3c/span\x3e\x3c/div\x3e${item:_formatItemTypeIcon}\x3cp class\x3d"grid-item-type"\x3e${item:_formatType}\x3c/p\x3e\x3cp class\x3d"grid-item-desc"\x3e${item.snippet}\x3c/p\x3e${item:_formatPremiumContentIcon}\x3cspan class\x3d"openItem" id\x3d"openItem"\x3e\x3c/span\x3e\x3ca href\x3d"item.html?id\x3d${item.id}" class\x3d"calcite btn small primary details-button"\x3e${i18n.gallery.details}\x3c/a\x3e\x3c/div\x3e';
this._itemPopupTemplate=this._itemPopupTemplate||'\x3cdiv class\x3d"grid-item-hover"\x3e\x3ch5\x3e${item:_formatItemTitle}\x3c/h5\x3e\x3cspan id\x3d\'openItem\'\x3e\x3c/span\x3e\x3ca href\x3d"item.html?id\x3d${item.id}" class\x3d"calcite btn small primary details-button"\x3e${i18n.details}\x3c/a\x3e\x3cp class\x3d"item-hover-type"\x3e${item:_formatItemTypeIcon}${item:_formatType} by\x26nbsp;${item.owner:_formatOwnerLink}\x3c/p\x3e\x3cp class\x3d"item-hover-desc"\x3e${item.snippet}\x3c/p\x3e${item:_formatPremiumContentIcon}\x3cdiv class\x3d"rating-system"\x3e\x3cdiv data-dojo-type\x3d\'arcgisonline/sharing/dijit/Rating\' data-dojo-props\x3d\'numStars:5,value:${item.avgRating},disabled:true\'\x3e\x3c/div\x3e\x26nbsp;\x3cspan\x3e(${item.numRatings})\x3c/span\x3e\x3c/div\x3e\x3c/div\x3e';
this._renderers=c.mixin(this._renderers||{},{gallery:c.hitch(this,function(a){a.snippet=a.snippet||"";var b=m("div"),e=new (k([l,q,r],{templateString:n.substitute(this._galleryTemplate,{item:a,i18n:f.gallery},null,this)}));a.widget=e;b.appendChild(e.domNode);return b}),details:c.hitch(this,function(a){a.snippet=a.snippet||"";var b=m("div"),e=new (k([l,q,r],{templateString:n.substitute(this._detailsTemplate,{item:a,i18n:f},null,this)})),c=new u({label:f.gallery.open,className:"btn calcite primary",
dropDown:this._getOpenInMenu(a)},d(".openItem",b)[0]);a.widget=e;b.appendChild(e.domNode);d(".openItem",b).replaceWith(c.domNode);0===c.dropDown.getChildren().length&&c.set("disabled",!0);return b}),table:function(){return m("div",v.prototype.renderRow.apply(this,arguments))}})},buildRendering:function(){this.inherited(arguments);var a=k([v,F,E,G,K,H]),b=this.columns||{title:{label:"title"},type:{label:"type"},modified:{label:"last modified"},access:{label:"sharing"}};this._view=this.view||"table";
this._query=this.query;this._sort=this.sort||[{attribute:"title",descending:!1}];this._queryOptions=this.queryOptions||{sort:this.sort};this._store=this.store||new s({data:[]});this._rowsPerPage=this.rowsPerPage||9;this._pagingLinks=!this.pagingLinks?3:this.pagingLinks;this._showHeader=this.showHeader||!1;this._selectionMode=this.selectionMode||"extended";this._useTouchScroll=this.useTouchScroll||!1;this._grid=new a({columns:b,renderRow:this._renderers[this._view],noDataMessage:this.noDataMessage||
"",showHeader:this._showHeader,store:this._store,query:this._query,showLoadingMessage:!1,firstLastArrows:this._pagingLinks,previousNextArrows:this._pagingLinks,rowsPerPage:this._rowsPerPage,pagingLinks:this._pagingLinks,allowSelectAll:!0,selectionMode:this._selectionMode,sort:this._sort},this.domNode);this._grid.startup()},postCreate:function(){this.inherited(arguments);this.own(this._grid.on("refresh",c.hitch(this,function(){this._grid.showFooter=this._grid._total>this._grid.rowsPerPage;this._onGridRefresh()})),
A.before(this._grid,"removeRow",c.hitch(this,function(a){a&&(a=this._grid.row(a),(a=(a.data||a).widget)&&a.destroyRecursive())})),this._grid.on(".fav-icon a:click",c.hitch(this,function(a){a.preventDefault();var b=this._grid.row(a),e=a.target.parentNode.parentNode.parentNode,h=g.contains(a.target.parentNode,"fav-off");a=this._content[h?"addToFavorites":"removeFromFavorites"](b.data).then(c.hitch(this,function(){this._favorites[b.data.id].id=h?b.data.id:!1}));d(".fav-on",e).style({display:h?"":"none"});
d(".fav-off",e).style({display:h?"none":""});setTimeout(c.hitch(this,function(){d(".fav-on",e).style({width:h?"200px":"24px"});d(".fav-off",e).style({width:h?"24px":"200px"});setTimeout(c.hitch(this,function(){d(".fav-on, .fav-off").style({width:"24px"})}),2500)}),50);a.then(c.hitch(this,function(){}))})),this._grid.on(".fav-icon a:mouseout",c.hitch(this,function(a){I.set(a.target.parentNode,{width:"24px"})})));esri.isTouchEnabled&&("gallery"===this._view||"details"===this._view)?this.own(this._grid.on(y.selector(".dgrid-content .dgrid-row",
y.tap),c.hitch(this,function(a){a.preventDefault();var b=this._grid.row(a);this._portalUser?this._isFavorite(b.data.id).then(c.hitch(this,function(a){this._showPopup(b.data,d("img",b.element)[0].parentNode)})):this._showPopup(b.data,d("img",b.element)[0])})),this._grid.on(".dgrid-row:click",c.hitch(this,function(a){a.preventDefault();var b=this._grid.row(a);this._portalUser?this._isFavorite(b.data.id).then(c.hitch(this,function(a){this._showPopup(b.data,d("img",b.element)[0].parentNode)})):this._showPopup(b.data,
d("img",b.element)[0])}))):("gallery"===this._view||"details"===this._view)&&this.own(this._grid.on(x.enterRow,c.hitch(this,function(a){if(a.relatedTarget&&!1===g.contains(a.relatedTarget,"dijitMenu")&&!1===g.contains(a.relatedTarget,"dijitReset")){var b=this._grid.row(a),e=d("img",b.element)[0];clearTimeout(this._showPopupTimeout);e&&(this._showPopupTimeout=setTimeout(c.hitch(this,function(){this._portalUser?this._isFavorite(b.data.id).then(c.hitch(this,function(a){this._showPopup(b.data,e.parentNode)})):
this._showPopup(b.data,e)}),400))}})),this._grid.on(x.leaveRow,c.hitch(this,function(a){a.relatedTarget&&(!1===g.contains(a.relatedTarget,"dijitTooltipDialog")&&!1===g.contains(a.relatedTarget,"dijitTooltipConnector"))&&(clearTimeout(this._showPopupTimeout),clearTimeout(this._closePopupTimeout),this._closePopupTimeout=setTimeout(c.hitch(this,function(){d(".fav-on, .fav-off",this.domNode).style("display","none").style("width","24px");this._closePopup()}),10))})))},_onGridRefresh:function(a){this.emit("onRefresh",
{currentPage:this._grid._currentPage});this._pagingLinks&&(d(".dgrid-navigation",this._grid.domNode)[this._grid._total<=this._grid.rowsPerPage?"addClass":"removeClass"]("hide"),d(".dgrid-pagination",this._grid.domNode)[0===this._grid._total?"addClass":"removeClass"]("hide"))},_getGridAttr:function(){return this._grid},_showPopup:function(a,b){"details"===this._view?this._portalUser&&this._isFavorite(a.id).then(c.hitch(this,function(a){d(".fav-on",b.parentNode).style("display",a.id?"":"none");d(".fav-off",
b.parentNode).style("display",a.id?"none":"")})):"gallery"===this._view&&(a.id&&a.id!==this._popupId)&&(this._portalUser&&this._isFavorite(a.id).then(c.hitch(this,function(a){d(".fav-on",b.parentNode).style("display",a.id?"":"none");d(".fav-off",b.parentNode).style("display",a.id?"none":"")})),this._closePopup(),this._popupId=a.id,this._tooltip=new B({onMouseLeave:c.hitch(this,"_closePopup"),content:new (k([l,q,r],{templateString:n.substitute(this._itemPopupTemplate,{item:a,i18n:f.gallery},null,this)}))}),
t.open({popup:this._tooltip,around:b,orient:["after-centered","before-centered"]}),this._popupButton=new u({label:f.gallery.open,className:"calcite btn small primary",dropDown:this._getOpenInMenu(a)}),d("#openItem").replaceWith(this._popupButton.domNode),0===this._popupButton.dropDown.getChildren().length&&this._popupButton.set("disabled",!0))},_closePopup:function(a){if((!a||!a.relatedTarget||!(!0===g.contains(a.relatedTarget,"dijitBackgroundIframe")||!0===g.contains(a.relatedTarget,"dijitMenu")||
!0===g.contains(a.relatedTarget,"dijitReset")))&&this._tooltip)t.close(this._tooltip),this._popupConnect&&this._popupConnect.remove(),this._popupButton&&this._popupButton.destroyRecursive(),this._tooltip.destroyRecursive(),this._popupId=this._tooltip=null},_isFavorite:function(a){return J(this._favorites[a]||this._searchItems('(group:"'+this._portalUser.favGroupId+'" AND id:"'+a+'")').then(c.hitch(this,function(b){this._favorites[a]=b.results[0]||{id:!1};return this._favorites[a]})))},_searchItems:function(a){return this._util.request({url:esriGeowConfig.restBaseUrl+
"search",content:{q:a,f:"json"}})},refresh:function(){this._grid&&this._grid.set("query",this._query,this._queryOptions)},gotoPage:function(a){this._grid.query=this._query;this._grid.queryOptions=this._queryOptions;this._grid._sort=this._queryOptions.sort;this._grid.gotoPage(a)},_formatItemTitle:function(a){return a.title||a.name||""},_formatType:function(a){return this._content.changeTypename({type:a.type,typeKeywords:a.typeKeywords},!1)||a.type},_formatLargeThumbnail:function(a){return a?"\x3cimg class\x3d'grid-item-thumb' alt\x3d'' src\x3d'"+
a+"'\x3e":"\x3cimg class\x3d'grid-item-thumb' alt\x3d'' src\x3d'"+this._util.getStaticImagesUrl()+"/desktopapp.png'\x3e"},_getDefaultThumbnail:function(a){var b=this._util.getStaticImagesUrl();return"web mapping application"==a?b+"/webapp.png":"mobile application"==a?b+"/mobileapp.png":"workforce project"===a?b+"/workforceproject.png":"web scene"===a||"scene service"===a?b+"/scene.png":b+"/desktopapp.png"},_formatThumbnail:function(a){var b=a.thumbnailUrl||this._getDefaultThumbnail(a.type&&a.type.toLowerCase()),
c=this._util.getHomePageGalleryLinkInfo(a),d=-1<dojo.indexOf(a.typeKeywords,"Web AppBuilder for ArcGIS"),d=esriGeowConfig.self&&esriGeowConfig.self.isPortal&&d||"Application"===a.type||"Web Mapping Application"===a.type&&!d||"Mobile Application"===a.type||"Document Link"===a.type,g="Application"===a.type||"Web Mapping Application"===a.type||"Mobile Application"===a.type||"Document Link"===a.type||"CityEngine Web Scene"===a.type;a='\x3ca href\x3d"'+(esri.isTouchEnabled?"#":d?a.url||"item.html?id\x3d"+
a.id:c&&c.href&&c.href.replace(/"/g,"'")||"item.html?id\x3d"+a.id)+'" target\x3d"'+(g?"_blank":"")+'"\x3e\x3cimg class\x3d"grid-item-thumb" alt\x3d"" src\x3d"'+b+'" /\x3e\x3c/a\x3e';b=esriGeowConfig.userRole&&esriGeowConfig.userRole.isCustom();b=!b||b&&esriGeowConfig.userRole.canShareItemToGroup();c='\x3cdiv class\x3d"gallery-img"\x3e\x3cdiv class\x3d"fav-icon"\x3e\x3ca href\x3d"#"\x3e\x3cdiv class\x3d"fav-on" style\x3d"display:none;"\x3e\x3cdiv class\x3d"star-on"\x3e\x3c/div\x3e\x3cp id\x3d"addString"\x3e'+
f.gallery.addFavorite+'\x3c/p\x3e\x3c/div\x3e\x3c/a\x3e\x3ca href\x3d"#"\x3e\x3cdiv class\x3d"fav-off" style\x3d"display:none;"\x3e\x3cdiv class\x3d"star-off"\x3e\x3c/div\x3e\x3cp id\x3d"remString"\x3e'+f.gallery.removeFavorite+"\x3c/p\x3e\x3c/div\x3e\x3c/a\x3e\x3c/div\x3e"+a+"\x3c/div\x3e";return b&&this._portalUser?c:a},_formatItemTypeIcon:function(a){return"\x3cimg class\x3d'grid-item-icon' alt\x3d'' src\x3d'"+this._content._getItemIconUrl(a)+"'\x3e"},_formatPremiumContentIcon:function(a){var b=
a.isPremiumContent,c=a.getTypeInfo();a=-1<p.indexOf(a.typeKeywords,"Requires Credits");return b?'\x3cp class\x3d"grid-item-type" title\x3d"'+(a?f.common.premiumcontentcreditstitle:f.common.premiumcontenttitle)+"\"\x3e\x3cimg class\x3d'grid-premium-icon' alt\x3d'' src\x3d'"+c.premiumIconUrl+"'\x3e"+f.common.premiumcontent+"\x3c/p\x3e":""},_formatDate:function(a){!1===a instanceof Date&&(a=new Date(a));return a?z.format(a,{selector:"date",datePattern:"MMMM yyy"}):""},_formatOwnerLink:function(a){return'\x3ca href\x3d"user.html?user\x3d'+
a+'"\x3e'+a+"\x3c/a\x3e"},_getOpenInMenu:function(a){a=this._util.getItemOpenLinkObjects(a);var b,c;b=new C({autoFocus:!0,_destroyOnRemove:!0,showTitle:!1});p.forEach(a,function(a){c=new D({label:a.label,onClick:function(){a.onClick()}});b.addChild(c)});b.startup();return b},_setViewAttr:function(a){this._view=a=-1===p.indexOf(this._supportedViews,a)?this._view:a;this._grid&&(this._grid.renderRow=this._renderers[a],m(this._grid.domNode,"!table!gallery!details."+a),this._grid.set("showHeader","table"===
this._view))},_setStoreAttr:function(a){this._store=a},_setQueryAttr:function(a,b){this._query=a||this._query;this._queryOptions=b||this._queryOptions},_setItemsAttr:function(a){(this._store=this._store||new w(new s({data:a,identifier:"id",label:"id"})))&&this._store.setData?this._store.setData(a):this._store=new w(new s({data:a}));this.set("store",this._store);this.set("view",this._view)}})});