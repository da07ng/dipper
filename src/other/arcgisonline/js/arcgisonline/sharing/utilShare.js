// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/utilShare",["dijit","dojo","dojox","dojo/require!arcgisonline/sharing/dijit/dialog/GeneralDlg,arcgisonline/sharing/dijit/dialog/ShareCheckDlg"],function(q,c,r){c.provide("arcgisonline.sharing.utilShare");c.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");c.require("arcgisonline.sharing.dijit.dialog.ShareCheckDlg");arcgisonline.sharing.utilShare={itemCards:[],ownerGroups:[],waitHandler:null,checkWebMapContent:function(a){var b=function(a){var b={};b.webMapId=a.webMapId;
b.mainItemCard=a.webMapItemCard;delete b.mainItemCard.needsUpdate;b.mainItemSharing=a.webMapItemSharing;b.mainConfig=a.webMapConfig;b.itemCards=a.itemCards||{};for(var f in b.itemCards)delete b.itemCards[f].needsUpdate;b.itemsSharing={};b.newAccess=a.newAccess;b.needUpdateHandler=a.needUpdateHandler;b.dontNeedUpdateHandler=a.dontNeedUpdateHandler;arcgisonline.sharing.utilShare.getMainItemCard(b)};a.useTimer?(arcgisonline.sharing.utilShare.waitHandler&&clearTimeout(arcgisonline.sharing.utilShare.waitHandler),
arcgisonline.sharing.utilShare.waitHandler=setTimeout(c.hitch(this,function(){arcgisonline.sharing.utilShare.waitHandler=null;b(a)}),2E3)):b(a)},checkWebAppContent:function(a){var b={};b.webAppId=a.webAppId;b.mainItemCard=a.webAppItemCard;b.mainItemSharing=a.webAppItemSharing;b.mainConfig=a.webAppConfig;b.itemCards=a.itemCards||{};b.itemsSharing={};arcgisonline.sharing.utilShare.getMainItemCard(b)},getMainItemCard:function(a){var b=function(a){a.newAccess?(a.mainItemSharing=a.newAccess,arcgisonline.sharing.utilShare.getMainConfig(a)):
"private"!==a.mainItemCard.access&&("shared"===a.mainItemCard.access?arcgisonline.sharing.utilShare.getMainSharingInfo(a):arcgisonline.sharing.utilShare.getMainConfig(a))};a.mainItemCard?b(a):arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+(a.webMapId||a.webAppId)).then(c.hitch(this,function(a,c){a.mainItemCard=c;b(a);return!0},a),c.hitch(this,function(a){console.log("can't get item card",a);return a}))},getMainSharingInfo:function(a){if(a.mainItemSharing)arcgisonline.sharing.utilShare.getMainConfig(a);
else{var b=arcgisonline.sharing.util.getUser(),b=esriGeowConfig.restBaseUrl+"content/users/"+b.email;a.mainItemCard.ownerFolder&&(b+="/"+a.mainItemCard.ownerFolder);var b=b+("/items/"+(a.webMapId||a.webAppId)),e=arcgisonline.sharing.util.getToken();esri.request({url:b+(e?"?f\x3djson\x26token\x3d"+e:"?f\x3djson"),callbackParamName:"callback",load:c.hitch(this,function(a,b){a.mainItemSharing=b.sharing;arcgisonline.sharing.utilShare.getMainConfig(a)},a),error:c.hitch(this,function(a,b){arcgisonline.sharing.utilShare.getMainConfig(a)},
a)},{disableIdentityLookup:!0})}},getMainConfig:function(a){if(a.mainConfig)a.webMapId?arcgisonline.sharing.utilShare.readWebMapConfig(a):arcgisonline.sharing.utilShare.readWebAppConfig(a);else return arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+(a.webMapId||a.webAppId)+"/data",c.hitch(this,function(a,c,d){a.mainConfig=c;a.webMapId?arcgisonline.sharing.utilShare.readWebMapConfig(a):arcgisonline.sharing.utilShare.readWebAppConfig(a)},a),c.hitch(this,function(a,c){console.log(a)}))},
checkForItemSharing:function(a){if(a.newAccess&&"shared"!==a.newAccess.access||!a.newAccess&&"shared"!==a.mainItemCard.access)arcgisonline.sharing.utilShare.checkAccessOfItems(a);else{var b=[],e;for(e in a.itemCards){var d=a.itemCards[e];("shared"===d.access||"org"===d.access)&&(d.ownerFolder||null===d.ownerFolder)&&b.push(arcgisonline.sharing.utilShare.getItemSharingInfo(d))}b.length?(new c.DeferredList(b)).addCallback(c.hitch(this,function(a,b){c.forEach(b,function(b){b=b[1];a.itemsSharing[b.item.id]=
b.sharing},this);arcgisonline.sharing.utilShare.checkAccessOfItems(a)},a)):arcgisonline.sharing.utilShare.checkAccessOfItems(a)}},checkAccessOfItems:function(a){var b=arcgisonline.sharing.util.getUser(),e=a.newAccess?a.newAccess.access:a.mainItemCard.access,d=[],f;for(f in a.itemCards){var g=a.itemCards[f];"shared"===e&&("public"!==g.access&&a.mainItemSharing&&void 0!==g.ownerFolder&&b.email!==g.owner)&&d.push(arcgisonline.sharing.utilShare.getOwnerGroups(g,a))}d.length?(new c.DeferredList(d)).addCallback(c.hitch(this,
function(a,b){arcgisonline.sharing.utilShare._checkAccessOfItems(a)},a)):arcgisonline.sharing.utilShare._checkAccessOfItems(a)},_checkAccessOfItems:function(a){var b=!1,e=a.newAccess?a.newAccess.access:a.mainItemCard.access,d=[],f;for(f in a.itemCards){var g=a.itemCards[f],h=g.access,k=!1;if("public"===e&&"public"!==h)k=!0;else if("org"===e&&"public"!==h&&"org"!==h)k=!0;else if("shared"===e&&"private"===h)k=!0;else if("shared"===e&&("shared"===h||"org"===h))if(a.mainItemSharing)if(a.itemsSharing[f]&&
void 0!==g.ownerFolder){for(var h=a.mainItemSharing.groups,p=a.itemsSharing[f].groups,m=!1,l=0;l<h.length;l++)if(-1===c.indexOf(p,h[l])){m=k=!0;break}m||delete a.itemCards[f]}else k=!0;else k=!0;else"Web Map"===!g.type&&"Web Scene"===!g.type?delete a.itemCards[f]:a.itemCards[f].needsUpdate=!1;(k&&a.webAppId||"Web Map"===g.type||"Web Scene"===g.type)&&d.push(arcgisonline.sharing.utilShare.checkWebMapInWebApp(g.id,a));b=b||k}var n=function(a,b){a?b.needUpdateHandler?b.needUpdateHandler(b):arcgisonline.sharing.dijit.dialog.ShareCheckDlg.prototype.statics.getInstance().show(b):
b.dontNeedUpdateHandler&&b.dontNeedUpdateHandler(b)};d.length?(new c.DeferredList(d)).addCallback(c.hitch(this,function(f){c.forEach(f,function(a){1<a.length&&esri.isDefined(a[1])&&(b=b||a[1])},this);n(b,a)})):esri.isEmpty(a.itemCards)?a.dontNeedUpdateHandler&&a.dontNeedUpdateHandler(a):n(b,a)},readWebMapConfig:function(a){for(var b=!1,e=[],d=a.mainConfig.operationalLayers.length-1;0<=d;d--){var f=a.mainConfig.operationalLayers[d];if(f.itemId)b=!0,a.itemCards[f.itemId]||e.push(arcgisonline.sharing.utilShare.getItemCard(f.itemId)),
"ArcGISTiledMapServiceLayer"===f.layerType&&(f.layers&&f.layers.length)&&c.forEach(f.layers,c.hitch(this,function(b){b.layerItemId&&!a.itemCards[b.layerItemId]&&e.push(arcgisonline.sharing.utilShare.getItemCard(b.layerItemId))}));else if("GroupLayer"===f.layerType)for(var g=a.mainConfig.operationalLayers[d],h=g.layers.length-1;0<=h;h--)f=g.layers[h],f.itemId&&(b=!0,a.itemCards[f.itemId]||e.push(arcgisonline.sharing.utilShare.getItemCard(f.itemId)));f.layers&&c.forEach(f.layers,function(b){b.layerItemId&&
!a.itemCards[b.layerItemId]&&e.push(arcgisonline.sharing.utilShare.getItemCard(b.layerItemId))})}for(d=a.mainConfig.baseMap.baseMapLayers.length-1;0<=d;d--)g=a.mainConfig.baseMap.baseMapLayers[d],g.itemId&&(b=!0,a.itemCards[g.itemId]||e.push(arcgisonline.sharing.utilShare.getItemCard(g.itemId)));e.length?(b=new c.DeferredList(e),b.addCallback(c.hitch(this,function(a,b){c.forEach(b,function(b){b=b[1];b.id&&(a.itemCards[b.id]=b)},this);var d=[],e=[];c.forEach(b,function(b){b=b[1];b.id&&("Map Service"==
b.type&&c.indexOf(b.typeKeywords,"Hosted Service"))&&!a.itemCards[f.itemId].data&&(d.push(arcgisonline.sharing.utilShare.getItemData(b.id)),e.push(b.id))},this);if(d.length){var g=new c.DeferredList(d);g.addCallback(c.hitch(this,function(a,b){c.forEach(b,function(b,f){var d=a.itemCards[e[f]];d.data=b[1];var g=[];d.data.layers&&c.forEach(d.data.layers,function(b){b.layerItemId&&(a.itemCards[b.layerItemId]||g.push(arcgisonline.sharing.utilShare.getItemCard(b.layerItemId)))});g.length?(d=new c.DeferredList(g),
d.addCallback(c.hitch(this,function(a,b){c.forEach(b,function(b){b=b[1];b.id&&(a.itemCards[b.id]=b)},this);arcgisonline.sharing.utilShare.checkForItemSharing(a)},a)),d.addErrback(c.hitch(this,function(a,b){arcgisonline.sharing.utilShare.checkForItemSharing(a)},a))):arcgisonline.sharing.utilShare.checkForItemSharing(a)},this)},a));g.addErrback(c.hitch(this,function(a,b){arcgisonline.sharing.utilShare.checkForItemSharing(a)},a))}else arcgisonline.sharing.utilShare.checkForItemSharing(a)},a)),b.addErrback(c.hitch(this,
function(a,b){arcgisonline.sharing.utilShare.checkForItemSharing(a)},a))):b?arcgisonline.sharing.utilShare.checkForItemSharing(a):a.dontNeedUpdateHandler&&a.dontNeedUpdateHandler(a)},readWebAppConfig:function(a){if(a.mainConfig.values&&a.mainConfig.values.webmap||a.mainConfig.map&&a.mainConfig.map.itemId){var b=a.mainConfig.values?a.mainConfig.values.webmap.split(","):[a.mainConfig.map.itemId],e=[];c.forEach(b,function(b){a.itemCards[b]||e.push(arcgisonline.sharing.utilShare.getItemCard(b))});e.length?
(new c.DeferredList(e)).addCallback(c.hitch(this,function(a,b){c.forEach(b,function(b){b=b[1];a.itemCards[b.id]=b},this);arcgisonline.sharing.utilShare.checkForItemSharing(a)},a)):hasItem&&arcgisonline.sharing.utilShare.checkForItemSharing(a)}},checkWebMapInWebApp:function(a,b){var e=new c.Deferred,d={access:b.mainItemCard.access};b.mainItemSharing&&b.mainItemSharing.groups&&(d.groups=b.mainItemSharing.groups);arcgisonline.sharing.utilShare.checkWebMapContent({webMapId:a,webMapItemCard:b.itemCards[a],
newAccess:d,needUpdateHandler:c.hitch(this,function(a,b,c,d){a.itemCards[b].webMapInfo=d;c.resolve(!0)},b,a,e),dontNeedUpdateHandler:c.hitch(this,function(a,b){a.resolve(!1)},e)});return e},getItemCard:function(a,b){b=b||new c.Deferred;if("inProgress"===arcgisonline.sharing.utilShare.itemCards[a])setTimeout(c.hitch(this,function(a,b){arcgisonline.sharing.utilShare.getItemCard(a,b)},a,b),1E3);else if(arcgisonline.sharing.utilShare.itemCards[a])delete arcgisonline.sharing.utilShare.itemCards[a].needsUpdate,
b.callback(arcgisonline.sharing.utilShare.itemCards[a]);else{arcgisonline.sharing.utilShare.itemCards[a]="inProgress";var e=esriGeowConfig.restBaseUrl+"content/items/"+a,d=arcgisonline.sharing.util.getToken();esri.request({url:e+(d?"?f\x3djson\x26token\x3d"+d:"?f\x3djson"),callbackParamName:"callback",load:c.hitch(this,function(c,d){arcgisonline.sharing.utilShare.itemCards[a]=c;b.callback(c)}),error:c.hitch(this,function(c,d){delete arcgisonline.sharing.utilShare.itemCards[a];b.errback(c)})},{disableIdentityLookup:!0})}return b},
getItemData:function(a,b){b=b||new c.Deferred;if(arcgisonline.sharing.utilShare.itemCards[a]&&"inProgress"===arcgisonline.sharing.utilShare.itemCards[a].data)setTimeout(c.hitch(this,function(a,b){arcgisonline.sharing.utilShare.getItemData(a,b)},a,b),1E3);else if(arcgisonline.sharing.utilShare.itemCards[a]&&arcgisonline.sharing.utilShare.itemCards[a].data)b.callback(arcgisonline.sharing.utilShare.itemCards[a].data);else{arcgisonline.sharing.utilShare.itemCards[a].data="inProgress";var e=esriGeowConfig.restBaseUrl+
"content/items/"+a+"/data",d=arcgisonline.sharing.util.getToken();esri.request({url:e+(d?"?f\x3djson\x26token\x3d"+d:"?f\x3djson"),callbackParamName:"callback",load:c.hitch(this,function(c,d){arcgisonline.sharing.utilShare.itemCards[a].data=c;b.callback(c)}),error:c.hitch(this,function(c,d){delete arcgisonline.sharing.utilShare.itemCards[a].data;b.errback(c)})},{disableIdentityLookup:!0})}return b},getItemSharingInfo:function(a){var b=esriGeowConfig.restBaseUrl+"content/users/"+a.owner;a.ownerFolder&&
(b+="/"+a.ownerFolder);b+="/items/"+a.id;a=arcgisonline.sharing.util.getToken();return esri.request({url:b+(a?"?f\x3djson\x26token\x3d"+a:"?f\x3djson"),callbackParamName:"callback"},{disableIdentityLookup:!0})},getOwnerGroups:function(a,b){var e=new c.Deferred;arcgisonline.sharing.utilShare.ownerGroups[a.owner]?e.callback():arcgisonline.sharing.geow.Community.getProfile(a.owner,function(b){b=c.map(b.groups,function(a){return a.id});arcgisonline.sharing.utilShare.ownerGroups[a.owner]=b;e.callback()},
function(){e.callback()});return e}}});