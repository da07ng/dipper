// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../../../core/declare ../../layers/LayerView ../../../geometry/Extent ../../../config ../../../core/urlUtils ../lib/glMatrix ../webgl-engine/Stage ../webgl-engine/lib/Texture ../webgl-engine/lib/RenderGeometry ../webgl-engine/lib/GeometryData ../webgl-engine/lib/GeometryUtil ../webgl-engine/materials/Material ../webgl-engine/lib/Util".split(" "),function(r,z,A,B,C,D,h,E,F,G,H,I,k){var n=k.assert,J=D.mat4d,l=k.VertexAttrConstants,K=function(a){a.remove()};r=r(z,{declaredClass:"esri.views.3d.layers.DynamicLayerView3D",
supportsDraping:!0,hasDraped:!0,drawingOrder:0,_updatingOverlay:!1,constructor:function(){this._extents=[];this._images=[]},initialize:function(){this.drawingOrder=this.view.getDrawingOrder(this.layer.get("id"));this.on("suspend",function(){this.clear();this.emit("draped-data-change")}.bind(this));this.on("resume",function(){for(var a=this._extents.length,c=0;c<a;c++)this.fetch(c)}.bind(this));var a=this.notifyChange.bind(this,"suspended");this._layerPropertyWatches=[this.layer.watch("opacity",this._opacityChangeHandler.bind(this)),
this.layer.watch("minScale",a),this.layer.watch("maxScale",a)];this.view.resourceController.registerIdleFrameWorker(this,{idleBegin:function(){this._hasScaleRange()&&this.notifyChange("suspended")}})},destroy:function(){this.clear();this._layerPropertyWatches.forEach(K);this._layerPropertyWatches.length=0;this.view.resourceController.deregisterIdleFrameWorker(this)},setDrapingExtent:function(a,b,c,e){this._extents[a]={extent:b,spatialReference:c,resolution:e};this.suspended||this.fetch(a)},fetch:function(a){var b=
this._extents[a],c=b.extent,e=b.resolution,b=new A(c[0],c[1],c[2],c[3],b.spatialReference);this.layer.getImageUrl({extent:b,width:e,height:e},function(b){this._images[a]||(this._images[a]={texture:null,material:null,rendergeometry:null,domImage:null,worldExtent:c,loading:!1});var f=this._images[a],e=f.domImage||new Image;0!==b.indexOf("data:")&&(C.canUseXhr(b)?e.crossOrigin="anonymous":b=B.request.proxyUrl+"?"+b);e.src=b;f.loading=!0;e.onload=function(){n(f.domImage===e);f.worldExtent=c;this._createStageObjects(a,
e);0===a&&(this._images[1]&&this._images[1].rendergeometry)&&this._createStageObjects(1,null);f.loading=!1;this._evaluateUpdatingState();this.emit("draped-data-change")}.bind(this);e.onerror=function(){f.loading=!1;this._clearDomImage(f);this._evaluateUpdatingState()}.bind(this);f.domImage=e;this._evaluateUpdatingState()}.bind(this))},clear:function(){for(var a in this._images)this.clearImage(a)},clearImage:function(a){if(a=this._images[a])a.htmlImage&&(a.htmlImage.removeAttribute("src"),a.htmlImage.removeAttribute("onload"),
a.htmlImage.removeAttribute("onerror"),a.htmlImage=null),a.rendergeometry&&(this.view._stage.getTextureGraphicsRenderer().removeRenderGeometries([a.rendergeometry]),a.rendergeometry=null),a.texture&&(this.view._stage.remove(h.ModelContentType.TEXTURE,a.texture.getId()),a.texture=null),a.material&&(this.view._stage.remove(h.ModelContentType.MATERIAL,a.material.getId()),a.material=null),this._clearDomImage(a),a.loading=!1},canResume:function(){if(!this.inherited(arguments))return!1;var a=this.layer.minScale,
b=this.layer.maxScale;if(0<a||0<b){var c=this.view.scale;if(c<b||0<a&&c>a)return!1}return!0},_drawingOrderSetter:function(a,b){if(a!==b){var c={};this._images.forEach(function(b){b&&b.material&&(b.material.setRenderPriority(a),c[b.material.getId()]=!0)});k.objectEmpty(c)||(this.view._stage.getTextureGraphicsRenderer().updateRenderOrder(c),this.emit("draped-data-change"))}return a},_hasScaleRange:function(){return 0<this.get("layer.minScale")||0<this.get("layer.maxScale")},_opacityChangeHandler:function(a){this._images.forEach(function(b){b&&
b.material&&b.material.setParameterValues({opacity:a})}.bind(this));this.emit("draped-data-change")},_clearDomImage:function(a){a.domImage&&(a.domImage.removeAttribute("src"),a.domImage.removeAttribute("onload"),a.domImage.removeAttribute("onerror"),a.domImage=null)},_evaluateUpdatingState:function(){if(this._updatingOverlay)this.set("updating",!0);else{var a=!1,b;for(b in this._images)if(this._images[b].loading){a=!0;break}this.set("updating",a)}},_createStageObjects:function(a,b){var c=this.view._stage,
e=c.getTextureGraphicsRenderer(),d=this._images[a];b?(d.texture&&c.remove(h.ModelContentType.TEXTURE,d.texture.getId()),d.texture=new E(b,"dynamicMapLayer",{width:b.width,height:b.height}),c.add(h.ModelContentType.TEXTURE,d.texture)):n(d.texture);d.material?b&&d.material.setParameterValues({textureId:d.texture.getId()}):(d.material=new I({ambient:[1,1,1],diffuse:[0,0,0],transparent:!0,opacity:this.layer.get("opacity"),textureId:d.texture.getId()},"dynamicMapLayer"),d.material.setRenderPriority(this.drawingOrder),
c.add(h.ModelContentType.MATERIAL,d.material));if(0===a)c=d.worldExtent,c=H.createSquareGeometry([[c[0],c[1],-1],[c[2],c[1],-1],[c[2],c[3],-1],[c[0],c[3],-1]],!0);else{n(1===a);c=this._images[0].worldExtent;if(!c)return;c=L(c,d.worldExtent,-1)}var f=new F(c);f.material=d.material;f.origin={vec3:[0,0,0],id:"0_0"};f.transformation=J.identity();f.name="dynamicMapLayer";f.uniqueName="dynamicMapLayer#"+c.id;e.addRenderGeometries([f]);d.rendergeometry&&e.removeRenderGeometries([d.rendergeometry]);d.rendergeometry=
f}});var L=function(){var a=new Float32Array([0,0,1]);return function(b,c,e){var d=[b[1]-c[1],b[3]-b[1],c[3]-b[3],123456],f=[b[0]-c[0],b[2]-b[0],c[2]-b[2],123456],h=c[2]-c[0],r=c[3]-c[1],s=0<f[0]&&0<f[2]?3:2;b=0<d[0]&&0<d[2]?3:2;var p=(b+1)*(s+1),g=new Float32Array(3*p),p=new Float32Array(2*p);b=new Uint32Array(6*(b*s-1));for(var v=0,k=0,n=0,m=0,q=0,t=0;4>t;t++){var x=d[t];if(!(0>=x)){for(var w=0,u=0;4>u;u++){var y=f[u];0>=y||(g[k++]=c[0]+w,g[k++]=c[1]+v,g[k++]=e,p[n++]=w/h,p[n++]=v/r,3>u&&(3>t&&
!(1===u&&1===t))&&(b[q++]=m,b[q++]=m+1,b[q++]=m+s+1,b[q++]=m+1,b[q++]=m+s+2,b[q++]=m+s+1),m++,w+=y)}v+=x}}c={};c[l.POSITION]={size:3,data:g};c[l.NORMAL]={size:3,data:a};c[l.UV0]={size:2,data:p};e={};d=new Uint32Array(b.length);for(g=0;g<d.length;g++)d[g]=0;e[l.POSITION]=b;e[l.NORMAL]=d;e[l.UV0]=b;return{faces:{type:"triangle",indices:e,positionKey:l.POSITION},vertexAttr:c,id:G.getNewId().toString()}}}();return r});