// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/geow/Account",["dijit","dojo","dojox","dojo/require!dojo/DeferredList,dojo/data/ItemFileReadStore,dojo/data/ItemFileWriteStore,dojo/data/util/sorter,dojo/json,arcgisonline/sharing/dijit/Role,arcgisonline/sharing/dijit/dialog/GeneralDlg,arcgisonline/sharing/dijit/dialog/SimpleDlg,arcgisonline/sharing/util,arcgisonline/sharing/geow/Geow"],function(l,c,m){c.provide("arcgisonline.sharing.geow.Account");c.require("dojo.DeferredList");c.require("dojo.data.ItemFileReadStore");
c.require("dojo.data.ItemFileWriteStore");c.require("dojo.data.util.sorter");c.require("dojo.json");c.require("arcgisonline.sharing.dijit.Role");c.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");c.require("arcgisonline.sharing.dijit.dialog.SimpleDlg");c.require("arcgisonline.sharing.util");c.require("arcgisonline.sharing.geow.Geow");arcgisonline.sharing.geow.Account={util:arcgisonline.sharing.util,geow:arcgisonline.sharing.geow.Geow,displayedPortalNonSSLNotice:!1,getCurrentUserInfo:function(a,
b){var e=this.util.getUser();null!==e&&this.util.getJson(esriGeowConfig.restBaseUrl+"community/users/"+e.email,c.hitch(this,a))},i18n:function(){return this._i18n?this._i18n:this._i18n=c.i18n.getLocalization("arcgisonline","arcgisonline").common},loadMapSettings:function(a){this.geow.checkSharedCookie();arcgisonline.sharing.geow.Account.getSelf(c.hitch(this,function(b,e){if(b){this.geow.setCookies(b);b.allSSL&&(esriGeowConfig.allSSL=b.allSSL);esri.isDefined(esriGeowConfig.allSSL)&&(esriGeowConfig.allSSL&&
"http:"===location.protocol)&&(window.location=arcgisonline.sharing.util.getSecureUrl(location.href));b.basemapGalleryGroupQuery&&(esriGeowConfig.basemapGalleryGroupQuery=b.basemapGalleryGroupQuery);b.templatesGroupQuery&&(esriGeowConfig.templatesGroupQuery=b.templatesGroupQuery);b.defaultBasemap&&(esriGeowConfig.defaultBasemap=b.defaultBasemap);b.defaultExtent&&(esriGeowConfig.defaultExtent=b.defaultExtent);b.symbolSetsGroupQuery&&(esriGeowConfig.symbolSetsGroupQuery=b.symbolSetsGroupQuery);b.staticImagesUrl&&
(esriGeowConfig.staticImagesUrl=b.staticImagesUrl);b.layerTemplatesGroupQuery&&(esriGeowConfig.layerTemplatesGroupQuery=b.layerTemplatesGroupQuery);b.colorSetsGroupQuery&&(esriGeowConfig.colorSetsGroupQuery=b.colorSetsGroupQuery);b.helpBase&&(esriGeowConfig.help=b.helpBase,esriGeowConfig.helpBase=b.helpBase);b.helpMap&&b.helpMap.m&&(esriGeowConfig.helpMap=b.helpMap.m);b.urlKey&&(esriGeowConfig.urlKey=b.urlKey);var d,f;if(b.authorizedCrossOriginDomains&&0<b.authorizedCrossOriginDomains.length)for(d=
0;d<b.authorizedCrossOriginDomains.length;d++)f=b.authorizedCrossOriginDomains[d],esri.isDefined(f)&&0<f.length&&esri.config.defaults.io.corsEnabledServers.push({host:f,withCredentials:!0});b.isPortal&&(arcgisonline.sharing.util._cookies&&-1===arcgisonline.sharing.util._cookies.esri_auth)&&delete arcgisonline.sharing.util._cookies.esri_auth;d=!1===esriGeowConfig.isMultiTenant;var g=(f=arcgisonline.sharing.util.getUser())?!0:!1,h=window.location.pathname.toLowerCase(),k=-1!=h.indexOf(esriGeowConfig.signin),
l=-1!=h.indexOf("troubleshoot.html"),h=-1!=h.indexOf("setup.html");if(!d&&f&&("account_admin"===f.role||"org_admin"===f.role)&&b.id&&!b.urlKey&&!h)window.location=esriGeowConfig.baseUrl+"setup.html";if(d){b.access&&("private"===b.access&&!g)&&(!this.isSignInPage&&!this.isTroubleshootPage)&&(window.location=arcgisonline.sharing.util.getSecureUrl()+esriGeowConfig.signin+"?returnUrl\x3d"+encodeURIComponent(window.location));f=c.query(".esriLogoIcon");for(d=0;d<f.length;d++)c.replaceClass(f[d],"esriLogoIcon esriOrgIcon");
b.isPortal&&"singletenant"===b.portalMode&&("7080"===location.port||"7443"===location.port)&&arcgisonline.sharing.util.checkForIAA().then(c.hitch(this,function(a){if(a&&a.hasIAA&&(b.portalHostname.match(/:7080\//)&&("http:"===location.protocol&&-1===location.href.indexOf("error.html"))&&(window.location=arcgisonline.sharing.util.getHttpUrl(esriGeowConfig.baseUrl)+"error.html?c\x3dWebAdaptorRequired"),!b.portalHostname.match(/:7080\//)&&80!==esriGeowConfig.self.httpPort&&443!==esriGeowConfig.self.httpsPort&&
"http:"===location.protocol&&-1===location.href.indexOf("error.html"))){a=new c._Url(location.href);var d=a.path.indexOf("/home/"),d=a.path.substring(d+6);a=esri.isDefined(a.query)?"?"+a.query:"";window.location=arcgisonline.sharing.util.getHttpUrl("http://"+b.portalHostname)+"/home/"+d+a}}))}else if(!b.id&&b.urlKey&&!g)!k&&!l&&(window.location=esriGeowConfig.baseUrl.replace("http:","https:")+esriGeowConfig.signin+"?returnUrl\x3d"+encodeURIComponent(window.location));else if(b.id&&b.urlKey&&!g){f=
c.query(".esriLogoIcon");for(d=0;d<f.length;d++)c.replaceClass(f[d],"esriLogoIcon esriOrgIcon")}}a&&a(b)}))},getAccountResource:function(a,b,e,d){this.util.getJson(esriGeowConfig.restBaseUrl+"portals/self/resources/"+b,c.hitch(this,e),c.hitch(this,d))},uploadAccountResource:function(a,b,e,d){this.util.postJson(b,esriGeowConfig.restBaseUrl+"portals/self/addResource",c.hitch(this,e),c.hitch(this,d))},deleteAccountResource:function(a,b,e,d){this.util.postJson({key:b},esriGeowConfig.restBaseUrl+"portals/self/removeResource",
c.hitch(this,e),c.hitch(this,d))},getAccountSettings:function(a,b){this.util.getJson(esriGeowConfig.restBaseUrl+"portals/self/resources/accountSettings",c.hitch(this,function(a){b&&b(a)}),c.hitch(this,function(a){b&&b({})}))},getSelf:function(a,b,e){if(this._isRequestingSelf)setTimeout(c.hitch(this,"getSelf",a,b),75);else{var d=esriGeowConfig.restBaseUrl+"portals/self?culture\x3d"+c.locale;e&&(d+="\x26token\x3d"+e);e=esriGeowConfig&&esriGeowConfig.self||this.util._requestWithAppHandlers({url:d}).then(c.hitch(this,
function(a){this.setupAfterSelf(a);this._isRequestingSelf=!1;10>=c.isIE&&this.throwawayIEPostFix();return a}),c.hitch(this,function(a){throw a;}));this._isRequestingSelf=!esriGeowConfig.self;return c.when(e,a,b)}},setupAfterSelf:function(a){esriGeowConfig.self=a;esriGeowConfig.userInfo=a.user&&c.mixin(esriGeowConfig.userInfo||{},a.user);a.user&&a.user.username&&(esriGeowConfig.userInfo.email=a.user&&a.user.username);a.user&&a.user.role&&(esriGeowConfig.userRole=new arcgisonline.sharing.dijit.Role({id:a.user.roleId?
a.user.roleId:a.user.role,role:a.user.role}),a.user.privileges&&esriGeowConfig.userRole.setPrivileges(a.user.privileges));this.normalizeOrgIdAndRole()},normalizeOrgIdAndRole:function(){esri.isDefined(esriGeowConfig.self.user)&&(esri.isDefined(esriGeowConfig.self.user.orgId)&&(esriGeowConfig.self.user.accountId=esriGeowConfig.self.user.orgId),esri.isDefined(esriGeowConfig.self.user.role)&&(esriGeowConfig.self.user.role=this.util.normalizeOrgRole(esriGeowConfig.self.user.role)));esri.isDefined(esriGeowConfig.userInfo)&&
(esri.isDefined(esriGeowConfig.userInfo.orgId)&&(esriGeowConfig.userInfo.accountId=esriGeowConfig.userInfo.orgId),esri.isDefined(esriGeowConfig.userInfo.role)&&(esriGeowConfig.userInfo.role=this.util.normalizeOrgRole(esriGeowConfig.userInfo.role)))},throwawayIEPostFix:function(){var a=c.create("form",{encoding:"multipart/form-data",method:"POST"});c.create("input",{type:"hidden",name:"f",value:"json"},a);c.create("input",{type:"hidden",name:"q",value:"*"},a);c.create("input",{type:"hidden",name:"callback.html",
value:"textarea"},a);c.io.iframe.send({url:esriGeowConfig.restBaseUrl+"community/users",form:a,handleAs:"json"}).then(function(a){}).otherwise(function(a){})},activateAccount:function(a,b,c){null!==this.util.getUser()&&this.util.postJson({code:a},esriGeowConfig.restBaseUrl+"portals/activate",b,c)},getAccount:function(a,b,e){null!==this.util.getUser()&&this.util.getJson(esriGeowConfig.restBaseUrl+"portals/self",c.hitch(this,b))},updateAccount:function(a,b,e){if(null!==this.util.getUser()){var d="";
a.defaultBasemap&&(d=c.json.stringify(a.defaultBasemap),d=d.replace(/(<|>)/g,function(a,b){return"\x3c"==b?"\x26lt;":"\x26gt;"}));var f=a.metadataFormats&&0<a.metadataFormats.length?a.metadataFormats.join(","):"",d={id:a.id,name:a.name,description:a.description,access:a.access,allSSL:a.allSSL,culture:a.culture,region:a.region,featuredItemsGroupQuery:a.featuredItemsGroupQuery,canSharePublic:a.canSharePublic,canSearchPublic:a.canSearchPublic,thumbnail:a.thumbnail,basemapGalleryGroupQuery:a.basemapGalleryGroupQuery,
defaultBasemap:d,defaultExtent:a.defaultExtent?c.json.stringify(a.defaultExtent):"",featuredGroups:c.json.stringify(a.featuredGroups),homePageFeaturedContent:a.homePageFeaturedContent,homePageFeaturedContentCount:a.homePageFeaturedContentCount,rotatorPanels:c.json.stringify(a.rotatorPanels),showHomePageDescription:a.showHomePageDescription,templatesGroupQuery:a.templatesGroupQuery,galleryTemplatesGroupQuery:a.galleryTemplatesGroupQuery,urlKey:a.urlKey,commentsEnabled:a.commentsEnabled,geocodeService:c.json.stringify(a.helperServices.geocode),
printServiceTask:c.json.stringify(a.helperServices.printTask),geometryService:c.json.stringify(a.helperServices.geometry),routeServiceLayer:c.json.stringify(a.helperServices.route),bingKey:a.bingKey,canShareBingPublic:a.canShareBingPublic,backgroundImage:a.backgroundImage,canSignInIDP:a.canSignInIDP,canSignInArcGIS:a.canSignInArcGIS,useStandardizedQuery:a.useStandardizedQuery,portalProperties:c.json.stringify(a.portalProperties),units:a.units,mfaEnabled:a.mfaEnabled,mfaAdmins:c.json.stringify(a.mfaAdmins),
metadataEditable:a.metadataEditable,metadataFormats:f,authorizedCrossOriginDomains:c.json.stringify(a.authorizedCrossOriginDomains),clearEmptyFields:!0};esri.isDefined(a.helperServices.asyncRoute)&&(d.asyncRouteService=c.json.stringify(a.helperServices.asyncRoute));esri.isDefined(a.helperServices.closestFacility)&&(d.closestFacilityService=c.json.stringify(a.helperServices.closestFacility));esri.isDefined(a.helperServices.asyncClosestFacility)&&(d.asyncClosestFacilityService=c.json.stringify(a.helperServices.asyncClosestFacility));
esri.isDefined(a.helperServices.serviceArea)&&(d.serviceAreaService=c.json.stringify(a.helperServices.serviceArea));esri.isDefined(a.helperServices.asyncServiceArea)&&(d.asyncServiceAreaService=c.json.stringify(a.helperServices.asyncServiceArea));esri.isDefined(a.helperServices.syncVRP)&&(d.syncVRPService=c.json.stringify(a.helperServices.syncVRP));esri.isDefined(a.helperServices.asyncVRP)&&(d.asyncVRPService=c.json.stringify(a.helperServices.asyncVRP));esri.isDefined(a.helperServices.asyncLocationAllocation)&&
(d.asyncLocationAllocationService=c.json.stringify(a.helperServices.asyncLocationAllocation));esri.isDefined(a.helperServices.routingUtilities)&&(d.routingUtilitiesService=c.json.stringify(a.helperServices.routingUtilities));esri.isDefined(a.helperServices.traffic)&&(d.trafficService=c.json.stringify(a.helperServices.traffic));this.util.isPortal()?(esri.isDefined(a.helperServices.analysis)&&(d.analysisService=c.json.stringify(a.helperServices.analysis)),esri.isDefined(a.helperServices.geoenrichment)&&
(d.geoenrichmentService=c.json.stringify(a.helperServices.geoenrichment)),esri.isDefined(a.helperServices.hydrology)&&(d.hydrologyService=c.json.stringify(a.helperServices.hydrology)),esri.isDefined(a.helperServices.elevation)&&(d.elevationService=c.json.stringify(a.helperServices.elevation)),esri.isDefined(a.helperServices.elevationSync)&&(d.elevationSyncService=c.json.stringify(a.helperServices.elevationSync))):d.contacts=c.json.stringify(a.contacts);a=this.util.getSecureUrl(esriGeowConfig.restBaseUrl)+
"portals/self/update";this.util.postJson(d,a,c.hitch(this,b),c.hitch(this,e))}},getAccountGroups:function(a,b,e,d){if(null!==this.util.getUser()){d=1;var f=10;null!==b.start&&(d=b.start);null!==b.num&&(f=b.num);a="(orgid:"+a+" AND (access:org || access:public)";this.util.isPortal()&&(a+=" AND -(owner:esri_nav AND title:'Navigator Maps')");this.util.getJson(esriGeowConfig.restBaseUrl+"community/groups?q\x3d"+(a+")")+"\x26sortField\x3dtitle\x26sortOrder\x3dasc\x26start\x3d"+d+"\x26num\x3d"+f,c.hitch(this,
e))}},checkUsernames:function(a,b,c){a=a&&0<a.length?a.join(","):"";this.util.postJson({usernames:a},esriGeowConfig.restBaseUrl+"community/checkUsernames",b,c)},inviteUsers:function(a,b,c){null!==this.util.getUser()&&this.util.postJson(a,esriGeowConfig.restBaseUrl+"portals/self/invite",b,c)},inviteAccountUsersByEmail:function(a,b,e,d){null!==this.util.getUser()&&this.util.postJson(b,esriGeowConfig.restBaseUrl+"portals/self/inviteByEmail",c.hitch(this,e),c.hitch(this,d))},getPendingAccountUsers:function(a,
b,e,d){if(null!==this.util.getUser()){a=1;d=10;var f,g,h;esri.isDefined(b.start)&&(a=b.start);esri.isDefined(b.num)&&(d=b.num);esri.isDefined(b.sortField)&&(f=b.sortField);esri.isDefined(b.sortOrder)&&(g=b.sortOrder);esri.isDefined(b.type)&&(h=b.type);b=esriGeowConfig.restBaseUrl+"portals/self/invitations?start\x3d"+a+"\x26num\x3d"+d;f&&(b+="\x26sortField\x3d"+f);g&&(b+="\x26sortOrder\x3d"+g);h&&(b+="\x26type\x3d"+h);this.util.getJson(b,c.hitch(this,e))}},retrieveInvitations:function(a,b,c){a=esriGeowConfig.restBaseUrl+
"portals/self/invitations?start\x3d"+a+"\x26num\x3d"+b;c&&(a+="\x26type\x3d"+c);return this.util.request({url:a})},getInvitation:function(a,b,e){null!==this.util.getUser()&&this.util.getJson(esriGeowConfig.restBaseUrl+"community/invitations/"+a,c.hitch(this,b),e)},acceptInvitation:function(a,b,e){null!==this.util.getUser()&&this.util.postJson({invitationId:a},esriGeowConfig.restBaseUrl+"community/invitations/"+a+"/accept",c.hitch(this,b),c.hitch(this,e))},declineInvitation:function(a,b,e){null!==
this.util.getUser()&&this.util.postJson({},esriGeowConfig.restBaseUrl+"community/invitations/"+a+"/decline",c.hitch(this,b))},approvePendingInvitation:function(a,b,e,d){null!==this.util.getUser()&&this.util.postJson({},esriGeowConfig.restBaseUrl+"portals/self/invitations/"+b+"/approve",c.hitch(this,e))},removePendingInvitation:function(a,b,e,d){null!==this.util.getUser()&&this.util.postJson({},esriGeowConfig.restBaseUrl+"portals/self/invitations/"+b+"/delete",c.hitch(this,e))},getAccountUsers:function(a,
b,e,d){if(null!==this.util.getUser()){a=1;d=10;var f,g,h,k;esri.isDefined(b.start)&&(a=b.start);esri.isDefined(b.num)&&(d=b.num);esri.isDefined(b.sortField)&&(f=b.sortField);esri.isDefined(b.sortOrder)&&(g=b.sortOrder);esri.isDefined(b.adminOnly)&&(h=b.adminOnly);esri.isDefined(b.excludeSystemUsers)&&(k=b.excludeSystemUsers);b=esriGeowConfig.restBaseUrl+"portals/self/users?start\x3d"+a+"\x26num\x3d"+d;f&&(b+="\x26sortField\x3d"+f);g&&(b+="\x26sortOrder\x3d"+g);h&&(b+="\x26role\x3dorg_admin");k&&(b+=
"\x26excludeSystemUsers\x3dtrue");this.util.getJson(b,c.hitch(this,e))}},searchAccountUsers:function(a,b,e,d){null!==this.util.getUser()&&(a=1,d=10,esri.isDefined(b.start)&&(a=b.start),esri.isDefined(b.num)&&(d=b.num),a=esriGeowConfig.restBaseUrl+"portals/self/users?start\x3d"+a+"\x26num\x3d"+d,esri.isDefined(b.sortField)&&(a+="\x26sortField\x3d"+b.sortField),esri.isDefined(b.sortOrder)&&(a+="\x26sortOrder\x3d"+b.sortOrder),esri.isDefined(b.role)&&(a+="\x26role\x3d"+b.role),esri.isDefined(b.username)&&
(a+="\x26username\x3d"+b.username),esri.isDefined(b.fullname)&&(a+="\x26fullname\x3d"+b.fullname),esri.isDefined(b.lastname)&&(a+="\x26lastname\x3d"+b.lastname),esri.isDefined(b.firstname)&&(a+="\x26firstname\x3d"+b.firstname),esri.isDefined(b.excludeSystemUsers)&&(a+="\x26excludeSystemUsers\x3dtrue"),this.util.getJson(a,c.hitch(this,e)))},searchAccountGroups:function(a,b,e,d,f){if(null!==this.util.getUser()){var g=1,h=10;null!==e.start&&(g=e.start);null!=e.num&&(h=e.num);this.util.getJson(esriGeowConfig.restBaseUrl+
"community/groups?q\x3d"+("("+b+" orgid:"+a+")")+"\x26start\x3d"+g+"\x26num\x3d"+h+"\x26sortField\x3dtitle\x26sortOrder\x3dasc",c.hitch(this,d),c.hitch(this,f))}},updateUserRole:function(a,b,e,d){var f=null,g=this.util.getUser();null!==g&&(f=g.accountId,null!==f&&(g.email===a&&"account_admin"===g.role&&"account_admin"!==b?(a=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),a.onOkClick=function(){l.byId("general-dialog").hide();e(null)},a.show({title:"Account Administrator",
message:"You are an account administrator and cannot remove yourself from the administrator role. Another account administrator must change your role."})):this.util.postJson({user:a,role:b},esriGeowConfig.restBaseUrl+"portals/self/updateUserRole",c.hitch(this,e),c.hitch(this,d))))},deleteUser:function(a,b,e){null!==this.util.getUser()&&this.util.postJson({},esriGeowConfig.restBaseUrl+"community/users/"+a+"/delete",c.hitch(this,b),c.hitch(this,e))},blankUserStore:function(){return new c.data.ItemFileReadStore({data:{identifier:"username",
label:"fullName",items:[]}})},caseInsensitiveComparator:function(a,b){a&&(a=a.toLowerCase());b&&(b=b.toLowerCase());return c.data.util.sorter.basicComparator(a,b)},pendingUsersToStore:function(a,b){var e=[];c.forEach(a,function(a,c){e[c]={id:a.id,fromUsername:a.fromUsername,email:a.email,username:a.username,role:this.util.normalizeOrgRole(a.role),targetId:a.targetId,type:a.type,targetType:a.targetType,mustApprove:a.mustApprove,accepted:a.accepted,dateAccepted:a.dateAccepted,expiration:a.expiration,
created:a.created,culture:b}},this);var d=new c.data.ItemFileReadStore({data:{identifier:"id",label:"fullName",items:e}});d.comparatorMap={email:arcgisonline.sharing.geow.Account.caseInsensitiveComparator,username:arcgisonline.sharing.geow.Account.caseInsensitiveComparator};return d},usersToStore:function(a,b){var e=[];c.forEach(a,function(a,c){e[c]={email:a.email,fullName:a.fullName,username:a.username,created:a.created,storageUsage:a.storageUsage,role:this.util.normalizeOrgRole(a.role),lastLogin:a.lastLogin,
culture:b,disabled:a.disabled,idpUsername:a.idpUsername,userType:a.userType,mfaEnabled:a.mfaEnabled,availableCredits:a.availableCredits,assignedCredits:a.assignedCredits}},this);var d=new c.data.ItemFileReadStore({data:{identifier:"username",label:"fullName",items:e}});d.comparatorMap={fullName:arcgisonline.sharing.geow.Account.caseInsensitiveComparator,username:arcgisonline.sharing.geow.Account.caseInsensitiveComparator};return d},groupsToStore:function(a){var b=[];c.forEach(a,function(a,c){b[c]=
{id:a.id,title:a.title}},this);return new c.data.ItemFileWriteStore({data:{identifier:"id",label:"group",items:b}})},getSupportedLanguages:function(a,b){return esri.request({url:esriGeowConfig.restBaseUrl+"portals/languages",content:{f:"json"},load:a,callbackParamName:"callback",error:b})},getSupportedRegions:function(a,b){return esri.request({url:esriGeowConfig.restBaseUrl+"portals/regions",content:{f:"json",culture:c.locale},load:a,callbackParamName:"callback",error:b})},getSupportedLanguagesAndRegions:function(a,
b){var e=new c.Deferred;(void 0!==a&&null!==a||void 0!==b&&null!==b)&&e.addBoth(a,b);var d=[];d.push(arcgisonline.sharing.geow.Account.getSupportedLanguages(null,null));d.push(arcgisonline.sharing.geow.Account.getSupportedRegions(null,null));d=new c.DeferredList(d);d.addCallback(function(a){var b={};b.languages=a[0][1];b.regions=a[1][1];e.callback(b)});d.addErrback(function(a){e.callback(a)});return e}}});