// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/itemData",["dijit","dojo","dojox","dojo/require!arcgisonline/sharing/dijit/dialog/GeneralDlg,arcgisonline/map/main"],function(u,c,v){c.provide("arcgisonline.map.itemData");c.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");c.require("arcgisonline.map.main");arcgisonline.map.itemData={itemDataContents:{},deletedFSItemSubLayers:{},checkItemDataContent:function(a,g){var k=function(){g&&g()};if(a.itemId&&a.featureCollection)g&&g();else if(a.itemId&&"esri.layers.FeatureLayer"===
a.layer.declaredClass){var f=function(a){var b=!1;if(a.origItemLayers){a.__createDefaultPopup&&(arcgisonline.map.popup.removePopup(a),a.popupChanged=!1,delete a.popupInfo,delete a.__createDefaultPopup);for(var p=parseInt(a.layer.url.substring(a.layer.url.lastIndexOf("/")+1)),m=!1,f=0;f<a.origItemLayers.length;f++){var e=a.origItemLayers[f];if(e.id===p){m=!0;e.popupInfo&&!a.popupInfo&&!a.disablePopup?(a.popupInfo=e.popupInfo,arcgisonline.map.popup.addPopupLayer(a,null),a.popupChanged=!1):!e.popupInfo&&
!a.popupInfo&&(a.disablePopup=!0);e.showLabels&&(a.showLabels=!0);p=a.rendererChanged||a.scaleChanged||a.defExpChanged||a.spatialFilterChanged||a.maximumTrackPointsChanged;e.layerDefinition&&e.layerDefinition.drawingInfo&&(e.layerDefinition.drawingInfo.renderer||e.layerDefinition.drawingInfo.labelingInfo)?(a.layerDefinition&&esri.isEmpty(a.layerDefinition)&&(p=a.rendererChanged=!0),p||(e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&(f=esri.renderer.fromJson(c.clone(e.layerDefinition.drawingInfo.renderer)),
"esri.renderer.ClassBreaksRenderer"===f.declaredClass&&f.setMaxInclusive(!0),a.layer.setRenderer(f),arcgisonline.map.mapUtil.checkHostedFSAccess(a,c.hitch(this,function(a){if(!a.layer.templates.length&&("esri.renderer.SimpleRenderer"==a.layer.renderer.declaredClass||"esri.renderer.ClassBreaksRenderer"==a.layer.renderer.declaredClass||"esri.renderer.HeatmapRenderer"==a.layer.renderer.declaredClass)||!a.layer.types.length&&"esri.renderer.UniqueValueRenderer"==a.layer.renderer.declaredClass)arcgisonline.map.edit.removeTypesAndTemplatesOnLayer(a.layer),
arcgisonline.map.edit.createTypesAndTemplatesOnLayer(a.layer),a.featureTemplatesChanged=!0},a))),e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.labelingInfo&&(f=c.map(e.layerDefinition.drawingInfo.labelingInfo,function(a){return new esri.layers.LabelClass(a)}),a.layer.setLabelingInfo(f),e.showLabels&&arcgisonline.map.labels.addLabelsForLayer(a.layer)))):!p&&(e.showLabels&&a.layer.labelingInfo)&&(a.showLabels=!0,arcgisonline.map.labels.addLabelsForLayer(a.layer));!p&&(e.layerDefinition&&
e.layerDefinition.definitionExpression)&&(a.layer.setDefinitionExpression(e.layerDefinition.definitionExpression),a.layerDefinition=a.layerDefinition||{},a.layerDefinition.definitionExpression=e.layerDefinition.definitionExpression,e.definitionEditor&&(a.definitionEditor=e.definitionEditor));!p&&(e.layerDefinition&&esri.isDefined(e.layerDefinition.minScale)&&esri.isDefined(e.layerDefinition.maxScale))&&a.layer.setScaleRange(e.layerDefinition.minScale,e.layerDefinition.maxScale);a.legendChanged||(!1===
e.showLegend?a.showLegend=!1:delete a.showLegend);!a.refreshIntervalChanged&&esri.isDefined(e.refreshInterval)&&a.layer.setRefreshInterval(e.refreshInterval);!a.timeChanged&&esri.isDefined(e.timeAnimation)&&a.layer.setUseMapTime(!1);if(e.layerDefinition&&(e.layerDefinition.drawingInfo&&esri.isDefined(e.layerDefinition.drawingInfo.transparency)||esri.isDefined(e.layerDefinition.defaultVisibility))&&!arcgisonline.map.main.isWebMapLayer(a))e.layerDefinition.drawingInfo&&esri.isDefined(e.layerDefinition.drawingInfo.transparency)&&
a.layer.setOpacity(1-e.layerDefinition.drawingInfo.transparency/100),esri.isDefined(e.layerDefinition.defaultVisibility)&&(e.layerDefinition.defaultVisibility?(a.layer.show(),a.visibility=!0):(a.layer.hide(),a.visibility=!1));!a.rendererChanged&&(!a.scaleChanged&&e.layerDefinition&&(e.layerDefinition.drawingInfo&&(e.layerDefinition.drawingInfo.renderer||e.layerDefinition.drawingInfo.labelingInfo)||esri.isDefined(e.layerDefinition.minScale)||esri.isDefined(e.layerDefinition.maxScale)))&&arcgisonline.map.mapUtil.checkHostedFSAccess(a,
c.hitch(this,function(a,n){if(a.layerDefinition.drawingInfo&&(a.layerDefinition.drawingInfo.renderer||a.layerDefinition.drawingInfo.labelingInfo))n.rendererChanged=!0;if(null!==a.layerDefinition.minScale||null!==a.layerDefinition.maxScale)n.scaleChanged=!0},e));break}}m||(b=!0)}g&&g(b)};arcgisonline.map.itemData.getItemLayerInfos(a,c.hitch(this,f,a),c.hitch(this,k))}else a.itemId&&"esri.layers.StreamLayer"===a.layer.declaredClass?(f=function(a){var b=arcgisonline.map.itemData.itemDataContents[a.itemId];
!b.empty&&a.__createDefaultPopup&&(arcgisonline.map.popup.removePopup(a),a.popupChanged=!1,delete a.popupInfo,delete a.__createDefaultPopup);b.popupInfo&&!a.popupInfo&&!a.disablePopup?(a.popupInfo=b.popupInfo,arcgisonline.map.popup.addPopupLayer(a,null),a.popupChanged=!1):!b.popupInfo&&!a.popupInfo&&(a.disablePopup=!0);var f=a.rendererChanged||a.scaleChanged||a.defExpChanged||a.spatialFilterChanged||a.maximumTrackPointsChanged||a.opacityChanged;if(b.layerDefinition&&(b.layerDefinition.drawingInfo&&
b.layerDefinition.drawingInfo.renderer)&&(a.layerDefinition&&esri.isEmpty(a.layerDefinition)&&(f=a.rendererChanged=!0),!f)){var m=esri.renderer.fromJson(c.clone(b.layerDefinition.drawingInfo.renderer));"esri.renderer.ClassBreaksRenderer"===m.declaredClass&&m.setMaxInclusive(!0);a.layer.setRenderer(m)}!f&&(b.layerDefinition&&esri.isDefined(b.layerDefinition.minScale)&&esri.isDefined(b.layerDefinition.maxScale))&&a.layer.setScaleRange(b.layerDefinition.minScale,b.layerDefinition.maxScale);!f&&(b.layerDefinition&&
b.layerDefinition.definitionExpression)&&(a.layer.setDefinitionExpression(b.layerDefinition.definitionExpression),a.layerDefinition=a.layerDefinition||{},a.layerDefinition.definitionExpression=b.layerDefinition.definitionExpression,b.definitionEditor&&(a.definitionEditor=b.definitionEditor));f&&!a.spatialFilterChanged&&b.layerDefinition&&b.layerDefinition.definitionGeometry?a.spatialFilterChanged=!0:!f&&(b.layerDefinition&&b.layerDefinition.definitionGeometry)&&a.layer.setFilter({geometry:new esri.geometry.Extent(b.layerDefinition.definitionGeometry)});
!f&&(b.layerDefinition&&esri.isDefined(b.layerDefinition.maximumTrackPoints))&&a.layer.setMaximumTrackPoints(b.layerDefinition.maximumTrackPoints);a.legendChanged||(!1===b.showLegend?a.showLegend=!1:delete a.showLegend);if((esri.isDefined(b.opacity)||esri.isDefined(b.visibility))&&!arcgisonline.map.main.isWebMapLayer(a))esri.isDefined(b.opacity)&&(a.layer.setOpacity(b.opacity),a.defaultOpacity=b.opacity),esri.isDefined(b.visibility)&&(b.visibility?(a.layer.show(),a.visibility=!0,a.defaultVisibility=
!0):(a.layer.hide(),a.visibility=!1,a.defaultVisibility=!1));g&&g(doNotAdd)},arcgisonline.map.itemData.getItemLayerInfos(a,c.hitch(this,f,a),c.hitch(this,k))):a.itemId?(f=function(a){a.itemLayers||(a.itemLayers=c.clone(a.origItemLayers));var b=arcgisonline.map.itemData.itemDataContents[a.itemId];if(b){var f=!1;arcgisonline.map.save_open.openedWebMap&&c.forEach(arcgisonline.map.save_open.openedWebMap.operationalLayers,function(b){b.id===a.id&&esri.isDefined(b.minScale)&&esri.isDefined(b.maxScale)&&
(f=!0)});f||esri.isDefined(b.minScale)&&esri.isDefined(b.maxScale)&&a.layer.setScaleRange(b.minScale,b.maxScale);!a.refreshIntervalChanged&&esri.isDefined(b.refreshInterval)&&(a.layer.setRefreshInterval(b.refreshInterval),delete a.refreshInterval);!a.timeChanged&&esri.isDefined(b.timeAnimation)&&a.layer.setUseMapTime(!1);if((esri.isDefined(b.opacity)||esri.isDefined(b.visibility))&&!arcgisonline.map.main.isWebMapLayer(a))esri.isDefined(b.opacity)&&a.layer.setOpacity(b.opacity),esri.isDefined(b.visibility)&&
(b.visibility?(a.layer.show(),a.visibility=!0,a.defaultVisibility=!0):(a.layer.hide(),a.visibility=!1,a.defaultVisibility=!1));if("esri.layers.ArcGISImageServiceLayer"===a.layer.declaredClass){!a.defaultBandIds&&b.bandIds&&a.layer.setBandIds(b.bandIds);if(!a.renderingRule&&b.renderingRule){var m=new esri.layers.RasterFunction(b.renderingRule);a.layer.setRenderingRule(m,!0)}!a.mosaicRule&&b.mosaicRule&&(m=new esri.layers.MosaicRule(b.mosaicRule),a.layer.setMosaicRule(m,!0));!a.format&&b.format&&a.layer.setImageFormat(b.format,
!0);!a.compressionQuality&&b.compressionQuality&&a.layer.setCompressionQuality(b.compressionQuality,!0);!a.popupInfo&&!a.disablePopup&&b.popupInfo?(a.popupInfo=b.popupInfo,arcgisonline.map.popup.addPopupLayer(a,null),a.popupChanged=!1):!b.popupInfo&&!a.popupInfo&&(a.disablePopup=!0);if((!a.layerDefinition||a.layerDefinition&&esri.isEmpty(a.layerDefinition.definitionExpression))&&b.layerDefinition&&esri.isDefined(b.layerDefinition.definitionExpression))a.layer.setDefinitionExpression(b.layerDefinition.definitionExpression),
a.layerDefinition=b.layerDefinition||{},a.layerDefinition.definitionExpression=b.layerDefinition.definitionExpression,b.definitionEditor&&(a.definitionEditor=b.definitionEditor);a.legendChanged||(!1===b.showLegend?a.showLegend=!1:delete a.showLegend)}}if(a.itemLayers&&0<a.itemLayers.length){var k=[];c.forEach(a.itemLayers,function(b){b.layerDefinition&&b.layerDefinition.definitionExpression&&(a.layer.setLayerDefinitions?k[b.id]=b.layerDefinition.definitionExpression:delete b.layerDefinition.definitionExpression)},
this);k.length&&a.layer.setLayerDefinitions(k);arcgisonline.map.main.hasDynamicLayers(a)&&(a.origItemLayers&&!a.layersChanged)&&arcgisonline.map.dynLayer.updateDynamicLayers(a)}!a.visibleLayersChanged&&b.visibleLayers&&(a.layer.setVisibleLayers?(a.visibleLayers=b.visibleLayers.toString(),m=a.layer.layerInfos,arcgisonline.map.main.hasDynamicLayers(a)&&(m=a.itemLayers),b=arcgisonline.map.main.filterSubLayers(m,b.visibleLayers.toString()),a.layer.setVisibleLayers(b)):delete b.visibleLayers);a.popupChanged||
arcgisonline.map.main.isMapFullyLoaded&&(arcgisonline.map.main.hasDynamicLayers(a)?arcgisonline.map.main.getLayersInfo(a,c.hitch(this,function(){c.forEach(a.layer.dynamicLayerInfos,function(b,c){arcgisonline.map.popup.addPopupLayer(a,b.id)},this)})):arcgisonline.map.main.getLayersInfo(a,c.hitch(this,function(){c.forEach(a.layer.layerInfos,function(b){arcgisonline.map.popup.addPopupLayer(a,b.id)},this)})));g&&g()},arcgisonline.map.itemData.getItemLayerInfos(a,c.hitch(this,f,a),c.hitch(this,k))):g&&
g()},getItemLayerInfos:function(a,g,k){var f=function(){var c=arcgisonline.map.itemData.itemDataContents[a.itemId];c.error||c.message?k&&k():(c.layers&&(a.origItemLayers=c.layers,a.thematicGroup=c.thematicGroup),esri.isDefined(c.refreshInterval)&&!esri.isDefined(a.refreshInterval)&&(a.refreshInterval=c.refreshInterval),c.visibleLayers&&!esri.isDefined(a.visibleLayers)&&(a.visibleLayers=c.visibleLayers.toString()),g())};arcgisonline.map.itemData.itemDataContents[a.itemId]?arcgisonline.map.itemData.itemDataContents[a.itemId].loading?
a.intervalHandler||(a.intervalHandler=setInterval(c.hitch(this,function(){!0!==arcgisonline.map.itemData.itemDataContents[a.itemId].loading&&(clearInterval(a.intervalHandler),delete a.intervalHandler,f())}),500)):f():(arcgisonline.map.itemData.itemDataContents[a.itemId]={loading:!0},arcgisonline.sharing.util.request({url:esriGeowConfig.restBaseUrl+"content/items/"+a.itemId+"/data"},{disableIdentityLookup:!0}).then(c.hitch(this,function(c){null===c&&(a.url&&-1<a.url.toLowerCase().indexOf("/streamserver"))&&
(c={empty:!0});c=c||{};c.layers&&0==c.layers.length&&delete c.layers;arcgisonline.map.itemData.itemDataContents[a.itemId]=c;f()}),c.hitch(this,function(c){arcgisonline.map.itemData.itemDataContents[a.itemId]=c;k&&k()})))},uploadItemLayerInfos:function(a,g,k){var f=new c.Deferred;if(arcgisonline.sharing.util.isLoggedIn()){var n=function(b,e,n){m.hide();a.itemLayers&&a.itemLayers.length?a.origItemLayers=c.clone(a.itemLayers):a.layer&&(a.layer.url&&(a.defExpChanged||a.spatialFilterChanged||a.rendererChanged&&
!k))&&arcgisonline.map.thumbnail.recreateItemThumbnail(a);arcgisonline.map.itemData.itemDataContents[a.itemId]=b;delete a.popupChanged;delete a.legendChanged;delete a.scaleChanged;delete a.defExpChanged;delete a.spatialFilterChanged;delete a.maximumTrackPointsChanged;delete a.renderingRuleChanged;delete a.mosaicRuleChanged;delete a.imageQualityChanged;delete a.refreshIntervalChanged;delete a.visibleLayersChanged;delete a.dataChanged;delete a.editableChanged;delete a.timeChanged;delete a.visibilityChanged;
delete a.opacityChanged;delete a.layersChanged;arcgisonline.map.mapUtil.checkHostedFSAccess(a,null,c.hitch(this,function(a){k||delete a.rendererChanged}));g&&g();!f.isResolved()&&f.callback()},b=function(b,e){m.hide();arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:c.string.substitute(esri.i18nBundle.viewer.mapUtil.savingPropsFailed,{title:a.itemCard.title})})},p=function(){if(a.layer&&"esri.layers.FeatureLayer"===
a.layer.declaredClass&&!a.origItemLayers&&!arcgisonline.map.itemData.deletedFSItemSubLayers[a.itemId]){arcgisonline.map.itemData.deletedFSItemSubLayers[a.itemId]=[];var f=a.url.substring(0,a.url.lastIndexOf("/"));arcgisonline.sharing.util.request({url:f+"?f\x3djson"}).then(function(b){var d=[];b.layers&&c.forEach(b.layers,function(a){d[a.id]={}});c.forEach(arcgisonline.map.main.mapLayers,function(b){b.itemId===a.itemId&&(b=parseInt(b.layer.url.substring(b.layer.url.lastIndexOf("/")+1)),delete d[b])});
if(esri.isEmpty(d))p();else{b=[];for(subId in d){var e=new c.Deferred;b.push(e);arcgisonline.sharing.util.request({url:f+"/"+subId+"?f\x3djson"}).then(c.hitch(this,function(b,c){arcgisonline.map.itemData.deletedFSItemSubLayers[a.itemId].push({id:c.id,popupInfo:arcgisonline.map.popup.getDefaultPopupInfo(c)});b.callback()},e),c.hitch(this,function(a,b){a.callback()},e))}(new c.DeferredList(b)).addCallback(function(a){p()})}},function(a){p()})}else{var e=function(a,d,e){var f={};d&&(f.text=c.json.stringify(d));
e&&(f.thumbnailURL=e);if(a.itemCard&&"Feature Service"===a.itemCard.type&&(arcgisonline.sharing.util.isHostedService(a.url)||-1<c.indexOf(a.itemCard.typeKeywords,"providerSDS")))if(arcgisonline.map.main.isNewRendererType_2_1(a))e=a.itemCard.typeKeywords,-1==c.indexOf(e,"webmap_2.1")&&(e.push("webmap_2.1"),f.typeKeywords=e.toString());else if(e=a.itemCard.typeKeywords,-1<c.indexOf(e,"webmap_2.1")){var g=c.indexOf(e,"webmap_2.1");e.splice(g,1);f.typeKeywords=e.toString()}arcgisonline.sharing.util.getUser();
e=esriGeowConfig.restBaseUrl+"content/users/"+a.itemCard.owner;e+=a.itemCard.ownerFolder?"/"+a.itemCard.ownerFolder:"";e+="/items/"+a.itemCard.id+"/update";arcgisonline.sharing.util.postJson(f,e,c.hitch(this,n,d),c.hitch(this,b))},l=arcgisonline.map.itemData.itemDataContents[a.itemId]||{};if(arcgisonline.map.featColl.isFeatureCollection(a)){var d=arcgisonline.map.featColl.buildFeatureCollectionJson(a);k&&(a.layers?c.forEach(d.layers,function(a,b){a.layerDefinition&&a.layerDefinition.drawingInfo&&
(a.layerDefinition.drawingInfo=l.featureCollection?l.featureCollection.layers[b].layerDefinition.drawingInfo:l.layers[b].layerDefinition.drawingInfo)}):d.layers[0].layerDefinition&&l.layers[0].layerDefinition&&(d.layers[0].layerDefinition.drawingInfo=l.layers[0].layerDefinition.drawingInfo));if(a.layers)if(d.opacity=a.layers[0].opacity||0===a.layers[0].opacity?a.layers[0].opacity:1,d.visibility=!1==a.visibility?!1:!0,esri.isDefined(a.visibleLayers))if(""===a.visibleLayers)d.visibleLayers=[];else{var g=
a.visibleLayers.split(",");g.length<a.layers.length&&(d.visibleLayers=c.map(g,function(a){return parseInt(a)}))}else delete d.visibleLayers;else d.visibility=a.layer.visible,d.opacity=a.layer.opacity||0===a.layer.opacity?a.layer.opacity:1;delete l.layers;d=c.mixin(l,d);if((a.rendererChanged&&!k||a.scaleChanged)&&!arcgisonline.map.thumbnail.hasCustomThumbnail(a))arcgisonline.map.thumbnail.buildThumbnailURLFromLayerOnMap(a,a.itemCard.extent?a.itemCard.extent.toString():"").then(function(b){e(a,null,
b)});e(a,d)}else if(a.layer&&"esri.layers.FeatureLayer"===a.layer.declaredClass){var d=parseInt(a.layer.url.substring(a.layer.url.lastIndexOf("/")+1)),h=null;if(a.origItemLayers)for(g=0;g<a.origItemLayers.length;g++){if(a.origItemLayers[g].id===d){h=a.origItemLayers[g];break}}else a.origItemLayers=[],c.forEach(arcgisonline.map.main.mapLayers,function(b){if(b.itemId===a.itemId&&b.popupInfo){var c={id:parseInt(b.layer.url.substring(b.layer.url.lastIndexOf("/")+1)),popupInfo:b.popupInfo};a.origItemLayers.push(c);
b.id===a.id&&(h=c)}},this),arcgisonline.map.itemData.deletedFSItemSubLayers[a.itemId]&&(c.forEach(arcgisonline.map.itemData.deletedFSItemSubLayers[a.itemId],function(b){a.origItemLayers.push(b)}),a.origItemLayers=a.origItemLayers.sort(function(a,b){return a.id<b.id?-1:1}));h||(h={id:d},a.origItemLayers.push(h));a.popupInfo&&a.popupChanged?h.popupInfo=a.popupInfo:a.disablePopup&&delete h.popupInfo;a.legendChanged&&(!1===a.showLegend?h.showLegend=!1:delete h.showLegend);a.refreshIntervalChanged&&esri.isDefined(a.layer.refreshInterval)&&
(a.layer.refreshInterval?h.refreshInterval=a.layer.refreshInterval:delete h.refreshInterval);a.visibleLayersChanged&&esri.isDefined(a.visibleLayers)&&(h.visibleLayers=a.visibleLayers);a.timeChanged&&!1==a.layer.useMapTime?h.timeAnimation=!1:delete h.timeAnimation;a.defExpChanged&&(a.layerDefinition&&esri.isDefined(a.layerDefinition.definitionExpression)&&(a.layerDefinition.definitionExpression.length?(h.layerDefinition=h.layerDefinition||{},h.layerDefinition.definitionExpression=a.layerDefinition.definitionExpression,
a.definitionEditor&&(h.definitionEditor=a.definitionEditor)):(delete h.layerDefinition.definitionExpression,delete h.definitionEditor)),a.layerDefinition&&""==a.layerDefinition.definitionExpression&&delete a.layerDefinition.definitionExpression);a.opacityChanged&&(d=a.layer.opacity||0===a.layer.opacity?a.layer.opacity:1,1>d?(h.layerDefinition=h.layerDefinition||{},h.layerDefinition.drawingInfo=h.layerDefinition.drawingInfo||{},h.layerDefinition.drawingInfo.transparency=100-100*d):h.layerDefinition&&
(h.layerDefinition.drawingInfo&&esri.isDefined(h.layerDefinition.drawingInfo.transparency))&&(delete h.layerDefinition.drawingInfo.transparency,esri.isEmpty(h.layerDefinition.drawingInfo)&&(delete h.layerDefinition.drawingInfo,esri.isEmpty(h.layerDefinition)&&delete h.layerDefinition)));h.layerDefinition=h.layerDefinition||{};h.layerDefinition.defaultVisibility=a.layer.visible;!a.scaleChanged&&h.layerDefinition&&(delete h.layerDefinition.minScale,delete h.layerDefinition.maxScale);var t=function(a,
b){var d={};d.layers=a.origItemLayers;a.thematicGroup&&(d.thematicGroup=a.thematicGroup);a.analysisInfo&&(d.analysisInfo=a.analysisInfo);delete l.layers;delete l.thematicGroup;delete l.analysisInfo;d=c.mixin(l,d);(a.rendererChanged||a.scaleChanged||a.defExpChanged)&&!arcgisonline.map.thumbnail.hasCustomThumbnail(a)&&arcgisonline.map.thumbnail.recreateItemThumbnail(a);e(a,d)};arcgisonline.map.mapUtil.checkHostedFSAccess(a,c.hitch(this,function(a,b){a.layerDefinition&&(a.layerDefinition.drawingInfo&&
delete a.layerDefinition.drawingInfo,a.layerDefinition.minScale&&delete a.layerDefinition.minScale,a.layerDefinition.maxScale&&delete a.layerDefinition.maxScale);b.layer.labelingInfo&&b.showLabels&&(a.showLabels=!0);esri.isEmpty(a.layerDefinition)&&delete a.layerDefinition;t(b,a)},h),c.hitch(this,function(a,b){b.rendererChanged&&!k&&(a.layerDefinition=a.layerDefinition||{},a.layerDefinition.drawingInfo||(a.layerDefinition.drawingInfo={}),a.layerDefinition.drawingInfo.renderer=b.layer.renderer.toJson(),
b.layer.labelingInfo&&b.showLabels?(a.layerDefinition.drawingInfo.labelingInfo=c.map(b.layer.labelingInfo,function(a){return a.toJson()}),a.showLabels=!0):(delete a.layerDefinition.drawingInfo.labelingInfo,delete a.showLabels));if(b.scaleChanged){var d=b.layer.minScale?b.layer.minScale:0,e=b.layer.maxScale?b.layer.maxScale:0;1===e&&(e=0);a.layerDefinition=a.layerDefinition||{};a.layerDefinition.minScale=d;a.layerDefinition.maxScale=e;if(0===d&&0===e&&(d=b.serviceInfo,(!d||!esri.isDefined(d.minScale)||
!esri.isDefined(d.maxScale)||!(0!==d.minScale||0!==d.maxScale))&&a.layerDefinition))delete a.layerDefinition.minScale,delete a.layerDefinition.maxScale,esri.isEmpty(a.layerDefinition)&&delete a.layerDefinition}t(b,a)},h))}else if(a.layer&&"esri.layers.StreamLayer"===a.layer.declaredClass){d={};a.popupInfo&&(d.popupInfo=a.popupInfo);!1===a.showLegend&&(d.showLegend=!1);d.visibility=a.layer.visible;d.opacity=a.layer.opacity||0===a.layer.opacity?a.layer.opacity:1;if(a.rendererChanged||a.scaleChanged||
a.defExpChanged||a.spatialFilterChanged||a.maximumTrackPointsChanged){d.layerDefinition=arcgisonline.map.itemData.itemDataContents[a.itemId].layerDefinition||{};a.layerDefinition&&esri.isDefined(a.layerDefinition.definitionExpression)&&a.layerDefinition.definitionExpression.length&&(d.layerDefinition.definitionExpression=a.layerDefinition.definitionExpression,a.definitionEditor&&(d.definitionEditor=a.definitionEditor));a.layerDefinition&&a.layerDefinition.definitionGeometry&&(d.layerDefinition.definitionGeometry=
a.layerDefinition.definitionGeometry);d.layerDefinition.drawingInfo=d.layerDefinition.drawingInfo||{};d.layerDefinition.drawingInfo.renderer=a.layer.renderer.toJson();a.layerDefinition&&esri.isDefined(a.layerDefinition.maximumTrackPoints)&&(d.layerDefinition.maximumTrackPoints=a.layerDefinition.maximumTrackPoints);var g=a.layer.minScale?a.layer.minScale:0,q=a.layer.maxScale&&1!==a.layer.maxScale?a.layer.maxScale:0;0===g&&0===q&&a.serviceInfo&&!a.serviceInfo.minScale&&!a.serviceInfo.maxScale||a.serviceInfo&&
a.serviceInfo.minScale===g&&a.serviceInfo.maxScale===q?(delete d.layerDefinition.minScale,delete d.layerDefinition.maxScale):(d.layerDefinition.minScale=g,d.layerDefinition.maxScale=1===q?0:q)}else d.layerDefinition=l.layerDefinition,d.definitionEditor=l.definitionEditor;delete l.popupInfo;delete l.showLegend;delete l.layerDefinition;delete l.definitionEditor;d=c.mixin(l,d);e(a,d)}else if(d={},l){d=l;if(a.itemLayers&&a.itemLayers.length){for(g=a.itemLayers.length-1;0<=g;g--)q=a.itemLayers[g],q.layerDefinition&&
""==q.layerDefinition.definitionExpression&&(delete q.layerDefinition,c.json.stringify(q)==c.json.stringify({id:q.id})&&a.itemLayers.splice(g,1));a.itemLayers.length?d.layers=c.map(a.itemLayers,function(a){delete a._layerInfo;return a}):delete a.itemLayers}else d.layers&&("esri.layers.ArcGISDynamicMapServiceLayer"===a.layer.declaredClass||"esri.layers.ArcGISTiledMapServiceLayer"===a.layer.declaredClass)&&delete d.layers;a.scaleChanged&&(0!==a.layer.minScale||0!==a.layer.maxScale?(d.minScale=a.layer.minScale?
a.layer.minScale:0,d.maxScale=a.layer.maxScale&&1!==a.layer.maxScale?a.layer.maxScale:0):(delete d.minScale,delete d.maxScale));a.refreshIntervalChanged&&(a.layer.refreshInterval?d.refreshInterval=a.layer.refreshInterval:delete d.refreshInterval);if(a.visibleLayersChanged&&esri.isDefined(a.visibleLayers)){var q=g="",r=a.layer.layerInfos;arcgisonline.map.main.hasDynamicLayers(a)&&(r=a.itemLayers);for(var s=0;s<r.length;s++)if(!0==r[s].defaultVisibility||!esri.isDefined(r[s].defaultVisibility))q+=g+
r[s].id,g=",";q==a.visibleLayers?delete d.visibleLayers:""===a.visibleLayers?d.visibleLayers=[]:(g=a.visibleLayers.split(","),d.visibleLayers=c.map(g,function(a){return parseInt(a)}))}a.timeChanged&&(!1==a.layer.useMapTime?d.timeAnimation=!1:delete d.timeAnimation);d.visibility=a.layer.visible;d.opacity=a.layer.opacity||0===a.layer.opacity?a.layer.opacity:1;"esri.layers.ArcGISImageServiceLayer"===a.layer.declaredClass&&(a.renderingRuleChanged&&(a.layer.bandIds?d.bandIds=a.layer.bandIds:delete d.bandIds,
a.layer.renderingRule?d.renderingRule=a.layer.renderingRule.toJson():delete d.renderingRule),a.mosaicRuleChanged&&(a.layer.mosaicRule?d.mosaicRule=a.layer.mosaicRule.toJson():delete d.mosaicRule),a.imageQualityChanged&&(a.layer.format?d.format=a.layer.format:delete d.format,a.layer.compressionQuality?d.compressionQuality=a.layer.compressionQuality:delete d.compressionQuality),a.popupInfo&&a.popupChanged?d.popupInfo=a.popupInfo:a.disablePopup&&delete d.popupInfo,a.defExpChanged&&(a.layerDefinition&&
esri.isDefined(a.layerDefinition.definitionExpression)?(d.layerDefinition=a.layerDefinition,esri.isDefined(a.definitionEditor)&&(d.definitionEditor=a.definitionEditor)):(delete d.layerDefinition,delete a.layerDefinition.definitionExpression,delete a.definitionEditor)),a.legendChanged&&(!1===a.showLegend?d.showLegend=!1:delete d.showLegend));e(a,d)}else m.hide(),arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:c.string.substitute(esri.i18nBundle.viewer.mapUtil.savingPropsFailed,
{title:a.itemCard.title})})}},m=arcgisonline.sharing.dijit.dialog.WaitingDlg.prototype.statics.getInstance();m.show({title:esri.i18nBundle.common.save,message:c.string.substitute(esri.i18nBundle.viewer.mapUtil.savingProps,{title:a.itemCard.title})});arcgisonline.map.itemData.getItemLayerInfos(a,c.hitch(this,p),c.hitch(this,p));return f}arcgisonline.map.main.requireAuthentication()},editFS:function(a,g){var k=new c.Deferred;if(arcgisonline.sharing.util.isLoggedIn()){var f=[];f.push(arcgisonline.map.itemData._editFSItem(a,
g));f.push(arcgisonline.map.itemData._editFSService(a,g));f=new c.DeferredList(f);f.addCallback(function(a){k.callback()});f.addErrback(function(a){k.errback()});return k}arcgisonline.map.main.requireAuthentication()},_editFSItem:function(a,g){var k=new c.Deferred,f=function(a,b,f){if(!a.layers||0===a.layers.length)f.callback();else{var m=parseInt(b.url.substring(b.url.lastIndexOf("/")+1)),k=!1;c.forEach(a.layers,function(e){if(e.id===m){var l=!1;g.addField&&e.popupInfo?l=!0:g.deleteField&&e.popupInfo&&
(l=!0);l?(arcgisonline.map.itemData.itemDataContents[b.itemCard.id]=a,e={text:c.json.stringify(a)},l=esriGeowConfig.restBaseUrl+"content/users/"+b.itemCard.owner,l+=b.itemCard.ownerFolder?"/"+b.itemCard.ownerFolder:"",l+="/items/"+b.itemCard.id+"/update",arcgisonline.sharing.util.postJson(e,l).then(function(a){f.callback()},function(a){f.errback()})):f.callback();k=!0}});k||f.callback()}};arcgisonline.map.itemData.itemDataContents[a.itemCard.id]?f(arcgisonline.map.itemData.itemDataContents[a.itemCard.id],
a,k):arcgisonline.sharing.util.request({url:esriGeowConfig.restBaseUrl+"content/items/"+a.itemCard.id+"/data"}).then(function(c){c=c||{};c.layers&&0==c.layers.length&&delete c.layers;arcgisonline.map.itemData.itemDataContents[a.itemCard.id]=c;f(c,a,k)},function(c){arcgisonline.map.itemData.itemDataContents[a.itemCard.itemId]=c;k.errback()});return k},_editFSService:function(a,g){var k=new c.Deferred,f=function(a,b,f){b.serviceInfo=a;var g={};g.typeIdField=a.typeIdField;g.types=a.types;g.templates=
a.templates;a={f:"json",updateDefinition:c.json.stringify(g)};b=b.url.replace("/rest/services","/rest/admin/services")+"/updateDefinition";arcgisonline.sharing.util.postJson(a,b).then(function(a){f.callback()},function(a){f.errback()})};a.serviceInfo?f(a.serviceInfo,a,k):arcgisonline.sharing.util.request({url:a.url}).then(function(c,b){a.serviceInfo=c;f(c,a,k)},function(a){k.errback()});return k},updateFeatureService:function(a,g){a.layer.renderer.toJson();var k=[];a.layer.types&&c.forEach(a.layer.types,
function(a){k.push(a.toJson())});var f=null;a.layer.labelingInfo&&a.showLabels&&(f=c.map(a.layer.labelingInfo,function(a){return a.toJson()}));var n={};if(a.rendererChanged||a.featureTemplatesChanged||a.opacityChanged)n.drawingInfo={renderer:a.layer.renderer.toJson()},f&&(n.drawingInfo.labelingInfo=f),n.typeIdField=a.layer.typeIdField,n.types=k,n.templates=a.layer.templates,n.drawingInfo.transparency=100-100*a.layer.opacity;a.scaleChanged&&(f=a.layer.maxScale?a.layer.maxScale:0,n.minScale=a.layer.minScale?
a.layer.minScale:0,n.maxScale=1===f?0:f);var n={f:"json",updateDefinition:c.json.stringify(n)},f=a.layer.url.replace("/rest/services","/rest/admin/services")+"/updateDefinition",b=arcgisonline.sharing.util.getToken();b&&(n.token=b);var p=arcgisonline.sharing.dijit.dialog.WaitingDlg.prototype.statics.getInstance();p.show({title:esri.i18nBundle.common.save,message:c.string.substitute(esri.i18nBundle.viewer.mapUtil.savingProps,{title:a.itemCard.title})});esri.request({url:f,content:n,callbackParamName:"callback",
load:c.hitch(this,function(b){setTimeout(c.hitch(this,function(){p.hide()}),1);b.success?(delete a.featureTemplatesChanged,delete a.rendererChanged,delete a.scaleChanged,a.layerDefinition&&(delete a.layerDefinition.drawingInfo,delete a.layerDefinition.minScale,delete a.layerDefinition.maxScale,esri.isEmpty(a.layerDefinition)&&delete a.layerDefinition),arcgisonline.map.thumbnail.recreateItemThumbnail(a),arcgisonline.map.itemData.getItemLayerInfos(a,c.hitch(this,function(){var b=null;if(a.origItemLayers)for(var e=
parseInt(a.layer.url.substring(a.layer.url.lastIndexOf("/")+1)),f=0;f<a.origItemLayers.length;f++)if(a.origItemLayers[f].id===e){b=a.origItemLayers[f];break}e=!1;if(a.itemCard&&"Feature Service"===a.itemCard.type&&(arcgisonline.sharing.util.isHostedService(a.url)||-1<c.indexOf(a.itemCard.typeKeywords,"providerSDS")))arcgisonline.map.main.isNewRendererType_2_1(a)?-1==c.indexOf(a.itemCard.typeKeywords,"webmap_2.1")&&(e=!0):-1<c.indexOf(a.itemCard.typeKeywords,"webmap_2.1")&&(e=!0);e||b&&b.layerDefinition||
a.popupChanged||a.legendChanged||a.layer.labelingInfo&&a.showLabels&&!b.showLabels||(!a.layer.labelingInfo||!a.showLabels)&&b.showLabels?arcgisonline.map.itemData.uploadItemLayerInfos(a,c.hitch(this,function(){g&&g()})):g&&g()}),c.hitch(this,function(){g&&g()}))):console.log(b)}),error:function(a){p.hide();console.log(a);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:c.string.substitute(esri.i18nBundle.viewer.mapUtil.errror.couldNotSaveEdits,
{msg:a.message?"("+a.message+")":""})})}},{usePost:!0})}}});