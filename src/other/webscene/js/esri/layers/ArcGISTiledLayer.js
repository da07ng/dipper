// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../core/declare dojo/_base/lang dojo/io-query ../request ../core/urlUtils ../geometry/SpatialReference ./TiledLayer ./mixins/ArcGISMapService ./mixins/ArcGISCachedService".split(" "),function(h,e,k,l,g,m,n,p,q){return h([n,p,q],{declaredClass:"esri.layers.ArcGISTiledLayer",classMetadata:{reader:{add:["spatialReference"]}},_mapsWithAttribution:"Canvas/World_Dark_Gray_Base Canvas/World_Dark_Gray_Reference Canvas/World_Light_Gray_Base Canvas/World_Light_Gray_Reference Elevation/World_Hillshade Ocean/World_Ocean_Base Ocean/World_Ocean_Reference Ocean_Basemap Reference/World_Boundaries_and_Places Reference/World_Boundaries_and_Places_Alternate Reference/World_Transportation World_Imagery World_Street_Map World_Topo_Map".split(" "),
_TILE_FORMATS:{PNG:"png",PNG8:"png",PNG24:"png",PNG32:"png",JPG:"jpg",JPEG:"jpg",GIF:"gif"},_attributionServices:["services.arcgisonline.com/arcgis/rest/services","servicesdev.arcgisonline.com/arcgis/rest/services","servicesqa.arcgisonline.com/arcgis/rest/services"],normalizeCtorArgs:function(a,b){return"string"===typeof a?e.mixin({},{url:a},b):a},getDefaults:function(a){var b=null,c=[];a.url&&(c=g.urlToObject(a.url).path.toLowerCase(),b=this._getDefaultAttribution(this._getMapName(c)),c=this._getDefaultTileServers(c));
return e.mixin(this.inherited(arguments),{tileServers:c,attributionDataUrl:b,hasAttributionData:!!b})},initialize:function(){this.addResolvingPromise(this._fetchService())},popupTemplates:null,tileServers:null,_tileServersSetter:function(a){return Array.isArray(a)?a.map(function(a){return g.urlToObject(a).path}):null},_spatialReferenceReader:function(a,b){return(a=a||b.tileInfo&&b.tileInfo.spatialReference)&&new m(a)},getTileUrl:function(a,b,c){var d=this.tileServers,f=e.mixin({},this.parsedUrl.query,
{token:this.token,blankTile:this.resampling&&!this.tileMap&&this.supportsBlankTile?!1:null,_ts:this.refreshTimestamp});a=(d&&d.length?d[b%d.length]:this.parsedUrl.path)+"/tile/"+a+"/"+b+"/"+c;f=k.objectToQuery(f);return g.addProxy(a+(f?"?"+f:""))},_fetchService:function(){return l({url:this.parsedUrl.path,content:e.mixin({f:"json"},this.parsedUrl.query),handleAs:"json",callbackParamName:"callback"}).then(function(a){a._ssl&&(delete a._ssl,this.url=this.url.replace(/^http:/i,"https:"));this.read(a)}.bind(this))},
_getMapName:function(a){return(a=a.match(/^https?\:\/\/(server|services)\.arcgisonline\.com\/arcgis\/rest\/services\/([^\/]+(\/[^\/]+)*)\/mapserver/i))&&a[2]},_getDefaultAttribution:function(a){if(a){var b;a=a.toLowerCase();for(var c=0,d=this._mapsWithAttribution.length;c<d;c++)if(b=this._mapsWithAttribution[c],-1<b.toLowerCase().indexOf(a))return this._getProtocol()+"//static.arcgis.com/attribution/"+b}},_getProtocol:function(){var a=window.location.protocol;return"file:"===a?"http:":a},_getDefaultTileServers:function(a){var b=
-1!==a.search(/^https?\:\/\/server\.arcgisonline\.com/i),c=-1!==a.search(/^https?\:\/\/services\.arcgisonline\.com/i);return b||c?[a,a.replace(b?/server\.arcgisonline/i:/services\.arcgisonline/i,b?"services.arcgisonline":"server.arcgisonline")]:[]}})});