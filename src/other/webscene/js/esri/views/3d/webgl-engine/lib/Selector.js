// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define(["./PerformanceTimer","./gl-matrix"],function(p,l){function h(b,d){this.normal=e.create();this.init(b,d)}function c(b,d,a,f,q,t,k,c){this.dir=e.create();this.normalDir=null;this.minResult=new h(a,f);this.maxResult=new h(a,f);this.timer=new p(1);this.invertedM=g.create();this.intersectObject=this.intersectObject.bind(this);this.init(b,d,a,f,q,t,k,c);this.mode="intersect"}var e=l.vec3d,g=l.mat4d;h.prototype.getIntersectionPoint=function(b){if(void 0===this.dist)return!1;e.lerp(this.p0,this.p1,
this.dist,b);return!0};h.prototype.set=function(b,d,a,f,q,c,k,h){this.dist=a;e.set(f,this.normal);this.object=b;this.name=d;this.priority=q;this.center=c;this.geometryId=k;this.triangleNr=h};h.prototype.setIntersector=function(b){this.intersector=b};h.prototype.init=function(b,d){this.priority=this.name=this.object=this.dist=void 0;this.triangleNr=this.geometryId=this.center=null;this.intersector="stage";this.p0=b;this.p1=d};c.prototype.init=function(b,d,a,f,c,h,k,g){a&&f&&e.subtract(f,a,this.dir);
this.minResult.init(a,f);this.maxResult.init(a,f);this.numObjectsTested=0;this.point=c;this.camera=h;this.isSelection=g;this.layers=b;this.objectIds=d;this.p0=a;this.p1=f;this.hudResults=[];null==k&&(k=1E-5);this.tolerance=k;if(this.objectIds){this.objectIdSet=new Set;for(a=0;a<this.objectIds.length;a++)this.objectIdSet.add(this.objectIds[a])}else this.objectIdSet=null;if(this.layers){this.timer.start();for(b=0;b<this.layers.length;++b)if(d=this.layers[b],a=d.getSpatialQueryAccelerator?d.getSpatialQueryAccelerator():
void 0)a.forEachObjectAlongRay(this.p0,this.dir,this.intersectObject);else{d=d.getObjects();a=0;for(f=d.length;a<f;++a)this.intersectObject(d[a])}this.timer.stop();this.performanceInfo={queryDuration:this.timer.getLast(),numObjectsTested:this.numObjectsTested}}};c.prototype.getDirection=function(){this.normalDir||(this.normalDir=e.create(),e.normalize(this.dir,this.normalDir));return this.normalDir};var m=g.create(),r=e.create(),s=e.create();c.prototype.intersectObject=function(b){if(!this.objectIdSet||
this.objectIdSet.has(b.getId())){this.numObjectsTested++;for(var d=b.getId(),a=b.getGeometryRecords(),f=b.getObjectTransformation(),c=0;c<a.length;c++){var e=a[c].geometry,k=e.getId(),l=a[c].materials;g.set(f,m);g.multiply(m,a[c].transformation);g.inverse(m,this.invertedM);g.multiplyVec3(this.invertedM,this.p0,r);g.multiplyVec3(this.invertedM,this.p1,s);for(var n=0,p=e.getNumGroups();n<p;++n)l[n].intersect(e,n,m,this.point,this.p0,this.p1,r,s,this.camera,this.tolerance,function(a,c,f,e,g){if(0<=a)if(g)g=
new h,g.set(b,d,a,c,e,b.getCenter(),k,f),this.hudResults.push(g);else{if(void 0===this.minResult.priority||e>=this.minResult.priority)(void 0===this.minResult.dist||a<this.minResult.dist)&&this.minResult.set(b,d,a,c,e,null,k,f);if(void 0===this.maxResult.priority||e>=this.maxResult.priority)(void 0===this.maxResult.dist||a>this.maxResult.dist)&&this.maxResult.set(b,d,a,c,e,null,k,f)}}.bind(this),this.isSelection)}}};c.prototype.getMinResult=function(){return this.minResult};c.prototype.getMaxResult=
function(){return this.maxResult};c.prototype.getHudResults=function(){return this.hudResults};c.DEFAULT_TOLERANCE=1E-5;return c});