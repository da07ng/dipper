// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/editTracking",["dijit","dojo","dojox","dojo/require!arcgisonline/map/main"],function(q,f,r){f.provide("arcgisonline.map.editTracking");f.require("arcgisonline.map.main");arcgisonline.map.editTracking={hour:36E5,day:864E5,week:6048E5,month:2592E6,year:31104E6,maxFeatureCount:3E4,hasEditTracking:function(a){if(a.layer&&a.layer.supportsAdvancedQueries&&!(10.1<=a.layer.version&&a.layer.isDataVersioned)&&a.serviceInfo){var c=a.serviceInfo.editFieldsInfo;if(c&&(c.creationDateField&&
c.creatorField||c.editDateField&&c.editorField)||c&&(c.creatorField||c.editorField)&&!arcgisonline.sharing.util.isHostedService(a.url))return!0}return!1},setDefinitionExpression:function(a,c,e){var b,f,k,h;if(a.serviceInfo&&a.serviceInfo.editFieldsInfo){b=a.serviceInfo.editFieldsInfo.creatorField;f=a.serviceInfo.editFieldsInfo.creationDateField;k=a.serviceInfo.editFieldsInfo.editorField;h=a.serviceInfo.editFieldsInfo.editDateField;var d="";a.layerDefinition&&a.layerDefinition.definitionExpression&&
(d=a.layerDefinition.definitionExpression,d=d.length?"("+d+")":"");a.editTrackingFilter={};var l=arcgisonline.sharing.util.isHostedService(a.url);if(c&&c!==esri.i18nBundle.tocPanel.everyone){var g=b&&(f||!l),l=k&&(h||!l),d=d+(d.length?" AND (":"(");g&&l?d+=b+" \x3d '"+c+"' OR "+k+" \x3d '"+c+"'":g?d+=b+" \x3d '"+c+"'":l&&(d+=k+" \x3d '"+c+"'");d+=")";a.editTrackingFilter.user=c}e&&e!==esri.i18nBundle.tocPanel.timeRangeAll&&(c=arcgisonline.map.editTracking.getFilterStandardizedTimeRangeOptions(e),
g=b&&f,l=k&&h,d+=d.length?" AND (":"(",g&&l?(d=d+"("+(f+c),d+=") OR (",d+=h+c,d+=")"):g?d+=f+c:l&&(d+=h+c),d+=")",a.editTrackingFilter.time=e);if(!d||0==d.length)d=void 0;a.layer.getDefinitionExpression()!==d&&a.layer.setDefinitionExpression(d)}},getFilterUTCTimeRangeOptions:function(a){var c=(new Date).getTime();return{min:a==esri.i18nBundle.tocPanel.timeRangeHour?c-arcgisonline.map.editTracking.hour:a==esri.i18nBundle.tocPanel.timeRangeDay?c-arcgisonline.map.editTracking.day:a==esri.i18nBundle.tocPanel.timeRangeWeek?
c-arcgisonline.map.editTracking.week:a==esri.i18nBundle.tocPanel.timeRangeMonth?c-arcgisonline.map.editTracking.month:a==esri.i18nBundle.tocPanel.timeRange3Month?c-3*arcgisonline.map.editTracking.month:a==esri.i18nBundle.tocPanel.timeRange6Month?c-6*arcgisonline.map.editTracking.month:a==esri.i18nBundle.tocPanel.timeRange9Month?c-9*arcgisonline.map.editTracking.month:a==esri.i18nBundle.tocPanel.timeRangeYear?c-arcgisonline.map.editTracking.year:c-20*arcgisonline.map.editTracking.year,max:c}},getFilterStandardizedTimeRangeOptions:function(a){a=
arcgisonline.map.editTracking.getFilterUTCTimeRangeOptions(a);return" BETWEEN '"+arcgisonline.map.editTracking.formatDate(new Date(a.min))+"' AND '"+arcgisonline.map.editTracking.formatDate(new Date(a.max))+"'"},formatDate:function(a){a=new Date(a);return""+a.getUTCFullYear()+"-"+f.number.format(a.getUTCMonth()+1,{pattern:"00"})+"-"+f.number.format(a.getUTCDate(),{pattern:"00"})+" "+f.number.format(a.getUTCHours(),{pattern:"00"})+":"+f.number.format(a.getUTCMinutes(),{pattern:"00"})+":"+f.number.format(a.getSeconds(),
{pattern:"00"})},filterTimeRangeOptions:function(a,c,e){if(c&&e){var b=(new Date).getTime();e>=b-arcgisonline.map.editTracking.hour&&a.newItem({name:esri.i18nBundle.tocPanel.timeRangeHour});c<=b-arcgisonline.map.editTracking.hour&&e>=b-arcgisonline.map.editTracking.day&&a.newItem({name:esri.i18nBundle.tocPanel.timeRangeDay});c<=b-arcgisonline.map.editTracking.day&&e>=b-arcgisonline.map.editTracking.week&&a.newItem({name:esri.i18nBundle.tocPanel.timeRangeWeek});c<=b-arcgisonline.map.editTracking.week&&
e>=b-arcgisonline.map.editTracking.month&&a.newItem({name:esri.i18nBundle.tocPanel.timeRangeMonth});c<=b-arcgisonline.map.editTracking.month&&e>=b-3*arcgisonline.map.editTracking.month&&a.newItem({name:esri.i18nBundle.tocPanel.timeRange3Month});c<=b-3*arcgisonline.map.editTracking.month&&e>=b-6*arcgisonline.map.editTracking.month&&a.newItem({name:esri.i18nBundle.tocPanel.timeRange6Month});c<=b-6*arcgisonline.map.editTracking.month&&e>=b-9*arcgisonline.map.editTracking.month&&a.newItem({name:esri.i18nBundle.tocPanel.timeRange9Month});
c<=b-9*arcgisonline.map.editTracking.month&&e>=b-arcgisonline.map.editTracking.year&&a.newItem({name:esri.i18nBundle.tocPanel.timeRangeYear});c<=b-arcgisonline.map.editTracking.year&&e>=b-2*arcgisonline.map.editTracking.year&&a.newItem({name:f.string.substitute(esri.i18nBundle.tocPanel.timeRangeXYear,{count:Math.round((b-e)/arcgisonline.map.editTracking.year+0.5)})})}return a},getFeatureCount:function(a,c){var e=new esri.tasks.QueryTask(a.layer.url),b=new esri.tasks.Query;b.returnGeometry=!1;b.where=
"1\x3d1";e.executeForCount(b,f.hitch(this,function(b){a.featureCount=b;c()}),f.hitch(this,function(){a.featureCount=-1}))},filterEditsQuery:function(a,c){var e,b,n,k;if(a.serviceInfo&&a.serviceInfo.editFieldsInfo){e=a.serviceInfo.editFieldsInfo.creatorField;b=a.serviceInfo.editFieldsInfo.creationDateField;n=a.serviceInfo.editFieldsInfo.editorField;k=a.serviceInfo.editFieldsInfo.editDateField;var h=function(b){if(b){a.trackedEdits=a.trackedEdits||{};a.trackedEdits.created=b;var e,g;f.forEach(b.features,
function(a){a.attributes.MinCreateDate&&(e=Math.min(e||Number.MAX_VALUE,a.attributes.MinCreateDate));a.attributes.MaxCreateDate&&(g=Math.max(g||-1*Number.MAX_VALUE,a.attributes.MaxCreateDate))});a.trackedEdits.all={attributes:{MinCreateDate:e,MaxCreateDate:g}}}if(n&&(k||!arcgisonline.sharing.util.isHostedService(a.url))){b=new esri.tasks.Query;b.outFields=[n];b.groupByFieldsForStatistics=[n];if(k){var m=new esri.tasks.StatisticDefinition;m.statisticType="min";m.onStatisticField=k;m.outStatisticFieldName=
"MinEditedDate";var h=new esri.tasks.StatisticDefinition;h.statisticType="max";h.onStatisticField=k;h.outStatisticFieldName="MaxEditedDate";b.outStatistics=[m,h]}else m=new esri.tasks.StatisticDefinition,m.statisticType="min",m.onStatisticField="OBJECTID",m.outStatisticFieldName="MinObjectId",b.outStatistics=[m];(new esri.tasks.QueryTask(a.layer.url)).execute(b,f.hitch(this,d),f.hitch(this,l))}else c()},d=function(b){a.trackedEdits=a.trackedEdits||{};a.trackedEdits.edited=b;var d,e;f.forEach(b.features,
function(a){a.attributes.MinEditedDate&&(d=Math.min(d||Number.MAX_VALUE,a.attributes.MinEditedDate));a.attributes.MaxEditedDate&&(e=Math.max(e||-1*Number.MAX_VALUE,a.attributes.MaxEditedDate))});a.trackedEdits.all||(a.trackedEdits.all={attributes:{}});f.mixin(a.trackedEdits.all.attributes,{MinEditedDate:d,MaxEditedDate:e});c()},l=function(){};if(e&&(b||!arcgisonline.sharing.util.isHostedService(a.url))){var g=new esri.tasks.Query;g.returnGeometry=!1;g.outFields=[e];g.groupByFieldsForStatistics=[e];
if(b){e=new esri.tasks.StatisticDefinition;e.statisticType="min";e.onStatisticField=b;e.outStatisticFieldName="MinCreateDate";var p=new esri.tasks.StatisticDefinition;p.statisticType="max";p.onStatisticField=b;p.outStatisticFieldName="MaxCreateDate";g.outStatistics=[e,p]}else b=new esri.tasks.StatisticDefinition,b.statisticType="min",b.onStatisticField="OBJECTID",b.outStatisticFieldName="MinObjectId",g.outStatistics=[b];(new esri.tasks.QueryTask(a.layer.url)).execute(g,f.hitch(this,h),f.hitch(this,
l))}else h()}}}});