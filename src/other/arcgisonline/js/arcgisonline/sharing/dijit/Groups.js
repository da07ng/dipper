// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/Groups",["dijit","dojo","dojox","dojo/require!dojox/grid/DataGrid,dijit/Toolbar,dijit/form/Button,dijit/form/TextBox,dijit/_Widget,dijit/_Templated,arcgisonline/sharing/util,arcgisonline/sharing/dijit/views,arcgisonline/sharing/geow/Account,arcgisonline/sharing/geow/Group,arcgisonline/sharing/dijit/dialog/GeneralDlg,arcgisonline/sharing/dijit/dialog/InvitationsDlg,arcgisonline/sharing/dijit/dialog/MembershipRequestsDlg,arcgisonline/sharing/geow/Community,arcgisonline/sharing/dijit/GroupSelector"],
function(f,a,l){a.provide("arcgisonline.sharing.dijit.Groups");a.require("dojox.grid.DataGrid");a.require("dijit.Toolbar");a.require("dijit.form.Button");a.require("dijit.form.TextBox");a.require("dijit._Widget");a.require("dijit._Templated");a.require("arcgisonline.sharing.util");a.require("arcgisonline.sharing.dijit.views");a.require("arcgisonline.sharing.geow.Account");a.require("arcgisonline.sharing.geow.Group");a.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");a.require("arcgisonline.sharing.dijit.dialog.InvitationsDlg");
a.require("arcgisonline.sharing.dijit.dialog.MembershipRequestsDlg");a.require("arcgisonline.sharing.geow.Community");a.require("arcgisonline.sharing.dijit.GroupSelector");a.declare("arcgisonline.sharing.dijit.Groups",[f._Widget,f._Templated],{views:arcgisonline.sharing.dijit.views,util:arcgisonline.sharing.util,group:arcgisonline.sharing.geow.Group,groupDlg:arcgisonline.sharing.dijit.dialog.GroupDlg,community:arcgisonline.sharing.geow.Community,account:arcgisonline.sharing.geow.Account,selectGroups:arcgisonline.sharing.dijit.GroupSelector,
invitations:null,widgetsInTemplate:!0,templateString:'\x3cdiv dojotype\x3d"dijit.layout.ContentPane" region\x3d"top"\x3e\r\n  \x3cdiv\x3e\r\n    \x3cspan id\x3d"createGroupDiv"\x3e\r\n      \x3cbutton dojotype\x3d"dijit.form.Button" type\x3d"button" class\x3d"create-group-button calcite transparent" iconClass\x3d"calcite transparent esriCreateGroupIcon" dojoAttachEvent\x3d"onClick: createGroup"\x3e${i18n.createAGroup}\x3c/button\x3e\r\n    \x3c/span\x3e\r\n    \x3cspan id\x3d"invitationsDiv" style\x3d"display:none;"\x3e\r\n      \x3cbutton dojotype\x3d"dijit.form.Button" type\x3d"button" id\x3d"invitations-group-button" class\x3d"calcite transparent invitations-group-button calcite transparent" iconClass\x3d"esriMembershipRequestIcon" dojoAttachEvent\x3d"onClick: viewInvitations"\x3e${i18n.invitations}\x3c/button\x3e\r\n    \x3c/span\x3e\r\n    \x3cbutton dojotype\x3d"dijit.form.Button" type\x3d"button" style\x3d"display:none;" id\x3d"addto-groups-button" class\x3d"calcite transparent addto-groups-button calcite transparent" iconClass\x3d"esriJoinGroupIcon" dojoattachpoint\x3d"_addToGroups" dojoAttachEvent\x3d"onClick: addToGroups"\x3e${i18n.addToGroups}\x3c/button\x3e\r\n  \x3c/div\x3e\r\n  \x3cdiv style\x3d"clear:both; width: 100%;"\x3e\r\n    \x3cdiv dojoType\x3d"dijit.layout.ContentPane" class\x3d"filters groupsFilterPane" dojoAttachPoint\x3d"_filtersPane"\x3e\r\n      \x3cspan class\x3d"section"\x3e${i18n.show}\x3c/span\x3e\r\n      \x3cdiv class\x3d"set" root\x3d"true"\x3e\r\n        \x3cdiv\x3e\x3ca href\x3d"#" class\x3d"item selected dijitInline" name\x3d"none" dojoAttachEvent\x3d"onclick:filterClick" id\x3d"allMyGroups"\x3e${i18n.allMyGroups}\x3c/a\x3e\x3c/div\x3e\r\n        \x3cdiv\x3e\x3ca href\x3d"#" class\x3d"item dijitInline" name\x3d"filter_myGroups" dojoAttachEvent\x3d"onclick:filterClick" id\x3d"ownedByMe"\x3e${i18n.ownedByMe}\x3c/a\x3e\x3c/div\x3e\r\n        \x3cdiv\x3e\x3ca href\x3d"#" class\x3d"item dijitInline" name\x3d"filter_othersGroups" dojoAttachEvent\x3d"onclick:filterClick"\x3e${i18n.ownedByOthers}\x3c/a\x3e\x3c/div\x3e\r\n        \x3cdiv\x3e\x3ca href\x3d"#" class\x3d"item dijitInline" name\x3d"filter_newRequestGroups" dojoAttachEvent\x3d"onclick:filterClick"\x3e${i18n.newMemberRequests}\x3c/a\x3e\x3c/div\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv dojoType\x3d"dijit.layout.ContentPane" class\x3d"groupsPane"\x3e\r\n      \x3cspan class\x3d"section" dojoAttachPoint\x3d"_groupsPaneLabel"\x3e\x26nbsp;\x3c/span\x3e\r\n      \x3cdiv dojoType\x3d"dijit.layout.ContentPane" dojoAttachPoint\x3d"_groupsPane" style\x3d"padding: 10px; margin-top:10px;"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"groupsMorePane"\x3e\r\n      \x3cspan class\x3d"section" id\x3d"featuredGroupsTitle"\x3e${i18n.moreGroups}\x3c/span\x3e\r\n      \x3cdiv class\x3d"esriItemLinks" style\x3d"margin-top:20px 0.8em 1em 0.8em;" id\x3d"featuredGroups"\x3e\r\n        \x3cspan class\x3d"note esriItemLinks" id\x3d"publicGroupsLinkSpan"\x3e\x3ca href\x3d"search.html?t\x3dgroups\x26q\x3dispublic:true" id\x3d"publicGroupsLink"\x3e${i18n.listAllGroups}\x3c/a\x3e\x3c/span\x3e\r\n        \x3cdiv id\x3d"moreGroups-featuredGroups"\x3e\x3c/div\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv style\x3d"clear:both; width:100%;"\x3e\x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e\r\n',
_groups:null,_groupsPane:null,_groupsPaneLabel:null,_user:null,_groupCheckBoxes:null,_organization:null,_isAdmin:!1,_groupsUser:null,includeGroup:null,i18n:null,postMixInProperties:function(){this.inherited(arguments);this.i18n=a.mixin({},a.i18n.getLocalization("arcgisonline","arcgisonline").common);a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").GroupWidget);a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").GroupsWidget)},postCreate:function(){this.inherited(arguments);
this.loadConnections();this._user=this.util.getUser();this.account.getSelf(a.hitch(this,function(b){esriGeowConfig.featuredGroups=b.featuredGroups;if(this._user&&this._user.accountId)this._user.role&&"account_admin"===this._user.role&&(this._isAdmin=!0),this.handleGetAccount(b);else if(this._user){if(esriGeowConfig.featuredGroups){var d=a.byId("moreGroups-featuredGroups");a.forEach(esriGeowConfig.featuredGroups,function(b){b=b.id?'\x3cspan class\x3d"note esriItemLinks"\x3e\x3ca href\x3d"group.html?groupid\x3did:'+
b.id+'"\x3e'+b.title+"\x3c/a\x3e\x3c/span\x3e":'\x3cspan class\x3d"note esriItemLinks"\x3e\x3ca href\x3d"group.html?owner\x3d'+b.owner+"\x26title\x3d"+encodeURIComponent(b.title)+'"\x3e'+b.title+"\x3c/a\x3e\x3c/span\x3e";a.place(b,d)})}this.initialize()}}))},initialize:function(){this.refreshGroups();this.getInvitations()},handleGetAccount:function(b,d){if(b&&b.id&&b.id===this._user.accountId){this._organization=b;this._isPortal=this.util.isPortal();this._roleCanView=(this._isCustomRole=esriGeowConfig.userRole.isCustom())&&
esriGeowConfig.userRole.canViewOrgGroups();this._roleCanDelete=this._isCustomRole&&esriGeowConfig.userRole.canDeleteOrgGroups();this._roleCanCreate=this._isCustomRole&&esriGeowConfig.userRole.canCreateGroup();this._roleCanAssign=this._isCustomRole&&esriGeowConfig.userRole.canAssignUsersToOrgGroups();a.byId("featuredGroupsTitle").innerHTML=this.i18n.findLabel;if(void 0===esriGeowConfig.isMultiTenant||!0===esriGeowConfig.isMultiTenant)a.byId("publicGroupsLink").href="search.html?t\x3dgroups\x26hideq\x3dtrue\x26q\x3dorgid:"+
this._organization.id+" access:public",a.byId("publicGroupsLink").innerHTML=this.i18n.orgGroupsPublic,a.place('\x3cspan class\x3d"note esriItemLinks"\x3e\x3ca href\x3d"search.html?q\x3dorgid:'+this._organization.id+'\x26t\x3dgroups\x26hideq\x3dtrue"\x3e'+this.i18n.orgGroups+"\x3c/a\x3e\x3c/span\x3e",a.byId("moreGroups-featuredGroups").parentNode,"first"),this._organization.portalProperties&&(this._organization.portalProperties.openData&&this._organization.portalProperties.openData.enabled)&&a.place('\x3cspan class\x3d"note esriItemLinks"\x3e\x3ca href\x3d"search.html?q\x3dorgid:'+
this._organization.id+' isopendata:true\x26t\x3dgroups\x26hideq\x3dtrue"\x3e'+this.i18n.orgGroupsOpenData+"\x3c/a\x3e\x3c/span\x3e",a.byId("publicGroupsLinkSpan"),"after");if(esriGeowConfig.featuredGroups){var c=a.byId("moreGroups-featuredGroups");c.innerHTML="";a.create("span",{innerHTML:this.i18n.featuredGroups,"class":"section"},c);var e=a.create("div",null,c);a.forEach(esriGeowConfig.featuredGroups,function(b){b=b.id?'\x3cspan class\x3d"note esriItemLinks"\x3e\x3ca href\x3d"group.html?groupid\x3did:'+
b.id+'"\x3e'+b.title+"\x3c/a\x3e\x3c/span\x3e":'\x3cspan class\x3d"note esriItemLinks"\x3e\x3ca href\x3d"group.html?owner\x3d'+b.owner+"\x26title\x3d"+encodeURIComponent(b.title)+'"\x3e'+b.title+"\x3c/a\x3e\x3c/span\x3e";a.place(b,e)});7<esriGeowConfig.featuredGroups.length&&a.addClass(e,"featuredGroupsLinks")}else a.byId("moreGroups-featuredGroups").innerHTML="";(c=a.queryToObject(window.location.search.slice(1)).user)?this.community.getProfile(c,a.hitch(this,this.handleGetGroupsUser),a.hitch(this.handleGetGroupsUser)):
(c="",this._organization.thumbnail&&0<this._organization.thumbnail.length&&(c+='\x3cimg src\x3d"'+this.getOrganizationThumbnailUrl(this._organization)+'" align\x3d"center" class\x3d"groupThumbnail"/\x3e '),a.byId("groupsTitle2").innerHTML=c+this.i18n.myGroups+"",this._isCustomRole&&!this._roleCanCreate&&a.style(a.byId("createGroupDiv"),"display","none"),this._isAdmin=!1,this.initialize())}else this._isAdmin=!1,this.initialize()},handleGetGroupsUser:function(b,d){if(b&&b.username&&b.orgId&&this._user.accountId===
b.orgId&&this._user.email!==b.username){this._groupsUser=b;var c="";this._organization.thumbnail&&0<this._organization.thumbnail.length&&(c+='\x3cimg src\x3d"'+this.getOrganizationThumbnailUrl(this._organization)+'" align\x3d"center" class\x3d"groupThumbnail"/\x3e ');a.byId("groupsTitle2").innerHTML=c+this._groupsUser.fullName+this.i18n.groupsLabel+"";a.byId("allMyGroups").innerHTML=this.i18n.allUserGroups;a.byId("ownedByMe").innerHTML=this.i18n.ownedByUser;a.style(a.byId("createGroupDiv"),"display",
"none");!this._isCustomRole||this._roleCanAssignToGroups?a.style(this._addToGroups.domNode,"display","inline-block"):a.style(this._addToGroups.domNode,"display","none")}else this._isAdmin=!1;this.initialize()},getOrganizationThumbnailUrl:function(b){var a=this.util.getToken();return esriGeowConfig.restBaseUrl+"portals/self/resources/"+b.thumbnail+(a?"?token\x3d"+a:"")},createGroup:function(){window.location.href="group.html"},deleteGroup:function(b){arcgisonline.sharing.dijit.dialog.DeleteWarningDlg.prototype.statics.getInstance().show(1,
this.i18n.groupTitle,a.hitch(this,"reallyDeleteGroup",b))},reallyDeleteGroup:function(b){"owner"===b.userMembership.memberType||this._isAdmin||this._roleCanDelete?this.community.deleteGroup(b,a.hitch(this,"refreshGroups"),a.hitch(this,function(a){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.errorTitle,message:this.i18n.removeItemsBeforeDelete})})):(b=b.title,arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.deleteGroup,
message:a.string.substitute(this.i18n.deleteMsg,{title:b})}))},leaveGroup:function(b){this.community.leaveGroup(b,a.hitch(this,"refreshGroups"))},confirmLeaveGroup:function(b){arcgisonline.sharing.dijit.dialog.DeleteWarningDlg.prototype.statics.getInstance().showMsgTitleButton(this.i18n.leaveGrpMsg,this.i18n.leaveGrp,this.i18n.leaveGrp,a.hitch(this,this.leaveGroup,b))},refreshGroups:function(){this._groups=[];this._groupCheckBoxes=[];a.empty(this._groupsPane.domNode);this._isAdmin||this._roleCanView&&
this._groupsUser?this.community.getUserGroupsByUser(this._groupsUser.username,a.hitch(this,this._handleGetUserGroups)):this.community.getUserGroups(a.hitch(this,this._handleGetUserGroups))},loadGroups:function(){this.sortField="title";this._groups.sort(a.hitch(this,this._sortFunc));a.forEach(this._groups,function(b){var d={showThumb:!0,showProfilePopup:!0};if((this._isAdmin||this._roleCanView)&&b.owner!==this._user.email&&this._groupsUser&&b.owner!==this._groupsUser.username)d.groupsUser=this._groupsUser;
d=this.views.group.medium(b,d);a.create("div");var c=(!0===this._isAdmin||this._roleCanDelete)&&this._groupsUser&&b.owner===this._groupsUser.username,e="owner"===b.userMembership.memberType||c;!this._hasSharedOwnershipGroup&&e&&a.forEach(b.capabilities||[],a.hitch(this,function(b){b&&"updateitemcontrol"===b.toLowerCase()&&(this._hasSharedOwnershipGroup=!0,a.place('\x3cspan class\x3d"note esriItemLinks"\x3e\x3ca href\x3d"search.html?q\x3dorgid:'+this._organization.id+' capabilities:updateItemControl\x26t\x3dgroups\x26hideq\x3dtrue"\x3e'+
this.i18n.orgGroupsSharedOwnership+"\x3c/a\x3e\x3c/span\x3e",a.byId("publicGroupsLinkSpan"),"after"))}));var g=a.create("span"),e=e?this.i18n.deleteGroup:this.i18n.leaveGroup,e=new f.form.Button({iconClass:"owner"===b.userMembership.memberType?"esriDeleteGroupIcon":"esriLeaveGroupIcon","class":"calcite transparent",groupObject:b,isAdmin:c,groupsUser:this._groupsUser,title:e,alt:e,onClick:a.hitch(this,this._handleButtonClick)});if(c||!this._isCustomRole||this._roleCanCreate)(!this._isPortal||!("owner"!==
b.userMembership.memberType&&b.provider&&b.providerGroupName))&&e.placeAt(g);b.userMembership.applications&&0<b.userMembership.applications&&(e=new f.form.Button({iconClass:"esriMembershipRequestIcon","class":"calcite transparent",alt:this.i18n.newMembRequests,title:this.i18n.newMembRequests,groupObject:b,onClick:a.hitch(this,this._handleMemberRequestsButtonClick)}),(!this._isCustomRole||this._roleCanCreate)&&e.placeAt(g));a.place(d,this._groupsPane.domNode);a.place(g,a.query(".itemTextContainer",
d)[0])},this)},_handleMemberRequestsButtonClick:function(b){b=f.getEnclosingWidget(b.currentTarget);var a=arcgisonline.sharing.dijit.dialog.MembershipRequestsDlg.prototype.statics.getInstance();a&&a.show(b.groupObject.id)},_handleButtonClick:function(b){b=f.getEnclosingWidget(b.currentTarget);"owner"===b.groupObject.userMembership.memberType||!0===b.isAdmin&&b.groupObject.owner===b.groupsUser.username?this.deleteGroup(b.groupObject):(this._isAdmin||this._roleCanAssign)&&b.groupsUser&&this._user.username!==
b.groupsUser.username&&"owner"!==b.groupObject.userMembership.memberType&&b.groupObject.owner!==b.groupsUser.username?(a.subscribe("onGroupLeave",a.hitch(this,this.refreshGroups)),this.group.removeFromGroup(b.groupObject.id,b.groupsUser.username)):this.confirmLeaveGroup(b.groupObject)},_handleGetUserGroups:function(b){if(b&&b.groups){this._groups=null===this.includeGroup?b.groups:a.filter(b.groups,a.hitch(this,this.includeGroup));b=a.string.substitute(this.i18n.memberOfMsg,{length:this._groups.length});
if(!0!==this._isAdmin&&(!this._isCustomRole||!this._roleCanView)&&1!==this._groups.length)b=a.string.substitute(this.i18n.memberOfGroups,{length:this._groups.length});if((!0===this._isAdmin||this._roleCanView&&this._groupsUser)&&1===this._groups.length)b=a.string.substitute(this.i18n.userMemberOf,{username:this._groupsUser.username,length:this._groups.length});if((!0===this._isAdmin||this._roleCanView&&this._groupsUser)&&1!==this._groups.length)b=a.string.substitute(this.i18n.userMemberOfGroups,{username:this._groupsUser.username,
length:this._groups.length});a.attr(this._groupsPaneLabel,"innerHTML",b);this.loadGroups()}},filter_allGroups:function(a){return!0},filter_myGroups:function(a){if((!0===this._isAdmin||this._roleCanView)&&this._groupsUser){if(a.owner===this._groupsUser.username)return!0}else if(a.owner===this._user.email)return!0;return!1},filter_othersGroups:function(a){return!this.filter_myGroups(a)},filter_newRequestGroups:function(a){return a.userMembership.applications&&0<a.userMembership.applications?!0:!1},
filterClick:function(b){b.preventDefault();a.query(".set .item").removeClass("selected");b.currentTarget.name&&(this.includeGroup="none"===b.currentTarget.name?null:this[b.currentTarget.name]);this.refreshGroups();a.addClass(b.currentTarget,"selected")},getInvitations:function(){var b=function(b,d){for(var g=[],k=0,h=0;h<b.userInvitations.length;h++)"group"===b.userInvitations[h].targetType&&(k++,g.push(b.userInvitations[h]));a.byId("invitations-group-button_label").innerHTML=a.string.substitute(this.i18n.invitationsMsg,
{count:k});0<k?a.style(a.byId("invitationsDiv"),"display","inline-block"):a.style(a.byId("invitationsDiv"),"display","none");this.invitations=g;f.byId("invitations-dialog")&&f.byId("invitations-dialog").open&&arcgisonline.sharing.dijit.dialog.InvitationsDlg.prototype.statics.getInstance().update(this.invitations)},d=this.util.getUser();if(null!=d){d=d.email;if(!0===this._isAdmin||this._roleCanView&&this._groupsUser)d=this._groupsUser.username;this.util.getJson(esriGeowConfig.restBaseUrl+"community/users/"+
d+"/invitations",a.hitch(this,b))}},viewInvitations:function(){var a=arcgisonline.sharing.dijit.dialog.InvitationsDlg.prototype.statics.getInstance();!0===this._isAdmin||this._roleCanView?a.show(this.invitations,this._groupsUser):a.show(this.invitations)},addToGroups:function(){var b=document.createDocumentFragment();a.create("div",{innerHTML:this.i18n.selectGroups},b);var d=new this.selectGroups({},a.create("div",{},b)),c=a.create("div",{style:{"float":"right",margin:"0.5em 0 0.5em 0"}},b),e=new f.form.Button({label:this.i18n.addToGroups,
type:"button","class":"primary"},a.create("button",{},c)),g=a.connect(e,"onClick",a.hitch(this,function(){a.disconnect(g);var b=d.get("value");this._groupsDialog.hide();b=a.map(b,a.hitch(this,function(a){return this._addToGroup(a.id)}));return(new a.DeferredList(b)).then(a.hitch(this,"refreshGroups"))})),c=new f.form.Button({label:this.i18n.cancel,type:"button","class":"calcite transparent"},a.create("button",{},c)),k=a.connect(c,"onClick",a.hitch(this,function(){a.disconnect(k);this._groupsDialog.hide()}));
this._groupsDialog=(new f.Dialog).placeAt(document.body);this._groupsDialog.set({title:this.i18n.addToGroups,style:{width:"600px"},content:b});d.set("selectedGroupsLabel",a.i18n.getLocalization("arcgisonline","arcgisonline").selectGroups.addToTheseGroups);this._groupsDialog.show();var h=a.connect(this._groupsDialog,"onHide",a.hitch(this,function(){a.disconnect(h);this._groupsDialog.destroyRecursive();this._groupsDialog=null}))},_addToGroup:function(a){return arcgisonline.sharing.util.postJson({users:this._groupsUser.username},
esriGeowConfig.restBaseUrl+"community/groups/"+a+"/addUsers")},onInvitationAccept:function(){this.refreshGroups();1==this.invitations.length?a.style(a.byId("invitationsDiv"),"display","none"):this.getInvitations()},onInvitationDecline:function(){1==this.invitations.length?a.style(a.byId("invitationsDiv"),"display","none"):this.getInvitations()},loadConnections:function(){a.subscribe("onInvitationAccept",this,"onInvitationAccept");a.subscribe("onInvitationDecline",this,"onInvitationDecline");a.subscribe("refreshGroups",
this,"refreshGroups")},_errorMessage:function(a){this.util.globalMessage(a,"error",5E3)},_sortFunc:function(a,d){var c=a[this.sortField].toLowerCase(),e=d[this.sortField].toLowerCase();return null==c||null==e||c==e?0:c<e?-1:1}})});