// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/table",["dijit","dojo","dojox","dojo/i18n!esri/nls/jsapi","dojo/require!arcgisonline/map/main,dgrid/OnDemandGrid,dgrid/Selection,dgrid/Keyboard,dgrid/OnDemandList,dgrid/extensions/ColumnResizer,dgrid/extensions/ColumnReorder,dgrid/extensions/ColumnHider,dgrid/editor,dojo/store/Cache,dojo/store/Memory,dojo/query,arcgisonline/sharing/dijit/FeatureLayerQueryStore,arcgisonline/sharing/dijit/dialog/TableStatisticsDlg,arcgisonline/sharing/dijit/dialog/TableCalcFieldDlg,arcgisonline/sharing/dijit/dialog/TableAddFieldDlg,arcgisonline/sharing/dijit/dialog/DeleteWarningDlg"],
function(l,e,x){e.provide("arcgisonline.map.table");e.require("arcgisonline.map.main");e.require("dgrid.OnDemandGrid");e.require("dgrid.Selection");e.require("dgrid.Keyboard");e.require("dgrid.OnDemandList");e.require("dgrid.extensions.ColumnResizer");e.require("dgrid.extensions.ColumnReorder");e.require("dgrid.extensions.ColumnHider");e.require("dgrid.editor");e.require("dojo.store.Cache");e.require("dojo.store.Memory");e.require("dojo.query");e.require("arcgisonline.sharing.dijit.FeatureLayerQueryStore");
e.require("arcgisonline.sharing.dijit.dialog.TableStatisticsDlg");e.require("arcgisonline.sharing.dijit.dialog.TableCalcFieldDlg");e.require("arcgisonline.sharing.dijit.dialog.TableAddFieldDlg");e.require("arcgisonline.sharing.dijit.dialog.DeleteWarningDlg");e.requireLocalization("esri","jsapi");arcgisonline.map.table={grid:null,store:null,openTableMapLayerId:null,openTableMapLayerSubId:null,storedInfo:{},batchCount:25,maxLayerFeatureCountForPaging:5E4,pointSelectionSymbol:null,lineSelectionSymbol:null,
fillSelectionSymbol:null,infoWindowHandler:null,leftPanelResizeHandler:null,onClickHandler:null,waitDlg:null,refreshTablePrep:function(a,b,c){if(arcgisonline.map.featColl.isFeatureCollection(a)||a.layer instanceof esri.layers.CSVLayer)if(a.layer)arcgisonline.map.table.refreshTable(a,-1,c);else{var d=a.layers;a.tables&&(d=d.concat(a.tables));arcgisonline.map.table.refreshTable(a,d[b].id,c)}else a.layer instanceof esri.layers.GeoRSSLayer?arcgisonline.map.table.refreshTable(a,a.layer.getFeatureLayers()[-1==
b?0:b].id,c):a.layer instanceof esri.layers.FeatureLayer||this._isImageServiceLayer(a.layer)?arcgisonline.map.table.refreshTable(a,null,c):(b=(arcgisonline.map.main.hasDynamicLayers(a),a.layer.layerInfos[b]),arcgisonline.map.table.refreshTable(a,b.id,c))},refreshTable:function(a,b,c,d){-1===b&&(b=null);esri.isDefined(b)&&a.layer instanceof esri.layers.FeatureLayer&&(b=null);var e=arcgisonline.map.table.getInfo(a,b);e&&(arcgisonline.map.table.clearSelection(a,b),arcgisonline.map.table.removeShowSelectedRecordsOnly(a,
b),e.fLayer.setSelectionSymbol());"popup"==c&&arcgisonline.map.table.removeInfoColumns(a,b);if("edit"==c||"delete"==c||"add"==c)arcgisonline.map.table.removeInfo(a,b),"add"==c?arcgisonline.map.table.grid.__mapLayerInfo.addedField=d:"delete"==c&&(arcgisonline.map.table.grid.__mapLayerInfo.deletedField=d);arcgisonline.map.table.isTableVisible(a.id,b)&&("filter"==c&&arcgisonline.map.table.removeShowSelectedRecordsOnly(a,b),arcgisonline.map.table.showAttributeTable(a,b))},destroyTable:function(a,b){-1===
b&&(b=null);var c=arcgisonline.map.table.openTableMapLayerId,d=arcgisonline.map.table.openTableMapLayerSubId;!a&&c&&(a=arcgisonline.map.main.getParameterListById(arcgisonline.map.table.openTableMapLayerId),b=arcgisonline.map.table.openTableMapLayerSubId);if(a){arcgisonline.map.table.hideAttributeTable();var f=arcgisonline.map.table.getInfo(a,b);f&&(f.fLayer&&arcgisonline.map.main.map.removeLayer(f.fLayer),f.selLayer&&arcgisonline.map.main.map.removeLayer(f.selLayer));arcgisonline.map.table.storedInfo=
{};var g=e.subscribe("onMapFullyLoaded",function(){e.unsubscribe(g);if(c){var a=arcgisonline.map.main.getParameterListById(c);arcgisonline.map.table.showAttributeTable(a,d)}})}},showAttributeTable:function(a,b){-1===b&&(b=null);arcgisonline.map.table.showWait();if(a.id!==arcgisonline.map.table.openTableMapLayerId||esri.isDefined(b)&&b!==arcgisonline.map.table.openTableMapLayerSubId){var c=arcgisonline.map.main.getParameterListById(arcgisonline.map.table.openTableMapLayerId);arcgisonline.map.table.hideAttributeTable(c,
arcgisonline.map.table.openTableMapLayerSubId)}if(arcgisonline.map.featColl.isFeatureCollection(a)){arcgisonline.map.table.showAttributeTableUI(a,b);if(a.layer)if(c=arcgisonline.map.table.getInfo(a,b))arcgisonline.map.table.buildGrid(a,b,a.layer.graphics),arcgisonline.map.table.displayTitle(a.title,a,b),arcgisonline.map.table.addCountToTitle(c.count);else{var d=e.json.parse(a.layer._json);arcgisonline.map.table.saveCount(a,b,d.featureSet.features.length);var f=new esri.layers.FeatureLayer(d,{outFields:["*"]});
f.__tempTableLayer=!0;var g=function(a,b,c){c.setRenderer(new esri.renderer.SimpleRenderer((new esri.symbol.SimpleMarkerSymbol).setColor([0,0,0,0]).setOutline(null)));c.setScaleRange(a.layer.minScale,a.layer.maxScale);var f=e.connect(a.layer,"onScaleRangeChange",e.hitch(this,function(a,b){a.setScaleRange(b.minScale,b.maxScale)},c,a.layer));arcgisonline.map.main.map.addLayer(c);arcgisonline.map.table.saveFLayerInfo(a,b,c._json);arcgisonline.map.table.saveFLayer(a,b,c,f);arcgisonline.map.table.saveLayer(a,
b,a.layer);arcgisonline.map.table.saveIdsFieldName(a,b,c.objectIdField);arcgisonline.map.table.buildGrid(a,b,a.layer.graphics);arcgisonline.map.table.displayTitle(a.title,a,b);arcgisonline.map.table.addCountToTitle(d.featureSet.features.length)};f.loaded?g(a,b,f):e.connect(f,"onLoad",e.hitch(arcgisonline.map.table,function(a,b,c){g(a,b,c)},a,b))}else c=a.layers,a.tables&&(c=c.concat(a.tables)),e.forEach(c,function(c){if(c.id===b){var d=arcgisonline.map.table.getInfo(a,b);if(d)arcgisonline.map.table.buildGrid(a,
b,c.graphics),arcgisonline.map.table.displayTitle(a.title+" - "+c.name,a,b),arcgisonline.map.table.addCountToTitle(d.count);else{var f=e.json.parse(c._json);arcgisonline.map.table.saveCount(a,b,f.featureSet.features.length);var g=new esri.layers.FeatureLayer(f,{outFields:["*"]});g.__tempTableLayer=!0;var k=function(a,b,c,d){d.setRenderer(new esri.renderer.SimpleRenderer((new esri.symbol.SimpleMarkerSymbol).setColor([0,0,0,0]).setOutline(null)));d.setScaleRange(g.minScale,g.maxScale);var k=e.connect(c,
"onScaleRangeChange",e.hitch(this,function(a,b){a.setScaleRange(b.minScale,b.maxScale)},d,c));arcgisonline.map.main.map.addLayer(d);arcgisonline.map.table.saveFLayerInfo(a,b,d._json);arcgisonline.map.table.saveFLayer(a,b,d,k);arcgisonline.map.table.saveLayer(a,b,c);arcgisonline.map.table.saveIdsFieldName(a,b,d.objectIdField);arcgisonline.map.table.buildGrid(a,b,g.graphics);arcgisonline.map.table.displayTitle(a.title+" - "+d.name,a,b);arcgisonline.map.table.addCountToTitle(f.featureSet.features.length)};
g.loaded?k(a,b,c,g):e.connect(g,"onLoad",e.hitch(arcgisonline.map.table,function(a,b,d){k(a,b,c,d)},a,b))}}});arcgisonline.map.table.saveMode(a,b,"all")}else if(a.layer instanceof esri.layers.GeoRSSLayer)arcgisonline.map.table.showAttributeTableUI(a,b),c=a.layer.getFeatureLayers(),e.forEach(c,function(c){if(c.id===b){var d=arcgisonline.map.table.getInfo(a,b);if(d)arcgisonline.map.table.buildGrid(a,b,c.graphics),arcgisonline.map.table.displayTitle(a.title+" - "+c.name,a,b),arcgisonline.map.table.addCountToTitle(d.count);
else{var f=e.json.parse(c._json);arcgisonline.map.table.saveCount(a,b,f.featureSet.features.length);var g=new esri.layers.FeatureLayer(f,{outFields:["*"]});g.__tempTableLayer=!0;var k=function(a,b,c,d){d.name=d.name||c.name;d.setRenderer(new esri.renderer.SimpleRenderer((new esri.symbol.SimpleMarkerSymbol).setColor([0,0,0,0]).setOutline(null)));d.setScaleRange(g.minScale,g.maxScale);var k=e.connect(c,"onScaleRangeChange",e.hitch(this,function(a,b){a.setScaleRange(b.minScale,b.maxScale)},d,c));arcgisonline.map.main.map.addLayer(d);
arcgisonline.map.table.saveFLayerInfo(a,b,d._json);arcgisonline.map.table.saveFLayer(a,b,d,k);arcgisonline.map.table.saveLayer(a,b,c);arcgisonline.map.table.saveIdsFieldName(a,b,d.objectIdField);arcgisonline.map.table.buildGrid(a,b,g.graphics);arcgisonline.map.table.displayTitle(a.title+" - "+d.name,a,b);arcgisonline.map.table.addCountToTitle(f.featureSet.features.length)};g.loaded?k(a,b,c,g):e.connect(g,"onLoad",e.hitch(arcgisonline.map.table,function(a,b,d){k(a,b,c,d)},a,b))}}}),arcgisonline.map.table.saveMode(a,
b,"all");else if(a.layer instanceof esri.layers.CSVLayer){arcgisonline.map.table.showAttributeTableUI(a,b);if(c=arcgisonline.map.table.getInfo(a,b))arcgisonline.map.table.buildGrid(a,b,a.layer.graphics),arcgisonline.map.table.displayTitle(a.title,a,b),arcgisonline.map.table.addCountToTitle(c.count);else{var h=a.layer.toJson();arcgisonline.map.table.saveCount(a,b,h.featureSet.features.length);f=new esri.layers.FeatureLayer(h,{outFields:["*"]});f.__tempTableLayer=!0;g=function(a,b,c){c.setRenderer(new esri.renderer.SimpleRenderer((new esri.symbol.SimpleMarkerSymbol).setColor([0,
0,0,0]).setOutline(null)));c.setScaleRange(a.layer.minScale,a.layer.maxScale);var d=e.connect(a.layer,"onScaleRangeChange",e.hitch(this,function(a,b){a.setScaleRange(b.minScale,b.maxScale)},c,a.layer));arcgisonline.map.main.map.addLayer(c);arcgisonline.map.table.saveFLayerInfo(a,b,h);arcgisonline.map.table.saveFLayer(a,b,c,d);arcgisonline.map.table.saveLayer(a,b,a.layer);arcgisonline.map.table.saveIdsFieldName(a,b,c.objectIdField);arcgisonline.map.table.buildGrid(a,b,a.layer.graphics);arcgisonline.map.table.displayTitle(a.title,
a,b);arcgisonline.map.table.addCountToTitle(h.featureSet.features.length)};f.loaded?g(a,b,f):e.connect(f,"onLoad",e.hitch(arcgisonline.map.table,function(a,b,c){g(a,b,c)},a,b))}arcgisonline.map.table.saveMode(a,b,"all")}else if(a.layer instanceof esri.layers.FeatureLayer&&"Table"===a.layer.type){var k=(c=arcgisonline.map.table.getInfo(a,b))?c.where:"",m=arcgisonline.map.table.getWhereClause(a,b);c&&!arcgisonline.map.table.isWhereClauseSame(k,m)?(delete c.count,delete c.mode,delete c.ids,arcgisonline.map.table.displayTitle(a.title,
a,b),arcgisonline.map.table.getFeatureCount(a,b).then(e.hitch(arcgisonline.map.table,"getFeatures",a,b))):c?esri.isDefined(c.count)?(arcgisonline.map.table.displayTitle(a.title,a,b),arcgisonline.map.table.addCountToTitle(c.count,a),arcgisonline.map.table.getFeatures(a,b,c.count)):(arcgisonline.map.table.displayTitle(a.title,a,b),arcgisonline.map.table.getFeatureCount(a,b).then(e.hitch(arcgisonline.map.table,"getFeatures",a,b))):(arcgisonline.map.table.saveType(a,b,"Table"),arcgisonline.map.table.saveFLayer(a,
b,a.layer,null),arcgisonline.map.table.saveIdsFieldName(a,b,a.layer.objectIdField),arcgisonline.map.table.displayTitle(a.title,a,b),arcgisonline.map.table.getFeatureCount(a,b).then(e.hitch(arcgisonline.map.table,"getFeatures",a,b)))}else if(a.layer instanceof esri.layers.FeatureLayer||this._isImageServiceLayer(a.layer)){var k=(c=arcgisonline.map.table.getInfo(a,b))?c.where:"",m=arcgisonline.map.table.getWhereClause(a,b),t=this._isImageServiceLayer(a.layer);c&&!arcgisonline.map.table.isWhereClauseSame(k,
m)?(delete c.count,delete c.mode,delete c.ids,arcgisonline.map.table.displayTitle(a.title,a,b),arcgisonline.map.table.getFeatureCount(a,b).then(e.hitch(arcgisonline.map.table,"getFeatures",a,b))):c?esri.isDefined(c.count)?(arcgisonline.map.table.displayTitle(a.title,a,b),arcgisonline.map.table.addCountToTitle(c.count,a),arcgisonline.map.table.getFeatures(a,b,c.count)):(arcgisonline.map.table.displayTitle(a.title,a,b),arcgisonline.map.table.getFeatureCount(a,b).then(e.hitch(arcgisonline.map.table,
"getFeatures",a,b))):(k=arcgisonline.map.table.getQueryUrl(a,b),f=new esri.layers.FeatureLayer(k,{outFields:["*"],mode:esri.layers.FeatureLayer.MODE_SELECTION,resourceInfo:a.serviceInfo}),f.__tempTableLayer=!0,g=function(a,b,c){a.layer.renderer&&!t&&("heatmap"===a.layer.renderer.type?c.setRenderer(new esri.renderer.SimpleRenderer((new esri.symbol.SimpleMarkerSymbol).setColor([0,0,0,0]).setOutline(null))):c.setRenderer(esri.renderer.fromJson(a.layer.renderer.toJson())),esri.isDefined(a.layer.renderer.isMaxInclusive)&&
(c.renderer.isMaxInclusive=a.layer.renderer.isMaxInclusive));c.setScaleRange(a.layer.minScale,a.layer.maxScale);var d=e.connect(a.layer,"onScaleRangeChange",e.hitch(this,function(a,b){a.setScaleRange(b.minScale,b.maxScale)},c,a.layer));arcgisonline.map.main.map.addLayer(c);arcgisonline.map.table.saveUrl(a,b,c.url);arcgisonline.map.table.saveFLayer(a,b,c,d);arcgisonline.map.table.saveIdsFieldName(a,b,c.objectIdField);arcgisonline.map.table.displayTitle(a.title,a,b);arcgisonline.map.table.getFeatureCount(a,
b).then(e.hitch(arcgisonline.map.table,"getFeatures",a,b))},f.loaded?g(a,b,f):e.connect(f,"onLoad",e.hitch(arcgisonline.map.table,function(a,b,c){g(a,b,c)},a,b)));c&&c.fLayer&&(a.scaleChanged&&c.fLayer.setScaleRange(a.layer.minScale,a.layer.maxScale),a.rendererChanged&&("heatmap"===a.layer.renderer.type?c.fLayer.setRenderer(new esri.renderer.SimpleRenderer((new esri.symbol.SimpleMarkerSymbol).setColor([0,0,0,0]).setOutline(null))):c.fLayer.setRenderer(esri.renderer.fromJson(a.layer.renderer.toJson()))))}else{c=
arcgisonline.map.table.getInfo(a);if(!c||!c.onScaleRangeChangeHandler)c=e.connect(a.layer,"onScaleRangeChange",e.hitch(this,function(a){e.publish("onScaleRangeChange_"+a.layer.id,[])},a)),arcgisonline.map.table.saveMSHandler(a,null,c);k=(c=arcgisonline.map.table.getInfo(a,b))?c.where:"";m=arcgisonline.map.table.getWhereClause(a,b);if(c&&!arcgisonline.map.table.isWhereClauseSame(k,m))delete c.count,delete c.mode,delete c.ids,arcgisonline.map.table.displayTitle(a.title,a,b),arcgisonline.map.table.getFeatureCount(a,
b).then(e.hitch(arcgisonline.map.table,"getFeatures",a,b));else if(c)esri.isDefined(c.count)?(arcgisonline.map.table.displayTitle(a.title+" - "+c.fLayer.name,a,b),arcgisonline.map.table.addCountToTitle(c.count),arcgisonline.map.table.getFeatures(a,b,c.count)):(arcgisonline.map.table.displayTitle(a.title+" - "+c.fLayer.name,a,b),arcgisonline.map.table.getFeatureCount(a,b).then(e.hitch(arcgisonline.map.table,"getFeatures",a,b)));else{var k=arcgisonline.map.table.getQueryUrl(a,b),n,s;a.queryServiceUrl&&
a.queryLayersInfo?(e.forEach(a.queryLayersInfo.layers,function(a){a.id===b&&(n=a)}),c=n):a.layer instanceof esri.layers.ArcGISTiledMapServiceLayer&&(!a.layer.capabilities||-1===a.layer.capabilities.toLowerCase().indexOf("query"))&&a.itemLayers?(e.forEach(a.itemLayers,function(a){a.id===b&&(a.layerUrl&&a._layerInfo)&&(n=a._layerInfo)}),!n&&a.layersInfo&&e.forEach(a.layersInfo.layers,function(a){a.id===b&&(n=a)}),c=n):arcgisonline.map.main.hasDynamicLayers(a)?(c=null,e.forEach(a.layersInfo.layers,function(c){e.forEach(a.layer.dynamicLayerInfos,
function(a){a.id===b&&a.source.mapLayerId==c.id&&(n=c,s=a.source)},this)},this)):(e.forEach(a.layersInfo.layers,function(a){a.id===b&&(n=a)}),c=n);f=new esri.layers.FeatureLayer(k,{outFields:arcgisonline.map.table.getOutFields(n.fields,a),mode:esri.layers.FeatureLayer.MODE_SELECTION,resourceInfo:c,source:s});f.__tempTableLayer=!0;g=function(a,b,c){a.itemLayers?e.forEach(a.itemLayers,function(d){d.id===b&&(d.layerDefinition&&esri.isDefined(d.layerDefinition.minScale)&&esri.isDefined(d.layerDefinition.maxScale)?
c.setScaleRange(d.layerDefinition.minScale,d.layerDefinition.maxScale):c.setScaleRange(a.layer.minScale,a.layer.maxScale))}):c.setScaleRange(a.layer.minScale,a.layer.maxScale);var d=e.subscribe("onScaleRangeChange_"+a.layer.id,e.hitch(this,function(a,b){a.setScaleRange(b.minScale,b.maxScale)},c,a.layer));arcgisonline.map.main.hasDynamicLayers(a)&&e.forEach(a.itemLayers,function(a){a.id===b&&(a.layerDefinition&&a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer)&&("esriGeometryPoint"===
f.geometryType?c.setRenderer(new esri.renderer.SimpleRenderer((new esri.symbol.SimpleMarkerSymbol).setColor([0,0,0,0]).setOutline(null))):"esriGeometryPolyline"===f.geometryType?c.setRenderer(new esri.renderer.SimpleRenderer((new esri.symbol.SimpleLineSymbol).setColor([0,0,0,0]))):c.setRenderer(new esri.renderer.SimpleRenderer((new esri.symbol.SimpleFillSymbol).setColor([0,0,0,0]).setOutline(null))))});arcgisonline.map.main.map.addLayer(c);arcgisonline.map.table.saveUrl(a,b,c.url);arcgisonline.map.table.saveFLayer(a,
b,c,d);arcgisonline.map.table.saveIdsFieldName(a,b,c.objectIdField);arcgisonline.map.table.displayTitle(a.title+" - "+c.name,a,b);arcgisonline.map.table.getFeatureCount(a,b).then(e.hitch(arcgisonline.map.table,"getFeatures",a,b))};f.loaded?g(a,b,f):e.connect(f,"onLoad",e.hitch(arcgisonline.map.table,function(a,b,c){g(a,b,c)},a,b))}}arcgisonline.map.table.infoWindowHandler||(arcgisonline.map.table.infoWindowHandler=e.connect(arcgisonline.map.main.map.infoWindow,"onHide",e.hitch(arcgisonline.map.table,
"onInfoWindowHide")))},isTableVisible:function(a,b){if(a===arcgisonline.map.table.openTableMapLayerId)return!esri.isDefined(b)||b===arcgisonline.map.table.openTableMapLayerSubId?!0:!1},checkTable:function(a,b){!esri.isDefined(a)&&arcgisonline.map.table.openTableMapLayerId&&(a=arcgisonline.map.table.openTableMapLayerId,b=arcgisonline.map.table.openTableMapLayerSubId);if(esri.isDefined(a)){if(arcgisonline.map.table.isTableVisible(a,b)){var c=arcgisonline.map.main.getParameterListById(a);arcgisonline.map.table.updateTableOptions(c,
b)}if(arcgisonline.map.table.getLayerVisibility(c,b)){e.disconnect(arcgisonline.map.table.onClickHandler);arcgisonline.map.table.onClickHandler=e.connect(arcgisonline.map.main.map,"onClick",e.hitch(arcgisonline.map.table,function(a,b,c){arcgisonline.map.table.mapPoint=c.mapPoint;arcgisonline.map.table.selectFeatures(a,b,c)},c,b));var d=arcgisonline.map.table.grid.selection,f=[],g;for(g in d)f.push(parseInt(g));arcgisonline.map.table.selectRecordsByIds(c,b,f)}else e.disconnect(arcgisonline.map.table.onClickHandler),
arcgisonline.map.table.onClickHandler=null,c=arcgisonline.map.table.getInfo(c,b),c.fLayer.clearSelection(),c.fLayer.setSelectionSymbol()}},getFeatures:function(a,b,c){var d=1E3;a.layer&&esri.isDefined(a.layer.maxRecordCount)?d=Math.min(a.layer.maxRecordCount,2E3):a.serviceInfo&&esri.isDefined(a.serviceInfo.maxRecordCount)&&(d=Math.min(a.serviceInfo.maxRecordCount,2E3));var f=new e.Deferred;esri.isDefined(c)&&c<=d?(arcgisonline.map.table.saveMode(a,b,"all"),arcgisonline.map.table.getAllFeatures(a,
b).then(function(c){arcgisonline.map.table.hideWait();c&&(arcgisonline.map.table.showAttributeTableUI(a,b),arcgisonline.map.table.buildGrid(a,b,c.features),f.callback())})):a.layer&&a.layer.advancedQueryCapabilities&&a.layer.advancedQueryCapabilities.supportsPagination?(arcgisonline.map.table.saveMode(a,b,"page"),arcgisonline.map.table.hideWait(),arcgisonline.map.table.showAttributeTableUI(a,b),arcgisonline.map.table.buildGrid(a,b),f.callback()):esri.isDefined(c)&&c<=arcgisonline.map.table.maxLayerFeatureCountForPaging?
(arcgisonline.map.table.saveMode(a,b,"page"),arcgisonline.map.table.getAllIds(a,b).then(function(c){arcgisonline.map.table.hideWait();c&&(arcgisonline.map.table.showAttributeTableUI(a,b),arcgisonline.map.table.buildGrid(a,b),f.callback())})):(arcgisonline.map.table.saveMode(a,b,"tooMany"),arcgisonline.map.table.getAllFeatures(a,b).then(function(c){arcgisonline.map.table.hideWait();c&&(arcgisonline.map.table.showAttributeTableUI(a,b),arcgisonline.map.table.buildGrid(a,b,c.features),f.callback())}));
return f},getFeatureCount:function(a,b){var c=arcgisonline.map.table.getInfo(a,b),d=c?c.where:"",f=arcgisonline.map.table.getWhereClause(a,b);arcgisonline.map.table.isWhereClauseSame(d,f)||(delete c.count,delete c.mode,delete c.ids);if(esri.isDefined(c.count))return arcgisonline.map.table.displayTitle(c.title,a,b),arcgisonline.map.table.addCountToTitle(c.count),f=new e.Deferred,f.callback(c.count),f;d=new esri.tasks.Query;d.returnGeometry=!1;d.returnIdsOnly=!1;d.where=f;esri.config.defaults.io.timeout=
1E4;return c.fLayer.queryCount(d).then(e.hitch(arcgisonline.map.table,function(a,b,c){var d=arcgisonline.map.table.getInfo(a,b);arcgisonline.map.table.displayTitle(d.title,a,b);arcgisonline.map.table.addCountToTitle(c,a);esri.config.defaults.io.timeout=6E4;arcgisonline.map.table.saveCount(a,b,c);return c},a,b),e.hitch(arcgisonline.map.table,function(a,b,c){c=arcgisonline.map.table.getInfo(a,b);arcgisonline.map.table.displayTitle(c.title,a,b);arcgisonline.map.table.addCountToTitle(null,a);console.log(a.title+
"-"+b+": count query took longer than 10 sec (timeout)");esri.config.defaults.io.timeout=6E4;return null},a,b))},getAllFeatures:function(a,b){var c=arcgisonline.map.table.getInfo(a,b),d=new esri.tasks.Query;d.returnGeometry=!1;d.outFields=arcgisonline.map.table.getOutFields(c.fLayer.fields,a);d.where=arcgisonline.map.table.getWhereClause(a,b);d.orderByFields=arcgisonline.map.table.getOrderByFields(c);return c.fLayer.queryFeatures(d).then(null,function(){arcgisonline.map.table.hideWait();console.log("could not get all features");
arcgisonline.map.table.displayError()})},getAllIds:function(a,b){var c=arcgisonline.map.table.getInfo(a,b);if(c.ids){var d=new e.Deferred;d.callback(c.ids);return d}d=new esri.tasks.Query;d.returnGeometry=!1;d.outFields=arcgisonline.map.table.getOutFields(c.fLayer.fields,a);d.where=arcgisonline.map.table.getWhereClause(a,b);d.orderByFields=arcgisonline.map.table.getOrderByFields(c);return c.fLayer.queryIds(d).then(function(c){arcgisonline.map.table.saveIds(a,b,c);var d=new e.Deferred;d.callback(c);
return d},function(){arcgisonline.map.table.hideWait();console.log("could to get all ids");arcgisonline.map.table.displayError()})},showAttributeTableUI:function(a,b){arcgisonline.map.table.hideWait();"editStack"===arcgisonline.map.leftPanel.getLeftContentPanelStack()||"geocodeStack"===arcgisonline.map.leftPanel.getLeftContentPanelStack()?arcgisonline.map.table.hideAttributeTable(a,b):(0===e.style(e.byId("bottomDiv"),"height")&&(e.style(l.byId("rightDiv").getSplitter("bottom").domNode,"height","5px"),
e.style(e.byId("bottomDiv"),"height","200px"),e.style(e.byId("tableDiv"),"height","200px"),e.style(e.byId("tableDiv"),"display","block"),l.byId("main-content").resize()),arcgisonline.map.table.openTableMapLayerId=a.id,arcgisonline.map.table.openTableMapLayerSubId=b,arcgisonline.map.table.getLayerVisibility(a,b)&&(e.disconnect(arcgisonline.map.table.onClickHandler),arcgisonline.map.table.onClickHandler=e.connect(arcgisonline.map.main.map,"onClick",e.hitch(arcgisonline.map.table,function(a,b,e){arcgisonline.map.table.mapPoint=
e.mapPoint;arcgisonline.map.table.selectFeatures(a,b,e)},a,b))),arcgisonline.map.dijit.toc.options.updateTableTool(a,b))},hideAttributeTable:function(a,b,c){!a&&arcgisonline.map.table.openTableMapLayerId&&(a=arcgisonline.map.main.getParameterListById(arcgisonline.map.table.openTableMapLayerId),b=arcgisonline.map.table.openTableMapLayerSubId);if(a){var d=arcgisonline.map.table.getInfo(a,b);if(!d)return;arcgisonline.map.table.clearSelection(a,b);arcgisonline.map.table.removeShowSelectedRecordsOnly(a,
b);d.fLayer.setSelectionSymbol()}arcgisonline.map.table.infoWindowHandler&&(e.disconnect(arcgisonline.map.table.infoWindowHandler),arcgisonline.map.table.infoWindowHandler=null);l.byId("tableMenu")&&l.byId("tableMenu").destroy();e.style(e.byId("tableDiv"),"display","none");e.style(l.byId("rightDiv").getSplitter("bottom").domNode,"height","0");e.style(e.byId("tableDiv"),"height","0");e.style(e.byId("bottomDiv"),"height","0");l.byId("main-content").resize();arcgisonline.map.table.openTableMapLayerId=
null;arcgisonline.map.table.openTableMapLayerSubId=null;e.disconnect(arcgisonline.map.table.onClickHandler);arcgisonline.map.table.onClickHandler=null;arcgisonline.map.dijit.toc.options.updateTableTool(a,b);c&&c.preventDefault()},onInfoWindowHide:function(){if(esri.isDefined(arcgisonline.map.table.openTableMapLayerId)){var a=arcgisonline.map.main.getParameterListById(arcgisonline.map.table.openTableMapLayerId),b=arcgisonline.map.table.openTableMapLayerSubId;if(a){var c=arcgisonline.map.table.getInfo(a,
b);c&&(arcgisonline.map.table.clearSelection(a,b),c.fLayer.setSelectionSymbol())}}},buildGrid:function(a,b,c,d){var f=null,g=null;if(arcgisonline.map.table.grid){if(arcgisonline.map.table.grid.__mapLayerInfo&&arcgisonline.map.table.grid.__mapLayerInfo.mapLayerId===a.id&&arcgisonline.map.table.grid.__mapLayerInfo.subLayerId===b){g=[];for(q in arcgisonline.map.table.grid.columns)!1===arcgisonline.map.table.grid.columns[q].hidden&&g.push(arcgisonline.map.table.grid.columns[q].field);if(arcgisonline.map.table.grid.__mapLayerInfo.addedField)g.push(arcgisonline.map.table.grid.__mapLayerInfo.addedField);
else if(arcgisonline.map.table.grid.__mapLayerInfo.deletedField){var h=e.indexOf(g,arcgisonline.map.table.grid.__mapLayerInfo.deletedField);-1<h&&g.splice(h,1)}}for(id in arcgisonline.map.table.grid._columnHiderRules)arcgisonline.map.table.grid._columnHiderRules[id].remove();delete arcgisonline.map.table.store;this.leftPanelResizeHandler&&e.disconnect(this.leftPanelResizeHandler);f={x:e.query(".dgrid-scroller")[0].scrollLeft,y:e.query(".dgrid-scroller")[0].scrollTop};arcgisonline.map.table.grid.destroy();
delete arcgisonline.map.table.grid;arcgisonline.map.table.grid=arcgisonline.map.table.store=null}e.byId("attrTableGrid")||e.create("div",{id:"attrTableGrid"},"tableContDiv");var h=arcgisonline.map.table.getInfo(a,b),k=h.columns,m=h.columnCount,t=[],n=!1;if(esri.isDefined(h.count)&&h.count<=arcgisonline.map.table.maxLayerFeatureCountForPaging||a.layer&&a.layer.url&&(arcgisonline.sharing.util.isHostedService(a.layer.url)||a.layer.supportsAdvancedQueries||h.fLayer&&h.fLayer.supportsAdvancedQueries))n=
!0;if(!k){var k={},m=0,s=arcgisonline.map.table.getPopupInfo(a,b),r=arcgisonline.map.table.getColumnFields(h.fLayer.fields,s.fieldInfos);e.forEach(r,function(c,d){var f="field"+d,h=a.layer;if(a.layers||a.tables){var l=a.layers;a.tables&&(l=l.concat(a.tables));e.forEach(l,function(a){a.id===b&&(h=a)})}for(var p={},l=0;l<s.fieldInfos.length;l++)if(s.fieldInfos[l].fieldName===c.name){p=s.fieldInfos[l];t[l]=f;break}l=p.label||c.alias||c.name;"esriFieldTypeString"===c.type?(k[f]={className:f,field:c.name,
label:l,sortable:!1,hidden:g?-1===e.indexOf(g,c.name):!p.visible},h.typeIdField===c.name&&h.types?k[f].formatter=e.hitch(this,function(a,b,c,d){return arcgisonline.map.table._checkForCodedValues(d,d,a,p,b,c)||""},c,a,h):h.typeIdField&&h.typeIdField!==c.name&&h.types?k[f].get=e.hitch(this,function(a,b,c,d,e){return arcgisonline.map.table._checkForCodedValues(e[d.typeIdField],e[a.name],a,c,b,d)||""},c,a,p,h):k[f].formatter=c.domain&&c.domain.codedValues?function(a){for(var b=0;b<c.domain.codedValues.length;b++){var d=
c.domain.codedValues[b];if(a===d.code)return d.name}return""}:function(a){if(a){var b=a.indexOf("http:");-1===b&&(b=a.indexOf("https:"));if(-1<b&&-1===a.indexOf("href\x3d")){var c=a.indexOf(" ",b);-1===c&&(c=a.length);var d=a.substring(b,c);a=a.substring(0,b)+'\x3cA href\x3d"'+d+'" target\x3d"_blank"\x3e'+d+"\x3c/A\x3e"+a.substring(c,a.length)}}return a||""}):"esriFieldTypeDouble"===c.type||"esriFieldTypeSingle"===c.type||"esriFieldTypeInteger"===c.type||"esriFieldTypeSmallInteger"===c.type?(k[f]=
{className:f,field:c.name,label:l,sortable:!1,hidden:g?-1===e.indexOf(g,c.name):!p.visible},h.typeIdField===c.name&&h.types?k[f].formatter=e.hitch(this,function(a,b,c,d){return arcgisonline.map.table._checkForCodedValues(d,d,a,p,b,c)||""},c,a,h):h.typeIdField&&h.typeIdField!==c.name&&h.types?k[f].get=e.hitch(this,function(a,b,c,d,e){return arcgisonline.map.table._checkForCodedValues(e[d.typeIdField],e[a.name],a,c,b,d)||""},c,a,p,h):k[f].formatter=c.domain&&c.domain.codedValues?e.hitch(this,function(a,
b){for(var c=0;c<a.domain.codedValues.length;c++){var d=a.domain.codedValues[c];if(b===d.code)return d.name}return""},c):e.hitch(arcgisonline.map.table,"_normalNumberFormatter",p)):"esriFieldTypeDate"===c.type?k[f]={className:f,field:c.name,label:l,formatter:function(a){var b={dateFormat:{properties:[c.name],formatter:"DateFormat"+esri.PopupInfoTemplate.prototype._dateFormats[p.format&&p.format.dateFormat?p.format.dateFormat:"longMonthDayYear"]}},d={};d[c.name]=a;return esri.substitute(d,"${"+c.name+
"}",b)||""},sortable:!1,hidden:g?-1===e.indexOf(g,c.name):!p.visible}:"esriFieldTypeOID"===c.type&&(k[f]={className:f,field:c.name,label:l,sortable:!1,hidden:g?-1===e.indexOf(g,c.name):!p.visible});k[f]&&(!esri.isTouchEnabled&&n&&(k[f].renderHeaderCell=e.hitch(this,function(a,b){var c=e.create("div",{},b),d=e.create("table",{cellspacing:0,cellpadding:0,width:"100%"},c),d=e.create("tr",{},e.create("tbody",{},d)),f=e.create("td",{},d);e.create("span",{innerHTML:a},f);f=e.create("td",{width:"20px;",
valign:"top",align:"center"},d);d=e.create("span",{"class":"esri-icon-settings",style:"display:none;"},f);e.style(b,"cursor","pointer");b.onmouseover=e.hitch(this,function(a){e.style(a,"display","")},d);b.onmouseout=e.hitch(this,function(a){e.style(a,"display","none")},d);return c},l)),m++)});var v={};e.forEach(t,function(a){a&&k[a]&&(v[a]=k[a],delete k[a])});for(q in k)v[q]=k[q];k=v;r=!1;for(q in k)if(!k[q].hidden){r=!0;break}if(!r)for(q in k){k[q].hidden=!1;break}arcgisonline.map.table.saveColumns(a,
b,k);arcgisonline.map.table.saveColumnCount(a,b,m)}r=e.declare([dgrid.OnDemandGrid,dgrid.Selection,dgrid.extensions.ColumnResizer,dgrid.extensions.ColumnHider,dgrid.OnDemandList]);if("page"==h.mode&&!h.showSelectedRecordsOnly){c=esri.isDefined(h.fLayer.maxRecordCount)?h.fLayer.maxRecordCount:1E3;c=Math.min(c,arcgisonline.map.table.batchCount);var u=new arcgisonline.sharing.dijit.FeatureLayerQueryStore({layer:h.fLayer,objectIds:h.ids,totalCount:h.count,batchCount:c,where:arcgisonline.map.table.getWhereClause(a,
b),orderByFields:arcgisonline.map.table.getOrderByFields(h)}),w=new e.store.Memory;arcgisonline.map.table.store=new e.store.Cache(u,w,{});arcgisonline.map.table.grid=new r({minRowsPerPage:c,maxRowsPerPage:c,queryRowsOverlap:0,pagingDelay:1E3,keepScrollPosition:!0,selectionMode:"Table"===h.type?"none":"extended",columns:k,style:"width: "+100*m+"px;"},"attrTableGrid")}else u=e.map(c,function(a){return a.attributes}),arcgisonline.map.table.store=new e.store.Memory({data:{identifier:h.objectIdFieldName,
items:u}}),u=a.layer instanceof esri.layers.ArcGISImageServiceLayer,arcgisonline.map.table.grid=new r({keepScrollPosition:!0,minRowsPerPage:c.length,maxRowsPerPage:c.length,selectionMode:"Table"===h.type||h.showSelectedRecordsOnly&&(!u||h.showSecondSelectedRecordsOnly)?"none":"extended",columns:k,style:"width: "+100*m+"px;"},"attrTableGrid");arcgisonline.map.table.grid.__mapLayerInfo={mapLayerId:a.id,subLayerId:b};arcgisonline.map.table.grid.__columnCount=m;arcgisonline.map.table.grid.set("store",
arcgisonline.map.table.store);setTimeout(function(){arcgisonline.map.table.grid.resize();f&&arcgisonline.map.table.grid.scrollTo(f)},10);f&&(setTimeout(function(){arcgisonline.map.table.grid.scrollTo(f)},100),setTimeout(function(){arcgisonline.map.table.grid.scrollTo(f)},1E3),setTimeout(function(){arcgisonline.map.table.grid.scrollTo(f)},2E3));d||(arcgisonline.map.table.grid.on("dgrid-select",e.hitch(arcgisonline.map.table,function(a,b,c){arcgisonline.map.table.selectRecords(a,b,c.rows)},a,b)),arcgisonline.map.table.grid.on("dgrid-deselect",
e.hitch(arcgisonline.map.table,function(a,b,c){arcgisonline.map.table.deselectRecords(a,b,c.rows)},a,b)));if(n)for(var q in k)arcgisonline.map.table.grid.on(".dgrid-header ."+q+":click",e.hitch(arcgisonline.map.table,"showColumnMenu",a,b));arcgisonline.map.table.grid.on("dgrid-columnstatechange",e.hitch(arcgisonline.map.table,function(a,b,c){c.column&&(arcgisonline.map.table.getInfo(a,b).columns[c.column.id].hidden=c.hidden)},a,b));arcgisonline.map.table.leftPanelResizeHandler=e.connect(l.byId("leftContentPanel"),
"resize",function(){arcgisonline.map.table.grid&&arcgisonline.map.table.grid.resize()});arcgisonline.map.table.updateTableOptions(a,b,d);arcgisonline.map.table.showTableMenu(a,b);arcgisonline.map.table.grid.startup()},_normalNumberFormatter:function(a,b){if(esri.isDefined(b)&&a.format){var c=e.number.format(b,a.format);if(!a.format.digitSeparator){var d=e.i18n.getLocalization("dojo.cldr","number");d.group&&(c=c.replace(RegExp("\\"+d.group,"g"),""))}b=c}return esriGeowConfig.isRightToLeft?esri.isDefined(b)?
'\x3cspan dir\x3d"ltr"\x3e'+b+"\x3c/span\x3e":"":esri.isDefined(b)?b:""},_checkForCodedValues:function(a,b,c,d,e,g){for(e=0;e<g.types.length;e++){var h=g.types[e];if(h.id===a){if(h.domains&&h.domains[c.name]&&"inherited"===h.domains[c.name].type){if(c.domain&&c.domain.codedValues)for(e=0;e<c.domain.codedValues.length;e++){var k=c.domain.codedValues[e];if(b===k.code)return k.name}return"esriFieldTypeString"===c.type?b:arcgisonline.map.table._normalNumberFormatter(d,b)}if(h.domains&&h.domains[c.name]&&
h.domains[c.name].codedValues)for(var m=h.domains[c.name].codedValues,l=0;l<m.length;l++)if(k=m[l],b===k.code)return k.name;if(g.typeIdField===c.name&&b===h.id)return h.name}}if(c.domain&&c.domain.codedValues)for(e=0;e<c.domain.codedValues.length;e++)if(k=c.domain.codedValues[e],b===k.code)return k.name;return b},showColumnMenu:function(a,b,c){c.preventDefault();var d=new l.Menu({}),f=arcgisonline.map.table.getInfo(a,b);if(!esri.isDefined(f.supportsAdvancedQueries)&&(a.layer instanceof esri.layers.FeatureLayer||
this._isImageServiceLayer(a.layer)||a.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer))a.layer instanceof esri.layers.FeatureLayer||this._isImageServiceLayer(a.layer)?(f.supportsAdvancedQueries=a.serviceInfo&&a.serviceInfo.supportsAdvancedQueries,arcgisonline.map.table.saveSupportsAdvancedQueries(a,b,f.supportsAdvancedQueries)):a.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer&&a.layersInfo&&e.forEach(a.layersInfo.layers,function(c){c.id===b&&(f.supportsAdvancedQueries=c.supportsAdvancedQueries,
arcgisonline.map.table.saveSupportsAdvancedQueries(a,b,c.supportsAdvancedQueries))});if("all"===f.mode||f.supportsAdvancedQueries)d.addChild(new l.MenuItem({label:esri.i18nBundle.viewer.table.sortAscending,iconClass:"iconSortAscending",onClick:function(){arcgisonline.map.table.saveSortColumn(a,b,arcgisonline.map.table.grid.column(c).field,"ASC");"all"===f.mode?arcgisonline.map.table.grid.set("sort",arcgisonline.map.table.grid.column(c).field,!1):f.supportsAdvancedQueries&&(delete f.ids,arcgisonline.map.table.showAttributeTable(a,
b))}})),d.addChild(new l.MenuItem({label:esri.i18nBundle.viewer.table.sortDescending,iconClass:"iconSortDescending",onClick:function(){arcgisonline.map.table.saveSortColumn(a,b,arcgisonline.map.table.grid.column(c).field,"DESC");"all"===f.mode?arcgisonline.map.table.grid.set("sort",arcgisonline.map.table.grid.column(c).field,!0):f.supportsAdvancedQueries&&(delete f.ids,arcgisonline.map.table.showAttributeTable(a,b))}}));if(!arcgisonline.map.featColl.isFeatureCollection(a)&&!(a.layer instanceof esri.layers.CSVLayer)&&
f.fLayer.supportsStatistics){var g=arcgisonline.map.table.grid.column(c).field;e.forEach(f.fLayer.fields,function(c,e){c.name===g&&("esriFieldTypeDouble"===c.type||"esriFieldTypeSingle"===c.type||"esriFieldTypeInteger"===c.type||"esriFieldTypeSmallInteger"===c.type)&&d.addChild(new l.MenuItem({label:esri.i18nBundle.viewer.table.statistics,iconClass:"iconTableStatistics",onClick:function(){arcgisonline.map.table.showStatistics(a,b,c)}}))})}this._calcI18n||(this._calcI18n={},this._calcI18n=e.mixin(this._calcI18n,
e.i18n.getLocalization("esri","jsapi").calculateFields));if(!arcgisonline.map.featColl.isFeatureCollection(a)&&!(a.layer instanceof esri.layers.CSVLayer)&&a.layer.supportsCalculate){var g=arcgisonline.map.table.grid.column(c).field,h=this.hasFullEditingControl(a),k=arcgisonline.sharing.util.isPortal()||!1===esriGeowConfig.isMultiTenant;e.forEach(f.fLayer.fields,function(c,f){c.name===g&&((h||k&&esriGeowConfig.showCalculate)&&(c.editable&&-1===e.indexOf("esriFieldTypeBlob esriFieldTypeGlobalID esriFieldTypeGeometry esriFieldTypeGUID esriFieldTypeOID esriFieldTypeRaster".split(" "),
c.type))&&d.addChild(new l.MenuItem({label:this._calcI18n.calculate,iconClass:"iconTableCalculate",onClick:e.hitch(this,this._showCalFieldDlg,{mapLayer:a,layer:a.layer,field:c,subLayerId:b,userId:arcgisonline.sharing.util.getUser().email,table:this})})),h&&this._canDeleteField(a,c)&&d.addChild(new l.MenuItem({label:this._calcI18n.deleteLabel,iconClass:"iconTableDelete",onClick:e.hitch(this,this._confirmDeleteField,{mapLayer:a,layer:a.layer,field:c,subLayerId:b})})))},this)}d.getChildren().length&&
d._scheduleOpen(this,null,{x:c.pageX,y:c.pageY})},_canDeleteField:function(a,b){var c=!0,d=a.layer;-1!==e.indexOf(["esriFieldTypeOID","esriFieldTypeGeometry"],b.type)?c=!1:d.objectIdField===b.name||d.displayField===b.name?c=!1:d.renderer&&(d.renderer.attributeField===b.name||d.renderer.normalizationField===b.name)?c=!1:d.timeInfo&&(d.timeInfo.startTimeField===b.name||d.timeInfo.endTimeField===b.name||d.timeInfo.trackIdField===b.name)?c=!1:d.editFieldsInfo&&(d.editFieldsInfo.creationDateField===b.name||
d.editFieldsInfo.creatorField===b.name||d.editFieldsInfo.editDateField===b.name||d.editFieldsInfo.editorField===b.name)?c=!1:d.getDefinitionExpression()&&-1!==d.getDefinitionExpression().search(b.name)?c=!1:d.labelingInfo&&0<d.labelingInfo.length?c=!this._checkFieldUsedinLabel(b,d.labelingInfo):arcgisonline.map.geocode.isSearchField(a,null,b.name)&&(c=!1);return c},_checkFieldUsedinLabel:function(a,b){var c=!1;e.forEach(b,function(b){b&&(b.labelExpressionInfo&&b.labelExpressionInfo.value&&-1!==b.labelExpressionInfo.value.search("{"+
a.name+"}")?c=!0:b.labelExpression&&-1<b.labelExpression.indexOf("["+a.name+"]")&&(c=!0))},this);return c},updateTableOptions:function(a,b,c){l.byId("tableMenu")&&l.byId("tableMenu").destroy();var d=[],f=arcgisonline.map.table.getInfo(a,b),g=arcgisonline.map.featColl.isFeatureCollection(a),h=a.layer instanceof esri.layers.FeatureLayer,k=a.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer,m=a.layer instanceof esri.layers.ArcGISImageServiceLayer,t=a.layer instanceof esri.layers.ArcGISImageServiceVectorLayer,
n=a.layer instanceof esri.layers.CSVLayer;if(!c){if(!g&&!n&&(h||k||m||t))d.push({label:esri.i18nBundle.tocPanel.filter,onClick:e.hitch(arcgisonline.map.table,"showFilterDlg",a,b),style:"Table"!==f.type?"border-bottom: 1px solid #AFAFAF;":""});"Table"!==f.type&&((!f.showSelectedRecordsOnly||m&&!f.showSecondSelectedRecordsOnly)&&d.push({label:esri.i18nBundle.viewer.table.showSelectedRecords,onClick:e.hitch(arcgisonline.map.table,"showSelectedRecords",a,b)}),f.showSelectedRecordsOnly&&d.push({label:esri.i18nBundle.viewer.table.showAllRecords,
onClick:e.hitch(arcgisonline.map.table,"showAllRecords",a,b)}));"Table"!==f.type&&arcgisonline.map.table.getLayerVisibility(a,b)&&(d.push({label:esri.i18nBundle.viewer.table.centerOnSelection,onClick:e.hitch(arcgisonline.map.table,"zoomToSelection",a,b)}),d.push({label:esri.i18nBundle.viewer.table.clearSelection,onClick:e.hitch(arcgisonline.map.table,"clearSelection",a,b)}));this._calcI18n||(this._calcI18n={},this._calcI18n=e.mixin(this._calcI18n,e.i18n.getLocalization("esri","jsapi").calculateFields));
if(!g&&(h||k||m)&&this.hasFullEditingControl(a))d.push({label:this._calcI18n.addFieldTitle,onClick:e.hitch(arcgisonline.map.table,"_showAddDlg",{mapLayer:a,subLayerId:b,layer:a.layer,table:this}),style:"Table"!==f.type?"border-bottom: 1px solid #AFAFAF;":""})}d.push({label:esri.i18nBundle.viewer.table.showHideColumns,onClick:e.hitch(arcgisonline.map.table,"showHideColumns",a,b),style:"border-top: 1px solid #AFAFAF;"+(m?"border-bottom: 1px solid #AFAFAF;":"")});m&&!c&&(d.push({label:esri.i18nBundle.viewer.table.selectVisibleRasters,
onClick:e.hitch(arcgisonline.map.table,"selectVisibleRasters",a,b)}),d.push({label:esri.i18nBundle.viewer.table.unlockRaster,onClick:e.hitch(arcgisonline.map.table,"unlockRasters",a,b)}),d.push({label:esri.i18nBundle.viewer.table.lockRaster,onClick:e.hitch(arcgisonline.map.table,"lockRasters",a,b)}));new arcgisonline.sharing.dijit.TextMenu({id:"tableMenu",triggerNode:e.byId("webmap-tableLink"),labelNode:e.byId("webmap-tableLink"),textMenuItems:d});e.style(e.byId("tableOptions"),"display",10>e.isIE?
"inline":"")},showTableMenu:function(a,b){var c=e.query("div#dgrid-hider-menu-attrTableGrid");if(!c||!c.length)c=e.query("div#attrTableGrid-hider-menu");var c=c[0],d=e.create("div",{"class":"dgrid-hider-menu-row"}),d=e.create("div",{"class":"dgrid-hider-menu-row",innerHTML:"\x3clabel\x3e"+esri.i18nBundle.viewer.table.showHideColumnsLabel+"\x3c/label\x3e"});e.place(d,c,0);if(5<arcgisonline.map.table.grid.__columnCount){var d=e.create("div",{"class":"dgrid-hider-menu-row"}),f=e.create("input",{id:"attrTableGrid-hider-menu-check-all",
"class":"dgrid-hider-menu-check-all",type:"checkbox"},d);e.create("label",{"class":"dgrid-hider-menu-label","for":"attrTableGrid-hider-menu-check-all",innerHTML:esri.i18nBundle.viewer.table.allColums},d);e.place(d,c,1);e.connect(f,"onclick",e.hitch(arcgisonline.map.table,"allColumns"))}},allColumns:function(){if(e.byId("attrTableGrid-hider-menu-check-all").checked)for(var a in arcgisonline.map.table.grid.columns)e.byId("attrTableGrid-hider-menu-check-"+a).checked||(e.byId("attrTableGrid-hider-menu-check-"+
a).checked=!0,arcgisonline.map.table.grid._updateColumnHiddenState(a,!1));else for(a in arcgisonline.map.table.grid.columns)e.byId("attrTableGrid-hider-menu-check-"+a).checked&&(e.byId("attrTableGrid-hider-menu-check-"+a).checked=!1,arcgisonline.map.table.grid._updateColumnHiddenState(a,!0))},showHideColumns:function(){arcgisonline.map.table.grid._toggleColumnHiderMenu()},showFilterDlg:function(a,b){var c;a.layer instanceof esri.layers.FeatureLayer||this._isImageServiceLayer(a.layer)?(c=a.serviceInfo,
arcgisonline.map.main.openFilterDlg(a,c)):arcgisonline.map.main.hasDynamicLayers(a)?e.forEach(a.layer.dynamicLayerInfos,function(c){c.id===b&&arcgisonline.map.main.openFilterDlg(a,c)}):arcgisonline.map.main.getLayerInfoForQuery(a,b).then(function(b){arcgisonline.map.main.openFilterDlg(a,b)})},lockRasters:function(a,b){var c=arcgisonline.map.table.getInfo(a,b).fLayer.getSelectedFeatures(),d=[];c.length&&e.forEach(c,function(a){a.attributes&&d.push(parseInt(a.attributes.OBJECTID))});if(!(1>d.length)){c=
new esri.layers.MosaicRule;c.method=esri.layers.MosaicRule.METHOD_LOCKRASTER;c.lockRasterIds=d;var f=arcgisonline.map.table.getWhereClause(a,b);f&&(c.where=f);a.layer.setMosaicRule(c);arcgisonline.map.table.clearYellowSelection(a,b);arcgisonline.map.table.updateTableOptions(a,b)}},unlockRasters:function(a,b){if(a.layer.mosaicRule&&a.layer.mosaicRule.method===esri.layers.MosaicRule.METHOD_LOCKRASTER){var c=new esri.layers.MosaicRule(a.layer.defaultMosaicRule.toJson()),d=arcgisonline.map.table.getWhereClause(a,
b);d&&(c.where=d);a.layer.setMosaicRule(c);arcgisonline.map.table.updateTableOptions(a,b)}},isPortalArcObjects:function(a){var b=arcgisonline.sharing.util.getUser(),c=arcgisonline.sharing.util.portalSupportsHostedServices(),d=a.itemCard;a=a.itemId;return b&&c&&a&&d&&d.typeKeywords&&-1<e.indexOf(d.typeKeywords,"Hosted Service")&&-1===e.indexOf(d.typeKeywords,"providerSDS")},hasFullEditingControl:function(a){var b=!1,c=arcgisonline.sharing.util.getUser(),d=a.itemCard,f=a.itemId;if(c&&f&&(arcgisonline.sharing.util.isHostedService(a.url)||
arcgisonline.sharing.util.isPortal()&&!this.isPortalArcObjects(a)))d&&-1<e.indexOf(d.typeKeywords,"Hosted Service")&&("update"===a.itemCard.itemControl||"admin"===a.itemCard.itemControl?b=!0:c&&esriGeowConfig.userRole&&esriGeowConfig.userRole.isAdmin()&&-1<a.url.indexOf("/"+c.accountId+"/")?b=!0:c&&(d.owner&&d.owner===c.email)&&(b=!0));return b},zoomToSelection:function(a,b){var c=arcgisonline.map.table.getInfo(a,b).fLayer.getSelectedFeatures();if(c.length){var d=null,f=null;e.forEach(c,function(a){if(a.geometry)if(d){f=
null;var b;if("point"===a.geometry.type)b=0.0010,b=new esri.geometry.Extent(a.geometry.x-b,a.geometry.y-b,a.geometry.x+b,a.geometry.y+b,a.geometry.spatialReference);else if("multipoint"===a.geometry.type||"polyline"===a.geometry.type||"polygon"===a.geometry.type)b=a.geometry.getExtent();d=d.union(b)}else if(f=a.geometry,"point"===a.geometry.type)b=0.0010,d=new esri.geometry.Extent(a.geometry.x-b,a.geometry.y-b,a.geometry.x+b,a.geometry.y+b,a.geometry.spatialReference);else if("multipoint"===a.geometry.type||
"polyline"===a.geometry.type||"polygon"===a.geometry.type)d=a.geometry.getExtent()});f?(c="point"===f.type?arcgisonline.map.main.map.extent.centerAt(f):f.getExtent().expand(1.2),arcgisonline.map.table.setMapExtent(a,b,c)):d&&arcgisonline.map.main.map.setExtent(d.expand(1.2),!0)}},clearSelection:function(a,b){var c=arcgisonline.map.table.getInfo(a,b);c.showSelectedRecordsOnly?(arcgisonline.map.table.store.setData([]),arcgisonline.map.table.grid.set("store",arcgisonline.map.table.store),arcgisonline.map.table.displayTitle(c.title,
a,b),arcgisonline.map.table.addCountAndSelectionToTitle(c.count,0),arcgisonline.map.table.clearYellowSelection(a,b)):arcgisonline.map.table.grid.clearSelection();"Table"!==c.fLayer.type&&c.fLayer.clearSelection();this.showAllRecords(a,b)},clearYellowSelection:function(a,b){var c=arcgisonline.map.table.getInfo(a,b);c.selLayer&&c.selLayer.clearSelection();c.fLayer.setSelectionSymbol();arcgisonline.map.table.setSelectionSymbol(c.fLayer)},saveSelectionAsFilter:function(a,b){console.log("not yet implemented")},
selectFeatures:function(a,b,c){if(arcgisonline.map.main.measureActivated)return!0;var d=arcgisonline.map.table.getInfo(a,b);if("Table"!==d.type&&!d.fLayer.suspended){arcgisonline.map.table.setSelectionSymbol(d.fLayer);var f=c.graphic,f=f&&f._getEffInfoTemplate()?f:null,g=6;if("esriGeometryPoint"===d.fLayer.geometryType&&d.fLayer.getSelectionSymbol())if(f){var h=d.fLayer._getSymbol(f);if(h){switch(h.type){case "simplemarkersymbol":width=height=h.size||0;break;case "picturemarkersymbol":width=h.width||
0,height=h.height||0}var k=(d.layer||d.fLayer).renderer.sizeInfo||e.filter((d.layer||d.fLayer).renderer.visualVariables,function(a){return"sizeInfo"===a.type})[0],g=k?(d.layer||d.fLayer).renderer.getSize(f,{sizeInfo:k,shape:h.style,resolution:arcgisonline.map.main.map&&arcgisonline.map.main.map.getResolutionInMeters&&arcgisonline.map.main.map.getResolutionInMeters()})/2:Math.max(width,height)/2;d.fLayer.getSelectionSymbol()._setDim(width+1,height+1,0)}else d.fLayer.getSelectionSymbol()._setDim(16,
16,0)}else d.fLayer.getSelectionSymbol()._setDim(16,16,0);(d=d.fLayer.renderer)&&"esri.renderer.SimpleRenderer"===d.declaredClass?(h=d.symbol,h.xoffset&&(g=Math.max(g,Math.abs(h.xoffset))),h.yoffset&&(g=Math.max(g,Math.abs(h.yoffset)))):d&&("esri.renderer.UniqueValueRenderer"===d.declaredClass||"esri.renderer.ClassBreaksRenderer"===d.declaredClass)&&e.forEach(d.infos,function(a){a=a.symbol;a.xoffset&&(g=Math.max(g,Math.abs(a.xoffset)));a.yoffset&&(g=Math.max(g,Math.abs(a.yoffset)))});d=c.screenPoint;
c=arcgisonline.map.main.map.toMap(new esri.geometry.ScreenPoint(d.x-g,d.y+g));d=arcgisonline.map.main.map.toMap(new esri.geometry.ScreenPoint(d.x+g,d.y-g));c=new esri.geometry.Extent(c.x,c.y,d.x,d.y,arcgisonline.map.main.map.spatialReference);d=new esri.tasks.Query;d.returnGeometry=!0;d.geometry=c;d.where=arcgisonline.map.table.getWhereClause(a,b);arcgisonline.map.table.selectFeaturesFromQuery(a,b,d)}},selectFeaturesFromQuery:function(a,b,c){arcgisonline.map.table.clearSelection(a,b);var d=arcgisonline.map.table.getInfo(a,
b);"Table"!==d.type&&arcgisonline.map.table.getLayerVisibility(a,b)&&(arcgisonline.map.featColl.isFeatureCollection(a)||a.layer instanceof esri.layers.CSVLayer?(d=e.filter(d.fLayer.graphics,function(a){return c.geometry.intersects(a.geometry)}),arcgisonline.map.table.onQueryFeaturesResult({features:d},a,b)):d.fLayer.queryFeatures(c).then(e.hitch(arcgisonline.map.table,function(a,b,c){arcgisonline.map.table.onQueryFeaturesResult(c,a,b)},a,b),function(a){console.log("error executing query",a?a.message:
" ")}))},selectFeaturesFromIdentify:function(a,b,c){arcgisonline.map.table.clearSelection(a,b);arcgisonline.map.table.getInfo(a,b);arcgisonline.map.table.getLayerVisibility(a,b)&&(new esri.tasks.ImageServiceIdentifyTask(a.layer.url)).execute(c).then(e.hitch(arcgisonline.map.table,function(a,b,c){var e={features:[]};if(c&&c.catalogItems&&c.catalogItems.features&&c.catalogItemVisibilities)for(var k=0;k<c.catalogItems.features.length;k++)0<c.catalogItemVisibilities[k]&&e.features.push(c.catalogItems.features[k]);
arcgisonline.map.table.onQueryFeaturesResult(e,a,b)},a,b),function(a){console.log("error executing identify",a?a.message:" ")})},onQueryFeaturesResult:function(a,b,c){var d=arcgisonline.map.table.getInfo(b,c),f=e.map(a.features,function(a){return a.attributes[d.objectIdFieldName]});if(f.length){var g=new esri.tasks.Query;g.returnGeometry=!0;g.objectIds=f;d.fLayer.selectFeatures(g,esri.layers.FeatureLayer.SELECTION_NEW)}else d.fLayer.clearSelection();arcgisonline.map.table.displayTitle(d.title,b,c);
arcgisonline.map.table.addCountAndSelectionToTitle(d.count,f.length);if(d.showSelectedRecordsOnly)a=e.map(a.features,function(a){return a.attributes}),arcgisonline.map.table.store.setData(a),arcgisonline.map.table.grid.set("store",arcgisonline.map.table.store);else{b.layer instanceof esri.layers.ArcGISImageServiceLayer&&(d.showSecondSelectedRecordsOnly&&!this.yellowGraphics)&&(this.yellowGraphics=e.map(a.features,function(a){arcgisonline.map.main.map.graphics.add(new esri.Graphic(a.geometry,this.getYellowSelectionSymbol(d.fLayer),
a.attributes))}));var h=!0;e.forEach(a.features,function(a){var b=a.attributes[d.objectIdFieldName];if(arcgisonline.map.table.store.get(b)){if(a=arcgisonline.map.table.grid.row(b),arcgisonline.map.table.grid.select(a),h)if(a.element)a.element.scrollIntoView(),h=!1;else{a=arcgisonline.map.table.store.objectIds.indexOf(b);arcgisonline.map.table.grid.scrollTo({y:a*arcgisonline.map.table.grid.rowHeight});h=!1;var c=0,e=setInterval(function(){var a=arcgisonline.map.table.grid.row(b);a&&a.element&&(clearInterval(e),
arcgisonline.map.table.grid.select(a));10<c?clearInterval(e):c++},1E3)}}else h&&(a=arcgisonline.map.table.store.objectIds.indexOf(b),arcgisonline.map.table.grid.scrollTo({y:a*arcgisonline.map.table.grid.rowHeight}),h=!1,c=0,e=setInterval(function(){var a=arcgisonline.map.table.grid.row(b);a&&a.element&&(clearInterval(e),arcgisonline.map.table.grid.select(a));10<c?clearInterval(e):c++},1E3))})}},selectRecords:function(a,b,c){if(arcgisonline.map.table.getLayerVisibility(a,b)&&(b=arcgisonline.map.table.getInfo(a,
b),"Table"!==b.type)){arcgisonline.map.table.setSelectionSymbol(b.fLayer);a.layer instanceof esri.layers.ArcGISImageServiceLayer&&(b.showSelectedRecordsOnly&&!b.showSecondSelectedRecordsOnly&&b.selLayer)&&(arcgisonline.map.table.setSelectionSymbol(b.selLayer),b.selLayer.show(),b.fLayer.setSelectionSymbol(arcgisonline.map.table.getYellowSelectionSymbol(b.selLayer)));a=new esri.tasks.Query;a.returnGeometry=!0;a.objectIds=[];c=arcgisonline.map.table.grid.selection;for(var d in c)a.objectIds.push(parseInt(d));
b.fLayer.selectFeatures(a,esri.layers.FeatureLayer.SELECTION_NEW).then(null,function(){console.log("could not select feature(s) on map")})}},selectRecordsByIds:function(a,b,c){arcgisonline.map.table.getLayerVisibility(a,b)&&(a=arcgisonline.map.table.getInfo(a,b),"Table"!==a.type&&(arcgisonline.map.table.setSelectionSymbol(a.fLayer),b=new esri.tasks.Query,b.returnGeometry=!0,b.objectIds=c,a.fLayer.selectFeatures(b,esri.layers.FeatureLayer.SELECTION_ADD).then(null,function(){console.log("could not select feature(s) on map")})))},
deselectRecords:function(a,b,c){if(arcgisonline.map.table.getLayerVisibility(a,b)){var d=arcgisonline.map.table.getInfo(a,b);if("Table"!==d.type){var f=new esri.tasks.Query;f.returnGeometry=!0;f.objectIds=[];e.forEach(c,function(a){f.objectIds.push(a.data[d.objectIdFieldName])});d.fLayer.selectFeatures(f,esri.layers.FeatureLayer.SELECTION_SUBTRACT)}}},setSelectionSymbol:function(a){if(!a.getSelectionSymbol())if("esriGeometryPoint"===a.geometryType){var b=new esri.symbol.SimpleMarkerSymbol;b.setStyle(esri.symbol.SimpleMarkerSymbol.STYLE_TARGET);
b._setDim(16,16,0);b.setOutline(new esri.symbol.CartographicLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new e.Color([0,255,255]),2,esri.symbol.CartographicLineSymbol.CAP_ROUND,esri.symbol.CartographicLineSymbol.JOIN_ROUND));b.setColor(new e.Color([0,0,0,0]));a.setSelectionSymbol(b)}else"esriGeometryPolyline"===a.geometryType?a.setSelectionSymbol(esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new e.Color([0,255,255]),2)):a.setSelectionSymbol(new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_NULL,
new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new e.Color([0,255,255]),2),new e.Color([0,0,0,0])))},getYellowSelectionSymbol:function(a){return"esriGeometryPoint"===a.geometryType?(a=new esri.symbol.SimpleMarkerSymbol,a.setStyle(esri.symbol.SimpleMarkerSymbol.STYLE_TARGET),a._setDim(16,16,0),a.setOutline(new esri.symbol.CartographicLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new e.Color([255,255,0]),2,esri.symbol.CartographicLineSymbol.CAP_ROUND,esri.symbol.CartographicLineSymbol.JOIN_ROUND)),
a.setColor(new e.Color([0,0,0,0])),a):"esriGeometryPolyline"===a.geometryType?esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new e.Color([255,255,0]),2):new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_NULL,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new e.Color([255,255,0]),2),new e.Color([0,0,0,0]))},selectVisibleRasters:function(a,b){var c=arcgisonline.map.table.getInfo(a,b);arcgisonline.map.table.setSelectionSymbol(c.fLayer);
var d=arcgisonline.map.main.map,e=new esri.geometry.Extent(d.extent.toJson());10<=a.layer.version&&d.wrapAround180&&(e=e._normalize(!0));c=new esri.geometry.Polygon(e.spatialReference);c.addRing([[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]);d=new esri.geometry.Point((e.xmax-e.xmin)/(2*d.width),(e.ymax-e.ymin)/(2*d.height),e.spatialReference);e=new esri.tasks.ImageServiceIdentifyParameters;e.geometry=c;e.returnGeometry=!0;e.pixelSize=d;e.where=arcgisonline.map.table.getWhereClause(a,
b);e.mosaicRule=a.layer.mosaicRule?a.layer.mosaicRule:null;arcgisonline.map.table.selectFeaturesFromIdentify(a,b,e)},showAllRecords:function(a,b){var c=arcgisonline.map.table.getInfo(a,b);c.showSelectedRecordsOnly&&(e.disconnect(c.showSelectedRecordsOnlyHandler),arcgisonline.map.table.saveShowSelectedRecordsOnly(a,b,!1,null),arcgisonline.map.table.saveShowSecondSelectedRecordsOnly(a,b,!1),arcgisonline.map.featColl.isFeatureCollection(a)?a.layer?(arcgisonline.map.table.buildGrid(a,b,a.layer.graphics),
arcgisonline.map.table.selectRecordsInTable(a,b)):e.forEach(a.layers,function(c){c.id===b&&(arcgisonline.map.table.buildGrid(a,b,c.graphics),arcgisonline.map.table.selectRecordsInTable(a,b))}):a.layer instanceof esri.layers.GeoRSSLayer?(c=a.layer.getFeatureLayers(),e.forEach(c,function(c){c.id===b&&(arcgisonline.map.table.buildGrid(a,b,c.graphics),arcgisonline.map.table.selectRecordsInTable(a,b))})):a.layer instanceof esri.layers.CSVLayer?(arcgisonline.map.table.buildGrid(a,b,a.layer.graphics),arcgisonline.map.table.selectRecordsInTable(a,
b)):(arcgisonline.map.table.clearYellowSelection(a,b),arcgisonline.map.table.getFeatures(a,b,c.count).then(function(){arcgisonline.map.table.selectRecordsInTable(a,b)})))},selectRecordsInTable:function(a,b){var c=arcgisonline.map.table.getInfo(a,b),d=!0;e.forEach(c.fLayer.getSelectedFeatures(),function(a){var b=a.attributes[c.objectIdFieldName];arcgisonline.map.table.store instanceof arcgisonline.sharing.dijit.FeatureLayerQueryStore?arcgisonline.map.table.store.get(b).then(function(a){d=arcgisonline.map.table.selectRecordsAndScroll(a,
b,d)}):(a=arcgisonline.map.table.store.get(b),d=arcgisonline.map.table.selectRecordsAndScroll(a,b,d))})},selectRecordsAndScroll:function(a,b,c){if(a){if(arcgisonline.map.table.grid.select(b),c){if(a=arcgisonline.map.table.grid.row(b).element)return a.scrollIntoView(),!1;console.log("id: "+b+" not yet rendererd")}}else console.log("id: "+b+" not yet requested");return!0},showSelectedRecords:function(a,b){var c=arcgisonline.map.table.getInfo(a,b),d=a.layer instanceof esri.layers.ArcGISImageServiceLayer;
if(!c.showSelectedRecordsOnly||d&&!c.showSecondSelectedRecordsOnly){var f=e.connect(a.layer,"onSelectionComplete",function(d,f){var g=e.map(d,function(a){return a.attributes});arcgisonline.map.table.store.setData(g);arcgisonline.map.table.grid.set("store",arcgisonline.map.table.store);arcgisonline.map.table.displayTitle(c.title,a,b);arcgisonline.map.table.addCountAndSelectionToTitle(c.count,d.length);if(arcgisonline.map.table.getLayerVisibility(a,b)){var g=e.map(d,function(a){return a.attributes[c.objectIdFieldName]}),
h=new esri.tasks.Query;h.returnGeometry=!0;h.objectIds=g;c.fLayer.selectFeatures(h,esri.layers.FeatureLayer.SELECTION_NEW)}});d&&(c.showSelectedRecordsOnly&&!c.showSecondSelectedRecordsOnly)&&arcgisonline.map.table.saveShowSecondSelectedRecordsOnly(a,b,!0);arcgisonline.map.table.saveShowSelectedRecordsOnly(a,b,!0,f);arcgisonline.map.table.buildGrid(a,b,c.fLayer.getSelectedFeatures());arcgisonline.map.table.displayTitle(c.title,a,b);arcgisonline.map.table.addCountAndSelectionToTitle(c.count,c.fLayer.getSelectedFeatures().length);
if((d=a.layer instanceof esri.layers.ArcGISImageServiceLayer)&&c.showSelectedRecordsOnly&&c.showSecondSelectedRecordsOnly)arcgisonline.map.table.clearYellowSelection(a,b);else if(d&&c.showSelectedRecordsOnly&&!c.showSecondSelectedRecordsOnly){var g=function(){c.selLayer.hide();var a=e.map(c.fLayer.getSelectedFeatures(),function(a){return a.attributes[c.objectIdFieldName]}),b=new esri.tasks.Query;b.returnGeometry=!0;b.objectIds=a;c.selLayer.selectFeatures(b,esri.layers.FeatureLayer.SELECTION_NEW)};
if(c.selLayer)g();else{var d=arcgisonline.map.table.getQueryUrl(a,b),d=new esri.layers.FeatureLayer(d,{outFields:["*"],mode:esri.layers.FeatureLayer.MODE_SELECTION,resourceInfo:a.serviceInfo}),h=function(a,b,c,d){d=e.indexOf(arcgisonline.map.main.map.graphicsLayerIds,d.fLayer.id);arcgisonline.map.main.map.addLayer(c,d);arcgisonline.map.table.saveSelLayer(a,b,c);g()};d.loaded?h(a,b,d,c):e.connect(d,"onLoad",e.hitch(arcgisonline.map.table,function(a,b,c,d){h(a,b,d,c)},a,b,c))}}}},showStatistics:function(a,
b,c){var d=new esri.tasks.Query;d.outFields=[c.name];d.outStatistics=[];d.where=arcgisonline.map.table.getWhereClause(a,b);var f=new esri.tasks.StatisticDefinition;f.statisticType="count";f.onStatisticField=c.name;f.outStatisticFieldName="countfield";d.outStatistics.push(f);f=new esri.tasks.StatisticDefinition;f.statisticType="sum";f.onStatisticField=c.name;f.outStatisticFieldName="sumfield";d.outStatistics.push(f);f=new esri.tasks.StatisticDefinition;f.statisticType="min";f.onStatisticField=c.name;
f.outStatisticFieldName="minfield";d.outStatistics.push(f);f=new esri.tasks.StatisticDefinition;f.statisticType="max";f.onStatisticField=c.name;f.outStatisticFieldName="maxfield";d.outStatistics.push(f);f=new esri.tasks.StatisticDefinition;f.statisticType="avg";f.onStatisticField=c.name;f.outStatisticFieldName="avgfield";d.outStatistics.push(f);f=new esri.tasks.StatisticDefinition;f.statisticType="stddev";f.onStatisticField=c.name;f.outStatisticFieldName="stddevfield";d.outStatistics.push(f);var g=
arcgisonline.map.table.getInfo(a,b);g.showSelectedRecordsOnly&&(f=e.map(g.fLayer.getSelectedFeatures(),function(a){return a.attributes[g.objectIdFieldName]}),d.where=d.where?"("+d.where+") AND ("+g.objectIdFieldName+" IN ("+f.toString()+"))":g.objectIdFieldName+" IN ("+f.toString()+")");var h=g.fLayer.url;arcgisonline.map.main.hasDynamicLayers(a)&&e.forEach(a.layersInfo.layers,function(c){e.forEach(a.layer.dynamicLayerInfos,function(d){d.id===b&&d.source.mapLayerId==c.id&&(h=a.url+"/"+d.source.mapLayerId)},
this)},this);(new esri.tasks.QueryTask(h)).execute(d).then(function(a){a.features&&a.features.length&&arcgisonline.sharing.dijit.dialog.TableStatisticsDlg.prototype.statics.getInstance().show(c.alias||c.name,a.features[0].attributes)},function(a){console.log("could not get statistics",a?a.message:a)})},_showAddDlg:function(a){arcgisonline.sharing.dijit.dialog.TableAddFieldDlg.prototype.statics.getInstance().show(a)},_showCalFieldDlg:function(a,b){arcgisonline.sharing.dijit.dialog.TableCalcFieldDlg.prototype.statics.getInstance().show(a)},
_confirmDeleteField:function(a){arcgisonline.sharing.dijit.dialog.DeleteWarningDlg.prototype.statics.getInstance().showMsgTitleButton(e.string.substitute(this._calcI18n.deleteFieldConfirm,{field:a.field.alias||a.field.name}),this._calcI18n.deleteField,this._calcI18n.deleteField,e.hitch(this,this._deleteField,a))},_deleteField:function(a){var b={f:"json"},c=a.layer.url.replace("/rest/services","/rest/admin/services")+"/deleteFromDefinition",d=arcgisonline.sharing.util.getToken(),f=[],g={};d&&(b.token=
d);f.push({name:a.field.name});g.fields=f;b.deleteFromDefinition=e.toJson(g);def=esri.request({url:c,content:b},{usePost:!0});def.then(e.hitch(this,function(b){esri.request({url:a.layer.url,content:{f:"json"},callbackParamName:"callback"}).then(e.hitch(this,function(b){a.mapLayer.layer.fields=b.fields;a.mapLayer.serviceInfo=b;b=arcgisonline.map.table.getPopupInfo(a.mapLayer,a.subLayerId);b.fieldInfos=e.filter(b.fieldInfos,function(b){return b.fieldName!==a.field.name},this);arcgisonline.map.popup.removePopup(a.mapLayer);
a.mapLayer.popupInfo=b;a.mapLayer.popupChanged=!0;arcgisonline.map.popup.addPopupLayer(a.mapLayer,a.subLayerId);arcgisonline.map.main.markMapAsChanged("deleteField");"Feature Layer"===a.mapLayer.layer.type?(arcgisonline.map.edit.removeTypesAndTemplatesOnLayer(a.mapLayer.layer),arcgisonline.map.edit.createTypesAndTemplatesOnMapLayer(a.mapLayer),a.mapLayer.featureTemplatesChanged=!0,arcgisonline.map.itemData.updateFeatureService(a.mapLayer,e.hitch(this,function(b){arcgisonline.map.table.refreshTable(a.mapLayer,
a.subLayerId,"delete",a.field.name)}))):arcgisonline.map.itemData.uploadItemLayerInfos(a.mapLayer,e.hitch(this,function(b){arcgisonline.map.table.refreshTable(a.mapLayer,a.subLayerId,"delete",a.field.name)}))}),e.hitch(this,function(a){console.log(a);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:a.message})}))}),e.hitch(this,function(a){console.log(a);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:a.details.toString()})}))},saveLayer:function(a,b,c){var d=arcgisonline.map.table.storedInfo[a.id]||{};esri.isDefined(b)?d[b]=e.mixin(d[b]||{},{layer:c}):d.layer=c;arcgisonline.map.table.storedInfo[a.id]=d},saveFLayer:function(a,b,c,d){var f=arcgisonline.map.table.storedInfo[a.id]||{},g=e.connect(c,"onSelectionComplete",e.partial(function(c,d){var e=arcgisonline.map.table.getInfo(a,b);arcgisonline.map.table.displayTitle(e.title,a,b);arcgisonline.map.table.addCountAndSelectionToTitle(e.count,
e.fLayer.getSelectedFeatures().length)},f));esri.isDefined(b)?(f[b].onSelectionCompleteHandler&&e.disconnect(f[b].onSelectionCompleteHandler),f[b]=e.mixin(f[b]||{},{fLayer:c,onScaleRangeChangeHandler:d,onSelectionCompleteHandler:g})):(f.onSelectionCompleteHandler&&e.disconnect(f.onSelectionCompleteHandler),f.fLayer=c,f.onScaleRangeChangeHandler=d,f.onSelectionCompleteHandler=g);arcgisonline.map.table.storedInfo[a.id]=f},saveFLayerInfo:function(a,b,c){var d=arcgisonline.map.table.storedInfo[a.id]||
{};esri.isDefined(b)?d[b]=e.mixin(d[b]||{},{fLayerInfo:c}):d.fLayerInfo=c;arcgisonline.map.table.storedInfo[a.id]=d},saveSelLayer:function(a,b,c){var d=arcgisonline.map.table.storedInfo[a.id]||{};esri.isDefined(b)?d[b]=e.mixin(d[b]||{},{selLayer:c}):d.selLayer=c;arcgisonline.map.table.storedInfo[a.id]=d},saveType:function(a,b,c){b=arcgisonline.map.table.storedInfo[a.id]||{};b.type=c;arcgisonline.map.table.storedInfo[a.id]=b},saveUrl:function(a,b,c){var d=arcgisonline.map.table.storedInfo[a.id]||{};
esri.isDefined(b)?d[b]=e.mixin(d[b]||{},{url:c}):d.url=c;arcgisonline.map.table.storedInfo[a.id]=d},saveCount:function(a,b,c){var d=arcgisonline.map.table.storedInfo[a.id]||{};esri.isDefined(b)?d[b]=e.mixin(d[b]||{},{count:c}):d.count=c;arcgisonline.map.table.storedInfo[a.id]=d},saveIds:function(a,b,c){var d=arcgisonline.map.table.storedInfo[a.id]||{};esri.isDefined(b)?d[b]=e.mixin(d[b]||{},{ids:c}):d.ids=c;arcgisonline.map.table.storedInfo[a.id]=d},saveIdsFieldName:function(a,b,c){var d=arcgisonline.map.table.storedInfo[a.id]||
{};esri.isDefined(b)?d[b]=e.mixin(d[b]||{},{objectIdFieldName:c}):d.objectIdFieldName=c;arcgisonline.map.table.storedInfo[a.id]=d},saveMode:function(a,b,c){var d=arcgisonline.map.table.storedInfo[a.id]||{};esri.isDefined(b)?d[b]=e.mixin(d[b]||{},{mode:c}):d.mode=c;arcgisonline.map.table.storedInfo[a.id]=d},saveSupportsAdvancedQueries:function(a,b,c){var d=arcgisonline.map.table.storedInfo[a.id]||{};esri.isDefined(b)?d[b]=e.mixin(d[b]||{},{supportsAdvancedQueries:c}):d.supportsAdvancedQueries=c;arcgisonline.map.table.storedInfo[a.id]=
d},saveWhereClause:function(a,b,c){var d=arcgisonline.map.table.storedInfo[a.id]||{};esri.isDefined(b)?d[b]=e.mixin(d[b]||{},{where:c}):d.where=c;arcgisonline.map.table.storedInfo[a.id]=d},saveSortColumn:function(a,b,c,d){var f=arcgisonline.map.table.storedInfo[a.id]||{};esri.isDefined(b)?f[b]=e.mixin(f[b]||{},{sort:{name:c,order:d}}):f.sort={name:c,order:d};arcgisonline.map.table.storedInfo[a.id]=f},saveColumns:function(a,b,c){var d=arcgisonline.map.table.storedInfo[a.id]||{};esri.isDefined(b)?d[b]=
e.mixin(d[b]||{},{columns:c}):d.columns=c;arcgisonline.map.table.storedInfo[a.id]=d},saveColumnCount:function(a,b,c){var d=arcgisonline.map.table.storedInfo[a.id]||{};esri.isDefined(b)?d[b]=e.mixin(d[b]||{},{columnCount:c}):d.columnCount=c;arcgisonline.map.table.storedInfo[a.id]=d},saveTitle:function(a,b,c){var d=arcgisonline.map.table.storedInfo[a.id]||{};esri.isDefined(b)?d[b]=e.mixin(d[b]||{},{title:c}):d.title=c;arcgisonline.map.table.storedInfo[a.id]=d},saveMSHandler:function(a,b,c){b=arcgisonline.map.table.storedInfo[a.id]||
{};b.onScaleRangeChangeHandler=c;arcgisonline.map.table.storedInfo[a.id]=b},saveShowSelectedRecordsOnly:function(a,b,c,d){var f=arcgisonline.map.table.storedInfo[a.id]||{};esri.isDefined(b)?f[b]=e.mixin(f[b]||{},{showSelectedRecordsOnly:c,showSelectedRecordsOnlyHandler:d}):(f.showSelectedRecordsOnly=c,f.showSelectedRecordsOnlyHandler=d);arcgisonline.map.table.storedInfo[a.id]=f},saveShowSecondSelectedRecordsOnly:function(a,b,c){var d=arcgisonline.map.table.storedInfo[a.id]||{};esri.isDefined(b)?d[b]=
e.mixin(d[b]||{},{showSecondSelectedRecordsOnly:c}):d.showSecondSelectedRecordsOnly=c;arcgisonline.map.table.storedInfo[a.id]=d},getInfo:function(a,b){if(arcgisonline.map.table.storedInfo[a.id]){var c=arcgisonline.map.table.storedInfo[a.id];if(esri.isDefined(b)){if(c[b])return c[b]}else return c}return null},removeInfoColumns:function(a,b){var c=arcgisonline.map.table.storedInfo[a.id];c&&c!=={}&&(esri.isDefined(b)?c[b]&&delete c[b].columns:delete c.columns,arcgisonline.map.table.storedInfo[a.id]=
c)},removeShowSelectedRecordsOnly:function(a,b){var c=arcgisonline.map.table.storedInfo[a.id];c&&c!=={}&&(esri.isDefined(b)?c[b]&&(delete c[b].showSelectedRecordsOnly,delete c[b].showSecondSelectedRecordsOnly,c[b].showSelectedRecordsOnlyHandler&&e.disconnect(c[b].showSelectedRecordsOnlyHandler),delete c[b].showSelectedRecordsOnlyHandler):(delete c.showSelectedRecordsOnly,delete c.showSecondSelectedRecordsOnly,c.showSelectedRecordsOnlyHandler&&e.disconnect(c.showSelectedRecordsOnlyHandler),delete c.showSelectedRecordsOnlyHandler),
arcgisonline.map.table.storedInfo[a.id]=c)},removeInfo:function(a,b){if(esri.isDefined(b)){var c=arcgisonline.map.table.storedInfo[a.id];c[b]&&delete c[b]}else delete arcgisonline.map.table.storedInfo[a.id]},getLayerVisibility:function(a,b){var c=!1;if(arcgisonline.map.featColl.isFeatureCollection(a)||a.layer instanceof esri.layers.CSVLayer)a.layer?c=a.layer.visible:e.forEach(a.layers,function(a){a.id===b&&(c=a.visible)});else if(a.layer instanceof esri.layers.GeoRSSLayer){var d=a.layer.getFeatureLayers();
e.forEach(d,function(a){a.id===b&&(c=a.visible)})}else if(a.layer instanceof esri.layers.FeatureLayer||this._isImageServiceLayer(a.layer))c=a.layer.visible;else if(c=a.layer.visible)if(esri.isDefined(a.visibleLayers))d=a.visibleLayers.split(","),-1==e.indexOf(d,b)&&(c=!1);else for(var d=a.layer.layerInfos,f=0;f<d.length;f++){var g=d[f];if(g.id===b){c=g.defaultVisibility;break}}return c},getLayerScale:function(a,b){var c=arcgisonline.map.table.getInfo(a,b);if(arcgisonline.map.featColl.isFeatureCollection(a)||
a.layer instanceof esri.layers.CSVLayer){if(a.layer)return{minScale:a.layer.minScale,maxScale:a.layer.maxScale};var d;e.forEach(a.layers,function(a){a.id===b&&(d={minScale:a.minScale,maxScale:a.maxScale})});return d}if(a.layer instanceof esri.layers.GeoRSSLayer)return c=a.layer.getFeatureLayers(),e.forEach(c,function(a){a.id===b&&(d={minScale:a.minScale,maxScale:a.maxScale})}),d;if(a.layer instanceof esri.layers.FeatureLayer)return{minScale:a.layer.minScale,maxScale:a.layer.maxScale};var f=Math.min(c.fLayer.minScale,
a.layer.minScale);!c.fLayer.minScale&&a.layer.minScale?f=a.layer.minScale:!a.layer.minScale&&c.fLayer.minScale&&(f=c.fLayer.minScale);return{minScale:f,maxScale:Math.max(c.fLayer.maxScale,a.layer.maxScale)}},getQueryUrl:function(a,b){var c="";arcgisonline.map.featColl.isFeatureCollection(a)||a.layer instanceof esri.layers.CSVLayer?c=a.layer?a.url:a.url+"/"+b:"esri.layers.FeatureLayer"==a.layer.declaredClass||this._isImageServiceLayer(a.layer)?c=a.url:a.queryServiceUrl?c=a.queryServiceUrl+"/"+b:arcgisonline.map.main.hasDynamicLayers(a)?
c=a.url+"/dynamicLayer":a.itemLayers?(e.forEach(a.itemLayers,function(a){a.id===b&&a.layerUrl&&(c=a.layerUrl)}),c.length||(c=a.url+"/"+b)):c=a.url+"/"+b;return c},getExtentForScale:function(a,b,c){var d=esri.WKIDUnitConversion,e,g,h=a.spatialReference;h&&(e=h.wkid,g=h.wkt);var k;e?k=d.values[d[e]]:g&&-1!==g.search(/^PROJCS/i)&&(d=/UNIT\[([^\]]+)\]\]$/i.exec(g))&&d[1]&&(k=parseFloat(d[1].split(",")[1]));return esri.geometry._getExtentForScale(a,b,k,c,!0)},getPopupInfo:function(a,b){var c=arcgisonline.map.popup.getPopupInfo(a,
b);if(!c)if(arcgisonline.map.featColl.isFeatureCollection(a)||a.layer instanceof esri.layers.CSVLayer)if(a.layer)c=arcgisonline.map.featColl.generateDefaultPopupInfo(a.layer.toJson());else{var d=a.layers;a.tables&&(d=d.concat(a.tables));e.forEach(d,function(a){a.id===b&&(c=arcgisonline.map.featColl.generateDefaultPopupInfo(a.toJson()))})}else a.layer instanceof esri.layers.GeoRSSLayer?(d=a.layer.getFeatureLayers(),e.forEach(d,function(a){a.id===b&&(c=arcgisonline.map.featColl.generateDefaultPopupInfo(a.toJson()))})):
a.layer instanceof esri.layers.FeatureLayer||this._isImageServiceLayer(a.layer)?c=arcgisonline.map.popup.getDefaultPopupInfo(a.serviceInfo,a.layer.isEditable?a.layer.isEditable():!1,a.layer):a.queryServiceUrl&&a.queryLayersInfo?e.forEach(a.queryLayersInfo.layers,function(d){d.id===b&&(c=arcgisonline.map.popup.getDefaultPopupInfo(d,!1,a.layer))}):a.layer instanceof esri.layers.ArcGISTiledMapServiceLayer&&(!a.layer.capabilities||-1===a.layer.capabilities.toLowerCase().indexOf("query"))&&a.itemLayers?
e.forEach(a.itemLayers,function(d){d.id===b&&(d.layerUrl&&d._layerInfo)&&(c=arcgisonline.map.popup.getDefaultPopupInfo(d._layerInfo,!1,a.layer))}):e.forEach(a.layersInfo.layers,function(d){d.id===b&&(c=arcgisonline.map.popup.getDefaultPopupInfo(d,!1,a.layer))});return c},displayTitle:function(a,b,c){var d=a.replace(/\_/g," ");67<d.length&&(d=d.substring(0,70)+esri.i18nBundle.viewer.shortenedTextEnding);e.byId("tableTitle").innerHTML=d;arcgisonline.map.table.saveTitle(b,c,a)},addCountToTitle:function(a,
b){arcgisonline.map.table.addCountAndSelectionToTitle(a,0,b)},addCountAndSelectionToTitle:function(a,b,c){if(esri.isDefined(a)){var d=esri.i18nBundle.viewer.table.zero_features,f=esri.i18nBundle.viewer.table.one_feature,g=esri.i18nBundle.viewer.table.more_features;c&&c.layer instanceof esri.layers.ArcGISImageServiceLayer&&(d=esri.i18nBundle.viewer.table.zero_rasters,f=esri.i18nBundle.viewer.table.one_raster,g=esri.i18nBundle.viewer.table.more_rasters);c="";c=0==a?d:1==a?f:e.string.substitute(g,{num:e.number.format(a,
{places:0})});esri.isDefined(b)?(a=e.string.substitute(esri.i18nBundle.viewer.table.selected,{num:e.number.format(b,{places:0})}),e.byId("tableTitle").innerHTML=e.string.substitute(esri.i18nBundle.viewer.table.title_count_selected,{title:e.byId("tableTitle").innerHTML,count:c,selected:a})):e.byId("tableTitle").innerHTML=e.string.substitute(esri.i18nBundle.viewer.table.title_count,{title:e.byId("tableTitle").innerHTML,count:c})}else esri.isDefined(b)&&(a=e.string.substitute(esri.i18nBundle.viewer.table.selected,
{num:e.number.format(b,{places:0})}),e.byId("tableTitle").innerHTML=e.string.substitute(esri.i18nBundle.viewer.table.title_selected,{title:e.byId("tableTitle").innerHTML,selected:a}))},setMapExtent:function(a,b,c){var d=arcgisonline.map.main.map.width*c.getHeight()/arcgisonline.map.main.map.height;if(d>c.getWidth()){var e=c.getCenter().x;c.xmin=e-d/1.6;c.xmax=e+d/1.6}d=arcgisonline.map.main.getScaleForExtent(c,arcgisonline.map.main.map.width);a=arcgisonline.map.table.getLayerScale(a,b);if(!(d<=a.minScale||
0===a.minScale)||!(d>=a.maxScale||0===a.maxScale)){b=esri.geometry.getScale(arcgisonline.map.main.map);if(0<a.minScale&&(0<a.maxScale&&Math.abs(a.maxScale-b)>Math.abs(a.minScale-b)||0===a.maxScale)){if(a=a.minScale,arcgisonline.map.main.mapLods)for(b=0;b<arcgisonline.map.main.mapLods.length-1;b++)if(arcgisonline.map.main.mapLods[b].scale>=a&&arcgisonline.map.main.mapLods[b+1].scale<=a){a=arcgisonline.map.main.mapLods[b+1].scale;break}}else if(a=a.maxScale,arcgisonline.map.main.mapLods)for(b=0;b<arcgisonline.map.main.mapLods.length-
1;b++)if(arcgisonline.map.main.mapLods[b].scale>=a&&arcgisonline.map.main.mapLods[b+1].scale<=a){a=arcgisonline.map.main.mapLods[b].scale;break}c=arcgisonline.map.table.getExtentForScale(c,arcgisonline.map.main.map.width,a)}a=c.getCenter();b=c.getWidth()/1E3;c.ymin=a.y-b;c.ymax=a.y+b;arcgisonline.map.main.map.setExtent(c,!1)},getWhereClause:function(a,b){var c="1\x3d1";a.layer instanceof esri.layers.FeatureLayer||this._isImageServiceLayer(a.layer)?a.layerDefinition&&a.layerDefinition.definitionExpression&&
(c=a.layer.getDefinitionExpression()):a.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer&&a.layer.layerDefinitions&&(c=a.layer.layerDefinitions[b]||c);arcgisonline.map.table.saveWhereClause(a,b,c);return c},getOrderByFields:function(a){return a.sort?[a.sort.name+" "+a.sort.order]:null},openFilterDlg:function(a,b,c){var d=(new l.Dialog).placeAt(document.body),f=new arcgisonline.sharing.dijit.dialog.FilterDlg({id:"filterDlg",dialog:d,style:"width:"+arcgisonline.map.main.calcFilterDlgWidth()+
"px;"});d.set({title:esri.i18nBundle.FilterDlg.filter,content:f});d.show();a.layer instanceof esri.layers.FeatureLayer||this._isImageServiceLayer(a.layer)?f.start(a,a.serviceInfo,c):e.forEach(a.layer.layerInfos,function(d){d.id==b&&arcgisonline.map.main.getLayerInfoForQuery(a,d.id,d.subLayerIds).then(function(b){f.start(a,b,c)})})},showWait:function(){arcgisonline.map.table.waitDlg=arcgisonline.sharing.dijit.dialog.WaitingDlg.prototype.statics.getInstance();arcgisonline.map.table.waitDlg.show({title:esri.i18nBundle.viewer.table.waitMsgTitle,
message:esri.i18nBundle.viewer.table.waitMsg,duration:0})},hideWait:function(){arcgisonline.map.table.waitDlg&&(arcgisonline.map.table.waitDlg.hide(),arcgisonline.map.table.waitDlg=null)},isWhereClauseSame:function(a,b){return("1\x3d1"==a?"":a||"")===("1\x3d1"==b?"":b||"")},getOutFields:function(a,b){return b.thematicGroup&&b.thematicGroup.fieldNames&&b.thematicGroup.fieldNames.length?e.map(e.filter(a,function(a){return e.some(b.thematicGroup.fieldNames,function(b){return b===a.name||"esriFieldTypeOID"==
a.type})}),function(a){return a.name}):["*"]},getColumnFields:function(a,b){return 100<a.length&&b?e.filter(a,function(a){return e.some(b,function(b){return b.fieldName===a.name})}):a},displayError:function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.table.error.msg})},toc_showAttributeTable:function(a,b){if(arcgisonline.map.featColl.isFeatureCollection(a)||a.layer instanceof esri.layers.CSVLayer)if(a.layer)arcgisonline.map.table.showAttributeTable(a,
-1);else{var c=a.layers;a.tables&&(c=c.concat(a.tables));arcgisonline.map.table.showAttributeTable(a,c[b].id)}else a.layer instanceof esri.layers.GeoRSSLayer?arcgisonline.map.table.showAttributeTable(a,a.layer.getFeatureLayers()[-1==b?0:b].id):a.layer instanceof esri.layers.FeatureLayer&&"Table"===a.layer.type?a.itemId&&!a.itemCard?arcgisonline.map.save_open.itemCards[a.itemId]?(a.itemCard=arcgisonline.map.save_open.itemCards[a.itemId],arcgisonline.map.table.showAttributeTable(a)):arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+
"content/items/"+a.itemId,e.hitch(this,function(a,b,c){arcgisonline.map.save_open.itemCards[c.id]=c;a.itemCard=c;arcgisonline.map.table.showAttributeTable(a)},a,this.menuSubLayerPos),e.hitch(this,function(){arcgisonline.map.table.toc_showAttributeTable(a,b)})):arcgisonline.map.table.showAttributeTable(a):a.layer instanceof esri.layers.FeatureLayer||this._isImageServiceLayer(a.layer)?arcgisonline.map.table.showAttributeTable(a):(c=arcgisonline.map.main.hasDynamicLayers(a)?a.layer.dynamicLayerInfos[b]:
a.layer.layerInfos[b],arcgisonline.map.table.showAttributeTable(a,c.id))},toc_hideAttributeTable:function(a,b){if(arcgisonline.map.featColl.isFeatureCollection(a)||a.layer instanceof esri.layers.CSVLayer)if(a.layer)arcgisonline.map.table.hideAttributeTable(a);else if(-1<b){var c=a.layers;a.tables&&(c=c.concat(a.tables));arcgisonline.map.table.hideAttributeTable(a,c[b].id)}else e.forEach(a.layers,function(b){arcgisonline.map.table.hideAttributeTable(a,b.id)});else a.layer instanceof esri.layers.GeoRSSLayer?
arcgisonline.map.table.hideAttributeTable(a,a.layer.getFeatureLayers()[-1==b?0:b].id):a.layer instanceof esri.layers.FeatureLayer||this._isImageServiceLayer(a.layer)?arcgisonline.map.table.hideAttributeTable(a):-1<b&&arcgisonline.map.main.hasDynamicLayers(a)?(c=a.layer.dynamicLayerInfos[b],arcgisonline.map.table.hideAttributeTable(a,c.id)):-1<b?(c=a.layer.layerInfos[b],arcgisonline.map.table.hideAttributeTable(a,c.id)):arcgisonline.map.table.hideAttributeTable()},_isImageServiceLayer:function(a){return a instanceof
esri.layers.ArcGISImageServiceLayer||a instanceof esri.layers.ArcGISImageServiceVectorLayer},doNothing:function(){}}});