// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/BrowseItemsDlg","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/window dojo/_base/event dojo/dom-class dojo/dom-style dojo/dom-attr dojo/string dojo/on dojo/aspect dojo/dom dojo/dom-construct dojo/mouse dojo/topic dojo/query dojo/parser dijit/registry dijit/TooltipDialog dijit/popup dojo/promise/all dojo/Deferred dgrid/Grid dgrid/extensions/Pagination dgrid/OnDemandGrid dgrid/Selection dgrid/selector dgrid/Keyboard dgrid/util/mouse dgrid/util/touch put-selector/put dojo/store/Observable dijit/_WidgetBase dijit/_TemplatedMixin dijit/_WidgetsInTemplateMixin esri/arcgis/Portal esri/Evented esri/PluginTarget arcgisonline/sharing/util arcgisonline/sharing/geow/Account ./_AppTemplateFiltersMixin dojo/i18n!arcgisonline/nls/arcgisonline ../_RefreshMixin dojo/NodeList-dom".split(" "),
function(g,b,l,L,s,f,M,h,t,m,N,n,p,O,x,d,P,u,Q,R,S,y,z,A,T,B,U,V,v,W,C,D,E,F,G,q,X,H,w,I,Y,r,J){var K=g(null,{idProperty:"id",constructor:function(a){g.safeMixin(this,a)},get:function(a,e){return q.PortalUtil.request(this.portalUrl+"content/items/"+a,e).then(function(a){return new q.PortalItem(b.mixin(a,{portal:this.portal}))})},getIdentity:function(a){return a[this.idProperty]},query:function(a,e){var c=b.isObject(a)?a:{q:a};if(e&&(c=b.mixin(c,{num:e.count,start:(e.start||0)+1}),e.sort&&e.sort.length))var d=
e.sort[0],c=b.mixin(c,{sortField:encodeURIComponent("created"===d.attribute?"uploaded":d.attribute),sortOrder:d.descending?"desc":"asc"});c=this.portal.queryItems(c,!0).then(function(a){a.results.total=a.total;return a.results});return q.PortalResult(c)}});return g("arcgisonline.sharing.dijit.dialog.BrowseItemsDlg",[E,F,G,H],{templateString:'\x3cdiv\x3e\x3cdiv class\x3d"top-bar"\x3e\x3cdiv  class\x3d"esriFloatLeading instructions"\x3e\x3cspan class\x3d"messageLeft hide" data-dojo-attach-point\x3d"messageNodeLeft"\x3e\x3c/span\x3e\x3cspan class\x3d"messageRight hide" data-dojo-attach-point\x3d"messageNodeRight"\x3e\x3c/span\x3e\x3ca tabIndex\x3d"-1" data-dojo-attach-point\x3d"helpLink" class\x3d"esriHelpIcon hide" title\x3d"${i18n.common.learnMoreConfigurableApps}" href\x3d"#" target\x3d"_blank"\x3e\x3c/a\x3e\x3c/div\x3e\x3cdiv id\x3d"${id}_search"class\x3d"searchBar esriFloatTrailing"\x3e\x3cinput tabIndex\x3d"1" placeholder\x3d"${i18n.search.searchTitle}" class\x3d"esriSearchBox dijitTextBox" type\x3d"search"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"gallery"\x3e\x3cdiv class\x3d"gallery-left  quiet-scroll"\x3e\x3cul class\x3d"filters"\x3e\x3c/ul\x3e\x3c/div\x3e\x3cdiv class\x3d"templates gallery-right"\x3e\x3cp id\x3d"${id}_filterTitle" class\x3d"filter-title hide" data-dojo-attach-point\x3d"filterDescription"\x3e\x3c/p\x3e\x3cdiv id\x3d"${id}_grid"class\x3d"dgrid-autoheight quiet-scroll"\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv id\x3d"loader-wrap"\x3e\x3c/div\x3e\x3cdiv  data-dojo-attach-point\x3d"infoPanel" id\x3d"template-info-panel"\x3e\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e',
galleryTemplate:"\x3cdiv style\x3d'opacity:1;' class\x3d'grid-item gallery-view'\x3e${item:_formatThumbnail}${item:_formatItemTitle}\x3cp class\x3d\"template-overlay\" style\x3d\"display:none;\"\x3e${i18n.browseItemsDlg.selectDetails}\x3c/p\x3e\x3c/div\x3e",infoPanelTemplate:'\x3cdiv\x3e\x3cdiv class\x3d"template-info-showing"\x3e\x3cdiv class\x3d"thumbnail"\x3e\x3cimg src\x3d"${item:_formatInfoPanelImage}"\x3e\x3c/div\x3e\x3ch4\x3e${item.title}\x3c/h4\x3e\x3cdiv class\x3d"template-info"\x3e\x3cp class\x3d"quiet-scroll"\x3e${item.snippet}\x3c/p\x3e\x3c/div\x3e\x3c/div\x3e\x3cdiv class\x3d"panel-actions"\x3e\x3cbutton class\x3d"btn blue btn-main" id\x3d"on-next"\x3e${i18n.browseItemsDlg.configure}\x3c/button\x3e\x3cbutton class\x3d"btn btn-cancel" id\x3d"close-panel"\x3e${i18n.common.close}\x3c/button\x3e\x3c/div\x3e\x3cdiv\x3e',
baseClass:"esriBrowseItems",i18n:r,postCreate:function(){this.inherited(arguments);I.getSelf(b.hitch(this,function(a){this._canSearchPublic=a.canSearchPublic;this._currentFilter=b.mixin(this._currentFilter||{},{get:function(a){return this[a]&&this[a].length?"("+this[a].join(" OR ")+") ":""},toString:function(){return{q:this.get("groups")+this.get("tags")+this.get("typekeywords")+(this.query||"")+(this.search||"")+' -type:"Attachment"'}}});a.canSearchPublic=!0;this.galleryTemplate=this.plugIn&&this.plugIn.galleryTemplate||
this.galleryTemplate;this.infoPanelTemplate=this.plugIn&&this.plugIn.infoPanelTemplate||this.infoPanelTemplate;if(this.helpLinkUrl=this.plugIn&&this.plugIn.helpLinkUrl||"")h.set(this.helpLink,"href",this.helpLinkUrl),f.remove(this.helpLink,"hide");this._portal=new q.Portal({url:esriGeowConfig.restBaseUrl,self:a});this._portal.on("load",b.hitch(this,"_fetchData"));d(".templates",this.domNode).addClass("fade");d(".dgrid-footer",this.domNode).addClass("hide")}))},destroy:function(){this.inherited(arguments);
this._grid&&this._grid.destroy();this._img_connect&&(this._img_connect.remove(),this._img_connect_error.remove());this._queryTimer&&clearTimeout(this._queryTimer);this._grid=this._portal=null},_setItemQueryAttr:function(a){this.itemQuery=a},_setPluginAttr:function(a){this.addPlugin(a)},_setMessageAttr:function(a){this.set("messageRight",a)},_setMessageRightAttr:function(a){h.set(this.messageNodeRight,"innerHTML",a);f.remove(this.messageNodeRight,"hide")},_setMessageLeftAttr:function(a){h.set(this.messageNodeLeft,
"innerHTML",a);f.remove(this.messageNodeLeft,"hide")},_setDisabledAttr:function(a){var b=u.findWidgets(this.domNode).concat(u.findWidgets(this._content));l.forEach(b,function(b){b.set("disabled",a)});f[a?"add":"remove"](this._interval.domNode,"dijitTextBoxDisabled")},_setSortAttr:function(a){this.sortAttribute=a},_setSortDescendingAttr:function(a){this.sortDescending=a},_getSelectionAttr:function(){var a=this._grid.selection,b;for(b in a)break;return b&&this._grid.row(b).data},_validate:function(){return!!this.get("selection")},
_clearQueryTimeout:function(){clearTimeout(this._queryTimer);this._queryTimer=null},_createGrid:function(){var a=g([z,A,B,J]),e=new D(new K({portal:this._portal})),c=this._currentFilter,k=b.hitch(this,function(a){a.snippet=a.snippet||"";var b=C("div");a=t.substitute(this.galleryTemplate,{item:a,i18n:r},null,this);p.place(a,b);return b});this._grid=new a({store:e,query:c.toString(),selectionMode:"single",pagingLinks:2,rowsPerPage:this.plugIn&&this.plugIn.rowsPerPage||6,noDataMessage:r.QueryLayerDlg.error.noFSItems,
showLoadingMessage:!1,renderRow:k,sort:[{attribute:this.sortAttribute||"title",descending:this.sortDescending||!1}]},this.id+"_grid");this._grid.startup();this.own(m(this.domNode,"click",b.hitch(this,function(a){n.byId("close-panel")&&n.byId("close-panel").click()})),this._grid.on(v.enterRow,b.hitch(this,function(a){!1===f.contains(this.domNode,"showing")&&this._showOverlay(!0,a)})),this._grid.on(v.leaveRow,b.hitch(this,function(a){this._showOverlay(!1,a)})),this._grid.on(".dgrid-row:click",b.hitch(this,
function(a){var e,c;!1===f.contains(this.domNode,"showing")&&(a.preventDefault(),s.stop(a),c=this.get("selection"),this._showOverlay(!1,a),p.place(t.substitute(this.infoPanelTemplate,{item:c,i18n:r},function(a){return esri.isDefined(a)?a:""},this),this.infoPanel),f.add(this.domNode,"showing"),e=[d(".template-info-showing .thumbnail img",this.domNode).on("error",b.hitch(this,function(a){h.set(a.target,"src",c.thumbnailUrl)})),d(".panel-actions .btn").on("click",b.hitch(this,function(a){a.preventDefault();
s.stop(a);"close-panel"===a.target.id?(f.remove(this.domNode,"showing"),setTimeout(function(){l.forEach(e,"item.remove();");p.empty("template-info-panel")},250)):x.publish("/esri/browseitems/close",a.target.id,this.get("selection"))})),d("#template-info-panel").on("click",b.hitch(this,function(a){a.preventDefault();s.stop(a)}))])})),this._grid.on("dgrid-refresh-complete",b.hitch(this,function(a){d(".templates",this.domNode).removeClass("fade");d("#loader-wrap",this.domNode).addClass("hide");d(".dgrid-footer",
this.domNode)[this._grid._total<=this._grid.rowsPerPage?"addClass":"removeClass"]("hide")})),this._grid.on("refresh",b.hitch(this,function(){this._img_connect&&(this._img_connect.remove(),this._img_connect_error.remove(),this._img_connect_error=this._img_connect=null);this._img_connect=d(".grid-item-thumb",this._grid.domNode).on("load",b.hitch(this,function(a){(a=this._grid.row(a))&&a.element&&d(".grid-item",a.element).addClass("fadeIn").style("opacity","1")}));this._img_connect_error=d(".grid-item-thumb",
this._grid.domNode).on("error",b.hitch(this,function(a){h.set(a.target,"src",w.getStaticImagesUrl()+"/desktopapp.png")}))})),m(n.byId(this.id+"_search"),"keyup",b.hitch(this,function(a){a.preventDefault();this._clearQueryTimeout();this._queryTimer=setTimeout(b.hitch(this,function(){this._currentFilter.search=h.get(a.target,"value");this._fetchItems(this._currentFilter).then(b.hitch(this,function(){this._clearQueryTimeout()}))}),this.searchKeypressDelay||450)})),m(n.byId(this.id+"_search"),"search",
b.hitch(this,function(a){this._queryTimer||(a.preventDefault(),this._currentFilter.search=h.get(a.target,"value"),this._fetchItems(this._currentFilter))})))},_createFilters:function(){if(this.plugIn&&this.plugIn.filters){var a=this.plugIn.filters,e=this.plugIn.filterStrings,c,k=d(".filters",this.domNode)[0];for(c in a)p.create("li",{"class":"all"===c?"active":"",innerHTML:"\x3ca id\x3d'"+c+"'  href\x3d'#'\x3e"+e[c].title+"\x3c/a\x3e"},k);this.own(m(k,"li a:click",b.hitch(this,function(c){c.preventDefault();
var g=c.target;d(".active",k).removeClass("active");f.add(g.parentNode,"active");d(".templates",this.domNode).addClass("fade");setTimeout(b.hitch(this,function(){f["all"===g.id?"add":"remove"](this.filterDescription,"hide");h.set(this.filterDescription,"innerHTML",e[g.id].description||"")}),225);c=b.mixin({},a[g.id]||{});this._currentFilter.tags=l.map(c.tags||[],function(a){return'tags:"'+a+'"'});this._currentFilter.typekeywords=[].concat(l.map(c.typekeywords||[],function(a){return'typekeywords:"'+
a+'"'}));this._fetchItems(this._currentFilter)})));f.add(this.domNode,"filters")}else f.add(this.domNode,"nofilters"+(this.plugIn&&this.plugIn.extraClasses?" "+this.plugIn.extraClasses.join(" "):""))},_showOverlay:function(a,b){var c=this._grid.row(b);c&&d(".template-overlay",c.element).style("display",a?"":"none")},_fetchData:function(){this._user=this._portal.getPortalUser();return this.plugIn&&this.plugIn.fetchData?this.plugIn.fetchData():this._fetchItems(this.itemQuery)},_fetchItems:function(a,
e){var c={sort:[{attribute:this.sortAttribute||"title",descending:this.sortDescending||!1}]},f=new y;d(".templates",this.domNode).addClass("fade");d(".dgrid-footer",this.domNode).addClass("hide");d("#loader-wrap",this.domNode).removeClass("hide");setTimeout(b.hitch(this,function(){this._currentFilter=b.mixin(this._currentFilter,a);this._grid?this._grid.set("query",this._currentFilter.toString(),c):(this._createFilters(),this._createGrid());f.resolve(this._grid)}),60);return f},_formatThumbnail:function(a){var b=
a.thumbnailUrl||w.getStaticImagesUrl()+"/desktopapp.png";a.thumbnailUrl=b;return"\x3cimg class\x3d'grid-item-thumb' width\x3d'187px' height\x3d'125px' alt\x3d'' src\x3d'"+b+"'\x3e"},_formatInfoPanelImage:function(a){var b=a.screenshots&&a.screenshots.length?a.screenshots[0]:null;return b?a.itemUrl+"/info/"+b:a.thumbnailUrl},_formatItemTitle:function(a){return"\x3ch5\x3e"+(a.title||a.name||"\x3cNo Title\x3e")+"\x3c/h5\x3e"}})});