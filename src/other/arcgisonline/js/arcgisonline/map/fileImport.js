// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/fileImport",["dijit","dojo","dojox","dojo/require!arcgisonline/map/main,esri/arcgis/csv,dojox/data/CsvStore,dojox/data/XmlStore,dojox/xml/DomParser,dojox/encoding/base64,esri/symbols/SimpleMarkerSymbol,esri/symbols/SimpleLineSymbol,esri/symbols/SimpleFillSymbol,esri/renderers/SimpleRenderer,arcgisonline/map/dijit/renderer/_RendererMixin"],function(P,b,H){b.provide("arcgisonline.map.fileImport");b.require("arcgisonline.map.main");b.require("esri.arcgis.csv");b.require("dojox.data.CsvStore");
b.require("dojox.data.XmlStore");b.require("dojox.xml.DomParser");b.require("dojox.encoding.base64");b.require("esri.symbols.SimpleMarkerSymbol");b.require("esri.symbols.SimpleLineSymbol");b.require("esri.symbols.SimpleFillSymbol");b.require("esri.renderers.SimpleRenderer");b.require("arcgisonline.map.dijit.renderer._RendererMixin");arcgisonline.map.fileImport={latFieldStrings:"lat latitude y ycenter latitude83 latdecdeg point-y lat_dd".split(" "),longFieldStrings:"lon lng long longitude x xcenter longitude83 longdecdeg point-x long_dd".split(" "),
symbolJson:"gpsunique.json",dropHandler:null,setupDragDrop:function(){arcgisonline.map.fileImport.setupDropZones()},setupDropZones:function(){if(!arcgisonline.map.fileImport.dropHandler){var c=b.byId("map");b.connect(c,"dragenter",function(b){b.preventDefault()});b.connect(c,"dragover",function(b){b.preventDefault()});arcgisonline.map.fileImport.dropHandler=window.File&&window.FileReader?b.connect(c,"drop",b.hitch(arcgisonline.map.fileImport,"handleDrop")):b.connect(c,"drop",function(b){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:esri.i18nBundle.viewer.fileImport.noDragDrop})})}},handleDrop:function(b){b.preventDefault();b=b.dataTransfer.files;var d;if(b&&1===b.length){var f=b[0];-1!==f.name.indexOf(".lnk")?(b=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),b.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.shortcutDragDropType})):-1!==f.name.toLowerCase().indexOf(".csv")||-1!==f.name.toLowerCase().indexOf(".txt")?(d=new FileReader,d.onload=function(){arcgisonline.map.fileImport.processCsvData(d.result,
f.name)},d.readAsText(f)):-1!==f.name.toLowerCase().indexOf(".gpx")?(d=new FileReader,d.onload=function(){arcgisonline.map.fileImport.processGpxData(d.result,f.name)},d.readAsText(f)):(b=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),b.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.notSupportedDragDropType}))}},addCSVByReferenceLayer:function(c){if(c&&0!==c.length){var d=c.substring(c.lastIndexOf("/")+1);if(-1<d.indexOf("?")){var f=
d.substring(0,d.indexOf("?"));f.length&&(d=f)}esri.request({url:c,handleAs:"text",headers:{"Content-Type":""},load:function(b){arcgisonline.map.fileImport.processCsvData(b,d,c)},error:function(d){console.error("error: "+d);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.viewer.webMap,message:b.string.substitute(esri.i18nBundle.viewer.fileImport.csvNotAccessible,{url:c})})}},{usePost:!1})}},processCsvData:function(c,d,f,k,a,g){var e="\n",l=c.indexOf(e);
-1==l&&(e="\r",l=c.indexOf(e));if(-1==l)l=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),l.show({title:esri.i18nBundle.common.errorTitle,message:esri.i18nBundle.viewer.fileImport.noRecords});else{var m=b.trim(c.substring(0,l));if(!m.length){e=c.indexOf(e,l+1);if(-1==e){l=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();l.show({title:esri.i18nBundle.common.errorTitle,message:esri.i18nBundle.viewer.fileImport.noRecords});return}m=b.trim(c.substring(l+
1,e));c=c.substring(l+1)}var h=g||arcgisonline.map.fileImport.getSeparator(m),n=new H.data.CsvStore({data:c,separator:h});n.fetch({start:0,onComplete:function(e,l){if(0==e.length){if(" "===h)return arcgisonline.map.fileImport.processCsvData(c,d,f,k,a,","),!0;var p=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();p.show({title:esri.i18nBundle.common.errorTitle,message:esri.i18nBundle.viewer.fileImport.noRecords});return!0}var m,v,p=n._attributes;if(!k||!a){if(b.forEach(p,
function(a){var c;c=b.indexOf(arcgisonline.map.fileImport.latFieldStrings,a.toLowerCase());-1!==c&&(m=a);c=b.indexOf(arcgisonline.map.fileImport.longFieldStrings,a.toLowerCase());-1!==c&&(v=a)},this),!m||!v){if(" "===h)return arcgisonline.map.fileImport.processCsvData(c,d,f,k,a,","),!0;var p=esriGeowConfig.self.helperServices.geocode,p=arcgisonline.sharing.util.filterBatchGeocoders(p),z=!1,I=-1;if(p&&p.length)for(var x=0;x<p.length&&!(z=arcgisonline.sharing.util.isEsriWorldGeocoder(p[x].url),I=x,
z);x++);if(!arcgisonline.map.role.isAllowed("can_esri_batch_geocoding")&&z&&(p.splice(I,1),!p.length))return setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:b.string.substitute(esri.i18nBundle.viewer.fileImport.geocodingNotAllowed,{fileName:d})})},1),!0;if(!p||!p.length)return(p=esriGeowConfig.userRole)&&esriGeowConfig.userRole.canCreateItem(),z=p&&esriGeowConfig.userRole.canUseGeocode(),
p=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),p.show({title:esri.i18nBundle.common.errorTitle,message:z?esri.i18nBundle.common.errors.noBatchGeocoding:b.string.substitute(esri.i18nBundle.viewer.fileImport.geocodingNotAllowed,{fileName:d})}),!0;!1===esriGeowConfig.self.supportsHostedServices||esriGeowConfig.self.isPortal&&(!p||1>p.length)?setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:b.string.substitute(esri.i18nBundle.viewer.fileImport.fileCannotBeAddedToPortal,{fileName:d})})},1):arcgisonline.map.fileImport.callAnalyze(c,e.length,b.hitch(this,function(a,b){if(b&&esriGeowConfig.self.isPortal&&"address"==a.publishParameters.locationType){var g=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();g.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.common.errors.noBatchGeocoding});return!0}var g=(new P.Dialog).placeAt(document.body),
k=new arcgisonline.sharing.dijit.dialog.CsvLocationDlg({dialog:g});g.set({title:esri.i18nBundle.CsvLocationDlg.title,content:k});g.show();k.start(c,d,f,e.length,a)}),b.hitch(this,function(a){console.log(a);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.CsvLocationDlg.error.general+(a&&a.message?" ("+a.message+")":"")})}));return!0}}else m=k,v=a;var M=[],B="";b.forEach(n._attributes,function(a,
c){-1==b.indexOf(M,a)?M.push(a):(B.length&&(B+=", "),B+=a)});if(B.length)return setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.common.errorTitle,message:b.string.substitute(esri.i18nBundle.viewer.fileImport.duplicateFieldNames,{fieldNames:B})})},1),!0;var p=0,C=arcgisonline.map.fileImport.generateFeatureCollectionTemplateCsv(n,e,m,v,f),N=[],E=[],z=C.layerDefinition.fields,q={};b.forEach(z,function(a,b){"esriFieldTypeDate"===
a.type?N.push(a.name):("esriFieldTypeDouble"===a.type||"esriFieldTypeInteger"===a.type)&&E.push(a.name);q[a.alias]=a});for(var I=e.length,A=C.featureSet.features,K=!1,x=0;x<I;x++){var G=e[x],r={},s,t,H=/[.,]/,F,O,L,w=n.getAttributes(G);b.forEach(w,function(a,c){if(a){var e=a;0===a.length&&b.forEach(C.layerDefinition.fields,function(b,c){b.name==="attribute_"+(c-1)&&(a="attribute_"+(c-1))});if(b.some(N,function(b){return b===q[a].name}))s=n.getValue(G,e),L=new Date(s),r[q[a].name]=arcgisonline.map.fileImport.isValidDate(L,
s)?L.getTime():null;else if(b.some(E,function(b,c){O=c;return b===q[a].name})){(s=n.getValue(G,e))&&(s=b.trim(s));t=q[a];if(!t._final&&"esriFieldTypeInteger"===t.type)if(H.test(s)||2147483647<s||-2147483648>s)t.type="esriFieldTypeDouble",t._final=1;else if(0===s.indexOf("0")&&1!==s.length){t.type="esriFieldTypeString";t.length=255;t._final=1;E.splice(O,1);for(F=0;F<x;F++)A[F]&&(A[F].attributes[q[a].name]+="");r[q[a].name]=s;return}var d=function(a,c,d,f,g){a.type="esriFieldTypeString";a.length=255;
b.forEach(c,function(b){b.attributes[a.name]=""+b.attributes[a.name]});d.splice(b.indexOf(d,a.name),1);f[a.name]=g.getValue(G,e)},f=s;s=b.number.parse(s);isNaN(s)?-1<f.indexOf("E")?(s=Number(f),isNaN(s)?-1<f.indexOf(",")?(f=f.replace(",","."),s=Number(f),isNaN(s)?d(t,A,E,r,n):r[q[a].name]=s):d(t,A,E,r,n):r[q[a].name]=s):d(t,A,E,r,n):r[q[a].name]=s}else r[q[a].name]=n.getValue(G,e),t=q[a],r[q[a].name].length>t.length&&(t.length=2*(t.length+1)-1);void 0===r[q[a].name]&&(r[q[a].name]=null)}});r.__OBJECTID=
p;p++;var w=r[q[m].name],y=r[q[v].name];"string"==typeof w&&(w=b.number.parse(r[q[m].name]));"string"==typeof y&&(y=b.number.parse(r[q[v].name]));if(isNaN(w)||91<Math.abs(w))w=parseFloat(r[q[m].name]),r[q[m].name]=w;if(isNaN(y)||181<Math.abs(y))y=parseFloat(r[q[v].name]),r[q[v].name]=y;b.forEach(C.layerDefinition.fields,function(a,b){if("esriFieldTypeString"==a.type&&(a.alias===m||a.alias===v))a.type="esriFieldTypeDouble",delete a.length});null==y||null==w||isNaN(w)||isNaN(y)?K=!0:(b.forEach(z,function(a){void 0===
r[a.name]&&(r[a.name]=null)},this),A.push({geometry:{x:y,y:w,spatialReference:{wkid:4326}},attributes:r}))}if(0===A.length)p=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),p.show({title:esri.i18nBundle.common.errorTitle,message:esri.i18nBundle.viewer.fileImport.noRecords});else{var J=d?d.substring(0,d.indexOf(".")):"CSV";0==J.length&&d&&(J=d);C.layerDefinition.name=J;arcgisonline.map.featColl.projectFeatureSet(C,new esri.SpatialReference({wkid:4326}),b.hitch(this,function(a){var c=
[102113,102100,3857],d=arcgisonline.map.main.map.spatialReference.wkid;esri.isDefined(d)&&arcgisonline.map.main.contains(c,d)&&arcgisonline.map.featColl.roundFeatureSetCoordinates(a);var e={layer:null,id:"csv_"+Math.floor(10001*Math.random()),type:"user",subType:"csv",title:J,defaultVisibility:!0,defaultOpacity:1,snippet:"",showLegend:!0,identify:!1,__createDefaultPopup:!0};e.locationInfo={locationType:"coordinates",latitudeFieldName:m,longitudeFieldName:v};f&&0<f.length&&(e.url=f);c=arcgisonline.map.layer.getLayerPosition(e);
arcgisonline.map.main.mapLayers.splice(c.list,0,e);c=c.map;d=arcgisonline.map.featColl.generateDefaultPopupInfo(C);e.layer=e.url?new esri.layers.CSVLayer(e.url,{infoTemplate:new esri.dijit.PopupTemplate(d),id:e.id,outFields:["*"],visible:!0,opacity:1,displayOnPan:9>b.isIE?!1:!0,columnDelimiter:g,latitudeFieldName:m,longitudeFieldName:v,layerDefinition:a.layerDefinition}):new esri.layers.FeatureLayer(a,{infoTemplate:new esri.dijit.PopupTemplate(d),id:e.id,outFields:["*"],visible:!0,opacity:1,displayOnPan:9>
b.isIE?!1:!0});a=esri.styles.basic.getSchemes({theme:"default",basemap:arcgisonline.map.fileImport.getBasemapType(),geometryType:"esriGeometryPoint"}).primaryScheme;var k=new esri.symbols.SimpleMarkerSymbol;k.setColor(a.color);k.size=a.size;k.outline.setColor(a.outline.color);k.outline.width=a.outline.width;a=new esri.renderers.SimpleRenderer(k);e.layer.setRenderer(a);e.onError=b.connect(e.layer,"onError",b.hitch(arcgisonline.map.layer,"layerOnErrorHandler",e));e.popupInfo=d;e.columnDelimiter=h;arcgisonline.map.popup.setupPopupHandler();
arcgisonline.map.main.map.addLayer(e.layer,c);var l=function(a,b){b&&arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.viewer.fileImport.warningTitle,message:esri.i18nBundle.viewer.fileImport.invalidChars});arcgisonline.map.main.mapInitialized||arcgisonline.map.main.initMap();arcgisonline.map.main.checkSuggestedScaleRangeAndZoom(a);0===arcgisonline.map.leftPanel.getLeftContentPanelStack().indexOf("renderer")&&-1<arcgisonline.map.leftPanel.getLeftContentPanelStack().indexOf("Stack")&&
arcgisonline.map.leftPanel.openLeftAboutPanel();arcgisonline.map.leftPanel.openLeftRendererPanel(a.id,-1,!0,!0,!0);arcgisonline.map.main.markMapAsChanged("processCsvData")};e.layer.loaded?l(e,K):b.connect(e.layer,"onLoad",function(a){l(e,K)})}))}},onError:function(a){console.error("Error fetching items from CSV store: ",a)}});return!0}},generateFeatureCollectionTemplateCsv:function(c,d,f,k,a){var g={layerDefinition:null,featureSet:{features:[],geometryType:"esriGeometryPoint"},layerDefinition:{geometryType:"esriGeometryPoint",
objectIdField:"__OBJECTID",type:"Feature Layer",typeIdField:"",drawingInfo:{renderer:{type:"simple",symbol:{color:[77,77,77,255],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,255],width:0.75,type:"esriSLS",style:"esriSLSSolid"}}},fixedSymbols:!0},fields:[{name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,nullable:!1,domain:null}],types:[],capabilities:"Query"}};b.forEach(c._attributes,function(b,l){for(var m=c.getValue(d[0],
b),h=1;!esri.isDefined(m)&&d.length>h;)m=c.getValue(d[h],b),h++;0===b.length&&(b="attribute_"+l);h="string";esri.isDefined(m)&&(h=arcgisonline.map.fileImport._getTypeOfValue(m,b,f,k));"int"===h?g.layerDefinition.fields.push({name:a&&a.length?b:b.replace(/\s+/g,"_").replace(/\'/g,"_"),alias:b,type:"esriFieldTypeInteger",editable:!0,nullable:!0,domain:null}):"double"===h?g.layerDefinition.fields.push({name:a&&a.length?b:b.replace(/\s+/g,"_").replace(/\'/g,"_"),alias:b,type:"esriFieldTypeDouble",editable:!0,
nullable:!0,domain:null}):"date"===h?g.layerDefinition.fields.push({name:a&&a.length?b:b.replace(/\s+/g,"_").replace(/\'/g,"_"),alias:b,type:"esriFieldTypeDate",length:36,editable:!0,nullable:!0,domain:null}):g.layerDefinition.fields.push({name:a&&a.length?b:b.replace(/\s+/g,"_").replace(/\'/g,"_"),alias:b,type:"esriFieldTypeString",length:255,editable:!0,nullable:!0,domain:null})});return g},_getTypeOfValue:function(c,d,f,k){c&&(c=b.trim(c));var a=!1,a=/[^+-.,0-9]/;if(""===c||a.test(c))a=!0;else if(a=
b.number.parse(c),(d==f||d==k)&&181<Math.abs(a))a=!0;else if(isNaN(a))if(-1<c.indexOf("E"))if(a=Number(c),isNaN(a))if(-1<c.indexOf(","))if(c=c.replace(",","."),a=Number(c),isNaN(a))a=!0;else return"double";else a=!0;else return"double";else a=!0;else return/[.,]/.test(c)?"double":214783647<c||-214783648>c?"double":"int";return a&&!/^[-]?\d*[.,]?\d*$/.test(c)&&arcgisonline.map.fileImport.isValidDate(new Date(c),c)?"date":"string"},processGpxData:function(c,d){var f=H.xml.parser.parse(c),k=b.query("wpt",
f),a=b.query("trk",f),g=b.query("rte",f),e=0;k&&0<k.length&&(e=1);a&&0<a.length&&(e+=2*a.length);g&&0<g.length&&(e+=2*g.length);if(0===e)return console.log(f),k=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),(a=b.query("parsererror",f))&&0<a.length?k.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.fileImport.errorOccurred}):k.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.fileImport.noData}),!1;
var l={id:"gpx_"+Math.floor(10001*Math.random()),type:"user",subType:"gpx",title:d?d.substring(0,d.indexOf(".")):"GPX",defaultVisibility:!0,defaultOpacity:1,snippet:"",showLegend:!0,visibility:!0,identify:!1,layers:1===e?null:[],visibleLayers:"",__createDefaultPopup:!0},f=arcgisonline.map.layer.getLayerPosition(l);arcgisonline.map.main.mapLayers.splice(f.list,0,l);var m=f.map,f=0;g&&0<g.length&&(arcgisonline.map.fileImport.addRoutesToMap(g,l,f),f+=2*g.length);a&&0<a.length&&(arcgisonline.map.fileImport.addTracksToMap(a,
l,f),f+=2*a.length);k&&0<k.length&&(l.visibleLayers+=(l.visibleLayers.length?",":"")+f,arcgisonline.map.fileImport.addWayPointsToMap(k,l,"Waypoints",f,!0));var h=function(){1===e?arcgisonline.map.main.map.addLayer(l.layer,m):b.forEach(l.layers,function(a,b){arcgisonline.map.main.map.addLayer(a,m+b)});l.layer?arcgisonline.map.main.checkSuggestedScaleRangeAndZoom(l):arcgisonline.map.main.checkSuggestedScaleRange(l,!0).then(function(a){if(l.layers){var c=-1*Number.MAX_VALUE,d=Number.MAX_VALUE,e=-1*Number.MAX_VALUE,
f=Number.MAX_VALUE,g=-1*Number.MAX_VALUE,k=Number.MAX_VALUE;b.forEach(l.layers,b.hitch(this,function(a){var b=a.minScale||0,h=a.maxScale||0;"esriGeometryPoint"===a.geometryType||"esriGeometryMultipoint"==a.geometryType?(c=0===c||0===b?0:Math.max(c,b),d=Math.min(d,h)):-1<a.name.indexOf("Track ")?(e=0===e||0===b?0:Math.max(e,b),f=Math.min(f,h)):(g=0===g||0===b?0:Math.max(g,b),k=Math.min(k,h))}));c==-1*Number.MAX_VALUE&&(c=0);d==Number.MAX_VALUE&&(d=0);e==-1*Number.MAX_VALUE&&(e=0);f==Number.MAX_VALUE&&
(f=0);g==-1*Number.MAX_VALUE&&(g=0);k==Number.MAX_VALUE&&(k=0);var h,m;0<g?(h=g,m=k):0<c?(h=c,m=d):(h=e,m=f);b.forEach(l.layers,b.hitch(this,function(a){a.setScaleRange(h,m)}))}});"contentStack"!==arcgisonline.map.leftPanel.getLeftContentPanelStack()?arcgisonline.map.leftPanel.openLeftTOCPanel():b.publish("onLayerUpdate",[""]);arcgisonline.map.main.markMapAsChanged("processGpxData")},n=0,u=setInterval(b.hitch(this,function(){if(1===e)l.layer&&(clearInterval(u),h());else{var a=!0,b;for(b=0;b<l.layers.length;b++)if(!l.layers[b]){a=
!1;break}a&&(clearInterval(u),h())}n++;if(15<n&&(console.log("Not all layers for this GPX could get created."),clearInterval(u),1<e)){a=[];for(b=0;b<l.layers.length;b++)l.layers[b]&&a.push(l.layers[b]);a.length&&(l.layers=a,h())}}),1E3);return!0},addWayPointsToMap:function(c,d,f,k,a){var g=0,e=arcgisonline.map.fileImport.generateFeatureCollectionTemplateGpxWaypoint(c[0]),l=arcgisonline.map.featColl.generateDefaultPopupInfo(e),m=!0,h=b.number.parse(c[0].getAttribute("lon")),n=b.number.parse(c[0].getAttribute("lat"));
if(isNaN(n)||isNaN(h))m=!1;b.forEach(c,function(a){m?(h=b.number.parse(a.getAttribute("lon")),n=b.number.parse(a.getAttribute("lat"))):(n=parseFloat(a.getAttribute("lat")),h=parseFloat(a.getAttribute("lon")));if(!isNaN(n)&&!isNaN(h)){var c={};c.lat=n;c.lon=h;c.__OBJECTID=g;g++;var d=0;b.forEach(a.childNodes,function(a){if(1===a.nodeType&&"extensions"!==a.nodeName){var e=a.text?a.text:a.textContent;if("time"===a.nodeName){if(9>b.isIE){var e=e.replace(/\-/g,"/"),f=e.indexOf(":");-1<f&&(f=e.indexOf(":",
f+1),-1<f&&(e=e.substring(0,f+3)))}f=new Date(e);c[a.nodeName]=arcgisonline.map.fileImport.isValidDate(f,e)?f.getTime():null}else"ele"===a.nodeName||"geoidheight"===a.nodeName||"sat"===a.nodeName||"hdop"===a.nodeName||"vdop"===a.nodeName||"pdop"===a.nodeName||"ageofdgpsdata"===a.nodeName||"magvar"===a.nodeName||"dgpsid"===a.nodeName?(f=b.number.parse(e),isNaN(f)?(f=parseFloat(e),isNaN(f)?c[a.nodeName]=null:c[a.nodeName]=f):c[a.nodeName]=f):c[a.nodeName]=e;void 0===c[a.nodeName]&&(c[a.nodeName]=null);
d++}});a={geometry:(new esri.geometry.Point(h,n,new esri.SpatialReference({wkid:4326}))).toJson(),attributes:c};e.featureSet.features.push(a)}});e.layerDefinition.name=f;arcgisonline.map.featColl.projectFeatureSet(e,new esri.SpatialReference({wkid:4326}),b.hitch(this,function(c){var e=[102113,102100,3857],f=arcgisonline.map.main.map.spatialReference.wkid;esri.isDefined(f)&&arcgisonline.map.main.contains(e,f)&&arcgisonline.map.featColl.roundFeatureSetCoordinates(c);var g=new esri.layers.FeatureLayer(c,
{infoTemplate:new esri.dijit.PopupTemplate(l),id:d.id+(esri.isDefined(d.layers)?"_"+k:""),outFields:["*"],visible:a,opacity:1,displayOnPan:9>b.isIE?!1:!0});d.onError=b.connect(g,"onError",b.hitch(arcgisonline.map.layer,"layerOnErrorHandler",d));g.__popupInfo=l;if(b.some(g.fields,function(a){return"sym"===a.name})){var h=[];b.forEach(g.graphics,function(a){-1===b.indexOf(h,a.attributes.sym)&&h.push(a.attributes.sym)});esri.request({url:require.toUrl("arcgisonline/map/"+arcgisonline.map.fileImport.symbolJson),
load:function(a){var c=esri.renderer.fromJson(a.renderer),e=[],f=[];b.forEach(c.infos,function(a){-1===b.indexOf(h,a.value)?f.push(a.value):e.push(a.value)});b.forEach(f,function(a){c.removeValue(a)});b.forEach(h,function(a){-1===b.indexOf(e,a)&&c.addValue({value:a,label:a,description:"",symbol:c.defaultSymbol})});(esriGeowConfig.allSSL||"https:"==location.protocol)&&b.forEach(c.infos,function(a){a.symbol.url&&arcgisonline.sharing.util.supportsHttps(a.symbol.url)&&(a.symbol.url=a.symbol.url.replace("http:",
"https:"))});0<c.infos.length&&(g.setRenderer(c),g.refresh())},error:function(a){console.log("error: "+a)}})}d.layers?d.layers[k]=g:d.layer=g}))},addTracksToMap:function(c,d,f){var k=null,a=[],g;for(g=c.length-1;0<=g;g--){var e=c[g].getElementsByTagName("trkseg"),l=new esri.geometry.Polyline(new esri.SpatialReference({wkid:4326}));b.forEach(e,function(a){var c=[];a=b.query("trkpt",a);0<a.length&&(b.forEach(a,function(a){var e,f;if(null===k&&(k=!0,e=b.number.parse(a.getAttribute("lat")),f=b.number.parse(a.getAttribute("lon")),
isNaN(e)||isNaN(f)))k=!1;k?(e=b.number.parse(a.getAttribute("lat")),f=b.number.parse(a.getAttribute("lon"))):(e=parseFloat(a.getAttribute("lat")),f=parseFloat(a.getAttribute("lon")));!isNaN(e)&&!isNaN(f)&&(a=new esri.geometry.Point(f,e,new esri.SpatialReference({wkid:4326})),c.push(a))}),c=arcgisonline.map.fileImport.denormalize(c),l.addPath(c))});a[g]=l}g=esri.geometry.normalizeCentralMeridian(a,esri.config.defaults.geometryService);g.addCallback(b.hitch(this,function(a){arcgisonline.map.fileImport.addTracksToMap2(a,
c,d,f)}));g.addErrback(b.hitch(this,function(b){console.log("error when normalizing polylines: "+b);arcgisonline.map.fileImport.addTracksToMap2(a,c,d,f)}))},addTracksToMap2:function(c,d,f,k){var a;for(a=d.length-1;0<=a;a--){var g=arcgisonline.map.fileImport.generateFeatureCollectionTemplateGPXTrack(d[a]),e=arcgisonline.map.featColl.generateDefaultPopupInfo(g),l=d[a],m="Track"+(1<d.length?" "+(a+1):""),h=l.getElementsByTagName("name");h&&0<h.length&&(m=h[0].text?h[0].text:h[0].textContent);m||(m=h[0].text?
h[0].text:h[0].textContent?h[0].textContent:"Track"+(1<d.length?" "+(a+1):""));g.layerDefinition.name=m;var h=0,n={};b.mixin(n,arcgisonline.map.fileImport.generateAttributes(g,l));var u=l.getElementsByTagName("trkseg"),D=[];b.forEach(u,function(a){a=b.query("trkpt",a);0<a.length&&(D=D.concat(a))});n.__OBJECTID=h;h++;b.forEach(l.childNodes,function(a){if(1===a.nodeType&&"extensions"!==a.nodeName){var b=a.text?a.text:a.textContent;"number"===a.nodeName&&(n[a.nodeName]=parseInt(b))}});l={geometry:c[a].toJson(),
attributes:n};g.featureSet.features.push(l);arcgisonline.map.featColl.projectFeatureSet(g,new esri.SpatialReference({wkid:4326}),b.hitch(this,function(a,c,d,g){var k=[102113,102100,3857],h=arcgisonline.map.main.map.spatialReference.wkid;esri.isDefined(h)&&arcgisonline.map.main.contains(k,h)&&arcgisonline.map.featColl.roundFeatureSetCoordinates(g);f.visibleLayers+=(f.visibleLayers.length?",":"")+a;g=new esri.layers.FeatureLayer(g,{infoTemplate:new esri.dijit.PopupTemplate(e),id:f.id+(esri.isDefined(f.layers)?
"_"+a:""),outFields:["*"],visible:!0,opacity:1,displayOnPan:9>b.isIE?!1:!0});f.onError=b.connect(g,"onError",b.hitch(arcgisonline.map.layer,"layerOnErrorHandler",f));g.__popupInfo=e;f.layers?f.layers[a]=g:f.layer=g;c&&0<c.length&&arcgisonline.map.fileImport.addWayPointsToMap(c,f,d+" - Trackpoints",a+1,!1)},k,D,m));k+=2}},addRoutesToMap:function(c,d,f){var k=null,a=[],g;for(g=c.length-1;0<=g;g--){var e=c[g],l=new esri.geometry.Polyline(new esri.SpatialReference({wkid:4326})),m=[],e=b.query("rtept",
e);b.forEach(e,function(a){var c,e;if(null===k&&(k=!0,c=b.number.parse(a.getAttribute("lat")),e=b.number.parse(a.getAttribute("lon")),isNaN(c)||isNaN(e)))k=!1;k?(c=b.number.parse(a.getAttribute("lat")),e=b.number.parse(a.getAttribute("lon"))):(c=parseFloat(a.getAttribute("lat")),e=parseFloat(a.getAttribute("lon")));!isNaN(c)&&!isNaN(e)&&(a=new esri.geometry.Point(e,c,new esri.SpatialReference({wkid:4326})),m.push(a))});m=arcgisonline.map.fileImport.denormalize(m);l.addPath(m);a[g]=l}g=esri.geometry.normalizeCentralMeridian(a,
esri.config.defaults.geometryService);g.addCallback(b.hitch(this,function(a){arcgisonline.map.fileImport.addRoutesToMap2(a,c,d,f)}));g.addErrback(b.hitch(this,function(b){console.log("error when normalizing polylines: "+b);arcgisonline.map.fileImport.addRoutesToMap2(a,c,d,f)}))},addRoutesToMap2:function(c,d,f,k){var a;for(a=d.length-1;0<=a;a--){var g=arcgisonline.map.fileImport.generateFeatureCollectionTemplateGPXRoute(d[a]),e=arcgisonline.map.featColl.generateDefaultPopupInfo(g),l=d[a],m=b.query("rtept",
l),h="Route"+(1<d.length?" "+(a+1):""),n=l.getElementsByTagName("name");n&&0<n.length&&(h=n[0].text?n[0].text:n[0].textContent);h||(h=n[0].text?n[0].text:n[0].textContent?n[0].textContent:"Route"+(1<d.length?" "+(a+1):""));g.layerDefinition.name=h;var n=0,u={};b.mixin(u,arcgisonline.map.fileImport.generateAttributes(g,l));u.__OBJECTID=n;n++;b.forEach(l.childNodes,function(a){if(1===a.nodeType&&"extensions"!==a.nodeName){var b=a.text?a.text:a.textContent;"number"===a.nodeName&&(u[a.nodeName]=parseInt(b))}});
l={geometry:c[a].toJson(),attributes:u};g.featureSet.features.push(l);arcgisonline.map.featColl.projectFeatureSet(g,new esri.SpatialReference({wkid:4326}),b.hitch(this,function(a,c,d,g){var k=[102113,102100,3857],h=arcgisonline.map.main.map.spatialReference.wkid;esri.isDefined(h)&&arcgisonline.map.main.contains(k,h)&&arcgisonline.map.featColl.roundFeatureSetCoordinates(g);f.visibleLayers+=(f.visibleLayers.length?",":"")+a;g=new esri.layers.FeatureLayer(g,{infoTemplate:new esri.dijit.PopupTemplate(e),
id:f.id+(esri.isDefined(f.layers)?"_"+a:""),outFields:["*"],visible:!0,opacity:1,displayOnPan:9>b.isIE?!1:!0});f.onError=b.connect(g,"onError",b.hitch(arcgisonline.map.layer,"layerOnErrorHandler",f));g.__popupInfo=e;f.layers?f.layers[a]=g:f.layer=g;c&&0<c.length&&arcgisonline.map.fileImport.addWayPointsToMap(c,f,d+" - Routepoints",a+1,!1)},k,m,h));k+=2}},generateFeatureCollectionTemplateGpxWaypoint:function(c){var d={layerDefinition:null,featureSet:{features:[],geometryType:"esriGeometryPoint"}};
d.layerDefinition={geometryType:"esriGeometryPoint",objectIdField:"__OBJECTID",type:"Feature Layer",typeIdField:"",drawingInfo:{renderer:{type:"simple",symbol:{type:"esriPMS",width:12,height:12,url:arcgisonline.sharing.util.getStaticImagesUrl()+"/Symbols/Basic/BlackWaypoint.png",imageData:"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\x3d\x3d",
contentType:"image/png",angle:0,xoffset:0,yoffset:0}},fixedSymbols:!0},fields:[{name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,nullable:!1,domain:null},{name:"lat",alias:"Latitude",type:"esriFieldTypeDouble",editable:!0,nullable:!0,domain:null},{name:"lon",alias:"Longitude",type:"esriFieldTypeDouble",editable:!0,nullable:!0,domain:null}],types:[],capabilities:"Query"};var f=[];b.forEach(c.childNodes,function(a){var c=b.some(f,function(b){return b===a.nodeName});1===a.nodeType&&
(!c&&"extensions"!==a.nodeName)&&f.push(a.nodeName)});var k={sat:"Number of satellites",ageofdgpsdata:"Time since last DGPS fix",ele:"Elevation",geoidheight:"Geoid height",hdop:"HDOP",vdop:"VDOP",time:"Time",name:"Name",cmt:"Comment",desc:"Description",src:"Source",link:"Link",sym:"Symbol",type:"Type",magvar:"Magnetic variation",url:"Link",urlname:"Link text",fix:"Type of GPS fix",pdop:"PDOP",dgpsid:"DGPS station ID"};b.forEach(f,function(a){("sat"===a||"ageofdgpsdata"===a||"dgpsid"===a)&&d.layerDefinition.fields.push({name:a,
alias:k[a],type:"esriFieldTypeInteger",editable:!0,nullable:!0,domain:null});("ele"===a||"geoidheight"===a||"hdop"===a||"vdop"===a||"pdop"===a||"magvar"===a)&&d.layerDefinition.fields.push({name:a,alias:k[a],type:"esriFieldTypeDouble",editable:!0,nullable:!0,domain:null});"time"===a&&d.layerDefinition.fields.push({name:"time",alias:k[a],type:"esriFieldTypeDate",length:36,editable:!0,nullable:!0,domain:null});("name"===a||"cmt"===a||"desc"===a||"src"===a||"link"===a||"sym"===a||"type"===a||"url"===
a||"urlname"===a||"fix"===a)&&d.layerDefinition.fields.push({name:a,alias:k[a],type:"esriFieldTypeString",length:255,editable:!0,nullable:!0,domain:null})});return d},generateFeatureCollectionTemplateGPXTrack:function(c){var d={layerDefinition:null,featureSet:{features:[],geometryType:"esriGeometryPolyline"},layerDefinition:{geometryType:"esriGeometryPolyline",objectIdField:"__OBJECTID",type:"Feature Layer",typeIdField:"",drawingInfo:{renderer:{type:"simple",symbol:{type:"esriSLS",style:"esriSLSSolid",
color:[136,69,19,255],width:3},label:"",description:""},transparency:0,labelingInfo:null,fixedSymbols:!0},fields:[{name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,nullable:!1,domain:null}],types:[],capabilities:"Query"}},f=[];b.forEach(c.childNodes,function(a){var c=b.some(f,function(b){return b===a.nodeName});1===a.nodeType&&(!c&&"extensions"!==a.nodeName)&&f.push(a.nodeName)});var k={name:"Name",cmt:"Comment",desc:"Description",src:"Source",link:"Link",url:"Link",urlname:"Link text",
number:"GPS track"};b.forEach(f,function(a){"number"===a&&d.layerDefinition.fields.push({name:a,alias:k[a],type:"esriFieldTypeInteger",editable:!0,nullable:!0,domain:null});("name"===a||"cmt"===a||"desc"===a||"src"===a||"link"===a||"url"===a||"urlname"===a)&&d.layerDefinition.fields.push({name:a,alias:k[a],type:"esriFieldTypeString",length:255,editable:!0,nullable:!0,domain:null})});return d},generateFeatureCollectionTemplateGPXRoute:function(c){var d={layerDefinition:null,featureSet:{features:[],
geometryType:"esriGeometryPolyline"},layerDefinition:{geometryType:"esriGeometryPolyline",objectIdField:"__OBJECTID",type:"Feature Layer",typeIdField:"",drawingInfo:{renderer:{type:"simple",symbol:{type:"esriSLS",style:"esriSLSSolid",color:[136,69,19,255],width:3},label:"",description:""},transparency:0,labelingInfo:null,fixedSymbols:!0},fields:[{name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,nullable:!1,domain:null}],types:[],capabilities:"Query"}},f=[];b.forEach(c.childNodes,
function(a){var c=b.some(f,function(b){return b===a.nodeName});1===a.nodeType&&(!c&&"extensions"!==a.nodeName)&&f.push(a.nodeName)});var k={name:"Name",cmt:"Comment",desc:"Description",src:"Source",link:"Link",url:"Link",urlname:"Link text",number:"GPS route"};b.forEach(f,function(a){"number"===a&&d.layerDefinition.fields.push({name:a,alias:k[a],type:"esriFieldTypeInteger",editable:!0,nullable:!0,domain:null});("name"===a||"cmt"===a||"desc"===a||"src"===a||"link"===a||"url"===a||"urlname"===a)&&d.layerDefinition.fields.push({name:a,
alias:k[a],type:"esriFieldTypeString",length:255,editable:!0,nullable:!0,domain:null})});return d},generateAttributes:function(c,d){var f={};b.forEach(d.childNodes,function(d){if(1===d.nodeType&&"extensions"!==d.nodeName){var a=d.text?d.text:d.textContent;"time"===d.nodeName?f[d.nodeName]=(new Date(a)).getTime():"link"===d.nodeName?d.attributes.href&&(f.link=d.attributes.href.nodeValue):b.some(c.layerDefinition.fields,function(c){c.name===d.nodeName&&("esriFieldTypeDouble"===c.type?(c=b.number.parse(a),
isNaN(c)?f[d.nodeName]=null:f[d.nodeName]=c):f[d.nodeName]=a)});void 0===f[d.nodeName]&&(f[d.nodeName]=null)}});return f},processShapefile:function(c,d,f){var k=Math.floor(10001*Math.random());c={id:c+"_"+k,type:"user",subType:"shapefile",title:c,defaultVisibility:!0,defaultOpacity:1,visibility:!0,defaultOpacity:1,snippet:"",showLegend:!0,identify:!1,layers:1===d.layers.length?null:[],__createDefaultPopup:!0};k=arcgisonline.map.layer.getLayerPosition(c);arcgisonline.map.main.mapLayers.splice(k.list,
0,c);for(var k=k.map,a,g=[],e=[],l=[],m=0;m<d.layers.length;m++)switch(d.layers[m].layerDefinition.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":g.push(d.layers[m]);break;case "esriGeometryPolyline":e.push(d.layers[m]);break;case "esriGeometryPolygon":l.push(d.layers[m])}d.layers=l.concat(e,g);for(m=0;m<d.layers.length;m++){g=d.layers[m];e=g.layerDefinition.capabilities.split(",");e=b.filter(e,function(a){return-1<a.indexOf("Editing")||-1<a.indexOf("Create")||-1<a.indexOf("Update")||
-1<a.indexOf("Delete")?!1:!0});g.layerDefinition.capabilities=e.toString();g.layerDefinition.drawingInfo.fixedSymbols=!0;e=arcgisonline.map.featColl.generateDefaultPopupInfo(g);g=new esri.layers.FeatureLayer(g,{infoTemplate:new esri.dijit.PopupTemplate(e),id:c.id+(1<d.layers.length?"_"+m:""),outFields:["*"],visible:!0,opacity:1,displayOnPan:9>b.isIE?!1:!0});c.onError=b.connect(g,"onError",b.hitch(arcgisonline.map.layer,"layerOnErrorHandler",c));1==d.layers.length?(c.layer=g,c.popupInfo=e):(c.layers.push(g),
g.__popupInfo=e);g.fullExtent=arcgisonline.map.featColl.getFullExtent(c);a=a?a.union(g.fullExtent):new esri.geometry.Extent(g.fullExtent.toJson());arcgisonline.map.main.checkSuggestedScaleRangeAndZoom(c);var e=esri.styles.basic.getSchemes({theme:"default",basemap:arcgisonline.map.fileImport.getBasemapType(),geometryType:g.geometryType}).primaryScheme,h;"esriGeometryPoint"===g.geometryType||"esriGeometryMultipoint"===g.geometryType?(h=new esri.symbols.SimpleMarkerSymbol,h.setColor(e.color),h.size=
e.size,h.outline.setColor(e.outline.color),h.outline.width=e.outline.width):"esriGeometryPolyline"===g.geometryType?(h=new esri.symbols.SimpleLineSymbol,h.setColor(e.color),h.width=e.width):"esriGeometryPolygon"===g.geometryType&&(h=new esri.symbols.SimpleFillSymbol,h.setColor(e.color),h.outline.setColor(e.outline.color),h.outline.width=e.outline.width);e=new esri.renderers.SimpleRenderer(h);g.setRenderer(e);arcgisonline.map.main.map.addLayer(g,k+m)}arcgisonline.map.main.zoomMapConsiderScale(c,a);
arcgisonline.map.popup.setupPopupHandler();0===arcgisonline.map.leftPanel.getLeftContentPanelStack().indexOf("renderer")&&-1<arcgisonline.map.leftPanel.getLeftContentPanelStack().indexOf("Stack")&&arcgisonline.map.leftPanel.openLeftAboutPanel();arcgisonline.map.leftPanel.openLeftRendererPanel(c.id,0,!0,!0,!0);b.publish("onLayerUpdate",[""]);arcgisonline.map.main.markMapAsChanged("processShapefile");f()},callAnalyze:function(c,d,f,k){var a=!0,g="arcgis/rest/services/World/GeocodeServer",e=esriGeowConfig.self||
{},l=(e.user||{}).region||e.ipCntryCode||"",e=(e=e.helperServices)&&e.geocode,l=l&&"wo"===l.toLowerCase()?"world":l,e=arcgisonline.sharing.util.filterBatchGeocoders(e);if(!arcgisonline.map.role.isAllowed("can_esri_batch_geocoding")){var m=-1;if(e&&e.length)for(var h=0;h<e.length&&!(isWorldGeocodeServer=arcgisonline.sharing.util.isEsriWorldGeocoder(e[h].url),m=h,isWorldGeocodeServer);h++);isWorldGeocodeServer&&e.splice(m,1)}e&&e.length&&(g=e[0].url,a=-1!==g.indexOf("arcgis/rest/services/World/GeocodeServer"));
if(10<d){for(e=d=0;-1<d&&10>=e;)e++,d=c.indexOf("\n",d+1);if(-1==d){c=c.replace(/\r/g,"\n");for(e=d=0;-1<d&&10>=e;)e++,d=c.indexOf("\n",d+1)}c=c.substring(0,d)}d=esriGeowConfig.restBaseUrl+(esriGeowConfig.restBaseUrl.lastIndexOf("/")===esriGeowConfig.restBaseUrl.length-1?"":"/");d+="content/features/analyze";(e=arcgisonline.sharing.util.getToken())&&(d+="?token\x3d"+e);e={enableGlobalGeocoding:!0,sourceLocale:b.locale};esriGeowConfig.self.isPortal&&(e.geocodeServiceUrl=g);a&&(e.sourceCountry="",e.sourceCountryHint=
l.toLowerCase());return esri.request({url:d,content:{filetype:"csv",text:c,analyzeParameters:b.json.stringify(e),f:"json"},callbackParamName:"callback"},{usePost:!0}).then(b.hitch(this,function(b){return b.error?k(b.error):f(b,a)}),b.hitch(this,function(a){k(a)}))},denormalize:function(b){var d=esri.geometry.getLength,f=esri.geometry.geodesicLengths,k=esri.geometry.geographicToWebMercator,a=b.length,g=b[0],e=0>g.x?-1:1,l;for(l=1;l<a;l++){var m=b[l],h=0>m.x?-1:1,n=0>g.x?-1:1,u;n!==h?u=n:e!==h&&(u=
e);if(u){for(;360<Math.abs(g.x-m.x);)m.x=0>n?m.x-360:m.x+360;var h=k(g),D=d(h,k(m));f([{paths:[[[g.x,g.y],[m.x,m.y]]]}],"esriMeters")[0]<D&&(g=0>n?m.x-360:m.x+360,d(h,k(new esri.geometry.Point(g,m.y)))<=D&&(e=0>m.x?-1:1,m.x=g))}g=m}return b},getBasemapType:function(){var b=arcgisonline.map.main.map.getLayer(arcgisonline.map.main.map.layerIds[0]);if(!b.url)return"topo";b=b.url.toLowerCase();if(-1<b.indexOf("arcgis/rest/services/world_street_map"))return"streets";if(-1<b.indexOf("arcgis/rest/services/canvas/world_light_gray_base"))return"gray";
if(!(-1<b.indexOf("arcgis/rest/services/world_topo_map")||-1<b.indexOf("arcgis/rest/services/usgstopo"))){if(-1<b.indexOf("arcgis/rest/services/world_terrain_base"))return"terrain";if(-1<b.indexOf("arcgis/rest/services/natgeo_world_map"))return"national-geographic";if(-1<b.indexOf("arcgis/rest/services/ocean_basemap"))return"oceans";if(-1<b.indexOf("arcgis/rest/services/world_imagery"))return"satellite";if(-1<b.indexOf("arcgis/rest/services/reference/world_boundaries_and_places"))return"hybrid";if(-1<
b.indexOf("arcgis/rest/services/canvas/world_dark_gray_base"))return"dark-gray";if(!b&&"esri.layers.OpenStreetMapLayer"===arcgisonline.map.main.map.getLayer(arcgisonline.map.main.map.layerIds[0]).declaredClass)return"osm"}return"topo"},getSeparator:function(c){var d=0,f="";b.forEach([","," ",";","|","\t"],function(b){var a=c.split(b).length;a>d&&(d=a,f=b)});return f},isValidDate:function(c,d){if(!c||"[object Date]"!==Object.prototype.toString.call(c)||isNaN(c.getTime()))return!1;var f=!0;if(b.isChrome&&
/\d+\W*$/.test(d)){var k=d.match(/[a-zA-Z]{2,}/);if(k){for(var f=!1,a=0,g=k.length,e=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;!f&&a<=g&&!(f=!e.test(k[a]));)a++;f=!f}}return f},contains:function(b,d){var f;for(f=0;f<d.length;f++)if(d[f]===b)return!0;return!1}}});