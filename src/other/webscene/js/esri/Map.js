// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("dojo/_base/lang ./core/declare dojo/Deferred ./geometry/Extent ./geometry/SpatialReference ./geometry/support/webMercatorUtils ./core/Accessor ./core/Evented ./core/Promise ./LayersMixin ./BasemapMixin".split(" "),function(g,h,k,l,m,f,n,p,q,r,s){return h([n,p,q,r,s],{declaredClass:"esri.Map",classMetadata:{properties:{extent:{type:l},spatialReference:{type:m}}},constructor:function(a){this._loadPromises={};this._loadHandler=this._loadHandler.bind(this);this._loadErrorHandler=this._loadErrorHandler.bind(this);
this.watch("basemap",this._basemapWatcher.bind(this));this._loadingPromise=new k;this.addResolvingPromise(this._loadingPromise.promise)},getDefaults:function(){return g.mixin(this.inherited(arguments),{loaded:!1,visible:!0})},destroy:function(){this.emit("destroy")},_loadingPromise:null,loaded:!1,layerAdded:function(a){this._loadPromises[a.id]=a.then(this._loadHandler)},layerRemoved:function(a){var b=this._loadPromises[a.id];b&&(b.cancel(),delete this._loadPromises[a.id])},_computeInitialState:function(){var a=
this.basemap||this.layers.getItemAt(0),b=a.initialExtent||a.fullExtent,c=this.extent;if(!this.spatialReference){var d=a.spatialReference,e=c&&c.spatialReference;if(e&&!e.equals(d)&&(a.tileInfo||!a.url))e=null;this.spatialReference=(d=e||d)&&d.clone()}c&&(c=this._projectGeometry(c,d));c=c||b&&b.clone();if(!c)return"[Map] Unable to calculate initial extent";this.extent=c},_projectGeometry:function(a,b){var c=a&&a.spatialReference;b&&(c&&!b.equals(c))&&(b._canProject(c)?b.isWebMercator()?a=f.geographicToWebMercator(a):
4326===b.wkid&&(a=f.webMercatorToGeographic(a,!0)):(console.log('[Map] Cannot project geometry from spatial reference: "${from}" to: "${to}"',c.wkid||c.wkt,b.wkid||b.wkt),a=null));return a},_basemapWatcher:function(a,b){b&&this._loadPromises[b.id]&&(this._loadPromises[b.id].cancel(),delete this._loadPromises[b.id]);a&&!this.isResolved()&&(this._loadPromises[a.id]=a.then(this._loadHandler,this._loadErrorHandler),a.load())},_loadHandler:function(a){delete this._loadPromises[a.id];if(!this.loaded&&(a===
this.basemap||!this.basemap&&0===this.layers.indexOf(a)))(a=this._computeInitialState())?this.reject(Error(a)):(this.loaded=!0,this.emit("load"),this._loadingPromise.resolve(this))},_loadErrorHandler:function(a){console.error(a)}})});