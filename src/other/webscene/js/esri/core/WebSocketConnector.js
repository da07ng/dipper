// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("./declare dojo/_base/lang dojo/io-query dojo/Deferred ../core/Accessor ../core/Evented ../core/Promise".split(" "),function(e,d,f,g,h,k,l){var c={STATUS_CONNECTED:0,STATUS_DISCONNECTED:1,STATUS_CONNECTING:2,STATUS_RECONNECTING:3,STATUS_DISCONNECTING:4};e=e([h,k,l],{classMetadata:{properties:{connectionInfo:{dependsOn:["socketUrls","queryParams"],readOnly:!0},status:{readOnly:!0}}},constructor:function(a){this.watch("maxReconnectAttempts",function(a){a<this._reconnectAttempts&&this.disconnect()}.bind(this))},
normalizeCtorArgs:function(a){a=a||{};"string"===typeof a?a={socketUrls:[a]}:Array.isArray(a)&&(a={socketUrls:a});return a},getDefaults:function(a){var b=this.inherited(arguments);return d.mixin(b||{},{socketUrls:[]})},initialize:function(){var a=null;this.socketUrls.length||(a=Error("No urls passed to WebSocketConnector. No live connection possible"));"WebSocket"in window||(a=Error("The browser does not support Web Sockets. No live connection possible"));if(a){var b=new g;this.addResolvingPromise(b.promise);
b.reject(a)}},_reconnectAttempts:0,_reconnectTimeoutId:null,_socket:null,_socketUrl:null,_connectionInfoGetter:function(){return{socketUrls:this.socketUrls,queryParams:this.queryParams}},_maxReconnectAttemptsSetter:function(a){return a||10},socketUrls:null,_status:c.STATUS_DISCONNECTED,_statusGetter:function(){return this._status},connect:function(){if(this._socket&&this._status!==c.STATUS_DISCONNECTED)console.log("Already connected. No need to do anything");else{var a=this._makeCurrentUrl(),a=new WebSocket(a);
this._changeSocketStatus(c.STATUS_CONNECTING);a.onopen=d.hitch(this,this._handleSocketOpen);a.onclose=d.hitch(this,this._handleSocketClose);a.onmessage=d.hitch(this,this._handleSocketMessage);this._socket=a}},disconnect:function(){this._changeSocketStatus(c.STATUS_DISCONNECTED);clearTimeout(this._reconnectTimeoutId);this._socket&&this._socket.close()},send:function(a){"object"===typeof a&&(a=JSON.stringify(a));this._socket.send(a)},_makeCurrentUrl:function(){var a=this.connectionInfo.queryParams,
b=this.connectionInfo.socketUrls,c;1===b.length||!this._socketUrl?b=b[0]:(c=b.indexOf(this._socketUrl),c=c>=b.length-1?0:c+1,b=b[c]);this._socketUrl=b;a&&(b+="?"+f.objectToQuery(a));return b},_handleSocketOpen:function(){this._changeSocketStatus(c.STATUS_CONNECTED);this._reconnectAttempts=0;this.emit("connect")},_handleSocketClose:function(a){this.emit("disconnect",a);this._changeSocketStatus(c.STATUS_DISCONNECTED);this._socket=null},_handleSocketMessage:function(a){this.emit("message",a.data)},_changeSocketStatus:function(a){this._status=
a;this.notifyChange("status")}});d.mixin(e,c);return e});