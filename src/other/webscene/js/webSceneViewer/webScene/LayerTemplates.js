// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("dojo/_base/lang esri/request esri/core/urlUtils dojo/Deferred dojo/promise/all dojo/sniff esri/renderers/Renderer esri/renderers/SimpleRenderer esri/renderers/UniqueValueRenderer esri/symbols/support/jsonUtils".split(" "),function(m,h,n,g,p,k,q,r,s,t){var e={};m.mixin(e,{symbolFromJSON:function(a){e.adjustProtocolInSymbolRefs(a);(k("ie")||k("trident"))&&e.changeSVGRefsToPNG(a);return t.fromJSON(a)},removeProtocol:function(a){return a=a.replace(/^http:|https:/,"")},adjustProtocol:function(a){return a=
"https:"===location.protocol?a.replace(/^http:/,"https:"):a.replace(/^https:/,"http:")},removeProtocolFromSymbolRefs:function(a){if(a.symbolLayers)for(var c=0;c<a.symbolLayers.length;c++){var b=a.symbolLayers[c];if(b.resource&&b.resource.href){var d=b.resource.href;n.fixUrl(d);d=e.removeProtocol(d);b.resource.href=d}}},adjustProtocolInSymbolRefs:function(a){if(a.symbolLayers)for(var c=0;c<a.symbolLayers.length;c++){var b=a.symbolLayers[c];if(b.resource&&b.resource.href){var d=b.resource.href,d=e.adjustProtocol(d);
b.resource.href=d}}},changeSVGRefsToPNG:function(a){if(a.symbolLayers)for(var c=0;c<a.symbolLayers.length;c++){var b=a.symbolLayers[c];if(b.resource&&b.resource.href&&-1!==b.resource.href.indexOf(".svg",b.resource.href.length-4)){var d=b.resource.href,d=d.replace(".svg",".png"),d=d.replace("/resource/","/resource/png/");b.resource.href=d}}},hasContentByReference:function(a){return!a?!1:a.styleUrl||a.styleName?"renderer":a.symbol&&a.symbol.type&&"styleSymbolReference"===a.symbol.type?"symbol":!1},
getStyleFromUrl:function(a){var c=new g;h({url:e.adjustProtocol(a),content:{f:"json"},handleAs:"json"}).then(function(b){c.resolve(b)},function(b){c.reject(b)});return c},getStyle:function(a,c){var b=new g;if(!c)return b.reject("no portal to query styles"),b;var d=c.stylesGroupQuery;if(!d)return b.reject("no stylesGroupQuery in portal.self"),b;c.queryGroups(d,!0).then(function(d){if(!d.results||0===d.results.length)return b.reject("no styles in styleGroup"),b;c.queryGroupItems(d.results[0].id,{q:"typekeywords:"+
a},!0).then(function(d){0===d.total?b.reject("style name "+a+" not in style group"):c.getItemData(d.results[0].id).then(function(a){b.resolve(a)})})});return b},getSymbolSet:function(a){var c=new g;if(!a.symbolSetUrl)return c.reject("style does not provide url for symbolSet"),c;h({url:e.adjustProtocol(a.symbolSetUrl),content:{f:"json"},handleAs:"json"}).then(function(b){(0===b.length||!b[0].name)&&c.reject("invalid syntax or missing data in symbol set");for(var d={defaultSymbol:void 0},f=0;f<b.length;f++){var l=
e.symbolFromJSON(b[f]);d[b[f].name]=l;b[f].name===a.defaultItem&&(d.defaultSymbol=l)}d.defaultSymbol||(d.defaultSymbol=d[b[0].name]);c.resolve(d)});return c},getSymbolsIndividually:function(a){for(var c=[],b=0;b<a.items.length;b++)c.push(e.getSymbol(a.items[b].name));return p(c)},getSymbol:function(a,c){for(var b=new g,d=0;d<a.items.length;d++)if(a.items[d].name===c)return h({url:e.adjustProtocol(a.items[d].webRef),content:{f:"json"},handleAs:"json"}).then(function(a){b.resolve(e.symbolFromJSON(a))},
function(a){b.reject(a)}),b;b.reject("symbolName "+c+" not found in style");return b},getSymbolFromUrl:function(a){var c=new g;h({url:e.adjustProtocol(a),content:{f:"json"},handleAs:"json"}).then(function(b){c.resolve(e.symbolFromJSON(b))},function(b){c.reject(b)});return c},createRenderer:function(a,c){var b,d=e.hasContentByReference(a);"renderer"===d?b=e._createUVRendererFromStyleUrl(a,c):"symbol"===d&&(b=e._createSimpleRendererWithStyleSymbolReference(a,c));return b},_patchInfosIntoRenderer:function(a,
c){var b=new q(a);b.sizeInfo&&c.setProportionalSymbolInfo(b.sizeInfo);b.colorInfo&&c.setColorInfo(b.colorInfo);b.visualVariables&&c.setVisualVariables(b.visualVariables);return c},_createSimpleRendererWithStyleSymbolReference:function(a,c){var b=new g,d=a.symbol;if(!d.name)return b.reject("no name in styleSymbolReference symbol"),b;var f;if(d.styleUrl)f=e.getStyleFromUrl(d.styleUrl);else if(d.styleName)f=e.getStyle(d.styleName,c);else return b.reject("no styleUrl or styleName in layerDefinition "+
a),b;f.then(function(c){e.getSymbol(c,d.name).then(function(c){c=new r(c);c=e._patchInfosIntoRenderer(a,c);b.resolve(c)},function(a){b.reject("Can't get symbol. "+a)})},function(a){b.reject(a)});return b},_createUVRendererFromStyleUrl:function(a,c){var b=new g,d;if(a.styleUrl)d=e.getStyleFromUrl(a.styleUrl);else if(a.styleName)d=e.getStyle(a.styleName,c);else return b.reject("no styleUrl or styleName in layerDefinition "+a),b;d.then(function(c){e.getSymbolSet(c).then(function(c){var d=new s(a.defaultSymbol&&
c[a.defaultSymbol.name]?c[a.defaultSymbol.name]:c.defaultSymbol,a.field1),f;for(f in c)c.hasOwnProperty(f)&&d.addValue(f,c[f]);d=e._patchInfosIntoRenderer(a,d);b.resolve(d)},function(a){b.reject(a)})},function(a){b.reject(a)});return b}});return e});