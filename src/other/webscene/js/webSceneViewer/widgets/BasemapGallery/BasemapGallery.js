// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("esri/core/declare dojo/_base/lang dojo/dom-construct dojo/dom dojo/on dojo/when dojo/dom-class esri/widgets/BasemapGallery esri/core/watchUtils esri/layers/OpenStreetMapLayer esri/layers/WebTiledLayer esri/views/3d/terrain/TilingScheme esri/layers/support/TileInfo esri/geometry/SpatialReference ../Switch/Switch webSceneViewer/basemapUtils dojo/i18n!../nls/widgets".split(" "),function(n,p,g,l,m,q,f,r,s,t,u,v,w,h,x,k,d){return n(null,{name:"BasemapGallery",baseClass:"BasemapGallery",_onHandles:void 0,
view:void 0,_basemapIdMapping:[null,"ocean","natgeo","gray","terrain","topo","street","imageryWithLabels","satellite"],_sceneSRLocked:!1,constructor:function(a,c){this._onHandles=[];this._compatibilityPromises=[];p.mixin(this,{content:g.create("div",{"class":"BasemapGallery"},c),map:a.map,webscene:a.webscene,portal:a.portal,_sceneSRLocked:a._sceneSRLocked});this.view=a.view;var b=c.nextSibling;f.add(c,"underground");f.add(b,"undergroundContainer");this._onHandles.push(this.view.watch("basemapTerrain.tilingScheme",
function(){this._disableIncompatibleBasemaps()}.bind(this)));g.create("h3",{className:"text"},b).textContent=d.underground.seeThroughGround;this._underGroundSwitch=new x({switchOn:!1});this._underGroundSwitch.placeAt(b);this._underGroundSwitch.startup();this._onHandles.push(m(this._underGroundSwitch,"toggle",function(b){b.on?k.applyTransparency(this.view,100):k.applyTransparency(this.view,0)}.bind(this)));this._onHandles.push(s.init(this.view,"basemapTerrain.wireframe",function(b){b?this._underGroundSwitch.turnOn():
this._underGroundSwitch.turnOff()}.bind(this)));this.map=a.map;this._updateContent()},destroy:function(){this._basemapGallery&&this._basemapGallery.destroy();this._onHandles.forEach(function(a){a.remove()});this._onHandles.length=0},changeBasemap:function(a){var c={baseMapLayers:[],elevationLayers:[],title:a.title,id:a.id,transparency:this._underGroundSwitch.switchOn?100:0};a.layers.forEach(function(b){var a={id:b.id,isReference:b.isReference,layerType:b.layerType||b.type};"OpenStreetMap"===a.layerType?
a.urlTemplate=b.urlTemplate||b.templateUrl:"WebTiledLayer"===a.layerType?(a.urlTemplate=b.urlTemplate||b.templateUrl,a.subDomains=b.subDomains):a.url=b.url;c.baseMapLayers.push(a)});this.map.basemap&&this.map.basemap.elevationLayers.forEach(function(b){c.elevationLayers.push({id:b.id,url:b.url,layerType:b.layerType||b.type})});k.setFromJSON(this.view,c,null,this._sceneSRLocked)},_updateContent:function(){var a=this,c=g.create("div",{"class":"basemapGallery",style:"width:200px; height:200px"},this.content);
this.map.layerIds=[1];this._compatibilityPromises.forEach(function(b){b.cancel()});this._compatibilityPromises=[];this._basemapGallery=new r({"class":"basemapGallery_viewer",showArcGISBasemaps:!0,map:this.map,portalUrl:this.portal&&(this.portal.url.replace(/\/sharing\/rest\/*/,"")||this.portal.portalHostname)},c);this._basemapGallery.startup();this._basemapGallery._switchBasemapLayers=function(b){a.changeBasemap(b)};this._basemapGallery._removeReferenceLayer=function(){};this._basemapGallery._addReferenceLayer=
function(){};m(this._basemapGallery,"load",function(b){b=[];for(var a=0;a<this._basemapGallery.basemaps.length;a++)"USGS National Map"===this._basemapGallery.basemaps[a].title&&b.push(this._basemapGallery.basemaps[a].id);for(a=0;a<b.length;a++)this._basemapGallery.remove(b[a]);this._disableIncompatibleBasemaps()}.bind(this))},_disableIncompatibleBasemap:function(a){return q(a.getLayers(this._basemapGallery.arcgisUrl)).then(function(){for(var c=a.layers;0<c.length;){var b=c[0];if(!b.isReference&&(b.url||
b.type)){if(b.type)return{layer:b};if("https:"==location.protocol&&(this._basemapGallery._isAgolService(b.url)||this._basemapGallery._isHostedService(b.url)))b.url=b.url.replace("http:","https:");return this._basemapGallery._getServiceInfo(b.url).then(function(a){return{layer:b,serviceInfo:a}})}throw Error("Could not find any layers");}}.bind(this)).then(function(a){var b;b="OpenStreetMap"===a.layer.type?(new t).tileInfo:"WebTiledLayer"===a.layer.type?(new u({urlTemplate:a.layer.templateUrl||a.layer.urlTemplate,
subDomains:a.layer.subDomains})).tileInfo:w.fromJSON(a.serviceInfo.tileInfo);var e=this.view.get("basemapTerrain.tilingScheme");if(e&&!e.compatibleWith(b)){e=h.WebMercator;"OpenStreetMap"!==a.layer.type&&(e=a.serviceInfo.spatialReference instanceof h?a.serviceInfo.spatialReference:h.fromJSON(a.serviceInfo.spatialReference));if(e.equals(this.map.spatialReference)){if(v._checkUnsupported(b))throw Error("planar"===this.view.globeMode?d.basemapGallery.TSMismatch:d.basemapGallery.TilingScheme);throw Error(d.basemapGallery.TilingScheme);
}throw Error("planar"===this.view.globeMode?d.basemapGallery.SRMismatch:d.basemapGallery.SRMismatchGlobal);}}.bind(this)).then(function(){var c=l.byId(this._basemapGallery.id+"_galleryNode_"+a.id);f.remove(c,"incompatible");c.title=""}.bind(this)).otherwise(function(c){var b=l.byId(this._basemapGallery.id+"_galleryNode_"+a.id);f.add(b,"incompatible");b.title=c.message}.bind(this))},_disableIncompatibleBasemaps:function(){!this._sceneSRLocked&&"spherical"!==this.view.globeMode||(!this._basemapGallery||
!this._basemapGallery.loaded||!this.view.get("basemapTerrain.tilingScheme"))||(this._compatibilityPromises.forEach(function(a){a.cancel()}),this._compatibilityPromises=[],this._basemapGallery.basemaps.forEach(function(a){this._compatibilityPromises.push(this._disableIncompatibleBasemap(a))}.bind(this)))},updateSceneSRLocked:function(a){a!==this._sceneSRLocked&&(this._sceneSRLocked=a,this._disableIncompatibleBasemaps())}})});