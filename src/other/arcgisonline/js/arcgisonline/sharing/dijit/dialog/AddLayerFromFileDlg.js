// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/AddLayerFromFileDlg",["dijit","dojo","dojox","dojo/require!dijit/form/TextBox,dijit/form/CheckBox,dijit/form/Button,dijit/InlineEditBox,dijit/Dialog,dijit/_Widget,dijit/_Templated,dojo/io/iframe,dojox/data/CsvStore,dojox/data/XmlStore,dojox/xml/DomParser,dojox/encoding/base64,arcgisonline/sharing/dijit/HelpManager,arcgisonline/sharing/dijit/dialog/GeneralDlg"],function(e,a,n){a.provide("arcgisonline.sharing.dijit.dialog.AddLayerFromFileDlg");a.require("dijit.form.TextBox");
a.require("dijit.form.CheckBox");a.require("dijit.form.Button");a.require("dijit.InlineEditBox");a.require("dijit.Dialog");a.require("dijit._Widget");a.require("dijit._Templated");a.require("dojo.io.iframe");a.require("dojox.data.CsvStore");a.require("dojox.data.XmlStore");a.require("dojox.xml.DomParser");a.require("dojox.encoding.base64");a.require("arcgisonline.sharing.dijit.HelpManager");a.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");a.declare("arcgisonline.sharing.dijit.dialog.AddLayerFromFileDlg",
[e._Widget,e._Templated],{widgetsInTemplate:!0,templateString:'\x3cdiv class\x3d"widgetContainer"\x3e\r\n  \x3cdiv dojotype\x3d"dijit.Dialog" id\x3d"add-layer-file-dialog" title\x3d"${i18n.addLayerFromFileDlgTitle}" execute\x3d""\x3e\r\n    \x3cform id\x3d"add-layer-file-form" enctype\x3d"multipart/form-data" name\x3d"add-layer-file-form" action\x3d"" method\x3d"post" onSubmit\x3d"return false;"\x3e\r\n      \x3cdiv id\x3d"add-layer-file-msg"\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv id\x3d"ie_msg" style\x3d"display:none;"\x3e\r\n        \x3cspan\x3e\r\n          \x3cbr/\x3e\r\n          ${i18n.ieMsg}\r\n        \x3c/span\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv style\x3d"margin-top: 1.5em;"\x3e\r\n        \x3ctable cellspacing\x3d"5" style\x3d"margin-top:0.25em 0 0.2em 0;"\x3e\r\n          \x3ctbody\x3e\r\n            \x3ctr\x3e\r\n              \x3ctd\x3e\r\n                \x3clabel for\x3d"add-layer-file-file"\x3e\r\n                  ${i18n.fileLabel}\r\n                \x3c/label\x3e\r\n              \x3c/td\x3e\r\n              \x3ctd\x3e\r\n                \x3cinput type\x3d"file" id\x3d"add-layer-file-file" name\x3d"file" size\x3d"40" onpropertychange\x3d"dijit.byId(\'addLayerFromFileDlg\').onFileInputPropertyChange();" style\x3d"margin:0 1px 0 1px;"\x3e\r\n              \x3c/td\x3e\r\n            \x3c/tr\x3e\r\n          \x3c/tbody\x3e\r\n        \x3c/table\x3e\r\n        \x3cdiv id\x3d"add-layer-file-tip" class\x3d"esriItemLinks" style\x3d"margin-top:15px;display:none;"\x3e\r\n          \x3cspan\x3e${i18n.tip}\x3c/span\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv id\x3d"add-layer-shapefile" style\x3d"padding-top:10px;padding-bottom:10px;display:none;"\x3e\r\n          \x3cdiv class\x3d"esriFloatLeading" style\x3d"width:20px;"\x3e\r\n            \x3cinput type\x3d"radio" name\x3d"option" dojotype\x3d"dijit.form.RadioButton" id\x3d"option:generalize" checked\x3d"checked"/\x3e\r\n          \x3c/div\x3e\r\n          \x3cdiv class\x3d"esriFloatLeading"\x3e\r\n            \x3clabel for\x3d"option:generalize"\x3e\r\n              ${i18n.generalize}\r\n            \x3c/label\x3e\r\n          \x3c/div\x3e\r\n          \x3cdiv style\x3d"clear:both;padding-top:5px;"\x3e\r\n          \x3c/div\x3e\r\n          \x3cdiv class\x3d"esriFloatLeading" style\x3d"width:20px;"\x3e\r\n            \x3cinput type\x3d"radio" name\x3d"option" dojotype\x3d"dijit.form.RadioButton" id\x3d"option:original"/\x3e\r\n          \x3c/div\x3e\r\n          \x3cdiv class\x3d"esriFloatLeading"\x3e\r\n            \x3clabel for\x3d"option:original"\x3e\r\n              ${i18n.keepOrig}\r\n            \x3c/label\x3e\r\n          \x3c/div\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv style\x3d"margin-top: 1em;"\x3e\r\n          \x3cdiv class\x3d"esriItemLinks esriFloatLeading" style\x3d"margin-top:5px;"\x3e\r\n            \x3cA id\x3d"helpLink" href\x3d"" target\x3d"_blank" style\x3d"line-height: 20px;"\x3e\x3c/A\x3e\r\n          \x3c/div\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv class\x3d"esriFloatTrailing" style\x3d"clear:both;"\x3e\r\n          \x3cspan id\x3d"add-layer-file-loading" style\x3d"display:none;"\x3e${i18n.importing}\x26nbsp;\x26nbsp;\x26nbsp;\x3c/span\x3e\r\n          \x3cbutton id\x3d"button_add-layer-file" class\x3d"primary" type\x3d"submit" dojotype\x3d"dijit.form.Button"\x3e\r\n            ${i18n.importLayerBtn} \r\n          \x3c/button\x3e\r\n          \x3cbutton id\x3d"button_add-layer-file-cancel" dojoAttachEvent\x3d"onClick:hide" class\x3d"jevent cancel" type\x3d"button" dojotype\x3d"dijit.form.Button"\x3e\r\n            ${i18n.cancel}\r\n          \x3c/button\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv style\x3d"clear:both; width: 100%; height:1px;"\x3e\r\n        \x3c/div\x3e\r\n      \x3c/div\x3e\r\n    \x3c/form\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e\r\n',
defaultTextFile:"",defaultTextUrl:"http://",layerType:"csv",helpMgr:null,statics:{_instance:null,getInstance:function(){null==this._instance&&(this._instance=new arcgisonline.sharing.dijit.dialog.AddLayerFromFileDlg({id:"addLayerFromFileDlg"}));return this._instance}},postMixInProperties:function(){this.inherited(arguments);this.i18n=a.mixin({},a.i18n.getLocalization("arcgisonline","arcgisonline").common);a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").generalDlg);a.mixin(this.i18n,
a.i18n.getLocalization("arcgisonline","arcgisonline").addLayerFromFileDlg);this.defaultTextFile=this.i18n.enterLocation},postCreate:function(){this.helpMgr=arcgisonline.sharing.dijit.HelpManager.prototype.statics.getInstance();this.loadConnections()},show:function(){e.byId("button_add-layer-file").set("disabled",!1);e.byId("button_add-layer-file-cancel").set("disabled",!1);a.style(a.byId("add-layer-file-loading"),"display","none");a.byId("add-layer-file-file").value="";var b=arcgisonline.sharing.util.getUser();
esri.isDefined(esriGeowConfig.self)&&!1===esriGeowConfig.self.supportsHostedServices?a.byId("add-layer-file-msg").innerHTML="\x3cspan\x3e"+this.i18n.locateFileNoShp+"\x3c/span\x3e":b&&b.accountId?a.byId("add-layer-file-msg").innerHTML="\x3cspan\x3e"+this.i18n.locateFileOrg+"\x3c/span\x3e":a.byId("add-layer-file-msg").innerHTML="\x3cspan\x3e"+this.i18n.locateFile+"\x3c/span\x3e";e.byId("add-layer-file-dialog").show()},clear:function(){a.byId("add-layer-file-file").value="";a.style(a.byId("add-layer-shapefile"),
"display","none");a.style(a.byId("add-layer-file-tip"),"display","none")},loadConnections:function(){a.query(".jevent").connect("onclick",function(a){a.preventDefault()});a.connect(e.byId("add-layer-file-dialog"),"hide",this,"clear");a.connect(a.byId("add-layer-file-form"),"onkeydown",this,"onKeyDown");a.connect(a.byId("add-layer-file-form"),"onsubmit",a.hitch(this,function(a){a.preventDefault();a.target.data?this.handleUserSelection(a.target.data.files):this.handleUserSelection(a.target.file.files)}));
a.connect(a.byId("add-layer-file-form"),"onchange",a.hitch(this,function(b){-1<a.trim(a.byId("add-layer-file-file").value.toLowerCase()).indexOf(".zip")?(a.style(a.byId("add-layer-shapefile"),"display",""),!a.isIE&&!a.isSafari&&a.style(a.byId("add-layer-file-tip"),"display","none")):(a.style(a.byId("add-layer-shapefile"),"display","none"),a.style(a.byId("add-layer-file-tip"),"display",""))}));8>=a.isIE&&a.style(a.byId("ie_msg"),"display","inline")},onFileInputPropertyChange:function(){if(10>a.isIE){var b=
a.trim(a.byId("add-layer-file-file").value.toLowerCase());0==b.length?a.style(a.byId("add-layer-shapefile"),"display","none"):-1<b.indexOf(".zip")?a.style(a.byId("add-layer-shapefile"),"display",""):a.style(a.byId("add-layer-shapefile"),"display","none")}},hide:function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().hide();e.byId("add-layer-file-dialog").hide()},onKeyDown:function(b){var c;window.event?c=b.keyCode:b.which&&(c=b.which);13==c&&a.byId("add-layer-file-form").submit()},
handleUserSelection:function(b){0==a.trim(a.byId("add-layer-file-file").value).length?arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.errorDlgTitle,message:this.i18n.errors.needFile}):(e.byId("button_add-layer-file").set("disabled",!0),e.byId("button_add-layer-file-cancel").set("disabled",!0),a.style(a.byId("add-layer-file-loading"),"display",a.IE?"inline":""),esri.isDefined(esriGeowConfig.self)&&!1!==esriGeowConfig.self.supportsHostedServices&&(b&&
1===b.length)&&-1!==(b[0].name||b[0].fileName).indexOf(".zip")?this.handleFile(b[0]):b&&1===b.length&&"undefined"!==typeof FileReader?this.handleFile(b[0]):(a.byId("add-layer-file-file").name="data",esri.request({url:esriGeowConfig.reflectorUrl,form:a.byId("add-layer-file-form"),content:{f:"json"},callbackParamName:"callback.html",handleAs:"json",load:a.hitch(this,function(a){a.error?this.errorFunc(a.error):this.handleFile(a)}),error:a.hitch(this,"errorFunc")})))},handleFile:function(b){var c=(b.type||
b.contentType||" ").toLowerCase(),g=b.name||b.fileName;if(10>a.isIE)var h=g.split("\\"),g=h[h.length-1];var d=g,g=g.toLowerCase(),f=!0;if(esri.isDefined(esriGeowConfig.self)&&!1!==esriGeowConfig.self.supportsHostedServices&&-1!==g.indexOf(".zip")){var k=d.split(".");b={};arcgisonline.map.main.map.extent.spatialReference.wkid?b.wkid=arcgisonline.map.main.map.extent.spatialReference.wkid:b.wkt=arcgisonline.map.main.map.extent.spatialReference.wkt;b={name:k[0],targetSR:b,maxRecordCount:1E3,enforceInputFileSizeLimit:!0,
enforceOutputJsonSizeLimit:!0,locationType:"none"};e.byId("option:generalize").get("checked")?(c=esri.geometry.getExtentForScale(arcgisonline.map.main.map,4E4),c=c.getWidth()/arcgisonline.map.main.map.width,b.generalize=!0,b.maxAllowableOffset=c,c/=10):(c=esri.geometry.getExtentForScale(arcgisonline.map.main.map,400),c=c.getWidth()/arcgisonline.map.main.map.width);for(h=0;1>c;)c*=10,h++;b.reducePrecision=!0;b.numberOfDigitsAfterDecimal=h;b={filetype:"shapefile",publishParameters:a.json.stringify(b),
f:"json","callback.html":"textarea"};var l=function(b){var c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),d=this.i18n.errors.cantImportShp;b.message&&-1<b.message.indexOf("maximum number of records allowed")?d+=" "+this.i18n.errors.tooManyFeatures:b.message&&-1<b.message.indexOf("missing prj file")?d+=" "+this.i18n.errors.missingPrj:b.message&&-1<b.message.indexOf("Invalid shapefile")?d+=" "+this.i18n.errors.notValidShp:b.message&&-1<b.message.indexOf("Exceeded response size")?
d=e.byId("option:generalize").get("checked")?d+(" "+a.string.substitute(this.i18n.errors.shpTooBigWithGeneralization,{linkStart:"\x3cspan class\x3d'esriItemLinks'\x3e\x3cA href\x3d'"+this.helpMgr.getHelpUrl("120000469")+"' target\x3d'_blank'\x3e",linkEnd:"\x3c/A\x3e\x3c/span\x3e"})):d+(" "+this.i18n.errors.shpTooBig):b.details&&b.details[0]&&-1<b.details[0].indexOf("File exceeds the max size")||b.message&&(-1<b.message.indexOf("Exceeded response size")||-1<b.message.indexOf("input shapefile exceeds"))?
d+=" "+a.string.substitute(this.i18n.errors.shpTooBigWithGeneralization,{linkStart:"\x3cspan class\x3d'esriItemLinks'\x3e\x3cA href\x3d'"+this.helpMgr.getHelpUrl("120000469")+"' target\x3d'_blank'\x3e",linkEnd:"\x3c/A\x3e\x3c/span\x3e"}):b.message&&(d+=" ("+b.message+")");c.show({title:this.i18n.errorDlgTitle,message:d});console.error(b.message?b.message:b);e.byId("button_add-layer-file").set("disabled",!1);e.byId("button_add-layer-file-cancel").set("disabled",!1);a.style(a.byId("add-layer-file-loading"),
"display","none")};a.byId("add-layer-file-file").name="file";c=esriGeowConfig.restBaseUrl+(esriGeowConfig.restBaseUrl.lastIndexOf("/")===esriGeowConfig.restBaseUrl.length-1?"":"/");c+="content/features/generate";(h=arcgisonline.sharing.util.getToken())&&(c+="?token\x3d"+h);esri.request({url:c,content:b,form:a.byId("add-layer-file-form"),handleAs:"json",load:a.hitch(this,function(b){!b||b.error?a.hitch(this,l,b?b.error:{})():arcgisonline.map.fileImport.processShapefile(k[0],b.featureCollection,a.hitch(this,
function(){a.style(a.byId("add-layer-file-loading"),"display","none");this.hide()}))}),error:a.hitch(this,l)});f=null}else if(-1!==c.indexOf("text/")||-1!==g.indexOf(".txt")||-1!==g.indexOf(".csv")||-1!==g.indexOf(".gpx"))if(b.data)b=this.bytesToString(n.encoding.base64.decode(b.data)),-1!==g.indexOf(".gpx")?(b=b.replace(/[\r\n]/g," "),f=arcgisonline.map.fileImport.processGpxData(b,d)):f=arcgisonline.map.fileImport.processCsvData(b,d);else{var m=new FileReader;m.onload=function(){f=-1!==g.indexOf(".gpx")?
arcgisonline.map.fileImport.processGpxData(m.result,d):arcgisonline.map.fileImport.processCsvData(m.result,d)};m.readAsText(b)}else b=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),c=this.i18n.errors.unkownFileType,esri.isDefined(esriGeowConfig.self)&&!1===esriGeowConfig.self.supportsHostedServices&&(c=a.string.substitute(this.i18n.errors.fileCannotBeAddedToPortal,{fileName:d})),b.show({title:this.i18n.errorDlgTitle,message:c}),f=!1;!0===f?this.hide():!1===f&&(e.byId("button_add-layer-file").set("disabled",
!1),e.byId("button_add-layer-file-cancel").set("disabled",!1),a.style(a.byId("add-layer-file-loading"),"display","none"))},bytesToString:function(a){var c=0,e=[],h=a.length,d,f,k,l;for("239,187,191"==a.slice(0,3)&&(c=3);c<h;c++)d=a[c],128>d?e.push(String.fromCharCode(d)):194<=d&&224>d?(f=a[++c],e.push(String.fromCharCode(((d&31)<<6)+(f&63)))):224<=d&&240>d?(f=a[++c],k=a[++c],e.push(String.fromCharCode(((d&255)<<12)+((f&63)<<6)+(k&63)))):240<=d&&245>d&&(f=a[++c],k=a[++c],l=a[++c],d=((d&7)<<18)+((f&
63)<<12)+((k&63)<<6)+(l&63),d-=65536,e.push(String.fromCharCode((d>>10)+55296,(d&1023)+56320)));return e.join("")},errorFunc:function(b){console.error("Error: ",b);e.byId("button_add-layer-file").set("disabled",!1);e.byId("button_add-layer-file-cancel").set("disabled",!1);a.style(a.byId("add-layer-file-loading"),"display","none");arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.errorDlgTitle,message:this.i18n.errors.importError})}})});