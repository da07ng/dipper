// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define(["./TileAgentBase","./TerrainConst","./UpsampleInfo","../support/ObjectPool"],function(h,m,e,n){var a=function(){h.apply(this,arguments)};a.prototype=new h;a.prototype.constructor=a;a.prototype.dataArrived=function(b){b!==this.tile?this._setUpsamplingTile(b):this.updateGeometry();this._dataRequested=null;this._requestNext()};a.prototype.updateGeometry=function(){this._tileLayerInfo.pendingUpdates|=m.TileUpdateTypes.UPDATE_GEOMETRY;this.tile.updateGeometry()};a.prototype._findAncestorWithData=
function(){if(this.tile.lij[0]<this.tile.elevationStartsAtLevel)return null;for(var b=this.layerClass,a=this.layerIdx,d=this.tile,f=d.vlevel,g;d&&(!d.layerInfo[b][a].data||!(g=d,f-d.lij[0]>=m.ELEVATION_DESIRED_RESOLUTION_LEVEL));)d=d.parent;return g?(b=e.Pool.acquire(),b.init(g,0,0,1),b):null};a.prototype._findNextDownload=function(){var b,a=this.layerIdx,d=this.layerClass,f=this.tile.parentSurface.layerViewByIndex(a,d),g=f._minDataLevel,f=f._maxDataLevel,e=m.ELEVATION_DESIRED_RESOLUTION_LEVEL-(this.tile.vlevel-
this.tile.lij[0]);if(this._tileLayerInfo.data||this.tile.lij[0]<Math.max(g,this.tile.elevationStartsAtLevel))b=null;else{for(var c=this.tile,h=c.lij[0],n=0,q=this._tileLayerInfo.upsampleFromTile?this._tileLayerInfo.upsampleFromTile.tile.lij[0]:-1,l=this.tile.parentSurface,k=l.getTilemapTile(c),l=l.tilemapStats,p=!1;c&&c.lij[0]>=g;){if(c.layerInfo[this.layerClass][this.layerIdx].data&&h-c.lij[0]>=e){c.lij[0]>q&&this._setUpsamplingTile(c);break}k&&!k.tileDataAvailable(c,a,d)?(p=!0,b=null):c.lij[0]<=
f&&(b=c);c=c.parent;k=k?k.parent:null;n++}b&&(h-b.lij[0]<e&&this._tileLayerInfo.upsampleFromTile)&&(b=null);!b&&p&&l.tilesNotPresent++}return b};a.prototype._setUpsamplingTile=function(b){this._tileLayerInfo.upsampleFromTile&&e.Pool.release(this._tileLayerInfo.upsampleFromTile);var a=e.Pool.acquire();a.init(b,0,0,1);this._tileLayerInfo.upsampleFromTile=a;this.tile.updateElevationBounds();this.updateGeometry()};n.on(a,400);return a});