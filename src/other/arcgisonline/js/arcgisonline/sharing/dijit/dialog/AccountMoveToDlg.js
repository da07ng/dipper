// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/AccountMoveToDlg",["dijit","dojo","dojox","dojo/require!dijit/_Widget,dijit/_Templated,dijit/Dialog,dijit/Tree,dijit/layout/BorderContainer,dijit/layout/ContentPane,dijit/tree/TreeStoreModel,dojo/DeferredList,dojo/promise/all,dojo/store/Memory,arcgisonline/sharing/util,arcgisonline/sharing/geow/Account,arcgisonline/sharing/geow/Content,arcgisonline/sharing/geow/Folder,arcgisonline/sharing/dijit/dialog/FolderDlg"],function(d,a,m){a.provide("arcgisonline.sharing.dijit.dialog.AccountMoveToDlg");
a.require("dijit._Widget");a.require("dijit._Templated");a.require("dijit.Dialog");a.require("dijit.Tree");a.require("dijit.layout.BorderContainer");a.require("dijit.layout.ContentPane");a.require("dijit.tree.TreeStoreModel");a.require("dojo.DeferredList");a.require("dojo.promise.all");a.require("dojo.store.Memory");a.require("arcgisonline.sharing.util");a.require("arcgisonline.sharing.geow.Account");a.require("arcgisonline.sharing.geow.Content");a.require("arcgisonline.sharing.geow.Folder");a.require("arcgisonline.sharing.dijit.dialog.FolderDlg");
a.declare("arcgisonline.sharing.dijit.dialog.AccountMoveToDlg",[d._Widget,d._Templated],{widgetsInTemplate:!0,templateString:'\x3cdiv class\x3d"widgetContent"\x3e\r\n  \x3cdiv dojotype\x3d"dijit.Dialog" id\x3d"account-move-to-dialog" title\x3d"${i18n.moveTo}" execute\x3d"" style\x3d"width:337px; height:auto;"\x3e\r\n    \x3cdiv style\x3d"margin-top:1em;"\x3e\r\n      \x3cspan\x3e${i18n.moveSelectedItems}\x3c/span\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv style\x3d"margin-top:1em;"\x3e\r\n      \x3cdiv dojoAttachPoint\x3d"userList" dojoAttachEvent\x3d"onChange:onUserSelect" dojoType\x3d"dijit.form.ComboBox" value\x3d"${i18n.selectUserValue}" style\x3d"width:300px;"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv style\x3d"margin-top:1em;"\x3e\r\n      \x3cspan class\x3d"userFound"\x3e${i18n.selectFolderToMove}\x3c/span\x3e\r\n      \x3cdiv dojoType\x3d"dijit.layout.BorderContainer" class\x3d"borderedContent userNotFound" gutters\x3d"false" design\x3d"headline" dojoAttachPoint\x3d"userNotFound" style\x3d"display:none;width:300px;height:200px;"\x3e${i18n.userNotFound}\x3c/div\x3e\r\n      \x3cdiv dojoType\x3d"dijit.layout.BorderContainer" class\x3d"borderedContent userFound" gutters\x3d"false" design\x3d"headline" preventcache\x3d\'true\' usecache\x3d\'false\' cachecontent\x3d\'false\' splitter\x3d"false" dojoAttachPoint\x3d"userFolderContainer" style\x3d"width:300px; height:200px; background:white;"\x3e\x3c/div\x3e\r\n      \x3cbutton id\x3d"button_account-create-folder" class\x3d"jevent userFound" dojoType\x3d"dijit.form.Button" type\x3d"button" iconClass\x3d"esriNewFolderIcon" dojoAttachEvent\x3d"onClick:createFolder"\x3e${i18n.newFolder}\x3c/button\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv style\x3d"float:right; clear:both; margin-top:2em;"\x3e\r\n      \x3cbutton id\x3d"button_account-move-to-submit" class\x3d"jevent primary" dojoType\x3d"dijit.form.Button" type\x3d"button" dojoAttachEvent\x3d"onClick:submitRequest"\x3e${i18n.move}\x3c/button\x3e\r\n      \x3cbutton id\x3d"button_account-move-to-close" class\x3d"jevent cancel" dojoType\x3d"dijit.form.Button" type\x3d"button" dojoAttachEvent\x3d"onClick:hide"\x3e${i18n.cancel}\x3c/button\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv style\x3d"clear:both; float:none; height:0;"\x3e\x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e\r\n',
util:arcgisonline.sharing.util,account:arcgisonline.sharing.geow.Account,content:arcgisonline.sharing.geow.Content,folder:arcgisonline.sharing.geow.Folder,folderDlg:arcgisonline.sharing.dijit.dialog.FolderDlg,adminUser:null,contentUser:null,selectedUser:null,folders:null,items:null,handler:null,selectedFolder:null,selectedFolderId:null,selectedFolderName:null,incomingFolderName:null,maxUsers:100,userList:null,userFolderPane:null,userFolderContainer:null,userFolderClickConnect:null,refreshUserFoldersConnect:null,
startupStarted:!1,i18n:null,postMixInProperties:function(){this.inherited(arguments);this.i18n=a.i18n.getLocalization("arcgisonline","arcgisonline").common;a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").accountMoveToDlg)},statics:{_instance:null,getInstance:function(){null===this._instance&&(this._instance=new arcgisonline.sharing.dijit.dialog.AccountMoveToDlg);return this._instance}},postCreate:function(){this.createUserFolderPane();esri.config.defaults.io.proxyUrl=esriGeowConfig.proxyServer;
esriGeowConfig.proxyUrl&&(esri.config.defaults.io.proxyUrl=esriGeowConfig.proxyUrl)},show:function(b,c,e,g,k){this.loadConnections();this.clear();this.adminUser=this.util.getUser();this.contentUser=b;this.items=c;this.incomingFolderName=e&&""!==e?e:null;this.handler=g;this.errorHandler=k;this.account.getAccountUsers(this.adminUser.accountId,{start:1,num:this.maxUsers},a.hitch(this,this.handleGetAccountUsers));d.byId("account-move-to-dialog").show()},handleGetAccountUsers:function(b){if(b&&b.users&&
b.total&&0<b.total){null===this.userStore&&(this.userStore=new a.store.Memory({idProperty:"name",data:[]}),this.userList.set("store",this.userStore));for(var c=0;c<b.users.length;c++){var e=b.users[c].username,g=a.mixin(b.users[c],{name:b.users[c].fullName+" ("+e+")",username:e});this.contentUser.username===e&&(this.selectedUser=g);this.userStore.put(g)}-1<b.nextStart?this.account.getAccountUsers(this.adminUser.accountId,{start:b.nextStart,num:this.maxUsers},a.hitch(this,this.handleGetAccountUsers)):
this.selectedUser&&(this.selectedUser.name&&this.selectedUser.username)&&(this.userList.set("value",this.selectedUser.name),this.selectedFolderName=this.selectedFolderId=this.selectedFolder=null,this.refreshFolders())}},selectIncomingFolder:function(){var a=d.byId("userFolderTree");if(!this.incomingFolderName||""===this.incomingFolderName)a.rootNode.setSelected(!0),this.selectedFolder=a.rootNode,this.selectedFolderName=this.selectedFolderId=null;else for(var c=a.rootNode.getChildren(),e=0;e<c.length;e++)if(a=
c[e],a.label===this.incomingFolderName){a.setSelected(!0);this.selectedFolder=a;a.item.id&&1===a.item.id.length?(this.selectedFolderId=a.item.id[0],this.selectedFolderName=a.item.title[0]):(this.selectedFolderId=a.item.id,this.selectedFolderName=a.item.title);break}},onFolderClick:function(a){},refreshFolders:function(){this.folder.getFoldersByUser(this.selectedUser&&this.selectedUser.username?this.selectedUser.username:this.contentUser.username,a.hitch(this,this.handleGetFolders))},handleGetFolders:function(b){this.folders=
b.folders;b=this.folder.foldersToStore(b.folders);if(null!==b){var c=d.byId("userFolderTree");c&&c.destroyRecursive();b=new d.tree.TreeStoreModel({store:b});b=new d.Tree({id:"userFolderTree",model:b,label:this.selectedUser&&this.selectedUser.username?this.selectedUser.username:this.contentUser.username,persist:!1,getIconClass:function(a,b){return b?"customTreeIconOpen":"customTreeIcon"},onClick:a.hitch(this,function(b,c){var k=c.item.id?b.id.toString():null,l=null===c.getParent()?null:b.title;a.publish("userFolderClicked",
[k,l]);var h=d.byId("userFolderTree");this.selectedFolder&&this.selectedFolder.setSelected(!1);this.selectedFolder=c||h.rootNode;this.selectedFolderId=k;this.selectedFolderName=l})},a.create("div"));this.userFolderPane.setContent(b.domNode);this.contentUser.username===this.selectedUser.username?this.selectIncomingFolder():b.rootNode&&(b.rootNode.setSelected(!0),this.selectedFolder=b.rootNode,this.selectedFolderName=this.selectedFolderId=null);d.byId("button_account-move-to-submit").set("disabled",
!1)}},loadConnections:function(){this.userFolderClickConnect=a.subscribe("userFolderClicked",a.hitch(this,this.onFolderClick));this.refreshUserFoldersConnect=a.subscribe("refreshFolders",a.hitch(this,this.refreshFolders))},createUserFolderPane:function(){this.userFolderPane||(this.userFolderPane=new d.layout.ContentPane({region:"top",style:"overflow:auto; width:100%; height:100%;"}),this.userFolderContainer.addChild(this.userFolderPane),this.userFolderPane.startup())},onUserSelect:function(b){var c=
null;this.selectedUser=null;if(this.userStore){if((c=this.userStore.query({name:b}))&&c.length)c=c[0],c.orgId===this.adminUser.orgId&&(this.selectedUser=c);this.selectedUser?(a.query(".userNotFound").style("display","none"),a.query(".userFound").style("display",""),d.byId("button_account-move-to-submit").set("disabled",!1),this.selectedFolderName=this.selectedFolderId=this.selectedFolder=null,this.refreshFolders()):(a.query(".userNotFound").style("display",""),a.query(".userFound").style("display",
"none"),d.byId("button_account-move-to-submit").set("disabled",!0))}},createFolder:function(a){this.folderDlg.prototype.statics.getInstance().show(this.folders,this.selectedUser&&this.selectedUser.username?this.selectedUser:this.contentUser)},clear:function(){this.selectedFolderName=this.selectedFolderId=this.selectedFolder=this.userStore=this.selectedUser=null;d.byId("button_account-move-to-submit").set("disabled",!0)},submitRequest:function(){var b=esriGeowConfig.userRole&&esriGeowConfig.userRole.isCustom();
if(this.selectedUser.username===this.contentUser.username&&!b)this.content.moveItemsByUser(this.contentUser.username,this.items,{folder:null!==this.selectedFolderId?this.selectedFolderId:"/"},a.hitch(this,this.onMoveDone),a.hitch(this,this.onMoveDone));else{var c=[],e=[],g=this.selectedUser.username,d=this.selectedFolderName?this.selectedFolderName:"/";a.forEach(this.items,a.hitch(function(b){var h=!(b.id&&1===b.id.length),f=h?b.folderId:b.folderId[0],f={id:h?b.id:b.id[0],owner:h?b.owner:b.owner[0],
folderId:f&&0<f.length&&""!==f?f:null};b=h?b.type:b.type[0];if("Web Mapping Application"===b||"Mobile Application"===b)f.type=b,e.push(f);b=esriGeowConfig.restBaseUrl+"content/users/"+f.owner;f.folderId&&(b=b+"/"+f.folderId);b=b+"/items/"+f.id+"/reassign";f=arcgisonline.sharing.util.request({url:b,content:{targetUsername:g,targetFolderName:d}},{usePost:!0}).then(a.hitch(this,function(a){return a}),a.hitch(this,function(a){return a}));c.push(f)}));(new a.promise.all(c)).then(a.hitch(this,function(b){if((b=
a.filter(b||[],function(a){return a&&200!==a.httpCode&&a.message}))&&b.length&&this.errorHandler)this.errorHandler(b[0]);else if(0<e.length)this.checkForRelatedItems(e);else this.onReassignDone()}))}},checkForRelatedItems:function(b){var c=[];a.forEach(b,a.hitch(this,function(a){var b="WMA2Code";"Mobile Application"===a.type&&(b="MobileApp2Code");a=arcgisonline.sharing.util.request({url:esriGeowConfig.restBaseUrl+"content/items/"+a.id+"/relatedItems",content:{relationshipType:b}});c.push(a)}));(new a.DeferredList(c)).then(a.hitch(this,
function(b){var c=[];a.forEach(b,function(b){b[1]&&b[1].relatedItems&&a.forEach(b[1].relatedItems,function(a){c.push(a)})});this.reassignRelatedItems(c)}),a.hitch(this,function(a){this.onReassignDone()}))},reassignRelatedItems:function(b){if(0<b.length){var c=[];a.forEach(b,a.hitch(this,function(a){var b=esriGeowConfig.restBaseUrl+"content/users/"+a.owner;a.folderId&&(b=b+"/"+a.folderId);b=b+"/items/"+a.id+"/reassign";a=this.util.request({url:b,content:{targetUsername:this.selectedUser.username,targetFolderName:"/"}},
{usePost:!0});c.push(a)}));(new a.DeferredList(c)).then(a.hitch(this,function(a){this.onReassignDone()}),a.hitch(this,function(a){this.onReassignDone()}))}else this.onReassignDone()},onMoveDone:function(){this.handler&&this.handler();d.byId("account-move-to-dialog").hide()},onReassignDone:function(){this.handler&&this.handler();d.byId("account-move-to-dialog").hide()},hide:function(){a.unsubscribe(this.userFolderClickConnect);a.unsubscribe(this.refreshUserFoldersConnect);d.byId("account-move-to-dialog").hide()}})});