// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define(["./Util","./GLUtil"],function(k,v){return function(s,w,x,a){var g={},f={},h=[],n=[],m=a.getExtension("EXT_texture_filter_anisotropic")||a.getExtension("MOZ_EXT_texture_filter_anisotropic")||a.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),y=m?a.getParameter(m.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,p=Math.min(8,y),q=!0,B=function(){var b=a.createTexture(),c=0;this.incRefCnt=function(){++c};this.decRefCnt=function(){--c;k.assert(0<=c)};this.getRefCnt=function(){return c};this.getGLName=function(){return b}},
C=function(b){var c=g[b];void 0!==c&&(a.deleteTexture(c.getGLName()),delete g[b])};this.resetNeedsRender=function(){q=!1};this.needsRender=function(){return q};this.aquire=function(b,c,d){var e=g[b];if(void 0===e){e=new B;k.assert(void 0===g[b]);g[b]=e;var l=s[b];k.assert(void 0!==l);l.setUnloadFunc(C);var f=e.getGLName();D(f,l,c,d);l.renderGl?l.renderGl(f,a):l.deferredLoading()?8>this.getLoadingCount()?z(b,f):h.push([b,f]):l.loadGl(function(){q=!0},f,a,w,x());q=!0}e.incRefCnt();return e.getGLName()};
this.release=function(a){a=g[a];void 0!==a&&(a.decRefCnt(),k.assert(0<=a.getRefCnt()))};this.getLoadingCount=function(){return Object.keys(f).length};this.getIsLoaded=function(a){if(void 0===g[a]||void 0!==f[a])return!1;for(var c=0,d=h.length;c<d;++c)if(h[c][0]===a)return!1;return!0};this.addTextureListener=function(a){k.assert(-1===n.indexOf(a));n.push(a)};this.removeTextureListener=function(a){a=n.indexOf(a);k.assert(-1!==a);n.splice(a,1)};this.getTexture=function(a){return s[a]};this.setMaxAnisotropy=
function(b){if(m&&(b=k.clamp(b,1,y),b!==p)){p=b;for(var c in g)b=g[c].getGLName(),a.bindTexture(a.TEXTURE_2D,b),a.texParameterf(a.TEXTURE_2D,m.TEXTURE_MAX_ANISOTROPY_EXT,p)}};this.getMaxAnisotropy=function(){return p};for(var t=new Uint8Array(256),A=new Uint8Array(256),r=0,u=t.length;r<u;++r)t[r]=255,A[r]=0!==(r+1)%4?255:0;var D=function(b,c,d,e){a.bindTexture(a.TEXTURE_2D,b);c.params&&c.params.wrapClamp&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_2D,
a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE));if(void 0!==d)if(Array.isArray(d.id)){b=d.num;k.assert(d.id.length===b*b);a.texImage2D(a.TEXTURE_2D,0,a.RGBA,256*b,256*b,0,a.RGBA,a.UNSIGNED_BYTE,null);c=a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,c);for(e=0;e<b;e++)for(var f=0;f<b;f++)a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,g[d.id[e*b+f]].getGLName(),0),v.checkFramebufferStatus(a.FRAMEBUFFER,a),a.copyTexSubImage2D(a.TEXTURE_2D,0,256*f,256*e,0,0,256,256);a.generateMipmap(a.TEXTURE_2D);
a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR);a.bindFramebuffer(a.FRAMEBUFFER,null);a.deleteFramebuffer(c)}else a.texImage2D(a.TEXTURE_2D,0,a.RGBA,d.width,d.height,0,a.RGBA,a.UNSIGNED_BYTE,null),v.copyTextureToTexture(g[d.id].getGLName(),b,d.x,d.y,0,0,d.width,d.height,a);else a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),void 0!==e&&e?a.texImage2D(a.TEXTURE_2D,0,a.RGBA,8,8,0,a.RGBA,a.UNSIGNED_BYTE,A):a.texImage2D(a.TEXTURE_2D,0,a.RGBA,8,8,0,a.RGBA,a.UNSIGNED_BYTE,
t);m&&a.texParameterf(a.TEXTURE_2D,m.TEXTURE_MAX_ANISOTROPY_EXT,p)},F=function(a){if(a in f){delete f[a];var c=Object.keys(g),d=Object.keys(f);n.forEach(function(e){e(a,c,d)});E()}},z=function(b,c){k.assert(void 0===f[b]);f[b]=!0;var d=s[b];k.assert(void 0!==d);setTimeout(function(){d.loadGl(function(){F(b);q=!0},c,a,w,x())},0)},E=function(){var b=[],c;c=0;for(u=h.length;c<u;++c){var d=h[c][0],e=g[d];void 0!==e&&(0===e.getRefCnt()?(a.deleteTexture(e.getGLName()),delete g[d]):b.push(h[c]))}h=b;b=Math.min(8-
Object.keys(f).length,h.length);for(c=0;c<b;++c)z(h[c][0],h[c][1]);h.splice(0,b)}}});