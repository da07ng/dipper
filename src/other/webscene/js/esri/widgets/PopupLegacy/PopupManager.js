// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("require ../../core/declare dojo/_base/array dojo/_base/lang dojo/on dojo/Deferred dojo/promise/all dijit/registry ../../layers/support/layerUtils ../../geometry/Extent ../../tasks/support/Query ../../layers/GroupLayer ../../core/Accessor".split(" "),function(F,y,h,G,C,u,H,I,D,J,K,L,M){var s;return y(M,{declaredClass:"esri.views.PopupManager",classMetadata:{properties:{map:{dependsOn:["view.map"],readOnly:!0}}},constructor:function(){this._featureLayersCache={}},destroy:function(){this._featureLayersCache=
{};this.view=null},_clickHandle:null,_featureLayersCache:null,enabled:!1,_enabledSetter:function(a){this._clickHandle&&(a?this._clickHandle.resume():this._clickHandle.pause());return a},_mapGetter:function(){return this.get("view.map")||null},view:null,_viewSetter:function(a){this._clickHandle&&(this._clickHandle.remove(),this._clickHandle=null);a&&(this._clickHandle=C.pausable(a,"click",this._clickHandler.bind(this)),this.enabled||this._clickHandle.pause());return a},getMapLayer:function(a){var b;
if(a&&(b=a.getLayer()))if(a=b.id,this._featureLayersCache[a]){var d=a.lastIndexOf("_");-1<d&&(a=a.substring(0,d),b=this.map.getLayer(a))}return b},_showInfoWindow:function(a,b){var d=this.view.popup,f=a.geometry,f=f&&"point"===f.type?f:b,h=a.getContent();d.setTitle(a.getTitle());if(h&&G.isString(h.id)){var m=I.byId(h.id);m&&(m.set&&/_PopupRenderer/.test(m.declaredClass))&&m.set("showTitle",!1)}d.setContent(h);d.show(f)},_showPopup:function(a){function b(a){if(null==a)return!1;var d=f.getLayerView(a);
return null==d?!1:a.loaded&&!a.disablePopup&&a.popupTemplate&&!d.suspended}var d=this.map,f=this.view,v=f.popup,m=this,n=[];h.forEach(d.layers.getAll(),function(a){a.isInstanceOf(L)?h.forEach(a.layers.getAll(),function(a){b(a)&&(!a.elevationInfo||"onTheGround"===a.elevationInfo.mode)&&n.push(a)}):b(a)&&(!a.elevationInfo||"onTheGround"===a.elevationInfo.mode)&&n.push(a)});var p=null;if(a.graphic&&(a.graphic.popupTemplate||b(a.graphic.layer)))p=a.graphic;if(n.length||p){var c=[],w=!0,e=!!p;if(!p){var g=
m._calculateClickTolerance(n),c=a.mapPoint;if(!c)return;var q=g*(f.basemapTerrain&&f.basemapTerrain.overlayManager.overlayPixelSizeInMapUnits(c)),g=c.offset(-q,-q),c=c.offset(q,q);if(null==g||null==c)return;var s=new J(Math.min(g.x,c.x),Math.min(g.y,c.y),Math.max(g.x,c.x),Math.max(g.y,c.y),d.spatialReference),t=new K,c=h.map(n,function(b){var c;t.timeExtent=b.useMapTime?d.timeExtent:null;if("esri.layers.ArcGISImageServiceLayer"===b.declaredClass)t.geometry=a.mapPoint,w=!1,c=b.queryVisibleRasters(t,
{rasterAttributeTableFieldPrefix:"Raster.",returnDomainValues:!0}),c.then(function(){var a=b.getVisibleRasters();e=e||0<a.length;return a});else if("esri.layers.SceneLayer"===b.declaredClass)c=new u,c.resolve();else if(m._featureLayersCache[b.id]||"function"===typeof b.queryFeatures&&(0===b.currentMode||1===b.currentMode))t.geometry=s,c=b.queryFeatures(t),c.then(function(a){a=a.features;e=e||0<a.length;return a});else{c=new u;var g=[],l=f.getLayerView(b);l&&l._graphicsCollection&&(g=h.filter(l._graphicsCollection.getAll(),
function(a){return a&&s.intersects(a.geometry)}));e=e||0<g.length;c.resolve(g)}return c.promise})}p&&(g=new u,c.unshift(g.resolve([p])));!h.some(c,function(a){return!a.isFulfilled()})&&!e?(v.hide(),v.clearFeatures()):(v.setFeatures(c),v.show(a.mapPoint,{closestFirst:w}))}},_getSubLayerFeatureLayers:function(a,b){var d=b||new u,f=[],v=a.length,m=Math.floor(this.map.extent.getWidth()/this.map.width),n=this.map.getScale(),p=!1,c=this,w=0;a:for(;w<v;w++){var e=a[w],g=e.dynamicLayerInfos||e.layerInfos;
if(g){var q=null;if(e._params&&(e._params.layers||e._params.dynamicLayers))q=e.visibleLayers;for(var q=D._getVisibleLayers(g,q),y=D._getLayersForScale(n,g),t=g.length,z=0;z<t;z++){var x=g[z],r=x.id,l=e.popupTemplates[r];if(!x.subLayerIds&&l&&l.popupTemplate&&-1<h.indexOf(q,r)&&-1<h.indexOf(y,r)){if(!s){p=!0;break a}var A=e.id+"_"+r,k=this._featureLayersCache[A];if(!k||!k.loadError)k||((k=l.layerUrl)||(k=x.source?this._getLayerUrl(e.url,"/dynamicLayer"):this._getLayerUrl(e.url,r)),k=new s(k,{id:A,
drawMode:!1,mode:s.MODE_SELECTION,outFields:this._getOutFields(l.popupTemplate),resourceInfo:l.resourceInfo,source:x.source}),this._featureLayersCache[A]=k),k.setDefinitionExpression(e.layerDefinitions&&e.layerDefinitions[r]),k.setGDBVersion(e.gdbVersion),k.popupTemplate=l.popupTemplate,k.setMaxAllowableOffset(m),k.setUseMapTime(!!e.useMapTime),e.layerDrawingOptions&&(e.layerDrawingOptions[r]&&e.layerDrawingOptions[r].renderer)&&k.setRenderer(e.layerDrawingOptions[r].renderer),f.push(k)}}}}if(p){var E=
new u;F(["../layers/FeatureLayer"],function(a){s=a;E.resolve()});E.then(function(){c._getSubLayerFeatureLayers(a,d)})}else{var B=[];h.forEach(f,function(a){if(!a.loaded){var b=new u;C.once(a,"load, error",function(){b.resolve()});B.push(b.promise)}});B.length?H(B).then(function(){f=h.filter(f,function(a){return!a.loadError&&a.isVisibleAtScale(n)});d.resolve(f)}):(f=h.filter(f,function(a){return a.isVisibleAtScale(n)}),d.resolve(f))}return d.promise},_getLayerUrl:function(a,b){var d=a.indexOf("?");
return-1===d?a+"/"+b:a.substring(0,d)+"/"+b+a.substring(d)},_getOutFields:function(a){var b;a.info&&"esri.widgets.PopupTemplate"===a.declaredClass?(b=[],h.forEach(a.info.fieldInfos,function(a){var f=a.fieldName&&a.fieldName.toLowerCase();f&&("shape"!==f&&0!==f.indexOf("relationships/"))&&b.push(a.fieldName)})):b=["*"];return b},_calculateClickTolerance:function(a){var b=6;h.forEach(a,function(a){if(a=a.renderer)"esri.renderer.SimpleRenderer"===a.declaredClass?((a=a.symbol)&&a.xoffset&&(b=Math.max(b,
Math.abs(a.xoffset))),a&&a.yoffset&&(b=Math.max(b,Math.abs(a.yoffset)))):("esri.renderer.UniqueValueRenderer"===a.declaredClass||"esri.renderer.ClassBreaksRenderer"===a.declaredClass)&&h.forEach(a.infos,function(a){(a=a.symbol)&&a.xoffset&&(b=Math.max(b,Math.abs(a.xoffset)));a&&a.yoffset&&(b=Math.max(b,Math.abs(a.yoffset)))})});return b},_clickHandler:function(a){var b=this.view.popup,d=a.graphic;b&&(this.map.loaded&&this.view.ready)&&(b.clearFeatures&&b.setFeatures?this._showPopup(a):d&&d.getEffectivePopupTemplate()&&
this._showInfoWindow(d,a.mapPoint))}})});