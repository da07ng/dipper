// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/AddLayerFromUrlDlg",["dijit","dojo","dojox","dojo/require!dijit/form/TextBox,dijit/form/CheckBox,dijit/form/Button,dijit/InlineEditBox,dijit/Dialog,dijit/_Widget,dijit/_Templated,arcgisonline/sharing/dijit/HelpManager,arcgisonline/sharing/dijit/dialog/GeneralDlg,arcgisonline/sharing/dijit/dialog/ExtentDlg,arcgisonline/sharing/util"],function(e,a,m){a.provide("arcgisonline.sharing.dijit.dialog.AddLayerFromUrlDlg");a.require("dijit.form.TextBox");a.require("dijit.form.CheckBox");
a.require("dijit.form.Button");a.require("dijit.InlineEditBox");a.require("dijit.Dialog");a.require("dijit._Widget");a.require("dijit._Templated");a.require("arcgisonline.sharing.dijit.HelpManager");a.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");a.require("arcgisonline.sharing.dijit.dialog.ExtentDlg");a.require("arcgisonline.sharing.util");a.declare("arcgisonline.sharing.dijit.dialog.AddLayerFromUrlDlg",[e._Widget,e._Templated],{widgetsInTemplate:!0,templateString:'\x3cdiv class\x3d"widgetContainer" \x3e\r\n  \x3cdiv dojotype\x3d"dijit.Dialog" id\x3d"add-layer-url-dialog" title\x3d"${i18n.addLayerFromUrlDlgTitle}" execute\x3d""\x3e\r\n    \x3cform id\x3d"add-layer-url-form" enctype\x3d"multipart/form-data" name\x3d"add-layer-url-form" action\x3d"" method\x3d"post" onSubmit\x3d"return false;"\x3e\r\n\r\n      \x3cspan\x3e${i18n.msg}\x3c/span\x3e\r\n\r\n      \x3cdiv style\x3d"margin-top: 1.5em; margin-left:0.70em; margin-right:0.5em;"\x3e\r\n        \x3cdiv style\x3d"clear:both; margin-bottom: 1em; margin-left:0.3em; "\x3e\r\n          \x3cselect dojoAttachPoint\x3d"layerTypeSelect" class\x3d"wideselect"  dojoType\x3d"dijit.form.Select" \x3e\r\n            \x3coption value\x3d"arcgis" selected\x3e${i18n.arcgis}\x3c/option\x3e\r\n            \x3coption value\x3d"wms"\x3e${i18n.wms}\x3c/option\x3e\r\n            \x3coption value\x3d"wmts"\x3e${i18n.wmts}\x3c/option\x3e\r\n            \x3coption value\x3d"webTiled"\x3e${i18n.webTiled}\x3c/option\x3e\r\n            \x3coption value\x3d"kml"\x3e${i18n.kml}\x3c/option\x3e\r\n            \x3coption value\x3d"geoRSS"\x3e${i18n.geoRSS}\x3c/option\x3e\r\n            \x3coption value\x3d"csv"\x3e${i18n.csv}\x3c/option\x3e\r\n          \x3c/select\x3e\r\n        \x3c/div\x3e\r\n\r\n        \x3cdiv id\x3d"add-layer-url" style\x3d"clear:both;"\x3e\r\n          \x3ctable cellpadding\x3d"0" cellspacing\x3d"5" style\x3d"margin-top:0.25em 0 0.2em 0;"\x3e\r\n            \x3ctbody\x3e\r\n              \x3ctr id\x3d"add-layer-url-webTiled-help" style\x3d"display:none;"\x3e\r\n                \x3ctd colspan\x3d"2"\x3e${!i18n.webTiledUrlHelp}\x3cbr/\x3e\x26nbsp;\x3c/td\x3e\r\n              \x3c/tr\x3e\r\n              \x3ctr\x3e\r\n                \x3ctd nowrap valign\x3d"top"\x3e\x3clabel for\x3d"add-layer-url-url"\x3e${i18n.urlLabel}\x3c/label\x3e\x3c/td\x3e\r\n                \x3ctd width\x3d"100%"\x3e\r\n                  \x3cdiv id\x3d"add-layer-url-url" dojoAttachEvent\x3d"onChange:onChangeUrl" intermediateChanges\x3d"true" name\x3d"url" dojotype\x3d"dijit.form.TextBox" dir\x3d"ltr" trim\x3d"true" required\x3d"true" style\x3d"width: 100%; padding:2px;"\x3e\x3c/div\x3e\r\n                \x3c/td\x3e\r\n              \x3c/tr\x3e\r\n              \x3ctr id\x3d"add-layer-url-wmts" style\x3d"display:none;"\x3e\r\n                \x3ctd nowrap\x3e\x3clabel for\x3d"add-layer-url-url"\x3e${i18n.layerLabel}\x3c/label\x3e\x3c/td\x3e\r\n                \x3ctd width\x3d"100%"\x3e\r\n                  \x3cselect dojoAttachPoint\x3d"wmtsLayerSelect" dojoAttachEvent\x3d"onChange:setWMTSLayer" style\x3d"width: 100%" maxHeight\x3d"200"  dojoType\x3d"dijit.form.Select" \x3e\r\n                  \x3c/select\x3e\r\n                \x3c/td\x3e\r\n              \x3c/tr\x3e\r\n              \x3ctr id\x3d"add-layer-url-basemap"\x3e\r\n                \x3ctd nowrap\x3e\x26nbsp;\x3c/td\x3e\r\n                \x3ctd width\x3d"100%"\x3e\r\n                  \x3cinput id\x3d"add-layer-url-basemap-check" dojotype\x3d"dijit.form.CheckBox" checked\x3d"false" value\x3d"off" type\x3d"checkbox" /\x3e\r\n                  \x3clabel for\x3d"add-layer-url-basemap-check"\x3e ${i18n.useAsBasemap} \x3c/label\x3e\r\n                \x3c/td\x3e\r\n              \x3c/tr\x3e\r\n            \x3c/tbody\x3e\r\n          \x3c/table\x3e\r\n        \x3c/div\x3e\r\n\r\n        \x3cdiv id\x3d"add-layer-url-webTiled" style\x3d"display:none; clear:both; padding-top:5px;"\x3e\r\n          \x3ctable cellpadding\x3d"0" cellspacing\x3d"5" border\x3d"0" width\x3d"100%"\x3e\r\n            \x3ctbody\x3e\r\n              \x3ctr\x3e\r\n                \x3ctd nowrap\x3e\x3cspan\x3e${i18n.title}\x3c/span\x3e\x3c/td\x3e\r\n                \x3ctd width\x3d"100%"\x3e\x3cdiv id\x3d"add-layer-url-webTiled-title" dojotype\x3d"dijit.form.TextBox" trim\x3d"true" style\x3d"width: 100%; padding:2px;"\x3e\x3c/div\x3e\x3c/td\x3e\r\n              \x3c/tr\x3e\r\n              \x3ctr\x3e\r\n                \x3ctd nowrap\x3e\x3cspan\x3e${i18n.credits}\x3c/span\x3e\x3c/td\x3e\r\n                \x3ctd\x3e\x3cdiv id\x3d"add-layer-url-webTiled-credits" dojotype\x3d"dijit.form.TextBox" trim\x3d"true" style\x3d"width: 100%; padding:2px;"\x3e\x3c/div\x3e\x3c/td\x3e\r\n              \x3c/tr\x3e\r\n              \x3ctr id\x3d"add-layer-url-webTiled-subdomains-input" style\x3d"display:none;"\x3e\r\n                \x3ctd nowrap\x3e\x3cspan\x3e${i18n.subdomains}\x3c/span\x3e\x3c/td\x3e\r\n                \x3ctd\x3e\x3cdiv id\x3d"add-layer-url-webTiled-subdomains" dojotype\x3d"dijit.form.TextBox" trim\x3d"true" style\x3d"width: 100%; padding:2px;"\x3e\x3c/div\x3e\x3c/td\x3e\r\n              \x3c/tr\x3e\r\n              \x3ctr id\x3d"add-layer-url-webTiled-subdomains-help" style\x3d"display:none;"\x3e\r\n                \x3ctd nowrap\x3e\x26nbsp;\x3c/td\x3e\r\n                \x3ctd\x3e\x3cspan\x3e${i18n.webTiledSubdomainsHelp}\x3c/span\x3e\x3c/td\x3e\r\n              \x3c/tr\x3e\r\n              \x3ctr\x3e\r\n                \x3ctd\x3e\x3cspan\x3e${i18n.extent}\x3c/span\x3e\x3c/td\x3e\r\n                \x3ctd\x3e\r\n                \x3cdiv id\x3d"add-layer-url-webTiled-extent-valid" style\x3d"display:none;"\x3e\r\n                  \x3ctable\x3e\r\n                    \x3ctr\x3e\r\n                      \x3ctd\x3e${i18n.left}:\x3c/td\x3e\r\n                      \x3ctd align\x3d"right" nowrap\x3d"nowrap"\x3e\x3cspan id\x3d"add-layer-url-webTiled-extent-left"\x3e\x3c/span\x3e\x3c/td\x3e\r\n                      \x3ctd style\x3d"width: 2em;"\x3e\x3c/td\x3e\r\n                      \x3ctd\x3e${i18n.right}:\x3c/td\x3e\r\n                      \x3ctd align\x3d"right" nowrap\x3d"nowrap"\x3e\x3cspan id\x3d"add-layer-url-webTiled-extent-right"\x3e\x3c/span\x3e\x3c/td\x3e\r\n                      \x3ctd rowspan\x3d"3" style\x3d"width: 2em;"\x3e\x3c/td\x3e\r\n                      \x3ctd rowspan\x3d"3"\x3e\r\n                      \x3cbutton dojoAttachEvent\x3d"onClick:setExtent" class\x3d"jevent" dojotype\x3d"dijit.form.Button"\x3e\r\n                        ${i18n.setTileCoverage}\r\n                      \x3c/button\x3e\x3c/td\x3e\r\n                    \x3c/tr\x3e\r\n                    \x3ctr\x3e\r\n                      \x3ctd colspan\x3d"5" style\x3d"line-height:5px;"\x3e\x26nbsp;\x3c/td\x3e\r\n                    \x3c/tr\x3e\r\n                    \x3ctr\x3e\r\n                      \x3ctd\x3e${i18n.top}:\x3c/td\x3e\r\n                      \x3ctd align\x3d"right" nowrap\x3d"nowrap"\x3e\x3cspan id\x3d"add-layer-url-webTiled-extent-top"\x3e\x3c/span\x3e\x3c/td\x3e\r\n                      \x3ctd\x3e\x3c/td\x3e\r\n                      \x3ctd\x3e${i18n.bottom}:\x3c/td\x3e\r\n                      \x3ctd align\x3d"right" nowrap\x3d"nowrap"\x3e\x3cspan id\x3d"add-layer-url-webTiled-extent-bottom"\x3e\x3c/span\x3e\x3c/td\x3e\r\n                      \x3ctd\x3e\x3c/td\x3e\r\n                    \x3c/tr\x3e\r\n                  \x3c/table\x3e\r\n                \x3c/div\x3e\r\n                \x3cdiv id\x3d"add-layer-url-webTiled-extent-none" style\x3d"display:block;"\x3e\r\n                  \x3cbutton dojoAttachEvent\x3d"onClick:setExtent" class\x3d"jevent" dojotype\x3d"dijit.form.Button"\x3e\r\n                    ${i18n.setTileCoverage}\r\n                  \x3c/button\x3e\r\n                \x3c/div\x3e\x3c/td\x3e\r\n              \x3c/tr\x3e\r\n            \x3c/tbody\x3e\r\n          \x3c/table\x3e\r\n        \x3c/div\x3e\r\n\r\n        \x3cdiv id\x3d"add-layer-bing" style\x3d"display:none; clear:both; padding-top:5px; padding-left:2px;"\x3e\r\n          \x3cdiv style\x3d"clear:both;"\x3e\r\n            \x3cinput class\x3d"esriFloatLeading" type\x3d"radio" name\x3d"bingType" dojotype\x3d"dijit.form.RadioButton" id\x3d"bingType:streets" checked\x3d"checked"/\x3e\r\n            \x3clabel class\x3d"esriFloatLeading" for\x3d"bingType:streets"\x3e\r\n              \x26nbsp;${i18n.bingStreets}\r\n            \x3c/label\x3e\r\n          \x3c/div\x3e\r\n          \x3cdiv style\x3d"clear:both; padding-top:5px;"\x3e\r\n            \x3cinput class\x3d"esriFloatLeading" type\x3d"radio" name\x3d"bingType" dojotype\x3d"dijit.form.RadioButton" id\x3d"bingType:imagery"/\x3e\r\n            \x3clabel class\x3d"esriFloatLeading" for\x3d"bingType:imagery"\x3e\r\n              \x26nbsp;${i18n.bingImagery}\r\n            \x3c/label\x3e\r\n          \x3c/div\x3e\r\n          \x3cdiv style\x3d"clear:both; padding-top:5px;"\x3e\r\n            \x3cinput class\x3d"esriFloatLeading" type\x3d"radio" name\x3d"bingType" dojotype\x3d"dijit.form.RadioButton" id\x3d"bingType:hybrid"/\x3e\r\n            \x3clabel class\x3d"esriFloatLeading" for\x3d"bingType:hybrid"\x3e\r\n              \x26nbsp;${i18n.bingHybrid}\r\n            \x3c/label\x3e\r\n          \x3c/div\x3e\r\n        \x3c/div\x3e\r\n\r\n        \x3cdiv id\x3d"add-layer-note-div" style\x3d"margin-bottom: 0.2em;"\x3e\r\n          \x3cdiv class\x3d"esriItemLinks" style\x3d"margin-top:1em;"\x3e\r\n            \x3clabel id\x3d"add-layer-note"\x3e\x3c/label\x3e\r\n          \x3c/div\x3e\r\n        \x3c/div\x3e\r\n\r\n        \x3cdiv class\x3d"esriFloatTrailing" style\x3d"margin-top: 1em;"\x3e\r\n          \x3cspan id\x3d"add-layer-url-loading" style\x3d"display:none;"\x3e${i18n.adding}\x26nbsp;\x26nbsp;\x26nbsp;\x3c/span\x3e\r\n          \x3cspan id\x3d"add-layer-url-capabilities" style\x3d"display:none;"\x3e${i18n.gettingCapabilities}\x26nbsp;\x26nbsp;\x26nbsp;\x3c/span\x3e\r\n          \x3cbutton type\x3d"submit" dojoAttachPoint\x3d"addButton" class\x3d"primary" dojotype\x3d"dijit.form.Button"\x3e\r\n            ${i18n.addLayerBtn}\r\n          \x3c/button\x3e\r\n          \x3cbutton dojoAttachEvent\x3d"onClick:hide" dojoAttachPoint\x3d"cancelButton" class\x3d"jevent cancel" type\x3d"cancel" dojotype\x3d"dijit.form.Button"\x3e\r\n            ${i18n.cancel}\r\n          \x3c/button\x3e\r\n        \x3c/div\x3e\r\n\r\n        \x3cdiv style\x3d"clear:both; width: 100%; height:1px;"\x3e\x3c/div\x3e\r\n\r\n      \x3c/div\x3e\r\n    \x3c/form\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e\r\n',
defaultArcGISTextUrl:"",defaultTextUrl:"",layerType:"arcgis",onExtentHandler:null,wmtsLayer:null,wmtsParameters:null,userTypingTimeout:null,helpMgr:null,util:arcgisonline.sharing.util,statics:{_instance:null,getInstance:function(){null==this._instance&&(this._instance=new arcgisonline.sharing.dijit.dialog.AddLayerFromUrlDlg);return this._instance}},postMixInProperties:function(){this.inherited(arguments);this.i18n=a.mixin({},a.i18n.getLocalization("arcgisonline","arcgisonline").common);a.mixin(this.i18n,
a.i18n.getLocalization("arcgisonline","arcgisonline").generalDlg);a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").itemProperties);a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").addLayerFromUrlDlg);this.defaultArcGISTextUrl=this.i18n.enterArcGISUrl;this.defaultTextUrl=this.i18n.enterUrl},postCreate:function(){this.helpMgr=arcgisonline.sharing.dijit.HelpManager.prototype.statics.getInstance();this.loadConnections();e.byId("add-layer-url-url").set("value",
this.defaultArcGISTextUrl);if(esriGeowConfig.self.bingKey){var b=new esri.virtualearth.VETiledLayer({bingMapsKey:esriGeowConfig.self.bingKey,mapStyle:esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL});a.connect(b,"onLoad",a.hitch(this,function(){this.layerTypeSelect.addOption({value:"bing",label:this.i18n.bing})}));a.connect(b,"onError",function(){delete esriGeowConfig.self.bingKey})}},show:function(){this.updateLayerType();a.style(a.byId("add-layer-url-loading"),"display","none");a.style(a.byId("add-layer-url-capabilities"),
"display","none");e.byId("add-layer-url-basemap-check").set("checked",!1);this.cancelButton.set("disabled",!1);esriGeowConfig.self.isPortal&&a.style(a.byId("add-layer-note-div"),"display","none");e.byId("add-layer-url-dialog").show()},clear:function(){"arcgis"===this.layerTypeSelect.get("value")?e.byId("add-layer-url-url").set("value",this.defaultArcGISTextUrl):e.byId("add-layer-url-url").set("value",this.defaultTextUrl)},loadConnections:function(){a.query(".jevent").connect("onclick",function(a){a.preventDefault()});
a.connect(e.byId("add-layer-url-dialog"),"hide",this,"clear");a.connect(a.byId("add-layer-url-url"),"onfocus",this,"onFocus");a.connect(a.byId("add-layer-url-form"),"onsubmit",this,"addLayer");a.connect(a.byId("add-layer-url-form"),"onkeydown",this,"onKeyDown");a.connect(this.layerTypeSelect,"onChange",a.hitch(this,"updateLayerType"));a.subscribe("layerAddFailed",a.hitch(this,function(){this.addButton.set("disabled",!1);this.cancelButton.set("disabled",!1);a.style(a.byId("add-layer-url-loading"),
"display","none");a.style(a.byId("add-layer-url-capabilities"),"display","none")}))},updateLayerType:function(){var b=this.layerTypeSelect.get("value");this.layerType=b;this.addButton.set("disabled",!0);a.style(a.byId("add-layer-url-webTiled"),"display","none");a.style(a.byId("add-layer-url-webTiled-help"),"display","none");a.style(a.byId("add-layer-url-wmts"),"display",a.IE?"inline":"none");e.byId("add-layer-url-url").set("value",this.defaultTextUrl);e.byId("add-layer-url-basemap-check").set("disabled",
!1);a.style(a.byId("add-layer-url"),"display",a.IE?"inline":"");a.style(a.byId("add-layer-bing"),"display","none");if("wms"===b||"wmts"===b)this.clearWMTSLayersSelect(),a.byId("add-layer-note").innerHTML=this.i18n.ogcHelp,a.style(a.byId("add-layer-url-basemap"),"display",a.IE?"inline":"");else if("webTiled"===b)a.byId("add-layer-note").innerHTML=this.i18n.webTiledHelp,e.byId("add-layer-url-webTiled-title").set("value",""),e.byId("add-layer-url-webTiled-credits").set("value",""),e.byId("add-layer-url-webTiled-subdomains").set("value",
""),a.byId("add-layer-url-webTiled-extent-left").innerHTML="",a.byId("add-layer-url-webTiled-extent-right").innerHTML="",a.byId("add-layer-url-webTiled-extent-top").innerHTML="",a.byId("add-layer-url-webTiled-extent-bottom").innerHTML="",a.style(a.byId("add-layer-url-webTiled-extent-none"),"display",a.IE?"inline":""),a.style(a.byId("add-layer-url-webTiled-extent-valid"),"display","none"),a.style(a.byId("add-layer-url-basemap"),"display",a.IE?"inline":""),a.style(a.byId("add-layer-url-webTiled-subdomains-input"),
"display","none"),a.style(a.byId("add-layer-url-webTiled-subdomains-help"),"display","none"),a.style(a.byId("add-layer-url-webTiled"),"display",a.IE?"inline":""),a.style(a.byId("add-layer-url-webTiled-help"),"display",a.IE?"inline":"");else if("kml"===b){var c=setInterval(a.hitch(this,function(){this.helpMgr.isLoaded()&&(clearInterval(c),a.byId("add-layer-note").innerHTML=a.string.substitute(this.i18n.kmlHelp,{linkStart:"\x3cA href\x3d'"+this.helpMgr.getHelpUrl("120000471")+"' target\x3d'_blank'\x3e",
linkEnd:"\x3c/A\x3e"}))}),200);a.style(a.byId("add-layer-url-basemap"),"display","none")}else"geoRSS"===b?(a.byId("add-layer-note").innerHTML=this.i18n.geoRSSHelp,a.style(a.byId("add-layer-url-basemap"),"display","none")):"csv"===b?(a.byId("add-layer-note").innerHTML=this.i18n.csvHelp,a.style(a.byId("add-layer-url-basemap"),"display","none")):"bing"===b?(a.byId("add-layer-note").innerHTML="",a.style(a.byId("add-layer-url-basemap"),"display","none"),a.style(a.byId("add-layer-url"),"display","none"),
a.style(a.byId("add-layer-bing"),"display",a.IE?"inline":""),this.addButton.set("disabled",!1)):(e.byId("add-layer-url-url").set("value",this.defaultArcGISTextUrl),a.byId("add-layer-note").innerHTML="",a.style(a.byId("add-layer-url-basemap"),"display",a.IE?"inline":""))},hide:function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().hide();e.byId("add-layer-url-dialog").hide()},onKeyDown:function(a){var c;window.event?c=a.keyCode:a.which&&(c=a.which);13==c&&this.addLayer(a)},
addLayer:function(b){b.preventDefault();arcgisonline.map.main.markMapAsChanged("AddLayerFromUrlDlg-addLayer");a.style(a.byId("add-layer-url-loading"),"display",a.IE?"inline":"");this.addButton.set("disabled",!0);this.cancelButton.set("disabled",!0);b=e.byId("add-layer-url-url").get("value");if(".kml"==b.toLowerCase().match(".kml$")||".kmz"==b.toLowerCase().match(".kmz$"))arcgisonline.map.kml.addKMLLayer(b,null,a.hitch(this,function(){"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&
arcgisonline.map.leftPanel.openLeftTOCPanel();this.hide()}),a.hitch(this,function(){this.hide()}));else if("csv"==this.layerType||".csv"==b.toLowerCase().match(".csv$")||".txt"==b.toLowerCase().match(".txt$"))arcgisonline.map.fileImport.addCSVByReferenceLayer(b),"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftTOCPanel(),this.hide();else if("geoRSS"==this.layerType)arcgisonline.map.geoRSS.addGeoRSSLayer(b),"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&
arcgisonline.map.leftPanel.openLeftTOCPanel(),this.hide();else if("webTiled"==this.layerType){var c=this.checkCanAddWebMerctorWebTiledLayer();c?(b=b.replace(/{subdomain}/i,"{subDomain}"),b=b.replace(/{level}/i,"{level}"),b=b.replace(/{col}/i,"{col}"),b=b.replace(/{row}/i,"{row}"),(c=this.checkWebTiledProperties())?e.byId("add-layer-url-basemap-check").get("checked")?arcgisonline.map.webTile.addWebTiledUrlAsBasemap(b,c,a.hitch(this,function(){"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&
arcgisonline.map.leftPanel.openLeftTOCPanel();this.hide()}),a.hitch(this,function(){this.hide()})):arcgisonline.map.webTile.addWebTiledLayer(b,c,a.hitch(this,function(){"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftTOCPanel();this.hide()}),a.hitch(this,function(){this.hide()})):(a.style(a.byId("add-layer-url-loading"),"display","none"),this.addButton.set("disabled",!1),this.cancelButton.set("disabled",!1))):(a.style(a.byId("add-layer-url-loading"),
"display","none"),this.addButton.set("disabled",!1),this.cancelButton.set("disabled",!1))}else if("arcgis"==this.layerType){if(-1!==b.toLowerCase().indexOf("token\x3d")&&(this.util.isHostedService(b)||-1!==b.indexOf("arcgis.com")&&-1!==b.indexOf("//utility")))b=this._stripParameters(b,["token"]);if(e.byId("add-layer-url-basemap-check").get("checked")){if(-1<b.toLowerCase().indexOf("/featureserver")||-1<b.toLowerCase().indexOf("/streamserver")){b=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();
b.show({title:this.i18n.errorDlgTitle,message:this.i18n.errors.cantUseAsBasemap});a.style(a.byId("add-layer-url-loading"),"display","none");this.addButton.set("disabled",!1);this.cancelButton.set("disabled",!1);return}if(-1<b.indexOf("/MapServer/")&&b.lastIndexOf("/")!=b.length-1){b=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();b.show({title:this.i18n.errorDlgTitle,message:this.i18n.errors.cantUseLayerAsBasemap});a.style(a.byId("add-layer-url-loading"),"display","none");
this.addButton.set("disabled",!1);this.cancelButton.set("disabled",!1);return}arcgisonline.map.save_open.switchBaseMapByUrl(arcgisonline.map.main.decodeUrl(b))}else arcgisonline.map.save_open.addServiceByUrl(arcgisonline.map.main.decodeUrl(b),null);"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftTOCPanel();this.hide()}else"wms"==this.layerType?this.isArcGISWMS().then(a.hitch(this,"addAsArcGISService"),a.hitch(this,"addAsWMS")):"wmts"==this.layerType?
this.ArcGISServiceParamsForWMTS&&this.ArcGISServiceParamsForWMTS.wmtsUrl===b?this.addAsArcGISService(this.ArcGISServiceParamsForWMTS):this.addAsWMTS():"bing"==this.layerType?(c=this.checkCanAddWebMerctorWebTiledLayer())?(b={operationalLayers:[],baseMap:{title:"Bing Maps Road",baseMapLayers:[{visibility:!0,opacity:1,type:"BingMapsRoad"}]}},e.byId("bingType:imagery").get("checked")?(b.baseMap.title="Bing Maps Aerial",b.baseMap.baseMapLayers[0].type="BingMapsAerial",b.baseMap.baseMapLayers[0].layerType=
"BingMapsAerial"):e.byId("bingType:hybrid").get("checked")&&(b.baseMap.title="Bing Maps Hybrid",b.baseMap.baseMapLayers[0].type="BingMapsHybrid",b.baseMap.baseMapLayers[0].layerType="BingMapsHybrid"),arcgisonline.map.save_open.switchOrRecreateBasemap(b),"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftTOCPanel(),this.hide()):(a.style(a.byId("add-layer-url-loading"),"display","none"),this.addButton.set("disabled",!1),this.cancelButton.set("disabled",
!1)):arcgisonline.map.kml.addKMLLayer(b,null,a.hitch(this,function(){"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftTOCPanel();this.hide()}),a.hitch(this,function(){this.hide()}))},onChangeUrl:function(b){"bing"!==this.layerTypeSelect.get("value")&&(a.style(a.byId("add-layer-url-loading"),"display","none"),a.style(a.byId("add-layer-url-capabilities"),"display","none"),this.addButton.set("disabled",!0),clearTimeout(this.userTypingTimeout),
this.userTypingTimeout=setTimeout(a.hitch(this,function(){this.userTypingTimeout=null;this.processUrl(b)}),1E3))},processUrl:function(b){b&&b!=this.defaultArcGISTextUrl&&b!=this.defaultTextUrl?!b.startsWith("http://")&&!b.startsWith("https://")?e.byId("add-layer-url-url").set("value","http://"+b):"wmts"==this.layerType?(e.byId("add-layer-url-basemap-check").set("disabled",!1),a.style(a.byId("add-layer-url-wmts"),"display","none"),this.isArcGISWMTS().then(a.hitch(this,"addAsArcGISServiceLater"),a.hitch(this,
"getWMTSInfo"))):("webTiled"==this.layerType&&(-1<b.toLowerCase().indexOf("{subdomain}")?(a.style(a.byId("add-layer-url-webTiled-subdomains-input"),"display",a.IE?"inline":""),a.style(a.byId("add-layer-url-webTiled-subdomains-help"),"display",a.IE?"inline":"")):(a.style(a.byId("add-layer-url-webTiled-subdomains-input"),"display","none"),a.style(a.byId("add-layer-url-webTiled-subdomains-help"),"display","none"))),this.addButton.set("disabled",!1)):this.addButton.set("disabled",!0)},setExtent:function(){var b=
arcgisonline.sharing.dijit.dialog.ExtentDlg.prototype.statics.getInstance(),c=a.byId("add-layer-url-webTiled-extent-left").innerHTML,d=a.byId("add-layer-url-webTiled-extent-bottom").innerHTML,e=a.byId("add-layer-url-webTiled-extent-right").innerHTML,f=a.byId("add-layer-url-webTiled-extent-top").innerHTML;c&&d&&e&&f?b.show([[parseFloat(c),parseFloat(d)],[parseFloat(e),parseFloat(f)]]):b.show([[-180,-90],[180,90]]);this.onExtentHandler||(this.onExtentHandler=a.subscribe("onExtentUpdate",a.hitch(this,
"onExtentUpdate")))},onExtentUpdate:function(b){a.byId("add-layer-url-webTiled-extent-left").innerHTML=b[0][0];a.byId("add-layer-url-webTiled-extent-bottom").innerHTML=b[0][1];a.byId("add-layer-url-webTiled-extent-right").innerHTML=b[1][0];a.byId("add-layer-url-webTiled-extent-top").innerHTML=b[1][1];a.style(a.byId("add-layer-url-webTiled-extent-none"),"display","none");a.style(a.byId("add-layer-url-webTiled-extent-valid"),"display",a.IE?"inline":"")},checkWebTiledProperties:function(){var b={},c=
e.byId("add-layer-url-webTiled-title").get("value"),d=e.byId("add-layer-url-webTiled-credits").get("value"),g=!1;-1<e.byId("add-layer-url-url").get("value").toLowerCase().indexOf("{subdomain}")&&!e.byId("add-layer-url-webTiled-subdomains").get("value")&&(g=!0);if(!c||!d||g)return arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.errorDlgTitle,message:g?this.i18n.errors.needWebTiledProps2:this.i18n.errors.needWebTiledProps}),null;b.title=c;b.copyright=
d;if(c=e.byId("add-layer-url-webTiled-subdomains").get("value"))b.subDomains=c.split(","),b.subDomains=a.map(b.subDomains,function(b){return a.trim(b)});var c=a.byId("add-layer-url-webTiled-extent-left").innerHTML,d=a.byId("add-layer-url-webTiled-extent-bottom").innerHTML,g=a.byId("add-layer-url-webTiled-extent-right").innerHTML,f=a.byId("add-layer-url-webTiled-extent-top").innerHTML;c&&(d&&g&&f)&&(c=new esri.geometry.Extent(parseFloat(c),parseFloat(d),parseFloat(g),parseFloat(f),new esri.SpatialReference({wkid:4326})),
b.fullExtent=esri.geometry.geographicToWebMercator(c));return b},isArcGISWMTS:function(){var b,c=e.byId("add-layer-url-url").get("value"),d=c.toLowerCase(),g=d.indexOf("/1.0.0/wmtscapabilities.xml");-1<g&&(c=c.substring(0,g),d=c.toLowerCase(),e.byId("add-layer-url-url").set("value",c));var f=new a.Deferred,g=function(a,d,e){b=d;f.callback({url:b,wmtsUrl:c,serviceInfo:a})},h=function(a,b){f.errback(null)},k=d.indexOf("/mapserver/"),l=d.indexOf("/imageserver/");-1<d.indexOf("/rest/services/")&&(-1<
k||-1<l)?(b=c.substring(0,-1<k?k+10:l+12),arcgisonline.map.layer.getServiceInfo(b,null,g,h)):f.errback(null);return f},isArcGISWMS:function(){var b,c=e.byId("add-layer-url-url").get("value");if((esriGeowConfig.allSSL||"https:"==location.protocol)&&arcgisonline.sharing.util.supportsHttps(c))c=c.replace("http:","https:");var d=c.toLowerCase(),g=new a.Deferred,f=function(a,d,c){b=d;g.callback({url:b,serviceInfo:a})},h=function(a,b){g.errback(null)},k=d.indexOf("/mapserver/"),l=d.indexOf("/imageserver/");
-1<d.indexOf("/services/")&&(-1<k||-1<l)?(b=c.substring(0,-1<k?k+10:l+12),b=b.replace("/services/","/rest/services/"),arcgisonline.map.layer.getServiceInfo(b,null,f,h)):g.errback(null);return g},addAsArcGISService:function(a){e.byId("add-layer-url-basemap-check").get("checked")?arcgisonline.map.save_open.switchBaseMapByUrl(a.url,a.serviceInfo):arcgisonline.map.save_open.addServiceByUrl(a.url,null,!1,a.serviceInfo);"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftTOCPanel();
this.hide()},addAsArcGISServiceLater:function(a){this.addButton.set("disabled",!1);this.ArcGISServiceParamsForWMTS=a},addAsWMS:function(){var b=e.byId("add-layer-url-url").get("value"),c=null,d=esri.urlToObject(b);if(d&&d.query)for(var g in d.query)if("layers"===g.toLowerCase()){c=d.query[g].split(",");break}b=this._stripParameters(b,"service request bbox format height width layers srs crs styles transparent bgcolor exceptions time elevation sld wfs".split(" "));e.byId("add-layer-url-basemap-check").get("checked")?
arcgisonline.map.wms.addWMSUrlAsBasemap(b,a.hitch(this,function(){"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftTOCPanel();this.hide()}),a.hitch(this,function(){this.hide()})):(arcgisonline.map.wms.addWMSService({url:b,visibleLayers:c},null,a.hitch(this,function(){"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftTOCPanel();this.hide()}),a.hitch(this,function(){this.hide()})),"contentStack"!=
arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftTOCPanel())},addAsWMTS:function(){e.byId("add-layer-url-url").get("value");e.byId("add-layer-url-basemap-check").get("checked")||!arcgisonline.map.main.sameSpatialReference(this.wmtsParameters.tileInfo.spatialReference,arcgisonline.map.main.map.spatialReference)?arcgisonline.map.webTile.addWebTiledUrlAsBasemap(this.wmtsParameters.templateUrl,this.wmtsParameters,a.hitch(this,function(){"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&
arcgisonline.map.leftPanel.openLeftTOCPanel();this.hide()}),a.hitch(this,function(){this.hide()})):(arcgisonline.map.webTile.addWebTiledLayer(this.wmtsParameters.templateUrl,this.wmtsParameters,a.hitch(this,function(){"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftTOCPanel();this.hide()}),a.hitch(this,function(){this.hide()})),"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftTOCPanel())},
getWMTSInfo:function(){var b=e.byId("add-layer-url-url").get("value");a.style(a.byId("add-layer-url-capabilities"),"display",a.IE?"inline":"");var c={},d=arcgisonline.sharing.util.urlToObject(b);d.query&&d.query.service&&("wmts"===d.query.service.toLowerCase()&&d.query.request&&"getcapabilities"===d.query.request.toLowerCase())&&(c={serviceMode:"KVP"});b=this._stripParameters(b,"version service request layer style format tilematrixset tilematrix tilerow tilecol".split(" "));this.wmtsLayer=new esri.layers.WMTSLayer(b,
c);var g=function(b){a.style(a.byId("add-layer-url-capabilities"),"display","none");1==b.layers.length?this.buildWMTSParameters(this.wmtsLayer.layers[0]):(this.clearWMTSLayersSelect(),this.wmtsLayerSelect.addOption({label:this.i18n.chooseWMTSLayer,value:-1}),a.forEach(b.layers,function(a,b){this.wmtsLayerSelect.addOption({label:a.title||a.identifier,value:""+b})},this),a.style(a.byId("add-layer-url-wmts"),"display",a.IE?"inline":""))},f=function(d){console.error("WMTS layer onErrorHandler",d);a.disconnect(e);
h&&a.disconnect(h);this.wmtsLayer=null;if(c.serviceMode)a.style(a.byId("add-layer-url-capabilities"),"display","none"),arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().showWide({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:a.string.substitute(this.i18n.errors.invalidWMTSUrl,{url:b})});else{c={serviceMode:"KVP"};this.wmtsLayer=new esri.layers.WMTSLayer(b,c);var e=a.connect(this.wmtsLayer,"onError",a.hitch(this,f));this.wmtsLayer.loaded?g(this.wmtsLayer):a.connect(this.wmtsLayer,
"onLoad",a.hitch(this,g))}};a.connect(this.wmtsLayer,"onError",a.hitch(this,f));var h=null;this.wmtsLayer.loaded?g(this.wmtsLayer):h=a.connect(this.wmtsLayer,"onLoad",a.hitch(this,g))},clearWMTSLayersSelect:function(){var b=this.wmtsLayerSelect.getOptions();a.forEach(b,function(a){this.wmtsLayerSelect.removeOption(a)},this)},setWMTSLayer:function(a){a=parseInt(a);-1<a&&this.buildWMTSParameters(this.wmtsLayer.layers[a])},buildWMTSParameters:function(b){var c="";this.wmtsLayer.copyright&&"none"!==this.wmtsLayer.copyright.toLowerCase()&&
(c=this.wmtsLayer.copyright,180<this.wmtsLayer.copyright.length&&(c=this.wmtsLayer.copyright.substring(0,180)+esri.i18nBundle.viewer.shortenedTextEnding));var d={id:"WMTS_"+Math.floor(10001*Math.random()),visibility:!0,opacity:1,identifier:b.identifier,gcsExtent:b.gcsExtent,description:b.description,title:b.title,copyright:c},g=-1<a.indexOf(b.formats,"image/png")?"image/png":b.formats[0];if(e.byId("add-layer-url-basemap-check").get("checked")){var f=b.tileMatrixSetInfos[0];d.fullExtent=f.fullExtent;
(c=a.some(arcgisonline.map.wms._WEB_MERCATOR,function(a){return a===f.tileInfo.spatialReference.wkid}))?(b.gcsExtent=b.gcsExtent.intersects(new esri.geometry.Extent(-179,-89,179,89,new esri.SpatialReference({wkid:4326}))),d.fullExtent=esri.geometry.geographicToWebMercator(b.gcsExtent)):d.fullExtent=4326===f.tileInfo.spatialReference.wkid?b.gcsExtent:f.fullExtent;d.minScale=f.tileInfo.lods[0].scale;d.maxScale=f.tileInfo.lods[f.tileInfo.lods.length-1].scale;d.tileInfo=f.tileInfo;this.wmtsLayer.resourceUrls=
b.resourceUrls;d.templateUrl=this.wmtsLayer.getTileUrlTemplate({identifier:b.identifier,tileMatrixSet:f.tileMatrixSet,format:g});d.wmtsInfo={url:this.wmtsLayer.url,layerIdentifier:b.identifier,tileMatrixSet:f.tileMatrixSet};arcgisonline.map.save_open.checkIfOpLayersFitToNewBasemap(d.tileInfo.spatialReference,{tileInfo:d.tileInfo})&&(this.wmtsParameters=d,this.addButton.set("disabled",!1))}else{var h=arcgisonline.map.main.defaultService.layer.tileInfo;a.forEach(b.tileMatrixSetInfos,function(c){if(!d.templateUrl){if(96!=
c.tileInfo.dpi){for(var e=0;e<c.tileInfo.lods.length;e++){var f=c.tileInfo.lods[e];f.scale=96*f.scale/c.tileInfo.dpi}c.tileInfo.dpi=96}if(arcgisonline.map.main.sameSpatialReference(c.tileInfo.spatialReference,arcgisonline.map.main.map.spatialReference)&&(!h||h&&arcgisonline.map.main.sameTilingScheme(c.tileInfo,arcgisonline.map.main.defaultService.layer.tileInfo)))d.fullExtent=c.fullExtent,a.some(arcgisonline.map.wms._WEB_MERCATOR,function(a){return a===c.tileInfo.spatialReference.wkid})?(b.gcsExtent=
b.gcsExtent.intersects(new esri.geometry.Extent(-179,-89,179,89,new esri.SpatialReference({wkid:4326}))),d.fullExtent=esri.geometry.geographicToWebMercator(b.gcsExtent)):d.fullExtent=4326===c.tileInfo.spatialReference.wkid?b.gcsExtent:c.fullExtent,d.minScale=c.tileInfo.lods[0].scale,d.maxScale=c.tileInfo.lods[c.tileInfo.lods.length-1].scale,d.tileInfo=c.tileInfo,this.wmtsLayer.resourceUrls=b.resourceUrls,d.templateUrl=this.wmtsLayer.getTileUrlTemplate({identifier:b.identifier,tileMatrixSet:c.tileMatrixSet,
format:g}),d.wmtsInfo={url:this.wmtsLayer.url,layerIdentifier:b.identifier,tileMatrixSet:c.tileMatrixSet};h&&console.log(b.title,"tileMatrixSet:",c.tileMatrixSet,"sameSpatialReference:",arcgisonline.map.main.sameSpatialReference(c.tileInfo.spatialReference,arcgisonline.map.main.map.spatialReference),"sameTilingScheme",arcgisonline.map.main.sameTilingScheme(c.tileInfo,arcgisonline.map.main.defaultService.layer.tileInfo))}},this);!d.templateUrl&&(0===arcgisonline.map.main.numOperationalLayers()&&"defaultBasemap"===
arcgisonline.map.main.mapLayers[0].id)&&(f=b.tileMatrixSetInfos[0],c=a.some(arcgisonline.map.wms._WEB_MERCATOR,function(a){return a===f.tileInfo.spatialReference.wkid}),d.fullExtent=c?esri.geometry.geographicToWebMercator(b.gcsExtent):4326===f.tileInfo.spatialReference.wkid?b.gcsExtent:f.fullExtent,d.minScale=f.tileInfo.lods[0].scale,d.maxScale=f.tileInfo.lods[f.tileInfo.lods.length-1].scale,d.tileInfo=f.tileInfo,this.wmtsLayer.resourceUrls=b.resourceUrls,d.templateUrl=this.wmtsLayer.getTileUrlTemplate({identifier:b.identifier,
tileMatrixSet:f.tileMatrixSet,format:g}),d.wmtsInfo={url:this.wmtsLayer.url,layerIdentifier:b.identifier,tileMatrixSet:f.tileMatrixSet},e.byId("add-layer-url-basemap-check").set("checked",!0),e.byId("add-layer-url-basemap-check").set("disabled",!0));d.templateUrl?(this.wmtsParameters=d,this.addButton.set("disabled",!1)):arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().showWide({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:a.string.substitute(this.i18n.errors.wmtsDoesntAlign,
{url:e.byId("add-layer-url-url").get("value"),layer:b.identifier})})}},checkCanAddWebMerctorWebTiledLayerToBasemap:function(){var b=(new esri.layers.OpenStreetMapLayer).tileInfo;(b=arcgisonline.map.webTile.checkIfFitsToNewService(arcgisonline.map.main.mapLayers[0],new esri.SpatialReference({wkid:102100}),b))||arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().showWide({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:a.string.substitute(this.i18n.errors.webTiledLayerDoesntAlign,
{url:e.byId("add-layer-url-url").get("value")})});return b},checkCanAddWebMerctorWebTiledLayer:function(){if(e.byId("add-layer-url-basemap-check").get("checked")||"bing"==this.layerType){var a=new esri.layers.OpenStreetMapLayer;return arcgisonline.map.save_open.checkIfOpLayersFitToNewBasemap(new esri.SpatialReference({wkid:102100}),{tileInfo:a.tileInfo})}return this.checkCanAddWebMerctorWebTiledLayerToBasemap()},_stripParameters:function(b,c){var d=esri.urlToObject(b);qs=[];for(var e in d.query)-1===
a.indexOf(c,e.toLowerCase())&&qs.push(e+"\x3d"+d.query[e]);return d.path+(qs.length?"?"+qs.join("\x26"):"")},onFocus:function(){var a=e.byId("add-layer-url-url").get("value");(a==this.defaultTextUrl||a==this.defaultArcGISTextUrl)&&e.byId("add-layer-url-url").set("value","")}})});