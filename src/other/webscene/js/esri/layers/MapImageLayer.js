// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../core/declare dojo/_base/lang dojo/_base/array dojo/dom-construct dojo/dom-style dojo/on ../kernel ../config ../core/sniff ../core/domUtils ../geometry/Point ../geometry/support/webMercatorUtils ./Layer".split(" "),function(u,v,w,l,f,r,k,x,m,s,t,n,y){var p=u([y],{declaredClass:"esri.layers.MapImageLayer","-chains-":{constructor:"manual"},constructor:function(a){this.inherited(arguments,[null,a]);this._mapImages=[];var b=v.hitch;this._panStart=b(this,this._panStart);this._pan=b(this,this._pan);
this._extentChange=b(this,this._extentChange);this._zoom=b(this,this._zoom);this._zoomStart=b(this,this._zoomStart);this._scale=b(this,this._scale);this._resize=b(this,this._resize);this.on("suspend",this._onSuspend.bind(this));this.on("resume",this._onResume.bind(this));this.loaded=!0;this.onLoad(this)},opacity:1,addImage:function(a){var b=this._mapImages.push(a),b=b-1;a._idx=b;a._layer=this;this._div&&this._createImage(a,b)},removeImage:function(a){if(a){var b=a._idx,c=this._mapImages;if(c[b]===
a){delete c[b];if(b=a._node)this._clearEvents(b),b.e_idx=b.e_bl=b.e_tr=b.e_l=b.e_t=b.e_w=b.e_h=null,b.parentNode&&(b.parentNode.removeChild(b),l.destroy(b));a._node=a._idx=a._layer=null}}},removeAllImages:function(){var a=this._mapImages,b,c=a.length;for(b=0;b<c;b++){var d=a[b];d&&this.removeImage(d)}this._mapImages=[]},getImages:function(){var a=this._mapImages,b=[],c,d=a.length;for(c=0;c<d;c++)a[c]&&b.push(a[c]);return b},setOpacity:function(a){this.opacity!=a&&(this._opacityChanged(this.opacity=
a),this.onOpacityChange())},onOpacityChange:function(){},_opacityChanged:function(a){var b=this._div,c,d;if(b)if(!m("ie")||8<m("ie"))f.set(b,"opacity",a);else{d=b.childNodes;c=d.length;for(b=0;b<c;b++)f.set(d[b],"opacity",a)}},_createImage:function(a,b){var c=l.create("img",{alt:""});f.set(c,{position:"absolute"});1>a.opacity?f.set(c,"opacity",a.opacity):8>=m("ie")&&f.set(c,"opacity",this.opacity);a.rotation&&!(9>m("ie"))&&f.set(c,k._css.names.transform,k._css.rotate(360-a.rotation));a._node=c;c.e_idx=
b;c.e_layer=this;c.e_load=r(c,"load",p.prototype._imageLoaded);c.e_error=r(c,"error",p.prototype._imageError);c.e_abort=r(c,"abort",p.prototype._imageError);c.src=a.href},_imageLoaded:function(a,b){var c=b||a.target||a.currentTarget,d=c.e_layer,e=d._mapImages[c.e_idx],g=d._map;g&&(g.__zooming||g.__panning||!d._sr)?d._standby.push(c):(d._clearEvents(c),e&&e._node===c&&g&&d._attach(e))},_imageError:function(a){a=a.target||a.currentTarget;var b=a.e_layer,c=b._mapImages[a.e_idx];b._clearEvents(a);c&&
(c._node=null)},_clearEvents:function(a){a.e_load.remove();a.e_error.remove();a.e_abort.remove();a.e_load=a.e_error=a.e_abort=a.e_layer=null},_attach:function(a){var b=a.extent,c=b.spatialReference,d=this._sr,e=this._div,g=a._node,f=new t({x:b.xmin,y:b.ymin,spatialReference:c}),b=new t({x:b.xmax,y:b.ymax,spatialReference:c});d.equals(c)||(d.isWebMercator()&&4326===c.wkid?(f=n.geographicToWebMercator(f),b=n.geographicToWebMercator(b)):c.isWebMercator()&&4326===d.wkid&&(f=n.webMercatorToGeographic(f),
b=n.webMercatorToGeographic(b)));g.e_bl=f;g.e_tr=b;a.visible&&(this._setPos(g,e._left,e._top),(this._active||e).appendChild(g))},_setPos:function(a,b,c){var d=a.e_bl,e=a.e_tr,g=this._map,d=g.toScreen(d),e=g.toScreen(e);b=d.x-b;c=e.y-c;var q=Math.abs(e.x-d.x),d=Math.abs(d.y-e.y),e={width:q+"px",height:d+"px"},h=this._mapImages[a.e_idx];"css-transforms"===g.navigationMode?e[k._css.names.transform]=k._css.translate(b,c)+(h.rotation?" "+k._css.rotate(360-h.rotation):""):(e.left=b+"px",e.top=c+"px");f.set(a,
e);a.e_l=b;a.e_t=c;a.e_w=q;a.e_h=d},managedSuspension:!0,_setMap:function(a,b){this.inherited(arguments);var c=this._div=l.create("div",null,b),d=k._css.names,e={position:"absolute"},g=a.__visibleDelta;if(!m("ie")||8<m("ie"))e.opacity=this.opacity;"css-transforms"===a.navigationMode?(e[d.transform]=k._css.translate(g.x,g.y),f.set(c,e),c._left=g.x,c._top=g.y,e={position:"absolute",width:a.width+"px",height:a.height+"px",overflow:"visible"},this._active=l.create("div",null,c),f.set(this._active,e),
this._passive=l.create("div",null,c),f.set(this._passive,e)):(c._left=0,c._top=0,f.set(c,e));this._standby=[];d=this._mapImages;g=d.length;for(e=0;e<g;e++){var q=d[e];q._node||this._createImage(q,q._idx)}s.hide(c);return c},_unsetMap:function(a,b){this._disconnect();var c=this._div;if(c){var d=this._mapImages,e,g=d.length;for(e=0;e<g;e++){var f=d[e];if(f){var h=f._node;h&&(this._clearEvents(h),h.e_idx=h.e_bl=h.e_tr=h.e_l=h.e_t=h.e_w=h.e_h=null);f._node=null}}b.removeChild(c);l.destroy(c)}this._map=
this._div=this._sr=this._active=this._passive=this._standby=null;this.inherited(arguments)},_onSuspend:function(){this._disconnect();s.hide(this._div)},_onResume:function(a){a.firstOccurrence&&(this._sr=this._map.spatialReference,this._processStandbyList());a=this._map;var b=this._div,c=a.__visibleDelta;"css-transforms"===a.navigationMode&&(b._left=c.x,b._top=c.y,f.set(b,k._css.names.transform,k._css.translate(b._left,b._top)));this._redraw("css-transforms"===a.navigationMode);this._connect(a);s.show(b)},
_connect:function(a){if(!this._connections){var b="css-transforms"===a.navigationMode;this._connections=[a.on("pan-start",this._panStart),a.on("pan",this._pan),a.on("extent-change",this._extentChange),b&&a.on("zoom-start",this._zoomStart),b?a.on("scale",this._scale):a.on("zoom",this._zoom),b&&a.on("resize",this._resize)]}},_disconnect:function(){this._connections&&(w.forEach(this._connections,function(a){a.remove()}),this._connections=null)},_panStart:function(){this._panL=this._div._left;this._panT=
this._div._top},_pan:function(a,b){var c=this._div;c._left=this._panL+b.x;c._top=this._panT+b.y;"css-transforms"===this._map.navigationMode?f.set(c,k._css.names.transform,k._css.translate(c._left,c._top)):f.set(c,{left:c._left+"px",top:c._top+"px"})},_extentChange:function(a,b,c){c?this._redraw("css-transforms"===this._map.navigationMode):b&&this._pan(a,b);this._processStandbyList()},_processStandbyList:function(){var a,b=this._standby;if(b&&b.length)for(a=b.length-1;0<=a;a--)this._imageLoaded(null,
b[a]),b.splice(a,1)},_redraw:function(a){if(a){a=this._passive;var b=k._css.names;f.set(a,b.transition,"none");this._moveImages(a,this._active);f.set(a,b.transform,"none")}a=this._active||this._div;var b=this._div._left,c=this._div._top,d,e=a.childNodes.length,g;for(d=0;d<e;d++)g=a.childNodes[d],this._setPos(g,b,c)},_zoom:function(a,b,c){a=this._div;var d=a._left,e=a._top,g,k=a.childNodes.length,h;for(g=0;g<k;g++){h=a.childNodes[g];var l=h.e_w*b,m=h.e_h*b,n=(c.x-d-h.e_l)*(l-h.e_w)/h.e_w,p=(c.y-e-
h.e_t)*(m-h.e_h)/h.e_h,n=isNaN(n)?0:n,p=isNaN(p)?0:p;f.set(h,{left:h.e_l-n+"px",top:h.e_t-p+"px",width:l+"px",height:m+"px"})}},_zoomStart:function(){this._moveImages(this._active,this._passive)},_moveImages:function(a,b){var c=a.childNodes,d;d=c.length;if(0<d)for(d-=1;0<=d;d--)b.appendChild(c[d])},_scale:function(a,b){var c=k._css.names,d=this._passive;f.set(d,c.transition,b?"none":c.transformName+" "+x.defaults.map.zoomDuration+"ms ease");k._css.matrix(a);f.set(d,c.transform,k._css.matrix(a))},
_resize:function(a,b,c){f.set(this._active,{width:b+"px",height:c+"px"});f.set(this._passive,{width:b+"px",height:c+"px"})}});return p});