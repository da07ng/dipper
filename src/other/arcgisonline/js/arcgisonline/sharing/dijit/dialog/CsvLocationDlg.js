// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/CsvLocationDlg",["dijit","dojo","dojox","dojo/i18n!arcgisonline/nls/arcgisonline","dojo/require!dijit/form/Form,dojox/form/Manager,dijit/form/Button,dijit/form/Select,dojox/validate/regexp,dojox/widget/Standby,dojo/i18n,esri/symbols/SimpleMarkerSymbol,esri/renderers/SimpleRenderer,arcgisonline/sharing/util,arcgisonline/sharing/dijit/dialog/_CsvLocationDlgMixin,arcgisonline/sharing/dijit/dialog/GeneralDlg,arcgisonline/map/main,arcgisonline/sharing/dijit/HelpManager"],
function(l,b,h){b.provide("arcgisonline.sharing.dijit.dialog.CsvLocationDlg");b.require("dijit.form.Form");b.require("dojox.form.Manager");b.require("dijit.form.Button");b.require("dijit.form.Select");b.require("dojox.validate.regexp");b.require("dojox.widget.Standby");b.require("dojo.i18n");b.requireLocalization("arcgisonline","arcgisonline");b.require("esri.symbols.SimpleMarkerSymbol");b.require("esri.renderers.SimpleRenderer");b.require("arcgisonline.sharing.util");b.require("arcgisonline.sharing.dijit.dialog._CsvLocationDlgMixin");
b.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");b.require("arcgisonline.map.main");b.require("arcgisonline.sharing.dijit.HelpManager");b.declare("arcgisonline.sharing.dijit.dialog.CsvLocationDlg",[l.form.Form,l._WidgetsInTemplateMixin,h.form.manager._Mixin,h.form.manager._NodeMixin,h.form.manager._EnableMixin,h.form.manager._ValueMixin,h.form.manager._DisplayMixin,h.form.manager._ClassMixin,arcgisonline.sharing.dijit.dialog._CsvLocationDlgMixin],{templateString:b.cache("arcgisonline.sharing.dijit.dialog",
"templates/CsvLocationDlg.html",'\x3cform data-dojo-attach-point\x3d"containerNode" enctype\x3d"multipart/form-data" action\x3d"" method\x3d"POST"  data-dojo-attach-event\x3d"onsubmit:onSubmit"\x3e\r\n\x3cdiv data-dojo-attach-point\x3d"formNode" class\x3d"esriItemLinks dijitDialogPaneContentArea"\x3e\r\n  \x3cp class\x3d"csv" id\x3d"locateDiv"\x3e\r\n    \x3cspan\x3e${i18n.locateUsing}\x3c/span\x3e\r\n    \x3cinput data-dojo-type\x3d"dijit.form.RadioButton" id\x3d"geocode:latLong" name\x3d"geocode"  value\x3d"locationTypes" checked /\x3e\r\n    \x3clabel for\x3d"geocode:latLong"\x3e${i18n.latLong}\x3c/label\x3e\r\n    \x3cinput data-dojo-type\x3d"dijit.form.RadioButton" id\x3d"geocode:addr" name\x3d"geocode" value\x3d"addressTypes" /\x3e\r\n    \x3clabel for\x3d"geocode:addr"\x3e${i18n.address}\x3c/label\x3e\r\n  \x3c/p\x3e\r\n  \x3cdiv class\x3d"csv multigeocode" style\x3d"margin-bottom:1.0em;"\x3e\r\n    \x3clabel for\x3d"geocoderSelect"\x3e${i18n.selectGeocoder}\x3c/label\x3e\r\n    \x3cselect id\x3d"geocoderSelect" data-dojo-attach-point\x3d"_geocoderSelect" data-dojo-type\x3d"dijit.form.Select" style\x3d"width:175px;" data-dojo-props\x3d"maxHeight:200" name\x3d"geocodeSelect"\x3e\x3c/select\x3e\r\n  \x3c/div\x3e\r\n  \x3cdiv class\x3d"csv geocode"\x3e\r\n    \x3clabel for\x3d"geocodeAddress"\x3e${i18n.country}${i18n.colon}\x3c/label\x3e\r\n    \x3cselect data-dojo-attach-point\x3d"_countryCodes" data-dojo-type\x3d"dijit.form.Select" style\x3d"width:175px;" data-dojo-props\x3d"maxHeight:200" id\x3d"geocodeAddress" name\x3d"geocodeAddress"\x3e\x3c/select\x3e\r\n  \x3c/div\x3e\r\n  \x3c!-- we hard code styles here so it will work in IE9-7 --\x3e\r\n  \x3cdiv class\x3d"csv" style\x3d"margin: 1.0em 0 1.0em 0;"\x3e${i18n.review}\x3c/div\x3e\r\n  \x3cdiv data-dojo-attach-point\x3d"gridNodeAddr" class\x3d"grid" style\x3d"width:448px;height:150px"\x3e\x3c/div\x3e\r\n  \x3cdiv data-dojo-attach-point\x3d"gridNodeLatLong" class\x3d"grid" style\x3d"display:none;width:448px;height:150px"\x3e\x3c/div\x3e\r\n  \x3cdiv data-dojo-attach-point\x3d"geocodingMsg"\x3e\x3cspan class\x3d"csv"\x3e${i18n.geocodingMsg}\x3c/span\x3e\x3c/div\x3e\r\n\x3c/div\x3e\r\n\x3cbr /\x3e\r\n\x3cdiv class\x3d"submitButtons dijitDialogPaneActionBar"\x3e\r\n    \x3cspan data-dojo-attach-point\x3d"spinnerNode" style\x3d"display:none"\x3e${i18n.pleaseWait}\x3c/span\x3e\r\n    \x3cinput data-dojo-attach-point\x3d"_okBtn" data-dojo-type\x3d"dijit.form.Button" name\x3d"addLayer" class\x3d"primary" type\x3d"submit"\x3e\r\n    \x3cinput data-dojo-attach-point\x3d"_cancelBtn" data-dojo-type\x3d"dijit.form.Button" name\x3d"cancel" class\x3d"cancel" type\x3d"button" data-dojo-observer\x3d"onCancel"\x3e\r\n\x3c/div\x3e\r\n\x3c/form\x3e'),
baseClass:"esriAGOCsvLocationForm",_requestParams:{f:"json"},publishParameters:{},helpLink:null,postMixInProperties:function(){this.inherited(arguments);this.i18n=b.mixin({},b.i18n.getLocalization("arcgisonline","arcgisonline").common);this.i18n=b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").addItemFrm);this.i18n=b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").CsvLocationDlg);this.countryCodes=b.mixin({},b.i18n.getLocalization("arcgisonline","arcgisonline").countryCodes)},
startup:function(){this.inherited(arguments);this._loadConnections();this._util=arcgisonline.sharing.util;this._errorDlg=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();this._user=b.mixin(this._util.getUser(),this.overrideUser||{});this._isLoggedIn=this._util.getUser()?!0:!1;this._contentUri=esriGeowConfig.restBaseUrl+(esriGeowConfig.restBaseUrl.lastIndexOf("/")===esriGeowConfig.restBaseUrl.length-1?"":"/")+"content";this._geocodeServiceUrl=this._agoGeocodeServiceUrl=
"arcgis.com/arcgis/rest/services/world/geocodeserver";this._geocodeServers=(this._helperServices=esriGeowConfig.self&&esriGeowConfig.self.helperServices)&&this._helperServices.geocode;this._isPortal=arcgisonline.sharing.util.isPortal();this._roleCanCreateItem=(this._isCustomRole=esriGeowConfig.userRole)&&esriGeowConfig.userRole.canCreateItem();this._roleCanPublishFeatures=this._isCustomRole&&this._roleCanCreateItem&&esriGeowConfig.userRole.canPublishFeatures();this._roleCanPublishTiles=this._isCustomRole&&
this._roleCanCreateItem&&esriGeowConfig.userRole.canPublishTiles();this._roleCanUseGeocode=this._isCustomRole&&esriGeowConfig.userRole.canUseGeocode();this._geocodeServers=this._util.filterBatchGeocoders(this._geocodeServers);if(esriGeowConfig.userRole&&!esriGeowConfig.userRole.canUseGeocode()){var a=-1;if(this._geocodeServers&&this._geocodeServers.length)for(var c=0;c<this._geocodeServers.length&&!(isWorldGeocodeServer=arcgisonline.sharing.util.isEsriWorldGeocoder(this._geocodeServers[c].url),a=
c,isWorldGeocodeServer);c++);isWorldGeocodeServer&&this._geocodeServers.splice(a,1)}this._geocodeServers&&this._geocodeServers.length&&(this._setGeocoder(this._geocodeServers[0].url),this._setGeocoderOptions(),2>this._geocodeServers.length&&b.query(".multigeocode").style("display","none"));esri.config.defaults.io.proxyUrl=esriGeowConfig.proxyServer;this._requestParams.token=this._user.token;this._isLoggedIn&&this._fetchCountryCodes()},_setGeocoderOptions:function(){for(var b=[],c=0;c<this._geocodeServers.length;c++)b.push({label:this._geocodeServers[c].name,
value:this._geocodeServers[c].url});this._geocoderSelect.set("options",b);this._geocoderSelect.set("value",this._geocodeServers[0].name,!1)},_setGeocoder:function(b){this._geocodeServiceUrl=b;this._isAgoWorldGeocodeServer=this._util.isEsriWorldGeocoderNoProxy(this._geocodeServiceUrl);this._isServiceProxyAgoWorldGeocodeServer=this._util.isEsriWorldGeocoderThroughProxy(this._geocodeServiceUrl);this._isWorldGeocodeServer=this._isAgoWorldGeocodeServer||this._isServiceProxyAgoWorldGeocodeServer},enable:function(b,
c){this.inherited(arguments);esri.hide(this.spinnerNode)},disable:function(a,c){this.inherited(arguments);b.attr(this.spinnerNode,"innerHTML",c||this.i18n.pleaseWait);b.style(this.spinnerNode,"display","inline-block")},onCancel:function(){this.dialog&&this.dialog.hide()},onSubmit:function(b){b.preventDefault();this._getFeatureCollection()},start:function(b,c,d,f,e){this.data=b;this.fileName=c;this.url=d;this.fullRecordCount=f;this._loadCSV(e)},_createGrid:function(a){a=b.map(a,b.hitch(this,function(a){for(var d in this.publishParameters.addressFields)if(this.publishParameters.addressFields[d]===
a.name)return b.mixin(a,{locationType:d});return b.mixin(a,{locationType:"unknown"})}));"addressTypes"===this._getRadioButtonValue("geocode")?this._useAddrGrid():this._useLatLongGrid();this.enable();this.dialog&&9>b.isIE&&b.style(this.dialog.domNode,"height","420px")},_getRadioButtonValue:function(a){var c;return 9>=b.isIE?(b.some(this.formWidgets[a].widget||[],function(b){return b.get("checked")?(c=b,!0):!1}),c?c.get("value"):""):this.elementValue(a)},_useAddrGrid:function(){var a=this._isLoggedIn&&
(!this._isPortal&&this._isWorldGeocodeServer||this._isPortal&&this._isServiceProxyAgoWorldGeocodeServer);b.query(".geocode").style("display",a?9>b.isIE?"block":"":"none");b.style(this.gridNodeAddr,"display","block");b.style(this.gridNodeLatLong,"display","none");this.url?b.style(this.geocodingMsg,"display","block"):b.style(this.geocodingMsg,"display","none");var a=b.clone(this.publishParameters.layerInfo&&this.publishParameters.layerInfo.fields),c=this.gridInfoAddr,d=[];b.forEach(c,function(a){a.name=
this.i18n[a.name]||a.name;if(a.select){var c=b.mixin({},b.mixin(b.clone(this.i18n.notUsed),this.publishParameters.standardizedFieldNames||this.i18n[a.select]));a=b.mixin(a,this._toSelectOptions(c));d=a.values}},this);b.forEach(a,function(a){a.locationType&&-1==b.indexOf(d,a.locationType)&&(a.locationType="unknown")});this._mStoreAddr=new b.store.Memory({data:a,idProperty:"name"});this._oStoreAddr=new b.data.ObjectStore({objectStore:this._mStoreAddr});this._gridAddr?(this._gridAddr.set("structure",
c),this._gridAddr.setStore(this._oStoreAddr)):(this._gridAddr=new h.grid.DataGrid({id:"_csv_grid_Addr",selectionMode:"none",singleClickEdit:!0},b.create("div",null,this.gridNodeAddr)),this._gridAddr.set("structure",c),this._gridAddr.setStore(this._oStoreAddr),this._gridAddr.startup(),this._gridConnects.push(b.connect(this._oStoreAddr,"onSet",b.hitch(this,function(b,a,c,d){"locationType"===a&&this._mStoreAddr.query({locationType:d}).forEach(function(a){a.name!==b.name&&(a=this._mStoreAddr.get(a.name),
a.locationType="unknown",this._mStoreAddr.put(a))},this)}))),this._gridConnects.push(b.connect(this._gridAddr,"onApplyCellEdit",b.hitch(this,function(a,c,d){if("locationType"===d&&a===this.publishParameters.standardizedFieldNames.Postal){var k=this._gridAddr.getItem(c);k.__isTypeUpdatedByUser||(k.type="esriFieldTypeString",k.__isTypeUpdatedByUser=!0,this._mStoreAddr.put(k),b.some(this.publishParameters.layerInfo.fields||[],b.hitch(this,function(b){return b.name===k.name?(b.type=k.type,!0):!1})))}}))));
this._mStore=this._mStoreAddr;this._oStore=this._oStoreAddr;this._grid=this._gridAddr},_fetchCountryCodes:function(){var b=[],c=esriGeowConfig.self||{},c=(c.user||{}).region||c.region||c.ipCntryCode||"",d;for(d in this.countryCodes)b.push({label:this.countryCodes[d],value:d.toLowerCase()});b=b.sort(function(b,a){return b.label<a.label?-1:b.label>a.label?1:0});this._countryCodes.set("options",b);this._countryCodes.set("value",this.countryCodes[c]?c.toLowerCase():"world")},_useLatLongGrid:function(){b.query(".geocode").style("display",
"none");b.style(this.gridNodeAddr,"display","none");b.style(this.geocodingMsg,"display","none");b.style(this.gridNodeLatLong,"display","block");9>=b.isIE&&(b.style(this.gridNodeLatLong,"width","448px"),b.style(this.gridNodeLatLong,"height","150px"));if(!this._gridLatLong){var a=b.clone(this.publishParameters.layerInfo&&this.publishParameters.layerInfo.fields),c=this.gridInfoLatLong,d=[];b.forEach(c,function(a){a.name=this.i18n[a.name]||a.name;if(a.select){var c=b.mixin({},this.i18n[a.select]);a=b.mixin(a,
this._toSelectOptions(c));d=a.values}},this);b.forEach(a,function(a){a.locationType&&-1==b.indexOf(d,a.locationType)&&(a.locationType="unknown")});this._mStoreLatLong=new b.store.Memory({data:a,idProperty:"name"});this._oStoreLatLong=new b.data.ObjectStore({objectStore:this._mStoreLatLong});this._gridLatLong=new h.grid.DataGrid({id:"_csv_grid_latLong",selectionMode:"none",singleClickEdit:!0},b.create("div",null,this.gridNodeLatLong));this._gridLatLong.set("structure",c);this._gridLatLong.setStore(this._oStoreLatLong);
this._gridLatLong.startup();this._gridConnects.push(b.connect(this._oStoreLatLong,"onSet",b.hitch(this,function(b,a,c,d){"locationType"===a&&this._mStoreLatLong.query({locationType:d}).forEach(function(a){a.name!==b.name&&(a=this._mStoreLatLong.get(a.name),a.locationType="unknown",this._mStoreLatLong.put(a))},this)})))}this._mStore=this._mStoreLatLong;this._oStore=this._oStoreLatLong;this._grid=this._gridLatLong},deleteGrid:function(){this._gridAddr&&(delete this._mStoreAddr,delete this._oStoreAddr,
this._gridAddr.destroy(),delete this._gridAddr);this._gridLatLong&&(delete this._mStoreLatLong,delete this._oStoreLatLong,this._gridLatLong.destroy(),delete this._gridLatLong);this._mStore=this._mStoreAddr=this._mStoreLatLong=this._oStore=this._oStoreAddr=this._oStoreLatLong=this._grid=this._gridAddr=this._gridLatLong=null},_loadCSV:function(a){a&&(this.publishParameters=a.publishParameters||{},this._isWorldGeocodeServer&&this._isPortal&&!this._isServiceProxyAgoWorldGeocodeServer?(this.elementValue("geocode",
"locationTypes"),b.style(b.byId("locateDiv"),"display","none")):(this._isWorldGeocodeServer&&this._countryCodes.set("value",a.publishParameters.sourceCountry||"world",!1),this.elementValue("geocode","address"===this.publishParameters.locationType||"none"===this.publishParameters.locationType&&this.publishParameters.standardizedFieldNames?"addressTypes":"locationTypes"),"address"!==this.publishParameters.locationType&&b.query(".multigeocode").style("display","none")),this._analyzed="addressTypes"===
this.elementValue("geocode"),this._createGrid(this.publishParameters.layerInfo&&this.publishParameters.layerInfo.fields||[]))},_getFeatureCollection:function(){var a=this._getRadioButtonValue("geocode");"addressTypes"===a?this._callGenerate(a):this._readLocal(a)},_callGenerate:function(a){this.disable(null,this.i18n.updating);var c=b.mixin({},this.publishParameters.standardizedFieldNames||this.i18n[a]);this._gridAddr&&this._gridAddr.edit.apply();this.publishParameters.locationType="address";var d=
0,f={};this._mStore.query(function(a){"unknown"!==a.locationType&&a.locationType in c&&(f[a.locationType]=a.name,d++)});if(1>d)return this._showError(this.i18n.errors.noAddressFields);this.publishParameters.addressFields=f;this.publishParameters.targetSR=arcgisonline.map.main.map.spatialReference.toJson();a=this.data;if(this._user.accountId&&1E3<this.fullRecordCount){var e=0,g=0;if(-1===a.indexOf("\n"))for(;-1<e&&1E3>=g;)g++,e=a.indexOf("\r",e+1);else for(;-1<e&&1E3>=g;)g++,e=a.indexOf("\n",e+1);
a=a.substring(0,e)}else if(!this._user.accountId&&250<this.fullRecordCount){g=e=0;if(-1===a.indexOf("\n"))for(;-1<e&&250>=g;)g++,e=a.indexOf("\r",e+1);else for(;-1<e&&250>=g;)g++,e=a.indexOf("\n",e+1);a=a.substring(0,e)}e=esriGeowConfig.restBaseUrl+(esriGeowConfig.restBaseUrl.lastIndexOf("/")===esriGeowConfig.restBaseUrl.length-1?"":"/");e+="content/features/generate";(g=arcgisonline.sharing.util.getToken())&&(e+="?token\x3d"+g);return this._request(e,{filetype:"csv",text:a,publishParameters:b.json.stringify(this.publishParameters)},
{usePost:!0}).then(b.hitch(this,"_addLayer"),b.hitch(this,function(a){console.log(a);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.CsvLocationDlg.error.general+(a&&a.message?" ("+a.message+")":"")})}))},_addLayer:function(a){if(a.geocodeResults&&0===a.geocodeResults.accepted){var c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();c.show({title:esri.i18nBundle.common.errorTitle,
message:esri.i18nBundle.viewer.fileImport.noRecords})}else{a.geocodeResults&&0<a.geocodeResults.rejected&&(c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),c.show({title:esri.i18nBundle.viewer.fileImport.warningTitle,message:b.string.substitute(esri.i18nBundle.viewer.fileImport.invalidAddresses,{count:a.geocodeResults.rejected})}));if(8>=b.isIE){var d=a.featureCollection.layers[0].layerDefinition.drawingInfo.renderer.symbol;d&&(d.url&&-1==d.url.indexOf("http"))&&(d.url=
arcgisonline.sharing.util.getRedSphereUrl())}if(a.featureCollection.layers[0].featureSet.features.length){a.featureCollection.layers[0].layerDefinition.capabilities="Query";c=this.fileName?this.fileName.substring(0,this.fileName.indexOf(".")):"CSV";0==c.length&&this.fileName&&(c=this.fileName);var f=arcgisonline.map.featColl.addFeatureLayers(a,c);arcgisonline.map.main.checkSuggestedScaleRangeAndZoom(f).then(function(){"rendererStack"==arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftAboutPanel();
arcgisonline.map.leftPanel.openLeftRendererPanel(f.id,-1,!0,!0,!0)},function(){"rendererStack"==arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftAboutPanel();arcgisonline.map.leftPanel.openLeftRendererPanel(f.id,-1,!0,!0,!0)});var c=f.layer,e=esri.styles.basic.getSchemes({theme:"default",basemap:"topo",geometryType:c.geometryType}).primaryScheme,d=new esri.symbols.SimpleMarkerSymbol;d.setColor(e.color);d.size=e.size;d.outline.setColor(e.outline.color);d.outline.width=
e.outline.width;d=new esri.renderers.SimpleRenderer(d);c.setRenderer(d);a=arcgisonline.map.featColl.generateDefaultPopupInfo(a.featureCollection.layers[0]);f.popupInfo=a;f.layer.setInfoTemplate(new esri.dijit.PopupTemplate(a));arcgisonline.map.popup.setupPopupHandler();f.columnDelimiter=this.publishParameters.columnDelimiter;arcgisonline.map.main.markMapAsChanged("CsvLocationDlg");if(!this._user.accountId&&250<this.fullRecordCount||this._user.accountId&&1E3<this.fullRecordCount)a=b.string.substitute(esri.i18nBundle.CsvLocationDlg.messageAddrPart1,
{appName:esriGeowConfig.portalName?esriGeowConfig.portalName:esri.i18nBundle.common.arcgisOnline,count:this._user.accountId?1E3:250}),a+="\x3cbr/\x3e\x3cbr/\x3e",this._user.accountId?(a+=b.string.substitute(esri.i18nBundle.CsvLocationDlg.messageAddrPart2Org,{count:1E3}),this.helpLink&&(a=a+"\x3cbr/\x3e\x3cbr/\x3e"+("\x3cspan class\x3d'esriItemLink'\x3e\x3cA href\x3d'"+this.helpLink+"' target\x3d'_blank'\x3e"+esri.i18nBundle.CsvLocationDlg.learnMoreOrg+"\x3c/A\x3e\x3c/span\x3e"))):(a+=b.string.substitute(esri.i18nBundle.CsvLocationDlg.messageAddrPart2,
{count:250}),a+="\x3cbr/\x3e\x3cbr/\x3e",a+="\x3cspan class\x3d'esriItemLink'\x3e\x3cA href\x3d'http://www.esri.com/software/arcgis/arcgisonline/features/organizations.html' target\x3d'_blank'\x3e"+esri.i18nBundle.CsvLocationDlg.learnMore+"\x3c/A\x3e\x3c/span\x3e"),c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),c.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:a})}else c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),c.show({title:esri.i18nBundle.common.errorTitle,
message:esri.i18nBundle.viewer.fileImport.noRecords})}this.dialog.hide()},_readLocal:function(a){this.disable(null,this.i18n.updating);var c=b.mixin({},this.i18n[a]),d={latitudeFieldName:null,longitudeFieldName:null};this._gridLatLong.edit.apply();this._mStore.query(function(a){"unknown"!==a.locationType&&a.locationType in c&&(d[a.locationType+"FieldName"]=a.alias||a.name)});if(!d.latitudeFieldName||!d.longitudeFieldName)return this._showError(this.i18n.errors.noLocationFields);arcgisonline.map.fileImport.processCsvData(this.data,
this.fileName,this.url,d.latitudeFieldName,d.longitudeFieldName,this.publishParameters.columnDelimiter);this.dialog.hide()},_request:function(a,c,d,f,e){c=b.mixin(b.mixin({},this._requestParams),c||{});d&&!1===d.addToken&&delete c.token;return esri.request({url:a,content:c,callbackParamName:"callback",timeout:d&&d.timeout||0},d).then(b.hitch(this,function(a){return!a?this._showError():a.error?this._showError(a.error):a}),b.hitch(this,function(a){e?e(a):this._showError(b.mixin({},{code:"timeout"===
a.dojoType?408:a.code,message:a.message,details:a.details}));throw a;}))},_toSelectOptions:function(a,b){var d=[],f=[],e;for(e in a)d.push(a[e]),f.push(e);return{formatter:function(d){return a[d]||b},options:d,values:f}},_loadConnections:function(){this._dlgConnect=b.connect(this.dialog,"hide",b.hitch(this,function(){this.deleteGrid();l.byId("geocode:latLong").destroy();l.byId("geocode:addr").destroy();b.forEach([this._dlgConnect].concat(this._gridConnects),b.disconnect);this.destroy()}));var a=arcgisonline.sharing.dijit.HelpManager.prototype.statics.getInstance(),
c=setInterval(b.hitch(this,function(){a.isLoaded()&&(clearInterval(c),this.helpLink=a.getHelpUrl("120000902"))}),200);this._gridConnects=[];this._gridConnects.push(b.connect(b.byId("geocode:latLong"),"onclick",b.hitch(this,function(){this._onTypeChange()})));this._gridConnects.push(b.connect(b.byId("geocode:addr"),"onclick",b.hitch(this,function(){this._onTypeChange()})));this._gridConnects.push(b.connect(this._countryCodes,"onChange",b.hitch(this,"_onCountryChange")));this._gridConnects.push(b.connect(this._geocoderSelect,
"onChange",b.hitch(this,"_onGeocoderChange")));this._okBtn.set("label",this.i18n.addLayer);this._cancelBtn.set("label",this.i18n.cancel)},_onTypeChange:function(){"addressTypes"===this.elementValue("geocode")?(this._analyzed?this._useAddrGrid():this._onCountryChange(this._countryCodes.get("value")),1<this._geocodeServers.length&&b.query(".multigeocode").style("display","")):(this._useLatLongGrid(),b.query(".multigeocode").style("display","none"))},_onGeocoderChange:function(a){this._setGeocoder(a);
this._analyzed=!1;this._onTypeChange()},_onCountryChange:function(a){var c=esriGeowConfig.restBaseUrl+(esriGeowConfig.restBaseUrl.lastIndexOf("/")===esriGeowConfig.restBaseUrl.length-1?"":"/"),d={enableGlobalGeocoding:!0,sourceLocale:b.locale};if(this._isPortal||!this._isPortal&&!this._isWorldGeocodeServer)d.geocodeServiceUrl=encodeURI(this._geocodeServiceUrl);this.data&&(d.locationType="addressTypes"===this._getRadioButtonValue("geocode")?"address":"coordinates");this._isWorldGeocodeServer&&(d.sourceCountry=
a.toLowerCase(),d.sourceCountryHint="");c+="content/features/analyze";(a=arcgisonline.sharing.util.getToken())&&(c+="?token\x3d"+a);return esri.request({url:c,content:{filetype:"csv",text:this.data,analyzeParameters:b.json.stringify(d),f:"json"},callbackParamName:"callback"},{usePost:!0}).then(b.hitch(this,function(a){this._analyzed=!0;this._isWorldGeocodeServer&&(a.publishParameters.sourceCountry=a.publishParameters.sourceCountry||"world");this._loadCSV(a)}),b.hitch(this,function(a){this._showError(a)}))},
_showError:function(a){a=a.error||a||{};a.details=a.details&&a.details.length?b.filter(a.details,"return item !\x3d\x3d null"):null;a.details&&a.details.length&&(a.details=a.details.join("\x3cbr /\x3e"),a.message=a.message?a.message+"\x3cbr /\x3e"+a.details:a.details);a=b.mixin(b.mixin({},this.i18n.error),a);this._errorDlg.show(a);this.enable();return!1}})});