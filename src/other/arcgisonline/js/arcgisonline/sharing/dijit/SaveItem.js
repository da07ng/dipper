// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/SaveItem",["dijit","dojo","dojox","dojo/require!dijit/_Widget,dijit/_Templated,dijit/form/Button,dijit/form/TextBox,dojo/data/ItemFileWriteStore,arcgisonline/sharing/dijit/ComboBox,arcgisonline/sharing/geow/Folder,arcgisonline/sharing/util,esri/dijit/Tags"],function(d,a,g){a.provide("arcgisonline.sharing.dijit.SaveItem");a.require("dijit._Widget");a.require("dijit._Templated");a.require("dijit.form.Button");a.require("dijit.form.TextBox");a.require("dojo.data.ItemFileWriteStore");
a.require("arcgisonline.sharing.dijit.ComboBox");a.require("arcgisonline.sharing.geow.Folder");a.require("arcgisonline.sharing.util");a.require("esri.dijit.Tags");a.declare("arcgisonline.sharing.dijit.SaveItem",[d._Widget,d._Templated],{widgetsInTemplate:!0,templateString:'\x3cdiv class\x3d"${baseClass}" data-dojo-attach-point\x3d"containerNode" style\x3d"width:100%; height:100%;"\x3e\r\n    \x3ctable width\x3d"100%"\x3e\r\n        \x3ctbody\x3e\r\n        \x3ctr class\x3d"save-item-title-row"\x3e\r\n            \x3ctd nowrap class\x3d"columnOne" valign\x3d"top"\x3e\r\n                \x3clabel\x3e${i18n.titleLabel}\x3c/label\x3e\r\n            \x3c/td\x3e\r\n            \x3ctd class\x3d"columnTwo"\x3e\r\n                \x3cdiv data-dojo-attach-point\x3d"saveItemTitle"\r\n                     data-dojo-type\x3d"dijit.form.TextBox"\r\n                     placeHolder\x3d"${i18n.defaultTextTitle}" trim\x3d"true" style\x3d"width: 100%;"\x3e\x3c/div\x3e\r\n            \x3c/td\x3e\r\n        \x3c/tr\x3e\r\n        \x3ctr class\x3d"spacer"\x3e\x3ctd colspan\x3d"2"\x3e\x26nbsp;\x3c/td\x3e\x3c/tr\x3e\r\n        \x3ctr class\x3d"save-item-tags-row"\x3e\r\n            \x3ctd nowrap class\x3d"columnOne" valign\x3d"top"\x3e\r\n                \x3clabel\x3e${i18n.tagsLabel}\x3c/label\x3e\r\n            \x3c/td\x3e\r\n            \x3ctd class\x3d"columnTwo"\x3e\r\n                \x3cdiv data-dojo-attach-point\x3d"saveItemTags"\r\n                     data-dojo-type\x3d"esri/dijit/Tags"\r\n                     data-dojo-props\x3d"minWidth:\'100%\',maxWidth:\'100%\'"\x3e\x3c/div\x3e\r\n              \x3c!--\x3cdiv data-dojo-attach-point\x3d"saveItemTags"--\x3e\r\n                     \x3c!--data-dojo-type\x3d"dijit.form.TextBox"--\x3e\r\n                     \x3c!--placeHolder\x3d"${i18n.defaultTextTags}" trim\x3d"true"\x3e\x3c/div\x3e\x3cbr/\x3e--\x3e\r\n                \x3c!--\x3cspan class\x3d"esriItemLinks" style\x3d"cursor:pointer; line-height:20px;"\x3e--\x3e\r\n                    \x3c!--\x3ca target\x3d"_blank" data-dojo-attach-event\x3d"onclick:_onChooseTags"\x3e${i18n.chooseFromTagsLabel}\x3c/a\x3e--\x3e\r\n                \x3c!--\x3c/span\x3e--\x3e\r\n            \x3c/td\x3e\r\n        \x3c/tr\x3e\r\n        \x3ctr class\x3d"spacer"\x3e\x3ctd colspan\x3d"2"\x3e\x26nbsp;\x3c/td\x3e\x3c/tr\x3e\r\n        \x3ctr class\x3d"save-item-summary-row"\x3e\r\n            \x3ctd class\x3d"columnOne" valign\x3d"top"\x3e\r\n                \x3clabel\x3e${i18n.summaryLabel}\x3c/label\x3e\r\n            \x3c/td\x3e\r\n            \x3ctd class\x3d"columnTwo"\x3e\r\n                \x3cdiv data-dojo-attach-point\x3d"saveItemSummary"\r\n                     data-dojo-type\x3d"dijit.form.TextBox"\r\n                     placeHolder\x3d"${i18n.defaultTextSummary}" maxlength\x3d"250" trim\x3d"true" style\x3d"width: 100%;"\x3e\x3c/div\x3e\r\n            \x3c/td\x3e\r\n        \x3c/tr\x3e\r\n        \x3ctr class\x3d"spacer"\x3e\x3ctd colspan\x3d"2"\x3e\x26nbsp;\x3c/td\x3e\x3c/tr\x3e\r\n        \x3ctr class\x3d"save-item-folder-row"\x3e\r\n            \x3ctd class\x3d"columnOne" valign\x3d"top"\x3e\r\n                \x3clabel\x3e${i18n.saveInFolderLabel}\x3c/label\x3e\r\n            \x3c/td\x3e\r\n            \x3ctd class\x3d"columnTwo"\x3e\r\n                \x3cdiv data-dojo-attach-point\x3d"saveItemFolder"\r\n                     data-dojo-type\x3d"arcgisonline.sharing.dijit.ComboBox"\r\n                     data-dojo-attach-event\x3d"onChange:_onFolderChange"\x3e\x3c/div\x3e\r\n            \x3c/td\x3e\r\n        \x3c/tr\x3e\r\n        \x3c/tbody\x3e\r\n    \x3c/table\x3e\r\n\x3c/div\x3e',
baseClass:"esriAGOSaveItemForm",util:arcgisonline.sharing.util,folder:arcgisonline.sharing.geow.Folder,init:!1,foldersJson:null,folderId:null,folderName:null,folders:{},requires:null,saveItemTitle:null,saveItemTags:null,saveItemSummary:null,saveItemFolder:null,i18n:null,tagConns:{},postMixInProperties:function(){this.inherited(arguments);this.i18n=a.i18n.getLocalization("arcgisonline","arcgisonline").common;a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").saveItem)},postCreate:function(){this.init||
(this._getFolders(),this.init=!0);this._isIE8=9>a.isIE},startup:function(){this.inherited(arguments);this._loadConnections()},hideRow:function(b){a.query(".save-item-"+b+"-row").forEach(function(a){esri.hide(a)})},loadTags:function(b){var c=this.util.getUser();b&&(c=b);return this.util.loadUserTags(c.username).then(a.hitch(this,function(b){this.saveItemTags.set("knownTags",b);this.tagConns.change||(this.tagConns.change=this._isIE8?a.connect(this.saveItemTags._textTags,"onChange",a.hitch(this,this._validate)):
a.connect(this.saveItemTags._inputTextBox,"onChange",a.hitch(this,this._validate)));this.tagConns.keyup||(this.tagConns.keyup=this._isIE8?a.connect(this.saveItemTags._textTags,"onKeyUp",a.hitch(this,this._validate)):a.connect(this.saveItemTags._inputTextBox,"onKeyUp",a.hitch(this,this._validate)));this.tagConns.blur||(this.tagConns.blur=this._isIE8?a.connect(this.saveItemTags._textTags,"onBlur",a.hitch(this,this._validate)):a.connect(this.saveItemTags._inputTextBox,"onBlur",a.hitch(this,this._validate)))}))},
_validate:function(){var b=!0;if(null===this.requires)var b=this.saveItemTitle.get("value"),c=this.saveItemTags.get("tags"),f=this.saveItemSummary.get("value"),b=!(!b||!c||!f);else-1<a.indexOf(this.requires,"title")&&(b=b&&!!this.saveItemTitle.get("value")),-1<a.indexOf(this.requires,"tags")&&(b=b&&0!==this.saveItemTags.get("tags").length),-1<a.indexOf(this.requires,"summary")&&(b=b&&!!this.saveItemSummary.get("value"));a.publish("onSaveItemValidate",[b])},_loadConnections:function(){a.connect(this.saveItemTitle,
"onChange",a.hitch(this,this._validate));a.connect(this.saveItemSummary,"onChange",a.hitch(this,this._validate));a.connect(this.saveItemTitle,"onKeyUp",a.hitch(this,this._validate));a.connect(this.saveItemSummary,"onKeyUp",a.hitch(this,this._validate))},_getFolders:function(){var b=arcgisonline.sharing.util.getUser();if(null!==b){var c=new a.data.ItemFileWriteStore({data:{identifier:"name",items:[]}});c.newItem({name:b.email,id:""});this.saveItemFolder.set("store",c);this.saveItemFolder.set("value",
b.email);this.folder.getFolders(a.hitch(this,function(b){var e=null;if(a.cookie("ESRI_Content")){var d=this.util.getCookie("ESRI_Content");d.folderId&&(e=d.folderId)}this.foldersJson=b.folders;a.forEach(b.folders,function(a,b){c.newItem({name:a.title,id:a.id});this.folders["id"+a.id]=a.title.replace(/\"/g,'\\"');e===a.id&&(this.saveItemFolder.set("value",a.title),this.folderId=e,this.folderName=a.title)},this);c.save({})}),a.hitch(this,function(a){console.log("error retrieving user folders",a)}))}},
_onFolderChange:function(b){this.saveItemFolder.get("store").fetch({onComplete:a.hitch(this,function(c){a.forEach(c,a.hitch(this,function(a){a.name[0]===b&&(this.folderId=a.id[0],this.folderName=a.name[0])}))})})},_setTitleAttr:function(a){this.saveItemTitle.set("value",a)},_getTitleAttr:function(){return this.saveItemTitle.get("value")},_setTagsAttr:function(a){this.saveItemTags.set("tags",a)},_getTagsAttr:function(){return this.saveItemTags.get("tags")},_setSummaryAttr:function(a){this.saveItemSummary.set("value",
a)},_getSummaryAttr:function(){return this.saveItemSummary.get("value")},_setFolderAttr:function(b){this.saveItemFolder.get("store").fetch({onComplete:a.hitch(this,function(c){a.forEach(c,a.hitch(this,function(a){a.name[0]===b&&(this.folderId=a.id[0],this.folderName=a.name[0],this.saveItemFolder.set("value",this.folderName))}))})})},_getFolderAttr:function(){return this.folderName},_setFolderIdAttr:function(b){this.saveItemFolder.get("store").fetch({onComplete:a.hitch(this,function(c){a.forEach(c,
a.hitch(this,function(a){a.id[0]===b&&(this.folderId=a.id[0],this.folderName=a.name[0],this.saveItemFolder.set("value",a.name[0]))}))})})},_getFolderIdAttr:function(){return this.folderId},_setRequiresAttr:function(a){this.requires=a?a:null},_setTitlePlaceHolderAttr:function(a){this.saveItemTitle.set("placeHolder",a)},_setTagsPlaceHolderAttr:function(a){this.saveItemTitle.set("placeHolder",a)},_setSummaryPlaceHolderAttr:function(a){this.saveItemSummary.set("placeHolder",a)}})});