// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/ShareCheckDlg",["dijit","dojo","dojox","dojo/require!dijit/Dialog,dijit/_Widget,dijit/_Templated,arcgisonline/sharing/util"],function(k,b,n){b.provide("arcgisonline.sharing.dijit.dialog.ShareCheckDlg");b.require("dijit.Dialog");b.require("dijit._Widget");b.require("dijit._Templated");b.require("arcgisonline.sharing.util");b.declare("arcgisonline.sharing.dijit.dialog.ShareCheckDlg",[k._Widget,k._Templated],{widgetsInTemplate:!0,templateString:'\x3cdiv class\x3d"widgetContent"\x3e\r\n  \x3cdiv dojotype\x3d"dijit.Dialog" id\x3d"shareCheck-dialog" title\x3d"${i18n.shareChecksDlgTitle}" execute\x3d""\x3e\r\n    \x3cstyle type\x3d"text/css"\x3e\r\n      .esri .dojoxGridHeader .dojoxGridCellFocus, .esri .dojoxGridHeader .dojoxGridCell {\r\n        border-bottom: 1px solid #CCC;\r\n      }\r\n    \x3c/style\x3e\r\n    \x3cspan dojoAttachPoint\x3d"shareCheckTopMsg"\x3e\x3c/span\x3e\r\n    \x3cdiv dojotype\x3d"dijit.layout.BorderContainer" design\x3d"headline" gutters\x3d"false" style\x3d"width:100%; height:120px; margin:20px 0 10px 0;"\x3e\r\n      \x3cdiv dojoType\x3d"dijit.layout.ContentPane" dojoAttachPoint\x3d"shareCheckGrid" region\x3d"top" style\x3d"height:118px;"\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cspan dojoAttachPoint\x3d"shareCheckBottomMsg"\x3e\x3c/span\x3e\r\n    \x3cdiv style\x3d"clear:both;"\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"esriFloatTrailing" style\x3d"padding-top:5px; padding-bottom:5px;"\x3e\r\n      \x3cbutton dojoAttachPoint\x3d"shareGridUpdateButton" dojoAttachEvent\x3d"onClick:onUpdateClick" class\x3d"jevent primary" dojoType\x3d"dijit.form.Button"\x3e\r\n        ${i18n.UpdateSharingBtn}\r\n      \x3c/button\x3e\r\n      \x3cbutton dojoAttachEvent\x3d"onClick:onCancelClick" dojoAttachPoint\x3d"exitButton" class\x3d"jevent cancel" dojoType\x3d"dijit.form.Button"\x3e\r\n        ${i18n.cancel}\r\n      \x3c/button\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv style\x3d"clear:both;"\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e\r\n',
grid:null,gridId:"shareCheckGridNode",statics:{_instance:null,getInstance:function(){this._instance&&(k.byId("shareCheck-dialog")&&k.byId("shareCheck-dialog").destroyRecursive(!0),this._instance=null);null==this._instance&&(this._instance=new arcgisonline.sharing.dijit.dialog.ShareCheckDlg);return this._instance}},postMixInProperties:function(){this.inherited(arguments);this.i18n=b.i18n.getLocalization("arcgisonline","arcgisonline").common;b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").shareCheckDlg)},
show:function(a){var c=function(a,c,d){var f=!1,g=!1;if(("public"===a||"org"===a)&&void 0!==d.ownerFolder)return{userCanUpdate:!0,hasItemWithKnownGroupDetails:f,unknownGroupDetails:g};if("shared"===a)if(void 0!==d.ownerFolder){f=!0;a=this.info.itemsSharing[e]?this.info.itemsSharing[e].groups:[];d=arcgisonline.sharing.utilShare.ownerGroups[d.owner];for(var h=0;h<c.length;h++)if(-1===b.indexOf(a,c[h])&&(!esri.isDefined(d)||esri.isDefined(d)&&-1<b.indexOf(d,c[h])))return{userCanUpdate:!0,hasItemWithKnownGroupDetails:f,
unknownGroupDetails:g}}else g=!0;return{userCanUpdate:!1,hasItemWithKnownGroupDetails:f,unknownGroupDetails:g}};this.info=a;a=!1;var d=this.info.mainItemCard.access,e;for(e in this.info.itemCards){var f=this.info.itemCards[e],l=this.info.mainItemSharing?this.info.mainItemSharing.groups:[];if(!1===f.needsUpdate){if(f.webMapInfo){for(var g in f.webMapInfo.itemCards){var h=c(d,l,f.webMapInfo.itemCards[g]);a=h.userCanUpdate;0-h.unknownGroupDetails;if(a)break}if(a)break}}else if(h=c(d,l,f),a=h.userCanUpdate,
0-h.unknownGroupDetails,a)break}a?(this.shareCheckTopMsg.innerHTML=this.info.webMapId?this.i18n.textTopWebmap:this.i18n.textTopWebapp,this.shareCheckBottomMsg.innerHTML=this.info.webMapId?this.i18n.textBottomWebmap:this.i18n.textBottomWebapp,b.style(this.shareGridUpdateButton.domNode,"display",""),this.exitButton.set("label",this.i18n.cancel)):(this.shareCheckTopMsg.innerHTML=this.info.webMapId?this.i18n.textTopWebmap:this.i18n.textTopWebapp,this.shareCheckBottomMsg.innerHTML="",b.style(this.shareGridUpdateButton.domNode,
"display","none"),this.exitButton.set("label",this.i18n.ok));this.createGrid();k.byId("shareCheck-dialog").show()},displayLayers:function(){var a=b.create("table",{border:"1",style:"width: 100%; height: 100%"},this.shareCheckItemsDiv),c=b.create("tbody",{},a),c=b.create("tr",{},c);b.create("span",{innerHTML:this.i18n.titleItem},b.create("td",{},c));b.create("span",{innerHTML:this.i18n.titleOwner},b.create("td",{},c));for(var d in this.info.itemCards){var e=this.info.itemCards[d],c=b.create("tr",{},
a);b.create("span",{innerHTML:e.title},b.create("td",{},c));b.create("span",{innerHTML:e.owner},b.create("td",{},c))}},createGrid:function(){var a=[[{name:this.i18n.titleLayer,field:"name",width:"210px"},{name:this.i18n.titleOwner,field:"owner",width:"210px"}]],c=[],d;for(d in this.info.itemCards){var e=this.info.itemCards[d];!1!==e.needsUpdate&&c.push({id:e.id,name:e.title,owner:e.owner});if(e.webMapInfo)for(var f in e.webMapInfo.itemCards){var l=e.webMapInfo.itemCards[f];c.push({id:l.id,name:l.title,
owner:l.owner})}}this.memory=new b.store.Memory({data:c,idProperty:"id"});this.store=new b.data.ObjectStore({objectStore:this.memory});this.grid=new n.grid.DataGrid({store:this.store,structure:a,id:this.gridId,style:{border:"1px #CCC solid"},selectionMode:"none"},b.create("div",null,this.shareCheckGrid.domNode));this.grid.startup();k.byId("shareCheck-dialog").resize();esri.isTouchEnabled&&(this.gridScrollBox=this.grid.views.views[0].scrollboxNode,esri.setScrollable(this.gridScrollBox))},updateSharing:function(){var a=
this.info.mainItemCard.access,c=[];if("public"===a||"org"===a)for(var d in this.info.itemCards){if(a=this.info.itemCards[d],void 0!==a.ownerFolder&&c.push(this.shareItemByID(a)),a.webMapInfo)for(var e in a.webMapInfo.itemCards){var f=a.webMapInfo.itemCards[e];void 0!==f.ownerFolder&&c.push(this.shareItemByID(f))}}else{var l=this.info.mainItemSharing?this.info.mainItemSharing.groups:[],c=[];for(d in this.info.itemCards){a=this.info.itemCards[d];if(void 0!==a.ownerFolder){var g="",h="",k=this.info.itemsSharing[d]?
this.info.itemsSharing[d].groups:[],m=arcgisonline.sharing.utilShare.ownerGroups[a.owner];b.forEach(l,function(a){if(-1===b.indexOf(k,a)&&(!esri.isDefined(m)||esri.isDefined(m)&&-1<b.indexOf(m,a)))g+=h+a,h=","},this);g.length&&c.push(this.shareItemByID(a,g))}if(a.webMapInfo)for(e in a.webMapInfo.itemCards)f=a.webMapInfo.itemCards[e],void 0!==f.ownerFolder&&(h=g="",k=a.webMapInfo.itemsSharing[e]?a.webMapInfo.itemsSharing[e].groups:[],m=arcgisonline.sharing.utilShare.ownerGroups[f.owner],b.forEach(l,
function(a){if(-1===b.indexOf(k,a)&&(!esri.isDefined(m)||esri.isDefined(m)&&-1<b.indexOf(m,a)))g+=h+a,h=","},this),g.length&&c.push(this.shareItemByID(f,g)))}}c.length?(new b.DeferredList(c)).addCallback(b.hitch(this,function(a){b.forEach(a,function(a){a=a[1];a.itemId&&delete arcgisonline.sharing.utilShare.itemCards[a.itemId]});b.publish("onShareUpdate",null);this.hide()})):this.hide()},shareItemByID:function(a,c){var d=this.info.mainItemCard.access,d={everyone:"public"===d,account:"org"===d||"org"===
a.access};c&&(d.groups=c);var e=new b.Deferred;arcgisonline.sharing.geow.Content.shareItemByID(a,d,b.hitch(this,function(a){e.callback(a)}),b.hitch(this,function(a){e.errback(a)}));return e},onUpdateClick:function(){this.updateSharing()},onCancelClick:function(){this.hide()},hide:function(){this.store.close();delete this.store;delete this.memory;this.grid.destroy();delete this.grid;this.grid=this.store=this.memory=null;k.byId("shareCheck-dialog").hide()}})});