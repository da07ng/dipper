// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../../../core/declare dojo/on dojo/has ../../../core/Collection ../ResourceLoader ../TileInfoView ../Tile ../math/vec2 ../collections/ReferenceMap ../collections/Set ../engine/Container ../engine/Bitmap ./LayerView2D ./TileQueue".split(" "),function(h,v,l,w,x,y,p,z,A,m,t,B,C,D){var u=l("esri-mobile");l=h(C,{declaredClass:"esri.views.2d.layers.TiledLayerView2D",constructor:function(a){this.container=new E;this._viewHdl=v.pausable(this,"view-change",function(){this.needUpdate()}.bind(this));
this._viewWtch=this.watch("suspended, view.stationary",function(){!this.suspended&&(!u||u&&this.view.stationary)?(this.needUpdate(),this._viewHdl.resume()):this._viewHdl.pause()}.bind(this))},initialize:function(){this.then(this.setup.bind(this))},destroy:function(){this._viewWtch.remove();this._viewWtch=null;this._viewHdl.remove();this._viewHdl=null},_tCol:null,_rtCol:null,setup:function(){var a=this.layer;this.tileInfoView=new y({tileInfo:a.tileInfo,fullExtent:a.fullExtent});this._rtCol=this._tCol=
new F;a.tileMap&&(this._rtCol=new G({tileInfoView:this.tileInfoView,tileMap:a.tileMap,tiles:this._tCol}));this._loadingCol=new H({loader:this.createLoader(),tileInfoView:this.tileInfoView,layer:this.layer,tiles:this._rtCol,view:this.view});this.container.set({tileInfoView:this.tileInfoView,tiles:this._loadingCol,state:this.view.state})},update:function(){if(!this.suspended){var a=this.tileInfoView.getTileSpans(this.view.state);this._tCol.tileSpans=a}},createLoader:function(){return new x({queue:new D({tileInfo:this.layer.tileInfo,
state:this.view.state})})}});var E=h([t],{declaredClass:"TileContainer",constructor:function(){this.levels={}},_hdl:null,_tilesSetter:function(a,b){var c=this._hdl;if(b===a)return b;c&&(this.clear(),c.remove(),c=null);a&&(c=a.on("change",this._colChange.bind(this)),this._tilesAdded(a.getAll()));this._hld=c;return a},_tilesAdded:function(a){var b,c;b=0;for(c=a.length;b<c;b++){var d=a[b].tile,g=a[b].data,e=d.coords[2],f=this.levels[e],k=this.tileInfoView.getTileOrigin(z.create(),d.coords);f||(this.levels[e]=
f=new t,f.coords=this.state.center,f.resolution=d.lodInfo.resolution,this.addChild(f));d.bitmap=new B({coords:k,source:g});f.addChild(d.bitmap)}},_tilesRemoved:function(a){var b,c,d,g;b=0;for(c=a.length;b<c;b++)if(d=a[b].tile,(g=this.levels[d.coords[2]])&&d.bitmap)g.removeChild(d.bitmap),0===g.numChildren&&(this.removeChild(g),delete this.levels[d.level])},_colChange:function(a){0<a.added.length&&this._tilesAdded(a.added);0<a.removed.length&&this._tilesRemoved(a.removed)}}),F=h([m],{declaredClass:"TileSet",
_tileSpansSetter:function(a){if(!a||0===a.length)return this.clear(),a;var b=this.keys(),c={},d=[],g=[],e,f,k,h,l,q,r,s,m,n;k=0;for(n=a.length;k<n;k++){e=a[k];f=e.lodInfo;q=e.row;r=f.z;h=e.colFrom;for(m=e.colTo;h<=m;h++)s=f.getWorldForX(h),l=f.normalizeX(h),e=p.getId(l,q,r,s),this.contains(e)?c[e]=this.getItem(e):(c[e]=new p([l,q,r,s],f),d.push(c[e]))}k=0;for(n=b.length;k<n;k++)c[b[k]]||g.push(b[k]);this.addItems(d);this.removeItems(g);return a}}),G=h([A],{declaredClass:"TileMapTilesCollection",constructor:function(){this._loading=
new m;this._tileMapCallback=this._tileMapCallback.bind(this)},_hdl:null,_tilesSetter:function(a,b){var c=this._hdl;if(b===a)return b;c&&(this.clear(),c.remove(),c=null);a&&(c=a.on("change",this._colChange.bind(this)),this._tilesAdded(a.getAll()));this._hld=c;return a},_tileMapCallback:function(a,b){this._loading.contains(b)&&(this._loading.removeItem(b),a!==b&&(a=new p([a.col,a.row,a.level,0],this.tileInfoView.getInfoForZoom(a.level)),a.world=b.world),this.addItem(a.id,a))},_tilesAdded:function(a){var b,
c,d;b=0;for(c=a.length;b<c;b++)d=a[b],!this._loading.contains(d)&&!this.contains(d)&&(this._loading.addItem(d),this.tileMap.getTile(d,this._tileMapCallback))},_tilesRemoved:function(a){this._loading.removeItems(a);this.removeItems(a)},_colChange:function(a){0<a.added.length&&this._tilesAdded(a.added);0<a.removed.length&&this._tilesRemoved(a.removed)}}),H=h([w],{declaredClass:"TileLoader",constructor:function(){this._tileLoadHandler=this._tileLoadHandler.bind(this);this._tileErrorHandler=this._tileErrorHandler.bind(this);
this._loadingList=[];this._removingList=[]},destroy:function(){this._viewHdl.remove();this._viewHdl=null},initialize:function(){this._viewHdl=this.view.watch("stationary",function(a){if(a&&!this._loadingList.length&&(!this.tiles._loading||!this.tiles._loading.length))a=this._removingList.map(function(a){return this.find(function(c){return a===c.tile})}.bind(this)),this.removeItems(a),this._removingList.length=0}.bind(this))},_hdl:null,_tilesSetter:function(a,b){var c=this._hdl;if(b===a)return b;c&&
(this.clear(),c.remove(),c=null);a&&(this._tilesAdded(a.getAll()),c=a.on("change",this._colChange.bind(this)));this._hld=c;return a},_tilesAdded:function(a){var b,c,d;b=0;for(c=a.length;b<c;b++)d=a[b],this._loadingList.push(d),this.loader.load({id:d.id,url:this.layer.getTileUrl(d.level,d.row,d.col),tile:d,loadCallback:this._tileLoadHandler,errorCallback:this._tileErrorHandler})},_tilesRemoved:function(a){var b,c,d,g,e,f=this._loadingList;b=0;for(c=a.length;b<c;b++)if(e=a[b],e.bitmap)this._removingList.push(e);
else{d=0;for(g=f.length;d<g;d++)if(f[d]===e){f.splice(d,1);break}this.loader.cancel(e.id);this._removeIntersectingTiles(e)}},_colChange:function(a){0<a.added.length&&this._tilesAdded(a.added);0<a.removed.length&&this._tilesRemoved(a.removed)},_tileLoadHandler:function(a){var b=a.request.tile,c=this._loadingList,d;this.addItem({tile:b,data:a.data});a=0;for(d=c.length;a<d;a++)if(c[a]===b){c.splice(a,1);break}this.view.stationary&&!c.length&&(!this.tiles._loading||!this.tiles._loading.length)?(b=this._removingList.map(function(a){return this.find(function(b){return a===
b.tile})}.bind(this)),this.removeItems(b),this._removingList.length=0):this._removeIntersectingTiles(b)},_removeIntersectingTiles:function(a){var b=this._loadingList,c=this._removingList,d,g,e,f=!1;for(g=c.length-1;0<=g;g--)if(d=c[g],a.intersects(d)){for(e=b.length-1;0<=e;e--)d.intersects(b[e])&&(f=!0);f||(c.splice(g,1),this.removeItemAt(this.findIndex(function(a){return a.tile===d})))}},_tileErrorHandler:function(a){}});return l});