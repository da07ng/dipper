// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/FeaturedItemsGrid",["dijit","dojo","dojox","dojo/require!arcgisonline/sharing/geow/Account,arcgisonline/sharing/geow/Content,arcgisonline/sharing/geow/Community,arcgisonline/sharing/dijit/Gallery,arcgisonline/sharing/dijit/views,arcgisonline/sharing/util"],function(g,b,h){b.provide("arcgisonline.sharing.dijit.FeaturedItemsGrid");b.require("arcgisonline.sharing.geow.Account");b.require("arcgisonline.sharing.geow.Content");b.require("arcgisonline.sharing.geow.Community");
b.require("arcgisonline.sharing.dijit.Gallery");b.require("arcgisonline.sharing.dijit.views");b.require("arcgisonline.sharing.util");b.declare("arcgisonline.sharing.dijit.FeaturedItemsGrid",[g._Widget,g._Templated],{_gallery:null,_galleryPane:null,_detailsPane:null,_detailsTextPane:null,_detailsIconPane:null,_detailsTimer:null,featuredGroupId:null,featuredItemsId:null,groupQuery:null,galleryNodes:4,galleryFilter:null,_views:arcgisonline.sharing.dijit.views,_util:arcgisonline.sharing.util,_settings:null,
_firstLoad:!0,sortField:null,showThumbnail:!0,templateString:"\x3cdiv dojoAttachPoint\x3d'containerNode'\x3e\x3c/div\x3e",i18n:null,postMixInProperties:function(){this.inherited(arguments);this.i18n=b.i18n.getLocalization("arcgisonline","arcgisonline").common;b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").featuredItemsGrid)},_getFeaturedItems:function(){var a=this._util.getUser();a&&a.accountId&&null!==a.accountId||!a&&this._settings.id?this._handleOrganization():!this.featuredItemsId&&
this.featuredGroupId?this._util.getJson(esriGeowConfig.restBaseUrl+"/search?q\x3dgroup:"+this.featuredGroupId+"\x26num\x3d100",b.hitch(this,this._handleFeaturedGroupChange),b.hitch(this,this._handleFeaturedGroupChange)):arcgisonline.sharing.geow.Content.getFeaturedItems(this.featuredItemsId,b.hitch(this,this._handleFeaturedIdChange),b.hitch(this,this._handleFeaturedIdChange))},_getFeaturedGroupItems:function(){var a=this._util.getUser();a&&a.accountId&&null!==a.accountId||!a&&this._settings.id?this._handleOrganization():
this._util.getJson(esriGeowConfig.restBaseUrl+"/search?q\x3dgroup:"+this.featuredGroupId+"\x26num\x3d100",b.hitch(this,this._handleFeaturedGroupChange),b.hitch(this,this._handleFeaturedGroupChange))},_getGroup:function(){arcgisonline.sharing.geow.Community.getGroup(this.groupQuery,b.hitch(this,this._handleGetGroup),b.hitch(this,this._handleGetGroup))},refresh:function(){this._getFeaturedItems()},postCreate:function(){this._gallery=new arcgisonline.sharing.dijit.Gallery({id:this.id+"_Gallery",nodesPerPage:this.galleryNodes,
showNodeLabels:!0,showToolTip:!0,includeNode:this.galleryFilter},b.create("div",null,this.domNode));this._gallery.set("noResultsMessage","\x3cp class\x3d'esriItemLinks'\x3e"+("\x3cspan\x3e"+this.i18n.noItemsAvailable+"\x3c/span\x3e")+"\x3c/p\x3e");this._gallery.startup()},_handleGetSelf:function(a,c,e){c&&(!c.code&&!c.message)&&(this._settings=c,void 0!==c.featuredItemsGroupQuery&&null!==c.featuredItemsGroupQuery&&(esriGeowConfig.featuredItemsGroupQuery=c.featuredItemsGroupQuery),this._settings.id&&
(b.query(".nonAccount").style("display","none"),c="\x3ca id\x3d'mapFilterSelector' href\x3d'#' class\x3d'selected' onClick\x3d'page.filterGallery(this, page.mapFilter, \"organizationMapNotes\"); return false;'\x3e"+this.i18n.maps+" \x3c/a\x3e\x3ca id\x3d'appFilterSelector' href\x3d'#' onClick\x3d'page.filterGallery(this, page.appFilter, \"organizationWebAppNotes\"); return false;'\x3e"+this.i18n.webApps+"\x3c/a\x3e\x3ca id\x3d'mobileFilterSelector' href\x3d'#' onClick\x3d'page.filterGallery(this, page.mobileFilter, \"organizationMobileAppNotes\"); return false;'\x3e"+
this.i18n.mobileApps+"\x3c/a\x3e",b.attr(b.byId("gallerySelectorLinks"),"innerHTML",c)));a&&a()},_setGroupQueryAttr:function(a){var c=b.hitch(this,function(){var c=this._util.getUser();c&&c.accountId&&null!==c.accountId||!c&&this._settings.id?this._handleOrganization():(this.groupQuery=a,!0===this._firstLoad&&(this.groupQuery=esriGeowConfig.featuredItemsGroupQuery,9>=b.isIE&&(this.groupQuery=encodeURIComponent(this.groupQuery)),this._firstLoad=!1),this.groupQuery&&0<this.groupQuery.length&&arcgisonline.sharing.geow.Community.searchGroups(this.groupQuery,
b.hitch(this,this._handleGetGroup),b.hitch(this,this._handleGetGroup)))});this._settings?c():arcgisonline.sharing.geow.Account.getSelf(b.hitch(this,this._handleGetSelf,c))},_setGalleryFilterAttr:function(a){this.galleryFilter=a;null!==this._gallery&&(this._gallery.includeNode=a,this.refresh())},_setFeaturedItemsIdAttr:function(a){null===a||0===a.length||(this.pageCount=0,this.featuredItemsId=a,this._getFeaturedItems())},_setFeaturedGroupIdAttr:function(a){null===a||0===a.length||(this.pageCount=0,
this.featuredGroupId=a,this._getFeaturedGroupItems())},_sortItemsFunction:function(a,b){return a[this.sortField]&&b[this.sortField]?b[this.sortField]-a[this.sortField]:null===a[this.sortField]&&null===b[this.sortField]?0:null!==a[this.sortField]?1:-1},_handleFeaturedIdChange:function(a,c){b.attr(this._gallery,"items",null===this.sortField?a.relatedItems:a.relatedItems.sort(b.hitch(this,this._sortItemsFunction)))},_handleFeaturedGroupChange:function(a,c){b.attr(this._gallery,"items",null===this.sortField?
a.results:a.results.sort(b.hitch(this,this._sortItemsFunction)))},_handleGallerySwivel:function(a,c){b.attr(this._gallery,"items",null===this.sortField?a.results:a.results.sort(b.hitch(this,this._sortItemsFunction)))},_handleGetGroup:function(a,c){a&&1===a.total?(b.byId("galleryTitle").innerHTML=a.results[0].title||"",a.results[0].featuredItemsId?this._setFeaturedItemsIdAttr(a.results[0].featuredItemsId):this._setFeaturedGroupIdAttr(a.results[0].id)):a&&1<a.total?console.error(b.string.substitute(this.i18n.multipleResult,
{groupQuery:this.groupQuery})):console.error(b.string.substitute(this.i18n.titleGroupNotExist,{groupQuery:this.groupQuery}))},_handleOrganization:function(){b.style(b.byId("sideNote"),"display","none");b.style(b.byId("organizationSideNote"),"display","block");var a=this.i18n.mostViewedItems,c=this.i18n.recentlyAddedItems,e=this.i18n.groups;if(void 0===esriGeowConfig.isMultiTenant||!0===esriGeowConfig.isMultiTenant)a+=this.i18n.inOrgString,c=this.i18n.itemsRecentlyAddedByOrgUsers,e=this.i18n.groupsText;
var d='\x3cdiv id\x3d"organizationWebAppNotes"\x3e\x3cp class\x3d"esriItemLinks"\x3e\x3ca href\x3d"search.html?q\x3dorgid:'+this._settings.id+'\x26t\x3dcontent\x26sortField\x3dnumviews\x26sortOrder\x3ddesc\x26focus\x3dapplications-web\x26hideq\x3dtrue"\x3e'+a+'\x3c/a\x3e\x3cbr/\x3e\x3cbr/\x3e\x3ca href\x3d"search.html?q\x3dorgid:'+this._settings.id+'\x26t\x3dcontent\x26sortField\x3dmodified\x26sortOrder\x3ddesc\x26focus\x3dapplications-web\x26hideq\x3dtrue"\x3e'+c+'\x3c/a\x3e\x3cbr/\x3e\x3cbr/\x3e\x3ca href\x3d"search.html?q\x3dorgid:'+
this._settings.id+'\x26t\x3dgroups"\x3e'+e+"\x3c/a\x3e\x3c/p\x3e\x3c/div\x3e",f='\x3cdiv id\x3d"organizationMobileAppNotes"\x3e\x3cp class\x3d"esriItemLinks"\x3e\x3ca href\x3d"search.html?q\x3dorgid:'+this._settings.id+'\x26t\x3dcontent\x26sortField\x3dnumviews\x26sortOrder\x3ddesc\x26focus\x3dapplications-mobile\x26hideq\x3dtrue"\x3e'+a+'\x3c/a\x3e\x3cbr/\x3e\x3cbr/\x3e\x3ca href\x3d"search.html?q\x3dorgid:'+this._settings.id+'\x26t\x3dcontent\x26sortField\x3dmodified\x26sortOrder\x3ddesc\x26focus\x3dapplications-mobile\x26hideq\x3dtrue"\x3e'+
c+'\x3c/a\x3e\x3cbr/\x3e\x3cbr/\x3e\x3ca href\x3d"search.html?q\x3dorgid:'+this._settings.id+'\x26t\x3dgroups"\x3e'+e+"\x3c/a\x3e\x3c/p\x3e\x3c/div\x3e",a='\x3cdiv id\x3d"organizationMapNotes"\x3e\x3cp class\x3d"esriItemLinks"\x3e\x3ca href\x3d"search.html?q\x3dorgid:'+this._settings.id+'\x26t\x3dcontent\x26sortField\x3dnumviews\x26sortOrder\x3ddesc\x26focus\x3dmaps\x26hideq\x3dtrue"\x3e'+a+'\x3c/a\x3e\x3cbr/\x3e\x3cbr/\x3e\x3ca href\x3d"search.html?q\x3dorgid:'+this._settings.id+'\x26t\x3dcontent\x26sortField\x3dmodified\x26sortOrder\x3ddesc\x26focus\x3dmaps\x26hideq\x3dtrue"\x3e'+
c+'\x3c/a\x3e\x3cbr/\x3e\x3cbr/\x3e\x3ca href\x3d"search.html?q\x3dorgid:'+this._settings.id+'\x26t\x3dgroups\x26hideq\x3dtrue"\x3e'+e+"\x3c/a\x3e\x3c/p\x3e\x3c/div\x3e";b.byId("organizationWebAppNotes").innerHTML=d;b.byId("organizationMobileAppNotes").innerHTML=f;b.byId("organizationMapNotes").innerHTML=a;(d=esriGeowConfig.featuredItemsGroupQuery)&&""!==d&&"most_viewed"!==d.toLowerCase()?arcgisonline.sharing.geow.Community.searchGroups(d,b.hitch(this,this._handleSearchGroups)):(d=this._settings.name+
this.i18n.featuredContent,this._settings.thumbnail&&0<this._settings.thumbnail.length&&(d='\x3cimg src\x3d"'+this._getOrganizationThumbnailUrl(this._settings)+'" align\x3d"center" class\x3d"groupThumbnail"/\x3e '+d),b.byId("galleryTitle").innerHTML=d,this.sortField=null,d=this._util.getUser(),f={num:100},f.q="orgid:"+(d?d.accountId:this._settings.id),f.sortField="numviews",f.sortOrder="desc",arcgisonline.sharing.geow.Content.search(esriGeowConfig.restBaseUrl+"search",f,b.hitch(this,this._handleGallerySwivel),
b.hitch(this,this._handleGallerySwivel)))},_handleSearchGroups:function(a,c){if(a&&!a.code&&!a.message&&a.results&&1===a.results.length){var e=a.results[0],d=e.title;this._settings.thumbnail&&0<this._settings.thumbnail.length&&(d='\x3cimg src\x3d"'+this._getOrganizationThumbnailUrl(this._settings)+'" align\x3d"center" class\x3d"groupThumbnail"/\x3e '+d);b.byId("galleryTitle").innerHTML=d;this._loadFeaturedContent(e.id,e.sortField,e.sortOrder)}else console.error(this.i18n.queryTooManyResults)},_handleGetGroupByID:function(a,
c){if(a&&!a.code&&!a.message){var e=a.title;this._settings.thumbnail&&0<this._settings.thumbnail.length&&(e='\x3cimg src\x3d"'+this._getOrganizationThumbnailUrl(this._settings)+'" align\x3d"center" class\x3d"groupThumbnail"/\x3e '+e);b.byId("galleryTitle").innerHTML=e;this._loadFeaturedContent(a.id,group.sortField,group.sortOrder)}else console.error(this.i18n.groupNotFoundById)},_loadFeaturedContent:function(a,c,e){this.sortField=null;this._util.getUser();var d={num:100};d.q="group:"+a;d.sortField=
c?c:"modified";d.sortOrder=e?e:"desc";arcgisonline.sharing.geow.Content.search(esriGeowConfig.restBaseUrl+"search",d,b.hitch(this,this._handleGallerySwivel),b.hitch(this,this._handleGallerySwivel))},_getOrganizationThumbnailUrl:function(a){var b=this._util.getToken();return esriGeowConfig.restBaseUrl+"portals/self/resources/"+a.thumbnail+(b?"?token\x3d"+b:"")},nextPage:function(){this._gallery.nextPage()},prevPage:function(){this._gallery.prevPage()}})});