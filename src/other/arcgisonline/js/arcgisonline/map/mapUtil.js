// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/mapUtil",["dijit","dojo","dojox","dojo/require!arcgisonline/map/main"],function(h,e,k){e.provide("arcgisonline.map.mapUtil");e.require("arcgisonline.map.main");arcgisonline.map.mapUtil={getWebMapAuthoringInfo:function(){return{authoringApp:"WebMapViewer",authoringAppVersion:arcgisonline.sharing.util.isPortal()?"10.4":"3.10",version:"2.3"}},openBlankMap:function(){var a=esriGeowConfig.baseUrl+"webmap/viewer.html";arcgisonline.map.storage.getMapCookie(function(b){b&&!0===b.c?
arcgisonline.sharing.dijit.dialog.OpenMapDlg.prototype.statics.getInstance().show(a,b):document.location=a})},openOnMap:function(a,b,c){a=e.mixin({layers:a},!0===c?{panel:"gallery",suggestField:!0}:{});var d=esriGeowConfig.baseUrl+"webmap/viewer.html?"+e.objectToQuery(a),f=esriGeowConfig.baseUrl+"signin.html?returnUrl\x3d"+encodeURIComponent(d);b="boolean"===typeof b?b:!1;arcgisonline.map.storage.getMapCookie(function(a){a&&!0===a.c?arcgisonline.sharing.dijit.dialog.OpenMapDlg.prototype.statics.getInstance().show(b?
f:d,a):document.location=b?f:d})},openOnGCSMap:function(a){var b=esriGeowConfig.baseUrl+"webmap/viewer.html?layers\x3d"+a+"\x26basemapUrl\x3d"+esriGeowConfig.gcsBasemapService;arcgisonline.map.storage.getMapCookie(function(a){a&&!0===a.c?arcgisonline.sharing.dijit.dialog.OpenMapDlg.prototype.statics.getInstance().show(b,a):document.location=b})},addToMap:function(a,b,c){a=e.mixin({layers:a,useExisting:1},!0===c?{panel:"gallery",suggestField:!0}:{});a=esriGeowConfig.baseUrl+"webmap/viewer.html?"+e.objectToQuery(a);
c=esriGeowConfig.baseUrl+"signin.html?returnUrl\x3d"+encodeURIComponent(a);document.location="boolean"===typeof b&&b?c:a},openUrlOnMap:function(a){a=esriGeowConfig.baseUrl+"webmap/viewer.html?url\x3d"+a;arcgisonline.map.storage.getMapCookie(function(b){b&&!0===b.c?arcgisonline.sharing.dijit.dialog.OpenMapDlg.prototype.statics.getInstance().show(a,b):document.location=a})},addUrlToMap:function(a){document.location=esriGeowConfig.baseUrl+"webmap/viewer.html?useExisting\x3d1\x26url\x3d"+a},openMap:function(a,
b){var c=esriGeowConfig.baseUrl+"webmap/viewer.html?webmap\x3d"+a,d=esriGeowConfig.baseUrl+"signin.html?returnUrl\x3d"+encodeURIComponent(c);b="boolean"===typeof b?b:!1;arcgisonline.map.storage.getMapCookie(function(a){a&&!0===a.c?arcgisonline.sharing.dijit.dialog.OpenMapDlg.prototype.statics.getInstance().show(b?d:c,a):document.location=b?d:c})},openMapWithBase:function(a,b,c){var d=esriGeowConfig.baseUrl+"webmap/viewer.html";null!=a&&0<a.length&&null!=b&&0<b.length?d+="?basemapType\x3d"+a+"\x26layers\x3d"+
b:null!=a&&0<a.length?d+="?basemapType\x3d"+a:null!=b&&0<b.length&&(d+="?layers\x3d"+b);esri.isDefined(c)&&(c.length&&"/"!=c)&&(d=-1===d.indexOf("?")?d+("?folder\x3d"+c):d+("\x26folder\x3d"+c));arcgisonline.map.storage.getMapCookie(function(a){a&&!0===a.c?arcgisonline.sharing.dijit.dialog.OpenMapDlg.prototype.statics.getInstance().show(d,a):document.location=d})},previewTemplate:function(a,b,c){c&&c.preventDefault();b=esriGeowConfig.restBaseUrl+"content/items/"+b+"/data";c=arcgisonline.sharing.util.getToken();
null!=c&&""!=c&&(b=b+"?token\x3d"+c);esri.request({url:b,callbackParamName:"callback"});b=a.indexOf("?");c=-1!==b?a.substr(b,a.length):"";c+=c&&c.length?"\x26":"?";c+="webmap\x3d"+arcgisonline.map.save_open.webMapInfo.id;a=a.substr(0,-1!==b?b:a.length)+c;window.open(a)},supportsOffline:function(a){for(var b=new e.Deferred,c=[],d=0;d<a.baseMap.baseMapLayers.length;d++){var f=a.baseMap.baseMapLayers[d];if(!f.url||f.type||f.layers)return b.callback(!1),b;-1==e.indexOf(c,f.url)&&c.push(f.url)}for(d=0;d<
a.operationalLayers.length;d++){f=a.operationalLayers[d];if(!f.url||f.type||f.layers)return b.callback(!1),b;-1==e.indexOf(c,f.url)&&c.push(f.url)}a=[];for(d=0;d<c.length;d++)a.push(arcgisonline.map.mapUtil.getServiceInfoHelper(c[d]));a.length?(new e.DeferredList(a)).addCallback(function(a){var e=null;for(d=0;d<c.length;d++){var f=c[d],g=a[d][1];g?(0===d&&(e=g.spatialReference),!(g.capabilities&&-1<g.capabilities.indexOf("Sync"))&&!g.exportTilesAllowed&&(!arcgisonline.sharing.util.isAgolService(f)||
!arcgisonline.map.main.agolServiceWithExportTilesAllowed(f))?b.callback(!1):0<d&&(g.singleFusedMapCache&&!arcgisonline.map.main.sameSpatialReference(e,g.spatialReference))&&b.callback(!1)):b.callback(!1)}b.callback(!0)}):b.callback(!1);return b},getServiceInfoHelper:function(a){var b=new e.Deferred;arcgisonline.map.layer.getServiceInfo(a,null,function(a){b.callback(a)},function(){b.errback()});return b},checkFSItemAccess:function(a,b){!a.itemOwner&&a.itemCard&&(a.itemOwner=a.itemCard.owner);a.itemId&&
!a.itemOwner&&!a._itemNotAccessible?arcgisonline.sharing.util.request({url:esriGeowConfig.restBaseUrl+"content/items/"+a.itemId},{disableIdentityLookup:!0}).then(e.hitch(this,function(c){c.id===a.itemId&&(a.itemOwner=c.owner,a.itemCard=c,b())}),e.hitch(this,function(){a._itemNotAccessible=!0;b()})):b()},checkHostedFSAccess:function(a,b,c){a.layer&&a.layer instanceof esri.layers.FeatureLayer&&a.itemId&&(arcgisonline.sharing.util.isHostedService(a.url)||a.itemCard&&-1<e.indexOf(a.itemCard.typeKeywords,
"providerSDS"))?arcgisonline.map.mapUtil.checkFSItemAccess(a,e.hitch(this,function(){if(a.itemCard&&-1<e.indexOf(a.itemCard.typeKeywords,"Hosted Service")){var d=arcgisonline.sharing.util.getUser();"update"===a.itemCard.itemControl||"admin"===a.itemCard.itemControl?b&&b(a):d&&esriGeowConfig.userRole&&esriGeowConfig.userRole.isAdmin()&&-1<a.url.indexOf("/"+d.accountId+"/")?b&&b(a):d&&a.itemOwner&&a.itemOwner===d.email?b&&b(a):c&&c(a)}else c&&c(a)})):c&&c(a)}}});