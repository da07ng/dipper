// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/layer",["dijit","dojo","dojox","dojo/require!arcgisonline/map/main"],function(n,f,p){f.provide("arcgisonline.map.layer");f.require("arcgisonline.map.main");arcgisonline.map.layer={addDefaultBaseLayers:function(a){arcgisonline.map.main.currentBaseService=arcgisonline.map.main.defaultBaseLayer.id;arcgisonline.map.main.isUserBaseService=!1;if(!arcgisonline.map.main.defaultBaseLayer.url&&arcgisonline.map.main.defaultBaseLayer._layerType)if("OpenStreetMap"==arcgisonline.map.main.defaultBaseLayer._layerType){var b=
new esri.layers.OpenStreetMapLayer;arcgisonline.map.main.defaultBaseLayerMapLods=b.tileInfo.lods}else-1<arcgisonline.map.main.defaultBaseLayer._layerType.indexOf("BingMaps")&&(b=new esri.virtualearth.VETiledLayer({bingMapsKey:esriGeowConfig.self.bingKey,mapStyle:esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL}),arcgisonline.map.main.defaultBaseLayerMapLods=b.tileInfo.lods);if(arcgisonline.map.main.defaultBaseLayerMapLods){arcgisonline.map.main.mapLods=arcgisonline.map.main.defaultBaseLayerMapLods;
arcgisonline.map.main.baseTilingSchemeScales="|";for(i=0;i<arcgisonline.map.main.mapLods.length;i++)arcgisonline.map.main.baseTilingSchemeScales+=arcgisonline.map.main.mapLods[i].scale+"|"}else if(arcgisonline.map.main.defaultBaseLayer.tileInfo){arcgisonline.map.main.mapLods=arcgisonline.map.main.defaultBaseLayer.tileInfo.lods;arcgisonline.map.main.baseTilingSchemeScales="|";for(i=0;i<arcgisonline.map.main.mapLods.length;i++)arcgisonline.map.main.baseTilingSchemeScales+=arcgisonline.map.main.mapLods[i].scale+
"|"}arcgisonline.map.main.createMapObject();arcgisonline.map.main.defaultExtent=new esri.geometry.Extent(esriGeowConfig.defaultExtent);if(arcgisonline.map.main.mapLods&&102100===arcgisonline.map.main.defaultExtent.spatialReference.wkid&&35E6<arcgisonline.map.main.defaultExtent.getWidth()&&25E6<arcgisonline.map.main.defaultExtent.getHeight()){for(var b=arcgisonline.map.main.map.width,d=arcgisonline.map.main.getExtentForNextTileLevel(arcgisonline.map.main.defaultExtent,b,!1),d=arcgisonline.map.main.adjustHeightToAspectRatio(d);1.05*
arcgisonline.map.main.defaultExtent.xmin>d.xmin||1.05*arcgisonline.map.main.defaultExtent.xmax<d.xmax;)d=arcgisonline.map.main.getExtentForNextTileLevel(d,b,!0),d=arcgisonline.map.main.adjustHeightToAspectRatio(d);arcgisonline.map.main.defaultExtent=d}var e=function(b){!arcgisonline.map.main.mapLods&&b.layer.tileInfo&&(arcgisonline.map.main.mapLods=b.layer.tileInfo.lods);arcgisonline.map.main.currentBaseService=b.id;arcgisonline.map.main.defaultService=b;a&&a(b);arcgisonline.map.layer.loadMoreLayers()},
b=function(a){console.log("Default basemap failed to load. ("+(arcgisonline.map.main.defaultBaseLayer.url||arcgisonline.map.main.defaultBaseLayer._layerType)+")");arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.defaultBasemapNotAvailable})};"WebTiledLayer"==arcgisonline.map.main.defaultBaseLayer._layerType?(d=f.mixin(arcgisonline.map.main.defaultBaseLayer,{type:"base"}),arcgisonline.map.webTile.addWebTiledLayer(arcgisonline.map.main.defaultBaseLayer.templateUrl,
d,f.hitch(this,function(a){e(arcgisonline.map.main.getParameterList(a))}),f.hitch(this,b))):"VectorTileLayer"===arcgisonline.map.main.defaultBaseLayer._layerType?(d=f.mixin(arcgisonline.map.main.defaultBaseLayer,{type:"base"}),arcgisonline.map.vectorTile.addVectorTileLayer(arcgisonline.map.main.defaultBaseLayer.styleUrl,d,f.hitch(this,function(a){e(arcgisonline.map.main.getParameterList(a))}),f.hitch(this,b))):"WMS"===arcgisonline.map.main.defaultBaseLayer._layerType?(d=f.mixin(arcgisonline.map.main.defaultBaseLayer,
{}),d.wmsInfo=arcgisonline.map.main.defaultBaseLayer,arcgisonline.map.wms.loadWMSFromWebmapConfig(arcgisonline.map.main.defaultBaseLayer.url,d,"base",f.hitch(this,function(a){e(a)}),f.hitch(this,b))):arcgisonline.map.main.defaultBaseLayer.url?arcgisonline.map.layer.addLayerByURL(arcgisonline.map.main.defaultBaseLayer.url,arcgisonline.map.main.defaultBaseLayer,f.hitch(this,e),f.hitch(this,b)):arcgisonline.map.main.defaultBaseLayer._layerType?arcgisonline.map.layer.addUserBaseLayerBingOrOpenStreetMap({type:arcgisonline.map.main.defaultBaseLayer._layerType,
title:arcgisonline.map.main.defaultBaseLayer.title,minScale:arcgisonline.map.main.defaultBaseLayer.minScale,maxScale:arcgisonline.map.main.defaultBaseLayer.maxScale,displayLevels:arcgisonline.map.main.defaultBaseLayer.displayLevels,visibleLayers:arcgisonline.map.main.defaultBaseLayer.visibleLayers,bingKey:arcgisonline.map.main.defaultBaseLayer.bingKey,visibility:!0},f.hitch(this,e),!0):b()},addUserBaseLayer:function(a,b){"BingMapsAerial"==a.type||"BingMapsRoad"==a.type||"BingMapsHybrid"==a.type||
"OpenStreetMap"==a.type?arcgisonline.map.layer.addUserBaseLayerBingOrOpenStreetMap(a,b):arcgisonline.map.layer.addUserBaseLayerStandard(a,b)},addUserBaseLayerStandard:function(a,b){if((9>f.isIE||f.isOpera)&&-1<a.url.indexOf("https:")&&"https:"!==location.protocol)arcgisonline.map.main.reloadViewerSecureSSL(a.url);else{if((esriGeowConfig.allSSL||"https:"==location.protocol)&&(arcgisonline.sharing.util.isHostedService(a.url)||arcgisonline.sharing.util.supportsHttps(a.url)))a.url=a.url.replace("http:",
"https:");var d=function(a,b){setTimeout(function(){var b=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();a&&a.details&&0<a.details.length&&"Unauthorized access"==a.details[0]?b.show({title:esri.i18nBundle.viewer.error.noPermissionTitle,message:esri.i18nBundle.viewer.error.secureNotSupported}):a&&a.details&&0<a.details.length&&"Missing spatial reference information."==a.details[0]?b.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.basemapMissingSR}):
b.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.basemapNotAvailable})},2E3);arcgisonline.map.layer.loadDefaultMap()},e=esri.i18nBundle.viewer.error.basemapStillTrying,g=e.indexOf("\x3cbr/\x3e");if(-1<g)var c=e.substring(0,g),e=e.substring(g+5),e=c+'\x3cdiv class\x3d"throb-loading"\x3e\x3cdiv class\x3d"throb-loading-text"\x3e'+e+"\x3c/div\x3e\x3c/div\x3e";arcgisonline.map.layer.getServiceInfo(a.url,e,function(c,e,g){a.url=e;c.mapName||c.pixelSizeX?c.capabilities&&
-1==c.capabilities.toLowerCase().indexOf("map")&&-1==c.capabilities.toLowerCase().indexOf("image")?d(c,g):arcgisonline.map.layer.addUserBaseLayerArcGISFormat(a,c,b):(arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.notSupportedBasemapType}),arcgisonline.map.layer.addDefaultBaseLayers())},d)}},addUserBaseLayerArcGISFormat:function(a,b,d){var e=a.url,g=a.title,c=a.id;arcgisonline.map.main.isUserBaseService=
!0;var f=arcgisonline.map.layer.parseServiceInfo(b,e),k=f.extent,g=g&&0<g.length?g:f.title;arcgisonline.map.main.createMapObject();arcgisonline.map.main.defaultExtent=k;arcgisonline.map.layer.addBaseLayerByURL({url:e,exclusionAreas:a.exclusionAreas,title:g,id:c,itemId:a.itemId,opacity:a.opacity,showLegend:a.showLegend,minScale:a.minScale,maxScale:a.maxScale,visibility:a.visibility,refreshInterval:a.refreshInterval,refreshIntervalChanged:a.refreshIntervalChanged,timeAnimation:a.timeAnimation,timeChanged:a.timeChanged},
function(b){arcgisonline.map.main.currentBaseService=b.id;for(var c=0;c<arcgisonline.map.main.mapLayers.length;c++)arcgisonline.map.main.mapLayers[c].id==b.id&&(arcgisonline.map.main.defaultService=arcgisonline.map.main.mapLayers[c]);d&&d(arcgisonline.map.main.defaultService);a.id||arcgisonline.map.layer.loadMoreLayers()},function(a,b){console.log(a);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.basemapNotAvailable});
arcgisonline.map.layer.loadDefaultMap()},b)},addUserBaseLayerBingOrOpenStreetMap:function(a,b,d){var e=a.type,g=a.opacity,c=a.title,l=a.id;if(arcgisonline.map.main.defaultBaseLayerMapLods){arcgisonline.map.main.mapLods=arcgisonline.map.main.defaultBaseLayerMapLods;arcgisonline.map.main.baseTilingSchemeScales="|";for(i=0;i<arcgisonline.map.main.mapLods.length;i++)arcgisonline.map.main.baseTilingSchemeScales+=arcgisonline.map.main.mapLods[i].scale+"|"}d||(arcgisonline.map.main.isUserBaseService=!0,
arcgisonline.map.main.createMapObject(),arcgisonline.map.main.defaultExtent=new esri.geometry.Extent(-2.0037508342787E7,-2.003750834278E7,2.003750834278E7,2.0037508342787E7,new esri.SpatialReference({wkid:102100})));if(null==c||0==c.length)switch(e){case "BingMapsAerial":c="Bing\x26trade; Aerial Map";break;case "BingMapsRoad":c="Bing\x26trade; Road Map";break;case "BingMapsHybrid":c="Bing\x26trade; Aerial Map with Labels";break;default:c="Open Street Map"}var k={layer:null,id:l||e,type:"base",title:c,
url:"",bingKey:a.bingKey,defaultVisibility:a.visibility,minScale:a.minScale,maxScale:a.maxScale,displayLevels:a.displayLevels,startVisibleLayers:a.visibleLayers,snippet:"",identify:!1,hadError:!1,successfulDraw:!1};arcgisonline.map.main.mapLayers.splice(0,0,k);arcgisonline.map.main.currentBaseService=e;k.layer="OpenStreetMap"==e?new esri.layers.OpenStreetMapLayer({id:k.id,opacity:g||0===g?g:1,visible:!1}):new esri.virtualearth.VETiledLayer({bingMapsKey:k.bingKey,mapStyle:"BingMapsAerial"==e?esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL:
"BingMapsRoad"==e?esri.virtualearth.VETiledLayer.MAP_STYLE_ROAD:esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL_WITH_LABELS,id:k.id,opacity:g||0===g?g:1,visible:!1});f.connect(k.layer,"onError",f.hitch(arcgisonline.map.layer,"layerOnErrorHandler",k));arcgisonline.map.main.map.addLayer(k.layer);a=function(){arcgisonline.map.main.defaultService=k;arcgisonline.map.main.currentBaseService=k.layer.id;b&&b(k)};k.layer.loaded?a():f.connect(k.layer,"onLoad",a)},loadMoreLayers:function(){var a=arcgisonline.sharing.util.urlToObject(document.URL);
a.query=a.query||{};if(arcgisonline.map.main.isUserBaseService)a.query.basemapReferenceUrl&&a.query.basemapUrl&&arcgisonline.map.layer.addLabelsLayer(arcgisonline.map.main.decodeUrl(a.query.basemapReferenceUrl));else if(1<esriGeowConfig.defaultBasemap.baseMapLayers.length){var b=[];f.forEach(esriGeowConfig.defaultBasemap.baseMapLayers,function(a,d){if(0!==d)if(a.isReference){var c={type:"labels",visibility:a.visibility,opacity:a.opacity,title:"Reference",minScale:a.minScale,maxScale:a.maxScale,displayLevels:a.displayLevels,
exclusionAreas:a.exclusionAreas,startVisibleLayers:a.visibleLayers,snippet:"",bandIds:a.bandIds,serviceInfo:null,showLegend:a.showLegend};a.id&&(c.id=a.id);a.itemId&&(c.itemId=a.itemId);if("WebTiledLayer"===a.type)c=f.mixin(a,{type:"labels",title:"Reference"}),arcgisonline.map.webTile.addWebTiledLayer(a.templateUrl,c,arcgisonline.map.save_open.onLayerLoadHandler);else if("VectorTileLayer"===a.type)arcgisonline.map.vectorTile.checkSupport().then(f.hitch(this,function(a,b,c){c?(b=f.mixin(a,{type:"labels",
title:"Reference"}),arcgisonline.map.vectorTile.addVectorTileLayer(a.styleUrl,b,arcgisonline.map.save_open.onLayerLoadHandler)):console.log("One of the basemap layers is a Vector Tile Layer which is not supported.")},a,c));else{if((esriGeowConfig.allSSL||"https:"==location.protocol)&&a.url&&(arcgisonline.sharing.util.isHostedService(a.url)||arcgisonline.sharing.util.supportsHttps(a.url)))a.url=a.url.replace("http:","https:");b.push(f.hitch(arcgisonline.map.layer,"addLayerByURL",a.url,c))}}else if(c=
{type:"base",visibility:a.visibility,opacity:a.opacity,title:esriGeowConfig.defaultBasemap.title,minScale:a.minScale,maxScale:a.maxScale,displayLevels:a.displayLevels,startVisibleLayers:a.visibleLayers,snippet:"",bandIds:a.bandIds,serviceInfo:null,showLegend:a.showLegend},a.id&&(c.id=a.id),"WebTiledLayer"===a.type)c=f.mixin(a,{type:"base"}),arcgisonline.map.webTile.addWebTiledLayer(a.templateUrl,c,arcgisonline.map.save_open.onLayerLoadHandler);else if("VectorTileLayer"===a.type)arcgisonline.map.vectorTile.checkSupport().then(f.hitch(this,
function(a,b,c){c?(b=f.mixin(a,{type:"base"}),arcgisonline.map.vectorTile.addVectorTileLayer(a.styleUrl,b,arcgisonline.map.save_open.onLayerLoadHandler)):console.log("One of the basemap layers is a Vector Tile Layer which is not supported.")},a,c));else{esri.isDefined(a.refreshInterval)&&(c.refreshInterval=a.refreshInterval,c.refreshIntervalChanged=!0);if((esriGeowConfig.allSSL||"https:"==location.protocol)&&a.url&&(arcgisonline.sharing.util.isHostedService(a.url)||arcgisonline.sharing.util.supportsHttps(a.url)))a.url=
a.url.replace("http:","https:");b.push(f.hitch(arcgisonline.map.layer,"addLayerByURL",a.url,c))}});0<b.length&&arcgisonline.map.layer.waitForServiceResponse(b)}if(!a.query.useExisting||a.query.useExisting&&(a.query.layers||a.query.services)){if(a.query.layers||a.query.services||a.query.url||a.query.urls||a.query.wms||a.query.kml||a.query.csv||a.query.georss||a.query.tile||a.query.vectorTile){if(a.query.layers||a.query.services)arcgisonline.map.save_open.openServiceItemCards(a.query.layers||a.query.services,
!0);a.query.url&&arcgisonline.map.save_open.addServiceByUrl(arcgisonline.map.main.decodeUrl(a.query.url),null);if(a.query.urls){var d=arcgisonline.map.main.decodeUrl(a.query.urls).split(",http"),b=[];f.forEach(d,function(a){if(a.startsWith("://")||a.startsWith("s://"))a="http"+a;b.push(f.hitch(arcgisonline.map.save_open,"addServiceByUrl",a,null,!0))});0<b.length&&arcgisonline.map.layer.waitForServiceResponse(b)}a.query.wms&&arcgisonline.map.wms.addWMSService({url:unescape(a.query.wms),visibleLayers:a.query.visibleLayers?
a.query.visibleLayers.split(","):null});a.query.kml&&arcgisonline.map.kml.addKMLLayer(unescape(a.query.kml));a.query.csv&&arcgisonline.map.fileImport.addCSVByReferenceLayer(unescape(a.query.csv));a.query.georss&&arcgisonline.map.geoRSS.addGeoRSSLayer(unescape(a.query.georss));a.query.tile&&arcgisonline.map.webTile.addWebTiledLayer(unescape(a.query.tile));a.query.vectorTile&&arcgisonline.map.vectorTile.addVectorTileLayer(unescape(a.query.vectorTile))}else a.query.webmap||(arcgisonline.map.main.initMap(null),
arcgisonline.map.main.setDefaultTitle());a.query.featurecollection&&arcgisonline.map.featColl.addFeatureCollectionByUrl(arcgisonline.map.main.decodeUrl(a.query.featurecollection))}else arcgisonline.map.main.initMap(null),arcgisonline.map.main.setDefaultTitle()},loadDefaultMap:function(){arcgisonline.map.storage.deleteMapCookie();arcgisonline.map.main.defaultService=arcgisonline.map.main.defaultBaseLayer;arcgisonline.map.layer.addDefaultBaseLayers(f.hitch(this,function(){arcgisonline.map.main.initMap(null);
arcgisonline.map.main.setDefaultTitle();"aboutStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&!arcgisonline.map.main.hasMapOnly()&&(arcgisonline.map.leftPanel.openLeftAboutPanel(),arcgisonline.map.main.resizeMap())}))},addTiledLayer:function(a){if(null==a.layer){var b=null;a.exclusionAreas&&(b=[],f.forEach(a.exclusionAreas,function(a){b.push({minZoom:a.minZoom,maxZoom:a.maxZoom,minScale:a.minScale,maxScale:a.maxScale,geometry:new esri.geometry.Extent(a.geometry)})}));a.layer=new esri.layers.ArcGISTiledMapServiceLayer(a.url,
{id:a.id,opacity:1,visible:!1,refreshInterval:a.refreshInterval?a.refreshInterval:null,resourceInfo:a.serviceInfo,exclusionAreas:b})}arcgisonline.map.main.map.addLayer(a.layer);arcgisonline.map.main.mapLayers[arcgisonline.map.main.mapLayers.length]=a;return a.layer},addLayerByURL:function(a,b,d,e){if((9>f.isIE||f.isOpera)&&-1<a.indexOf("https:")&&"https:"!==location.protocol)arcgisonline.map.main.reloadViewerSecureSSL(a);else{var g=null,c=arcgisonline.sharing.util.urlToObject(a);if(c.query&&c.query.layers){var l=
c.query.layers;if(-1<l.indexOf("show:")){g=l.split(":")[1];delete c.query.layers;a=c.path;var l="?",k;for(k in c.query)a+=l+k+"\x3d"+c.query[k],l="\x26"}}a.lastIndexOf("/")===a.length-1&&(a=a.substring(0,a.length-1));var c=arcgisonline.map.layer.getIdFromUrl(a),h={layer:null,id:b.id?b.id:c,url:a,exclusionAreas:b.exclusionAreas,type:b.type,layerType:b.layerType,title:b.title,defaultVisibility:b.visibility,defaultOpacity:b.opacity,snippet:b.snippet,defaultBandIds:b.bandIds,format:b.format,compressionQuality:b.compressionQuality,
renderingRule:b.renderingRule,mosaicRule:b.mosaicRule,renderingRuleChanged:b.renderingRuleChanged,mosaicRuleChanged:b.mosaicRuleChanged,imageQualityChanged:b.imageQualityChanged,symbolTileSize:b.symbolTileSize,identify:!1,mode:b.mode,drawMode:b.drawMode,hadError:!1,serviceInfo:b.serviceInfo||b.resourceInfo,itemId:b.itemId,infoTemplate:b.infoTemplate,itemLayers:b.itemLayers,rendererChanged:b.rendererChanged,layers:b.layers,thematicGroup:b.thematicGroup,popupInfo:b.popupInfo,layerDefinition:b.layerDefinition,
popupChanged:b.popupChanged,defExpChanged:b.defExpChanged,spatialFilterChanged:b.spatialFilterChanged,layersChanged:b.layersChanged,capabilities:b.capabilities,startVisibleLayers:g||b.visibleLayers,minScale:b.minScale,maxScale:b.maxScale,dynamicLayerParams:b.dynamicLayerParams,refreshInterval:b.refreshInterval,refreshIntervalChanged:b.refreshIntervalChanged,visibleLayersChanged:b.visibleLayersChanged,timeChanged:b.timeChanged,timeAnimation:b.timeAnimation,dimensionAnimation:b.dimensionAnimation,showLabels:b.showLabels,
zoomToOneLayer:b.zoomToOneLayer,featureLimitExceededHandlerNotNeeded:b.featureLimitExceededHandlerNotNeeded};b.__createDefaultPopup&&(h.__createDefaultPopup=b.__createDefaultPopup);b.disablePopup&&(h.disablePopup=b.disablePopup);esri.isDefined(b.showLegend)&&(h.showLegend=b.showLegend,h.legendChanged=!0);b.editTrackingFilter&&(h.editTrackingFilter=b.editTrackingFilter);a=arcgisonline.map.layer.getLayerPosition(h);"popup"!=b.type&&arcgisonline.map.main.mapLayers.splice(a.list,0,h);b.itemCard&&(h.itemCard=
b.itemCard);if(h.itemLayers&&h.itemId)f.forEach(h.itemLayers,function(a){a.popupInfo&&(h.popupChanged=!0);if(a.layerDefinition&&a.layerDefinition.drawingInfo&&(a.layerDefinition.drawingInfo.renderer||a.layerDefinition.drawingInfo.labelingInfo))h.rendererChanged=!0;a.layerDefinition&&esri.isDefined(a.layerDefinition.definitionExpression)&&(h.defExpChanged=!0);if(a.layerDefinition&&(esri.isDefined(a.layerDefinition.minScale)||esri.isDefined(a.layerDefinition.maxScale)))h.scaleChanged=!0},this);else{h.popupInfo&&
(h.popupChanged=!0);if(h.layerDefinition&&h.layerDefinition.drawingInfo&&(h.layerDefinition.drawingInfo.renderer||h.layerDefinition.drawingInfo.labelingInfo))h.rendererChanged=!0;h.layerDefinition&&esri.isDefined(h.layerDefinition.definitionExpression)&&(h.defExpChanged=!0,b.definitionEditor&&(h.definitionEditor=b.definitionEditor));h.layerDefinition&&h.layerDefinition.definitionGeometry&&(h.spatialFilterChanged=!0);h.layerDefinition&&h.layerDefinition.definitionGeometry&&(h.spatialFilterChanged=
!0);h.layerDefinition&&esri.isDefined(h.layerDefinition.maximumTrackPoints)&&(h.maximumTrackPointsChanged=!0);h.renderingRule&&(h.renderingRuleChanged=!0);h.mosaicRule&&(h.mosaicRuleChanged=!0);if(h.compressionQuality||h.format)h.imageQualityChanged=!0}arcgisonline.map.layer.addLayer(h,a.map,d,e);b.defaultVisibility&&(h.defaultVisibility=b.defaultVisibility);esri.isDefined(b.visibleLayers)?h.visibleLayers=b.visibleLayers:b.serviceInfo&&b.serviceInfo.subLayerVisibility&&(h.visibleLayers=b.serviceInfo.subLayerVisibility)}},
addBaseLayerByURL:function(a,b,d,e){var g=a.url,c=a.title,f=a.id;f||(f=arcgisonline.map.layer.getIdFromUrl(g));g={layer:null,id:f,type:"base",title:c,url:g,exclusionAreas:a.exclusionAreas,defaultVisibility:a.visibility,defaultOpacity:a.opacity,minScale:a.minScale,maxScale:a.maxScale,displayLevels:a.displayLevel,visibleLayers:a.visibleLayers,refreshInterval:a.refreshInterval,refreshIntervalChanged:a.refreshIntervalChanged,snippet:"",identify:!1,hadError:!1,successfulDraw:!1,showLegend:a.showLegend,
timeAnimation:a.timeAnimation,timeChanged:a.timeChanged};a.itemId&&(g.itemId=a.itemId);e&&(g.serviceInfo=e);arcgisonline.map.main.mapLayers.splice(0,0,g);arcgisonline.map.layer.addLayer(g,0,b,d);return g},addTableByURL:function(a,b,d,e){if((9>f.isIE||f.isOpera)&&-1<a.indexOf("https:")&&"https:"!==location.protocol)arcgisonline.map.main.reloadViewerSecureSSL(a);else{a.lastIndexOf("/")===a.length-1&&(a=a.substring(0,a.length-1));d=function(a,c,d){d=b.id?b.id:arcgisonline.map.layer.getIdFromUrl(c);a=
{id:d,url:c,title:b.title||a.name,serviceInfo:a,layerDefinition:b.layerDefinition};b.itemId&&(a.itemId=b.itemId);b.popupInfo&&(a.popupInfo=b.popupInfo,a.popupChanged=!0);a.layerDefinition&&a.layerDefinition.definitionExpression&&a.layer.setDefinitionExpression(a.layerDefinition.definitionExpression);b.capabilities&&b.capabilities!==a.serviceInfo.capabilities&&(a.serviceInfo._origCapabilities=a.serviceInfo.capabilities,a.serviceInfo.capabilities=b.capabilities);a.layer=new esri.layers.FeatureLayer(c,
{id:d,outFields:["*"],resourceInfo:a.serviceInfo});arcgisonline.map.main.mapTables.push(a);f.publish("onLayerUpdate",[""])};var g=function(a,c){setTimeout(function(){var a=f.string.substitute(esri.i18nBundle.viewer.error.layerNotAdded,{layer:b.title});"http"===arcgisonline.sharing.util.parseUrl(b.url).protocol&&"https"===arcgisonline.sharing.util.parseUrl(window.location.href).protocol&&(a=f.string.substitute(esri.i18nBundle.viewer.error.layerNotAddedSecure,{layer:b.title}));arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:a})},5E3);e&&e(a,c)};if(b.serviceInfo)d(b.serviceInfo,a);else{var c=f.string.substitute(esri.i18nBundle.viewer.error.layerStillTrying,{layer:b.title}),l=c.indexOf("\x3cbr/\x3e");if(-1<l)var k=c.substring(0,l),c=c.substring(l+5),c=k+'\x3cdiv class\x3d"throb-loading"\x3e\x3cdiv class\x3d"throb-loading-text"\x3e'+c+"\x3c/div\x3e\x3c/div\x3e";arcgisonline.map.layer.getServiceInfo(a,c,f.hitch(this,d),f.hitch(this,g))}}},addLayer:function(a,b,d,e){if(!a.layer)if(a.serviceInfo){if(!a.title||!a.title.length)a.title=
arcgisonline.map.layer.parseServiceInfo(a.serviceInfo,a.url).title;arcgisonline.map.layer.addLayerPart2(a,b,d,e)}else{var g=f.string.substitute(esri.i18nBundle.viewer.error.layerStillTrying,{layer:a.title}),c=g.indexOf("\x3cbr/\x3e");if(-1<c)var l=g.substring(0,c),g=g.substring(c+5),g=l+'\x3cdiv class\x3d"throb-loading"\x3e\x3cdiv class\x3d"throb-loading-text"\x3e'+g+"\x3c/div\x3e\x3c/div\x3e";arcgisonline.map.layer.getServiceInfo(a.url,g,function(c,g,m){a.url=g;a.serviceInfo=c;if(arcgisonline.sharing.util.isHostedService(g)&&
-1<g.indexOf("/MapServer")&&-1===g.indexOf("/MapServer/")||a.serviceInfo.capabilities&&-1<a.serviceInfo.capabilities.toLowerCase().indexOf("tilesonly")){g=new esri.SpatialReference(a.serviceInfo.spatialReference);g=arcgisonline.map.main.sameSpatialReference(g,arcgisonline.map.main.map.spatialReference);var l=arcgisonline.map.layer.sameTilingSchemeAsBasemap(a.serviceInfo);if(!g||!l){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:f.string.substitute(esri.i18nBundle.viewer.error.layerDoesntFit,{layer:a.title})});return}}if(null==a.title||0==a.title.length)a.title=arcgisonline.map.layer.parseServiceInfo(c,m.args.url).title;arcgisonline.map.layer.addLayerPart2(a,b,d,e)},function(b,c){"base"==a.type&&a.id===arcgisonline.map.main.mapLayers[0].id||(setTimeout(function(){var c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();if(b&&b.details&&0<b.details.length&&"Missing spatial reference information."==
b.details[0])c.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:f.string.substitute(esri.i18nBundle.viewer.error.layerMissingSP,{layer:a.title})});else{var d=f.string.substitute(esri.i18nBundle.viewer.error.layerNotAdded,{layer:a.title});"http"===arcgisonline.sharing.util.parseUrl(a.url).protocol&&"https"===arcgisonline.sharing.util.parseUrl(window.location.href).protocol&&(d=f.string.substitute(esri.i18nBundle.viewer.error.layerNotAddedSecure,{layer:a.title}));c.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:d})}},5E3),arcgisonline.map.layer.removeLayer(a));e&&e(b,c)})}},addLayerPart2:function(a,b,d,e){if("Feature Layer"==a.serviceInfo.type){var g=a.url&&-1<a.url.toLowerCase().indexOf("/mapserver")&&-1==a.url.toLowerCase().indexOf("/featureserver"),c=a.serviceInfo.capabilities&&a.serviceInfo.capabilities.toLowerCase(),g=c&&(!g&&-1<c.indexOf("query")||g&&-1<c.indexOf("query")&&-1<c.indexOf("data"));if(c&&!g){console.log("Layer "+a.url+" is not supporting the Data or Query capability.");setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:f.string.substitute(esri.i18nBundle.viewer.error.layerNotAdded,{layer:a.url})})},5E3);arcgisonline.map.layer.removeLayer(a);e&&e({});return}}null==arcgisonline.map.main.defaultExtent.spatialReference.wkid?(e=arcgisonline.map.layer.parseServiceInfo(a.serviceInfo,a.url).extent,arcgisonline.map.main.sameSpatialReference(arcgisonline.map.main.defaultExtent.spatialReference,e.spatialReference)?this.addLayerPart3(a,b,d):(e=a.url,c=e.toLowerCase().indexOf("/rest/services"),e=e.substring(0,c+14),
arcgisonline.map.main.getJson(e,f.hitch(this,function(c,g){if(c&&c.currentVersion)if(9.4>parseInt(c.currentVersion)){var e=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();e.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:f.string.substitute(esri.i18nBundle.viewer.error.layerNotFittingSR,{layer:a.title})});arcgisonline.map.layer.removeLayer(a)}else this.addLayerPart3(a,b,d);else e=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),
e.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:f.string.substitute(esri.i18nBundle.viewer.error.layerNotFittingSR,{layer:a.title})}),arcgisonline.map.layer.removeLayer(a)}),f.hitch(this,function(b,c){var d=f.string.substitute(esri.i18nBundle.viewer.error.layerNotAdded,{layer:a.title});"http"===arcgisonline.sharing.util.parseUrl(a.url).protocol&&"https"===arcgisonline.sharing.util.parseUrl(window.location.href).protocol&&(d=f.string.substitute(esri.i18nBundle.viewer.error.layerNotAddedSecure,
{layer:a.title}));arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:d});arcgisonline.map.layer.removeLayer(a)})))):this.addLayerPart3(a,b,d)},addLayerPart3:function(a,b,d){var e=new esri.layers.ImageParameters;e.format="png24";a.serviceInfo&&(a.serviceInfo.supportedImageFormatTypes&&-1<a.serviceInfo.supportedImageFormatTypes.indexOf("PNG32"))&&(e.format="png32");if("user"==a.type||"labels"==a.type)e.transparent=
!0;var g=null!=a.defaultOpacity?a.defaultOpacity:1;a.capabilities&&(a.capabilities!==a.serviceInfo.capabilities&&(a.serviceInfo._origCapabilities=a.serviceInfo.capabilities,a.serviceInfo.capabilities=a.capabilities),delete a.capabilities);var c=arcgisonline.map.layer.parseServiceInfo(a.serviceInfo,a.url).spatialReference;if("Feature Layer"==a.serviceInfo.type||a.mode===esri.layers.FeatureLayer.MODE_SELECTION)arcgisonline.sharing.util.isHostedService(a.url)?"popup"===a.type?arcgisonline.map.layer.addFeatureLayerToMap(a,
g,b,d,a.mode):(delete a.mode,arcgisonline.map.layer.addFeatureLayerToMap(a,g,b,d)):arcgisonline.map.layer.getMode(a,f.hitch(arcgisonline.map.layer,"addFeatureLayerToMap",a,g,b,d));else{if(a.serviceInfo.singleFusedMapCache&&"base"==a.type||a.serviceInfo.singleFusedMapCache&&arcgisonline.map.main.sameSpatialReference(c,arcgisonline.map.main.defaultExtent.spatialReference))if("base"==a.type){if(null==arcgisonline.map.main.mapLods){arcgisonline.map.main.mapLods=a.serviceInfo.tileInfo.lods;arcgisonline.map.main.baseTilingSchemeScales=
"|";for(i=0;i<a.serviceInfo.tileInfo.lods.length;i++)arcgisonline.map.main.baseTilingSchemeScales+=a.serviceInfo.tileInfo.lods[i].scale+"|"}var l=null;a.exclusionAreas&&(l=[],f.forEach(a.exclusionAreas,function(a){l.push({minZoom:a.minZoom,maxZoom:a.maxZoom,minScale:a.minScale,maxScale:a.maxScale,geometry:new esri.geometry.Extent(a.geometry)})}));a.layer=new esri.layers.ArcGISTiledMapServiceLayer(a.url,{id:a.id,opacity:g,visible:a.defaultVisibility,refreshInterval:a.refreshInterval?a.refreshInterval:
null,resourceInfo:a.serviceInfo,exclusionAreas:l})}else arcgisonline.map.main.recreateFLsForMS(a,esri.layers.FeatureLayer.MODE_SELECTION),arcgisonline.map.layer.sameTilingSchemeAsBasemap(a.serviceInfo)?(l=null,a.exclusionAreas&&(l=[],f.forEach(a.exclusionAreas,function(a){l.push({minZoom:a.minZoom,maxZoom:a.maxZoom,minScale:a.minScale,maxScale:a.maxScale,geometry:new esri.geometry.Extent(a.geometry)})})),a.layer=new esri.layers.ArcGISTiledMapServiceLayer(a.url,{id:a.id,opacity:g,visible:a.defaultVisibility,
refreshInterval:a.refreshInterval?a.refreshInterval:null,resourceInfo:a.serviceInfo,exclusionAreas:l})):null!=a.serviceInfo.pixelSizeX?(e=new esri.layers.ImageServiceParameters,null!=a.defaultBandIds?e.bandIds=a.defaultBandIds:a.serviceInfo.bandCount&&3<parseInt(a.serviceInfo.bandCount)&&(e.bandIds=[0,1,2]),a.layer=new esri.layers.ArcGISImageServiceLayer(a.url,{id:a.id,opacity:g,visible:a.defaultVisibility,imageServiceParameters:e,refreshInterval:a.refreshInterval?a.refreshInterval:null,resourceInfo:a.serviceInfo,
useMapDimensionValue:esri.isDefined(a.dimensionAnimation)?a.dimensionAnimation:!0})):a.layer=new esri.layers.ArcGISDynamicMapServiceLayer(a.url,{id:a.id,opacity:g,visible:a.defaultVisibility,imageParameters:e,refreshInterval:a.refreshInterval?a.refreshInterval:null,resourceInfo:a.serviceInfo});else if(null!=a.serviceInfo.pixelSizeX)e=new esri.layers.ImageServiceParameters,null!=a.defaultBandIds&&(e.bandIds=a.defaultBandIds),null!=a.format&&(e.format=a.format,null!=a.compressionQuality&&(e.compressionQuality=
a.compressionQuality)),a.renderingRule&&a.renderingRule.rasterFunction&&(c=new esri.layers.RasterFunction(a.renderingRule),e.renderingRule=c),a.mosaicRule&&(c=new esri.layers.MosaicRule(a.mosaicRule),e.mosaicRule=c),g={id:a.id,opacity:g,visible:a.defaultVisibility,imageServiceParameters:e,refreshInterval:a.refreshInterval?a.refreshInterval:null,infoTemplate:a.infoTemplate?a.infoTemplate:a.popupInfo&&new esri.dijit.PopupTemplate(a.popupInfo),resourceInfo:a.serviceInfo,useMapDimensionValue:esri.isDefined(a.dimensionAnimation)?
a.dimensionAnimation:!0},e=a.layerType?"ArcGISImageServiceVectorLayer"===a.layerType:!1,esri.isDefined(a.layerType)||(e=a.serviceInfo.hasMultidimensions&&("esriImageServiceDataTypeVector-UV"===a.serviceInfo.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===a.serviceInfo.serviceDataType)),e?(g.symbolTileSize=a.symbolTileSize||null,a.layer=new esri.layers.ArcGISImageServiceVectorLayer(a.url,g),a.layerDefinition&&(a.layerDefinition.drawingInfo&&a.layerDefinition.drawingInfo.renderer)&&(g=esri.renderer.fromJson(f.clone(a.layerDefinition.drawingInfo.renderer)),
a.layer.setRenderer(g))):a.layer=new esri.layers.ArcGISImageServiceLayer(a.url,g),a.serviceInfo.hasMultidimensions&&a.layer.getMultidimensionalInfo().then(function(b){a.multidimensionalInfo=b}),(1<a.layer.bandCount||a.layer.rasterFunctionInfos&&0<a.layer.rasterFunctionInfos.length)&&f.connect(a.layer,"onRenderingChange",f.hitch(this,function(a){a&&delete a.legendResponse},a.layer)),a.layerDefinition&&esri.isDefined(a.layerDefinition.definitionExpression)&&a.layer.setDefinitionExpression(a.layerDefinition.definitionExpression,
!0),a.onError=f.connect(a.layer,"onError",f.hitch(arcgisonline.map.layer,"layerOnErrorHandler",a));else{arcgisonline.map.main.recreateFLsForMS(a,esri.layers.FeatureLayer.MODE_SELECTION);a.layer=new esri.layers.ArcGISDynamicMapServiceLayer(a.url,{id:a.id,opacity:g,visible:a.defaultVisibility,imageParameters:e,refreshInterval:a.refreshInterval?a.refreshInterval:null,resourceInfo:a.serviceInfo});if(!arcgisonline.map.main.hasDynamicLayers(a)&&esri.isDefined(a.startVisibleLayers))if(a.layer.loaded)a.visibleLayers=
a.startVisibleLayers,""===a.visibleLayers?a.layer.setVisibleLayers([]):a.layer.setVisibleLayers(a.visibleLayers.split(","));else var k=f.connect(a.layer,"onLoad",f.hitch(this,function(b){a.visibleLayers=a.startVisibleLayers;""===a.visibleLayers?a.layer.setVisibleLayers([]):a.layer.setVisibleLayers(a.visibleLayers.split(","));f.disconnect(k)}));if(a.itemLayers&&0<a.itemLayers.length)if(arcgisonline.map.main.hasDynamicLayers(a))arcgisonline.map.dynLayer.setupDynamicLayers(a);else{var h=[];f.forEach(a.itemLayers,
function(a){a.layerDefinition&&a.layerDefinition.definitionExpression&&(h[a.id]=a.layerDefinition.definitionExpression)},this);0<h.length&&a.layer.setLayerDefinitions(h)}}arcgisonline.map.layer.addLayerPart4(a,b,d)}},addLayerPart4:function(a,b,d){var e=function(a){"labels"===a.type&&a.layer.attr("data-reference",!0);a.itemId&&(!a.itemCard&&arcgisonline.map.save_open.itemCards[a.itemId])&&(a.itemCard=arcgisonline.map.save_open.itemCards[a.itemId]);esri.isDefined(a.minScale)&&esri.isDefined(a.maxScale)&&
(a.layer.setScaleRange(a.minScale,a.maxScale),"base"!==a.type&&"labels"!==a.type&&(a.scaleChanged=!0,delete a.minScale,delete a.maxScale));a.itemLayers&&(0===a.itemLayers.length?(a.legendChanged=!0,a.popupChanged=!0):f.forEach(a.itemLayers,function(b){esri.isDefined(b.showLegend)&&(a.legendChanged=!0);esri.isDefined(b.popupInfo)&&(a.popupChanged=!0)}));a.timeChanged&&(esri.isDefined(a.timeAnimation)&&!1===a.timeAnimation?a.layer.setUseMapTime(!1):a.layer.setUseMapTime(!0),delete a.timeAnimation);
arcgisonline.map.itemData.checkItemDataContent(a,f.hitch(this,function(c){if(c)for(c=0;c<arcgisonline.map.main.mapLayers.length;c++){if(a.id==arcgisonline.map.main.mapLayers[c].id){arcgisonline.map.main.mapLayers.splice(c,1);break}}else-1<b?arcgisonline.map.main.map.addLayer(a.layer,b):arcgisonline.map.main.map.addLayer(a.layer),a.layer&&arcgisonline.map.labels.hasLayer(a.layer)&&arcgisonline.map.labels.orderLayers();f.publish("layerAdded",[a.id])}));d&&d(a)};a.layer.loaded?e(a):f.connect(a.layer,
"onLoad",f.hitch(this,e,a));a.onError=f.connect(a.layer,"onError",f.hitch(arcgisonline.map.layer,"layerOnErrorHandler",a));"user"==a.type&&"Feature Layer"!==a.serviceInfo.type&&(a.serviceInfo.capabilities&&-1<a.serviceInfo.capabilities.toLowerCase().indexOf("query")?a.identify=!0:a.serviceInfo.capabilities||arcgisonline.map.layer.checkIdentify(a))},addFeatureLayerToMap:function(a,b,d,e,g){a.mode=g;!arcgisonline.map.role.isAllowed("tool_edit")&&(a.serviceInfo&&a.serviceInfo.capabilities)&&(a.serviceInfo._origCapabilities=
a.serviceInfo.capabilities,a.serviceInfo.capabilities=arcgisonline.map.edit.removeEditCapabilities(a.serviceInfo.capabilities));b={id:a.id,visible:a.defaultVisibility,opacity:b,mode:g,outFields:["*"],infoTemplate:a.infoTemplate?a.infoTemplate:a.popupInfo&&new esri.dijit.PopupTemplate(a.popupInfo),resourceInfo:f.clone(a.serviceInfo),displayOnPan:9>f.isIE?!1:!0,refreshInterval:a.refreshInterval?a.refreshInterval:null,autoGeneralize:!0};a.dynamicLayerParams&&f.mixin(b,a.dynamicLayerParams);(!0===a.drawMode||
!1===a.drawMode)&&f.mixin(b,{drawMode:a.drawMode});arcgisonline.sharing.util.isHostedService(a.url)&&"popup"!==a.type&&(b.mode=esri.layers.FeatureLayer.MODE_AUTO,b.autoGeneralize=!0);arcgisonline.map.main.hasFullEditingControl(a)&&(b.userIsAdmin=!0,arcgisonline.map.role.updateUserActionAfterFullEditing());(function(a,b,d,e){arcgisonline.map.main.checkUnsupportedRendererType(a);a.layer=new esri.layers.FeatureLayer(a.url,b);var g=function(a){var b=a.layer;delete a.zoomToOneLayer;arcgisonline.map.editTracking.hasEditTracking(a)&&
b.setEditSummaryCallback(function(a,b){if(b&&b.userId){var c=!1,d=a.getLayer().url;arcgisonline.sharing.util.isHostedService(d)?c=!0:(d=esri.id.findServerInfo(d))&&(d.owningSystemUrl&&-1<d.owningSystemUrl.indexOf("www.arcgis.com"))&&(c=!0);c&&(b.userId="\x3ca onclick\x3d\"arcgisonline.sharing.dijit.ProfilePopup.prototype.statics.getInstance().showProfileFromPopup('"+b.userId+'\', this);" alt\x3d"'+esri.i18nBundle.itemProperties.viewProfile+'" title\x3d"'+esri.i18nBundle.itemProperties.viewProfile+
"\" href\x3d'Javascript:void(0);'\x3e"+b.userId+"\x3c/a\x3e")}return b});if(!a.featureLimitExceededHandlerNotNeeded&&!a.layer.queryPagination&&(arcgisonline.sharing.util.isHostedService(a.url)||10.1<=a.layer.version))a.featureLimitExceededHandler=f.connect(a.layer,"onQueryLimitExceeded",f.hitch(this,function(a){arcgisonline.sharing.dijit.dialog.FeatureLimitReachedDlg.prototype.statics.getInstance().show(a)},a));delete a.featureLimitExceededHandlerNotNeeded;a.layerDefinition?(a.layerDefinition.drawingInfo&&
(a.layerDefinition.drawingInfo.renderer&&(b=esri.renderer.fromJson(f.clone(a.layerDefinition.drawingInfo.renderer)),b.isMaxInclusive=!0,a.layer.setRenderer(b)),a.layerDefinition.drawingInfo.labelingInfo&&(b=f.map(a.layerDefinition.drawingInfo.labelingInfo,function(a){return new esri.layers.LabelClass(a)}),a.layer.setLabelingInfo(b))),a.editTrackingFilter?arcgisonline.map.editTracking.setDefinitionExpression(a):esri.isDefined(a.layerDefinition.definitionExpression)&&a.layer.setDefinitionExpression(a.layerDefinition.definitionExpression),
esri.isDefined(a.layerDefinition.minScale)&&(a.layer.setMinScale(a.layerDefinition.minScale),a.scaleChanged=!0),esri.isDefined(a.layerDefinition.maxScale)&&(a.layer.setMaxScale(1===a.layerDefinition.maxScale?0:a.layerDefinition.maxScale),a.scaleChanged=!0)):a.editTrackingFilter&&arcgisonline.map.editTracking.setDefinitionExpression(a,a.editTrackingFilter.user,a.editTrackingFilter.time);a.showLabels&&arcgisonline.map.labels.addLabelsForLayer(a.layer);arcgisonline.map.layer.addLayerPart4(a,d,e)};a.layer.loaded?
g(a):f.connect(a.layer,"onLoad",f.hitch(this,function(a,b){g(a)},a));if(a.__createDefaultPopup&&(b=!1,a.serviceInfo.capabilities&&-1<a.serviceInfo.capabilities.toLowerCase().indexOf("editing")&&(b=!0),a.popupInfo=arcgisonline.map.popup.getDefaultPopupInfo(a.serviceInfo,b,a.layer),a.layer.setInfoTemplate(new esri.dijit.PopupTemplate(a.popupInfo)),a.popupChanged=!0,a.layer.mode===esri.layers.FeatureLayer.MODE_SELECTION&&(b=arcgisonline.map.main.getMSForFS(a))))a=parseInt(a.url.substring(a.url.lastIndexOf("/")+
1,a.url.length)),arcgisonline.map.popup.addPopupLayer(b,a)})(a,b,d,e)},layerOnErrorHandler:function(a,b){if(!(b.message&&-1<b.message.indexOf("Request canceled"))){var d=function(){clearTimeout(arcgisonline.map.main.mapFullyLoadedTimer);arcgisonline.map.main.destroyOverviewMap();try{arcgisonline.map.main.map.destroy()}catch(a){}var b=arcgisonline.map.main.map.infoWindow;b&&b.destroy();arcgisonline.map.main.map=null;f.byId("map").innerHTML="";arcgisonline.map.main.mapLayers=[];arcgisonline.map.main.startup=
!0},e=function(a,b){a=arcgisonline.map.main.switchBingToEsriBasemap(a);var c=null;b.extent&&0<b.extent.length&&(c=new esri.geometry.Extent(b.extent[0][0],b.extent[0][1],b.extent[1][0],b.extent[1][1],new esri.SpatialReference({wkid:4326})));d();arcgisonline.map.save_open.startupWebMap(c,a)};if("base"==a.type){if(arcgisonline.map.main.currentBaseService!=arcgisonline.map.main.defaultBaseLayer.id)if(!a.successfulDraw&&a.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer)f.publish("layerAddFailed",
[]),null!=arcgisonline.map.save_open.basemapWebMap?(f.disconnect(a.onError),setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:f.string.substitute(esri.i18nBundle.viewer.error.basemapTitleNotAvailable,{title:a.title})})},1E3),arcgisonline.map.save_open.basemapWebMap=null,arcgisonline.map.layer.switchBaseLayer(arcgisonline.map.main.defaultBaseLayer.url,arcgisonline.map.main.defaultBaseLayer._layerType,
arcgisonline.map.main.defaultBaseLayer.title,null,null)):arcgisonline.map.main.currentBaseService!=arcgisonline.map.main.defaultBaseLayer.id&&(setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.basemapNotAvailable})},2E3),d(),arcgisonline.map.layer.loadDefaultMap());else if(a.layer instanceof esri.virtualearth.VETiledLayer&&b.authenticationResultCode&&"ValidCredentials"!==
b.authenticationResultCode){var g=arcgisonline.map.save_open.webMapItemCard,c=arcgisonline.map.save_open.openedWebMap,l=arcgisonline.sharing.util.getUser();a.bingKey&&a.bingKey==esriGeowConfig.bingMapsKey?l&&g.owner===l.email&&esriGeowConfig.self.bingKey?(delete c.baseMap.baseMapLayers[0].bingKey,c.baseMap.baseMapLayers[0].portalUrl=esriGeowConfig.self.isPortal?location.protocol+"//"+esriGeowConfig.self.portalHostname+"/sharing/rest/portals/"+esriGeowConfig.self.id:location.protocol+"//"+esriGeowConfig.self.urlKey+
"."+esriGeowConfig.self.customBaseUrl+"/sharing/rest/portals/"+esriGeowConfig.self.id,e=null,g.extent&&0<g.extent.length&&(e=new esri.geometry.Extent(g.extent[0][0],g.extent[0][1],g.extent[1][0],g.extent[1][1],new esri.SpatialReference({wkid:4326}))),d(),arcgisonline.map.save_open.startupWebMap(e,c)):(e(c,g),l&&(arcgisonline.map.save_open.webMapInfo&&arcgisonline.map.save_open.webMapInfo.owner===l.email)&&setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:esri.i18nBundle.viewer.error.webMapNoFreeBingKey})},2E3)):(delete esriGeowConfig.self.bingKey,e(c,g),l&&(arcgisonline.map.save_open.webMapInfo&&arcgisonline.map.save_open.webMapInfo.owner===l.email)&&setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.common.warning,message:esri.i18nBundle.viewer.error.webMapBadBingKey})},2E3))}else f.publish("layerAdded",[a.id]),console.log(a.url+" returned error: "+(b&&b.message)?
b.message:f.json.stringify(b)+".")}else"ArcGISImageServiceVectorLayer"==a.layerType&&null!=b.message&&-1<b.message.indexOf("This layer is not supported in the current browser")?setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:f.string.substitute(esri.i18nBundle.viewer.error.imageserviceVectorLayerNotSupported,{layer:a.title})})},2E3):null!=b.message&&-1<b.message.indexOf("Unable to draw graphic")||
console.log(a.url+" returned error: ",b)}},hideLayer:function(a){null!=a.layer&&a.layer.hide()},removeLayer:function(a){for(var b=!1,d=0;d<arcgisonline.map.main.mapLayers.length;d++)if(arcgisonline.map.main.mapLayers[d].id==a.id){arcgisonline.map.main.mapLayers.splice(d,1);f.publish("onLayerUpdate",[""]);b=!0;break}if(!b)for(d=0;d<arcgisonline.map.main.mapTables.length;d++)if(arcgisonline.map.main.mapTables[d].id==a.id){arcgisonline.map.main.mapTables.splice(d,1);f.publish("onLayerUpdate",[""]);break}},
removeCompleteLayer:function(a){for(var b,d=0;d<arcgisonline.map.main.mapLayers.length;d++)if(arcgisonline.map.main.mapLayers[d].id==a){b=arcgisonline.map.main.mapLayers[d];arcgisonline.map.layer.removeLayer(b);break}if(!b)for(d=0;d<arcgisonline.map.main.mapTables.length;d++)if(arcgisonline.map.main.mapTables[d].id==a){b=arcgisonline.map.main.mapTables[d];arcgisonline.map.layer.removeLayer(b);break}b.layer?(arcgisonline.map.main.map.removeLayer(b.layer),arcgisonline.map.labels.removeLabelsForLayer(b.layer)):
b.layers&&f.forEach(b.layers,function(a){arcgisonline.map.main.map.removeLayer(a);arcgisonline.map.labels.removeLabelsForLayer(a)})},recreateFL:function(a,b){if(a.layer){var d=a.layer.opacity;a.defaultVisibility=a.layer.visible;arcgisonline.map.main.map.removeLayer(a.layer);arcgisonline.map.labels.removeLabelsForLayer(a.layer);arcgisonline.map.layer.addFeatureLayerToMap(a,d,-1,function(a){},b)}},checkIdentify:function(a){if(!arcgisonline.sharing.util.isHostedService(a.url)){var b=function(b,c){if(b&&
(b.details&&0<b.details.length&&-1==b.details[0].indexOf("not supported")||null==b.details||0==b.details.length))a.identify=!0},d=a.url,e=d.indexOf("?"),d=-1==e?d+"/identify":d.substring(0,e)+"/identify"+d.substring(e,d.length);arcgisonline.map.main.getJson(d,f.hitch(this,b),f.hitch(this,b))}},switchBaseLayer:function(a,b,d,e,g,c,l){c=c||{};for(var k=[],h=0;h<arcgisonline.map.main.mapLayers.length;h++){var m=arcgisonline.map.main.mapLayers[h];"base"==m.type?(arcgisonline.map.main.mapLayers[h]=null,
m.layer&&arcgisonline.map.main.map.removeLayer(m.layer)):k[k.length]=m}arcgisonline.map.main.mapLayers=k;if(null!=b&&("OpenStreetMap"==b||-1<b.indexOf("BingMaps"))){m=null;"OpenStreetMap"==b?(m={layer:null,id:c.id||b,type:"base",title:c.title||d,url:"",defaultVisibility:esri.isDefined(c.visibility)?c.visibility:!0,defaultOpacity:esri.isDefined(c.opacity)?c.opacity:1,minScale:esri.isDefined(c.minScale)?c.minScale:0,maxScale:esri.isDefined(c.maxScale)?c.maxScale:0,displayLevels:c.displayLevels||null,
snippet:"",identify:!1,hadError:!1,successfulDraw:!1},m.layer=new esri.layers.OpenStreetMapLayer({id:m.id,opacity:1,visible:!0})):-1<b.indexOf("BingMaps")&&(a="BingMapsAerial"==b?esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL:"BingMapsRoad"==b?esri.virtualearth.VETiledLayer.MAP_STYLE_ROAD:esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL_WITH_LABELS,m={layer:null,id:c.id||b,type:"base",title:c.title||d,url:"",bingKey:esriGeowConfig.self.bingKey,defaultVisibility:esri.isDefined(c.visibility)?c.visibility:
!0,defaultOpacity:esri.isDefined(c.opacity)?c.opacity:1,minScale:esri.isDefined(c.minScale)?c.minScale:0,maxScale:esri.isDefined(c.maxScale)?c.maxScale:0,displayLevels:c.displayLevels||null,snippet:"",identify:!1,hadError:!1,successfulDraw:!1},m.layer=new esri.virtualearth.VETiledLayer({bingMapsKey:m.bingKey,mapStyle:a,id:m.id,opacity:1,visible:!0}));for(h=arcgisonline.map.main.mapLayers.length;0<h;h--)arcgisonline.map.main.mapLayers[h]=arcgisonline.map.main.mapLayers[h-1];arcgisonline.map.main.mapLayers[0]=
m;arcgisonline.map.main.map.addLayer(m.layer,0);c=function(){arcgisonline.map.main.defaultService=m;arcgisonline.map.main.currentBaseService=m.layer.id;arcgisonline.map.main.recreateOverviewMap();l&&l()};m.layer.loaded?c():f.connect(m.layer,"onLoad",c)}else if(g&&"Vector Tile Service"===g.type)arcgisonline.map.vectorTile.getStyleUrlFromItemId(g.id,g).then(f.hitch(this,function(a,b,c){var e={layer:null,id:"VectorTile_"+Math.floor(10001*Math.random()),url:c,type:"base",subType:"VectorTileLayer",title:a.title,
itemCard:a,itemId:a.id,defaultVisibility:!0,defaultOpacity:1};for(h=arcgisonline.map.main.mapLayers.length;0<h;h--)arcgisonline.map.main.mapLayers[h]=arcgisonline.map.main.mapLayers[h-1];arcgisonline.map.main.mapLayers[0]=e;arcgisonline.map.vectorTile.createVectorTileLayer(e,0,function(){arcgisonline.map.main.defaultService=e;arcgisonline.map.main.currentBaseService=e.layer.id;arcgisonline.map.main.recreateOverviewMap();b&&b()},function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:f.string.substitute(esri.i18nBundle.viewer.error.basemapTitleNotAvailable,{title:d})});arcgisonline.map.save_open.basemapWebMap=null;arcgisonline.map.layer.switchBaseLayer(arcgisonline.map.main.defaultBaseLayer.url,arcgisonline.map.main.defaultBaseLayer._layerType,arcgisonline.map.main.defaultBaseLayer.title,null,a)})},g,l));else{b=arcgisonline.map.layer.getIdFromUrl(a);m={layer:null,id:c.id||b,url:a,type:"base",title:c.title||d,defaultVisibility:esri.isDefined(c.visibility)?c.visibility:
!0,defaultOpacity:esri.isDefined(c.opacity)?c.opacity:1,minScale:esri.isDefined(c.minScale)?c.minScale:0,maxScale:esri.isDefined(c.maxScale)?c.maxScale:0,snippet:"",identify:!1,hadError:!1,serviceInfo:e,startVisibleLayers:c.visibleLayers};c.exclusionAreas&&(m.exclusionAreas=c.exclusionAreas);c.displayLevels&&(m.displayLevels=c.displayLevels);c.bandIds&&(m.defaultBandIds=c.bandIds);g&&g.id&&(m.itemCard=g,m.itemId=g.id);for(h=arcgisonline.map.main.mapLayers.length;0<h;h--)arcgisonline.map.main.mapLayers[h]=
arcgisonline.map.main.mapLayers[h-1];arcgisonline.map.main.mapLayers[0]=m;arcgisonline.map.layer.addLayer(m,0,function(){arcgisonline.map.main.defaultService=m;arcgisonline.map.main.currentBaseService=m.layer.id;arcgisonline.map.main.recreateOverviewMap();l&&l()},function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:f.string.substitute(esri.i18nBundle.viewer.error.basemapTitleNotAvailable,{title:d})});arcgisonline.map.save_open.basemapWebMap=
null;arcgisonline.map.layer.switchBaseLayer(arcgisonline.map.main.defaultBaseLayer.url,arcgisonline.map.main.defaultBaseLayer._layerType,arcgisonline.map.main.defaultBaseLayer.title,null,g)})}},removeLabelsLayers:function(){for(var a=arcgisonline.map.main.mapLayers.length-1;0<a;a--){var b=arcgisonline.map.main.mapLayers[a];"labels"==b.type&&(arcgisonline.map.main.mapLayers.splice(a,1),arcgisonline.map.main.map.removeLayer(b.layer))}},addLabelsLayer:function(a,b){b=b||{};var d={layer:null,id:arcgisonline.map.layer.getIdFromUrl(a),
url:a,type:"labels",title:"Reference",defaultVisibility:!0,defaultOpacity:1,minScale:esri.isDefined(b.minScale)?b.minScale:0,maxScale:esri.isDefined(b.maxScale)?b.maxScale:0,startVisibleLayers:b.visibleLayers||null,snippet:"",identify:!1,hadError:!1};b.exclusionAreas&&(d.exclusionAreas=b.exclusionAreas);b.displayLevels&&(d.displayLevels=b.displayLevels);b.bandIds&&(d.defaultBandIds=b.bandIds);arcgisonline.map.main.mapLayers[arcgisonline.map.main.mapLayers.length]=d;arcgisonline.map.layer.addLayer(d,
-1)},getIdFromUrl:function(a){var b=a.lastIndexOf("/");a=a.substring(0,b);b=a.lastIndexOf("/");b=a.substring(b+1,a.length);if("MapServer"==b||"FeatureServer"==b)b=a.lastIndexOf("/"),a=a.substring(0,b),b=a.lastIndexOf("/"),b=a.substring(b+1,a.length);a=Math.floor(10001*Math.random());b=b.replace("(","_").replace(")","_").replace("'","");return b+"_"+a},sameTilingSchemeAsBasemap:function(a){return arcgisonline.map.main.mapLods&&a.tileInfo?arcgisonline.map.main.sameTilingScheme(arcgisonline.map.main.mapLayers[0].layer.tileInfo,
a.tileInfo):!1},sameTilingSchemeAsBasemap2:function(){return arcgisonline.map.main.mapLods?arcgisonline.map.main.sameTilingScheme(arcgisonline.map.main.mapLayers[0].layer.tileInfo,{lods:arcgisonline.map.main.defaultBaseLayerMapLods,dpi:96}):!1},getServiceInfo:function(a,b,d,e){var g=function(b,c){clearTimeout(k);f.publish("ServiceAnswerReceived",[]);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();var g=b.fullExtent;g||(g=b.extent);if(g&&(!g.spatialReference||!g.spatialReference.wkid&&
!g.spatialReference.wkt))b.fullExtent=null,g=b.extent=null;(esriGeowConfig.allSSL||"https:"==location.protocol)&&(b.tileServers&&b.tileServers.length)&&f.forEach(b.tileServers,function(a,c){if(arcgisonline.sharing.util.isHostedService(a)||arcgisonline.sharing.util.supportsHttps(a))b.tileServers[c]=a.replace("http:","https:")});g?d&&d(b,a,c):b.spatialReference&&(b.spatialReference.wkid||b.spatialReference.wkt)?(g=new esri.geometry.Extent(-180,-90,180,90,new esri.SpatialReference({wkid:4326})),arcgisonline.map.main.projectExtent(g,
new esri.SpatialReference(b.spatialReference),f.hitch(this,function(e){b.fullExtent=e[0];b.extent=e[0];d&&d(b,a,c)}),f.hitch(this,function(a,b){e&&(a.details=[],a.details.push("Missing extent and could not project GCS into service spatial reference."),e(a,b))}))):d&&d(b,a,c)},c=function(a,b){clearTimeout(k);f.publish("ServiceAnswerReceived",[]);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();e&&e(a,b)},l=!1,k=setTimeout(function(){clearTimeout(k);k=null;var g=a.toLowerCase();
-1===g.indexOf("/arcgis/rest/")&&-1<g.indexOf("/arcgis/")?(a=a.replace("/arcgis/","/arcgis/rest/").replace("/ArcGIS/","/ArcGIS/rest/"),arcgisonline.map.layer.getServiceInfo(a,b,d,e)):esri.id.isBusy()?l=!0:b?(arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.waitDlgTitle,message:b}),k=setTimeout(function(){clearTimeout(k);k=null;esri.id.isBusy()?l=!0:c("Request timed out.",{args:{url:a}})},45E3)):c("Request timed out.",{args:{url:a}})},
1E4),h=a+(-1<a.indexOf("?")?"\x26f\x3djson":"?f\x3djson");esri.request({url:h,callbackParamName:"callback",load:function(b,d){if(k||l)clearTimeout(k),b?b.error&&""!=b.error?c(b.error,d):g(b,d):c("Request error.",{args:{url:a}})},error:function(b){if(k||l)clearTimeout(k),b&&b.message&&-1<b.message.indexOf("Aborted the Sign-In process")?f.publish("ServiceAnswerReceived",[]):c(b,{args:{url:a}})}})},waitForServiceResponse:function(a){var b=function(e){f.unsubscribe(d);e<a.length-1&&(d=f.subscribe("ServiceAnswerReceived",
f.hitch(this,b,e+1)));a[e]()},d=null;1<a.length&&(d=f.subscribe("ServiceAnswerReceived",f.hitch(this,b,1)));a[0]()},parseServiceInfo:function(a,b){var d=a.fullExtent;null==d&&(d=a.extent);var e=null,g=null;null!=d&&(e=d.spatialReference,null==e&&(e=a.spatialReference),g=new esri.SpatialReference,e.wkid&&(g.wkid=e.wkid),e.latestWkid&&(g.latestWkid=e.latestWkid),e.wkt&&(g.wkt=e.wkt),e=new esri.geometry.Extent(d.xmin,d.ymin,d.xmax,d.ymax,g));d=b;-1<b.indexOf("/MapServer")?(d=b.substring(0,b.indexOf("/MapServer")),
d=d.substring(d.lastIndexOf("/")+1,d.length)):-1<b.indexOf("/ImageServer")?(d=b.substring(0,b.indexOf("/ImageServer")),d=d.substring(d.lastIndexOf("/")+1,d.length)):-1<b.indexOf("/FeatureServer")?(d=b.substring(0,b.indexOf("/FeatureServer")),d=d.substring(d.lastIndexOf("/")+1,d.length)):a.documentInfo&&a.documentInfo.Title&&0<a.documentInfo.Title.length?d=a.documentInfo.Title:a.mapName&&0<a.mapName.length&&(d=a.mapName);-1<d.indexOf("%")&&(d=arcgisonline.map.main.decodeUrl(d));var d=arcgisonline.sharing.util.stripHTML(d),
c=a.serviceDescription;if((null==c||0==c.length)&&null!=a.description&&0<a.description.length)c=a.description;var c=arcgisonline.sharing.util.stripHTML(c),f=0;if(a.minScale||0===a.minScale)f=a.minScale;var k=0;if(a.maxScale||0===a.maxScale)k=a.maxScale;return{extent:e,spatialReference:g,title:d,description:c,minScale:f,maxScale:k}},getMode:function(a,b){if(null!=a.mode)b(a.mode);else if(arcgisonline.map.main.hasMSForFS(a))b(esri.layers.FeatureLayer.MODE_SELECTION);else if(a.serviceInfo&&10.11<=a.serviceInfo.currentVersion&&
"esriGeometryPoint"==a.serviceInfo.geometryType&&-1==a.serviceInfo.capabilities.toLowerCase().indexOf("editing")&&(!a.serviceInfo.timeInfo||a.serviceInfo.timeInfo&&!1===a.timeAnimation)){var d=new esri.tasks.QueryTask(a.url),e=new esri.tasks.Query;e.returnGeometry=!1;e.where="1\x3d1";esri.config.defaults.io.timeout=2E3;d.executeForCount(e,f.hitch(this,function(d){esri.config.defaults.io.timeout=6E4;var c=2E3;a.serviceInfo.maxRecordCount&&a.serviceInfo.maxRecordCount<c&&(c=a.serviceInfo.maxRecordCount);
d<=c?b(esri.layers.FeatureLayer.MODE_SNAPSHOT):b(esri.layers.FeatureLayer.MODE_ONDEMAND)}),f.hitch(this,function(){esri.config.defaults.io.timeout=6E4;b(esri.layers.FeatureLayer.MODE_ONDEMAND)}))}else b(esri.layers.FeatureLayer.MODE_ONDEMAND)},getLayerPosition:function(a){if("popup"==a.type)return{};var b=arcgisonline.map.main.numLabelsLayers(),d=arcgisonline.map.main.numMapNotesLayers();"labels"==a.type&&(b=0);var e=!1;if(!a.url||a.featureCollection||"csv"==a.subType||-1<a.url.indexOf("/StreamServer")||
a.serviceInfo&&"Feature Layer"==a.serviceInfo.type||!a.serviceInfo&&(-1<a.url.indexOf("/FeatureServer")||-1<a.url.indexOf("/MapServer/")&&!isNaN(a.url.substring(a.url.indexOf("/MapServer/")+11))))e=!0;for(var g="GeoRSS"===a.subType,b=arcgisonline.map.main.mapLayers.length-(b+d),d=b-1;0<d;d--)if(b=arcgisonline.map.main.mapLayers[d],b.layer&&b.layer instanceof esri.layers.FeatureLayer||b.layers||"GeoRSS"===b.subType)if(e||g){b=d+1;break}else b=d;else{b=d+1;break}d=b;if(e||g){var c=0;f.forEach(arcgisonline.map.main.mapLayers,
function(a){if((!a.layer||!a.layer.loaded)&&!a.layers)a.url&&a.serviceInfo&&"Feature Layer"===a.serviceInfo.type?c+=1:a.url&&(-1<a.url.indexOf("/FeatureServer")||-1<a.url.indexOf("/MapServer/"))?c+=1:a.featureCollection&&a.featureCollection.layers?c+=a.featureCollection.layers.length:"GeoRSS"==a.subType&&(c+=3);else if(a.layer instanceof esri.layers.GeoRSSLayer)c+=a.layer.getFeatureLayers().length;else if(a.layers||a.layer&&a.layer instanceof esri.layers.FeatureLayer)c+=a.layer?1:a.layers.length},
this);d=c-arcgisonline.map.main.countMapNotesSubLayers()}else a.serviceInfo||(d=arcgisonline.map.main.mapLayers.length);return{map:d,list:b}}}});