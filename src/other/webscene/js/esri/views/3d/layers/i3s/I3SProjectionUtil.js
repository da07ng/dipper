// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define(["../../support/projectionUtils","../../lib/glMatrix"],function(p,w){var g=w.vec3d,m=w.mat4d,v={PER_VERTEX:"perVertex",BOUNDINGBOX:"boundingBox",NO_REPROJECTION:"noReprojection"},l=new Float64Array(3E3);return{ReprojectionTypes:v,reprojectPoints:function(b,g,e,d,l,c,f,a){b===v.PER_VERTEX?d=this.reprojectPointsPerVertex(g,e,d,c,f,a,l):b===v.BOUNDINGBOX?d=this.reprojectBoundingBox(g,d,c,f,a):(b=m.create(),m.identity(b),g=m.create(),p.computeLinearTransformation(c,d,g,a),d={localTrafo:b,globalTrafo:g});
return d},reprojectPointsPerVertex:function(b,r,e,d,q,c,f){r=m.create();p.computeLinearTransformation(d,e,r,c);var a=m.create(),a=m.inverse(r,a),k=m.create();m.identity(k);g.create();g.create();if(!f){f=[0,0,0];b=b.data;var h=b.length/3;p.vectorToVector(e,d,f,q);for(d=e=0;d<h;d+=1E3){var n=Math.min(1E3,h-d);for(e=0;e<n;e++)l[3*e+0]=b[3*(d+e)+0]+f[0],l[3*e+1]=b[3*(d+e)+1]+f[1],l[3*e+2]=b[3*(d+e)+2]+f[2];p.bufferToBuffer(l,q,0,l,c,0,n);var s,t,u;for(e=0;e<n;e++)s=l[3*e+0],t=l[3*e+1],u=l[3*e+2],b[3*
(d+e)+0]=a[0]*s+a[4]*t+a[8]*u+a[12],b[3*(d+e)+1]=a[1]*s+a[5]*t+a[9]*u+a[13],b[3*(d+e)+2]=a[2]*s+a[6]*t+a[10]*u+a[14]}}return{localTrafo:k,globalTrafo:r}},reprojectBoundingBox:function(b,l,e,d,q){for(var c=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],f=[-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE],a=0;a<b.data.length/3;a++)for(var k=[b.data[3*a+0],b.data[3*a+1],b.data[3*a+2]],h=0;3>h;h++)c[h]=Math.min(c[h],k[h]),f[h]=Math.max(f[h],k[h]);a=this.geographicToProjected(l,e,d);g.add(a,
c,c);g.add(a,f,f);for(a=0;3>a;a++)f[a]==c[a]&&(f[a]+=1);a=[[c[0],c[1],c[2]],[f[0],c[1],c[2]],[c[0],f[1],c[2]],[c[0],c[1],f[2]]];for(k=0;4>k;k++)h=a[k],p.vectorToVector(h,d,h,q);d=g.subtract(a[1],a[0],g.create());k=g.subtract(a[2],a[0],g.create());h=g.subtract(a[3],a[0],g.create());g.scale(d,1/(f[0]-c[0]));g.scale(k,1/(f[1]-c[1]));g.scale(h,1/(f[2]-c[2]));var c=g.length(d),f=g.length(k),n=g.length(h);if(3<Math.abs(c-f)||3<Math.abs(c-n)||3<Math.abs(f-n)){for(a=0;a<b.data.length/3;a++)b.data[3*a+0]*=
c,b.data[3*a+1]*=f,b.data[3*a+2]*=n;g.normalize(d);g.normalize(k);g.normalize(h)}b=m.createFromMatrixRowMajor([d[0],k[0],h[0],0,d[1],k[1],h[1],0,d[2],k[2],h[2],0,0,0,0,1]);c=[0,0,0,0];p.vectorToVector(l,e,c,q);return{globalTrafo:m.createFromMatrixRowMajor([1,0,0,c[0],0,1,0,c[1],0,0,1,c[2],0,0,0,1]),localTrafo:b}},geographicToProjected:function(b,g,e){return 4326===e.wkid?[b[0],b[1],b[2]]:b}}});