// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/ManageTilesDlg",["dijit","dojo","dojox","dojo/require!dijit/Dialog,dijit/_Widget,dijit/_Templated,dijit/form/Button,dijit/layout/BorderContainer,dijit/layout/ContentPane,dojo/data/ItemFileWriteStore,arcgisonline/sharing/util,arcgisonline/sharing/dijit/DataGrid,arcgisonline/sharing/dijit/dialog/ChoiceDlg"],function(f,b,q){b.provide("arcgisonline.sharing.dijit.dialog.ManageTilesDlg");b.require("dijit.Dialog");b.require("dijit._Widget");b.require("dijit._Templated");
b.require("dijit.form.Button");b.require("dijit.layout.BorderContainer");b.require("dijit.layout.ContentPane");b.require("dojo.data.ItemFileWriteStore");b.require("arcgisonline.sharing.util");b.require("arcgisonline.sharing.dijit.DataGrid");b.require("arcgisonline.sharing.dijit.dialog.ChoiceDlg");b.declare("arcgisonline.sharing.dijit.dialog.ManageTilesDlg",[f._Widget,f._Templated],{widgetsInTemplate:!0,templateString:'\x3cdiv class\x3d"widgetContainer" data-dojo-attach-point\x3d"containerNode"\x3e\r\n  \x3cdiv class\x3d"${baseClass}" data-dojo-type\x3d"dijit.Dialog" data-dojo-attach-point\x3d"dialog" id\x3d"manage-tiles-dialog" title\x3d"${i18n.dialogTitle}" execute\x3d"" data-dojo-attach-event\x3d"onHide:hide"\x3e\r\n    \x3cspan data-dojo-attach-point\x3d"dialogDescription"\x3e\x3c/span\x3e\x3cbr/\x3e\r\n\r\n    \x3cdiv data-dojo-type\x3d"dijit.layout.BorderContainer" data-dojo-props\x3d"design:\'headline\',gutters:false,preventcache:true,usecache:false,cachecontent:false,region:\'center\'"\r\n         class\x3d"borderedContent" style\x3d"width:665px; height:200px;"\x3e\r\n      \x3cdiv id\x3d"gridContentPane" data-dojo-attach-point\x3d"gridContentPane" data-dojo-type\x3d"dijit.layout.ContentPane" data-dojo-props\x3d"region:\'center\'"\r\n           style\x3d"width:100%; height:100%;"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv style\x3d"font-weight:bold;"\x3e\r\n      \x3cdiv data-dojo-type\x3d"dijit.layout.BorderContainer" data-dojo-props\x3d"design:\'headline\',gutters:false,preventcache:true,usecache:false,cachecontent:false,region:\'center\'"\r\n           class\x3d"borderedContent" style\x3d"width:665px; height:32px;"\x3e\r\n        \x3cdiv id\x3d"totalsContentPane" data-dojo-attach-point\x3d"totalsContentPane" data-dojo-type\x3d"dijit.layout.ContentPane" data-dojo-props\x3d"region:\'center\'"\r\n             style\x3d"width:100%;height:100%;font-weight:bold;"\x3e\x3c/div\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv data-dojo-attach-point\x3d"controlDiv" style\x3d"margin-top:20px;"\x3e\r\n      \x3ctable width\x3d"100%"\x3e\r\n        \x3ctbody\x3e\r\n          \x3ctr\x3e\r\n            \x3ctd width\x3d"25%"\x3e\r\n              \x3cdiv\x3e\r\n                \x3cbutton id\x3d"buildButton" data-dojo-attach-point\x3d"buildButton" data-dojo-type\x3d"dijit.form.Button" type\x3d"button" class\x3d"primary" data-dojo-attach-event\x3d"onClick:onCreateClick"\x3e\r\n                  ${i18n.buildButton}\r\n                \x3c/button\x3e\r\n                \x3c!--\x3cbr/\x3e\r\n                \x3cbutton id\x3d"deleteButton" data-dojo-attach-point\x3d"deleteButton" data-dojo-type\x3d"dijit.form.Button" type\x3d"button"\x3e\r\n                  ${i18n.deleteButton}\r\n                \x3c/button\x3e--\x3e\r\n                \x3cbr/\x3e\x3cbr/\x3e\r\n                \x3cspan id\x3d"scalesSelectedSpan" data-dojo-attach-point\x3d"scalesSelectedSpan"\x3e\x3c/span\x3e\r\n              \x3c/div\x3e\r\n            \x3c/td\x3e\r\n            \x3ctd width\x3d"75%" valign\x3d"top"\x3e\r\n              \x3cdiv id\x3d"messageDiv" data-dojo-attach-point\x3d"messageDiv" style\x3d"margin-top:10px;"\x3e\x3c/div\x3e\r\n            \x3c/td\x3e\r\n          \x3c/tr\x3e\r\n        \x3c/tbody\x3e\r\n      \x3c/table\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv data-dojo-attach-point\x3d"cancelDiv" class\x3d"esriAlignTrailing" style\x3d"margin-top:20px;display:none;"\x3e\r\n      \x3cbutton id\x3d"cancelButton" data-dojo-attach-point\x3d"cancelButton" class\x3d"cancel" data-dojo-type\x3d"dijit.form.Button" type\x3d"button" data-dojo-attach-event\x3d"onClick:onCancelClick"\x3e\r\n        ${i18n.cancelButton}\r\n      \x3c/button\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e',
baseClass:"esriManageTiles",util:arcgisonline.sharing.util,_isPortal:!1,dialog:null,dialogDescription:null,gridContentPane:null,controlDiv:null,cancelDiv:null,messageDiv:null,scalesSelectedSpan:null,noSourceData:!1,isSourceTilePackage:!1,isVisible:!1,isProcessing:!1,allTilesComplete:!1,hasScrollbar:!1,createClicked:!1,item:null,serviceFullExtent:null,serviceTileInfo:null,serviceMinScale:null,serviceMaxScale:null,lastTileStatus:null,timeToNextUpdate:1E4,defaultTileWidth:256,defaultTileHeight:256,grid:null,
gridRows:5,gridStore:null,currentScrollPos:null,hostedServer:null,serverToken:null,adminServerToken:null,jobId:null,selectAllCon:null,i18n:null,statics:{_instance:null,getInstance:function(){null==this._instance&&(this._instance=new arcgisonline.sharing.dijit.dialog.ManageTilesDlg);return this._instance}},postMixInProperties:function(){this.inherited(arguments);this.i18n=b.i18n.getLocalization("arcgisonline","arcgisonline").common;b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").manageTilesDlg)},
postCreate:function(){esri.config.defaults.io.proxyUrl=esriGeowConfig.proxyServer;esriGeowConfig.proxyUrl&&(esri.config.defaults.io.proxyUrl=esriGeowConfig.proxyUrl);this._isIE=b.isIE||7<=b.has("trident")&&void 0===b.isIE},startup:function(){},setServerTokens:function(a,b,d){this.hostedServer=a;this.serverToken=b;this.adminServerToken=d},show:function(a,c,d,e){this.setFlags();this.item=a;(this.isSourceTilePackage=d)&&f.byId("buildButton").set("label",this.i18n.publishButton);a=function(a){a&&(!a.code&&
!a.message)&&(this.serviceFullExtent=a.fullExtent,this.serviceTileInfo=a.tileInfo,this.serviceTileInfo.width||(this.serviceTileInfo.width=this.defaultTileWidth),this.serviceTileInfo.height||(this.serviceTileInfo.height=this.defaultTileHeight),arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.tileInfo=this.serviceTileInfo,this.serviceMinScale=a.minScale?a.minScale:this.serviceTileInfo.lods[0].scale,this.serviceMaxScale=a.maxScale?a.maxScale:this.serviceTileInfo.lods[this.serviceTileInfo.lods.length-
1].scale,this.dialog.show(),this.isVisible=!0,this._updateStatus(c))};e?a(e):this._isPortal?esri.request({url:this.item.url,content:{f:"json",token:this.serverToken}}).then(b.hitch(this,a),b.hitch(this,a)):this.util.getJson(this.item.url,b.hitch(this,a),b.hitch(this,a))},setFlags:function(){this._isPortal=this.util.isPortal();this._roleCanPublishTiles=(this._roleCanCreateItem=esriGeowConfig.userRole.canCreateItem())&&esriGeowConfig.userRole.canPublishTiles()},showNoSource:function(a,b){this.noSourceData=
!0;this.show(a,b,!1)},hide:function(){this.noSourceData=!1;this.dialog.hide();var a=esri.urlToObject(document.URL);if(this.createClicked||a.query&&a.query.showManageTiles)window.location=esriGeowConfig.baseUrl+"item.html?id\x3d"+this.item.id},_getStatus:function(){this.grid&&(this.currentScrollPos=this.grid.views.views[0].scrollboxNode.scrollTop);if(this._isPortal){var a=b.hitch(this,function(a){a&&(a.results&&!a.message)&&(a=a.results[0],a.serviceName=this.lastTileStatus.serviceName,a.type=this.lastTileStatus.type,
a.lodInfos=a.value.lodInfos,a.cacheExecutionStatus=a.value.cacheExecutionStatus,a.minScale=this.lastTileStatus.minScale,a.maxScale=this.lastTileStatus.maxScale);this._updateStatus(a)}),c=this.item.url.indexOf("/services/")+10,d=this.item.url.indexOf("/"+this.lastTileStatus.serviceName+"/")+1,c=this.item.url.substring(c,d)+this.lastTileStatus.serviceName+":"+this.lastTileStatus.type,e=("https:"===location.protocol?this.hostedServer.url.replace("http:","https:").replace(":6080",":6443"):this.hostedServer.url.replace("https:",
"http:").replace(":6443",":6080"))+"/rest/services/System/ReportingTools/GPServer/ReportCacheStatus/execute",g={service_url:c,report_mode:"esriCacheStatus",f:"json",token:this.serverToken,job_id:this.jobId,ts:(new Date).getTime()};this.jobId?esri.request({url:e,content:g}).then(a,a):(c={service_url:c,report_mode:"esriJobSummary",f:"json",token:this.serverToken,ts:(new Date).getTime()},esri.request({url:e,content:c}).then(b.hitch(this,function(b){b&&(b.results&&b.results[0]&&b.results[0].value.esriJobStatus&&
b.results[0].value.esriJobStatus[0])&&(this.jobId=b.results[0].value.esriJobStatus[0].cancelJobID,g.job_id=this.jobId);esri.request({url:e,content:g}).then(a,a)})))}else c=this.item.url.replace("/rest/","/rest/admin/"),this.util.request({url:c,content:{ts:(new Date).getTime()}}).then(b.hitch(this,this._updateStatus),b.hitch(this,this._updateStatus))},_updateStatus:function(a){if(!a||!("Error"==a.name&&"Unknown runtime error"==a.message))this.lastTileStatus=a,this.lastTileStatus.minScale||(this.lastTileStatus.minScale=
this.serviceMinScale),this.lastTileStatus.maxScale||(this.lastTileStatus.maxScale=this.serviceMaxScale),(this.isProcessing="PROCESSING"===a.cacheExecutionStatus||"SUBMITTED"===a.cacheExecutionStatus)&&this.isVisible&&setTimeout(b.hitch(this,this._getStatus),this.timeToNextUpdate),this._refreshUI()},_refreshUI:function(){this._updateData();this.grid?this._updateGrid():this._createGrid();this.totalsGrid?this._updateTotalsGrid():this._createTotalsGrid();null!==this.currentScrollPos&&(this.grid.views.views[0].scrollboxNode.scrollTop=
this.currentScrollPos);this._updateDescription();this._updateTotals();this._updateButtons();this._updateMessage()},_updateButtons:function(){this._roleCanPublishTiles?this.isProcessing||this.allTilesComplete?(this._hideButtons(),this.isProcessing&&this._isPortal&&this.jobId?this._showCancel():this._hideCancel()):(this._showButtons(),this._hideCancel()):this._hideButtons()},_updateMessage:function(){!this.isProcessing&&!this.allTilesComplete&&(this.noSourceData?b.attr(this.messageDiv,"innerHTML",this.i18n.noSourceData):
b.attr(this.messageDiv,"innerHTML",this.isSourceTilePackage?this.i18n.selectTilesPublish:this.i18n.selectTiles))},_updateData:function(){this.gridStore=new b.data.ItemFileWriteStore({data:this._getTileStatusData()});if(this.noSourceData)b.attr(this.scalesSelectedSpan,"display","none");else{var a=b.string.substitute(this.i18n.scalesSelected,{scales:0});b.attr(this.scalesSelectedSpan,"innerHTML",a)}},_getTileStatusData:function(){var a=[];b.forEach(this.serviceTileInfo.lods,b.hitch(this,function(c){if(c.scale<=
this.lastTileStatus.minScale&&c.scale>=this.lastTileStatus.maxScale){var d=arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.calculateExpectedTiles(this.serviceTileInfo,this.serviceFullExtent,c);a.push({id:c.level,selected:!1,scaleLevel:"1:"+b.number.format(Math.round(c.scale),{pattern:"#,###,###,##0"}),scale:c.scale,created:0,expected:d,pctComplete:0,storageSize:0})}}));this.lastTileStatus&&(this.lastTileStatus.lodInfos&&0<this.lastTileStatus.lodInfos.length)&&b.forEach(this.lastTileStatus.lodInfos,
b.hitch(this,function(b){for(var c=0;c<a.length;c++)if(a[c]&&a[c].id===b.levelID){var d=Math.round(100*(b.tileCount/b.expectedTileCount));100<d&&(d=100);this._isPortal&&b.pct&&(d=b.pct);c=a[c];c.created=b.tileCount;c.expected=b.expectedTileCount;c.pctComplete=d;c.storageSize=b.tilesSize?b.tilesSize:0;break}}));var c=0,d=0;b.forEach(a,function(a){c+=a.created;d+=a.expected});this.allTilesComplete=c===d;arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.disableButtons();this.hasScrollbar=a.length>
this.gridRows;return{identifier:"id",label:"scaleLevel",items:a}},_updateTotals:function(){var a=0,c=0,d=0;this.grid.store.fetch({onComplete:function(e){b.forEach(e,function(b){b.selected.length?(c+=parseInt(b.created[0],10),a+=parseInt(b.expected[0],10),d+=b.storageSize[0]?parseInt(b.storageSize[0],10):0):(c=parseInt(b.created,10),a=parseInt(b.expected,10),d=b.storageSize?parseInt(b.storageSize,10):0)})}});var e=b.number.round(100*(c/a),2)||0,e=100<e?100:e,g;g=this.lastTileStatus&&!this._isPortal?
this.lastTileStatus.size:d;this.totalsGrid.setStructure(this._getTotalsGridLayout());this.totalsGridStore.fetch({id:0,onComplete:b.hitch(this,function(d){this.totalsGridStore.setValue(d[0],"created",c);this.totalsGridStore.setValue(d[0],"expected",a);this.totalsGridStore.setValue(d[0],"pctComplete",e);this.totalsGridStore.setValue(d[0],"storageSize",g);this.totalsGridStore.save({onComplete:b.hitch(this,function(){this.totalsGrid.update()})})})})},_updateDescription:function(){b.attr(this.dialogDescription,
"innerHTML","\x3cstrong\x3e"+(this.isProcessing?this.isSourceTilePackage?this.i18n.jobStatusPublishing:this.i18n.jobStatus:this.i18n.noJobStatus)+"\x3c/strong\x3e\x3cbr/\x3e")},_hideButtons:function(){b.style(this.controlDiv,"display","none")},_showButtons:function(){b.style(this.controlDiv,"display","block")},_hideCancel:function(){b.style(this.cancelDiv,"display","none")},_showCancel:function(){b.style(this.cancelDiv,"display","block")},_getInitialTotalsGridStore:function(){return new b.data.ItemFileWriteStore({data:{identifier:"id",
label:"label",items:[{id:0,label:this.i18n.totals,created:0,expected:0,pctComplete:0,storageSize:0}]}})},_resetTotals:function(){var a=b.number.format(0);this.totalsGridStore.fetch({id:0,onComplete:b.hitch(this,function(c){this.totalsGridStore.setValue(c[0],"created",a);this.totalsGridStore.setValue(c[0],"expected",a);this.totalsGridStore.setValue(c[0],"pctComplete",a);this.totalsGridStore.setValue(c[0],"storageSize",0);this.totalsGridStore.save({onComplete:b.hitch(this,function(){this.totalsGrid.update()})})})})},
_updateTotalsGrid:function(){this.totalsGrid.setStructure(this._getTotalsGridLayout());this._resetTotals()},_updateGrid:function(){b.byId("selectAll")&&(b.disconnect(this.selectAllCon),this.selectAllCon=null,b.destroy(b.byId("selectAll")));this.grid.setStructure(this._getGridLayout());this.grid.setStore(this.gridStore);this.grid.update();b.byId("selectAll")&&(this.selectAllCon=b.connect(b.byId("selectAll"),"onclick",arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.toggleAll),arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.checkToggled())},
_createTotalsGrid:function(){this.totalsGrid=new arcgisonline.sharing.dijit.DataGrid({structure:this._getTotalsGridLayout(),rowsPerPage:1,region:"center",noDataMessage:"",id:"totalsGridNode",jsid:"totalsGrid",selectionMode:"none",clientSort:!1,gutters:!1,canSort:function(){return 0}},b.byId("totalsContentPane"));this.totalsGrid.startup();this.totalsGridStore=this._getInitialTotalsGridStore();this.totalsGrid.setStore(this.totalsGridStore);this.totalsGrid.update()},_createGrid:function(){this.grid=
new arcgisonline.sharing.dijit.DataGrid({structure:this._getGridLayout(),rowsPerPage:this.gridRows,region:"center",noDataMessage:this.i18n.noVisibleRange,id:"scaleGridNode",jsid:"scaleGrid",selectionMode:"none",clientSort:!1,gutters:!1,canSort:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.noSort},b.byId("gridContentPane"));this.grid.startup();this.selectAllCon=b.connect(b.byId("selectAll"),"onclick",arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.toggleAll);this.grid.setStore(this.gridStore);
this.grid.update()},_getTotalsGridLayout:function(){var a=[[]];!this.isProcessing&&(!this.allTilesComplete&&!this.noSourceData)&&a[0].push({field:"selectedItem",get:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.spacerFormatter,formatter:arcgisonline.sharing.util.fix,name:" ",width:this._getSelectColWidth(),styles:"text-align:center;"});a[0].push({field:"label",get:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.totalsLabelFormatter,formatter:arcgisonline.sharing.util.fix,name:" ",width:this._getTotalsColWidth()});
a[0].push({field:"created",get:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.tilesCreatedFormatter,formatter:arcgisonline.sharing.util.fix,name:" ",width:this._getCreatedColWidth()});a[0].push({field:"expected",get:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.totalTilesFormatter,formatter:arcgisonline.sharing.util.fix,name:" ",width:this._getExpectedColWidth()});a[0].push({field:"pctComplete",get:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.percentCompleteFormatter,formatter:arcgisonline.sharing.util.fix,
name:" ",width:this._getPctCompleteColWidth()});a[0].push({field:"storageSize",get:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.storageSizeFormatter,formatter:arcgisonline.sharing.util.fix,name:" ",width:this._getTotalStorageColWidth()});return a},_getGridLayout:function(){var a=[[]];!this.isProcessing&&(!this.allTilesComplete&&!this.noSourceData&&this._roleCanPublishTiles)&&a[0].push({field:"selectedItem",get:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.selectItem,formatter:arcgisonline.sharing.util.fix,
name:'\x3cinput type\x3d"checkbox" id\x3d"selectAll" name\x3d"selectAll" onclick\x3d"arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.toggleAll(this);" style\x3d"border:none; padding:0; margin:0;"/\x3e',width:this._getSelectColWidth(),styles:"text-align:center;"});a[0].push({field:"scaleLevel",get:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.scaleLevelFormatter,formatter:arcgisonline.sharing.util.fix,name:this.i18n.grid.scaleLevel,width:this._getScaleColWidth()});a[0].push({field:"created",
get:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.tilesCreatedFormatter,formatter:arcgisonline.sharing.util.fix,name:this.isSourceTilePackage?this.i18n.grid.tilesPublished:this.i18n.grid.tilesCreated,width:this._getCreatedColWidth()});a[0].push({field:"expected",get:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.totalTilesFormatter,formatter:arcgisonline.sharing.util.fix,name:this.i18n.grid.totalTiles,width:this._getExpectedColWidth()});a[0].push({field:"pctComplete",get:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.percentCompleteFormatter,
formatter:arcgisonline.sharing.util.fix,name:this.i18n.grid.percentComplete,width:this._getPctCompleteColWidth()});a[0].push({field:"storageSize",get:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.storageSizeFormatter,formatter:arcgisonline.sharing.util.fix,name:this.i18n.grid.storageSize,width:this._getStorageColWidth()});return a},_getTotalsColWidth:function(){return"auto"},_getSelectColWidth:function(){return"20px"},_getScaleColWidth:function(){return this.hasScrollbar&&this._isIE&&esriGeowConfig.isRightToLeft?
"183px":"auto"},_getCreatedColWidth:function(){return"115px"},_getExpectedColWidth:function(){return"100px"},_getPctCompleteColWidth:function(){return"115px"},_getStorageColWidth:function(){return"105px"},_getTotalStorageColWidth:function(){return this.hasScrollbar?b.isFF||this._isIE&&!esriGeowConfig.isRightToLeft||b.isSafari&&esriGeowConfig.isRightToLeft?"105px":this._isIE&&esriGeowConfig.isRightToLeft?"125px":"120px":"105px"},_getTilesCreatedSpanColWidth:function(){return this.hasScrollbar&&this._isIE&&
esriGeowConfig.isRightToLeft?"101px":b.isSafari?"116px":"113px"},_getTotalTilesSpanColWidth:function(){return this.hasScrollbar&&this._isIE&&esriGeowConfig.isRightToLeft?"90px":b.isSafari?"101px":"99px"},_getPctCompleteSpanColWidth:function(){return this.hasScrollbar&&this._isIE&&esriGeowConfig.isRightToLeft?"103px":b.isSafari?"111px":"115px"},_getStorageSpanColWidth:function(){return this.hasScrollbar&&this._isIE&&esriGeowConfig.isRightToLeft?"92px":this.hasScrollbar?b.isFF||this._isIE?"119px":"139px":
"119px"},onCancelClick:function(a){this.cancelButton.set("disabled",!0);a=b.hitch(this,function(a){console.log("cancel cache response",a);esri.isDefined(a.error)&&(arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance.show({title:this.i18n.errorTitle,message:this.i18n.cantCancelJob}),this.cancelButton.set("disabled",!1))});esri.request({url:this.hostedServer.adminUrl+"/rest/services/System/CachingControllers/GPServer/Manage%20Map%20Cache%20Tiles/jobs/"+this.jobId+"/cancel",content:{f:"json",
token:this.adminServerToken}},{usePost:!0}).then(a,a)},checkCredits:function(a){var c=new b.Deferred,d=esriGeowConfig.restBaseUrl+"portals/self/cost";a={generatedTileCount:a};this._isPortal||this.isSourceTilePackage?c.resolve():this.util.request({url:d,content:a}).then(b.hitch(this,function(a){c.resolve(a)}),b.hitch(this,function(a){c.resolve()}));return c},onCreateClick:function(a){this.grid.store.fetch({onComplete:b.hitch(this,function(a){var d=0,e=0,g=0,k=[],h;b.forEach(a,b.hitch(this,function(a){1===
a.selected.length?(a.selected[0]&&(h=parseInt(a.expected[0],10)-parseInt(a.created[0],10),0<h&&(this._isPortal?k.push(""+a.scale[0]):k.push(a.id[0]),d+=h)),e+=parseInt(a.created[0],10),g+=parseInt(a.storageSize[0],10)):(a.selected&&(h=parseInt(a.expected,10)-parseInt(a.created,10),0<h&&(this._isPortal?k.push(""+a.scale):k.push(a.id),d+=h)),e+=parseInt(a.created,10),g+=parseInt(a.storageSize,10))}));if(0<k.length){a=0<g&&0<e?g/e:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.getAvgTileSize(this.serviceTileInfo);
var f=arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.formatSizeWithUnits(a*d),l=this._isPortal?k.join(";"):k.join(","),n=this.serviceFullExtent.xmin+","+this.serviceFullExtent.ymin+","+this.serviceFullExtent.xmax+","+this.serviceFullExtent.ymax;this.checkCredits(d).then(b.hitch(this,function(a){var c="\x3cp\x3e"+b.string.substitute(this.isSourceTilePackage?this.i18n.aboutToPublish:this.i18n.aboutToCreate,{tiles:d,storage:f})+"\x3c/p\x3e";!this._isPortal&&(!this.isSourceTilePackage&&esri.isDefined(a.transactionCreditCost)&&
esri.isDefined(a.availableCredits))&&(c+="\x3cp\x3e"+b.string.substitute(this.i18n.aboutToCreateCost,{credits:b.number.format(a.transactionCreditCost),creditsLeft:b.number.format(a.availableCredits)})+"\x3c/p\x3e");c+="\x3cp\x3e"+(this.isSourceTilePackage?this.i18n.reallyPublishTiles:this.i18n.reallyCreateTiles)+"\x3c/p\x3e";a=arcgisonline.sharing.dijit.dialog.ChoiceDlg.prototype.statics.getInstance();c={title:this.isSourceTilePackage?this.i18n.publishTiles:this.i18n.createTiles,message:c,choiceOneTitle:this.isSourceTilePackage?
this.i18n.yesPublishTiles:this.i18n.yesCreateTiles,choiceTwoTitle:this.isSourceTilePackage?this.i18n.noPublishTiles:this.i18n.noCreateTiles};c.choiceOneHandler=b.hitch(this,function(){this.createClicked=!0;if(this._isPortal){this.cancelButton.set("disabled",!1);var a=this.item.url.indexOf("/services/")+10,c=this.item.url.indexOf(this.lastTileStatus.serviceName),c=this.item.url.substring(a,c),a=this.hostedServer.adminUrl+"/rest/services/System/CachingControllers/GPServer/Manage%20Map%20Cache%20Tiles/submitJob",
c={f:"json",token:this.adminServerToken,service_url:c+this.lastTileStatus.serviceName+":"+this.lastTileStatus.type,constraining_extent:n,levels:l,update_mode:"RECREATE_ALL_TILES",thread_count:-1},d=b.hitch(this,function(a){a.code&&a.message?(console.log("Error updating tiles",a),arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.errorTitle,message:a.message})):(this.jobId=a.jobId,this.isProcessing=!0,this._refreshUI(),setTimeout(b.hitch(this,this._getStatus),
this.timeToNextUpdate))});esri.request({url:a,content:c},{usePost:!0}).then(d,d)}else a=this.item.url.replace("/rest/","/rest/admin/")+"/updateTiles",9>=b.isIE&&(c=a.indexOf("admin/services/"),d=a.indexOf("/MapServer"),a=a.substring(0,c+15)+encodeURIComponent(a.substring(c+15,d))+a.substring(d)),c={levels:l,extent:n},d=b.hitch(this,function(a){if(a.code&&a.message){var c=a.message;a.message&&-1<a.message.toLowerCase().indexOf("credit")&&(c=this.i18n.notEnoughCredits);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.errorTitle,
message:c})}else this.isProcessing=!0,this._refreshUI(),setTimeout(b.hitch(this,this._getStatus),this.timeToNextUpdate)}),this.util.request({url:a,content:c},{usePost:!0}).then(d,d)});c.choiceTwoHandler=b.hitch(this,function(){});a.show(c)}))}})})}});arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util={tileInfo:null,i18n:function(){if(this._i18n)return this._i18n;this._i18n=b.i18n.getLocalization("arcgisonline","arcgisonline").common;b.mixin(this._i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").manageTilesDlg);
return this._i18n},selectItem:function(a,b){return!b?this.defaultValue:'\x3cinput type\x3d"checkbox" id\x3d"chk_'+b.id+'" onclick\x3d"arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.toggleItem(\''+b.id+"');\" "+("true"==b.selected?"checked":"")+' style\x3d"width:auto;" class\x3d"dojoxGridInput" /\x3e'},scaleLevelFormatter:function(a,b){return!b?this.defaultValue:'\x3cspan class\x3d"esriContentTypeName"\x3e'+b.scaleLevel+"\x3c/span\x3e"},percentCompleteFormatter:function(a,b){return!b?this.defaultValue:
'\x3cspan class\x3d"esriContentTypeName"\x3e'+b.pctComplete+"%\x3c/span\x3e"},spacerFormatter:function(a,b){return!b?this.defaultValue:'\x3cspan class\x3d"esriContentTypeName"\x3e\x3c/span\x3e'},totalsLabelFormatter:function(a,b){return!b?this.defaultValue:'\x3cspan class\x3d"esriContentTypeName"\x3e'+b.label+"\x3c/span\x3e"},tilesCreatedFormatter:function(a,c){if(!c)return this.defaultValue;var d="esriContentTypeName";c.created&&1E10<=c.created&&(d="esriContentTypeNameSmall");return'\x3cspan class\x3d"'+
d+'"\x3e'+b.number.format(c.created)+"\x3c/span\x3e"},totalTilesFormatter:function(a,c){if(!c)return this.defaultValue;var d="esriContentTypeName";c.expected&&1E10<=c.expected&&(d="esriContentTypeNameSmall");return'\x3cspan class\x3d"'+d+'"\x3e'+b.number.format(c.expected)+"\x3c/span\x3e"},storageSizeFormatter:function(a,b){return!b?this.defaultValue:'\x3cspan class\x3d"esriContentTypeName"\x3e'+arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.formatSize(b.storageSize)+"\x3c/span\x3e"},noSort:function(a){return!1},
getAvgTileSize:function(a){return 1E3*(a.rows?a.rows/10:25.6)},formatSize:function(a){if(a){var c=a;0<a&&(c=a/1048567);c=Math.round(100*c)/100;return b.number.format(c)}return 0},formatSizeWithUnits:function(a){var c=a,d=" "+this.i18n().megabytes;1048567E3<a?(c=a/1048567E3,d=" "+this.i18n().gigabytes):0<a&&(c=a/1048567);c=Math.round(100*c)/100;return b.number.format(c)+d},toggleAll:function(a){if(a){var c=b.attr(a,"checked");a=f.byId("scaleGridNode");a.store&&(a.store.fetch({onComplete:function(a){b.forEach(a,
function(a){1===a.selected.length?a.selected[0]=c:a.selected=c})}}),a.update(),arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.checkToggled())}},toggleItem:function(a){var c=f.byId("scaleGridNode");c.store&&(c.store.fetch({onComplete:function(c){b.forEach(c,function(b){if((1===b.id.length?b.id[0]:b.id)==a)1===b.selected.length?b.selected[0]=b.selected[0]?!1:!0:b.selected=b.selected?!1:!0})}}),c.update(),arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.checkToggled())},enableButtons:function(a,
c,d){var e=arcgisonline.sharing.dijit.dialog.ManageTilesDlg.prototype.statics.getInstance().isSourceTilePackage,g=arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.i18n().tilesToCreate,k=arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.i18n().tilesToPublish,h=arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.i18n().noTilesToCreate,p=arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.i18n().noTilesToPublish,l="";a!==c?(a=c-a,d=arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.formatSizeWithUnits(d*
a),l=b.string.substitute(e?k:g,{tiles:a,storage:d}),f.byId("buildButton").attr("disabled",!1)):(l=b.string.substitute(e?p:h,{tiles:0}),f.byId("buildButton").attr("disabled",!0));b.attr(b.byId("messageDiv"),"innerHTML",l)},disableButtons:function(){var a=arcgisonline.sharing.dijit.dialog.ManageTilesDlg.prototype.statics.getInstance().isSourceTilePackage;b.attr(b.byId("messageDiv"),"innerHTML",a?arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.i18n().selectTilesPublish:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.i18n().selectTiles);
f.byId("buildButton").attr("disabled",!0)},setScalesSelected:function(a){var c=arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.i18n().scalesSelected;a=b.string.substitute(c,{scales:a});b.byId("scalesSelectedSpan")&&b.attr(b.byId("scalesSelectedSpan"),"innerHTML",a)},checkToggled:function(){var a=0,c=0,d=0,e=0,g=0,k=!0,h=f.byId("scaleGridNode");h.store?h.store.fetch({onComplete:function(f){b.forEach(f,function(b){var f=0,h=0,m=0;1===b.selected.length?(f=parseInt(b.created[0],10),h=parseInt(b.expected[0],
10),m=parseInt(b.storageSize[0],10),b.selected[0]?(a++,c+=f<=h?f:h,d+=h):k=!1):(f=parseInt(b.created,10),h=parseInt(b.expected,10),m=parseInt(b.storageSize,10),b.selected?(a++,c+=f<=h?f:h,d+=h):k=!1);e+=f;g+=m});b.byId("selectAll")&&b.attr(b.byId("selectAll"),"checked",k);a?(f=0<g?g/e:arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.getAvgTileSize(arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.tileInfo),arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.enableButtons(c,d,f)):arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.disableButtons()}}):
arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.disableButtons();arcgisonline.sharing.dijit.dialog.ManageTilesDlg.util.setScalesSelected(a)},calculateExpectedTiles:function(a,b,d){var e=new esri.geometry.Point(b.xmax,b.ymin,b.spatialReference);b=new esri.geometry.Point(b.xmin,b.ymax,b.spatialReference);b=esri.TileUtils.getContainingTileCoords(a,b,d);a=esri.TileUtils.getContainingTileCoords(a,e,d);a=(a.row+1-b.row)*(a.col+1-b.col);0>=a&&(a=1);return a}}});