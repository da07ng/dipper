// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/LayersGrid",["dijit","dojo","dojox","dojo/require!arcgisonline/sharing/geow/Content,arcgisonline/sharing/geow/Community,arcgisonline/sharing/dijit/Gallery,arcgisonline/sharing/dijit/views,arcgisonline/sharing/util,dojo/mouse"],function(m,a,n){a.provide("arcgisonline.sharing.dijit.LayersGrid");a.require("arcgisonline.sharing.geow.Content");a.require("arcgisonline.sharing.geow.Community");a.require("arcgisonline.sharing.dijit.Gallery");a.require("arcgisonline.sharing.dijit.views");
a.require("arcgisonline.sharing.util");a.require("dojo.mouse");a.declare("arcgisonline.sharing.dijit.LayersGrid",[m._Widget,m._Templated],{_gallery:null,itemsGroupIds:null,groupQuery:null,galleryNodes:4,showThumbnail:!0,templateString:"\x3cdiv dojoAttachPoint\x3d'containerNode' class\x3d'itemsGallery'\x3e\x3c/div\x3e",textMenus:[],i18n:null,postMixInProperties:function(){this.inherited(arguments);this.i18n=a.i18n.getLocalization("arcgisonline","arcgisonline").common;this.i18n=a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline",
"arcgisonline").itemLinks);a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").templatesGridWidget);this.init()},init:function(){this.groupQuery='(title:"Featured Maps And Apps" AND owner:esri)';arcgisonline.sharing.geow.Community.searchGroups(this.groupQuery,a.hitch(this,this._handleGetGroup),a.hitch(this,this._handleGetGroup))},_getItems:function(e,b,g){if(g){this._gallery.clear("\x3cp class\x3d'esriItemLinks'\x3e\x3cspan\x3e"+this.i18n.searching+"\x3c/span\x3e\x3c/p\x3e");var d=
"",k="";a.forEach(this.itemsGroupIds,function(a){d+=k+"group:"+a;k=" OR "});var c={q:"("+d+")"+g+(e?" AND "+e:""),sortField:null,num:"100"};arcgisonline.map.role.isAllowed("add_require_credits")||(c.q+=' -typekeywords:"Requires Credits"');this.sortOrder&&(c.sortOrder=this.sortOrder);if(!esri.isDefined(b)||b){var f=function(b,e){c.bbox=arcgisonline.map.main.extentToString(b[0]);arcgisonline.sharing.geow.Content.search(esriGeowConfig.restBaseUrl+"search",c,a.hitch(this,this._handleItemsResponse),a.hitch(this,
this._handleItemsResponse))},l=function(){arcgisonline.sharing.geow.Content.search(esriGeowConfig.restBaseUrl+"search",c,a.hitch(this,this._handleItemsResponse),a.hitch(this,this._handleItemsResponse))},h=arcgisonline.map.main.map.extent;h.spatialReference._isWrappable()?esri.geometry.normalizeCentralMeridian([h],null,a.hitch(this,function(b){if(b[0].rings){var c=(new esri.geometry.Polygon(h.spatialReference)).addRing(b[0].rings[0]).getExtent();b=(new esri.geometry.Polygon(h.spatialReference)).addRing(b[0].rings[1]).getExtent();
h=c.getWidth()>b.getWidth()?c:b}else h=b[0];arcgisonline.map.main.projectExtent(h,new esri.SpatialReference({wkid:4326}),a.hitch(this,f),a.hitch(this,l))})):arcgisonline.map.main.projectExtent(h,new esri.SpatialReference({wkid:4326}),a.hitch(this,f),a.hitch(this,l))}else arcgisonline.sharing.geow.Content.search(esriGeowConfig.restBaseUrl+"search",c,a.hitch(this,this._handleItemsResponse),a.hitch(this,this._handleItemsResponse))}else g=' (type:"Map Service" OR type:"Image Service" OR type:"Feature Service" OR type:"WMS" OR type:"KML" OR type:"Vector Tile Service") ',
arcgisonline.map.vectorTile.checkSupport().then(a.hitch(this,function(a,b,c){c||(g=' (type:"Map Service" OR type:"Image Service" OR type:"Feature Service" OR type:"WMS" OR type:"KML") ');this._getItems(a,b,g)},e,b))},refresh:function(a,b){this.itemsGroupIds&&this._getItems(a,b)},postCreate:function(){this._gallery=new arcgisonline.sharing.dijit.Gallery({id:this.id+"_Gallery",nodesPerPage:this.galleryNodes,showNodeLabels:!0,showToolTip:!1,noResultsMessage:"\x3cp class\x3d'esriItemLinks'\x3e\x3cspan\x3e"+
this.i18n.noItemsToDisplay+"\x3c/span\x3e\x3c/p\x3e"},a.create("div",null,this.domNode));this._user=arcgisonline.sharing.util.getUser();var e=this;a.mixin(this._gallery,{_buildNodeLayout:function(b,g){var d=a.create("div",{id:"galleryNode_"+b.id,"class":this.nodeClass,style:"position:relative;"});a.addClass(d,g?"large":"small");if(this.showNodeLabels){var k=a.create("div",{"class":"galleryLabelContainer"},d),c=b.title||"";a.create("span",{innerHTML:c,alt:c,title:c},k)}arcgisonline.sharing.util.getGalleryMainLinkInfo(b);
k=a.create("a",{href:"JavaScript:void(0);"},d);a.create("img",{"class":this.thumbClass,src:b.thumbnail?this._getThumbailUrl(b):arcgisonline.sharing.util.relativeToExplicitUrl("images/transparent.gif")},k);a.create("br",null,d);var c=a.create("div",{"class":"linksDiv"},d),c=a.create("div",{"class":"esriItemLinks"},c),f=a.create("div",{"class":"esriFloatLeading"},c),f=a.create("a",{style:"text-decoration: none;"},f);a.create("span",{innerHTML:this.i18n.addToViewer},f);a.create("div",{"class":"dijitReset dijitInline esriArrows"},
f);var l=[];l.push({label:this.i18n.asLayer,onClick:a.hitch(this,function(a){arcgisonline.map.save_open.openServiceItemCards(a,!1);"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftTOCPanel()},b.id)});("Map Service"==b.type||"Image Service"==b.type||"WMS"==b.type||"Vector Tile Service"==b.type)&&l.push({label:this.i18n.asBasemap,onClick:a.hitch(this,function(a){arcgisonline.map.save_open.openBaseMapServiceItemCard(a);"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&
arcgisonline.map.leftPanel.openLeftTOCPanel()},b.id)});f=new arcgisonline.sharing.dijit.TextMenu({triggerNode:f,labelNode:f,textMenuItems:l});e.textMenus.push(f);a.create("span",{innerHTML:"\x26nbsp;",style:"width:0;"},c);c=b.snippet||"";145<c.length&&(c=c.substring(0,140)+"...");c=a.create("div",{id:"tooltip"+b.id,className:"layersGridTooltip",innerHTML:'\x3cp class\x3d"title ellipsis"\x3e'+b.title+"\x3c/p\x3e\x3cp\x3e"+c+"\x3c/p\x3e",onclick:a.hitch(this,function(a){arcgisonline.map.save_open.openServiceItemCards(a,
!1);"contentStack"!=arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftTOCPanel()},b.id)},d,"first");(f=arcgisonline.sharing.geow.Content._getPremiumItemNode(b))&&a.place(f,a.create("p",{},c,"last"));var h=function(b){(b=a.byId(b))&&a.style(b,{opacity:0,display:"none"})},m=function(b,c){var d=a.byId(b);esri.show(d);var g=a.coords(d),f=a.coords(a.byId(c).parentNode);esriGeowConfig.isRightToLeft&&g.x+g.l<f.x+f.l?(a.style(d,"right","auto"),a.style(d,"left",10>a.isIE?
"10px":"0")):g.w+g.x>f.w+f.x&&(a.style(d,"left","auto"),a.style(d,"right",10>a.isIE?"10px":"0"));a.fadeIn({node:d}).play();a.forEach(e.textMenus,function(a){a.hide()})};/ipad|android|android 3.0|xoom|sch-i800|playbook|tablet|kindle/i.test(navigator.userAgent.toLowerCase())?a.connect(k,"onclick",function(){var c=a.byId("tooltip"+b.id);c&&"block"===a.getStyle(c,"display")?h("tooltip"+b.id):m("tooltip"+b.id,"galleryNode_"+b.id);a.query(".layersGridTooltip").forEach(function(a){a.id!=="tooltip"+b.id&&
h(a.id)})}):(a.connect(k,a.mouse.enter,function(){a.query(".layersGridTooltip").forEach(function(a){h(a.id)});m("tooltip"+b.id,"galleryNode_"+b.id)}),a.connect(c,a.mouse.leave,function(){h("tooltip"+b.id)}));return d}});this._gallery.startup()},_getPremiumIcon:function(e){return(e=arcgisonline.sharing.geow.Content._getPremiumItemNode(e))?a.place(e,a.create("p",{})):""},_setGroupIdsAttr:function(a){0!==a.length&&(this.pageCount=0,this.itemsGroupIds=a,this._getItems())},_handleItemsResponse:function(e,
b){for(var g,d=[],k=0;k<e.results.length;k++)g=e.results[k],g.url&&d.push(g);a.attr(this._gallery,"items",d)},_handleGetGroup:function(e,b){e&&0<e.total?(this.itemsGroupIds=a.map(e.results,function(a){return a.id}),this._setGroupIdsAttr(this.itemsGroupIds)):console.error('LayersGrid: groups with title "'+this.groupQuery+'" do not exist.')},nextPage:function(){this._gallery.nextPage()},prevPage:function(){this._gallery.prevPage()}})});