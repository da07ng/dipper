// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
require({cache:{"url:esri/views/3d/environment/materials/SimpleAtmosphereMaterial.xml":'\x3c?xml version\x3d"1.0" encoding\x3d"UTF-8"?\x3e\r\n\r\n\x3csnippets\x3e\r\n\r\n\x3csnippet name\x3d"vsSimpleAtmosphere"\x3e\x3c![CDATA[\r\n  uniform mat4 proj;\r\n  uniform mat4 view;\r\n\r\n#ifndef PANORAMIC\r\n\r\n  const float TWICEPI \x3d 2.0*3.14159265;\r\n  const float ATMOSPHERE_RIM_SEGMENTS \x3d 128.0;\r\n\r\n  uniform vec3 silCircleCenter;\r\n  uniform vec3 silCircleV1;\r\n  uniform vec3 silCircleV2;\r\n  uniform vec2 texV;\r\n\r\n#endif\r\n\r\n  uniform vec3 lightDirection;\r\n\r\n  attribute vec3 $position;\r\n  varying vec2 vtc;\r\n  varying float falloff;\r\n\r\n  void main(void) {\r\n\r\n#ifdef PANORAMIC\r\n\r\n    vec3 pos \x3d $position;\r\n    float ndotl \x3d lightDirection.z;\r\n    vtc \x3d vec2(0, $position.z+0.05);\r\n\r\n#else\r\n\r\n    float phi \x3d $position.x * (TWICEPI / ATMOSPHERE_RIM_SEGMENTS) + 1.0;\r\n    vec3 pos \x3d (sin(phi) * silCircleV1 + cos(phi) * silCircleV2 + silCircleCenter) * $position.y;\r\n    float ndotl \x3d dot(normalize(pos), lightDirection);\r\n\r\n    vtc.x \x3d $position.x / ATMOSPHERE_RIM_SEGMENTS;\r\n    vtc.y \x3d texV.x * (1.0 - $position.z) + texV.y * $position.z;\r\n\r\n#endif\r\n\r\n    falloff \x3d max(0.0, (smoothstep(-1.0, 0.8, ndotl + ndotl)));\r\n\r\n    gl_Position \x3d proj * view * vec4(pos, 1.0);\r\n    gl_Position.z \x3d gl_Position.w; // project atmosphere onto the far plane\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3csnippet name\x3d"fsSimpleAtmosphere"\x3e\x3c![CDATA[\r\n  precision mediump float;\r\n\r\n  uniform sampler2D tex;\r\n  uniform vec4 color;\r\n  varying vec2 vtc;\r\n  varying float falloff;\r\n\r\n  void main() {\r\n    vec4 texColor \x3d texture2D(tex, vtc);\r\n    gl_FragColor \x3d texColor * color * falloff;\r\n  }\r\n]]\x3e\x3c/snippet\x3e\r\n\r\n\x3c/snippets\x3e\r\n'}});
define("dojo/text!./materials/SimpleAtmosphereMaterial.xml dojo/on ../../../core/declare ../../../core/Accessor ../lib/glMatrix ../webgl-engine/lib/GeometryRenderer ../webgl-engine/lib/VertexBufferLayout ../webgl-engine/lib/Texture ../webgl-engine/lib/Util ../webgl-engine/lib/GLSLProgram ../webgl-engine/lib/GLTextureRep ./resources/SimpleAtmosphereTexture ../support/earthUtils".split(" "),function(x,y,z,A,r,B,C,D,n,u,E,F,G){var m=G.earthRadius,d=r.vec3d,v=r.vec2d,w=r.mat4d,s=n.VertexAttrConstants,
H=(m-1E4)/m,t=(m+3E5)/m,p=-1E4/3E5,q=1-p;return z([A],{classMetadata:{properties:{view:{}}},normalizeCtorArgs:function(a){return"esri.views.SceneView"===a.declaredClass?{view:a,initialized:!1}:a},constructor:function(){this.geometryData=this._createRibbonGeometryData();this.renderData={texV:v.create(),silCircleCenter:d.create(),silCircleV1:d.create(),silCircleV2:d.create()};this.textureRep=this.texture=null;this.gl=this.slot=0;this._needsRender=!0;this._didRender=!1},setContext:function(a){this.gl=
a;this.renderer=new B(this.geometryData,C.Defaults.Pos,null,this.gl)},loadShaders:function(a,c,b){a.vsSimpleAtmosphere||a._parse(x);this.program=u.fromSnippets("vsSimpleAtmosphere","fsSimpleAtmosphere",a,this.gl);this.programRep=b;this.textureRep=new E({SimpleAtmosphere:new D(F,"SimpleAtmosphere",{wrapClamp:!0})},b,function(){return this.view._stage.getCamera().viewport}.bind(this),this.gl);this.texture=this.textureRep.aquire("SimpleAtmosphere")},render:function(a){if(!(a.slot!==this.slot||"material"!==
a.pass||!this.textureRep.getIsLoaded("SimpleAtmosphere"))){var c=this.gl,b=this.program;b.use();b.uniform4f("color",1,1,1,1);b.uniformMatrix4fv("proj",a.camera.projectionMatrix);b.uniformMatrix4fv("view",a.camera.viewMatrix);b.uniform3fv("silCircleCenter",this.renderData.silCircleCenter);b.uniform3fv("silCircleV1",this.renderData.silCircleV1);b.uniform3fv("silCircleV2",this.renderData.silCircleV2);b.uniform2fv("texV",this.renderData.texV);c.bindTexture(c.TEXTURE_2D,this.texture);b.uniform1i("tex",
0);b.uniform3fv("lightDirection",a.lightingData.getLightDirection());c.web3DDefaultState.depthFunc!==c.LEQUAL&&c.depthFunc(c.LEQUAL);c.depthMask(!1);c.enable(c.BLEND);this.renderer.render(this.program);this._didRender=!0;u.unuse(c);c.depthMask(!0);c.disable(c.BLEND);c.web3DDefaultState.depthFunc!==c.LEQUAL&&c.depthFunc(c.web3DDefaultState.depthFunc)}},needsRender:function(){return this._needsRender},resetNeedsRender:function(){this._didRender&&(this._needsRender=!1)},init:function(){this._cameraListener=
y(this.view.navigation,"currentViewChanged",function(a){this.update(a.camera)}.bind(this));this.initialized=!0;this.update(this.view.navigation.currentCamera)},destroy:function(){this._cameraListener.remove();this.textureRep&&this.textureRep.release(this.texture)},update:function(a){if(!(d.length(a.eye)<=m)&&this.initialized){var c=this.view._stage,b=d.create(),e=d.create(),h=d.create(),f=this.view.renderCoordsHelper.getAltitude(a.eye);d.scale(a.eye,(m+50)/d.length(a.eye),h);this._computeSilhouetteCircle(h,
a.center,a.up,m);d.add(this.renderData.silCircleCenter,this.renderData.silCircleV2,b);d.scale(b,t,e);var h=this._computeScreenRimWidth(h,a.up,b,e),k=0,l=1,g=1;50>f?(k=0.001953125,l=0.1015625):500>f?(g=(f-50)/450,k=0.001953125*(1-g)+0.001953125*g,l=0.1015625*(1-g)+0.21875*g):5E3>f?(g=(f-500)/4500,k=0.001953125*(1-g)+0.001953125*g,l=0.21875*(1-g)+0.51171875*g):5E4>f&&(g=(f-5E3)/45E3,k=0.001953125*(1-g)+0.001953125*g,l=0.51171875*(1-g)+0.4140625*g);f=p+k*q;g=p+h*l*q;50<d.length(a.eye)-m&&(this._computeSilhouetteCircle(a.eye,
a.center,a.up,m),d.add(this.renderData.silCircleCenter,this.renderData.silCircleV2,b),d.scale(b,t,e),a=this._computeScreenRimWidth(a.eye,a.up,b,e),a=n.clamp((a-1.5)/(h-1.5),0,1),f=p+a*k*q,g=p+n.lerp(1,h*l,a)*q);v.set2(f,g,this.renderData.texV);c.setNeedsRender()}},_computeSilhouetteCircle:function(a,c,b,e){var h=d.length(a),f=Math.sqrt(h*h-e*e),f=e*f/h;e=Math.sqrt(e*e-f*f);var k=this.renderData.silCircleV1,l=this.renderData.silCircleV2;d.scale(a,e/h,this.renderData.silCircleCenter);d.cross(a,c,k);
1>d.length2(k)&&d.cross(a,b,k);d.scale(k,f/d.length(k));d.cross(k,a,l);d.scale(l,f/d.length(l));return f},_computeScreenRimWidth:function(a,c,b,e){var h=w.create();w.lookAt(a,b,c,h);a=this.view.navigation.currentCamera;n.project(b,h,a.projectionMatrix,a.viewport);n.project(e,h,a.projectionMatrix,a.viewport);return d.dist(b,e)/a.height},_createRibbonGeometryData:function(){for(var a=new Float32Array(768),c=new Uint32Array(768),b=0;128>b;b++){var e=6*b;a[e+0]=b;a[e+1]=H;a[e+2]=0;a[e+3]=b;a[e+4]=t;a[e+
5]=1;var d=2*b,f=127===b?0:d+2;c[e+0]=d;c[e+1]=d+1;c[e+2]=f+1;c[e+3]=f+1;c[e+4]=f;c[e+5]=d}b={};b[s.POSITION]=c;c={};c[s.POSITION]={size:3,data:a};return{faces:{type:"triangle",indices:b,positionKey:s.POSITION},vertexAttr:c}}})});