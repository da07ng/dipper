// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/SignUp",["dijit","dojo","dojox","dojo/require!dijit/_Widget,dijit/_Templated,dijit/form/Button,dijit/form/ValidationTextBox,arcgisonline/sharing/util,arcgisonline/sharing/geow/Geow,arcgisonline/sharing/geow/Account,arcgisonline/sharing/dijit/dialog/ChoiceDlg,arcgisonline/sharing/dijit/dialog/TermsOfUseDlg"],function(d,b,k){b.provide("arcgisonline.sharing.dijit.SignUp");b.require("dijit._Widget");b.require("dijit._Templated");b.require("dijit.form.Button");b.require("dijit.form.ValidationTextBox");
b.require("arcgisonline.sharing.util");b.require("arcgisonline.sharing.geow.Geow");b.require("arcgisonline.sharing.geow.Account");b.require("arcgisonline.sharing.dijit.dialog.ChoiceDlg");b.require("arcgisonline.sharing.dijit.dialog.TermsOfUseDlg");b.declare("arcgisonline.sharing.dijit.SignUp",[d._Widget,d._Templated],{util:arcgisonline.sharing.util,termsOfUseDlg:arcgisonline.sharing.dijit.dialog.TermsOfUseDlg,geow:arcgisonline.sharing.geow.Geow,redirectUrl:esriGeowConfig.baseUrl+"index.html",orgRedirectUrl:esriGeowConfig.baseUrl+
"organization.html",setupRedirectUrl:esriGeowConfig.baseUrl+"setup.html",widgetsInTemplate:!0,templateString:'\x3cdiv class\x3d"widgetContent"\x3e\r\n  \x3cdiv id\x3d"sign-up-form" class\x3d"grid_16"\x3e\r\n    \x3ch1 id\x3d"sign_up_title"\x3e\x3c/h1\x3e\r\n    \x3cdiv id\x3d"register-error"\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv dojotype\x3d"dijit.form.Form" id\x3d"register-form" method\x3d"POST" action\x3d""\x3e\r\n      \x3cp class\x3d"register"\x3e\r\n        \x3cb id\x3d"sign-up-title"\x3e\x3c/b\x3e\r\n      \x3c/p\x3e\r\n      \x3cp class\x3d"freeTrial" style\x3d"display:none;"\x3e${i18n.activateTrialMsg}\x3c/p\x3e\r\n      \x3cp\x3e\r\n        \x3ctable\x3e\r\n          \x3ctbody\x3e\r\n            \x3ctr\x3e\r\n              \x3ctd class\x3d"grid_2 alpha"\x3e\r\n                \x3clabel for\x3d"register_username" style\x3d"padding:0;margin:0;"\x3e\r\n                  ${i18n.userLabel}\r\n                \x3c/label\x3e\r\n              \x3c/td\x3e\r\n              \x3ctd\x3e\r\n                \x3cdiv id\x3d"register_username" name\x3d"register_username" class\x3d"grid_6 omega" style\x3d"padding:2px;margin:0;" dojotype\x3d"dijit.form.TextBox" trim\x3d"true"\x3e\r\n                \x3c/div\x3e\r\n              \x3c/td\x3e\r\n            \x3c/tr\x3e\r\n            \x3ctr height\x3d"5"\x3e\r\n              \x3ctd colspan\x3d"2" height\x3d"5"\x3e\r\n              \x3c/td\x3e\r\n            \x3c/tr\x3e\r\n            \x3ctr\x3e\r\n              \x3ctd class\x3d"grid_2 alpha"\x3e\r\n                \x3clabel for\x3d"register_password" style\x3d"padding:0;margin:0;"\x3e\r\n                  ${i18n.passwordLabel}\r\n                \x3c/label\x3e\r\n              \x3c/td\x3e\r\n              \x3ctd\x3e\r\n                \x3cdiv id\x3d"register_password" name\x3d"register_password" class\x3d"grid_6 omega" style\x3d"padding:2px;margin:0;" type\x3d"password" dojotype\x3d"dijit.form.TextBox"trim\x3d"true"\x3e\r\n                \x3c/div\x3e\r\n              \x3c/td\x3e\r\n            \x3c/tr\x3e\r\n            \x3ctr\x3e\r\n              \x3ctd\x3e\x3c/td\x3e\r\n              \x3ctd\x3e\r\n                \x3cdiv class\x3d"freeTrial" style\x3d"display:none;"\x3e\r\n                  \x3ca dojoAttachPoint\x3d"_signInHelpLink" href\x3d"troubleshoot.html"\x3e${i18n.needHelpSign}\x3c/a\x3e\r\n                  \x3cdiv\x3e\r\n                    \x3cinput id\x3d"remember-me" value\x3d"off" dojotype\x3d"dijit.form.CheckBox" /\x3e\r\n                    \x3clabel for\x3d"remember-me"\x3e${i18n.rememberMe}\x3c/label\x3e\r\n                  \x3c/div\x3e\r\n                \x3c/div\x3e\r\n                \x3cdiv class\x3d"register"\x3e\r\n                  \x3cdiv id\x3d"forgotPasswordLinkDiv"\x3e\r\n                    \x3ca id\x3d"forgotPasswordLink"\x3e${i18n.forgotPassword}\x3c/a\x3e\r\n                  \x3c/div\x3e\r\n                \x3c/div\x3e\r\n                \x3cdiv style\x3d"margin-top:10px;"\x3e\r\n                  \x3cbutton id\x3d"button_sign_in" class\x3d"calcite blue" dojoAttachPoint\x3d\'_btnSignIn\' type\x3d"submit" label\x3d"${i18n.register}" dojotype\x3d"dijit.form.Button"\x3e\r\n\r\n                  \x3c/button\x3e\r\n                  \x3cimg dojoAttachPoint\x3d\'_keyImgicon\' style\x3d"display:none; position:absolute; padding-left:10px;"/\x3e\r\n                  \x3cbr/\x3e\r\n                  \x3cbr/\x3e\r\n                  \x3cdiv id\x3d"registerDiv"\x3e\r\n                  \x3cp\x3e\r\n                    \x3cb id\x3d"sign-up-no-account"\x3e\x3c/b\x3e\r\n                    \x3cbr/\x3e\r\n                    \x3cspan\x3e\x3ca id\x3d"registerLink"\x3e${i18n.createAccount}\x3c/a\x3e\x3c/span\x3e\r\n                  \x3c/p\x3e\r\n                  \x3c/div\x3e\r\n                \x3c/div\x3e\r\n              \x3c/td\x3e\r\n            \x3c/tr\x3e\r\n          \x3c/tbody\x3e\r\n        \x3c/table\x3e\r\n        \x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv style\x3d"width:100%; clear:both;"\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n',
i18n:null,postMixInProperties:function(){this.inherited(arguments);this.i18n=b.i18n.getLocalization("arcgisonline","arcgisonline").common;b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").signUpWidget);this.defaultOrgTitleText=this.i18n.myAccount},postCreate:function(){b.attr(this._keyImgicon,"src",this.util.relativeToExplicitUrl("images/goldKey.gif"));esriGeowConfig.portalName&&b.style(this._keyImgicon,"display","none")},startup:function(){this.inherited(arguments);b.mixin(this,
b.queryToObject(window.location.search.slice(1)));this.trial=this.type&&("trial"===this.type.toLowerCase()||"trial press"===this.type.toLowerCase());esri.config.defaults.io.proxyUrl=esriGeowConfig.proxyServer;this._svcUrl=esriGeowConfig.restBaseUrl+(esriGeowConfig.restBaseUrl.lastIndexOf("/")===esriGeowConfig.restBaseUrl.length-1?"":"/");this._communityUri=this._svcUrl+"community/";this._usersUri=this._communityUri+"users/";this._accountsUri=this._svcUrl+"portals/";this._requestParams={f:"json"};
this.loadConnections();esriGeowConfig.account_registration?b.byId("registerLink").href=esriGeowConfig.account_registration:b.style(b.byId("registerDiv"),"display","none");esriGeowConfig.forgotPwd?b.byId("forgotPasswordLink").href=esriGeowConfig.forgotPwd:b.style(b.byId("forgotPasswordLinkDiv"),"display","none");b.byId("sign-up-title").innerHTML=b.string.substitute(this.i18n.enterYourAccountInfo,{account:esriGeowConfig.esriGlobalAccount?esriGeowConfig.esriGlobalAccount:this.i18n.esriGlobalAccount});
b.byId("sign-up-no-account").innerHTML=b.string.substitute(this.i18n.dontHaveAccount,{account:esriGeowConfig.esriGlobalAccount?esriGeowConfig.esriGlobalAccount:this.i18n.esriGlobalAccount});this.trial?(b.attr("registerYour","innerHTML",this.i18n.activateTrial),this._btnSignIn.set("label",this.i18n.signIn),b.query(".registerYour").style("display","none"),b.query(".freeTrial").style("display","block")):esriGeowConfig.useDefaultIdentityStore?b.attr("registerYour","innerHTML",this.i18n.createAccount):
b.attr("registerYour","innerHTML",this.i18n.registerYour+(esriGeowConfig.esriGlobalAccount||this.i18n.esriGlobalAccount));setTimeout(function(){b.byId("register_username").focus()},350);b.subscribe("registerUser",this,"registerUser");b.subscribe("declineTermsOfUse",this,"declineTermsOfUse")},loadConnections:function(){b.connect(d.byId("button_register"),"onClick",this,"signUp");b.connect(d.byId("register-form"),"onSubmit",this,"signUp")},signIn:function(a){this.invitation?arcgisonline.sharing.geow.Account.getInvitation(this.invitation,
b.hitch(this,this.onInvitationInfo),b.hitch(this,this.onInvitationInfo)):this.activationcode?this._activateAccount(a).then(b.hitch(this,"routeUser")):this.routeUser()},onInvitationInfo:function(a,f){var c;if(a&&a.code&&a.message&&403===a.code){var e="\x3cp\x3e"+this.i18n.emailInvitation+"\x3c/p\x3e\x3cp\x3e"+this.i18n.clickOkInstructions+"\x3c/p\x3e";c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();c.onOkClick=b.hitch(this,function(a,b){a.hide();this.routeUser()},c);
c.show({title:this.i18n.notice,message:e})}else if(a&&a.code&&a.message&&400===a.code)e="\x3cp\x3e"+this.i18n.invitationUsedMsg+"\x3c/p\x3e\x3cp\x3e"+this.i18n.clickOkSignIn+"\x3c/p\x3e",c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),c.onOkClick=b.hitch(this,function(a,b){a.hide();this.routeUser()},c),c.show({title:this.i18n.notice,message:e});else if(a&&a.id&&a.id===this.invitation){c=arcgisonline.sharing.util.getUser();var d="\x3cp\x3e"+b.string.substitute(this.i18n.membershipPending,
{account:"\x3cstrong\x3e"+a.account.name+"\x3c/strong\x3e"})+"\x3c/p\x3e";c="\x3cp\x3e\x3cstrong\x3e"+b.string.substitute(this.i18n.ByAcceptingInvite,{account:a.account.name,name:c.username})+"\x3c/strong\x3e\x3c/p\x3e\x3cp\x3e\x3cul\x3e\x3cli\x3e"+b.string.substitute(this.i18n.transferMsg,{account:a.account.name,name:c.username})+"\x3c/li\x3e\x3cli\x3e"+this.i18n.leaveOrganization+"\x3c/li\x3e\x3cli\x3e"+b.string.substitute(this.i18n.itemsMsg,{beginStrong:"\x3cstrong\x3e",endStrong:"\x3c/strong\x3e"})+
"\x3c/li\x3e\x3cli\x3e"+this.i18n.accountManagedMsg+"\x3c/li\x3e\x3c/ul\x3e\x3c/p\x3e\x3cp\x3e"+b.string.substitute(this.i18n.currentOrNewAccount,{account:a.account.name})+"\x3c/p\x3e";e={title:this.i18n.notice,message:c,choiceOneTitle:this.i18n.useCurrentAccount,choiceTwoTitle:this.i18n.createNewOne};e.choiceOneHandler=b.hitch(this,function(c){a.mustApprove&&!0===a.mustApprove?(console.log(a),c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),c.onOkClick=b.hitch(this,
function(a){a.hide();arcgisonline.sharing.geow.Account.acceptInvitation(this.invitation,b.hitch(this,this.onInvitationAccepted),b.hitch(this,this.onInvitationAccepted))},c),c.show({title:this.i18n.notice,message:d})):arcgisonline.sharing.geow.Account.acceptInvitation(this.invitation,b.hitch(this,this.onInvitationAccepted),b.hitch(this,this.onInvitationAccepted))});e.choiceTwoHandler=b.hitch(this,function(a){this.routeUser()});c=arcgisonline.sharing.dijit.dialog.ChoiceDlg.prototype.statics.getInstance();
c.show(e)}else this.routeUser()},onInvitationAccepted:function(a){var f;a&&a.success&&!0===a.success?(f={username:d.byId("register_username").getValue(),password:d.byId("register_password").getValue(),expiration:esriGeowConfig.tokenExpiration},this.geow.signin(f,b.hitch(this,this.routeUser),b.hitch(this,"signInError"))):a&&a.code&&a.message&&500===a.code&&"Invitation has already been accepted."===b.trim(a.message)?(a="\x3cp\x3e"+this.i18n.acceptedInvite+"\x3c/p\x3e\x3cp\x3e"+this.i18n.clickOk+"\x3c/p\x3e",
f=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),f.onOkClick=b.hitch(this,function(a,b){a.hide();this.routeUser()},f),f.show({title:this.i18n.notice,message:a})):(f=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),f.onOkClick=b.hitch(this,function(a,b){a.hide();window.location=esriGeowConfig.baseUrl.replace("http:","https:")+esriGeowConfig.signin+"?invitation\x3d"+this.invitation},f),a.code&&a.message?("User already member of an account."===
a.message&&(a.message=this.i18n.userAnotheOrg),f.show({title:this.i18n.unableJoin,message:a.message})):f.show({title:this.i18n.unableJoin,message:this.i18n.problemJoingOrg}))},routeUser:function(){var a=this.returnUrl,f=esriGeowConfig.baseUrl+esriGeowConfig.signin;a&&-1<a.indexOf(f)&&(a=null);(this._user=this.util.getUser()).accountId?this._fetchSelf().then(b.hitch(this,"routeOrg")):window.location=a?a:esriGeowConfig.baseUrl.replace("https:","http:")+"user.html?newUser\x3dtrue"},routeOrg:function(a,
b){var c=this._user,e=this.returnUrl,d=esriGeowConfig.baseUrl+esriGeowConfig.signin;e&&-1<e.indexOf(d)&&(e=null);var g=this._organization=a||{},d=g.allSSL,h;e?(g.urlKey&&g.customBaseUrl&&(c=this._util.parseUrl(e).host,-1===c.indexOf(g.urlKey+"."+g.customBaseUrl)&&(h=this.util.getCookie("esri_auth"),e=e.replace(c,g.urlKey+"."+g.customBaseUrl),e=this.util.getBridgeUrl(e,h))),window.location=d?e.replace("http:","https:"):e):g.urlKey&&g.customBaseUrl?(h=null,-1===window.location.host.indexOf(g.urlKey+
"."+g.customBaseUrl)&&(h=this.util.getCookie("esri_auth")),e=(d?"https:":"http:")+"//"+g.urlKey+"."+g.customBaseUrl,g=esriGeowConfig.baseUrl.indexOf(location.host),e=-1<g?e+(esriGeowConfig.baseUrl.substring(g+location.host.length)+("account_admin"===c.role?"organization.html":"index.html")):d?this.redirectUrl.replace("http:","https:"):this.redirectUrl.replace("https:","http:"),h&&(e=esriGeowConfig.bridgeUrl+"?url\x3d"+e+"\x26exp\x3d"+Math.ceil((new Date(h.expires)-new Date)/1E3)),window.location=
e):window.location="account_admin"===c.role&&!g.urlKey?d?this.setupRedirectUrl.replace("http:","https:"):this.setupRedirectUrl.replace("https:","http:"):"account_admin"===c.role&&this.activationcode?d?this.orgRedirectUrl.replace("http:","https:"):this.orgRedirectUrl.replace("https:","http:"):d?this.redirectUrl.replace("http:","https:"):this.redirectUrl.replace("https:","http:")},signUp:function(a){a.preventDefault();b.query("#register-error")&&(b.byId("register-error").innerHTML="",b.removeClass("register-error",
"error"));!1!==this.validateForm()&&(d.byId("button_sign_in").set("disabled",!0),this.trial||d.byId("button_sign_in").set("label",this.i18n.registering),esriGeowConfig.portalName?this.registerUser():this.trial&&this.activationcode?(this.signout(),this._signin(b.hitch(this,function(){this.termsOfUseDlg.prototype.statics.getInstance().show()})).then(b.hitch(this,function(){this._showAlreadyRegisteredDlg()}))):this.termsOfUseDlg.prototype.statics.getInstance().show())},_showAlreadyRegisteredDlg:function(){var a=
arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();a.show({title:this.i18n.alreadyRegisteredTitle,message:this.i18n.alreadyRegistered});var f=b.connect(a,"onHide",b.hitch(this,function(){b.disconnect(f);d.byId("register_username").set("value","");d.byId("register_password").set("value","");d.byId("button_sign_in").set("disabled",!1);setTimeout(b.hitch(function(){d.byId("register_username").focus()}),300)}))},validateForm:function(){var a=d.byId("register_username").getValue(),
b=d.byId("register_password").getValue(),c=null;if((null==a||""===a)&&(null==b||""===b))c=this.i18n.error.userNamePassRqd;else if(null==a||""===a)c=this.i18n.error.usernameRqd;else if(null==b||""===b)c=this.i18n.error.passRqd;if(null==c)return!0;this.showError({message:c});return!1},signout:function(){esriGeowConfig.userInfo=null;esriGeowConfig.userPreferences=null;b.cookie("esri_auth",null,{expires:-1,path:"/",domain:document.domain});b.cookie("ESRI_Webmap",null,{expires:-1,path:"/",domain:document.domain});
b.publish("onSignOut",[])},registerUser:function(a){a=b.byId("register_username").value;var f=b.byId("register_password").value;a={username:a,password:f};this.signout();this.geow.signup(a,b.hitch(this,function(a,e){if(null!=a.error&&""!==a.error)d.byId("button_sign_in").set("disabled",!1),d.byId("button_sign_in").set("label",this.trial?this.i18n.signIn:this.i18n.register),this.errorHandler(a,e);else return this._signin().then(b.hitch(this,"signIn"))}),b.hitch(this,"signInError"))},declineTermsOfUse:function(){d.byId("button_sign_in").set("disabled",
!1)},signInError:function(a,f){d.byId("button_sign_in").set("disabled",!1);d.byId("button_sign_in").set("label",this.trial?this.i18n.signIn:this.i18n.register);var c="\x3cb style\x3d'font-size:1.2em;line-height:30px;'\x3e"+b.string.substitute(this.i18n.unableRegister,{portalName:esriGeowConfig.portalName?esriGeowConfig.portalName:this.i18n.arcgisOnline})+"\x3c/b\x3e\x3cbr/\x3e",c=c+"\x3cspan style\x3d'color:#000000;'\x3e",c=a.code&&500===a.code&&a.message&&"Unable to register user. Username contains unsupported characters."===
a.message?c+this.i18n.invalidUsername:c+(this.i18n.usernameSpellCheck+"\x3cbr/\x3e"+this.i18n.caseSensitive);this.showError({message:c+"\x3c/span\x3e\x3cbr/\x3e\x26nbsp;"})},_activateAccount:function(a){return this._request(this._accountsUri+"activate",{code:this.activationcode,token:a.token},{usePost:!0,errBack:b.hitch(this,"_activateError")}).then(b.hitch(this,"_signin"))},_activateError:function(a){a.details=a.details&&a.details.length?b.filter(a.details,"return item !\x3d\x3d null"):null;a.details&&
a.details.length&&(a.details=a.details.join("\x3cbr /\x3e"),a.message=a.message?a.message+"\x3cbr /\x3e"+a.details:a.details);a=b.mixin(b.mixin({},{title:"Error",message:"There was an error."}),a);var f=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();f.onOkClick=b.hitch(this,function(a){a.hide();this.routeUser()},f);f.show(a)},_signin:function(a){var f=new b.Deferred,c={username:d.byId("register_username").getValue(),password:d.byId("register_password").getValue(),expiration:b.byId("remember-me").checked?
esriGeowConfig.longTokenExpiration:esriGeowConfig.tokenExpiration};this.geow.signin(c,b.hitch(this,"_resolveDfd",f),a||b.hitch(this,"signInError"));return f},_resolveDfd:function(a,b){if(b.error)throw this.signInError(b.error),b.error;a.resolve(b)},_fetchSelf:function(){var a=this.util.getUser();esriGeowConfig.self=null;return this._request(this._accountsUri+"self",{token:a.token})},_request:function(a,d,c){d=b.mixin(d||{},this._requestParams);return this.util.request({url:a,content:d},c||{}).then(b.hitch(this,
function(a){return a.error?c.errBack?c.errBack(a.error):this._showError(a.error):a}),b.hitch(this,function(a){c.errBack?c.errBack(a):this._showError(a);throw a;}))},showError:function(a){a=a.error||a||{};a.code=a.code||0;a.details=a.details&&a.details.length?b.filter(a.details,"return item !\x3d\x3d null"):null;a.details&&a.details.length&&(a.details=a.details.join("\x3cbr /\x3e"),a.message=a.message?a.message+"\x3cbr /\x3e"+a.details:a.details);b.addClass("register-error","error");b.attr(b.byId("register-error"),
"innerHTML",a.message+"");return!0}})});