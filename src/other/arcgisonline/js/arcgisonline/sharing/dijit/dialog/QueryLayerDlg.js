// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/QueryLayerDlg",["dijit","dojo","dojox","dojo/i18n!arcgisonline/nls/arcgisonline","dojo/require!dijit/_Widget,dijit/_Templated,dijit/form/Button,dojox/widget/Standby,dojo/data/ItemFileWriteStore,dojo/i18n,arcgisonline/sharing/util,arcgisonline/sharing/dijit/dialog/GeneralDlg,arcgisonline/map/main"],function(e,a,g){a.provide("arcgisonline.sharing.dijit.dialog.QueryLayerDlg");a.require("dijit._Widget");a.require("dijit._Templated");a.require("dijit.form.Button");
a.require("dojox.widget.Standby");a.require("dojo.data.ItemFileWriteStore");a.require("dojo.i18n");a.requireLocalization("arcgisonline","arcgisonline");a.require("arcgisonline.sharing.util");a.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");a.require("arcgisonline.map.main");a.declare("arcgisonline.sharing.dijit.dialog.QueryLayerDlg",[e._Widget,e._Templated],{widgetsInTemplate:!0,templateString:a.cache("arcgisonline.sharing.dijit.dialog","templates/QueryLayerDlg.html",'\x3cdiv\x3e\r\n  \x3cdiv class\x3d"esriItemLinks dijitDialogPaneContentArea"\x3e\r\n    \x3cspan\x3e${i18n.header}\x3c/span\x3e\r\n    \x3cdiv dojoAttachPoint\x3d"_queryLayerChoiceDiv" style\x3d"display:none; margin-top:10px; margin-bottom:12px;"\x3e\r\n      \x3cdiv style\x3d"margin-bottom:15px;"\x3e\r\n        ${i18n.choiceMsg}\r\n      \x3c/div\x3e\r\n      \x3cinput dojoType\x3d"dijit.form.RadioButton" id\x3d"choice:item" name\x3d"choice" value\x3d"item" dojoAttachEvent\x3d"onClick:_onClickChoiceItem" checked\x3d"checked" /\x3e\r\n      \x3clabel\x3e\r\n        ${i18n.choiceItems}\r\n      \x3c/label\x3e\r\n\t\t\t\x3cspan\x3e\x26nbsp;\x26nbsp;\x26nbsp;\x3c/span\x3e\r\n      \x3cinput dojoType\x3d"dijit.form.RadioButton" id\x3d"choice:url" name\x3d"choice" value\x3d"url" dojoAttachEvent\x3d"onClick:_onClickChoiceUrl" /\x3e\r\n      \x3clabel\x3e\r\n        ${i18n.choiceUrl}\r\n      \x3c/label\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv dojoAttachPoint\x3d"_queryLayerUrlMsgDiv" style\x3d"display:none; margin-top:10px; margin-bottom:10px;"\x3e\r\n      \x3cdiv\x3e\r\n        ${i18n.urlMsg}\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv dojoAttachPoint\x3d"_queryLayerItemsDiv" style\x3d"display:none;"\x3e\r\n      \x3ctable\x3e\r\n        \x3ctbody\x3e\r\n          \x3ctr\x3e\r\n            \x3ctd style\x3d"vertical-align:top;"\x3e\r\n              \x3clabel style\x3d"margin-top:10px;"\x3e\r\n                ${i18n.itemLabel}\r\n              \x3c/label\x3e\r\n            \x3c/td\x3e\r\n            \x3ctd\x3e\r\n              \x3cdiv\x3e\r\n                \x3cselect class\x3d"queryLayerInput" dojoAttachPoint\x3d"_queryLayerItem" dojoAttachEvent\x3d"onChange:_onChangeQueryItem" dojotype\x3d"dijit.form.FilteringSelect" maxHeight\x3d"150" sortByLabel\x3d"false"\x3e\r\n                  \x3coption value\x3d"-1" selected\x3d"selected"\x3e${i18n.selectItem}\x3c/option\x3e\r\n                \x3c/select\x3e\r\n              \x3c/div\x3e\r\n              \x3cdiv dojoAttachPoint\x3d"_querLayerOrgItemsDiv" style\x3d"display:none;"\x3e\r\n                \x3cinput dojoAttachPoint\x3d"_querLayerOrgItems" dojotype\x3d"dijit.form.CheckBox" dojoAttachEvent\x3d"onClick:_onClickOrgItems" checked\x3d"false" value\x3d"off" type\x3d"checkbox" /\x3e\r\n                \x3clabel\x3e\r\n                  ${i18n.includeOrgItems}\r\n                \x3c/label\x3e\r\n              \x3c/div\x3e\r\n            \x3c/td\x3e\r\n          \x3c/tr\x3e\r\n          \x3ctr\x3e\r\n            \x3ctd\x3e\r\n              \x3clabel for\x3d"queryLayerUrl"\x3e\r\n                ${i18n.layerLabel}\r\n              \x3c/label\x3e\r\n            \x3c/td\x3e\r\n            \x3ctd\x3e\r\n              \x3cselect class\x3d"queryLayerInput" dojoAttachPoint\x3d"_queryItemLayer" dojoAttachEvent\x3d"onChange:_onChangeQueryServiceLayer" dojoType\x3d"dijit.form.FilteringSelect" maxHeight\x3d"150" sortByLabel\x3d"false" disabled\x3d"true"\x3e\r\n                \x3coption value\x3d"-1" selected\x3d"selected"\x3e${i18n.selectLayer}\x3c/option\x3e\r\n              \x3c/select\x3e\r\n            \x3c/td\x3e\r\n          \x3c/tr\x3e\r\n        \x3c/tbody\x3e\r\n      \x3c/table\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n  \x3cdiv dojoAttachPoint\x3d"_queryLayerUrlDiv" style\x3d"display:none;"\x3e\r\n    \x3ctable\x3e\r\n      \x3ctbody\x3e\r\n        \x3ctr\x3e\r\n          \x3ctd style\x3d"vertical-align:top;"\x3e\r\n            \x3clabel style\x3d"margin-top:10px;"\x3e\r\n              ${i18n.urlLabel}\r\n            \x3c/label\x3e\r\n          \x3c/td\x3e\r\n          \x3ctd\x3e\r\n            \x3cdiv class\x3d"queryLayerInput" dojoAttachPoint\x3d"_queryLayerUrl" dojotype\x3d"dijit.form.TextBox" trim\x3d"true" value\x3d"" dojoAttachEvent\x3d"onFocus:_onFocusLayerUrl, onBlur:_onBlurLayerUrl, onChange:_onChangeLayerUrl" style\x3d"margin-bottom:0;"\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv style\x3d"font-size:smaller;"\x3e\r\n              ${i18n.enterArcGISUrl}\r\n            \x3c/div\x3e\r\n          \x3c/td\x3e\r\n        \x3c/tr\x3e\r\n        \x3ctr\x3e\r\n          \x3ctd\x3e\r\n            \x3clabel for\x3d"queryLayerUrl"\x3e\r\n              ${i18n.layerLabel}\r\n            \x3c/label\x3e\r\n          \x3c/td\x3e\r\n          \x3ctd\x3e\r\n            \x3cselect class\x3d"queryLayerInput" dojoAttachPoint\x3d"_queryUrlLayer" dojoAttachEvent\x3d"onChange:_onChangeQueryServiceLayer" dojoType\x3d"dijit.form.FilteringSelect" maxHeight\x3d"150" sortByLabel\x3d"false" disabled\x3d"true"\x3e\r\n              \x3coption value\x3d"-1" selected\x3d"selected"\x3e${i18n.selectLayer}\x3c/option\x3e\r\n            \x3c/select\x3e\r\n          \x3c/td\x3e\r\n        \x3c/tr\x3e\r\n      \x3c/tbody\x3e\r\n    \x3c/table\x3e\r\n  \x3c/div\x3e\r\n  \x3cdiv class\x3d"submitButtons dijitDialogPaneActionBar esriFloatTrailing" style\x3d"margin-top:10px;"\x3e\r\n    \x3cspan dojoAttachPoint\x3d"spinnerNode" style\x3d"display:none"\x3e\x3c/span\x3e\r\n    \x3cdiv dojoType\x3d"dijit.form.Button" type\x3d"submit" class\x3d"primary" dojoAttachPoint\x3d"_submitButton" dojoAttachEvent\x3d"onClick:onOk" label\x3d"${i18n.title}"\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv dojoType\x3d"dijit.form.Button" type\x3d"button" class\x3d"cancel" dojoAttachEvent\x3d"onClick:onCancel" label\x3d"${i18n.cancel}"\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e\r\n'),
baseClass:"esriAGOQueryLayerForm",_lastChangedTime:(new Date).getTime(),lastQuery:"",postMixInProperties:function(){this.inherited(arguments);this.i18n=a.i18n.getLocalization("arcgisonline","arcgisonline").common;this.i18n=a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").errorWidget);this.i18n=a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").GeneralDlg);this.i18n=a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").QueryLayerDlg)},startup:function(){this.inherited(arguments);
this._loadConnections();this._util=arcgisonline.sharing.util},enable:function(a,c){this.inherited(arguments);esri.hide(this.spinnerNode)},disable:function(b,c){this.inherited(arguments);a.attr(this.spinnerNode,"innerHTML",c||this.i18n.pleaseWait);a.style(this.spinnerNode,"display","inline-block")},onCancel:function(){this.dialog&&this.dialog.hide()},onOk:function(b){b.preventDefault();b=this.layersInfo.layers[0];if(1<this.layersInfo.layers.length)for(var c=0;c<this.layersInfo.layers.length;c++)if(this.layersInfo.layers[c].id===
this.layerId){b=this.layersInfo.layers[c];break}b={id:this.sublayerId,layerUrl:this.layerUrl+"/"+this.layerId,_layerInfo:b,popupInfo:arcgisonline.map.popup.getDefaultPopupInfo(b,!1,null)};this.layerItemId&&(b.layerItemId=this.layerItemId);this.mapLayer.itemLayers=this.mapLayer.itemLayers||[];this.mapLayer.itemLayers.push(b);arcgisonline.map.popup.addPopupLayer(this.mapLayer,this.sublayerId);this.mapLayer.popupChanged=!0;a.publish("onLayerUpdate",["reopen"]);this.dialog.hide()},start:function(b,c){this.mapLayer=
b;this.sublayerId=c;this.user&&this._util.isHostedService(this.mapLayer.url)?(a.style(this._queryLayerUrlDiv,"display","none"),a.style(this._queryLayerUrlMsgDiv,"display","none"),a.style(this._queryLayerChoiceDiv,"display",10>a.isIE?"inline":""),a.style(this._queryLayerItemsDiv,"display",10>a.isIE?"inline":""),a.byId("choice:item").checked=!0,this.user.accountId?(this._querLayerOrgItems.set("checked",!1),a.style(this._querLayerOrgItemsDiv,"display",10>a.isIE?"inline":"")):a.style(this._querLayerOrgItemsDiv,
"display","none"),this._getAllFSItems()):(a.style(this._queryLayerChoiceDiv,"display","none"),a.style(this._queryLayerItemsDiv,"display","none"),a.style(this._queryLayerUrlMsgDiv,"display",10>a.isIE?"inline":""),a.style(this._queryLayerUrlDiv,"display",10>a.isIE?"inline":""))},_loadConnections:function(){this.user=arcgisonline.sharing.util.getUser();this._dlgConnect=a.connect(this.dialog,"hide",a.hitch(this,function(){this.destroy()}));this._submitButton.set("disabled",!0)},_getAllFSItems:function(){this.disable(null,
this.i18n.pleaseWaitForFSItems);this.lastQuery='type:"Feature Service"';this.user?this.user.accountId&&this._querLayerOrgItems.get("checked")?this.lastQuery+=" orgid:"+this.user.accountId:this.lastQuery+=" owner:"+this.user.email:this._errorHandleFSItems();arcgisonline.sharing.geow.Search.searchByQuery(this.lastQuery,100,1,"title",a.hitch(this,"_handleFSItems"),a.hitch(this,"_errorHandleFSItems"))},_errorHandleFSItems:function(){this.enable();arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.errorDlgTitle,
message:this.i18n.defaultError})},_handleFSItems:function(b){this.enable();if(!b.results||0==b.results.length){var c=[{name:this.i18n.selectItem,id:-1}];this.fsItemsStore=new a.data.ItemFileWriteStore({data:{label:"name",identifier:"id",items:c}});this._queryLayerItem.set("store",this.fsItemsStore);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.errorDlgTitle,message:this.i18n.error.noFSItems})}else 1===b.start?(c=a.map(b.results,a.hitch(this,function(a,
b){return{name:a.title||this.i18n.noTitle,id:b+1,url:a.url,itemId:a.id}})),c.splice(0,0,{name:this.i18n.selectItem,id:-1}),this.fsItemsStore=new a.data.ItemFileWriteStore({data:{label:"name",identifier:"id",items:c}})):a.forEach(b.results,a.hitch(this,function(a,c){this.fsItemsStore.newItem({name:a.title||this.i18n.noTitle,id:c+b.start+1,url:a.url,itemId:a.id})})),this._queryLayerItem.set("store",this.fsItemsStore),-1<b.nextStart&&arcgisonline.sharing.geow.Search.searchByQuery(this.lastQuery,100,
b.nextStart,"title",a.hitch(this,"_handleFSItems"),a.hitch(this,"_errorHandleFSItems"))},_getAllSublayers:function(b,c,d){this.layersStore=new a.data.ItemFileWriteStore({data:{label:"name",identifier:"id",items:[{name:this.i18n.selectLayer,id:-1}]}});"hosted"===d?(this._queryItemLayer.set("store",this.layersStore),this._queryItemLayer.set("disabled",!0)):(this._queryUrlLayer.set("store",this.layersStore),this._queryUrlLayer.set("disabled",!0));this.disable(null,this.i18n.pleaseWaitForLayers);arcgisonline.map.layer.getServiceInfo(b,
null,a.hitch(this,"_handleServiceInfo",d),a.hitch(this,function(b,c){setTimeout(a.hitch(this,function(){this.enable()}),0);this._queryLayerUrl.set("value","");this._queryItemLayer.set("disabled",!0);this._queryUrlLayer.set("disabled",!0);var f;f="hosted"===d&&this.user?a.string.substitute(this.i18n.error.itemNotAvailable,{title:c}):a.string.substitute(this.i18n.error.serviceNotAvailable,{url:b});arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.errorDlgTitle,
message:f})},b,c))},_handleServiceInfo:function(b,c,d){this.enable();c.layers?c.capabilities&&-1===c.capabilities.toLowerCase().indexOf("query")?(b=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),b.show({title:this.i18n.errorDlgTitle,message:a.string.substitute(this.i18n.error.cantUseService,{url:this.layerUrl})})):(this.serviceInfo=c,d=a.map(c.layers,a.hitch(this,function(a,b){return{name:a.name,id:b+1,layerId:a.id}})),d=d.sort(function(a,b){var c=a.name.toLowerCase(),
d=b.name.toLowerCase();return c==d?0:c<d?-1:1}),1<c.layers.length&&d.splice(0,0,{name:this.i18n.selectLayer,id:-1}),this.layersStore=new a.data.ItemFileWriteStore({data:{label:"name",identifier:"id",items:d}}),"hosted"===b?(this._queryItemLayer.set("disabled",!1),this._queryItemLayer.set("store",this.layersStore),this._queryItemLayer.set("value",1===c.layers.length?1:-1)):(this._queryUrlLayer.set("disabled",!1),this._queryUrlLayer.set("store",this.layersStore),this._queryUrlLayer.set("value",1===
c.layers.length?1:-1))):"Feature Layer"===c.type?(this.serviceInfo=null,this.layerUrl=d.substring(0,d.lastIndexOf("/")),this.layerId=parseInt(d.substring(d.lastIndexOf("/")+1)),d=[{name:c.name,id:1,layerId:this.layerId}],this.layersStore=new a.data.ItemFileWriteStore({data:{label:"name",identifier:"id",items:d}}),"hosted"===b?(this._queryItemLayer.set("disabled",!1),this._queryItemLayer.set("store",this.layersStore),this._queryItemLayer.set("value",1)):(this._queryUrlLayer.set("disabled",!1),this._queryUrlLayer.set("store",
this.layersStore),this._queryUrlLayer.set("value",1)),c.capabilities&&-1===c.capabilities.toLowerCase().indexOf("query")?this._handleLayerInfo({layers:[]}):this._handleLayerInfo({layers:[c]})):(b=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),b.show({title:this.i18n.errorDlgTitle,message:a.string.substitute(this.i18n.error.invalidUrl,{url:d})}))},_handleLayerInfo:function(b){this.enable();b&&b.layers&&b.layers.length?(this.layersInfo=b,this._submitButton.set("disabled",
!1)):arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.errorDlgTitle,message:a.string.substitute(this.i18n.error.cantUseLayer,{title:this.layerName?this.layerName:this.layerUrl+"/"+this.layerId})})},_onChangeQueryItem:function(b){this._submitButton.set("disabled",!0);-1===b?(this.layersStore=new a.data.ItemFileWriteStore({data:{label:"name",identifier:"id",items:[{name:this.i18n.selectLayer,id:-1}]}}),this._queryItemLayer.set("store",this.layersStore),
this._queryItemLayer.set("disabled",!0)):this.fsItemsStore.fetchItemByIdentity({identity:b,onItem:a.hitch(this,function(a){this.layerUrl=a.url.toString();this.layerItemId=a.itemId.toString();this.layersInfo=null;this._getAllSublayers(this.layerUrl,a.name.toString(),"hosted")})})},_onChangeQueryServiceLayer:function(b){this._submitButton.set("disabled",!0);-1!==b&&this.layersStore.fetchItemByIdentity({identity:b,onItem:a.hitch(this,function(b){this.layerId=b.layerId[0];this.layerName=b.name[0];this.disable(null,
this.i18n.pleaseWaitForLayerInfo);this.layersInfo?this._handleLayerInfo(this.layersInfo):arcgisonline.map.main.getLayerInfoForQueryFromUrl(this.layerUrl,this.serviceInfo,this.layerId,a.hitch(this,"_handleLayerInfo"))})})},_onChangeLayerUrl:function(){var a=this._queryLayerUrl.get("value");a.length&&(!a.startsWith("http://")&&!a.startsWith("https://")&&(a="http://"+a,this._queryLayerUrl.set("value",a)),this.layerUrl=a,this.layersInfo=null,this._queryUrlLayer.set("disabled",!0),this._getAllSublayers(this.layerUrl,
null,"url"))},_onClickChoiceItem:function(){a.style(this._queryLayerUrlDiv,"display","none");a.style(this._queryLayerItemsDiv,"display",10>a.isIE?"inline":"")},_onClickChoiceUrl:function(){a.style(this._queryLayerItemsDiv,"display","none");a.style(this._queryLayerUrlDiv,"display",10>a.isIE?"inline":"")},_onClickOrgItems:function(){this._getAllFSItems()},_onBlurLayerUrl:function(){},_onFocusLayerUrl:function(){this._queryLayerUrl.get("value")===this.i18n.enterArcGISUrl&&this._queryLayerUrl.set("value",
"")}})});