// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define(["../../core/declare","dojo/_base/lang","dojo/Deferred","../../core/Accessor","../../core/Promise"],function(k,l,h,m,n){return k([m,n],{constructor:function(){this._featuresByTime={};this._lastEndTimeCheck=null;this._trackIds={};this._doTrackPurge=this._doTimePurge=!1;this._watchHandlers=[]},normalizeCtorArgs:function(a){a=a||{};a.controller||(a={controller:a});return a},getDefaults:function(){return l.mixin(this.inherited(arguments),{idField:"id",parentField:"parent"})},initialize:function(){var a,
b=this;if(this.controller)try{this.graphicsCollection=this.controller.graphicsCollection;this.layer=this.controller.layer;this.layer.trackIdField&&(this.trackIdField=this.layer.trackIdField,this._doTrackPurge=!0);this.maximumTrackPoints=this.layer.maximumTrackPoints;b._watchHandlers.push(this.layer.watch("maximumTrackPoints",function(a){var c=b.maximumTrackPoints;b.maximumTrackPoints=a;b._doTrackPurge&&(0===c||0!==a&&a<c)&&b._purgeByTracks()}));this.maxFeatureAge=0;this.get("layer.purgeOptions.age")&&
(this.maxFeatureAge=Math.ceil(6E4*this.layer.purgeOptions.age));if(this.get("layer.timeInfo.endTimeField")||this.maxFeatureAge)this._doTimePurge=!0,this._lastEndTimeCheck=1E3*Math.ceil(Date.now()/1E3);this.displayCount=this.layer.purgeOptions&&this.layer.purgeOptions.displayCount;b._watchHandlers.push(this.layer.watch("purgeOptions",function(a){var c=b.displayCount;a.hasOwnProperty("displayCount")&&a.displayCount!==c&&(b.displayCount=a.displayCount,b.displayCount<c&&b._purgeByDisplayCount());a.hasOwnProperty("age")&&
(b.maxFeatureAge=a.age)}));b._watchHandlers.push(this.graphicsCollection.on("change",function(a){a.added.length&&b._addItems(a.added)}))}catch(c){a=new h,this.addResolvingPromise(a.promise),a.reject(c)}else a=new h,this.addResolvingPromise(a.promise),a.reject(Error("Controller is not optional argument for StreamPurger constructor"))},destroy:function(){for(var a=0,b=this._watchHandlers.length;a<b;a++)this._watchHandlers[a].remove()},purge:function(a){this._doTimePurge&&this._purgeByTime();this._doTrackPurge&&
this._purgeByTracks(a);this._purgeByDisplayCount()},_addItems:function(a){var b,c,d,e,f=this._featuresByTime,g=[];b=0;for(c=a.length;b<c;b++)if(d=a[b],this._doTrackPurge&&(e=d.attributes[this.trackIdField],d[this.parentField]=e,this._trackIds.hasOwnProperty(e)?this._trackIds[e]+=1:this._trackIds[e]=1,-1===g.indexOf(e)&&g.push(e)),this._doTimePurge&&(e=this._getExpireTimeOfItem(d)))e=1E3*Math.ceil(e/1E3),f[e]?f[e].push(d.id):f[e]=[d.id];this.purge(g)},_getExpireTimeOfItem:function(a){var b=this.layer.timeInfo||
{},c;c=b.endTimeField&&a.attributes[b.endTimeField];!c&&this.maxFeatureAge&&(c=b.startTimeField&&a.attributes[b.startTimeField]?a.attributes[b.startTimeField]+this.maxFeatureAge:Date.now()+this.maxFeatureAge);return c},_getIndexOfItem:function(a){var b,c=this.idField;b="object"===typeof a?a[c]:a;return this.graphicsCollection.findIndex(function(a){return a[c]===b},this)},_getItemsByParent:function(a){return this.graphicsCollection.filter(function(b){return b[this.parentField]===a},this)},_processRemovedTrackFeatures:function(a){if(this._doTrackPurge&&
a&&a.length)for(var b,c=0,d=a.length;c<d;c++)b=a[c],this._trackIds[b]-=1,0===this._trackIds[b]&&delete this._trackIds[b]},_purgeByDisplayCount:function(){var a,b,c=[];a=this.graphicsCollection.length-this.displayCount;if(0<a){for(var d=0;d<a;d++)this._doTrackPurge&&(b=this.graphicsCollection.getItemAt(0)[this.parentField],c.push(b)),this.graphicsCollection.removeItemAt(0);this._processRemovedTrackFeatures(c)}},_purgeByTime:function(){if(this._featuresByTime&&0!==Object.getOwnPropertyNames(this._featuresByTime).length){var a,
b,c,d=[];if((this.layer.timeInfo||{}).endTimeField||this.maxFeatureAge){a=1E3*Math.floor(this._lastEndTimeCheck/1E3);this._lastEndTimeCheck=b=1E3*Math.ceil(Date.now()/1E3);if(a&&a!==b)for(c=this._featuresByTime;a<=b;a+=1E3)c[a]&&(d=d.concat(c[a]),delete c[a]);b=0;for(c=d.length;b<c;b++)a=this._getIndexOfItem(d[b]),-1!==a&&this.graphicsCollection.removeItemAt(a)}}},_purgeByTracks:function(a){function b(a){var b,c;b=e._getItemsByParent(a);c=b.length-d;if(0<c){for(var f=0;f<c;f++)e._removeItemFromCollection(b.getItemAt(f));
e._trackIds[a]=d}}a=a||[];if(this.maximumTrackPoints){var c,d=this.maximumTrackPoints,e=this;if(a.length){c=0;for(var f=a.length;c<f;c++)b(a[c])}else for(c in a=this._trackIds,a)a.hasOwnProperty(c)&&b(c)}},_removeItemFromCollection:function(a){var b=a[this.idField],c;c=this._getIndexOfItem(a);-1!==c&&this.graphicsCollection.removeItemAt(c);return{index:c,id:b,parent:a[this.parentField]}}})});