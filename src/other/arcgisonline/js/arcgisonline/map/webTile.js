// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/webTile",["dijit","dojo","dojox","dojo/require!arcgisonline/map/main"],function(p,c,q){c.provide("arcgisonline.map.webTile");c.require("arcgisonline.map.main");arcgisonline.map.webTile={addWebTiledLayer:function(a,b,e,g,d){-1==a.indexOf("http")&&(a="http://"+a);if(!b){b=a.indexOf("//")+2;b=a.substring(b,a.indexOf("/",b));0==b.length&&(b="WebTiledLayer");var f=Math.floor(10001*Math.random());b={id:"WebTiled_"+f,visibility:!0,opacity:1,title:b,_addedVia:"url"}}b.id||(f=Math.floor(10001*
Math.random()),b=c.mixin(b,{id:"WebTiled_"+f,visibility:!0,opacity:1,_addedVia:"url"}));a={layer:null,id:b.id,itemId:b.itemId,url:a,type:b.type?b.type:"user",subType:"WebTiledLayer",title:b.title,defaultVisibility:b.visibility,defaultOpacity:b.opacity,showLegend:!0,visibility:!0,minScale:b.minScale,maxScale:b.maxScale,snippet:"",identify:!1,_addedVia:b._addedVia,copyright:b.copyright,fullExtent:b.fullExtent instanceof esri.geometry.Extent?b.fullExtent:b.fullExtent?esri.geometry.Extent(b.fullExtent):
null,subDomains:b.subDomains,tileInfo:b.tileInfo?esri.layers.TileInfo(b.tileInfo):null,tileServers:b.tileServers,refreshInterval:b.refreshInterval};a.fullExtent||(a.fullExtent=new esri.geometry.Extent(-2.0037508342787E7,-2.003750834278E7,2.003750834278E7,2.0037508342787E7,new esri.SpatialReference({wkid:102100})));b.wmtsInfo&&(a.wmtsInfo=b.wmtsInfo);d||(d=arcgisonline.map.layer.getLayerPosition(a));arcgisonline.map.main.mapLayers.splice(d.list,0,a);arcgisonline.map.webTile.createWebTiledLayer(a,d.map,
e,g)},createWebTiledLayer:function(a,b,e,g){var d=function(a){"labels"===a.type&&a.layer.attr("data-reference",!0);c.publish("layerAddedNoRemove",[a.id]);c.publish("onLayerUpdate",[""]);esri.isDefined(a.layer.tileInfo.dpi)||(a.layer.tileInfo.dpi=96);esri.isDefined(a.minScale)&&esri.isDefined(a.maxScale)&&(a.layer.setScaleRange(a.minScale,a.maxScale),a.scaleChanged=!0,delete a.minScale,delete a.maxScale);esri.isDefined(a.defaultOpacity)&&a.layer.setOpacity(a.defaultOpacity);var d=arcgisonline.sharing.util.urlToObject(document.URL);
d.query=d.query||{};!arcgisonline.map.main.mapInitialized&&d.query.tile&&arcgisonline.map.main.initMap();!arcgisonline.map.main.isMapFullyLoaded&&!d.query.layers&&!d.query.services?(arcgisonline.map.main.map.addLayer(a.layer,b),c.publish("layerAdded",[a.id]),e&&e(a.layer)):a.layer.fullExtent?arcgisonline.map.main.getIntersectionPercent(a.layer.fullExtent,arcgisonline.map.main.map.extent).then(c.hitch(this,function(d){5>d?(arcgisonline.map.main.map.addLayer(a.layer,b),arcgisonline.map.main.map.setExtent(a.layer.fullExtent,
!1)):arcgisonline.map.main.map.addLayer(a.layer,b);c.publish("layerAdded",[a.id]);e&&e(a.layer)})):(arcgisonline.map.main.map.addLayer(a.layer,b),c.publish("layerAdded",[a.id]),e&&e(a.layer))};a.layer?d(a):(a.layer=new esri.layers.WebTiledLayer(a.url,{id:a.id,visible:a.defaultVisibility,copyright:a.copyright,fullExtent:a.fullExtent,initialExtent:a.fullExtent,subDomains:a.subDomains,tileInfo:a.tileInfo,refreshInterval:a.refreshInterval}),a.layer.loaded?d(a):c.connect(a.layer,"onLoad",c.hitch(this,
d,a)),a.onError=c.connect(a.layer,"onError",c.hitch(this,function(a,b){console.log(c.json.stringify(b)+" "+b.message);if(!a.layer||!a.layer.loaded){g&&g();var d=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),e;-1<b.message.indexOf("Unable to load tile")?(e=c.string.substitute(esri.i18nBundle.viewer.webTile.tileMissing,{url:a.url}),d.showWide({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:e})):(e=c.string.substitute(esri.i18nBundle.viewer.webTile.error,{url:a.url}),
d.showWide({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:e}),arcgisonline.map.layer.removeLayer(a),c.publish("layerAddFailed",[a.id]));arcgisonline.map.main.mapInitialized||arcgisonline.map.main.initMap()}},a)))},addWebTiledUrlAsBasemap:function(a,b,e,g){-1==a.indexOf("http")&&(a="http://"+a);if(!b){b=a.indexOf("//")+2;b=a.substring(b,a.indexOf("/",b));0==b.length&&(b="WebTiledLayer");var d=Math.floor(10001*Math.random());b={id:"WebTiled_"+d,visibility:!0,opacity:1,title:b,_addedVia:"url"}}b.id||
(d=Math.floor(10001*Math.random()),b=c.mixin(b,{id:"WebTiled_"+d,visibility:!0,opacity:1,_addedVia:"url"}));a={layer:null,id:b.id,itemId:b.itemId,url:a,type:"base",subType:"WebTiledLayer",title:b.title,defaultVisibility:b.visibility,defaultOpacity:1,showLegend:!0,visibility:!0,minScale:b.minScale,maxScale:b.maxScale,fullExtent:b.fullExtent,snippet:"",identify:!1,_addedVia:b._addedVia,copyright:b.copyright,subDomains:b.subDomains,tileInfo:b.tileInfo?esri.layers.TileInfo(b.tileInfo):null,tileServers:b.tileServers};
b.wmtsInfo&&(a.wmtsInfo=b.wmtsInfo);arcgisonline.map.webTile.addWebTiledAsBaseLayer(null,a,e,g,!0)},addWebTiledAsBaseLayer:function(a,b,e,g,d){arcgisonline.map.main.isUserBaseService=!0;var f=function(){c.unsubscribe(k);c.unsubscribe(l);c.unsubscribe(m);arcgisonline.map.main.currentBaseService=b.id;arcgisonline.map.main.defaultService=b;if(null==arcgisonline.map.main.mapLods){arcgisonline.map.main.mapLods=b.layer.tileInfo.lods;arcgisonline.map.main.baseTilingSchemeScales="|";for(h=0;h<b.layer.tileInfo.lods.length;h++)arcgisonline.map.main.baseTilingSchemeScales+=
b.layer.tileInfo.lods[h].scale+"|"}arcgisonline.map.main.recreateOverviewMap();e&&e(b)};b?(b.type="base",b.fullExtent||(b.fullExtent=new esri.geometry.Extent(-2.0037508342787E7,-2.003750834278E7,2.003750834278E7,2.0037508342787E7,new esri.SpatialReference({wkid:102100})))):(b={layer:null,id:a.id,url:a.templateUrl,type:"base",subType:"WebTiledLayer",title:a.title,defaultVisibility:a.visibility,defaultOpacity:a.opacity,refreshInterval:a.refreshInterval,snippet:"",identify:!1,copyright:a.copyright,subDomains:a.subDomains,
tileInfo:a.tileInfo?new esri.layers.TileInfo(a.tileInfo):null,tileServers:a.tileServers},esri.isDefined(a.minScale)&&esri.isDefined(a.maxScale)&&(b.minScale=a.minScale,b.maxScale=a.maxScale),b.fullExtent=a.fullExtent?new esri.geometry.Extent(a.fullExtent):new esri.geometry.Extent(-2.0037508342787E7,-2.003750834278E7,2.003750834278E7,2.0037508342787E7,new esri.SpatialReference({wkid:102100})),arcgisonline.map.main.mapLayers.push(b));var k=c.subscribe("layerAdded",c.hitch(this,f)),l=c.subscribe("layerAddedNoRemove",
c.hitch(this,f)),m=c.subscribe("layerAddFailed",c.hitch(this,function(a,d){c.unsubscribe(k);c.unsubscribe(l);c.unsubscribe(m);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:c.string.substitute(esri.i18nBundle.viewer.webTile.error,{url:b.title})});arcgisonline.map.layer.loadDefaultMap();g&&g()}));if(d){if(arcgisonline.map.main.defaultExtent=new esri.geometry.Extent(b.fullExtent.toJson()),a=arcgisonline.map.main.defaultExtent.spatialReference,
d=arcgisonline.map.main.map.extent,f=b.tileInfo,f||(f=(new esri.layers.OpenStreetMapLayer).tileInfo),arcgisonline.map.save_open.checkIfOpLayersFitToNewBasemap(a,{tileInfo:f})){var n=arcgisonline.map.main.sameSpatialReference(d.spatialReference,a);if(arcgisonline.map.layer.sameTilingSchemeAsBasemap({tileInfo:f})&&n){f=arcgisonline.map.main.updateTilingScheme(f,arcgisonline.map.main.mapLayers[0].layer.tileInfo.dpi);b.tileInfo&&(b.tileInfo=f);arcgisonline.map.layer.removeLabelsLayers();a=[];for(var h=
0;h<arcgisonline.map.main.mapLayers.length;h++)d=arcgisonline.map.main.mapLayers[h],"base"==d.type?(arcgisonline.map.main.mapLayers[h]=null,d.layer&&arcgisonline.map.main.map.removeLayer(d.layer)):a[a.length]=d;arcgisonline.map.main.mapLayers=a;for(h=arcgisonline.map.main.mapLayers.length;0<h;h--)arcgisonline.map.main.mapLayers[h]=arcgisonline.map.main.mapLayers[h-1];arcgisonline.map.main.mapLayers[0]=b;arcgisonline.map.main.currentBaseService=b.id;arcgisonline.map.main.defaultService=b;arcgisonline.map.webTile.createWebTiledLayer(b,
0)}else arcgisonline.map.main.defaultExtent=new esri.geometry.Extent(b.fullExtent.toJson()),arcgisonline.map.main.mapLods=null,arcgisonline.map.main.baseTilingSchemeScales="",arcgisonline.map.save_open.basemapWebMap=null,arcgisonline.map.save_open.prepRecreateMap(b,a,d);arcgisonline.map.main.markMapAsChanged("addWebTiledAsBaseLayer")}}else arcgisonline.map.main.defaultExtent=new esri.geometry.Extent(b.fullExtent.toJson()),arcgisonline.map.main.mapLods=null,arcgisonline.map.main.baseTilingSchemeScales=
"",arcgisonline.map.main.createMapObject(null,arcgisonline.map.main.defaultExtent),b.layer?arcgisonline.map.main.map.addLayer(b.layer,0):(arcgisonline.map.main.currentBaseService=b.id,arcgisonline.map.main.defaultService=b,arcgisonline.map.webTile.createWebTiledLayer(b,0)),c.publish("layerAddedNoRemove",[b.id]),c.publish("onLayerUpdate",[""]),arcgisonline.map.main.markMapAsChanged("addWebTiledAsBaseLayer")},checkIfFitsToNewService:function(a,b,c){if(b.wkid&&c){var g=a.tileInfo;g||(g=(new esri.layers.OpenStreetMapLayer).tileInfo);
a=arcgisonline.map.main.sameSpatialReference(a.layer.spatialReference,b);c=arcgisonline.map.main.sameTilingScheme(g,c);return!a||!c?!1:!0}return!1},buildConfig:function(a){var b={templateUrl:a.url,id:a.id,type:"WebTiledLayer",layerType:"WebTiledLayer",title:a.title};"labels"===a.type&&(b.isReference=!0);a.copyright&&(b.copyright=a.copyright);a.fullExtent&&(b.fullExtent=a.fullExtent.toJson());a.tileInfo&&(b.tileInfo=a.tileInfo.toJson());a.subDomains&&(b.subDomains=a.subDomains);a.wmtsInfo&&(b.wmtsInfo=
a.wmtsInfo);b.visibility=a.layer.visible;b.opacity=esri.isDefined(a.layer.opacity)?a.layer.opacity:1;if(a.scaleChanged&&(a.layer.minScale||a.layer.maxScale))b.minScale=a.layer.minScale?a.layer.minScale:0,b.maxScale=a.layer.maxScale&&1!==a.layer.maxScale?a.layer.maxScale:0;a.layer.refreshInterval&&(b.refreshInterval=a.layer.refreshInterval);return b}}});