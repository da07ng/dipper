// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/dijit/PopupBuilder",["dijit","dojo","dojox","dojo/require!dijit/_Widget,dijit/_Templated,arcgisonline/sharing/dijit/LayerAttributesGrid,dijit/form/Select,dijit/form/MultiSelect,dijit/form/CheckBox,dojo/dnd/Source,arcgisonline/map/dijit/DropDownButton,dojox/data/AndOrWriteStore,arcgisonline/map/dijit/AddFieldPlugin,arcgisonline/sharing/dijit/LinkDialog,dijit/Menu,dijit/MenuItem,dijit/Editor,dijit/_editor/plugins/FontChoice,dijit/_editor/plugins/TextColor,dijit/_editor/plugins/ViewSource,dijit/_editor/plugins/EnterKeyHandling,dojo/Deferred,dojo/promise/all,dojo/when,dojo/store/Observable,dojo/store/Memory,dojo/store/DataStore,dgrid/Grid,dgrid/OnDemandGrid,dgrid/extensions/DijitRegistry"],
function(h,b,r){b.provide("arcgisonline.map.dijit.PopupBuilder");b.require("dijit._Widget");b.require("dijit._Templated");b.require("arcgisonline.sharing.dijit.LayerAttributesGrid");b.require("dijit.form.Select");b.require("dijit.form.MultiSelect");b.require("dijit.form.CheckBox");b.require("dojo.dnd.Source");b.require("arcgisonline.map.dijit.DropDownButton");b.require("dojox.data.AndOrWriteStore");b.require("arcgisonline.map.dijit.AddFieldPlugin");b.require("arcgisonline.sharing.dijit.LinkDialog");
b.require("dijit.Menu");b.require("dijit.MenuItem");b.require("dijit.Editor");b.require("dijit._editor.plugins.FontChoice");b.require("dijit._editor.plugins.TextColor");b.require("dijit._editor.plugins.ViewSource");b.require("dijit._editor.plugins.EnterKeyHandling");b.require("dojo.Deferred");b.require("dojo.promise.all");b.require("dojo.when");b.require("dojo.store.Observable");b.require("dojo.store.Memory");b.require("dojo.store.DataStore");b.require("dgrid.Grid");b.require("dgrid.OnDemandGrid");
b.require("dgrid.extensions.DijitRegistry");b.declare("arcgisonline.map.dijit.PopupBuilder",[h._Widget,h._Templated],{widgetsInTemplate:!0,templateString:'\x3cdiv dojoType\x3d"dijit.layout.BorderContainer" region\x3d"top"\x3e\r\n\r\n    \x3cdiv id\x3d"popupBuilderContentHeader" class\x3d"panel panel_left" dojoType\x3d"dijit.layout.ContentPane" region\x3d"top"\x3e\r\n      \x3cdiv class\x3d"esriFloatTrailing" style\x3d"display:inline;"\x3e\r\n        \x3ca dojoAttachPoint\x3d"_closeBtn" title\x3d"${i18n.close}" class\x3d"panel panel_close panel_collapse"\x3e\x3c/a\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv id\x3d"popupBuilderContentTitle" class\x3d"esriFloatLeading panel_title"\x3e\r\n          ${i18n.popupBuilderTitle}\r\n      \x3c/div\x3e\r\n      \x3cdiv dojoAttachPoint\x3d"_popupBuilderLayerName" class\x3d"esriFloatLeading panel_title" style\x3d"clear:both;"\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv style\x3d"clear:both; border-bottom: #aeaeae thin solid; height:1px;"\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv id\x3d"popupBuilderContentPane" dojoType\x3d"dijit.layout.ContentPane" region\x3d"center" style\x3d"overflow-x:hidden;overflow-y:auto;"\x3e\r\n        \x3cdiv\x3e\r\n            \x3cp style\x3d"margin:4px 0px 10px 0px;"\x3e\r\n                ${i18n.titleMessage}\r\n            \x3c/p\x3e\r\n            \x3clabel for\x3d"_title" class\x3d"title"\x3e\r\n                ${i18n.title}\r\n            \x3c/label\x3e\r\n            \x3ctable style\x3d"width:100%;"\x3e\r\n                \x3ctr\x3e\r\n                    \x3ctd style\x3d"width:165px;"\x3e\r\n                    \x3cdiv dojoAttachPoint\x3d"_title" name\x3d"title" dojotype\x3d"dijit.form.Textarea" style\x3d"padding:2px;"/\x3e\r\n                    \x3c/td\x3e\r\n                    \x3ctd\x3e\r\n                    \x3cbutton dojoAttachPoint\x3d"_titleButton" class\x3d"calcite transparent tiny"\x3e\x3c/button\x3e\r\n                    \x3c/td\x3e\r\n                \x3c/tr\x3e\r\n            \x3c/table\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv style\x3d"margin-bottom:10px;"\x3e\r\n            \x3cp style\x3d"margin-bottom:3px;" class\x3d"title"\x3e\r\n                ${i18n.content}\r\n            \x3c/p\x3e\r\n            \x3clabel dojoAttachPoint\x3d"_descriptionTypeLabel" for\x3d"popupbuilderContentSelect"\x3e\r\n                ${i18n.displayLabel}\r\n            \x3c/label\x3e\r\n            \x3cselect dojoAttachPoint\x3d"_descriptionType" name\x3d"popupbuilderContentSelect" dojoAttachEvent\x3d"onChange:_onChangePopupContent" dojoType\x3d"dijit.form.Select" style\x3d"margin:10px 0px 10px 0px;"\x3e\r\n                \x3coption value\x3d"_fieldAttributes" selected\x3d"selected"\x3e${i18n.fieldAttributes}\x3c/option\x3e\r\n                \x3coption value\x3d"_oneField" \x3e${i18n.oneField}\x3c/option\x3e\r\n                \x3coption value\x3d"_customField"\x3e${i18n.customField}\x3c/option\x3e\r\n                \x3coption value\x3d"_none"\x3e${i18n.noField}\x3c/option\x3e\r\n            \x3c/select\x3e\r\n            \x3cbr /\x3e\r\n            \x3cdiv class\x3d"_popContentPane" dojoAttachPoint\x3d"_fieldAttributes" style\x3d"margin-bottom:0.7em;"\x3e\r\n                \x3cdiv style\x3d"margin-bottom:0.7em;"\x3e\r\n                    ${i18n.fieldDisplay}\r\n                \x3c/div\x3e\r\n                \x3ctable\x3e\r\n                    \x3ctr\x3e\r\n                        \x3ctd\x3e\r\n                        \x3cselect dojoType\x3d"dijit.form.MultiSelect" style\x3d"width: 180px;" dojoAttachPoint\x3d"_attributesSelect"\x3e\r\n                        \x3c/select\x3e\x3c/td\x3e\r\n                        \x3ctd width\x3d"18"\x3e\r\n                        \x3cbutton  class\x3d"button calcite transparent tiny" dojoAttachPoint\x3d"_attributesSelectUp" dojoType\x3d"dijit.form.Button" iconClass\x3d"popupButton popupUpIcon" showLabel\x3d"false" type\x3d"button"\x3e${i18n.moveUp}\x3c/button\x3e\r\n                        \x3cbutton  class\x3d"button calcite transparent tiny" dojoAttachPoint\x3d"_attributesSelectDown" dojoType\x3d"dijit.form.Button" iconClass\x3d"popupButton popupDownIcon" showLabel\x3d"false" type\x3d"button"\x3e${i18n.moveDown}\x3c/button\x3e\r\n                        \x3c/td\x3e\r\n                    \x3c/tr\x3e\r\n                \x3c/table\x3e\r\n                \x3c!--\x3cbutton  dojoAttachPoint\x3d"_changeFieldsBtn" dojoAttachEvent\x3d"onClick:_onShowFieldsDlg" dojoType\x3d"dijit.form.Button" type\x3d"button"\x3e--\x3e\r\n                    \x3c!--${i18n.configureFields}--\x3e\r\n                \x3c!--\x3c/button\x3e--\x3e\r\n                \x3c!--\x3cp style\x3d"margin:0px;"\x3e\x3ca href\x3d\'\' dojoAttachEvent\x3d"onclick:_onShowFieldsDlg" style\x3d"color:blue;margin:0.2em;"\x3e${i18n.configureFields}\x3c/a\x3e\x3c/p\x3e--\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv class\x3d"_popContentPane" dojoAttachPoint\x3d"_oneField" style\x3d"margin-bottom:0.7em;display:none;"\x3e\r\n                \x3c!--\x3cdiv style\x3d"margin-bottom:5px;"\x3e--\x3e\r\n                    \x3c!--${i18n.selectDescriptionField}--\x3e\r\n                \x3c!--\x3c/div\x3e--\x3e\r\n                \x3cselect dojoAttachPoint\x3d"_singleFieldSelect" dojoType\x3d"dijit.form.Select" minSize\x3d\'150\'  maxSize\x3d\'180\'  maxHeight\x3d\'150\' style\x3d"width: 200px;" size\x3d"4"\x3e\r\n                \x3c/select\x3e\r\n                \x3cbr /\x3e\r\n                \x3c!--\x3ca class\x3d"_requireNumericDateFld" href\x3d\'\' dojoAttachEvent\x3d"onclick:_onShowFieldsDlg" style\x3d"color:blue;"\x3e${i18n.configureFields}\x3c/a\x3e--\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv class\x3d"_popContentPane" dojoAttachPoint\x3d"_customField" style\x3d"margin-bottom:0.7em;display:none;"\x3e\r\n                \x3cbutton class\x3d"calcite green small" style\x3d"margin-top:-5px;" dojoType\x3d"dijit.form.Button" dojoAttachPoint\x3d"_customFieldBtn" type\x3d"button"\x3e\r\n                    ${i18n.configure}\r\n                \x3c/button\x3e\r\n                \x3cbr /\x3e\r\n                \x3c!--\x3ca class\x3d"_requireNumericDateFld" href\x3d\'\' dojoAttachEvent\x3d"onclick:_onShowFieldsDlg" style\x3d"margin:0.2em;color:blue;"\x3e${i18n.configureFields}\x3c/a\x3e--\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv class\x3d"_popContentPane" style\x3d"margin-bottom:0.7em;display:none;" dojoAttachPoint\x3d"_none"\x3e\r\n                \x3cspan\x3e\r\n                  ${i18n.noAttributeInfo}\r\n                \x3c/span\x3e\r\n                \x3cbr /\x3e\r\n                \x3c!--\x3ca class\x3d"_requireNumericDateFld" href\x3d\'\' dojoAttachEvent\x3d"onclick:_onShowFieldsDlg" style\x3d"margin:0.2em;color:blue;"\x3e${i18n.configureFields}\x3c/a\x3e--\x3e\r\n            \x3c/div\x3e\r\n            \x3ca href\x3d\'\' dojoAttachEvent\x3d"onclick:_onShowFieldsDlg" style\x3d"color: #21759b;"\x3e${i18n.configureFields}\x3c/a\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv dojoAttachPoint\x3d"_noDataHandlerDiv"\x3e\r\n        \x3c/div\x3e\x3cspan dojoAttachPoint\x3d"_noDataHandlerText"\x3e\x3c/span\x3e              \r\n        \x3cdiv\x3e\r\n            \x3cinput id\x3d"_showAttachments" dojoAttachPoint\x3d"_showAttachments" dojotype\x3d"dijit.form.CheckBox" value\x3d"true" checked\x3d"false" type\x3d"checkbox"/\x3e\r\n            \x3clabel id\x3d"_showAttachmentsLabel" dojoAttachPoint\x3d"_showAttachmentsLabel" for\x3d"_showAttachments"\x3e\r\n                ${i18n.showAttachmentAsLinks}\r\n            \x3c/label\x3e\r\n            \x3cp style\x3d"margin-bottom:3px;" class\x3d"title"\x3e\r\n                ${i18n.media}\r\n            \x3c/p\x3e\r\n            \x3cdiv style\x3d"margin-bottom:5px;"\x3e\r\n                ${i18n.imagesAndCharts}\r\n            \x3c/div\x3e\r\n            \x3cbutton dojoAttachPoint\x3d"_addMedia" class\x3d"calcite light tiny" \x3e\x3c/button\x3e\r\n            \x3ctable\x3e\r\n                \x3ctr\x3e\r\n                    \x3ctd\x3e\r\n                    \x3cselect dojoType\x3d"dijit.form.MultiSelect" name\x3d"_mediaSelect" style\x3d"width:180px;height:130px;" dojoAttachPoint\x3d"_mediaSelect"\x3e\r\n                        \x3coption value\x3d"-1" selected\x3d"false"\x3e${i18n.noImagesOrCharts}\x3c/option\x3e\r\n                        \x3coption value\x3d"1" selected\x3d"false"\x3e${i18n.clickAdd}\x3c/option\x3e\r\n                        \x3coption value\x3d"2" selected\x3d"false"\x3e${i18n.useArrows}\x3c/option\x3e\r\n                    \x3c/select\x3e\x3c/td\x3e\r\n                    \x3ctd width\x3d"18"\x3e\r\n                    \x3cbutton dojoAttachPoint\x3d"_mediaProperties" dojoType\x3d"dijit.form.Button" class\x3d"button calcite transparent tiny" iconClass\x3d"popupButton popupConfigureIcon" showLabel\x3d"false" type\x3d"button"\x3e${i18n.configureMedia}\x3c/button\x3e\r\n                    \x3cbutton  dojoAttachPoint\x3d"_mediaDelete" class\x3d"button calcite transparent tiny" dojoType\x3d"dijit.form.Button" iconClass\x3d"popupButton popupRemoveIcon" showLabel\x3d"false" type\x3d"button"\x3e${i18n.removeMedia}\x3c/button\x3e\r\n                    \x3cbutton  dojoAttachPoint\x3d"_mediaSelectUp" class\x3d"button calcite transparent tiny" dojoType\x3d"dijit.form.Button" iconClass\x3d"popupButton popupUpIcon" showLabel\x3d"false" type\x3d"button"\x3e${i18n.moveUp}\x3c/button\x3e\r\n                    \x3cbutton  dojoAttachPoint\x3d"_mediaSelectDown" class\x3d"button calcite transparent tiny" dojoType\x3d"dijit.form.Button" iconClass\x3d"popupButton popupDownIcon" showLabel\x3d"false" type\x3d"button"\x3e${i18n.moveDown}\x3c/button\x3e\r\n                    \x3c/td\x3e\r\n                \x3c/tr\x3e\r\n            \x3c/table\x3e\r\n            \x3cbr /\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv dojoAttachPoint\x3d"relatedData" class\x3d"hide"\x3e\r\n            \x3cp style\x3d"margin-bottom:3px;" class\x3d"title"\x3e\r\n                ${i18n.relatedDataTitle}\r\n            \x3c/p\x3e\r\n            \x3clabel class\x3d"showRelatedDataNode" for\x3d"_showRelatedData" style\x3d"vertical-align: middle;"\x3e\r\n                \x3cinput dojoAttachPoint\x3d"_showRelatedData" dojotype\x3d"dijit.form.CheckBox" checked\x3d"true" type\x3d"checkbox"/\x3e\r\n                ${i18n.showRelatedData}\x3cbr /\x3e\x3cbr /\x3e\r\n            \x3c/label\x3e\r\n            \x3cbutton dojoAttachPoint\x3d"_sortOptionsBtn" dojoType\x3d"dijit.form.Button" class\x3d"calcite light small"  type\x3d"button"\x3e${i18n.sortOptions}\x3c/button\x3e\r\n        \x3c/div\x3e\r\n    \x3c/div\x3e\r\n\r\n    \x3cdiv id\x3d"popupBuilderContentBottom" dojoType\x3d"dijit.layout.BorderContainer" region\x3d"bottom" gutters\x3d"false" design\x3d"headline" style\x3d"height:80px;padding:0; margin:0px;"\x3e\r\n    \r\n      \x3cdiv id\x3d"popupBuilderContentButtons" dojoType\x3d"dijit.layout.ContentPane" region\x3d"top" style\x3d"padding:5px;margin-top:5px;border-top:solid 1px #BBB;"\x3e\r\n        \x3cdiv align\x3d"center" id\x3d"popupBuilderContentButtonsCenter"\x3e\r\n          \x3cbutton dojoType\x3d"dijit.form.Button" class\x3d"calcite blue" type\x3d"submit" dojoAttachPoint\x3d"_savePopup"\x3e\r\n              ${i18n.savePopup}\r\n          \x3c/button\x3e\r\n          \x3cbutton dojoType\x3d"dijit.form.Button" class\x3d"calcite transparent" type\x3d"submit" dojoAttachPoint\x3d"_cancelPopup"\x3e\r\n              ${i18n.cancel}\r\n          \x3c/button\x3e\r\n        \x3c/div\x3e \r\n      \x3c/div\x3e\r\n      \r\n      \x3cdiv id\x3d"popupBuilderContentFooter" dojoType\x3d"dijit.layout.ContentPane" region\x3d"bottom" style\x3d"padding: 0 5px 0 5px; display:none;"\x3e\r\n          \x3cdiv class\x3d"footer" id\x3d"popupBuilderSiteFooter" dojotype\x3d"arcgisonline.sharing.dijit.SiteFooterMap" style\x3d"white-space:normal;"\x3e\x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \r\n    \x3c/div\x3e\r\n\r\n    \x3cdiv dojoAttachPoint\x3d"_changeFieldsDlg" class\x3d"esriChangeFieldsDialog" title\x3d"${i18n.configureAttributes}" dojoType\x3d"dijit.Dialog"\x3e\r\n        \x3cdiv id\x3d"_changeFieldsTitle" style\x3d"margin-bottom:10px;max-width:720px;min-width:400px;width:600px;"\x3e${i18n.checkFields}\x3c/div\x3e\r\n          \x3cdiv style\x3d"height:250px;"\x3e\r\n          \x3cdiv class\x3d"_popupGrid" style\x3d"height:250px;" dojoAttachPoint\x3d"_changeFieldsGridDiv"\x3e\x3c/div\x3e\r\n          \x3cdiv class\x3d"_popupSettings esriLeadingMargin1"\x3e\r\n            \x3cdiv\x3e\r\n              \x3cbutton class\x3d"button calcite transparent tiny" dojoAttachPoint\x3d"_fieldsSelectUp" dojoType\x3d"dijit.form.Button" iconClass\x3d"popupButton popupUpIcon" showLabel\x3d"false" type\x3d"button"\x3e${i18n.moveUp}\x3c/button\x3e\r\n              \x3cbr /\x3e\r\n              \x3cbutton  class\x3d"button calcite transparent tiny" dojoAttachPoint\x3d"_fieldsSelectDown" dojoType\x3d"dijit.form.Button" iconClass\x3d"popupButton popupDownIcon" showLabel\x3d"false" type\x3d"button"\x3e${i18n.moveDown}\x3c/button\x3e\r\n            \x3c/div\x3e\r\n            \x3cfieldset class\x3d"statisticType" dojoAttachPoint\x3d"_statsFieldSet" style\x3d"display:none; width:200px;"\x3e\r\n              \x3clegend dojoAttachPoint\x3d"_statsTitle" class\x3d"legendTitle"\x3e${i18n.statsType}\x3c/legend\x3e\r\n              \x3cdiv style\x3d"display:block;"\x3e\r\n                \x3cselect style\x3d"width:150px;" dojoAttachPoint\x3d"_statsTypeSelect" dojoType\x3d"dijit.form.Select"\x3e\r\n                  \x3coption value\x3d\'count\' selected\x3d"selected"\x3e${i18n.count}\x3c/option\x3e\r\n                  \x3coption value\x3d\'sum\'\x3e${i18n.sum}\x3c/option\x3e\r\n                  \x3coption value\x3d\'min\'\x3e${i18n.min}\x3c/option\x3e\r\n                  \x3coption value\x3d\'max\'\x3e${i18n.max}\x3c/option\x3e\r\n                  \x3coption value\x3d\'avg\'\x3e${i18n.avg}\x3c/option\x3e\r\n                  \x3coption value\x3d\'stddev\'\x3e${i18n.stddev}\x3c/option\x3e\r\n                \x3c/select\x3e\r\n                \x3cbr/\x3e\r\n              \x3c/div\x3e\r\n            \x3c/fieldset\x3e\r\n            \x3cfieldset class\x3d"popupFormat" style\x3d"display:none; width:180px;"\x3e\r\n              \x3clegend dojoAttachPoint\x3d"_legendTitle" class\x3d"legendTitle"\x3e${i18n.formatFields}\x3c/legend\x3e\r\n              \x3cdiv class\x3d"format formatNumber" style\x3d"display:none;"\x3e\r\n                \x3cselect style\x3d"width:150px;" dojoAttachPoint\x3d"_formatNumberSelect" class\x3d"formatNumber formatter format" dojoType\x3d"dijit.form.Select"\x3e\r\n                  \x3coption value\x3d\'0\' selected\x3d"selected"\x3e0 ${i18n.decimalPlaces}\x3c/option\x3e\r\n                  \x3coption value\x3d\'1\'\x3e1 ${i18n.decimalPlace}\x3c/option\x3e\r\n                  \x3coption value\x3d\'2\'\x3e2 ${i18n.decimalPlaces}\x3c/option\x3e\r\n                  \x3coption value\x3d\'3\'\x3e3 ${i18n.decimalPlaces}\x3c/option\x3e\r\n                  \x3coption value\x3d\'4\'\x3e4 ${i18n.decimalPlaces}\x3c/option\x3e\r\n                  \x3coption value\x3d\'5\'\x3e5 ${i18n.decimalPlaces}\x3c/option\x3e\r\n                  \x3coption value\x3d\'6\'\x3e6 ${i18n.decimalPlaces}\x3c/option\x3e\r\n                \x3c/select\x3e\r\n                \x3cbr /\x3e\r\n                \x3c/div\x3e\r\n                \x3cdiv class\x3d"formatNumber formatter formatInteger format" style\x3d"display:none;"\x3e\r\n                  \x3clabel class\x3d"checkbox"\x3e\x3cinput dojoAttachPoint\x3d"_formatNumberCheck" dojoType\x3d"dijit.form.CheckBox"/\x3e\x26nbsp;${i18n.separator}\x3c/label\x3e\r\n                \x3c/div\x3e\r\n              \x3cdiv class\x3d"formatDate format"\x3e\r\n                \x3cselect dojoAttachPoint\x3d"_formatDateSelect" class\x3d"formatter" style\x3d"width:150px;" dojoType\x3d"dijit.form.Select"\x3e\r\n                  \x3coption value\x3d"shortDate" selected\x3d"selected"\x3e12/21/1997\x3c/option\x3e\r\n                  \x3coption value\x3d"shortDateLE" selected\x3d"selected"\x3e21/12/1997\x3c/option\x3e\r\n                  \x3coption value\x3d"longMonthDayYear"\x3eDecember 21, 1997\x3c/option\x3e\r\n                  \x3coption value\x3d"dayShortMonthYear"\x3e21 Dec 1997\x3c/option\x3e\r\n                  \x3coption value\x3d"longDate"\x3eSunday, December 21, 1997\x3c/option\x3e\r\n                  \x3coption value\x3d"longMonthYear"\x3eDecember 1997\x3c/option\x3e\r\n                  \x3coption value\x3d"shortMonthYear"\x3eDec 1997\x3c/option\x3e\r\n                  \x3coption value\x3d"year"\x3e1997\x3c/option\x3e\r\n                \x3c/select\x3e\r\n                \x3cdiv class\x3d"formatTime hide"\x3e\r\n                  \x3clabel dojoAttachPoint\x3d"timeCheckboxLbl" class\x3d"timeCheckbox disabled"\x3e\x3cinput dojoAttachPoint\x3d"_formatTimeCheck" dojoType\x3d"dijit.form.CheckBox"/\x3e\x26nbsp;${i18n.showTime}\x3c/label\x3e\r\n                  \x3cbr /\x3e\r\n                  \x3cselect dojoAttachPoint\x3d"_formatTimeSelect" class\x3d"formatter hide" style\x3d"width:150px;" dojoType\x3d"dijit.form.Select"\x3e\r\n                    \x3coption value\x3d"ShortTime" selected\x3d"selected"\x3e6:00 PM\x3c/option\x3e\r\n                    \x3coption value\x3d"LongTime"\x3e6:00:00 PM\x3c/option\x3e\r\n                    \x3coption value\x3d"ShortTime24"\x3e18:00\x3c/option\x3e\r\n                    \x3coption value\x3d"LongTime24"\x3e18:00:00\x3c/option\x3e\r\n                  \x3c/select\x3e\r\n                \x3c/div\x3e\r\n                \x3c!--\x3cinput dojoAttachPoint\x3d"_formatDateCheck" dojoType\x3d"dijit.form.CheckBox"/\x3e--\x3e\r\n                \x3c!--\x3clabel class\x3d"checkbox"\x3e${i18n.localTime}\x3c/label\x3e--\x3e\r\n              \x3c/div\x3e\r\n              \x3cdiv class\x3d"formatString format"\x3e\r\n                \x3clabel\x3e${i18n.textboxType}\x3c/label\x3e\r\n                \x3cselect dojoAttachPoint\x3d"_formatStringSelect" dojoType\x3d"dijit.form.Select"\x3e\r\n                  \x3coption value\x3d\'textbox\' selected\x3d"selected"\x3e${i18n.singleLine}\x3c/option\x3e\r\n                  \x3coption value\x3d\'textarea\'\x3e${i18n.multipleLine}\x3c/option\x3e\r\n                  \x3coption value\x3d\'richtext\'\x3e${i18n.richText}\x3c/option\x3e\r\n                \x3c/select\x3e\r\n              \x3c/div\x3e\r\n              \x3cdiv class\x3d"formatHint format"\x3e\r\n                \x3cbr /\x3e\r\n                \x3clabel\x3e${i18n.editHint}\x3c/label\x3e\r\n                \x3cinput dojoAttachPoint\x3d"_formatTooltip" dojoType\x3d"dijit.form.TextBox"/\x3e\r\n              \x3c/div\x3e\r\n            \x3c/fieldset\x3e\r\n          \x3c/div\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv style\x3d"margin:40px 0 10px 0;float:right;"\x3e\r\n          \x3cbutton dojoType\x3d"dijit.form.Button" type\x3d"submit" dojoAttachEvent\x3d"onClick:_onSaveFields" class\x3d"calcite blue"\x3e${i18n.ok}\x3c/button\x3e\r\n          \x3cbutton dojoType\x3d"dijit.form.Button" type\x3d"button" dojoAttachEvent\x3d"onClick:_onCancelSaveFields" class\x3d"calcite transparent"\x3e${i18n.cancel}\x3c/button\x3e\r\n        \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv dojoAttachPoint\x3d"_customFieldDlg" id\x3d"_customFieldDlg" title\x3d"${i18n.customAttributeDisplay}" dojoType\x3d"dijit.Dialog" style\x3d"height:auto;width:575px;overflow-y:hidden;"\x3e\r\n        \x3cdiv style\x3d"margin-bottom:10px;"\x3e\r\n            ${i18n.defineInfo}\r\n        \x3c/div\x3e\r\n        \x3c!--\x3cdiv dojoType\x3d"dijit.Editor" plugins\x3d"[\'bold\',\'italic\',\'underline\',\'|\', \'justifyLeft\', \'justifyCenter\', \'justifyRight\',\'|\', \'insertOrderedList\', \'insertUnorderedList\', \'|\', \'createEsriLink\', \'unlink\', \'|\', \'undo\', \'redo\']" extraPlugins\x3d"[\'foreColor\',\'hiliteColor\']" dojoAttachPoint\x3d"_customAttributeEditor" trim\x3d"true" style\x3d"border:1px solid #CCCCCC;height:160px;"\x3e\x3c/div\x3e--\x3e\r\n        \x3cdiv dojoAttachPoint\x3d"_customFieldEditor"\x3e\x3c/div\x3e\r\n        \x3cdiv style\x3d"float:right;margin:10px 0px 10px 0px"\x3e\r\n            \x3cbutton dojoType\x3d"dijit.form.Button" type\x3d"submit" class\x3d"calcite blue"\x3e\r\n                ${i18n.ok}\r\n            \x3c/button\x3e\r\n            \x3cbutton dojoType\x3d"dijit.form.Button" type\x3d"button" class\x3d"calcite transparent" onClick\x3d"dijit.byId(\'_customFieldDlg\').hide();"\x3e\r\n                ${i18n.cancel}\r\n            \x3c/button\x3e\r\n        \x3c/div\x3e\r\n    \x3c/div\x3e\r\n     \x3cdiv dojoAttachPoint\x3d"_mediaConfigDlg" id\x3d"_mediaConfigDlg" style\x3d"width:400px;height:auto;overflow-y:auto;" title\x3d"" dojoType\x3d"dijit.Dialog" \x3e\r\n        \x3cdiv style\x3d"margin-bottom:10px;" dojoAttachPoint\x3d"_mediaConfigDescription"\x3e\x3c/div\x3e\r\n            \x3clabel for\x3d"_mediaTitle" style\x3d"margin:3px 0px 3px 0px"\x3e${i18n.titleLabel}\x3c/label\x3e\r\n            \x3ctable style\x3d"width:100%;margin-top:5px;" cellspacing\x3d"0" cellpadding\x3d"0"\x3e\r\n                \x3ctr\x3e\r\n                    \x3ctd width\x3d"300"\x3e\r\n                    \x3cdiv dojoAttachPoint\x3d"_mediaTitle" name\x3d"_mediaTitle" dojotype\x3d"dijit.form.TextBox" style\x3d"width:315px;padding:4px;"\x3e\x3c/div\x3e\r\n                    \x3c/td\x3e\r\n                    \x3ctd\x3e\r\n                    \x3cbutton dojoAttachPoint\x3d"_mediaTitleButton" class\x3d"calcite light tiny"\x3e\x3c/button\x3e\r\n                    \x3c/td\x3e\r\n                \x3c/tr\x3e\r\n            \x3c/table\x3e\r\n            \x3cbr/\x3e\r\n            \x3clabel for\x3d"_mediaCaption" style\x3d"margin:3px 0px 3px 0px;"\x3e${i18n.caption}\x3c/label\x3e\r\n            \x3ctable style\x3d"width:100%;margin-top:5px;" cellspacing\x3d"0" cellpadding\x3d"0"\x3e\r\n                \x3ctr\x3e\r\n                    \x3ctd width\x3d"300"\x3e\r\n                    \x3cdiv dojoAttachPoint\x3d"_mediaCaption" name\x3d"_mediaCaption" dojotype\x3d"dijit.form.SimpleTextarea" style\x3d"width:315px;padding:4px;"\x3e\x3c/div\x3e\r\n                    \x3c/td\x3e\r\n                    \x3ctd style\x3d"vertical-align:top;"\x3e\r\n                    \x3cbutton dojoAttachPoint\x3d"_mediaCaptionButton" class\x3d"calcite light tiny"\x3e\x3c/button\x3e\r\n                    \x3c/td\x3e\r\n                \x3c/tr\x3e\r\n            \x3c/table\x3e\r\n            \x3cbr/\x3e\r\n            \x3cdiv dojoAttachPoint\x3d"_imageConfigDiv"\x3e\r\n            \x3clabel for\x3d"_imageUrl" style\x3d"margin:3px 0px 3px 0px;"\x3e${i18n.URL}\x3c/label\x3e\r\n            \x3ctable style\x3d"width:100%;margin-top:5px;" cellspacing\x3d"0" cellpadding\x3d"0"\x3e\r\n                \x3ctr\x3e\r\n                    \x3ctd width\x3d"300"\x3e\r\n                    \x3cdiv dojoAttachPoint\x3d"_imageUrl" name\x3d"_imageUrl"  invalidMessage\x3d"Invalid URL." dojotype\x3d"dijit.form.TextBox" style\x3d"width:315px;padding:4px;"\x3e\x3c/div\x3e\r\n                    \x3c/td\x3e\r\n                    \x3ctd\x3e\r\n                    \x3cbutton dojoAttachPoint\x3d"_imageUrlButton" class\x3d"calcite light tiny"\x3e\x3c/button\x3e\r\n                    \x3c/td\x3e\r\n                \x3c/tr\x3e\r\n            \x3c/table\x3e\r\n            \x3cbr/\x3e\r\n            \x3clabel for\x3d"_imageLink" style\x3d"margin:3px 0px 3px 0px;"\x3e${i18n.link}\x3c/label\x3e\r\n            \x3ctable style\x3d"width:100%;margin-top:5px;" cellspacing\x3d"0" cellpadding\x3d"0"\x3e\r\n                \x3ctr\x3e\r\n                    \x3ctd width\x3d"300"\x3e\r\n                    \x3cdiv dojoAttachPoint\x3d"_imageLink" name\x3d"_imageLink" dojotype\x3d"dijit.form.TextBox" style\x3d"width:315px;padding:4px;"\x3e\x3c/div\x3e\r\n                    \x3c/td\x3e\r\n                    \x3ctd\x3e\r\n                    \x3cbutton dojoAttachPoint\x3d"_imageLinkButton" class\x3d"calcite light tiny"\x3e\x3c/button\x3e\r\n                    \x3c/td\x3e\r\n                \x3c/tr\x3e\r\n            \x3c/table\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv data-dojo-attach-point\x3d"_mediaFieldSelectDiv" style\x3d"padding:2px 0px 5px 0px"\x3e\r\n              \x3clabel\x3e${i18n.chartSelectLabel}\x3c/label\x3e\r\n              \x3cdiv class\x3d"esriLeadingMargin2" style\x3d"width:100%;padding-top:5px;padding-bottom:5px;"\x3e\r\n                \x3clabel class\x3d"esriSelectLabel"\x3e\r\n                  \x3cinput type\x3d"radio" data-dojo-type\x3d"dijit/form/RadioButton" data-dojo-attach-point\x3d"_sameFieldsBtn" data-dojo-attach-event\x3d"onChange:_handleSameFieldBtnChange" data-dojo-props\x3d"\'class\':\'esriSelectLabel\',checked:true" name\x3d"chartFields"/\x3e\r\n                  ${i18n.thisLayer}\r\n                \x3c/label\x3e\r\n                \x3cdiv style\x3d"padding:2px;"\x3e\x3c/div\x3e\r\n                \x3clabel class\x3d"esriSelectLabel"\x3e\r\n                  \x3cinput type\x3d"radio" data-dojo-type\x3d"dijit/form/RadioButton" data-dojo-attach-point\x3d"_relatedFieldsBtn" data-dojo-props\x3d"\'class\':\'esriSelectLabel\'" name\x3d"chartFields"/\x3e \r\n                  ${i18n.relLayer}\r\n                \x3c/label\x3e\r\n              \x3c/div\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv dojoAttachPoint\x3d"_mediaFieldsDiv"\x3e\r\n            \x3cdiv dojoAttachPoint\x3d"_mediaFieldsDivTitle" style\x3d"margin-top:5px;"\x3e${i18n.chartFields}\x3c/div\x3e\r\n            \x3ctable dojoType\x3d"dojox.grid.DataGrid" class\x3d\'popupGrid\' singleClickEdit\x3d\'true\' selectionMode\x3d"none" sortInfo\x3d\'1\' style\x3d"margin-top:5px;border:1px solid #CCCCCC;height:175px;" dojoAttachPoint\x3d"_mediaFieldsGrid"\x3e\r\n            \x3cthead\x3e\r\n                \x3ctr\x3e\r\n                    \x3cth editable\x3d"false" hidden\x3d\'true\' field\x3d"_pos" width\x3d\'0px\'\x3e\x3c/th\x3e\r\n                    \x3cth editable\x3d"false" width\x3d"22px" field\x3d"_item" formatter\x3d"_getInChartCheckbox"\x3e\x3cinput id\x3d\'_mediaFieldsGrid_checkAll\' type\x3d"checkbox" /\x3e\x3c/th\x3e\r\n                    \x3cth editable\x3d"true" field\x3d"label" width\x3d\'185px\'\x3e${i18n.fieldAlias}\x3c/th\x3e\r\n                    \x3cth editable\x3d"false" field\x3d"fieldName" width\x3d\'120px\' formatter\x3d"_formatToken"\x3e${i18n.fieldName}\x3c/th\x3e\r\n                \x3c/tr\x3e\r\n            \x3c/thead\x3e\r\n            \x3c/table\x3e\r\n            \r\n            \x3cspan\x3e${i18n.normalizeByLabel}\x26nbsp;\x3c/span\x3e\x3cselect dojoAttachPoint\x3d"_mediaNormalizeSelect" dojoType\x3d"dijit.form.Select" minSize\x3d\'150\'  maxSize\x3d\'180\'  maxHeight\x3d\'150\'  style\x3d"margin:10px 0px 10px 0px;width: 150px;"\x3e\x3c/select\x3e\r\n            \x3cdiv\x3e\r\n            \x3c/div\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv data-dojo-attach-point\x3d"_mediaRelatedFieldsDiv"\x3e\r\n              \x3ctable class\x3d"esriFormTable"\x3e \r\n                \x3ctbody\x3e\r\n                  \x3ctr\x3e\r\n                    \x3ctd class\x3d"esriLeadingMargin1"\x3e\r\n                      \x3clabel\x3e${i18n.layerTable}\x3c/label\x3e\r\n                    \x3c/td\x3e\r\n                    \x3ctd\x3e\r\n                      \x3cinput class\x3d"longInput" dojoAttachPoint\x3d"_relatedLayerInput" data-dojo-type\x3d"dijit/form/Select" data-dojo-attach-event\x3d"onChange:_handleRelatedLayerInputChange" minSize\x3d\'150\'  maxSize\x3d\'180\'  maxHeight\x3d\'150\'  style\x3d"margin:10px 0px 10px 0px;width: 150px;"\x3e\x3c/input\x3e\r\n                    \x3c/td\x3e\r\n                  \x3c/tr\x3e\r\n                  \x3ctr\x3e\r\n                    \x3ctd class\x3d"esriLeadingMargin1"\x3e\r\n                      \x3clabel\x3e${i18n.chartField}\x3c/label\x3e\r\n                    \x3c/td\x3e\r\n                    \x3ctd\x3e\r\n                      \x3cinput class\x3d"longInput" dojoAttachPoint\x3d"_relatedChartFieldInput" data-dojo-type\x3d"dijit/form/Select" minSize\x3d\'150\'  maxSize\x3d\'180\'  maxHeight\x3d\'150\'  style\x3d"margin:10px 0px 10px 0px;width: 150px;"\x3e\x3c/input\x3e\r\n                    \x3c/td\x3e               \r\n                  \x3c/tr\x3e\r\n                  \x3ctr\x3e\r\n                    \x3ctd class\x3d"esriLeadingMargin1"\x3e\r\n                      \x3clabel\x3e${i18n.labelField}\x3c/label\x3e\r\n                    \x3c/td\x3e\r\n                    \x3ctd\x3e\r\n                      \x3cinput dojoAttachPoint\x3d"_mediaTooltipSelect" data-dojo-type\x3d"dijit/form/Select" minSize\x3d\'150\'  maxSize\x3d\'180\'  maxHeight\x3d\'150\'  style\x3d"margin:10px 0px 10px 0px;width: 150px;"\x3e\x3c/input\x3e\r\n                    \x3c/td\x3e\r\n                  \x3c/tr\x3e\r\n                \x3c/tbody\x3e\r\n              \x3c/table\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv style\x3d"float:right;margin:10px 0px 10px 0px"\x3e\r\n            \x3cbutton dojoType\x3d"dijit.form.Button" type\x3d"submit" class\x3d"calcite blue"\x3e\r\n                ${i18n.ok}\r\n            \x3c/button\x3e\r\n            \x3cbutton dojoType\x3d"dijit.form.Button" type\x3d"button" class\x3d"calcite transparent" onClick\x3d"dijit.byId(\'_mediaConfigDlg\').hide();"\x3e\r\n                ${i18n.cancel}\r\n            \x3c/button\x3e\r\n        \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv id\x3d"_sortOptionsDlg" dojoAttachPoint\x3d"_sortOptionsDlg" title\x3d"${i18n.sortOptions}" dojoType\x3d"dijit.Dialog" style\x3d"height:auto;width:575px;overflow-y:hidden;"\x3e\r\n        \x3cdiv style\x3d"margin-bottom:10px;"\x3e\r\n            ${i18n.sortOptionsMsg}\r\n        \x3c/div\x3e\r\n        \x3cdiv class\x3d"_sortOptionsGrid" id\x3d"_sortOptionsGridDiv" dojoAttachPoint\x3d"_sortOptionsGridDiv"\x3e\x3c/div\x3e\r\n        \x3cdiv style\x3d"float:right;margin:10px 0px 10px 0px"\x3e\r\n            \x3cbutton dojoType\x3d"dijit.form.Button" type\x3d"submit" class\x3d"calcite blue" onClick\x3d"dijit.byId(\'_sortOptionsDlg\').hide(\'ok\');"\x3e\r\n                ${i18n.ok}\r\n            \x3c/button\x3e\r\n            \x3cbutton dojoType\x3d"dijit.form.Button" type\x3d"button" class\x3d"calcite transparent" onClick\x3d"dijit.byId(\'_sortOptionsDlg\').hide(\'cancel\');"\x3e\r\n                ${i18n.cancel}\r\n            \x3c/button\x3e\r\n        \x3c/div\x3e\r\n    \x3c/div\x3e\r\n\x3c/div\x3e\r\n',
hideTargetHandler:null,i18n:null,_relatedFieldPrefix:"relationships/",_supportsTime:{shortDate:!0,shortDateLE:!0},_dateFormats:[{value:'{"dateFormat":"shortDate", "timezone":"utc"}',label:"12/21/1997"},{value:'{"dateFormat":"longMonthDayYear", "timezone":"utc"}',label:"December 21, 1997"},{value:'{"dateFormat":"dayShortMonthYear", "timezone":"utc"}',label:"21 Dec 1997"},{value:'{"dateFormat":"longDate", "timezone":"utc"}',label:"Sunday, December 21, 1997"},{value:'{"dateFormat":"shortDateShortTime", "timezone":"utc"}',
label:"12/21/1997 6:00 PM"},{value:'{"dateFormat":"shortDateShortTime24", "timezone":"utc"}',label:"12/21/1997 18:00"},{value:'{"dateFormat":"longMonthYear", "timezone\':"utc"}',label:"December 1997"},{value:'{"dateFormat":"shortMonthYear", "timezone":"utc"}',label:"Dec 1997"},{value:'{"dateFormat":"year", "timezone":"utc"}',label:"1997"},{value:'{"dateFormat":"shortDateLE", "timezone":"utc"}',label:"21/12/1997"},{value:'{"dateFormat":"shortDateLEShortTime", "timezone":"utc"}',label:"21/12/1997 6:00 PM"},
{value:'{"dateFormat":"shortDateLEShortTime24", "timezone":"utc"}',label:"21/12/1997 18:00"},{value:'{"dateFormat":"shortDateLongTime", "timezone":"utc"}',label:"12/21/1997 6:00:00 PM"},{value:'{"dateFormat":"shortDateLongTime24", "timezone":"utc"}',label:"12/21/1997 18:00:00"},{value:'{"dateFormat":"shortDateLELongTime", "timezone":"utc"}',label:"21/12/1997 6:00 PM"},{value:'{"dateFormat":"shortDateLELongTime24", "timezone":"utc"}',label:"21/12/1997 18:00:00"}],_timeFormats:[{value:'{"timeFormat":"ShortTime"}',
label:"6:00 PM"},{value:'{"timeFormat":"LongTime"}',label:"6:00:00 PM"},{value:'{"timeFormat":"ShortTime24"}',label:"18:00"},{value:'{"timeFormat":"LongTime24"}',label:"18:00:00"}],_numberFormats:[{value:'{"places":0, "digitSeparator":true}',label:"0 decimal places"},{value:'{"places":1, "digitSeparator":true}',label:"1 decimal place"},{value:'{"places":2, "digitSeparator":true}',label:"2 decimal places"},{value:'{"places":3, "digitSeparator":true}',label:"3 decimal places"},{value:'{"places":4, "digitSeparator":true}',
label:"4 decimal places"},{value:'{"places":5, "digitSeparator":true}',label:"5 decimal places"},{value:'{"places":6, "digitSeparator":true}',label:"6 decimal places"}],_editorTrackingFields:"creationdate, creator, editdate, editor",constructor:function(a,b){a=a||{};this.container=a.containerNode;this.layerId=a.layerId;this.subLayerId=a.subLayerId;this.mapLayer=a.mapLayer;this.mapLayerFS=null;this._layer=a.layerInfo;this._thematicGroupLayerIds=a.thematicGroupLayerIds;this._pbConnects=[];this._relatedInfo=
[]},destroy:function(){b.forEach(this._pbConnects,b.disconnect);delete this._pbConnects;this._changeFieldsDlg.destroy();this._customFieldDlg.destroy();this._mediaConfigDlg.destroy();this._changeFieldsGrid.destroy();this._sortOptionsDlg&&this._sortOptionsDlg.destroy();this._fieldInfosStore.close();this._mediaInfoStore.close();this._fieldsGridStore=this._title=this._sortOptionsDlg=this.changeFieldsGrid=this._formatFieldsGrid=this._fieldInfosStore=this._mediaInfoStore=this._customFieldDlg=this._changeFieldsDlg=
this._formatFieldsDlg=this._mediaConfigDlg=null;this._curLayer&&this._curLayer.__url&&delete this._curLayer.__url;this._curLayer&&this._curLayer.__version&&delete this._curLayer.__version;this._customAttributeEditor&&(this._customAttributeEditor.destroyRecursive(),this._customAttributeEditor=null);this.inherited(arguments)},postMixInProperties:function(){this.inherited(arguments);this.i18n=b.i18n.getLocalization("arcgisonline","arcgisonline").common;b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline",
"arcgisonline").popupBuilder)},postCreate:function(){this.container.addChild(h.byId(this.id))},startup:function(){this.inherited(arguments);isEmbedded||b.style(b.byId("popupBuilderContentFooter"),"display","");this._createDropDownButtons();this._init();!1===this._hasNumericField&&(b.query("._requireNumericFld").forEach(esri.hide),!1===this._hasDateField&&b.query("._requireNumericDateFld").forEach(esri.hide))},_createDropDownButtons:function(){this._titleFieldsSelect=new h.form.MultiSelect({style:"width:200px;"});
new arcgisonline.map.dijit.DropDownButton({showLabel:!1,dropDown:this._titleFieldsSelect,"class":"calcite transparent tiny noArrow"},this._titleButton);this._mediaTitleSelect=new h.form.MultiSelect({style:"width:200px;"});new arcgisonline.map.dijit.DropDownButton({showLabel:!1,dropDown:this._mediaTitleSelect,"class":"calcite transparent tiny noArrow"},this._mediaTitleButton);this._mediaCaptionSelect=new h.form.MultiSelect({style:"width:200px;"});new arcgisonline.map.dijit.DropDownButton({showLabel:!1,
dropDown:this._mediaCaptionSelect,"class":"calcite transparent tiny noArrow"},this._mediaCaptionButton);this._imageUrlSelect=new h.form.MultiSelect({style:"width:200px;"});new arcgisonline.map.dijit.DropDownButton({showLabel:!1,dropDown:this._imageUrlSelect,"class":"calcite transparent tiny noArrow"},this._imageUrlButton);this._imageLinkSelect=new h.form.MultiSelect({style:"width:200px;"});new arcgisonline.map.dijit.DropDownButton({showLabel:!1,dropDown:this._imageLinkSelect,"class":"calcite transparent tiny noArrow"},
this._imageLinkButton);var a=new h.Menu;a.addChild(this._addMediaImage=new h.MenuItem({tooltip:this.i18n.image,label:this.i18n.image}));a.addChild(this._addMediaPieChart=new h.MenuItem({"class":"_requireNumericFld",tooltip:this.i18n.pieChart,label:this.i18n.pieChart}));a.addChild(this._addMediaBarChart=new h.MenuItem({"class":"_requireNumericFld",tooltip:this.i18n.barChart,label:this.i18n.barChart}));a.addChild(this._addMediaColumnChart=new h.MenuItem({"class":"_requireNumericFld",tooltip:this.i18n.columnChart,
label:this.i18n.columnChart}));a.addChild(this._addMediaLineChart=new h.MenuItem({"class":"_requireNumericFld",tooltip:this.i18n.lineChart,label:this.i18n.lineChart}));new h.form.DropDownButton({title:this.i18n.addMediaInfo,label:this.i18n.add,dropDown:a,"class":"calcite light small"},this._addMedia)},getPopupInfo:function(){var a={};a.title=b.trim(this._title.get("value"));a.fieldInfos=[];var c=this._fieldInfosStore;c.fetch({sort:[{attribute:"_pos",descending:!1}],onItem:b.hitch(this,function(d){var f=
{},g=c.getAttributes(d);b.forEach(g,function(a){if("_"!==a.charAt(0)){var b=c.getValue(d,a);esri.isDefined(b)&&(f[a]=b)}},this);f.format&&(f.format=b.json.parse(f.format));a.fieldInfos.push(f)})});var d=this._descriptionType.get("value");"_oneField"===d?this._getItemFromStore(this._fieldInfosStore,this._singleFieldSelect.get("value"),b.hitch(this,function(b){a.description=this._formatToken(this._fieldInfosStore.getValue(b,"fieldName"))})):"_customField"===d?a.description=this._customAttributeEditor.get("value"):
"_none"===d?(a.description=null,b.forEach(a.fieldInfos,"item.visible \x3d false;")):a.description=null;a.showAttachments=this._showAttachments.checked?!0:!1;this._showNoDataRecordsCheckbox&&(a.layerOptions||(a.layerOptions={}),a.layerOptions.showNoDataRecords=this._showNoDataRecordsCheckbox.checked?!1:!0);if(a.relatedRecordsInfo||this._relatedInfo&&this._relatedInfo.length)a=b.mixin(a,{relatedRecordsInfo:{showRelatedRecords:this._showRelatedData.get("checked"),orderByFields:this._orderByFields||null}});
a.mediaInfos=[];c=this._mediaInfoStore;c.fetch({sort:[{attribute:"_pos",descending:!1}],onItem:b.hitch(this,function(d){var f={},g=c.getAttributes(d);b.forEach(g,function(a){"_"!==a.charAt(0)&&(f[a]=c.getValue(d,a))},this);a.mediaInfos.push(f)})});return a},save:function(){var a=this.getPopupInfo();if(a.description&&-1<a.description.indexOf("\x3ca href\x3d"))for(var c=a.description.indexOf("\x3ca href\x3d");-1<c;){var d=a.description.substring(c+1,a.description.indexOf('"',c+10));if(-1<d.indexOf("$")){var e=
d.replace(/\$/g,"%24");a.description=a.description.replace(d,e)}c=a.description.indexOf("\x3ca href\x3d",c+10)}if(this.popupInfo&&this._origPopupInfoJson!==b.json.stringify(a)){if(arcgisonline.map.featColl.isFeatureCollection(this.mapLayer)||this.mapLayer.layer instanceof esri.layers.CSVLayer)if(this.mapLayer.layers||this.mapLayer.tables){d=this.mapLayer.layers;this.mapLayer.tables&&(d=d.concat(this.mapLayer.tables));for(c=0;c<d.length;c++)c===this.subLayerId&&(arcgisonline.map.popup.removePopup(this.mapLayer,
c),d[c].__popupInfo=a)}else arcgisonline.map.popup.removePopup(this.mapLayer),this.mapLayer.popupInfo=a;else if(this.mapLayer.layer instanceof esri.layers.GeoRSSLayer)c=this.mapLayer.layer.getFeatureLayers()[this.subLayerId],arcgisonline.map.popup.removePopup(this.mapLayer,this.subLayerId),c.__popupInfo=a;else if(!this.subLayerId&&0!==this.subLayerId)arcgisonline.map.popup.removePopup(this.mapLayer),this.mapLayer.popupInfo=a;else if(this._thematicGroupLayerIds)b.forEach(this._thematicGroupLayerIds,
function(c){for(var d=0;d<this.mapLayer.itemLayers.length;d++){var e=this.mapLayer.itemLayers[d];if(e.id===c){e.popupInfo&&arcgisonline.map.popup.removePopup(this.mapLayer,c);e.popupInfo=b.clone(a);arcgisonline.map.popup.addPopupLayer(this.mapLayer,c);break}}},this);else if(this.mapLayerFS)arcgisonline.map.popup.removePopup(this.mapLayerFS),this.mapLayerFS.popupInfo=a,delete this.mapLayerFS.__createDefaultPopup,this.mapLayer.layer.infoTemplates=this.mapLayer.layer.infoTemplates||{},this.mapLayer.layer.infoTemplates[this.subLayerId]=
{infoTemplate:new esri.dijit.PopupTemplate(a),layerUrl:this.mapLayerFS.url,resourceInfo:this.mapLayerFS.serviceInfo};else{var f=e=d=null;if(this.mapLayer.itemLayers){for(c=0;c<this.mapLayer.itemLayers.length;c++)if(this.mapLayer.itemLayers[c].id===this.subLayerId){d=this.mapLayer.itemLayers[c].layerUrl;e=this.mapLayer.itemLayers[c].layerItemId;f=this.mapLayer.itemLayers[c]._layerInfo;break}arcgisonline.map.popup.removePopup(this.mapLayer,this.subLayerId)}else this.mapLayer.itemLayers=[];for(var g=
!1,c=0;c<this.mapLayer.itemLayers.length;c++)if(this.mapLayer.itemLayers[c].id===this.subLayerId){this.mapLayer.itemLayers[c].popupInfo=a;d&&(this.mapLayer.itemLayers[c].layerUrl=d,this.mapLayer.itemLayers[c]._layerInfo=f,e&&(this.mapLayer.itemLayers[c].layerItemId=e));g=!0;break}g||(c={id:this.subLayerId,popupInfo:a},d&&(c.layerUrl=d,c.layerItemId=e,c._layerInfo=this._layer),this.mapLayer.queryServiceUrl&&(c.layerUrl=this.mapLayer.queryServiceUrl+"/"+this.subLayerId,c._layerInfo=this._layer,this.mapLayer.queryServiceItemId&&
(c.layerItemId=this.mapLayer.queryServiceItemId)),this.mapLayer.itemLayers.push(c))}this.popupInfo=a;this._origPopupInfoJson=b.json.stringify(esri._sanitize(this.popupInfo));this.mapLayerFS?(this.mapLayerFS.popupChanged=!0,delete this.mapLayerFS.disablePopup,arcgisonline.map.popup.addPopupLayer(this.mapLayerFS)):(this.mapLayer.popupChanged=!0,delete this.mapLayer.disablePopup,arcgisonline.map.popup.addPopupLayer(this.mapLayer,this.subLayerId));arcgisonline.map.main.markMapAsChanged("popupBuilder");
this._thematicGroupLayerIds||arcgisonline.map.table.refreshTablePrep(this.mapLayer,this.subLayerId,"popup");b.publish("_onRendererUpdate",[])}},_onChangeFieldsGridCheckAll:function(a,c,d,e){if(!1!==esri.isDefined(e.target.checked)){var f=e.target.checked;a.fetch({query:c,onItem:b.hitch(this,function(b){a.setValue(b,d||e.cell.field,f)})})}},_onTitleSelectChange:function(a,c,d){this._getItemFromStore(this._fieldInfosStore,c.get("value"),b.hitch(this,function(b){esriGeowConfig.isRightToLeft?a.set("value",
this._formatToken(this._fieldInfosStore.getValue(b,"fieldName"))+a.get("value")):a.set("value",a.get("value")+this._formatToken(this._fieldInfosStore.getValue(b,"fieldName")));c.set("value",-1,!1)}))},_onShowFieldsDlg:function(a){a.preventDefault();this._changeFieldsDlg.show();this._changeFieldsGrid.selection.clear();this._changeFieldsGrid.selection.setSelected(0,!0);this._changeFieldsGrid.setSortIndex(0,!0);this._changeFieldsGrid.resize()},_onSaveFields:function(a){this._changeFieldsGrid.edit.apply();
this._fieldInfosStore.save({onComplete:b.hitch(this,"_loadFieldSelects")})},_onCancelSaveFields:function(){this._changeFieldsDlg.hide();this._fieldInfosStore.revert()},_onSaveFieldFormatter:function(a){this._fieldInfosStore.save()},_onFormatChange:function(a,b,d){this._fieldInfosStore.setValue(a,b,d);this._fieldInfosStore.save()},_onChangePopupContent:function(a){b.query("._popContentPane").forEach(esri.hide);this.hasOwnProperty(a)&&esri.show(this[a])},_onMoveSelectItem:function(a,c,d){var e=c.getSelected(),
e=e.length?e[0].index:0,f=c.domNode.options,g=c.containerNode.options.length-1;if(!(-1===e||1===d&&e===g||-1===d&&0===e)){var k=-1,l;this._getItemFromStore(a,f[e].value,b.hitch(this,function(b){b&&(l=b,k=a.getValue(b,"_pos"),a.setValue(b,"_pos",k+d),c.domNode.scrollTop=15*(k+d-2))}));this._getItemFromStore(a,f[e+d].value,b.hitch(this,function(d){d&&(a.setValue(d,"_pos",k),a.save({onComplete:b.hitch(this._loadSelect(a,a.getIdentity(l),!1,c))}))}))}},_onMoveGridItem:function(a,b,d){var e=b.selection.getSelected(),
f=b.selection.selected.length-1,g=b.selection.selectedIndex,k=e&&e.length&&a.getValue(e[0],"_pos")||0,l=b.getItem(g+d);if(l&&e&&e.length&&!(1===d&&g===f||-1===d&&0===g))a.setValue(e[0],"_pos",k+d),a.setValue(l,"_pos",k),b.setSortIndex(0,!0),b.selection.selectedIndex+=d,b.scrollToRow(b.selection.selectedIndex)},_onAddMedia:function(a){this._mediaInfoStore.fetch({query:{type:a.type},onComplete:b.hitch(this,function(c){var d=this._mediaSelect.domNode.options||[],d=d.length&&"-1"===d[0].value?0:d.length;
c=b.mixin(b.mixin({},a),{_pos:d,title:a.title+" "+(c.length+1),_visible:!0});this._onShowMediaConfigDlg(c,!1)})})},_onDeleteMedia:function(){var a=this._mediaSelect,c=a.get("value");if(c.length){var d=this._mediaInfoStore;b.forEach(c,b.hitch(this,function(c){this._getItemFromStore(d,c,b.hitch(this,function(c){c&&(d.deleteItem(c),d.save({onComplete:b.hitch(this,function(e){this._loadSelect(d,d.getIdentity(c),!1,a);a.domNode.options.length||b.forEach([this.i18n.noImagesOrCharts,this.i18n.clickAdd,this.i18n.useArrows],
b.hitch(this,function(c,d){var e=b.create("option");e.innerHTML=c;e.value=d-1+"";a.containerNode.appendChild(e)}))})}))}))}))}},_onShowMediaSettingsDlg:function(a){this._getItemFromStore(this._mediaInfoStore,this._mediaSelect.get("value"),b.hitch(this,function(b){b&&this._onShowMediaConfigDlg(b,!0)}))},_onShowMediaConfigDlg:function(a,c){var d=this._mediaInfoStore,e=c?d.getValue(a,"type"):a.type;this._mediaConfig=a;this._mediaTitle.set("value",c?d.getValue(a,"title"):a.title);this._mediaCaption.set("value",
c?d.getValue(a,"caption"):a.caption);var f=c?d.getValue(a,"value"):a.value;if("image"===e)esri.show(this._imageConfigDiv),esri.hide(this._mediaFieldsDiv),esri.hide(this._mediaFieldSelectDiv),esri.hide(this._mediaRelatedFieldsDiv),this._mediaConfigDescription.innerHTML=this.i18n.specifyImageInfo,this._mediaConfigDlg.set("title",this.i18n.configureImage),this._imageUrl.set("value",f.sourceURL),this._imageLink.set("value",f.linkURL);else{esri.hide(this._imageConfigDiv);this._relatedInfo&&0===this._relatedInfo.length?
(esri.hide(this._mediaFieldSelectDiv),esri.show(this._mediaFieldsDiv)):esri.show(this._mediaFieldSelectDiv);this._mediaConfigDescription.innerHTML=this.i18n.specifyChartInfo;"piechart"===e?b.style(this._mediaNormalizeSelect,"display","none"):b.style(this._mediaNormalizeSelect,"display","");switch(e){case "piechart":this._mediaConfigDlg.set("title",this.i18n.configurePieChart);break;case "barchart":this._mediaConfigDlg.set("title",this.i18n.configureBarChart);break;case "linechart":this._mediaConfigDlg.set("title",
this.i18n.configureLineChart);break;case "columnchart":this._mediaConfigDlg.set("title",this.i18n.configureColumnChart);break;default:this._mediaConfigDlg.set("title",this.i18n.configureChart)}var g=this._fieldInfosStore,k=!1,l,m=-1;b.forEach(f.fields,function(a){this._getItemFromStore(g,a,b.hitch(this,function(b){var c=this._fromRelatedFieldName(a),d;if(0<c.length&&(this._relatedInfo&&this._relatedInfo[c[0]]&&(d=this._relatedInfo[c[0]].relation),d&&("esriRelCardinalityOneToMany"===d.cardinality||
"esriRelCardinalityManyToMany"===d.cardinality)))!k&&-1===m&&(m=b._relatedId),k=!0,l=b;g.setValue(b,"_inChart",!0)}))},this);this._relatedFieldsBtn.set("value",k);this._sameFieldsBtn.set("value",!k);this._handleSameFieldBtnChange(!k);this._mediaNormalizeSelect.setStore(this._fieldInfosStore,null,{query:"_fieldType:'esriFieldTypeDouble' OR _fieldType:'esriFieldTypeSingle' OR _fieldType:'esriFieldTypeInteger' OR _fieldType:'esriFieldTypeSmallInteger'"});this._mediaNormalizeSelect.addOption([{value:"_none",
label:this.i18n.none}]);this._mediaNormalizeSelect.set("value",f.normalizeField||"_none");this._mediaTooltipSelect.setStore(this._fieldInfosStore,null,{query:"(_cardinality:'esriRelCardinalityOneToMany' OR _cardinality:'esriRelCardinalityManyToMany') AND (NOT _fieldType:'esriFieldTypeOID' AND NOT _fieldType:'esriFieldTypeGeometry')"});-1===m?(this._relatedChartFieldInput.setStore(this._fieldInfosStore,null,{query:"(_cardinality:'esriRelCardinalityOneToMany' OR _cardinality:'esriRelCardinalityManyToMany') AND (NOT _fieldType:'esriFieldTypeOID' AND NOT _fieldType:'esriFieldTypeGeometry')"}),
this._mediaTooltipSelect.setStore(this._fieldInfosStore,null,{query:"(_cardinality:'esriRelCardinalityOneToMany' OR _cardinality:'esriRelCardinalityManyToMany') AND (NOT _fieldType:'esriFieldTypeOID' AND NOT _fieldType:'esriFieldTypeGeometry')"})):this._relatedLayerInput.set("value",m);setTimeout(b.hitch(this,function(){this._mediaTooltipSelect.addOption([{value:"_none",label:this.i18n.none}]);this._mediaTooltipSelect.set("value",f.tooltipField||"_none");l&&this._relatedChartFieldInput.set("value",
this._fieldInfosStore.getIdentity(l))}),500)}this._mediaConfigDlg.show();this._mediaFieldsGrid.update()},_onSaveMediaConfig:function(){this._mediaFieldsGrid.edit.apply();var a=this._mediaInfoStore,c=this._mediaConfig;a.isItem(c)||(this._mediaConfig=c=a.newItem(c));var d=b.trim(this._mediaTitle.get("value")),e=this._mediaInfoStore.getValue(c,"_displayTitle");if(!e&&(!d||!d.length)){for(var d=null,e=this._mediaSelect.containerNode.options,f=!0,g=0;f;)g++,f=b.filter(e,function(b){return b.text===this.i18n.untitled+
" "+g},this).length;a.setValue(c,"_displayTitle",g)}a.setValue(c,"title",d);a.setValue(c,"caption",b.trim(this._mediaCaption.get("value")));d=b.mixin({},a.getValue(c,"value"));if("image"===a.getValue(c,"type"))d=b.mixin(d,{sourceURL:b.trim(this._imageUrl.get("value")),linkURL:b.trim(this._imageLink.get("value"))});else{var k=this._fieldInfosStore,l=[];k.fetch({sort:[{attribute:"_pos",descending:!1}],onItem:b.hitch(this,function(b){!0===k.getValue(b,"_inChart")&&(l.push(k.getValue(b,"fieldName")),
k.setValue(b,"_inChart",!1))})});d=b.mixin(d,{fields:l});e=this._mediaNormalizeSelect.get("value");d=b.mixin(d,{normalizeField:"_none"!==e?e:null});e=this._mediaTooltipSelect.get("value");d=b.mixin(d,{tooltipField:"_none"!==e?e:null})}a.setValue(c,"value",d);a.save({onComplete:b.hitch(this,function(){this._loadSelect(a,a.getIdentity(c),!1,this._mediaSelect);this._loadFieldSelects()})})},_onShowSortOptions:function(a){var c=[];a.preventDefault();this._createSortFieldsGrid();this._sortOptionsDlg.show();
var d=b.connect(this._sortOptionsDlg,"hide",b.hitch(this,function(a){d.remove();this._fieldsGridStore.query(b.hitch(this,function(b){"none"!==b.sortField&&"none"!==b.sortOrder&&c.push({field:b.sortField,order:b.sortOrder})}));this._orderByFields=c;this._fieldsGrid.destroyRecursive();this._fieldsGrid=null}))},_createSortFieldsGrid:function(){if(!this._fieldsGrid){var a=this._relatedInfo||[],c=[],d,e,f,g=this.popupInfo.relatedRecordsInfo&&this.popupInfo.relatedRecordsInfo.orderByFields||[],k=b.hitch(this,
function(b,a){b.sortField=a}),l=[{field:"name",label:this.i18n.relatedData,renderCell:b.hitch(this,function(a,c,d,e){a=b.create("span",{title:a.name,innerHTML:a.name});return b.place(a,d)})},{field:"sortField",label:this.i18n.field,autoSave:!0,renderCell:b.hitch(this,function(a,c,d,e){a=new h.form.Select({onChange:b.hitch(this,k,a),maxHeight:150,style:"width:150px;max-width:150px;text-overflow:ellipsis;",options:a.fieldOptions});d.widget=a;return b.place(a.domNode,d)})},dgrid.editor({autoSave:!0,
field:"sortOrder",label:this.i18n.order,editorArgs:{options:[{label:this.i18n.none,value:"none"},{label:this.i18n.asc,value:"asc"},{label:this.i18n.desc,value:"desc"}],maxHeight:150,style:"width:150px;max-width:150px;overflow:hidden;"}},h.form.Select)];this._fieldsGridStore||(b.forEach(a,b.hitch(this,function(a,k){d=e=null;a&&(f=b.map(a.relatedFields,function(a){return{label:a.alias,value:a.name,selected:b.some(g,function(b){return b.field===a.name?(d=b.order,e=a.name,!0):!1})}}),c.push({id:k,name:a.layerInfo&&
a.layerInfo.name,fieldOptions:f,sortField:e||f[0].value||null,sortOrder:d||"none"}))})),this._fieldsGridStore=new b.store.Observable(new b.store.Memory({idProperty:"id",data:c})));this._fieldsGrid=new (b.declare([dgrid.Grid,dgrid.OnDemandGrid,dgrid.extensions.DijitRegistry]))({columns:l,store:this._fieldsGridStore,highlightDuration:0,maintainOddEven:!1,id:"_sortOptionsGrid",showLoadingMessage:!1,showHeader:!0,selectionMode:"none",className:".dgrid-autoheight"},b.create("div",{},this._sortOptionsGridDiv));
this._fieldsGrid.startup();b.aspect.before(this._fieldsGrid,"removeRow",b.hitch(this,function(b){(b=(b=this._fieldsGrid.cell(b).element)&&(b.contents||b).widget)&&b.destroyRecursive()}))}},_onClose:function(a,c){c.preventDefault();b.byId("popupBuilderContentPane").scrollTop=0;a&&this.save();arcgisonline.map.leftPanel.openLeftTOCPanel()},_init:function(){this.popupInfo={};this._customAttributeEditor=new h.Editor({id:"item-description-edit",plugins:["bold","italic","underline","foreColor","hiliteColor",
"|","justifyLeft","justifyCenter","justifyRight","justifyFull","|","insertOrderedList","insertUnorderedList","indent","outdent","|","createEsriLink","unlink","insertImage","removeFormat","|","undo","redo","|","viewsource",{name:"dijit._editor.plugins.FontChoice",command:"fontName",custom:"Arial;Courier New;Garamond;Tahoma;Times New Roman;Verdana".split(";")},{name:"dijit._editor.plugins.FontChoice",command:"fontSize",custom:["2","3","4","5","6"]},{name:"dijit._editor.plugins.EnterKeyHandling",blockNodeForEnter:"br"}],
trim:"true",style:"border:1px solid #CCCCCC;height:200px;"},this._customFieldEditor);this._popupBuilderLayerName.innerHTML=arcgisonline.map.main.getLayerTitle(this.mapLayer,this.subLayerId);this._isImageServiceLayer(this.mapLayer.layer)&&(this._showNoDataRecordsCheckbox=new h.form.CheckBox({checked:!1},this._noDataHandlerDiv),b.html.set(this._noDataHandlerText,this.i18n.showNoDataRecordsText));if(this.layerInfo&&this.layerInfo.editFieldsInfo){var a=[],c;for(c in this.layerInfo.editFieldsInfo)a.push(this.layerInfo.editFieldsInfo[c]);
this._editorTrackingFields=a.join(",")}if(arcgisonline.map.featColl.isFeatureCollection(this.mapLayer)||this.mapLayer.layer instanceof esri.layers.CSVLayer){if(this.mapLayer.layers||this.mapLayer.tables){c=this.mapLayer.layers;this.mapLayer.tables&&(c=c.concat(this.mapLayer.tables));for(a=0;a<c.length;a++)if(a===this.subLayerId){this.popupInfo=c[a].__popupInfo?c[a].__popupInfo:c[a].toJson().popupInfo;this._curLayer=c[a];break}}else this.popupInfo=this.mapLayer.popupInfo?this.mapLayer.popupInfo:this.mapLayer.layer.toJson().popupInfo,
this._curLayer=this.mapLayer.layer;this.popupInfo||(this.popupInfo={})}else if(!this.subLayerId&&0!==this.subLayerId)this.popupInfo=this.mapLayer.popupInfo?this.mapLayer.popupInfo:{},this._curLayer=this.mapLayer.layer;else if(this._thematicGroupLayerIds){c=this._thematicGroupLayerIds[0];for(a=0;a<this.mapLayer.itemLayers.length;a++){var d=this.mapLayer.itemLayers[a];if(d.id===c){this.popupInfo=d.popupInfo;break}}this.popupInfo||(this.popupInfo={})}else if(this.mapLayerFS=arcgisonline.map.main.getFlForMSL(this.mapLayer,
this.subLayerId))this.popupInfo=this.mapLayerFS.popupInfo?this.mapLayerFS.popupInfo:{},this._curLayer=this.mapLayerFS.layer;else{if(this.mapLayer.itemLayers)for(a=0;a<this.mapLayer.itemLayers.length;a++)this.mapLayer.itemLayers[a].id==this.subLayerId&&(this.popupInfo=this.mapLayer.itemLayers[a].popupInfo);this.mapLayer.layersInfo&&(!this.mapLayer.layer.dynamicLayerInfos&&this.mapLayer.layer.version&&10.1<=this.mapLayer.layer.version)&&(this._curLayer=this.mapLayer.layersInfo.layers[this.subLayerId],
this._curLayer.__url=this.mapLayer.url+"/"+this.subLayerId,this._curLayer.version||(this._curLayer.__version=this.mapLayer.layer.version));this.popupInfo||(this.popupInfo={})}this._origPopupInfoJson=this.popupInfo?b.json.stringify(this.popupInfo):"";var e;if(this._curLayer&&this._curLayer.relationships&&0<this._curLayer.relationships.length&&(this._curLayer.__version&&10.1<=this._curLayer.__version||this._curLayer.version&&10.1<=this._curLayer.version))this._relatedInfo=this._curLayer._relatedInfo||
[],0===this._relatedInfo.length&&(e=this._getRelatedFieldsInfo());syncAsyncObj=e&&0<e.length?new b.promise.all(e):"sync";b.when(syncAsyncObj,b.hitch(this,this._populatePopupBuilder))},_populatePopupBuilder:function(){if(this.mapLayer.layer)this._isEditable=this.mapLayerFS?this.mapLayerFS.layer.isEditable?this.mapLayerFS.layer.isEditable():!1:this.mapLayer.layer.isEditable?this.mapLayer.layer.isEditable():!1;else{var a=this.mapLayer.layers;this.mapLayer.tables&&(a=a.concat(this.mapLayer.tables));this._isEditable=
a[this.subLayerId].isEditable?a[this.subLayerId].isEditable():!1}this._displayField=this.getDisplayField();if(esri.isDefined(this.popupInfo.title))this._title.set("value",this.popupInfo.title);else{var a=this._layer.name?this._layer.name:this.mapLayer.title,c=this._displayField?this._formatToken(this._displayField):"";this._title.set("value",a+(c?":":"")+c)}var d=b.clone(this._layer.fields),e=!1,f=!1,g=!1;this._isImageServiceLayer(this.mapLayer.layer)&&(d=this.mapLayer.layer.getCustomRasterFields({rasterAttributeTableFieldPrefix:"Raster."}),
g=0>b.indexOf(["F32","F64"],this.mapLayer.layer.pixelType),f=(e=this.mapLayer.layer.capabilities&&-1<this.mapLayer.layer.capabilities.toLowerCase().indexOf("catalog")||this.mapLayer.layer.fields&&0<this.mapLayer.layer.fields.length)&&("esriImageServiceDataTypeVector-UV"===this.mapLayer.layer.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.mapLayer.layer.serviceDataType));!d&&(this.mapLayer.layer.dynamicLayerInfos&&this._layer.source)&&b.forEach(this.mapLayer.layersInfo.layers,function(b){b.id==
this._layer.source.mapLayerId&&(d=b.fields)},this);var k=this.popupInfo.fieldInfos;this.mapLayer.thematicGroup&&(this.mapLayer.thematicGroup.fieldNames&&this.mapLayer.thematicGroup.fieldNames.length)&&(d=b.filter(d,function(a){return b.some(this.mapLayer.thematicGroup.fieldNames,function(b){return b===a.name},this)},this));var l=[],m=0,n,q={esriFieldTypeDouble:1,esriFieldTypeSingle:1},s={esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1},t={esriFieldTypeDate:1};this._curLayer&&this._relatedInfo&&
(this._curLayer._relatedInfo=this._relatedInfo,b.forEach(this._relatedInfo,function(a){a&&(b.forEach(a.relatedFields,function(b){d.push(b)},this),("esriRelCardinalityOneToMany"===a.relation.cardinality||"esriRelCardinalityManyToMany"===a.relation.cardinality||"esriRelCardinalityManyToOne"===a.relation.cardinality)&&this._relatedLayerInput.addOption({value:a.relation.id,label:a.layerInfo.name}))},this));k&&k.length?b.forEach(d,b.hitch(this,function(a,c){var d,e,f,g="";d=b.some(k,b.hitch(this,function(b,
c){m=c;return a.name===b.fieldName}));-1!==a.name.indexOf(this._relatedFieldPrefix)&&(e=this._fromRelatedFieldName(a.name),e=e[0]);e&&(f=this._relatedInfo[e].layerInfo.name,g=this._relatedInfo[e].relation.cardinality);if(d){n=k[m];var h=b.mixin({},n),h=b.mixin(h,{isEditable:!1===a.editable?!1:esri._isDefined(n.isEditable)?n.isEditable:a.editable});h.isEditable=h.isEditable&&!esri.isDefined(f);h.isEditableOnLayer=a.editable;esri.isDefined(n.format)&&(h=b.mixin(h,{format:b.json.stringify(n.format)}));
h.label=h.label||a.alias;d=esri.isDefined(a.domain)?a.domain&&"codedvalue"==a.domain.type.toLowerCase():!1;l.push(b.mixin({_fieldType:a.type,_hasDomain:d,_pos:m,_inChart:!1,statisticType:a.statisticType,_relateName:f,_cardinality:g,_relatedId:e?e:"-1"},h))}else{d=esri.isDefined(a.domain)?a.domain&&"codedvalue"==a.domain.type.toLowerCase():!1;h=null;d||(a.type in s?h=this._numberFormats[0].value:a.type in q?h=this._numberFormats[2].value:a.type in t&&10<=this.mapLayer.layer.version&&(h=this._dateFormats[4].value));
var p="esriFieldTypeString"===a.type||d?"textbox":null;l.push({fieldName:a.name,label:a.alias,isEditable:a.editable&&!esri.isDefined(f)||!1,isEditableOnLayer:a.editable,tooltip:null,visible:!1,format:h,stringFieldOption:p,_fieldType:a.type,_hasDomain:d,_pos:9999,_inChart:!1,statisticType:a.statisticType,_relateName:f,_cardinality:g,_relatedId:e?e:"-1"})}})):l=b.map(d,b.hitch(this,function(a,c){var d=a.name.toLowerCase(),k=esri.isDefined(a.domain)?a.domain&&"codedvalue"==a.domain.type.toLowerCase():
!1,h={subclass:0,rings_ok:0,rings_nok:0},l,n,m="";-1!==a.name.indexOf(this._relatedFieldPrefix)&&(l=this._fromRelatedFieldName(a.name),l=l[0]);l&&(n=this._relatedInfo[l].layerInfo.name,m=this._relatedInfo[l].relation.cardinality);e&&(h["raster.servicepixelvalue"]=0,f&&(h["raster.magnitude"]=0,h["raster.direction"]=0));var p="esriFieldTypeOID"!==a.type&&"esriFieldTypeGlobalID"!==a.type&&"esriFieldTypeGeometry"!==a.type,p=(p=p&&!(d in h)&&!(-1<d.indexOf("area")||-1<d.indexOf("length")||-1<d.indexOf("perimeter")||
-1<d.indexOf("raster.servicepixelvalue.")))&&d.lastIndexOf("_i",d.length-2)!==d.length-2,h=null;k||(a.type in s?h=this._numberFormats[0].value:a.type in q?h=g&&(-1<d.indexOf("raster.servicepixelvalue")||-1<d.indexOf("raster.itempixelvalue"))?this._numberFormats[0].value:this._numberFormats[2].value:a.type in t&&10<=this.mapLayer.layer.version&&(h=this._dateFormats[4].value));d="esriFieldTypeString"===a.type||k?"textbox":null;return b.mixin({},{fieldName:a.name,label:a.alias,isEditable:a.editable&&
!esri.isDefined(n)||!1,isEditableOnLayer:a.editable,tooltip:null,visible:p,format:h,stringFieldOption:d,_pos:c,_inChart:!1,_hasDomain:k,_fieldType:a.type,_editable:a.editable,statisticType:a.statisticType,_relateName:n,_cardinality:m,_relatedId:l?l:"-1"})}));this._fieldInfosStore=new r.data.AndOrWriteStore({data:{label:"fieldName",identifier:"fieldName",items:l}});var u={esriFieldTypeDouble:1,esriFieldTypeSingle:1,esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1};this._hasNumericField=b.some(l,
b.hitch(this,function(a){return a.fieldName===this._layer.typeIdField?!1:a._fieldType in u?!0:!1}));this._hasDateField=b.some(l,b.hitch(this,function(a){return a.fieldName===this._layer.typeIdField?!1:a._fieldType in u?!0:!1}));var p=this.popupInfo.description,v;p&&p.length?(m=p.indexOf("}"),a=p.indexOf("{"),c=p.indexOf("{",1),m===p.length-1&&0===a&&-1===c?(this._descriptionType.set("value","_oneField"),this._fieldInfosStore.fetch({query:{fieldName:p.substring(1,p.length)},onComplete:b.hitch(this,
function(a){if(a&&a.length&&(v=this._fieldInfosStore.getIdentity(a[0]),a=this._fieldInfosStore.getValue(a[0],"_fieldType"),"esriFieldTypeOID"===a||"esriFieldTypeGeometry"===a))this._descriptionType.set("value","_customField"),this._customAttributeEditor.set("value",p,!0)})})):(this._descriptionType.set("value","_customField"),this._customAttributeEditor.set("value",p,!0))):(a=k&&k.length?b.some(k,"return item.visible \x3d\x3d\x3d true"):!0,this._descriptionType.set("value",a?"_fieldAttributes":"_none"));
if(this._relatedInfo&&this._relatedInfo.length||this.popupInfo&&this.popupInfo.relatedRecordsInfo)b.some(this._relatedInfo,function(a){return(a=(a=a&&a.relatedLayerUrl)&&arcgisonline.map.popup._findRelatedTable(a))&&(a.selMapTable||a.tableId)}),this._showRelatedData.set("checked",this.popupInfo&&this.popupInfo.relatedRecordsInfo?this.popupInfo.relatedRecordsInfo.showRelatedRecords:!0),esri.show(this.relatedData);this._showAttachments.set("checked",this.popupInfo?this.popupInfo.showAttachments:!1);
this._layer.hasAttachments||(esri.hide(this._showAttachments.domNode),esri.hide(this._showAttachmentsLabel));this._showNoDataRecordsCheckbox&&this._showNoDataRecordsCheckbox.set("checked",this.popupInfo.layerOptions&&this.popupInfo.layerOptions.hasOwnProperty("showNoDataRecords")?!this.popupInfo.layerOptions.showNoDataRecords:!1);this._fieldInfosStore.getLabel=b.hitch(this,"_getFieldSelectLabel");this._createFieldAttributesGrid();this._changeFieldsGrid.set("formatterScope",this);this._changeFieldsGrid.setStore(this._fieldInfosStore,
"NOT (_fieldType:'esriFieldTypeGeometry')");this._singleFieldSelect.setStore(this._fieldInfosStore,v,{query:"NOT _fieldType:'esriFieldTypeOID' AND NOT _fieldType:'esriFieldTypeGeometry'"});this._mediaFieldsGrid.set("formatterScope",this);this._mediaFieldsGrid.setStore(this._fieldInfosStore,"(_cardinality:'esriRelCardinalityOneToOne' OR _cardinality:'') AND (_fieldType:'esriFieldTypeDouble' OR _fieldType:'esriFieldTypeSingle' OR _fieldType:'esriFieldTypeInteger' OR _fieldType:'esriFieldTypeSmallInteger')");
this._mediaInfoStore=new r.data.AndOrWriteStore({data:{label:"title",items:[]}});this._mediaInfoStore.getLabel=b.hitch(this,function(a){return this._mediaInfoStore.getValue(a,"title")||this.i18n.untitled+" "+this._mediaInfoStore.getValue(a,"_displayTitle")});this._mediaSelect.set("value",[]);if(this.popupInfo.mediaInfos&&this.popupInfo.mediaInfos.length){var w=1;b.forEach(this.popupInfo.mediaInfos,b.hitch(this,function(a,d){var c=b.mixin(a,{_visible:!0,_pos:d});if(!c.title||!c.title.length)c._displayTitle=
w,w++;this._mediaInfoStore.newItem(c)}));this._mediaInfoStore.save()}this._customAttributeSelect=new h.form.MultiSelect;this._customAttributeEditor._started||this._customAttributeEditor.startup();this._customAttributeEditor.addPlugin(new arcgisonline.map.dijit.AddFieldPlugin({command:"addField",select:this._customAttributeSelect,store:this._fieldInfosStore}));this._loadFieldSelects();this.popupInfo.mediaInfos&&this.popupInfo.mediaInfos.length&&this._loadSelect(this._mediaInfoStore,0,!1,this._mediaSelect);
this._loadConnections();this.adjustHeight()},_getRelatedFieldsInfo:function(){var a=[],c;if((c=this._curLayer.url||this._curLayer.__url)&&0<this._curLayer.relationships.length)b.forEach(this._curLayer.relationships,function(a,b){a&&(this._relatedInfo[a.id]||(this._relatedInfo[a.id]={relation:a}))},this),b.forEach(this._relatedInfo,function(d,e){var f,g,h;d&&(f=d.relation,g=c.replace(/[0-9]+$/,f.relatedTableId),c.match(/[0-9]+$/g),h=new b.Deferred,a[e]=h,esri.request({url:g,content:{f:"json"}}).then(b.hitch(this,
function(a){var c=b.clone(a.fields);b.forEach(c,function(a){a.name=this._toRelatedFieldName([e,a.name]);a.alias=a.alias;if("esriRelCardinalityOneToMany"===f.cardinality||"esriRelCardinalityManyToMany"===f.cardinality)b.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],a.type),a.statisticType="count"},this);d.relatedFields=c;d.layerInfo=a;d.relatedLayerUrl=g;h.resolve(c)}),b.hitch(this,function(a){h.reject(a);console.log(a)})))},this);return a},
_fromRelatedFieldName:function(a){var b=[];-1!==a.indexOf(this._relatedFieldPrefix)&&(a=a.split("/"),b=a.slice(1));return b},_toRelatedFieldName:function(a){var b="";a&&0<a.length&&(b=this._relatedFieldPrefix+a[0]+"/"+a[1]);return b},_createFieldAttributesGrid:function(){var a=[{editable:!1,hidden:!0,field:"_pos",width:"10px",style:{display:"none"}},{field:"visible",name:"\x3cinput id\x3d'_changeFieldsGrid_checkAll' style\x3d'vertical-align:middle;' type\x3d'checkbox'/\x3e\x26nbsp;"+this.i18n.display,
width:"120px",editable:!0,type:r.grid.cells.Bool},{formatter:b.hitch(this,"_getIsEditableCheckbox"),hidden:!0,width:"80px",field:"isEditable",name:"\x3cinput id\x3d'_changeFieldsGrid_editAll' style\x3d'vertical-align:middle;' type\x3d'checkbox'/\x3e\x26nbsp;"+this.i18n.allowEdits},{editable:!1,field:"fieldName",width:"130px",formatter:"_formatToken",name:this.i18n.fieldName},{editable:!0,width:"150px",field:"label",name:this.i18n.fieldAlias}],c=this._changeFieldsGrid=new r.grid.DataGrid({sortInfo:1,
selectionMode:"single",singleClickEdit:!0,autoWidth:!0,"class":"_popupGrid",keepSelection:!0},this._changeFieldsGridDiv);c.set("structure",a);c.startup();9>b.isIE&&b.style(this._changeFieldsDlg.domNode,{width:this._isEditable?"720px":"650px"});b.query(".popupFormat, .format").forEach(esri.hide);b.style(this._statsFieldSet,"display","none");this._isEditable&&(c.layout.setColumnVisibility(2,this._isEditable),b.byId("_changeFieldsTitle").innerHTML=this.i18n.checkFieldsForEdit);this._connect(c,"onSelectionChanged",
b.hitch(this,function(a){this._showIsEditable(c)}));this._connect(c,"onRowClick",b.hitch(this,function(a){if("isEditable"===a.cell.field&&"INPUT"===a.target.tagName){var e=this._getFormatter(c.selection.getSelected()[0]);this._fieldInfosStore.setValue(c.getItem(a.rowIndex),"isEditable",a.target.checked);a.target.checked?(this._fieldInfosStore.setValue(c.getItem(a.rowIndex),"visible",a.target.checked),("formatString"===e||"formatDomain"===e)&&b.query("."+e+",.popupFormat, .formatHint").forEach(esri.show)):
("formatString"===e||"formatDomain"===e)&&b.query("."+e+",.popupFormat, .formatHint").forEach(esri.hide);this._fieldInfosStore.save()}}));this._connect(c,"onHeaderCellClick",b.hitch(this,function(a){"isEditable"===a.cell.field&&"INPUT"===a.target.tagName?this._fieldInfosStore.fetch({onItem:b.hitch(this,function(b){var c=a.target.checked,g=this._fieldInfosStore.getValue(b,"_fieldType"),h=this._fieldInfosStore.getValue(b,"fieldName"),l=this._fieldInfosStore.getValue(b,"_editable"),m=this._fieldInfosStore.getValue(b,
"_relateName"),g=(g=(g=esri.isDefined(l)&&!l||"esriFieldTypeOID"===g||"esriFieldTypeGlobalID"===g||"esriFieldTypeGeometry"===g)||-1!==this._editorTrackingFields.indexOf(h))||esri.isDefined(m);g||(this._fieldInfosStore.setValue(b,a.cell.field,c),c&&this._fieldInfosStore.setValue(b,"visible",c))}),onComplete:b.hitch(this,function(){this._showIsEditable(c)})}):this._onChangeFieldsGridCheckAll(this._fieldInfosStore,"{_fieldType:'*'}",null,a)}));this._connect(this._formatDateSelect,"onChange",b.hitch(this,
"_setFormatter","dateFormat"));this._connect(this._formatTimeSelect,"onChange",b.hitch(this,"_setFormatter","dateFormat",null));this._connect(this._formatNumberSelect,"onChange",b.hitch(this,"_setFormatter","places"));this._connect(this._formatNumberCheck,"onChange",b.hitch(this,"_setFormatter","digitSeparator"));this._connect(this._formatStringSelect,"onChange",b.hitch(this,"_setAttribute","stringFieldOption"));this._connect(this._formatTooltip,"onChange",b.hitch(this,"_setAttribute","tooltip"));
this._connect(this._statsTypeSelect,"onChange",b.hitch(this,"_setAttribute","statisticType"));this._connect(this._formatTimeCheck,"onChange",b.hitch(this,function(){var a=this._formatTimeCheck.get("checked");b[!a?"addClass":"removeClass"](this._formatTimeSelect.domNode,"hide");this._setFormatter("dateFormat")}))},_showIsEditable:function(a){var c=a.selection.getSelected()[0],d=!1,e;c&&(e=this._getFormatter(a.selection.getSelected()[0]),b.query(".popupFormat, .format").forEach(esri.hide),e&&(d=this._isEditable&&
this._fieldInfosStore.getValue(a.selection.getSelected()[0],"isEditable"),"formatString"===e||"formatDomain"===e?d&&(b.query("."+e+",.popupFormat, .formatHint").forEach(esri.show),b.attr(this._legendTitle,"innerHTML",this.i18n.editing)):(b.query("."+e+",.popupFormat").forEach(esri.show),b.attr(this._legendTitle,"innerHTML",this.i18n.formatFields),d&&b.query(".formatHint").forEach(esri.show))),a=this._fieldInfosStore.getValue(c,"_cardinality"),"esriRelCardinalityOneToMany"===a||"esriRelCardinalityManyToMany"===
a?(b.style(this._statsFieldSet,"display","block"),c._fieldType&&(0<c._fieldType.length&&c._fieldType[0])&&(a=-1!==b.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],c._fieldType[0]),this._updateStatsSelect(a)),c.statisticType&&this._statsTypeSelect.set("value",c.statisticType)):b.style(this._statsFieldSet,"display","none"))},_setFormatter:function(a,c){var d=this._changeFieldsGrid.selection.getSelected()[0],e=b.json.parse(this._fieldInfosStore.getValue(d,
"format"));b.query(".formatTime").addClass("hide");if("dateFormat"===a){var f=c||this._formatDateSelect.get("value"),g=f in this._supportsTime,h=g&&this._formatTimeCheck.get("checked")?this._formatTimeSelect.get("value"):"";b.query(".formatTime").removeClass("hide");this._enableUpdateTime(g);e[a]=f+h}else e[a]="places"===a?parseInt(c):c;this._onFormatChange(d,"format",b.json.stringify(e))},_setAttribute:function(a,b){var d=this._changeFieldsGrid.selection.getSelected()[0];this._onFormatChange(d,a,
b)},_loadFieldSelects:function(){this._loadSelect(this._fieldInfosStore,null,!1,this._attributesSelect);b.forEach([this._imageLinkSelect,this._mediaCaptionSelect,this._imageUrlSelect,this._titleFieldsSelect,this._customAttributeSelect,this._mediaTitleSelect],b.hitch(this,"_loadSelect",this._fieldInfosStore,null,!0),this)},_getFieldSelectLabel:function(a){return arcgisonline.sharing.util.htmlEncode(this._fieldInfosStore.getValue(a,"label"))+" "+this._formatToken(this._fieldInfosStore.getValue(a,"fieldName"))},
_loadSelect:function(a,c,d,e){this._resetSelect(e);a.fetch({sort:[{attribute:"_pos",descending:!1}],onItem:b.hitch(this,function(c){var g=a.getValue(c,"visible")||a.getValue(c,"_visible"),h="esriFieldTypeGeometry"===a.getValue(c,"_fieldType"),l=a.getValue(c,"_relateName"),m=a.getValue(c,"visible"),n=a.getValue(c,"_cardinality"),q;l&&(q=b.query("optGroup[label\x3d'"+l+"']",e.containerNode),0<q.length?q=q[0]:(q=b.create("optGroup"),b.attr(q,"label",l),b.place(q,e.containerNode)));if(!h&&(d||!0===g)&&
(!n||n&&"esriRelCardinalityOneToOne"===n||n&&("esriRelCardinalityOneToMany"===n||"esriRelCardinalityManyToMany"===n)&&!0===m))g=b.create("option"),g.innerHTML=a.getLabel(c),g.value=a.getIdentity(c),q?b.place(g,q):b.place(g,e.containerNode)}),onComplete:b.hitch(this,function(a){esri.isDefined(c)&&e.set("value",[c])})})},_loadConnections:function(){this._connect(h.byId("leftContentPanel"),"resize",b.hitch(this,"adjustHeight"));this._connect(this._customFieldBtn,"onClick",b.hitch(this._customFieldDlg,
"show"));this._connect(this._mediaFieldsGrid,"onHeaderCellClick",b.hitch(this,"_onChangeFieldsGridCheckAll",this._fieldInfosStore,"_fieldType:'esriFieldTypeDouble' OR _fieldType:'esriFieldTypeSingle' OR _fieldType:'esriFieldTypeInteger' OR _fieldType:'esriFieldTypeSmallInteger'","_inChart"));this._changeFieldsGrid.canSort=b.hitch(this,function(a){return 1===a||-1===a});this._mediaFieldsGrid.canSort=b.hitch(this,function(a){return 2!==a&&-2!==a});this._connect(this._attributesSelectUp,"onClick",b.hitch(this,
"_onMoveSelectItem",this._fieldInfosStore,this._attributesSelect,-1,null));this._connect(this._attributesSelectDown,"onClick",b.hitch(this,"_onMoveSelectItem",this._fieldInfosStore,this._attributesSelect,1,null));this._connect(this._fieldsSelectUp,"onClick",b.hitch(this,"_onMoveGridItem",this._fieldInfosStore,this._changeFieldsGrid,-1,null));this._connect(this._fieldsSelectDown,"onClick",b.hitch(this,"_onMoveGridItem",this._fieldInfosStore,this._changeFieldsGrid,1,null));this._connect(this._mediaSelectUp,
"onClick",b.hitch(this,"_onMoveSelectItem",this._mediaInfoStore,this._mediaSelect,-1,null));this._connect(this._mediaSelectDown,"onClick",b.hitch(this,"_onMoveSelectItem",this._mediaInfoStore,this._mediaSelect,1,null));this._connect(this._titleFieldsSelect,"onChange",b.hitch(this,"_onTitleSelectChange",this._title,this._titleFieldsSelect));this._connect(this._imageUrlSelect,"onChange",b.hitch(this,"_onTitleSelectChange",this._imageUrl,this._imageUrlSelect));this._connect(this._mediaCaptionSelect,
"onChange",b.hitch(this,"_onTitleSelectChange",this._mediaCaption,this._mediaCaptionSelect));this._connect(this._imageLinkSelect,"onChange",b.hitch(this,"_onTitleSelectChange",this._imageLink,this._imageLinkSelect));this._connect(this._addMediaImage,"onClick",b.hitch(this,"_onAddMedia",{title:this.i18n.image,type:"image",caption:"",value:{sourceURL:null,linkURL:null}}));this._connect(this._addMediaPieChart,"onClick",b.hitch(this,"_onAddMedia",{title:this.i18n.pieChart,type:"piechart",caption:"",value:{fields:[]}}));
this._connect(this._addMediaBarChart,"onClick",b.hitch(this,"_onAddMedia",{title:this.i18n.barChart,type:"barchart",caption:"",value:{fields:[]}}));this._connect(this._addMediaColumnChart,"onClick",b.hitch(this,"_onAddMedia",{title:this.i18n.columnChart,type:"columnchart",caption:"",value:{fields:[]}}));this._connect(this._addMediaLineChart,"onClick",b.hitch(this,"_onAddMedia",{title:this.i18n.lineChart,type:"linechart",caption:"",value:{fields:[]}}));this._connect(this._mediaDelete,"onClick",b.hitch(this,
"_onDeleteMedia"));this._connect(this._mediaProperties,"onClick",b.hitch(this,"_onShowMediaSettingsDlg"));this._connect(this._mediaConfigDlg,"execute",b.hitch(this,"_onSaveMediaConfig"));this._connect(this._mediaTitleSelect,"onChange",b.hitch(this,"_onTitleSelectChange",this._mediaTitle,this._mediaTitleSelect));this._connect(this._mediaSelect,"onDblClick",b.hitch(this,"_onShowMediaSettingsDlg"));this._connect(this._savePopup,"onClick",b.hitch(this,"_onClose",!0));this._connect(this._closeBtn,"onclick",
b.hitch(this,"_onClose",!1));this._connect(this._cancelPopup,"onClick",b.hitch(this,"_onClose",!1));this._relatedChartFieldInput.watch("value",b.hitch(this,this._handleRelatedChartValueChange));this._connect(this._sortOptionsBtn,"onClick",b.hitch(this,"_onShowSortOptions"))},_connect:function(a,c,d){this._pbConnects.push(b.connect(a,c,d))},_resetSelect:function(a){for(a=a.containerNode||a;a.hasChildNodes();)a.removeChild(a.lastChild)},_formatToken:function(a){return a&&a.length?"{"+a+"}":""},_getItemFromStore:function(a,
b,d){a.fetchItemByIdentity({identity:b,onItem:d})},_getFormatter:function(a){if(!a)return"";var c={esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1},d={esriFieldTypeSingle:1,esriFieldTypeDouble:1},e=this._fieldInfosStore.getValue(a,"_fieldType");b.query(".formatTime").addClass("hide");if("esriFieldTypeDate"===e&&this.mapLayer&&this.mapLayer.layer&&10>this.mapLayer.layer.version)return"";if(this._fieldInfosStore.getValue(a,"_hasDomain"))return"formatDomain";this._formatTooltip.set("value",this._fieldInfosStore.getValue(a,
"tooltip"),!1);if("esriFieldTypeString"===e)return this._formatStringSelect.set("value",this._fieldInfosStore.getValue(a,"stringFieldOption"),!1),"formatString";a=this._fieldInfosStore.getValue(a,"format");var f;a&&(f=b.json.parse(a));return f&&(e in d||e in c)?(e in d&&this._formatNumberSelect.set("value",f.places,!1),this._formatNumberCheck.set("value",f.digitSeparator,!1),e in d?"formatNumber":"formatInteger"):f&&"esriFieldTypeDate"===e?(b.query(".formatTime").removeClass("hide"),-1<f.dateFormat.indexOf("LETime")?
(this._formatDateSelect.set("value","shortDateLE",!1),this._formatTimeCheck.set("checked",!0),this._formatTimeSelect.set("value",f.dateFormat.split("shortDateLE")[1],!1),this._enableUpdateTime(!0)):-1<f.dateFormat.indexOf("Time")?(this._formatDateSelect.set("value","shortDate",!1),this._formatTimeCheck.set("checked",!0),this._formatTimeSelect.set("value",f.dateFormat.split("shortDate")[1],!1),this._enableUpdateTime(!0)):(this._formatDateSelect.set("value",f.dateFormat,!1),this._enableUpdateTime(f.dateFormat in
this._supportsTime)),"formatDate"):""},_enableUpdateTime:function(a){this._formatTimeCheck.get("checked");this._formatTimeCheck.set("disabled",!a);b[!a?"addClass":"removeClass"](this.timeCheckboxLbl,"disabled");a||this._formatTimeCheck.set("checked",!1)},_getIsEditableCheckbox:function(a,b,d){var e=this._changeFieldsGrid.getItem(b);d=this._fieldInfosStore.getValue(e,"_fieldType");a=this._fieldInfosStore.getValue(e,"isEditable");var f=this._fieldInfosStore.getValue(e,"isEditableOnLayer"),g=this._fieldInfosStore.getValue(e,
"_editable");b=this._fieldInfosStore.getValue(e,"fieldName");e=this._fieldInfosStore.getValue(e,"_relateName");d=(d=!1===f||esri.isDefined(g)&&!g||"esriFieldTypeOID"===d||("esriFieldTypeGlobalID"===d||"esriFieldTypeGeometry"===d)||esri.isDefined(e))||-1!==this._editorTrackingFields.indexOf(b)||(arcgisonline.map.featColl.isFeatureCollection(this.mapLayer)||this.mapLayer.layer instanceof esri.layers.CSVLayer)&&"fid"===b.toLowerCase();return'\x3cinput class\x3d"dojoxGridInput" type\x3d"checkbox"'+(a?
' checked\x3d"checked" ':"")+(d?'disabled\x3d"true" ':"")+'style\x3d"width: auto" /\x3e'},_getIsVisibleCheckbox:function(a,b,d){return this._getCheckbox(a,b,d,"visible",!1,!0)},_getInChartCheckbox:function(a,b,d){d.customClasses.push("popupGridCenterCell");return this._getCheckbox(a,b,d,"_inChart",!1,!1)},_getCheckbox:function(a,c,d,e,f,g){c=this._fieldInfosStore.getValue(a,e);g=esri.isDefined(c)?c:g;f=new h.form.CheckBox({name:"checkBox",checked:g,disabled:f});this._connect(f,"onChange",b.hitch(this,
"_onFormatChange",a,e));return f},_getRichTextSelect:function(a,c,d){if("esriFieldTypeString"!==this._fieldInfosStore.getValue(a,"_fieldType"))return"";c=this._fieldInfosStore.getValue(a,"stringFieldOption");var e=this._fieldInfosStore.getValue(a,"_stringFieldSelect");e||(e=new h.form.Select({style:{width:"110px"}}),this._changeFieldsGrid.store.setValue(a,"_stringFieldSelect",e),this._changeFieldsGrid.store.save(),this._connect(e,"onChange",b.hitch(this,"_onFormatChange",a,"stringFieldOption")));
e.options=[];e.options.push({label:this.i18n.singleLine,value:"textbox"});e.options.push({label:this.i18n.multipleLine,value:"textarea"});e.options.push({label:this.i18n.richText,value:"richtext"});e.set("value",c||"textbox",!0);d.customClasses.push("popupGridCenterCell");return e},getChildren:function(){return this.containerNode?this.myDijitFindWidgets(this.containerNode):[]},myDijitFindWidgets:function(a){function c(a){if(9>b.isIE&&a.children||a.childNodes){a=9>b.isIE?a.children:a.childNodes;for(var f=
0,g;g=a[f++];)if(1===g.nodeType){var k=g.getAttribute("widgetId");k?(g=h.byId(k),d.push(g)):c(g)}}}var d=[];c(a);return d},loadContent:function(){setTimeout(function(){h.byId("popupPanel").adjustHeight()},100)},adjustHeight:function(a){if(!("undefined"==typeof leftPanel||"popupStack"!=leftPanel.visibleStack)){h.byId("popupBuilderContentBottom").resize();a=b.coords(b.byId("leftPanelDiv")).h;var c=b.coords(b.byId("popupBuilderContentHeader")).h,d=b.coords(b.byId("popupBuilderSiteFooter_links")).h+9,
e=b.coords(b.byId("popupBuilderContentButtonsCenter")).h;b.style(b.byId("popupBuilderContentFooter"),"height",d+"px");b.style(b.byId("popupBuilderContentButtons"),"height",e+"px");b.style(b.byId("popupBuilderContentBottom"),"height",e+d+16+"px");b.style(b.byId("popupBuilderContentPane"),"height",a-(c+d+e+32)+"px");a=b.coords(b.byId("leftContentStackContainer")).w-8;0<a&&(b.style(this._attributesSelect.domNode,"width",a-50+"px"),b.style(this._mediaSelect.domNode,"width",a-50+"px"),b.style(this._title.domNode,
"width",a-70+"px"))}},getDisplayField:function(){var a=this._layer.displayField;if(!this._displayField&&this._layer.fields)for(var b=0;b<this._layer.fields.length;b++){var d=this._layer.fields[b];if(-1<d.name.toLowerCase().indexOf("name")||-1<d.name.toLowerCase().indexOf("title"))a=d.name}return a},_updateStatsSelect:function(a){this._statsTypeSelect.removeOption(this._statsTypeSelect.getOptions());a?this._statsTypeSelect.addOption([{value:"count",label:this.i18n.count},{value:"sum",label:this.i18n.sum},
{value:"min",label:this.i18n.min},{value:"max",label:this.i18n.max},{value:"avg",label:this.i18n.avg},{value:"stddev",label:this.i18n.stddev}]):this._statsTypeSelect.addOption({value:"count",label:this.i18n.count})},_handleSameFieldBtnChange:function(a){a?(esri.show(this._mediaFieldsDiv),this._mediaFieldsGrid.update(),esri.hide(this._mediaRelatedFieldsDiv)):(esri.show(this._mediaRelatedFieldsDiv),esri.hide(this._mediaFieldsDiv));this._relatedChartFieldInput.get("value")&&this._updateRelatedChartField(this._relatedChartFieldInput.get("value"),
this._relatedFieldsBtn.get("checked"))},_handleRelatedLayerInputChange:function(a){this._relatedInfo&&this._relatedInfo[a]&&(this._relatedChartFieldInput.setStore(this._fieldInfosStore,null,{query:"(_relatedId:'"+a+"') AND (_cardinality:'esriRelCardinalityOneToMany' OR _cardinality:'esriRelCardinalityManyToMany') AND (NOT _fieldType:'esriFieldTypeOID' AND NOT _fieldType:'esriFieldTypeGeometry')"}),this._mediaTooltipSelect.setStore(this._fieldInfosStore,null,{query:"(_relatedId:'"+a+"') AND (_cardinality:'esriRelCardinalityOneToMany' OR _cardinality:'esriRelCardinalityManyToMany') AND (NOT _fieldType:'esriFieldTypeOID' AND NOT _fieldType:'esriFieldTypeGeometry')"}))},
_updateRelatedChartField:function(a,c){this._getItemFromStore(this._fieldInfosStore,a,b.hitch(this,function(a){a&&this._onFormatChange(a,"_inChart",c)}))},_handleRelatedChartValueChange:function(a,b,d){this._updateRelatedChartField(b,!1);this._updateRelatedChartField(d,!0)},_isImageServiceLayer:function(a){return a instanceof esri.layers.ArcGISImageServiceLayer||a instanceof esri.layers.ArcGISImageServiceVectorLayer}});b.mixin(arcgisonline.map.dijit.PopupBuilder,{MEDIA_TYPE_IMAGE:"image",MEDIA_TYPE_PIE_CHART:"piechart",
MEDIA_TYPE_BAR_CHART:"barchart",MEDIA_TYPE_COLUMN_CHART:"columnchart",MEDIA_TYPE_LINE_CHART:"linechart"})});