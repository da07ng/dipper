// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../../../core/declare dojo/_base/lang dojo/Deferred ../../../core/Accessor ../../../core/Promise ../../../core/urlUtils ../../../core/WebSocketConnector ../../../request ../../../kernel".split(" "),function(l,f,n,p,q,r,s,t,u){return l([p,q],{classMetadata:{computed:{url:["layerDefinition"],parsedUrl:["url"],connectionInfo:["layerDefinition"]}},getDefaults:function(c){var a=this.inherited(arguments),d=c.layer;d&&(a=f.mixin(a,{url:d.url,connectionInfo:{direction:d.socketDirection,socketUrl:d.socketUrl},
queryTask:null}));return a},initialize:function(){this.layerDefinition||this.addResolvingPromise(this._fetchLayer());this.addResolvingPromise(this._socketConnector)},_socketConnector:null,_connectionInfoGetter:function(){if(this.layer.hasMemorySource||this.layer.socketUrl)return{serviceSocketUrls:[this.layer.socketUrl]};var c={},a=this.layerDefinition,d=[],e=[],b=[],g,f,h;a.streamUrls&&a.streamUrls.forEach(function(a){"ws"===a.transport&&(d=a.urls,c.token=a.token)},this);d.forEach(function(a){0===
a.lastIndexOf("wss",0)?b.push(a):e.push(a)});if((a="https"===u.appUrl.scheme||0===this.url.lastIndexOf("https:",0)?b:0===e.length?b:e)&&1<a.length)for(g=0;g<a.length-1;g++)f=g+Math.floor(Math.random()*(a.length-g)),h=a[f],a[f]=a[g],a[g]=h;c.serviceSocketUrls=a;return c},_parsedUrlGetter:function(){return this.url?r.urlToObject(this.url):null},url:null,createWebSocketConnector:function(c){var a=this,d=new n;a.then(function(){var e=a.connectionInfo,b,g=a.layer.spatialReference,k,h,m={};try{b=a.makeFilter()}catch(l){d.reject(l);
return}if(e){e.socketUrl?h=[e.socketUrl]:e.serviceSocketUrls&&(h=e.serviceSocketUrls.map(function(b){return b+"/"+a.layer.socketDirection}));m.socketUrls=h;if(b&&(b.where||b.geometry||b.outFields)||e.token)k=f.mixin(k||{},{where:b.where,geometry:b.geometry,outFields:b.outFields,token:e.token});c&&(g&&c.wkid!==g.wkid)&&(k=f.mixin(k||{},{outSR:c.wkid}));m.queryParams=k;e=new s(m);d.resolve(e)}else d.reject(Error("No web socket urls found"))});return d.promise},makeFilter:function(c){var a=this.layer,
d=null,e=null,b;c?(c.hasOwnProperty("definitionExpression")&&(b=f.mixin(b||{},{where:c.definitionExpression})),c.hasOwnProperty("geometryDefinition")&&(d=c.geometryDefinition,b=f.mixin(b||{},{geometry:d}))):(a.hasOwnProperty("definitionExpression")&&a.definitionExpression&&(b=f.mixin(b||{},{where:a.definitionExpression})),a.hasOwnProperty("geometryDefinition")&&a.geometryDefinition&&(d=JSON.stringify(a.geometryDefinition.toJSON()),b=f.mixin(b||{},{geometry:d})));a.hasOwnProperty("outFields")&&(a.outFields&&
"*"!==a.outFields[0]&&(e=a.outFields.join(",")),b=f.mixin(b||{},{outFields:e}));return b},_fetchLayer:function(){return t({url:this.url,content:f.mixin({f:"json"}),handleAs:"json",callbackParamName:"callback"}).then(function(c){c._ssl&&(delete c._ssl,this.url=this.url.replace(/^http:/i,"https:"));this.layerDefinition=c}.bind(this))}})});