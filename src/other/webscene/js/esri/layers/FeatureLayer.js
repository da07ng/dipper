// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("require ../core/declare dojo/_base/lang dojo/_base/array dojo/Deferred ../core/JSONSupport ../core/sniff ../geometry/Extent ../geometry/SpatialReference ../core/Collection ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/support/jsonUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/support/jsonUtils ./GraphicsLayer ./support/Field ./support/FeatureType ./support/FeatureTemplate ./support/TimeInfo ./support/LabelClass".split(" "),
function(l,r,f,e,m,s,n,p,t,u,v,w,x,h,q,y,z,A,B,C,D,E,F){var k=r([A,s],{declaredClass:"esri.layers.FeatureLayer",classMetadata:{computed:{allRenderers:["loaded","renderer","fields"],capabilities:["editable"],outFields:["requiredFields"],requiredFields:["allRenderers"],supportsAdvancedQueries:["hasMemorySource"]},reader:{exclude:"id copyrightText definitionExpression currentVersion extent drawingInfo".split(" "),add:"isTable layerId copyright defaultDefinitionExpression version initialExtent fullExtent spatialReference objectIdField renderer labelingInfo opacity editable trackIdField".split(" ")}},
_rndProps:"attributeField attributeField2 attributeField3 rotationInfo.field proportionalSymbolInfo.field proportionalSymbolInfo.normalizationField colorInfo.field colorInfo.normalizationField".split(" "),_visVariableProps:["field","normalizationField"],controllerModulePaths:{"0":"./graphics/controllers/SnapshotController",1:{"2d":"./graphics/controllers/OnDemandController","3d":"./graphics/controllers/OnDemandController"},2:"./graphics/controllers/SelectionController",6:"./graphics/controllers/AutoController"},
normalizeCtorArgs:function(a,b){return"string"===typeof a?f.mixin({},{url:a},b):a&&a.layerDefinition?f.mixin({},{collectionLayer:a},b):a},getDefaults:function(a){var b=this.inherited(arguments);return f.mixin(b||{},{mode:k.MODE_SNAPSHOT,hasMemorySource:!!a.collectionLayer})},initialize:function(){var a=this.createGraphicsSource();a.then(f.hitch(this,this._initLayerProperties));this.addResolvingPromise(a)},_allowGeometryUpdatesReader:function(a){return null==a?!0:a},_allRenderersGetter:function(){return this._getAllRenderers(this.renderer)},
_capabilitiesGetter:function(a){var b=this.editable,c=f.trim(a||"");a=e.map(c&&c.split(","),f.trim);var d=e.map(c&&c.toLowerCase().split(","),f.trim),c=d.indexOf("editing"),d={Create:e.indexOf(d,"create"),Update:e.indexOf(d,"update"),Delete:e.indexOf(d,"delete")};if(b&&-1===c)a.push("Editing");else if(!b&&-1<c){var b=[c],g;for(g in d)-1<d[g]&&b.push(d[g]);b.sort();for(g=b.length-1;0<=g;g--)a.splice(b[g],1)}return a.join(",")},copyright:null,_copyrightReader:function(a,b){return b.copyrightText},_defaultDefinitionExpressionReader:function(a,
b){return b.definitionExpression},_defaultSymbolReader:function(a){return a&&h.fromJSON(a)},_editable:!1,_editableReader:function(a,b){b.capabilities?a=-1!==b.capabilities.toLowerCase().indexOf("editing"):this.hasMemorySource||(a=-1!==this.parsedUrl.path.search(/\/FeatureServer\//i));return!!a},_editableGetter:function(){return this._editable||this.userIsAdmin},_editableSetter:function(a){this._editable=a},_fieldsReader:function(a){return a.map(function(a){return new B(a)})},fullExtent:null,_fullExtentReader:function(a,
b){return b.extent&&p.fromJSON(b.extent)},generalizeForScale:4E3,hasAttachments:!1,_hasAttachmentsReader:function(a){return!this.hasMemorySource&&!!a},hasM:!1,hasMemorySource:!1,hasZ:!1,_initialExtentReader:function(a,b){return b.extent&&p.fromJSON(b.extent)},_isTableReader:function(a,b){return"Table"===b.type},_labelingInfoReader:function(a,b){if(a=b.drawingInfo&&b.drawingInfo.labelingInfo){var c=/\[([^\[\]]+)\]/ig,d,g=function(a,c){var d=this.getField(c,b.fields);return"["+(d&&d.name||c)+"]"}.bind(this);
a=a.map(function(a){a=new F(a);if(d=a.labelExpression)a.labelExpression=d.replace(c,g);return a})}return a},latticeTiling:!1,_latticeTilingReader:function(a,b){return!("esriGeometryPoint"===b.geometryType||"esriGeometryMultipoint"===b.geometryType)},_layerIdReader:function(a,b){return b.id},maxPointCountForAuto:4E3,maxRecordCountForAuto:2E3,maxVertexCountForAuto:25E4,_minScaleReader:function(a,b){return b.effectiveMinScale||a},_maxScaleReader:function(a,b){return b.effectiveMaxScale||a},_objectIdFieldReader:function(a,
b){a||b.fields.some(function(b){"esriFieldTypeOID"===b.type&&(a=b.name);return!!a});return a},_opacityReader:function(a,b){return 1-(b.drawingInfo&&b.drawingInfo.transparency||0)/100},_outFields:null,_outFieldsGetter:function(){var a=this._outFields,b=this.requiredFields;a?-1===a.indexOf("*")&&b.forEach(function(b){-1===a.indexOf(b)&&a.push(b)}):a=b;this.loaded&&(a=a.filter(function(a){return"*"===a||!!this.getField(a)},this),a=a.map(function(a){return"*"===a?a:this.getField(a).name},this));return a},
_outFieldsSetter:function(a){this._outFields=a},_rendererSetter:function(a){var b=this._getAllRenderers(a);this._fixRendererFields(b);return a},_rendererReader:function(a,b){var c;if(a=b.drawingInfo&&b.drawingInfo.renderer)a=z.fromJSON(a),a.addBreak&&a.setMaxInclusive(!0);else if(b.defaultSymbol)c=h.fromJSON(b.defaultSymbol),b.types&&b.types.length?(a=new y(c,b.typeIdField),e.forEach(b.types,function(b){a.addValue(b.id,h.fromJSON(b.symbol))})):a=new q(c);else if("Table"!==b.type){switch(b.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":c=
new v;break;case "esriGeometryPolyline":c=new w;break;case "esriGeometryPolygon":c=new x}a=c&&new q(c)}return a},_requiredFieldsGetter:function(){var a=this.timeInfo,b=[this.objectIdField,this.typeIdField,this.editFieldsInfo&&this.editFieldsInfo.creatorField,a&&a.startTimeField,a&&a.endTimeField,this.trackIdField],c=this._rndProps;e.forEach(this.allRenderers,function(a){e.forEach(c,function(c){b.push(f.getObject(c,!1,a))});a.visualVariables&&a.visualVariables.forEach(function(a){this._visVariableProps.forEach(function(c){b.push(a[c])})},
this)},this);b=b.concat(this.dataAttributes);return b.filter(function(a,b,c){return!!a&&c.indexOf(a)===b&&"function"!==typeof a})},returnM:!1,returnZ:!1,_spatialReferenceReader:function(a,b){return(a=b.extent&&b.extent.spatialReference)&&t.fromJSON(a)},_supportsAdvancedQueries:!1,_supportsAdvancedQueriesGetter:function(){return this.hasMemorySource?!1:this._supportsAdvancedQueries},_supportsAdvancedQueriesSetter:function(a){this._supportsAdvancedQueries=a},_templatesReader:function(a,b){var c=b.editFieldsInfo,
d=c&&c.creatorField,c=c&&c.editorField;a=a&&a.map(function(a){return new D(a)});this._fixTemplates(a,d);this._fixTemplates(a,c);return a},_timeInfoReader:function(a){a=a&&new E(a);a.trackIdField=this.trackIdField||a.trackIdField;return a},_trackIdFieldReader:function(a,b){return b.timeInfo&&b.timeInfo.trackIdField},_typeIdFieldReader:function(a,b){if(a){var c=this.getField(a,b.fields);c&&(a=c.name)}return a},_typesReader:function(a,b){var c=b.editFieldsInfo,d=c&&c.creatorField,g=c&&c.editorField;
return a&&a.map(function(a){a=new C(a);this._fixTemplates(a.templates,d);this._fixTemplates(a.templates,g);return a},this)},userIsAdmin:!1,_versionReader:function(a,b){(a=b.currentVersion)||(a=b.hasOwnProperty("capabilities")||b.hasOwnProperty("drawingInfo")||b.hasOwnProperty("hasAttachments")||b.hasOwnProperty("htmlPopupType")||b.hasOwnProperty("relationships")||b.hasOwnProperty("timeInfo")||b.hasOwnProperty("typeIdField")||b.hasOwnProperty("types")?10:9.3);return a},createGraphicsSource:function(){var a=
new m;l(["./graphics/sources/"+(this.collectionLayer?"MemorySource":"FeatureLayerSource")],f.hitch(this,function(b){var c=new b({layer:this});c.then(f.hitch(this,function(){this.emit("graphics-source-create",{graphicsSource:c});a.resolve(c)}),function(b){a.reject(b)})}));return a.promise},createGraphicsController:function(a){var b=new m,c=this.controllerModulePaths[this.mode],d=a.layerView,g=new u,e=f.mixin(a.options||{},{layer:this,layerView:d,graphicsCollection:g});"object"===typeof c&&(c=c[d.view.type]);
c?l([c],f.hitch(this,function(a){var c=new a(e);c.then(f.hitch(this,function(){this.emit("graphics-controller-create",{graphicsController:c});b.resolve(c)}),function(a){b.reject(a)})})):b.reject(Error('Module path not found for controller type: "'+this.mode+'"'));return b.promise},getField:function(a,b){var c;if(b=b||this.fields)a=a.toLowerCase(),e.some(b,function(b){b&&b.name.toLowerCase()===a&&(c=b);return!!c});return c},_initLayerProperties:function(a){this.graphicsSource=a;a=a.layerDefinition;
a._ssl&&(delete a._ssl,this.url=this.url.replace(/^http:/i,"https:"));this.read(a);this._verifyFields();this._fixSymbolUrls();this.useQueryTimestamp=(n("ie")||n("safari"))&&this.editable&&10.02>this.version;this.watch("token",function(){this._fixSymbolUrls()}.bind(this))},_fixSymbolUrls:function(){var a=this.renderer;if(!this.hasMemorySource){var b=this.parsedUrl.path+"/images/",c=this.token,d=[a.symbol,a.defaultSymbol];e.forEach(a.infos,function(a){d.push(a.symbol)});e.forEach(d,function(a){var d=
a&&a.url;d&&(-1===d.search(/https?\:/)&&-1===d.indexOf("data:")&&(a.url=b+d),c&&(-1!==a.url.search(/https?\:/)&&-1===a.url.indexOf("?token\x3d"))&&(a.url+="?token\x3d"+c))})}},_getAllRenderers:function(a){var b=[];a&&[a,a.trackRenderer,a.observationRenderer,a.latestObservationRenderer].forEach(function(a){a&&(b.push(a),a.rendererInfos&&a.rendererInfos.forEach(function(a){a.renderer&&b.push(a.renderer)}))});return b},_fixRendererFields:function(a){var b=this.fields;a&&b&&a.forEach(function(a){this._fixFieldName(this._rndProps,
a);e.forEach(a.visualVariables,function(a){this._fixFieldName(this._visVariableProps,a)},this)},this)},_fixFieldName:function(a,b){e.forEach(a,function(a){var d=f.getObject(a,!1,b);(d=d&&"function"!==typeof d&&this.getField(d))&&f.setObject(a,d.name,b)},this)},_verifyFields:function(){var a=this.parsedUrl&&this.parsedUrl.path||"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+a+")");!this.isTable&&(!this.hasMemorySource&&-1===a.search(/\/FeatureServer\//i)&&
!e.some(this.fields,function(a){return"esriFieldTypeGeometry"===a.type}))&&console.log("FeatureLayer: unable to find field of type 'esriFieldTypeGeometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+a+")")},_fixTemplates:function(a,b){e.forEach(a,function(a){(a=a.prototype&&a.prototype.attributes)&&b&&delete a[b]})}});f.mixin(k,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,MODE_AUTO:6,
POPUP_URL:"esriServerHTMLPopupTypeAsURL",POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText"});return k});