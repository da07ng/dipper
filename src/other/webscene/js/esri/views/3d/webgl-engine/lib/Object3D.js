// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define(["./IdGen","./Util","./gl-matrix","../parts/Model","./IntervalUtilities"],function(r,G,H,K,y){var m=G.assert,h=H.mat4d,p=H.vec3d,I=G.VertexAttrConstants,L=new r,M=new r,z=function(g,h,m,p,r){var v=M.gen(g.getId());this.getId=function(){return v};this.geometry=g;this.materials=h;this.transformation=m;this.instanceParameters=p;this.origin=r};r=function(g){var r=this,N=L.gen(g.idHint);this.getId=function(){return N};var O=g.name,J=null!=g.castShadow?g.castShadow:!0,v=g.metadata||{},t;this.getParentLayer=
function(){return t};this.addParentLayer=function(a){m(void 0===t,"Object3D can only be added to a single Layer");t=a};this.removeParentLayer=function(a){t=void 0};var e,l;if(Array.isArray(g.geometries)){m(g.materials.length===g.geometries.length,"Object3D: materials don't match geometries");m(g.transformations.length===g.geometries.length,"Object3D: transformations don't match geometries");e=Array(g.geometries.length);l=g.geometries.slice();for(var w=0;w<g.geometries.length;w++)m(g.materials[w]instanceof
Array,"Object3D: materials parameter must be array of array"),e[w]=new z(g.geometries[w],g.materials[w].slice(),h.create(g.transformations[w]),g.instanceParameters?g.instanceParameters.slice():void 0)}else e=[],l=[];var x=h.identity();g=function(){this.min=p.create();this.max=p.create();this.center=p.create();this.init=function(){p.set3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.min);p.set3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this.max)}};var s=new g,q=new g,E=!0,A,D;
this.getNumGeometryRecords=function(){return e.length};this.getFirstGeometryIndex=function(a){a=l.indexOf(a);m(-1<a,"Object3D.getFirstGeometryIndex: geometry not found");return a};this.findGeometryRecords=function(a){for(var b=[],c=0;c<l.length;c++)l[c]===a&&b.push(e[c]);return b};this.getGeometryRecord=function(a){m(0<=a&&a<e.length,"Object3d.getGeometryDataByIndex: index out of range");return e[a]};this.getGeometryRecords=function(){return e};this.addGeometry=function(a,b,c,d,n){m(b instanceof Array,
"Object3D.addGeometry: materials must be array");l.push(a);a=new z(a,b.slice(),h.create(c),d,n);e.push(a);this.notifyDirty("objGeometryAdded",a);B();return a};this.hasGeometry=function(a){return-1<l.indexOf(a)};this.removeGeometry=function(a){var b=e.splice(a,1)[0];l.splice(a,1);this.notifyDirty("objGeometryRemoved",b);B();return b};this.replaceGeometry=function(a,b){m(0<=a&&a<e.length,"Object3d.replaceGeometry: index out of range");var c=e[a],d=new z(b,c.materials,c.transformation);e[a]=d;l[a]=b;
this.notifyDirty("objGeometryReplaced",[c,d]);B();return c.geometry};this.replaceGeometryMaterials=function(a,b){m(0<=a&&a<e.length,"Object3d.replaceGeometryMaterials: index out of range");var c=e[a],d=c.materials,n=new z(c.geometry,b.slice(),c.transformation);e[a]=n;this.notifyDirty("objGeometryReplaced",[c,n]);return d};this.geometryVertexAttrsUpdated=function(a){this.notifyDirty("vertexAttrsUpdated",e[a]);B()};this.geometryColorAttrsUpdated=function(a){this.notifyDirty("colorAttrsUpdated",e[a])};
var k={},u={};this.getHiddenIndexRanges=function(a){return k[a.getId()]};this.getVisibleIndexRanges=function(a){return u[a.getId()]};this.isAllHidden=function(){for(var a=0;a<e.length;a++){var b=e[a],c=b.geometry.getData().getFaces().length,b=this.getVisibleIndexRanges(b);if(!b)return!1;for(var d=0;d<c;d++){var n=b[d];if(!n||0<n.length)return!1}}return!0};this.setFacerangeColors=function(a,b){var c=this.getGeometryRecords();if(1!=c.length)console.warn("face range colors currently support only one geometry record");
else{var c=c[0].geometry,d=c.getData().getVertexAttr();if(null==c.backupColors){var n=d[I.COLOR].data;c.backupColors=new Uint8Array(n,0,n.byteLength)}d=d[I.COLOR].data;if(null!=d){for(n=0;n<a.length;n++){var e=a[n],f=null==e.faceRanges?0:12*e.faceRanges[0],g=null==e.faceRanges?d.length:12*(e.faceRanges[1]+1),h,k,l;if(null!=e.color)if("blend"===b){h=e.color[0];k=e.color[1];l=e.color[2];for(e=e.color[3];f<g;f+=4)d[f+0]=c.backupColors[f+0]*h,d[f+1]=c.backupColors[f+1]*k,d[f+2]=c.backupColors[f+2]*l,
d[f+3]=c.backupColors[f+3]*e}else{h=255*e.color[0];k=255*e.color[1];l=255*e.color[2];for(e=255*e.color[3];f<g;f+=4)d[f+0]=h,d[f+1]=k,d[f+2]=l,d[f+3]=e}else for(;f<g;f++)d[f]=c.backupColors[f]}this.geometryColorAttrsUpdated(0)}}};this.isPartiallyHidden=function(){for(var a=0;a<e.length;a++){var b=e[a],c=b.geometry.getData().getFaces().length;if(b=this.getHiddenIndexRanges(b))for(var d=0;d<c;d++){var n=b[d];if(n&&0<n.length)return!0}}return!1};this.hideFaceRange=function(a,b){var c=a.getId();void 0===
k[c]&&(k[c]={},u[c]={});for(var d=0;d<a.geometry.getData().getFaces().length;d++){void 0===k[c][d]&&(k[c][d]=[],u[c][d]=[]);var e=y.copyIntervals(b);y.convertFaceToIndexRange(e,3);var g=a.geometry.getData().getFaces()[d].componentRange,e=y.intersectIntervals(e,g),e=y.offsetIntervals(e,-g[0]);k[c][d]=k[c][d].concat(e);k[c][d]=y.mergeIntervals(k[c][d]);0===k.length?(delete u[c],delete k[c]):(e=a.geometry.getData().getFaces()[d].indices.position.length,u[c][d]=y.invertIntervals(k[c][d],e-1))}this.notifyDirty("hideFaceRange",
a)};this.hideAllFaceRanges=function(){k={};u={};for(var a=0;a<e.length;a++){var b=e[a],c=b.getId();k[c]={};u[c]={};for(var d=b.geometry.getData().getFaces().length,g=0;g<d;g++){var h=b.geometry.getData().getFaces()[g].indices.position.length;k[c][g]=[0,h-1];u[c][g]=[]}this.notifyDirty("hideFaceRange",b)}return!0};this.unhideAllFaceRange=function(){k={};u={};this.notifyDirty("unhideAllFaceRange")};this.getFaceRangeIndexFromTriangleNr=function(a){var b=v.faceRanges,c;if(null!=b&&1<b.length)for(var d=
0;d<b.length;d++)if(b[d][0]<=a&&b[d][1]>=a){c=d;break}return c};this.getFaceRangeFromTriangleNr=function(a){a=this.getFaceRangeIndexFromTriangleNr(a);var b=v.faceRanges;return a?[b[a]]:null};this.setGeometryTransformation=function(a,b){m(0<=a&&a<e.length,"Object3d.setGeometryTransformation: index out of range");var c=e[a],d=new z(c.geometry,c.materials,h.create(b));e[a]=d;this.notifyDirty("objGeometryReplaced",[c,d]);B()};this.getObjectTransformation=function(){return h.create(x)};this.setObjectTransformation=
function(a){h.set(a,x);B();this.notifyDirty("objTransformation")};this.getCombinedTransformation=function(a,b){b=b||h.create();h.multiply(x,a.transformation,b);return b};this.getCastShadow=function(){return J};this.setCastShadow=function(a){J=a};this.getMetadata=function(){return v};this.getName=function(){return O};this.getBBMin=function(a){C();return a?s.min:q.min};this.getBBMax=function(a){C();return a?s.max:q.max};this.getCenter=function(a){C();return a?s.center:q.center};this.getBSRadiusApprox=
function(){C();return A};this.calcFacerangeBoundingSphere=function(a){var b=null;null!=a&&(1===l.length&&1===l[0].getNumGroups())&&(b=this.getFaceRangeFromTriangleNr(a));if(null==b||1!==b.length)return{center:this.getCenter(),radiusScaled:this.getBSRadiusApproxScaled()};a=l[0].calculateBoundingInfo(0,b[0]);b=a.getCenter();h.multiplyVec3(e[0].transformation,b);h.multiplyVec3(x,b);return{center:b,radiusScaled:a.getBSRadius()*F(e[0].transformation)*F(x)}};this.getBSRadiusApproxScaled=function(){C();
return D};var C=function(){if(E){s.init();q.init();for(var a=p.create(),b=p.create(),c=0;c<e.length;++c)for(var d=l[c],g=0,k=d.getNumGroups();g<k;++g){var f=d.getBoundingInfo(g);h.multiplyVec3(e[c].transformation,f.getBBMin(),a);h.multiplyVec3(e[c].transformation,f.getBBMax(),b);for(f=0;3>f;++f){if(a[f]>b[f]){var m=a[f];a[f]=b[f];b[f]=m}s.min[f]=Math.min(s.min[f],a[f]);s.max[f]=Math.max(s.max[f],b[f])}h.multiplyVec3(x,a);h.multiplyVec3(x,b);for(f=0;3>f;++f)a[f]>b[f]&&(m=a[f],a[f]=b[f],b[f]=m),q.min[f]=
Math.min(q.min[f],a[f]),q.max[f]=Math.max(q.max[f],b[f])}p.lerp(s.min,s.max,0.5,s.center);p.lerp(q.min,q.max,0.5,q.center);for(c=D=A=0;c<e.length;++c){d=l[c];g=0;for(k=d.getNumGroups();g<k;++g)f=d.getBoundingInfo(g),b=e[c].transformation,h.multiplyVec3(b,f.getCenter(),a),A=Math.max(A,p.dist(a,s.center)+f.getBSRadius(g)),b=F(b),D=Math.max(D,A*b)}E=!1}},F=function(a){var b=Math.sqrt(a[0]*a[0]+a[4]*a[4]+a[8]*a[8]),c=Math.sqrt(a[1]*a[1]+a[5]*a[5]+a[9]*a[9]);a=Math.sqrt(a[2]*a[2]+a[6]*a[6]+a[10]*a[10]);
return Math.max(Math.max(b,c),a)},B=function(){E=!0;var a={bbMin:q.min,bbMax:q.max,center:q.center,bsRadius:A};t&&t.notifyObjectBBChanged(r,a)};this.notifyDirty=function(a,b,c,d){t&&(c=c||K.ContentType.OBJECT,t.notifyDirty(a,b,c,d||this))}};r.GeometryRecord=z;r.paramsFromOldConstructor=function(g,h,m,p,r,v,t){return{name:g,geometries:h,materials:m,transformations:p,castShadow:r,metadata:v,idHint:t}};return r});