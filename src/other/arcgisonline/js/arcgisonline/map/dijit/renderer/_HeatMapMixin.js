// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/dijit/renderer/_HeatMapMixin","dojo/_base/declare dojo/_base/lang dojo/_base/connect dojo/_base/array dojo/dom dojo/Deferred dojo/dom-construct esri/lang esri/symbols/jsonUtils esri/styles/choropleth esri/renderers/smartMapping esri/plugins/FeatureLayerStatistics esri/dijit/HeatmapSlider esri/renderers/HeatmapRenderer".split(" "),function(l,c,m,n,f,e,g,p,q,r,h,s,k,t){return{buildHeatMapRenderer:function(b){var a=new e;setTimeout(function(){a.progress(a)},1);b=b||{};if(this.isFeatColl||
this.isCSV||this.hasDynamic)this.buildHeatMapRendererGo(null,b,a);else if("esri.renderer.UniqueValueRenderer"===this.renderer.declaredClass)if(this.isOwnerOfHostedFS){var d=this.layer.getEditCapabilities();!this.layer.isEditable()||!d.canCreate&&(d.canUpdate||d.canDelete)||this.mapLayer.featureTemplatesChanged?this.buildHeatMapRendererGo(!0,b,a):arcgisonline.map.edit.hasDefaultTypesAndTemplates(this.layer)?this.buildHeatMapRendererGo(!0,b,a):arcgisonline.sharing.dijit.dialog.ChoiceDlg.prototype.statics.getInstance().show({title:this.i18n.warning,
message:this.i18n.featureTypesAndTemplatesWarning,choiceOneTitle:this.i18n.yesLabel,choiceOneHandler:c.hitch(this,function(){this.buildHeatMapRendererGo(!0,b,a)}),choiceTwoTitle:this.i18n.noLabel,choiceTwoHandler:c.hitch(this,function(){a.reject()})})}else this.buildHeatMapRendererGo(null,b,a);else this.buildHeatMapRendererGo(null,b,a);return a},buildHeatMapRendererGo:function(b,a,d){arcgisonline.map.dynLayer.checkDynamicLayers(this.mapLayer);this.hasDynamic=arcgisonline.map.main.hasDynamicLayers(this.mapLayer);
h.createHeatmapRenderer({layer:this.layer,basemap:this.getBasemapType(),blurRadius:null,field:a.field,scheme:this.scheme}).then(c.hitch(this,function(a){d.isRejected()||(this.scheme=a.scheme,b&&(arcgisonline.map.edit.removeTypesAndTemplatesOnLayer(this.mapLayer.layer),this.mapLayer.featureTemplatesChanged=!0),delete this.authoringInfo,d.resolve(a.renderer,a.statistics))}),c.hitch(this,function(a){d.isRejected()||(this.handleError(a,"createHeatmapRenderer",!0),d.reject())}))},applyHeatMapRenderer:function(b){var a=
this.getRendererStyle((this.fLayer||this.layer).renderer);this.setRenderer(b);!this.hasDynamic&&("heatMap"!==a&&this.scheme&&esri.isDefined(this.scheme.opacity))&&(this.layer.setOpacity(this.scheme.opacity),this.transparencySlider&&this.transparencySlider.set("value",1-this.scheme.opacity));(arcgisonline.map.featColl.isFeatureCollection(this.mapLayer)||this.isCSV)&&arcgisonline.map.main.markMapAsChanged("onRendererChange");this.updateLegendPopup();this.isOwnerOfHostedFS&&!this.layer.templates.length&&
arcgisonline.map.edit.createTypesAndTemplatesOnLayer(this.layer)},createHeatMapSlider:function(b){var a=new e;setTimeout(function(){a.progress(a)},1);b=b||{};this.createSlider=c.hitch(this,function(){this.heatMapSlider=new k({colorStops:c.clone(this.renderer.colorStops)},"rendererHeatMapSlider");this.heatMapSlider.startup();this.sliderChangeHandler=this.heatMapSlider.on("handle-value-change",c.hitch(this,function(a){this.renderer.setColorStops(a);this.applyHeatMapRenderer(this.renderer)}))});this.destroyHeatMapSlider();
b.statistics?this.createSlider(b):this.layer.addPlugin("esri/plugins/FeatureLayerStatistics").then(c.hitch(this,function(){a.isRejected()||this.layer.statisticsPlugin.getHeatmapStatistics({blurRadius:b.blurRadius,field:b.field}).then(c.hitch(this,function(d){a.isRejected()||(b.statistics=d,this.createSlider(b),a.resolve())}),c.hitch(this,function(b){a.isRejected()||(this.handleError(b,"getHeatmapStatistics",!1),a.reject())}))}),c.hitch(this,function(b){a.isRejected()||(this.handleError(b,"addPlugin",
!1),a.reject())}));return a},updateRendererWithNewStatistics:function(b){var a=new e;setTimeout(function(){a.progress(a)},1);this.layer.addPlugin("esri/plugins/FeatureLayerStatistics").then(c.hitch(this,function(){a.isRejected()||this.layer.statisticsPlugin.getHeatmapStatistics({blurRadius:b.blurRadius,field:b.field}).then(c.hitch(this,function(d){a.isRejected()||(this.renderer.setField(b.field),this.renderer.setBlurRadius(b.blurRadius),this.renderer.setMinPixelIntensity(d.min),this.renderer.setMaxPixelIntensity(d.max),
a.resolve(this.renderer))}),c.hitch(this,function(b){a.isRejected()||(this.handleError(b,"getHeatmapStatistics",!1),a.reject())}))}),c.hitch(this,function(b){a.isRejected()||(this.handleError(b,"addPlugin",!1),a.reject())}));return a},destroyHeatMapSlider:function(){this.sliderChangeHandler&&this.sliderChangeHandler.remove();this.sliderChangeHandler=null;this.heatMapSlider&&this.heatMapSlider.destroy();f.byId("rendererHeatMapSlider")||g.create("div",{id:"rendererHeatMapSlider"},f.byId("rendererHeatMapSliderDiv"))}}});