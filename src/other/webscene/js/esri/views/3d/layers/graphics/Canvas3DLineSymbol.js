// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../../../../core/declare ./Canvas3DSymbolBase ./Canvas3DGraphic ./Canvas3DDrapedGraphic ./ElevationAligners ./Canvas3DSymbolCommonCode ../../../../core/screenUtils ../../../../geometry/Polygon ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/NativeLineMaterial ../../webgl-engine/materials/RibbonLineMaterial ../../webgl-engine/lib/Util".split(" "),
function(D,E,F,G,x,p,H,I,z,A,J,K,B,L,M,N,O){var s=O.VertexAttrConstants,y=z.vec3d,u=z.mat4d;y.create();var C=function(a,c,f,h,b,m){var d,e,g;f&&(f=a.length,f=!(a[0]===a[f-3]&&a[1]===a[f-2]&&a[2]===a[f-1]));if(f){f=new Float32Array(a.length+3);for(e=0;e<a.length;e++)f[e]=a[e];e=f.length;f[e-3]=a[0];f[e-2]=a[1];f[e-1]=a[2];d=a.length/3+1;e=new Uint32Array(2*(d-1));g=new Uint32Array(2*(d-1))}else d=a.length/3,e=new Uint32Array(2*(d-1)),g=new Uint32Array(2*(d-1)),f=a;a=new Float32Array(1);a[0]=b;for(var k=
b=0,l=0;l<d-1;l++)e[b++]=l,e[b++]=l+1,g[k++]=0,g[k++]=0;d={};b={};d[s.POSITION]=e;d[s.COLOR]=g;d[s.SIZE]=g;b[s.POSITION]={size:3,data:f};b[s.COLOR]={size:4,data:h};b[s.SIZE]={size:1,data:a};c&&(d.mapPos=e,b.mapPos={size:3,data:c});c=[{type:"line",indices:d,positionKey:s.POSITION}];return m?{faces:c[0],vertexAttr:b,id:B.getNewId().toString()}:new B(c,b)};return D([E],{_prepareResources:function(){var a=this.symbol,c=this._getWidth(a),f=this._getStageIdHint(),h=this._isPropertyDriven("size");this._isNativeLineMaterial=
!1;if(h||2<c)h&&(c=0),c={width:c,color:this._getMaterialOpacityAndColor(),miterLimit:a.miterLimit},"miter"===a.join||"bevel"===a.join?c.join=a.join:(c.join="miter",a.join&&this._logWarning("unsupported join type for line symbol: "+a.join)),c.polygonOffset=!0,this._material=new N(c,f+"_ribbonlinemat");else if(0<c)this._isNativeLineMaterial=!0,this._material=new M(c,this._getMaterialOpacityAndColor(),f+"_nativelinemat");else{this.reject();return}this._context.stage.add(A.ModelContentType.MATERIAL,this._material);
this.resolve()},_getWidth:function(a){return null!=a.size?a.size:1},destroy:function(){this._context.stage.remove(A.ModelContentType.MATERIAL,this._material.getId())},createCanvas3DGraphic:function(a,c){var f=a.geometry;if("polyline"!==f.type&&"polygon"!==f.type&&"extent"!==f.type)return this._logWarning("unsupported geometry type for line symbol: "+f.type),null;var f="polygon"===f.type||"extent"===f.type?"rings":"paths",h="graphic"+a.id,b=this._getVertexOpacityAndColor(c,Float32Array,255),m=0;c.size&&
this._isPropertyDriven("size")&&(m=p.getSingleSizeDriver(c.size),m=H.pt2px(m));var d=this._getGraphicElevationInfo(a);return d.mode===p.ELEV_MODES.ON_THE_GROUND?this._createAsOverlay(a,f,b,m,d,h):this._createAs3DShape(a,f,b,m,d,h,a.id)},layerPropertyChanged:function(a,c,f){if("opacity"===a)return this._isNativeLineMaterial?(c=this._material.getColor(),c[3]=this._getMaterialOpacity(),this._material.setColor(c)):(c=this._material.getParameterValues(),c.color[3]=this._getMaterialOpacity(),this._material.setParameterValues({color:c.color})),
!0;if("elevationInfo"===a){a=this._elevationInfo.mode;this._updateElevationInfo();var h=this._elevationInfo.mode;if(null==a||null==h)return!1;var b=p.ELEV_MODES;if(a===b.ON_THE_GROUND&&h===b.ON_THE_GROUND)return!0;if(a!==h&&(a===b.ON_THE_GROUND||h===b.ON_THE_GROUND))return!1;a=h===b.RELATIVE_TO_GROUND?x.perVertexElevationAligner:null;var h=this._context.elevationProvider,b=this._context.renderCoordsHelper,m=this._context.mapCoordsHelper,d;for(d in c){var e=c[d],g=e._graphics[f];g&&(e=e.graphic,g.elevationAligner=
a,g.elevationInfo.set(this._getGraphicElevationInfo(e)),x.perVertexElevationAligner(g,h,b,m))}return!0}return!1},_getOutlineSegments:function(a,c){var f=c.length;if(null!=a._outlineSegments){for(var h=[],b=0;b<f;b++)for(var m=c[b],d=0;d<a._outlineSegments[b].length;d++){for(var e=a._outlineSegments[b][d],g=[],k=e[0];k<e[1];k++)g.push(m[k]);0<g.length&&h.push(g)}c=h}return c},_getGeometry:function(a){a=a.geometry;"extent"===a.type&&(a=I.fromExtent(a));return a},_createAs3DShape:function(a,c,f,h,b,
m,d){var e=this._getGeometry(a),g=e.hasZ,k=e[c];if(0<this._getOutlineSegments(e,k).length){a=[];for(var l=[],q=[],r=y.create(),s=Array(6),k=p.getGeometryVertexData3D(k,g,e.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,b),e=k.geometryData.outlines,g=k.eleVertexData,k=k.vertexData,v=0;v<e.length;++v){var w=e[v],n=w.index,t=w.count;if(this._context.clippingExtent&&(p.computeBoundingBox(g,n,t,s),p.boundingBoxClipped(s,this._context.clippingExtent)))continue;p.chooseOrigin(k,
n,t,r);p.subtractCoordinates(k,n,t,r);w=new Float64Array(g.buffer,3*n*g.BYTES_PER_ELEMENT,3*t);n=new Float64Array(k.buffer,3*n*k.BYTES_PER_ELEMENT,3*t);n=C(n,w,"rings"===c,f,h,!1);n=new K(n,m+"path"+v);n.singleUse=!0;a.push(n);l.push([this._material]);n=u.identity();u.translate(n,r,n);q.push(n)}c=this._context.layer.get("id");m=new J({geometries:a,materials:l,transformations:q,castShadow:!1,metadata:{layerId:c,graphicId:d},idHint:m});d=null;b.mode===p.ELEV_MODES.RELATIVE_TO_GROUND&&(d=x.perVertexElevationAligner);
return new F(this,m,a,null,null,d,b)}this._logWarning("no paths found for line symbol");return null},_createAsOverlay:function(a,c,f,h,b,m){var d=this._getGeometry(a);this._material.setRenderPriority(this._symbolLayerOrder);var e=this._getOutlineSegments(d,d[c]);if(0<e.length){a=[];b=Array(6);for(var g=y.create(),e=p.getGeometryVertexDataDraped(e,d.spatialReference,this._context.overlaySR),d=e.vertexData,e=e.geometryData.outlines,k=0;k<e.length;++k){var l=e[k],q=l.index,l=l.count;p.computeBoundingBox(d,
q,l,b);if(!p.boundingBoxClipped(b,this._context.clippingExtent)){p.chooseOrigin(d,q,l,g);p.subtractCoordinates(d,q,l,g);p.setZ(d,q,l,this._getDrapedZ());l=new Float64Array(d.buffer,3*q*d.BYTES_PER_ELEMENT,3*l);q=u.identity();u.translate(q,g,q);var l=C(l,null,"rings"===c,f,h,!0),r=new L(l);r.material=this._material;r.center=[0.5*(b[0]+b[3]),0.5*(b[1]+b[4]),0];r.bsRadius=0.5*Math.sqrt((b[3]-b[0])*(b[3]-b[0])+(b[4]-b[1])*(b[4]-b[1]));r.transformation=q;r.name=m;r.uniqueName=m+"#"+l.id;a.push(r)}}return new G(this,
a,null,null)}return null}})});