// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("require ../../lib/glMatrix ../../support/earthUtils ../../support/projectionUtils ../../support/PromiseLightweight ../graphics/Canvas3DSymbolCommonCode ../../webgl-engine/Stage ../../webgl-engine/materials/Material ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/Layer ../../webgl-engine/lib/BufferVectorMath ../../webgl-engine/lib/Util".split(" "),function(P,w,z,A,Q,R,p,t,B,C,D,S,T,K){var U=K.matrix2frustumPlanes,F=
w.vec4d,v=w.vec3d,k=w.vec3,s=w.mat4d,L=K.assert,u=v.create(),M=v.create(),N=F.create(),x={DDS_ENCODING_STRING:"image/vnd-ms.dds",BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS:["image/jpeg","image/png"],getNodeURL:function(a,h){return a+"nodes/"+h+"/"},addTrailingSlash:function(a){"/"!=a[a.length-1]&&(a+="/");return a},concatUrl:function(a,h){for(var b=a.split("/"),e=h.split("/"),g=[],f=0,c=b.length;f<c;f++)".."==b[f]?g.pop():"."==b[f]||""===b[f]&&1<f||g.push(b[f]);f=0;for(c=e.length;f<c;f++)".."==e[f]?
g.pop():"."==e[f]||""===e[f]||g.push(e[f]);return g.join("/")},extractWkid:function(a){return a&&parseInt(a.substring(a.lastIndexOf("/")+1,a.length),10)},getAppropriateTextureEncoding:function(a,h){if(Array.isArray(a)){if(h){var b=a.indexOf(x.DDS_ENCODING_STRING);if(-1<b)return b}for(b=0;b<a.length;b++)if(-1<x.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(a[b]))return b;throw Error("Could not find appropriate texture encoding (among "+a.toString()+")");}return-1},findIntersectingNodes:function(a,
h,b,e,g,f){if(null!=b&&(A.mbsToMbs(b.mbs,e,N,h),0!==this.intersectBoundingBoxWithMbs(a,N))){f.push(b);for(var c=null!=b.children?b.children.length:0,d=0;d<c;d++)this.findIntersectingNodes(a,h,g[b.children[d].id],e,g,f)}},intersectBoundingBoxWithMbs:function(a,h){var b=h[0],e=h[1],g=h[2],f=h[3],c=0,d;b<a[0]&&(d=a[0]-b,c+=d*d);e<a[1]&&(d=a[1]-e,c+=d*d);g<a[2]&&(d=a[2]-g,c+=d*d);b>a[3]&&(d=b-a[3],c+=d*d);e>a[4]&&(d=e-a[4],c+=d*d);g>a[5]&&(d=g-a[5],c+=d*d);if(c>f*f)return 0;if(0<c)return 1;c=Infinity;
b-a[0]<c&&(c=b-a[0]);e-a[1]<c&&(c=e-a[1]);g-a[2]<c&&(c=g-a[2]);a[3]-b<c&&(c=a[3]-b);a[4]-e<c&&(c=a[4]-e);a[5]-g<c&&(c=a[5]-g);return c>f?2:1},ViewportQueries:function(a,h,b,e,g,f,c,d,r,m,y,O,V){for(var n=[],G=0;8>G;++G)n[G]=F.create();U(b.viewMatrix,b.projectionMatrix,n);var q=h.spatialRef;this.engineSR=q;var p=1/b.perPixelRatio,t=b.eye;h=k.subtract(b._center,t,[0,0,0]);k.normalize(h);var s={x:0,y:0,z:0,spatialReference:a},u=function(l){l.computedMbs||(l.computedMbs=F.create(),l.computedMbs[3]=-1);
var c=l.computedMbs;0>c[3]&&(c[0]=l.mbs[0],c[1]=l.mbs[1],c[2]=l.mbs[2],c[3]=l.mbs[3],O&&(s.x=c[0],s.y=c[1],s.z=c[2],c[2]=R.computeElevation(O,s,V)),A.mbsToMbs(c,a,c,q));return c};this.isNodeVisible=function(l){if(c){for(var a=!1,b=0;b<c.length&&!a;b++)0===c[b].indexOf(l.id.toString())&&(a=!0);if(!a)return!1}l=u(l);a=g?0!=x.intersectBoundingBoxWithMbs(g,l):!0;return a&&w(l)};var w=function(l){var a=l[0],c=l[1],b=l[2];l=l[3];if(n[0][0]*a+n[0][1]*c+n[0][2]*b+n[0][3]>l||n[1][0]*a+n[1][1]*c+n[1][2]*b+
n[1][3]>l||n[2][0]*a+n[2][1]*c+n[2][2]*b+n[2][3]>l||n[3][0]*a+n[3][1]*c+n[3][2]*b+n[3][3]>l)return!1;a=n[4][0]*a+n[4][1]*c+n[4][2]*b+n[4][3];return a<l&&-a-l<e};this.isMBSVisible=w;var H=function(a,c){var b=u(a),d=b[3],b=v.dist2(b,t)-d*d;return 0>b?0.5*Number.MAX_VALUE:c/Math.sqrt(b)*p};this.calcScreenSpaceSize=H;this.hasLOD=function(a){return!0===f?!1:void 0!==a.lodSelection||void 0!==a.precision};var z=function(a){return null!=a.features&&0<a.features.length||null!=a.featureData};this.hasFeatures=
z;var I=[0,0,0],B=[0,0,0],E=[0,0,0],C=[0,0,0];h=function(a,c,b){var d=a[0]-c[0],e=a[1]-c[1];a=a[2]-c[2];d=d+d+e*e;if(d<=b*b)return Math.abs(a);b=Math.sqrt(d)-b;return Math.sqrt(a*a+b*b)};b=function(a,c,b){var d=k.length(c),e=k.length(a)-d;k.scale(a,k.dot(a,c)/k.length2(a),I);if(k.dist2(c,I)<=b*b)return Math.abs(e);c=k.scale(c,1/d,I);var d=k.scale(c,d-b*b/2/d,B),f=k.subtract(a,d,E),f=k.subtract(f,k.scale(c,k.dot(c,f),C),E),d=k.add(d,k.scale(f,b/k.length(f),E),E);b=k.dist(a,d);2E5<=e&&(a=k.subtract(a,
d,B),a=k.dot(a,c)/k.length(a),0.08>a&&(a=1E-4),b/=a);return b};var D=q===A.SphericalRenderSpatialReference?b:h,J=function(a){if(d)return-1==r||!a.features||0===a.features.length?!1:a.features[0].rank>r;if(a.lodSelection&&0<a.lodSelection.length){if(!1===z(a))return!1;for(var c=0;c<a.lodSelection.length;c++){var b=a.lodSelection[c];null==a.dbgErrorS&&(a.dbgErrorS={});if(!(null!=y&&b.metricType!=y))if("screenSpaceRelative"==b.metricType)if(a=u(a),a=2*D(t,a,a[3])/p,b.maxError>a)break;else return!0;else{if("maxScreenThreshold"==
b.metricType)return H(a,a.mbs[3])*m<b.maxError;if("removedFeatureDiameter"==b.metricType)return 10>H(a,b.maxError)*m}}}return!1};this.isTooHighLOD=J;this.isChosenLod=function(a,c,b,e){return d?-1==r?!0:a.features[0].rank==r:a.lodSelection&&0<a.lodSelection.length?(b=null!=b?b:J(a),c=!c?!1:null!=e?e:J(c),(b||!a.children)&&!c):!0};this.distToPOI=function(a,c){var b=u(a);return v.dist(b,c)-b[3]}},recomputeNormals:function(a,h){for(var b=T.Vec3Compact.subtract,e=a.map(function(a){return a.indices.position.length/
3}).reduce(function(a,c){return a+c}),e=new Float32Array(3*e),g=h.position.data,f=0,c=0;c<a.length;c++){for(var d=a[c].indices.position,k=new Uint32Array(d.length),m=0;m<d.length;m+=3){b(g,3*d[m],g,3*d[m+1],M,0);b(g,3*d[m],g,3*d[m+2],u,0);v.cross(u,M);v.normalize(u);var y=f/3;e[f++]=u[0];e[f++]=u[1];e[f++]=u[2];k[m]=y;k[m+1]=y;k[m+2]=y}a[c].indices.normal=k}h.normal.data=e},makeNodeDebugVisualizer:function(a,h,b){function e(a){return{ambient:a,diffuse:[0,0,0],transparent:!0,opacity:0.5,blendModeOneOne:!1}}
var g=new B(C.createCylinderGeometry(1,1,64,[0,0,1],[0,0,0],!1),"debugCylinder"),f=new B(C.createSphereGeometry(1),"debugSphere"),c={};c.red=new t(e([0.8,0,0]),"debugMaterialRed");c.grey=new t(e([0.4,0.4,0.4]),"debugMaterialGrey");c.brown=new t(e([0.2,0.1,0]),"debugMaterialBrown");c.green=new t(e([0,0.8,0]),"debugMaterialGreen");c.blue=new t(e([0,0,0.8]),"debugMaterialBlue");c.yellow=new t(e([0.8,0.8,0]),"debugMaterialYellow");c.magenta=new t(e([0.8,0,0.8]),"debugMaterialMagenta");for(var d in c)a.add(p.ModelContentType.MATERIAL,
c[d]);a.add(p.ModelContentType.GEOMETRY,g);b=new S(b+"_debug",{interaction:"IGNORED"},b+"_debug");a.add(p.ModelContentType.LAYER,b);a.addToViewContent([b.getId()]);var r=v.create(),m=s.create();return{engineLayer:b,added:{},show:function(a,b,d){var e=a.mbs,f=a.computedMbs;a="node"+a.id+"dbg";v.set(f,r);var q=f[3];if(q>z.earthRadius/10&&h.spatialRef===A.SphericalRenderSpatialReference){this.showWS(r,Math.max(0.01*q,1E4),d,a+"_center");var f=k.length(r),p=z.earthRadius;p+q>f&&(q=(f*f+p*p-q*q)/(2*f),
k.scale(r,q/f),q=Math.sqrt(p*p-q*q))}s.identity(m);s.scale(m,[q,q,0.05*q]);d=c[d];L(d);d=new D({name:a,geometries:[g],materials:[[d]],transformations:[m],castShadow:!1,idHint:a});A.computeLinearTransformation(b,e,m,h.spatialRef);null!=r&&(m[12]=r[0],m[13]=r[1],m[14]=r[2]);d.setObjectTransformation(m);this._addToStage(d,a)},showWS:function(a,b,d,e){var g=s.identity();s.scale(g,[b,b,b]);b=c[d];L(b);g=new D({name:e,geometries:[f],materials:[[b]],transformations:[g],castShadow:!1,idHint:e});b=s.identity();
s.translate(b,a);g.setObjectTransformation(b);this._addToStage(g,e)},_addToStage:function(b,c){a.add(p.ModelContentType.OBJECT,b);this.engineLayer.addObject(b);var d=this.added[c];void 0!==d&&(a.remove(p.ModelContentType.OBJECT,d.getId()),this.engineLayer.removeObject(d));this.added[c]=b},clear:function(){for(var b in this.added){var c=this.added[b];a.remove(p.ModelContentType.OBJECT,c.getId());this.engineLayer.removeObject(c)}this.added={}},dispose:function(){this.clear();for(var b in c)a.remove(p.ModelContentType.MATERIAL,
c[b].getId());a.remove(p.ModelContentType.GEOMETRY,g.getId());a.remove(p.ModelContentType.LAYER,this.engineLayer.getId())}}},postData:function(a,h,b){var e=new XMLHttpRequest;e.open("PUT","/put.php"+a,!0);e.setRequestHeader("Content-type",b);e.send(h)},queryAttributesFromFeatureLayer:function(a,h){var b=new Q.Promise;if(a){var e=a.url;P(["../../../../tasks/support/Query","../../../../tasks/QueryTask"],function(a,f){var c=new a;c.where="1\x3d1";c.objectIds=[h];c.outFields=["*"];c.returnGeometry=!1;
(new f(e)).execute(c).then(function(a){!a||!a.features||1>a.features.length?b.reject():b.done(a.features[0].attributes)},function(a){b.reject(a)})})}else b.reject(Error("Companion feature layer not present."));return b},valueType2TypedArrayClassMap:{Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},isValueType:function(a){return x.valueType2TypedArrayClassMap.hasOwnProperty(a)},getBytesPerValue:function(a){return x.isValueType(a)&&
x.valueType2TypedArrayClassMap[a].BYTES_PER_ELEMENT}};return x});