// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/ExportDlg",["dijit","dojo","dojox","dojo/require!dijit/Dialog,dijit/_Widget,dijit/_Templated,dijit/form/Button,dijit/form/TextBox,dijit/layout/BorderContainer,dijit/layout/ContentPane,dojo/data/ItemFileWriteStore,arcgisonline/sharing/dijit/ComboBox,arcgisonline/sharing/dijit/SaveItem,arcgisonline/sharing/geow/Folder,arcgisonline/sharing/util"],function(h,b,k){b.provide("arcgisonline.sharing.dijit.dialog.ExportDlg");b.require("dijit.Dialog");b.require("dijit._Widget");
b.require("dijit._Templated");b.require("dijit.form.Button");b.require("dijit.form.TextBox");b.require("dijit.layout.BorderContainer");b.require("dijit.layout.ContentPane");b.require("dojo.data.ItemFileWriteStore");b.require("arcgisonline.sharing.dijit.ComboBox");b.require("arcgisonline.sharing.dijit.SaveItem");b.require("arcgisonline.sharing.geow.Folder");b.require("arcgisonline.sharing.util");b.declare("arcgisonline.sharing.dijit.dialog.ExportDlg",[h._Widget,h._Templated],{widgetsInTemplate:!0,
templateString:'\x3cdiv class\x3d"widgetContent" \x3e\r\n  \x3cdiv data-dojo-type\x3d"dijit.Dialog" data-dojo-attach-point\x3d"exportDialog" id\x3d"export-dialog" title\x3d"${i18n.exportDialogTitle}" execute\x3d""\x3e\r\n    \x3cdiv data-dojo-attach-point\x3d"saveItemForm" data-dojo-type\x3d"arcgisonline.sharing.dijit.SaveItem"\x3e\x3c/div\x3e\r\n    \x3cdiv data-dojo-attach-point\x3d"_featureCollectionDiv" class\x3d"featureCollectionOnly hide" style\x3d"margin-top:10px;"\x3e\r\n        \x3cinput type\x3d"radio" style\x3d"margin:5px;" data-dojo-attach-point\x3d"generalizeChk" data-dojo-type\x3d"dijit.form.RadioButton" data-dojo-props\x3d"checked:false" name\x3d"generalize"/\x3e\x3clabel style\x3d"vertical-align:middle;"\x3e${i18n.generalize}\x3c/label\x3e\r\n        \x3cbr /\x3e\r\n        \x3cinput type\x3d"radio" style\x3d"margin:5px;" data-dojo-type\x3d"dijit.form.RadioButton"  name\x3d"generalize"/\x3e\x3clabel style\x3d"vertical-align:middle;"\x3e${i18n.keepOrig}\x3c/label\x3e\r\n    \x3c/div\x3e\r\n    \x3ctable width\x3d"100%"\x3e\r\n      \x3ctbody\x3e\r\n        \x3ctr\x3e\r\n          \x3ctd class\x3d"esriAlignLeading"\x3e\r\n            \x3cspan dojoAttachPoint\x3d"exportingLabel" style\x3d"visibility:hidden;"\x3e${i18n.exportingLabel}\x3c/span\x3e\r\n          \x3c/td\x3e\r\n          \x3ctd class\x3d"esriAlignTrailing"\x3e\r\n            \x3cdiv class\x3d"primary" data-dojo-attach-point\x3d"exportBtn" data-dojo-attach-event\x3d"onClick:onExport"\r\n                 data-dojo-type\x3d"dijit.form.Button" data-dojo-props\x3d"type:\'button\'"\x3e${i18n.exportLabel}\x3c/div\x3e\r\n            \x3cdiv class\x3d"cancel" data-dojo-attach-point\x3d"cancelBtn" data-dojo-attach-event\x3d"onClick:onCancel"\r\n                 data-dojo-type\x3d"dijit.form.Button" data-dojo-props\x3d"type:\'button\'"\x3e${i18n.cancel}\x3c/div\x3e\r\n          \x3c/td\x3e\r\n        \x3c/tr\x3e\r\n      \x3c/tbody\x3e\r\n    \x3c/table\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e',
util:arcgisonline.sharing.util,folder:arcgisonline.sharing.geow.Folder,item:null,layerId:-1,init:!1,exportType:null,exportResponse:null,checkStatusInterval:null,checkingStatus:!1,statusCheckIntervalTime:4E3,saveItemForm:null,exportDialog:null,exportBtn:null,cancelBtn:null,i18n:null,statics:{_instance:null,getInstance:function(){null==this._instance&&(this._instance=new arcgisonline.sharing.dijit.dialog.ExportDlg);return this._instance}},postMixInProperties:function(){this.inherited(arguments);this.i18n=
b.i18n.getLocalization("arcgisonline","arcgisonline").common;b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").exportDlg);b.mixin(this.i18n,{generalize:b.i18n.getLocalization("arcgisonline","arcgisonline").addLayerFromFileDlg.generalize});b.mixin(this.i18n,{keepOrig:b.i18n.getLocalization("arcgisonline","arcgisonline").addLayerFromFileDlg.keepOrig});this._webMercatorValues={3857:1,102113:1,102100:1,900913:1}},postCreate:function(){this.init||(this.init=!0)},startup:function(){this.inherited(arguments);
esri.config.defaults.io.proxyUrl=esriGeowConfig.proxyServer;esriGeowConfig.proxyUrl&&(esri.config.defaults.io.proxyUrl=esriGeowConfig.proxyUrl)},showShapefile:function(a,b){this._showDlg(a,b,arcgisonline.sharing.dijit.dialog.ExportDlg.util.shapefileType)},showCSV:function(a,b){this._showDlg(a,b,arcgisonline.sharing.dijit.dialog.ExportDlg.util.csvType)},showFileGDB:function(a,b){this._showDlg(a,b,arcgisonline.sharing.dijit.dialog.ExportDlg.util.fileGDB)},showGeoJson:function(a,b){this._showDlg(a,b,
arcgisonline.sharing.dijit.dialog.ExportDlg.util.geoJson)},showFeatureCollection:function(a,b){this._showDlg(a,b,arcgisonline.sharing.dijit.dialog.ExportDlg.util.featureCollection)},_showDlg:function(a,b,e){this.clear();this.item=a;this._setDialogTitle(e);this._setLayerDetails(b);this._initTags();this.exportDialog.show()},_initTags:function(){this.saveItemForm.loadTags().then(b.hitch(this,function(){this.saveItemForm.set("tags","")}))},_setDialogTitle:function(a){this.exportType=a;arcgisonline.sharing.dijit.dialog.ExportDlg.util.shapefileType===
this.exportType?this.exportDialog.set("title",this.i18n.exportDialogTitle+" "+this.i18n.toShapefile):arcgisonline.sharing.dijit.dialog.ExportDlg.util.csvType===this.exportType?this.exportDialog.set("title",this.i18n.exportDialogTitle+" "+this.i18n.toCSV):arcgisonline.sharing.dijit.dialog.ExportDlg.util.fileGDB===this.exportType?this.exportDialog.set("title",this.i18n.exportDialogTitle+" "+this.i18n.toFileGDB):arcgisonline.sharing.dijit.dialog.ExportDlg.util.geoJson===this.exportType?this.exportDialog.set("title",
this.i18n.exportDialogTitle+" "+this.i18n.toGeoJson):arcgisonline.sharing.dijit.dialog.ExportDlg.util.featureCollection===this.exportType&&this.exportDialog.set("title",this.i18n.exportDialogTitle+" "+this.i18n.toFeatureCollection)},_setLayerDetails:function(a){this._isTableLayer=this._isWebMercator=!1;a&&esri._isDefined(a.id)?(this.layerId=a.id,this._layers=[a],this.saveItemForm.set("title",a.name),this._isWebMercator=a.extent&&a.extent.spatialReference&&a.extent.spatialReference.wkid in this._webMercatorValues,
this._extent=a.extent):a&&a.length&&(this._layers=a,this._isWebMercator=a[0].extent&&a[0].extent.spatialReference&&a[0].extent.spatialReference.wkid in this._webMercatorValues,this._isTableLayer=b.every(a,function(a){return"Table"===a.type}),this._extent=a[0].extent,this.saveItemForm.set("title",1===a.length?a[0].name:this.item.title));this._isWebMercator&&(!this._isTableLayer&&this.exportType===arcgisonline.sharing.dijit.dialog.ExportDlg.util.featureCollection)&&(b.removeClass(this._featureCollectionDiv,
"hide"),this.generalizeChk.set("checked",!0))},clear:function(){this.exportDialog.set("title",this.i18n.exportDialogTitle);this.item=null;this.layerId=-1;this.checkStatusInterval=this.exportResponse=this.exportType=null;this.checkingStatus=!1;this.saveItemForm.set("title","");this.saveItemForm.set("tags","");this.saveItemForm.set("summary","");this.saveItemForm.set("requires",["title","tags"]);b.style(this.exportingLabel,"visibility","hidden");this.exportBtn.set("disabled",!0);b.subscribe("onSaveItemValidate",
b.hitch(this,this.validate));this.saveItemForm.hideRow("folder");b.query(".select2-container.select2-container-multi",this.saveItemForm.domNode).style({minWidth:"334px",maxWidth:"334px"});b.addClass(this._featureCollectionDiv,"hide");this.generalizeChk.set("checked",!1)},hide:function(){return this.exportDialog.hide()},validate:function(a){this.exportBtn.set("disabled",!a)},validates:function(){var a=this.saveItemForm.get("title"),b=this.saveItemForm.get("tags");return a&&b},setWait:function(){b.query("#export-dialog").style("cursor",
"wait");b.style(this.exportingLabel,"visibility","visible");this.exportBtn.set("disabled",!0)},unsetWait:function(){b.query("#export-dialog").style("cursor","default");b.style(this.exportingLabel,"visibility","hidden");this.exportBtn.set("disabled",!1)},exportItem:function(){this.setWait();var a=this.saveItemForm.get("title"),c=this.generalizeChk.get("checked"),e={maxAllowableOffset:1,quantizationParameters:{tolerance:1}},d=arcgisonline.sharing.dijit.dialog.ExportDlg.util.shapefileType;arcgisonline.sharing.dijit.dialog.ExportDlg.util.csvType==
this.exportType?d=arcgisonline.sharing.dijit.dialog.ExportDlg.util.csvType:arcgisonline.sharing.dijit.dialog.ExportDlg.util.fileGDB==this.exportType?d=arcgisonline.sharing.dijit.dialog.ExportDlg.util.fileGDB:arcgisonline.sharing.dijit.dialog.ExportDlg.util.geoJson==this.exportType?d=arcgisonline.sharing.dijit.dialog.ExportDlg.util.geoJson:arcgisonline.sharing.dijit.dialog.ExportDlg.util.featureCollection==this.exportType&&(d=arcgisonline.sharing.dijit.dialog.ExportDlg.util.featureCollection);var g=
b.map(this._layers,b.hitch(this,function(a){return c?b.mixin({id:a.id},e):{id:a.id}})),a={itemId:this.item.id,title:a,exportFormat:d,exportParameters:-1<this.layerId?b.json.stringify({layers:g}):c?b.json.stringify(e):null},d=this.util.getUser();this.util.request({url:esriGeowConfig.restBaseUrl+"content/users/"+d.email+"/export",content:a},{usePost:!0}).then(b.hitch(this,this.handleExport),b.hitch(this,this.displayError))},handleExport:function(a){a&&!a.code&&!a.message?(this.exportResponse=a,this.checkStatusInterval=
setInterval(b.hitch(this,this.checkStatus),this.statusCheckIntervalTime)):this.displayError(a)},checkStatus:function(){if(this.exportResponse&&!this.checkingStatus){var a={jobId:this.exportResponse.jobId,jobType:"export"},c=this.util.getUser(),c=esriGeowConfig.restBaseUrl+"content/users/"+c.email+"/items/"+this.exportResponse.exportItemId+"/status";this.checkingStatus=!0;this.util.request({url:c,content:a}).then(b.hitch(this,function(a){this.handleStatusCheck(a);this.checkingStatus=!1}),b.hitch(this,
function(a){this.displayError(a);this.checkingStatus=!1}))}},handleStatusCheck:function(a){a.status&&("completed"===a.status?(clearInterval(this.checkStatusInterval),this.updateExportedItemDetails(a)):"failed"===a.status&&(clearInterval(this.checkStatusInterval),this.updateExportedItemDetailsAndFail(a)))},updateExportedItemDetailsAndFail:function(a){this.getItemDetails(this.exportResponse.exportItemId).then(b.hitch(this,function(c){this.updateItem(c.id,c.ownerFolder).then(b.hitch(this,function(b){this.unsetWait();
this.displayFailure(a.statusMessage)}))}))},updateExportedItemDetails:function(a){this.getItemDetails(a.itemId).then(b.hitch(this,function(c){this.updateItem(c.id,c.ownerFolder).then(b.hitch(this,function(b){this.goToItem(a.itemId)}))}))},updateItem:function(a,b){var e=this.saveItemForm.get("title"),d=this.saveItemForm.get("tags"),g=this.saveItemForm.get("summary"),f=this.util.getUser(),f=esriGeowConfig.restBaseUrl+"content/users/"+f.email;b&&0<b.length&&(f+="/"+b);f+="/items/"+this.exportResponse.exportItemId+
"/update";return this.util.request({url:f,content:{title:e,tags:d,snippet:g}},{usePost:!0})},getItemDetails:function(a){return this.util.request({url:esriGeowConfig.restBaseUrl+"content/items/"+a})},goToItem:function(a){this.hide().then(b.hitch(this,function(){this.unsetWait();window.location=esriGeowConfig.baseUrl+"item.html?id\x3d"+a}))},checkTitle:function(){var a=this.saveItemForm.get("title"),b=this.exportType,e=this.util.getUser().username;return this.util.request({url:esriGeowConfig.restBaseUrl+
"search",content:{q:'title:"'+a+'" AND type:"'+b+'" AND owner:'+e}})},displayFailure:function(a){var c;if(a)try{c=b.json.parse(a)}catch(e){c=a}var d=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();d.onOkClick=b.hitch(this,function(a){a.hide();this.onCancel()},d);c.message&&(a=c.message);d.show({title:this.i18n.errorTitle,message:a})},displayError:function(a){if(a){var c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();c.onOkClick=b.hitch(this,
function(a){a.hide();this.onCancel()},c);a.code&&a.message?c.show({title:this.i18n.errorTitle,message:a.message}):c.show({title:this.i18n.errorTitle,message:a})}},onChooseTags:function(){arcgisonline.sharing.dijit.dialog.TagsDlg.prototype.statics.getInstance().show()},onExport:function(){this.validates()&&this.checkTitle().then(b.hitch(this,function(a){0<a.total?(a=this.saveItemForm.get("title"),a=b.string.substitute(this.i18n.duplicateFound,{type:this.exportType,title:a}),arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.errorTitle,
message:a})):this.exportItem()}))},onCancel:function(a){a&&a.preventDefault();this.hide()}});arcgisonline.sharing.dijit.dialog.ExportDlg.util={shapefileType:"Shapefile",csvType:"CSV",fileGDB:"File Geodatabase",geoJson:"GeoJson",featureCollection:"Feature Collection",requiredBorder:"1px dotted orangered",normalBorder:"1px solid #bbb"}});