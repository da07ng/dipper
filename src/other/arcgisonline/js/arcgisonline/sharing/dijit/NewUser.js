// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/NewUser",["dijit","dojo","dojox","dojo/i18n!arcgisonline/nls/arcgisonline","dojo/require!dijit/_Widget,dijit/_Templated,dijit/layout/ContentPane,arcgisonline/sharing/util,arcgisonline/sharing/dijit/dialog/GeneralDlg,arcgisonline/sharing/dijit/dialog/TermsOfUseDlg,arcgisonline/sharing/geow/Geow,arcgisonline/sharing/geow/Account"],function(d,a,g){a.provide("arcgisonline.sharing.dijit.NewUser");a.require("dijit._Widget");a.require("dijit._Templated");a.require("dijit.layout.ContentPane");
a.require("arcgisonline.sharing.util");a.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");a.require("arcgisonline.sharing.dijit.dialog.TermsOfUseDlg");a.require("arcgisonline.sharing.geow.Geow");a.require("arcgisonline.sharing.geow.Account");a.requireLocalization("arcgisonline","arcgisonline");a.declare("arcgisonline.sharing.dijit.NewUser",[d._Widget,d._Templated],{widgetsInTemplate:!0,templateString:'\x3cdiv dojoType\x3d"dijit.layout.ContentPane" dojoAttachPoint\x3d"containerNode" style\x3d"min-height:300px;"\x3e\r\n  \x3cdiv dojoAttachPoint\x3d"newUserNode" style\x3d"display:none;"\x3e\r\n    \x3ch1 dojoAttachPoint\x3d"_welcomeHeader"\x3e\x3c/h1\x3e\r\n    \x3cdiv class\x3d"userInfo" dojoAttachPoint\x3d"_userInfo"\x3e\r\n        \x3clabel\x3e${i18n.usernameLabel}\x3c/label\x3e\x3cspan dojoAttachPoint\x3d"_username"\x3e\x3c/span\x3e\r\n        \x3cbr /\x3e\r\n        \x3clabel\x3e${i18n.emailLabel}\x3c/label\x3e\x3cspan dojoAttachPoint\x3d"_email"\x3e\x3c/span\x3e\r\n        \x3cbr /\x3e\r\n        \x3clabel\x3e${i18n.firstNameLabel}\x3c/label\x3e\x3cspan dojoAttachPoint\x3d"_firstName"\x3e\x3c/span\x3e\r\n        \x3cbr /\x3e\r\n        \x3clabel\x3e${i18n.lastNameLabel}\x3c/label\x3e\x3cspan dojoAttachPoint\x3d"_lastName"\x3e\x3c/span\x3e\r\n    \x3c/div\x3e\r\n    \x3cspan class\x3d"indent section"\x3e${i18n.formInstructions}\x3c/span\x3e\r\n    \x3cbr /\x3e\r\n    \x3cdiv class\x3d"formNode" dojoAttachPoint\x3d"_formNode"\x3e\r\n        \x3c!--\x3cdiv dojoAttachPoint\x3d"_passwordHintText" class\x3d"indent prompt hidden"\x3e${i18n.passwordHintText}\x3c/div\x3e--\x3e\r\n        \x3clabel\x3e${i18n.setPasswordLabel}\x3c/label\x3e\x3cinput dojoAttachPoint\x3d"_password" name\x3d"password" class\x3d"required" dojoType\x3d"dijit.form.TextBox" type\x3d"password" trim\x3d"true"\x3e\r\n        \x3cbr /\x3e\r\n        \x3clabel\x3e${i18n.verifyPasswordLabel}\x3c/label\x3e\x3cinput dojoAttachPoint\x3d"_verify" name\x3d"verify" class\x3d"required" dojoType\x3d"dijit.form.TextBox" type\x3d"password" trim\x3d"true"\x3e\r\n        \x3cbr /\x3e\r\n        \x3clabel\x3e${i18n.questionLabel}\x3c/label\x3e\x3cinput name\x3d"question" class\x3d"required" style\x3d"width:300px;" dojoAttachPoint\x3d"_select" class\x3d"select required" dojoType\x3d"dijit.form.Select"\x3e\r\n        \x3cbr /\x3e\r\n        \x3clabel\x3e${i18n.answerLabel}\x3c/label\x3e\x3cinput dojoAttachPoint\x3d"_answer" name\x3d"answer" class\x3d"required" dojoType\x3d"dijit.form.TextBox" trim\x3d"true"\x3e\r\n        \x3cbr /\x3e\r\n        \x3cdiv dojoAttachPoint\x3d"_terms"\x3e\x3clabel\x3e${i18n.termsOfUseLabel}\x3c/label\x3e\x3cbutton dojoAttachEvent\x3d"onClick:onTermsClick" class\x3d"calcite transparent" dojoType\x3d"dijit.form.Button" type\x3d"button"\x3e${i18n.reviewTermsOfUse}\x3c/button\x3e\x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv class\x3d"buttons indent" dojoAttachPoint\x3d"_buttons"\x3e\r\n        \x3cbutton dojoAttachPoint\x3d"_signInBtn" class\x3d"calcite blue" dojoAttachEvent\x3d"onClick:onSignInClick" dojoType\x3d"dijit.form.Button" type\x3d"button" disabled\x3d"true"\x3e${i18n.signIn}\x3c/button\x3e\r\n        \x3cbutton dojoType\x3d"dijit.form.Button" class\x3d"calcite transparent" dojoAttachEvent\x3d"onClick:onCancelClick" type\x3d"button"\x3e${i18n.cancel}\x3c/button\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e\r\n\r\n',
baseClass:"esriNewUser",_util:arcgisonline.sharing.util,_geow:arcgisonline.sharing.geow.Geow,_account:arcgisonline.sharing.geow.Account,_isSingleTenant:!1,postMixInProperties:function(){this.inherited(arguments);this.i18n=a.mixin({},a.i18n.getLocalization("arcgisonline","arcgisonline").common);this.i18n=a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").newUser);this.i18n.signUpWidget=a.i18n.getLocalization("arcgisonline","arcgisonline").signUpWidget;this.i18n.questions=a.mixin(this.i18n.questions,
a.i18n.getLocalization("arcgisonline","arcgisonline").securityQuestions);this._util.getCookie("esri_auth")&&this._geow.signout(window.location.href)},startup:function(){esri.config.defaults.io.proxyUrl=esriGeowConfig.proxyServer;this._errorDlg=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();this._svcUrl=esriGeowConfig.restBaseUrl+(esriGeowConfig.restBaseUrl.lastIndexOf("/")===esriGeowConfig.restBaseUrl.length-1?"":"/");this._communityUri=this._svcUrl+"community/";this._usersUri=
this._communityUri+"users/";this._accountsUri=this._svcUrl+"portals/";this._requestParams={f:"json"};a.mixin(this,a.queryToObject(window.location.search.slice(1)));this._isSingleTenant=void 0!==esriGeowConfig.isMultiTenant&&null!==esriGeowConfig.isMultiTenant&&!1===esriGeowConfig.isMultiTenant;this._loadQuestions();this._loadData()},isValid:function(){return this._checkRequired()?!1:this._password.get("value")!==this._verify.get("value")?(this._password.focus(),!this._showError(this.i18n.errors.passwordsNotMatch)):
!0},_containsAlphaNumeric:function(b){var a=/^[a-zA-Z0-9@_\.\-\s]+$/g;return b&&!!a.test(b)},_loadQuestions:function(){var b=a.map([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14],'return {"label":this.i18n.questions[item], "value":item};',this);this._select.set("options",b);this._select.reset()},_loadData:function(){return this._fetchInvitation().then(a.hitch(this,function(b){a.mixin(this,{user:b.username,org:b.account&&b.account.name});return this._signin().then(a.hitch(this,function(b){this._user=a.mixin(this._util.getUser(),
b);this._requestParams.token=this._user.token;this._signOut();return this._user})).then(a.hitch(this,"_loadUserInfo"))}))},_loadUserInfo:function(){var b=this._user.firstName;this.fullName=this._user.fullName;this._user.firstName=b?this._user.firstName:this.fullName.split(" ")[0];this._user.lastName=b?this._user.lastName:this.fullName.split(" ")[1];a.attr(this._welcomeHeader,"innerHTML",esri.substitute(this,this.i18n.welcomeHeader));a.attr(this._username,"innerHTML",this._user.username);a.attr(this._email,
"innerHTML",this._user.email);a.attr(this._firstName,"innerHTML",this._user.firstName);a.attr(this._lastName,"innerHTML",this._user.lastName);this._termsAccepted=!0;a.style(this._terms,"display","none");this._signInBtn.set("disabled",!1);esri.show(this.newUserNode)},onTermsClick:function(b){this.isValid()&&(a.subscribe("registerUser",a.hitch(this,function(){this._termsAccepted=!0;this._signInBtn.set("disabled",!1)})),arcgisonline.sharing.dijit.dialog.TermsOfUseDlg.prototype.statics.getInstance().show())},
onSignInClick:function(b){this._disable(!0);if(!this._isSingleTenant&&this.isValid())this._showJoinDlg().then(a.hitch(this,function(){return this._resetUser().then(a.hitch(this,"_signin")).then(a.hitch(this,"_acceptInvitation")).then(a.hitch(this,"_redirectToProfile"))}));else if(this._isSingleTenant&&this.isValid())return this._resetUser().then(a.hitch(this,"_signin")).then(a.hitch(this,"_acceptInvitation")).then(a.hitch(this,"_redirectToProfile"))},onCancelClick:function(){this._geow.signout(esriGeowConfig.baseUrl+
"index.html")},_resetUser:function(){var b=this._usersUri+this._user.username+"/reset",a={password:this.invitation,newPassword:this._password.get("value"),newSecurityQuestionIdx:this._select.get("value"),newSecurityAnswer:this._answer.get("value")};this._user.password=a.newPassword;return this._request(b.replace("http:","https:"),a,{usePost:!0})},_redirectToProfile:function(){var a=this._invitation&&this._invitation.account&&this._invitation.account.customUrl||null,c=window.location.protocol+"//"+
(a||window.location.host)+"/home/user.html",e=this._util.getCookie("esri_auth");a&&(c=this._util.getBridgeUrl(c,e));window.location=this._allSSL?c.replace("http:","https:"):c.replace("https:","http:")},_fetchInvitation:function(){return this._request(this._communityUri+"invitations/"+this.invitation,{}).then(a.hitch(this,function(a){return this._invitation=a}))},_signin:function(){var b=new a.Deferred,c={username:this.user,password:this._user&&this._user.password||this.invitation};esriGeowConfig.userInfo&&
esriGeowConfig.userInfo.token&&this._signOut();this._geow.signin(c,a.hitch(this,function(a){this._allSSL=a.ssl||!1;this._requestParams.token=a.token;b.resolve(a)}),a.hitch(this,function(a){this._showError(a)}));return b},_signOut:function(){esriGeowConfig.userInfo=null;esriGeowConfig.userPreferences=null;a.cookie("esri_auth",null,{expires:-1,path:"/",domain:document.domain});esriGeowConfig.isDebug||a.cookie("esri_auth",null,{expires:-1,path:"/",domain:".arcgis.com"});delete this._util._cookies.esri_auth;
a.cookie("esri_prefs",null,{expires:-1,path:"/"});a.publish("onSignOut",[])},_acceptInvitation:function(){var b=new a.Deferred;this._account.acceptInvitation(this.invitation,a.hitch(this,function(a){b.resolve(a)}),a.hitch(this,function(a){this._showError(a)}));return b.then(a.hitch(this,"_fixCookie"))},_fixCookie:function(){var b=new a.Deferred;this._geow.signInHandler(this._user.username,a.hitch(this,function(){b.resolve({success:!0})}),a.hitch(this,function(a){this._showError(a)}),esriGeowConfig.userInfo);
return b},_showJoinDlg:function(){var b=new a.Deferred,c="\x3cp\x3e\x3cstrong\x3e"+this.i18n.invite.joiningOrg+"\x3c/strong\x3e\x3c/p\x3e\x3cul\x3e",c=c+("\x3cli\x3e"+this.i18n.invite.createdContent+"\x3c/li\x3e"),c=c+("\x3cli\x3e"+this.i18n.signUpWidget.accountManagedMsg+"\x3c/li\x3e"),c=c+("\x3cli\x3e"+this.i18n.signUpWidget.leaveOrganization+"\x3c/li\x3e\x3c/ul\x3e"),c=esri.substitute(this,c),e=esri.substitute(this,this.i18n.invite.title),e=this._util.ellipse(e,50),f=this._errorDlg.onOkClick;this._errorDlg.onOkClick=
a.hitch(this,function(){this._errorDlg.onOkClick=f;this._errorDlg.hide();b.resolve()});var d=a.connect(this._errorDlg,"onCancel",a.hitch(this,function(){a.disconnect(d);this._disable(!1)}));this._errorDlg.show({title:e,message:c});return b},_disable:function(b){a.query(".esriNewUser .dijitTextBox, .esriNewUser .dijitButton, .esriNewUser .dijitSelect").map(d.byNode).forEach(function(a){a.set("disabled",b)})},_clear:function(){a.query(".esriNewUser .dijitTextBox").map(d.byNode).forEach(function(a){a.set("value",
"")})},_checkRequired:function(){var b=a.query(".required").map(d.byNode).filter(a.hitch(this,function(a){return this._isEmpty(a)}));return b&&b.length?(b[0].focus(),this._showError(this.i18n.errors.required[b[0].name])):!1},_isEmpty:function(a){var c=a.get("value");return a.declaredClass.indexOf("Select")&&0===c?!0:(this.trim?/^\s*$/:/^$/).test(c)},_request:function(b,c,d){c=a.mixin(c||{},this._requestParams);return this._util.request({url:b,content:c},d||{}).then(a.hitch(this,function(a){return a.error?
this._showError(a.error):a}),a.hitch(this,function(a){this._showError(a);this._disable(!1);throw a;}))},_showError:function(b){b=b.error||b||{};var c=b.code=b.messageCode||b.code||0;b=this.i18n.errors[b.code]||b;b.details=b.details&&b.details.length?a.filter(b.details,"return item !\x3d\x3d null"):null;b.details&&b.details.length&&(b.details=b.details.join("\x3cbr /\x3e"),b.message=b.message?b.message+"\x3cbr /\x3e"+b.details:b.details);b=a.mixin(a.mixin({},this.i18n.errors.error),b);this._isSingleTenant&&
b.portalMessage&&(b.message=b.portalMessage);"COM_0005"===c&&(this._errorDlg.onOkClick=a.hitch(this,function(){this._errorDlg.hide()}),this._errorDlg.onHide=a.hitch(this,function(){window.location=esriGeowConfig.baseUrl.replace("http:","https:")+esriGeowConfig.signin}));this._errorDlg.show(b);this._disable(!1);return!0}})});