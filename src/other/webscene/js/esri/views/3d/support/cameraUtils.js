// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../../../geometry/SpatialReference ../../../config ../../../geometry/Point ../../../geometry/support/webMercatorUtils ../../../Camera ../lib/glMatrix ./mathUtils ./earthUtils ./projectionUtils ./cameraUtilsPlanar ./cameraUtilsSpherical".split(" "),function(w,C,r,x,y,K,s,t,p,D,E){function u(a){var b;a.map&&(b=a.map.spatialReference);return b||w.WGS84}function v(a,b){return"spherical"===a._globeMode?E[b]:D[b]}function F(a,b,c){var d=a.renderSpatialReference,e=b.computeDirection(L),e=G(a,b.eye,
e,b.up,M);a=u(a);p.vectorToVector(b.eye,d,m,a)||(a=w.WGS84,p.vectorToVector(b.eye,d,m,a));return c?(c.position.x=m[0],c.position.y=m[1],c.position.z=m[2],c.position.spatialReference=a,c.heading=e.heading,c.tilt=e.tilt,c.fov=s.rad2deg(b.fov),c):new y(new r(m,a),e.heading,e.tilt,s.rad2deg(b.fov))}function H(a,b,c){var d=a.navigation.currentCamera,e=d.fovX,d=d.width/2;"spherical"===a._globeMode&&null!=c&&(b*=Math.cos(s.deg2rad(c)));b/=a.mapCoordsHelper.mapUnitInMeters;return d/(C.screenDPI*I/b)/Math.tan(e/
2)}function J(a,b,c){var d=a.navigation.currentCamera;b*=Math.tan(d.fovX/2);d=C.screenDPI*I/(d.width/2/b);"spherical"===a._globeMode&&(d/=Math.cos(s.deg2rad(c)));return d*=a.mapCoordsHelper.mapUnitInMeters}function G(a,b,c,d,e){return v(a,"directionToHeadingTilt")(b,c,d,e)}function A(a,b,c,d,e,f){var h=k.create(),l=a.renderSpatialReference;if(d&&d instanceof r){var g=d;p.pointToVector(g,h,a.renderSpatialReference);null==g.z&&("spherical"===a._globeMode?a._pickRay([0,0,0],h):a._pickRay([h[0],h[1]-
1,h[2]],h),null!=a.basemapTerrain&&(g=a.basemapTerrain.getElevation(g),null!=g&&a.renderCoordsHelper.setAltitude(h,g)))}else d?k.set(d,h):k.set(a.navigation.currentCamera.center,h);if(!d||!(d instanceof r))d=u(a),d=p.vectorToPoint(h,l,d);e=Math.max(e,a.navigation.minPoiDist);l=c;c=e;if(f=!f||!f.noReset)f=d,d=a.engineToScreen(a.navigation.currentCamera.center),g=a.toScreen(f),f=d.x-g.x,d=d.y-g.y,d=Math.sqrt(f*f+d*d),f=Math.max(a.width,a.height),f=d>N*f;f?(b=0,l=a.navigation.constraints.tilt.min(c)):
(l=v(a,"eyeTiltToLookAtTilt")(h,c,l),l=a.navigation.constraints.tilt.apply(l,c),l=v(a,"lookAtTiltToEyeTilt")(h,c,l));a=v(a,"eyeForCenterWithHeadingTilt")(h,e,b,l);a.center=h;return a}var k=K.vec3d,I=39.37,N=2,m=k.create(),z=k.create(),L=k.create(),M={heading:0,tilt:0},B=new s.Cyclical(-2.0037508342788905E7,2.0037508342788905E7);return{externalToInternal:function(a,b){var c=a.renderSpatialReference,d=v(a,"headingTiltToDirectionUp"),e=k.create();return p.pointToVector(b.position,e,c)?(c=d(e,b.heading,
b.tilt),k.add(c.direction,e),e=a.navigation.getCameraIntersectTerrain(e,c.direction,c.up),e.fov=s.deg2rad(b.fov),e):null},internalToExternal:F,scaleToDistance:H,distanceToScale:J,fromExtent:function(a,b,c,d,e){d instanceof y&&(e=d,d={});var f="spherical"===a._globeMode,h=a.renderSpatialReference,l=u(a),g=w.WebMercator,q=b.spatialReference||g,k,m=0;null!=b.zmax&&null!=b.zmin&&(k=(b.zmax+b.zmin)/2,m=b.zmax-b.zmin);if(f){var f=new r(b.xmin,b.ymin,q),n=new r(b.xmax,b.ymax,q),f=x.project(f,g),n=x.project(n,
g);if(null===f||null===n)return;b=new r(B.center(f.x,n.x),(n.y+f.y)/2,g);null!=k&&(b.z=k);q=t.getGreatCircleSpanAt(b,f,n);g=q.lon;q=q.lat;B.diff(f.x,n.x)>B.range/2&&(g+=t.halfEarthCircumference);g=Math.min(g,t.halfEarthCircumference);q=Math.min(q,t.halfEarthCircumference)}else x.canProject(b,l)&&(b=x.project(b,l)),g=b.xmax-b.xmin,q=b.ymax-b.ymin,b=new r({x:b.xmin+0.5*g,y:b.ymin+0.5*q,z:k,spatialReference:l});n=a.navigation.currentCamera;k=1/Math.tan(n.fovX/2);f=1/Math.tan(n.fovY/2);n=1/Math.tan(n.fov/
2);m=Math.max(0.5*g*k,0.5*q*f,0.5*m*n)/1;c||(c=a._externalCamera());a=A(a,c.heading,c.tilt,b,m,d);h=p.vectorToPoint(a.eye,h,l);if(!h)return null;e||(e=new y);e.position=h;e.heading=a.heading;e.tilt=a.tilt;e.fov=c.fov;return e},toExtent:function(a,b,c,d,e){var f=a.renderSpatialReference;b||(c||(c=a.navigation.currentCamera),b=F(a,c,e));if(c)e=p.vectorToPoint(c.center,f,u(a)),b=c.distance;else{e=a.toMap(a.screenCenter);if(!e)return null;b=t.computeCarthesianDistance(b.position,e)}c||(c=a.navigation.currentCamera);
f=Math.tan(c.fovX/2);c=Math.tan(c.fovY/2);f=1*2*b*f;c=1*2*b*c;return"spherical"===a._globeMode?E.toExtent(a,e,f,c,d):D.toExtent(a,e,f,c,d)},fromCenterScale:function(a,b,c,d,e,f){var h=H(a,c,b.latitude);c=a.renderSpatialReference;b=A(a,d.heading,d.tilt,b,h,e);a=u(a);a=p.vectorToPoint(b.eye,c,a);if(!a)return null;if(!f)return new y(a,b.heading,b.tilt,d.fov);f.position=a;f.heading=b.heading;f.tilt=b.tilt;f.fov=d.fov;return f},directionToHeadingTilt:G,eyeHeadingTiltForCenterPointAtDistance:A,scaleToZoom:function(a,
b){var c=a.get("basemapTerrain.tilingScheme");return c?c.levelAtScale(b):void 0},zoomToScale:function(a,b){var c=a.get("basemapTerrain.tilingScheme");return c?c.scaleAtLevel(b):void 0},computeScale:function(a,b,c){var d=a.renderSpatialReference;b||(b=a.navigation.currentCamera);var e;e=w.WGS84;b.center?(p.vectorToVector(b.center,d,z,e),e=z[1],b=b.distance):(e=b.position.latitude,p.pointToVector(b.position,m,d),p.pointToVector(c,z,d),b=k.dist(m,z));return J(a,b,e)}}});