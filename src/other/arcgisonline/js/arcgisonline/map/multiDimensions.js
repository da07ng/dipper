// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/multiDimensions",["dijit","dojo","dojox","dojo/require!arcgisonline/map/main,dojo/touch"],function(h,a,k){a.provide("arcgisonline.map.multiDimensions");a.require("arcgisonline.map.main");a.require("dojo.touch");arcgisonline.map.multiDimensions={mdSlider:null,mdSliderProperties:null,mdSliderDefaultInterval:null,handlers:[],checkOnMdSliderButton:function(){arcgisonline.map.multiDimensions.fetchMapMdInfo().then(function(c){if(arcgisonline.map.multiDimensions.defaultDimension||
arcgisonline.map.multiDimensions.getDefaultVisibleDimension())arcgisonline.map.multiDimensions.hasVisibleMdLayer()?arcgisonline.map.multiDimensions.mdSlider?arcgisonline.map.multiDimensions.updateMdSlider():arcgisonline.map.multiDimensions.showMdSlider():(arcgisonline.map.multiDimensions.mdSlider&&(arcgisonline.map.multiDimensions.removeMdSlider(),a.style(a.byId("multidimensionalDiv"),"visibility","hidden")),arcgisonline.map.multiDimensions.hasMdLayer()||(arcgisonline.map.multiDimensions.mdSliderProperties=
null))})},showMdSlider:function(){if(!arcgisonline.map.multiDimensions.mdSlider){var c,d=!1,b=3E3,e=!0,f,g=arcgisonline.map.multiDimensions.mdSliderProperties;c=arcgisonline.map.multiDimensions.getDefaultVisibleDimension();g&&(d=!!g.useRanges,b=g.thumbMovingRate||b,e=!!g.playDirectionAscending,c=g.dimension&&arcgisonline.map.multiDimensions.hasVisibleMdLayer(g.dimension)?g.dimension:c);a.forEach(arcgisonline.map.main.mapLayers,function(b){b.layer&&b.layer.useMapDimensionValue&&(b.layer.activeMapDimensions&&
0<b.layer.activeMapDimensions.length?0>a.indexOf(b.layer.activeMapDimensions,c)&&b.layer.activeMapDimensions.push(c):(f=[],f.push(c),b.layer.activeMapDimensions=f))});arcgisonline.map.multiDimensions.mdSliderProperties={dimension:c,dimensionInterval:void 0,dimensionRange:void 0,useRanges:d,thumbMovingRate:b,playDirectionAscending:e};arcgisonline.map.multiDimensions.mdSlider=new esri.dijit.MultidimensionalSlider({map:arcgisonline.map.main.map,dimension:c,dimensionValues:void 0,useLayersDimSlices:!0,
layout:"vertical",useRanges:d,thumbMovingRate:b,nLabels:10,showPlayButton:!1,playDirectionAscending:e},"mdSlider");arcgisonline.map.multiDimensions.mdSlider.startup();arcgisonline.map.multiDimensions.updateUI();10>a.isIE?arcgisonline.map.multiDimensions.activateSlider():arcgisonline.map.multiDimensions.deactivateSlider();arcgisonline.map.multiDimensions.showPassiveLabels();arcgisonline.map.multiDimensions.adjustSliderStyle();arcgisonline.map.multiDimensions.mdSlider.onChange=arcgisonline.map.multiDimensions.updatePassiveLabels;
(new a.dnd.move.constrainedMoveable(a.byId("multidimensionalDiv"),{within:!0,constraints:function(){return a.coords(a.byId("map"))}})).onMoved=arcgisonline.map.multiDimensions.updatePassiveLabels;a.style(a.byId("multidimensionalDiv"),"visibility","visible");arcgisonline.map.multiDimensions.setupHandles()}},setupHandles:function(){var c;arcgisonline.map.multiDimensions.handlers[0]=a.connect(h.byId("mdSliderSettingsButton"),"onClick",arcgisonline.map.multiDimensions,"displaySettings");arcgisonline.map.multiDimensions.handlers[1]=
a.connect(h.byId("mdSliderAnimateButton"),"onClick",arcgisonline.map.multiDimensions,"toggleAnimateMode");arcgisonline.map.multiDimensions.handlers[3]=a.connect(arcgisonline.map.multiDimensions.mdSlider,"onChange",arcgisonline.map.multiDimensions,"onMultidimensionalDefinitionChanged");arcgisonline.map.multiDimensions.handlers[4]=a.connect(arcgisonline.map.main.map,"onResize",arcgisonline.map.multiDimensions,"adjustSliderStyle");arcgisonline.map.multiDimensions.handlers[5]=a.connect(h.byId("mdSliderPreviousButton"),
"onClick",arcgisonline.map.multiDimensions,"decrement");arcgisonline.map.multiDimensions.handlers[6]=a.connect(h.byId("mdSliderNextButton"),"onClick",arcgisonline.map.multiDimensions,"increment");arcgisonline.map.multiDimensions.handlers[7]=a.connect(a.byId("multidimensionalDiv"),"onmouseover",arcgisonline.map.multiDimensions,"activateSlider");arcgisonline.map.multiDimensions.handlers[8]=a.connect(a.byId("multidimensionalDiv"),"onmouseleave",arcgisonline.map.multiDimensions,"deactivateSlider");arcgisonline.map.multiDimensions.handlers[9]=
a.connect(a.byId("multidimensionalDiv"),a.touch.press,arcgisonline.map.multiDimensions,"activateSlider");arcgisonline.map.multiDimensions.handlers[10]=a.connect(a.byId("multidimensionalDiv"),a.touch.release,arcgisonline.map.multiDimensions,"deactivateSlider");arcgisonline.map.multiDimensions.handlers[11]=a.connect(h.byId("mdSliderPreviousButton"),a.touch.press,arcgisonline.map.multiDimensions,"activateSlider");arcgisonline.map.multiDimensions.handlers[12]=a.connect(h.byId("mdSliderNextButton"),a.touch.press,
arcgisonline.map.multiDimensions,"activateSlider");arcgisonline.map.multiDimensions.handlers[13]=a.connect(h.byId("mdSliderSettingsButton"),a.touch.press,arcgisonline.map.multiDimensions,"activateSlider");arcgisonline.map.multiDimensions.handlers[14]=a.connect(h.byId("mdSliderAnimateButton"),a.touch.press,arcgisonline.map.multiDimensions,"activateSlider");c=a.query("#multidimensionalDiv .dijitSliderImageHandle.dijitSliderImageHandleV");a.forEach(c,function(d){console.log(c);arcgisonline.map.multiDimensions.handlers.push(a.connect(d,
a.touch.press,arcgisonline.map.multiDimensions,"activateSlider"));arcgisonline.map.multiDimensions.handlers.push(a.connect(d,a.touch.release,arcgisonline.map.multiDimensions,"deactivateSlider"))},this)},removeHandles:function(){a.forEach(arcgisonline.map.multiDimensions.handlers,function(c){a.disconnect(c)},this);arcgisonline.map.multiDimensions.handlers=[]},activateSlider:function(){9>a.isIE&&a.style("multidimensionalDiv","background","#fff");arcgisonline.map.multiDimensions.sliderActive=!0;arcgisonline.map.multiDimensions.deactivateTimer&&
clearTimeout(arcgisonline.map.multiDimensions.deactivateTimer);a.removeClass("multidimensionalDiv","mdSliderPassive");a.addClass("multidimensionalDiv","mdSliderActive");a.style("mdSliderPassiveLbl","display","none");a.style("mdSliderPassiveLbl1","display","none")},deactivateSlider:function(){10>a.isIE||(arcgisonline.map.multiDimensions.deactivateTimer=setTimeout(function(){arcgisonline.map.multiDimensions.sliderActive=!1;arcgisonline.map.multiDimensions.updatePassiveLabels();a.removeClass("multidimensionalDiv",
"mdSliderActive");a.addClass("multidimensionalDiv","mdSliderPassive");arcgisonline.map.multiDimensions.showPassiveLabels()},2500))},showPassiveLabels:function(){arcgisonline.map.multiDimensions.mdSlider&&arcgisonline.map.multiDimensions.mdSlider.value&&(a.style("mdSliderPassiveLbl","display","block"),arcgisonline.map.multiDimensions.mdSlider.value.length?a.style("mdSliderPassiveLbl1","display","block"):a.style("mdSliderPassiveLbl1","display","none"))},updatePassiveLabels:function(){arcgisonline.map.multiDimensions.mdSlider&&
arcgisonline.map.multiDimensions.mdSlider.value&&(pos=a.position(a.query("#multidimensionalDiv .dijitSliderImageHandle.dijitSliderImageHandleV")[0]),mapPos=a.position(a.query("#map")[0]),a.style("mdSliderPassiveLbl","top",pos.y-mapPos.y+"px"),a.style("mdSliderPassiveLbl","left",pos.x-mapPos.x+20+"px"),a.byId("mdSliderPassiveLbl").innerHTML=arcgisonline.map.multiDimensions.mdSlider.value.length?arcgisonline.map.multiDimensions.mdSlider.value[0]:arcgisonline.map.multiDimensions.mdSlider.value,arcgisonline.map.multiDimensions.mdSlider.value.length&&
(pos1=a.position(a.query("#multidimensionalDiv .dijitSliderImageHandle.dijitSliderImageHandleV")[1]),a.style("mdSliderPassiveLbl1","top",pos1.y-mapPos.y+"px"),a.style("mdSliderPassiveLbl1","left",pos1.x-mapPos.x+20+"px"),a.byId("mdSliderPassiveLbl1").innerHTML=arcgisonline.map.multiDimensions.mdSlider.value[1]),arcgisonline.map.multiDimensions.sliderActive||arcgisonline.map.multiDimensions.showPassiveLabels())},increment:function(){arcgisonline.map.multiDimensions.mdSlider&&arcgisonline.map.multiDimensions.mdSlider.increment()},
decrement:function(){arcgisonline.map.multiDimensions.mdSlider&&arcgisonline.map.multiDimensions.mdSlider.decrement()},updateMdSlider:function(){var c,d=arcgisonline.map.multiDimensions.mdSlider.dimension;a.forEach(arcgisonline.map.main.mapLayers,function(b){b.layer&&b.layer.useMapDimensionValue&&(b.layer.activeMapDimensions&&0<b.layer.activeMapDimensions.length?0>a.indexOf(b.layer.activeMapDimensions,d)&&b.layer.activeMapDimensions.push(d):(c=[],c.push(d),b.layer.activeMapDimensions=c))});arcgisonline.map.multiDimensions.mdSlider.update()},
addActiveDimension:function(c,d){var b;d||(d=arcgisonline.map.multiDimensions.mdSlider?arcgisonline.map.multiDimensions.mdSlider.dimension:arcgisonline.map.multiDimensions.getDefaultVisibleDimension());d&&(c.activeMapDimensions&&0<c.activeMapDimensions.length?0>a.indexOf(c.activeMapDimensions,d)&&c.activeMapDimensions.push(d):(b=[],b.push(d),c.activeMapDimensions=b));a.publish("map-dimension-changed",[])},removeActiveDimension:function(c){var d;(d=arcgisonline.map.multiDimensions.mdSlider?arcgisonline.map.multiDimensions.mdSlider.dimension:
arcgisonline.map.multiDimensions.getDefaultVisibleDimension())&&c.activeMapDimensions&&0<c.activeMapDimensions.length&&0<=a.indexOf(c.activeMapDimensions,d)&&c.activeMapDimensions.splice(a.indexOf(c.activeMapDimensions,d),1)},hasVisibleMdLayer:function(c){var d,b;b=arcgisonline.map.multiDimensions.mdSlider?arcgisonline.map.multiDimensions.mdSlider.dimension:arcgisonline.map.multiDimensions.getDefaultVisibleDimension();c=c||b;a.forEach(arcgisonline.map.main.mapLayers,function(b){b.multidimensionalInfo&&
(b.layer&&b.layer.visible&&b.layer.useMapDimensionValue)&&a.some(b.multidimensionalInfo.variables,function(b){a.some(b.dimensions,function(a){a.name===c&&(d=!0)})})});return d},hasMdLayer:function(c){var d;c=c||arcgisonline.map.multiDimensions.getDefaultDimension();a.forEach(arcgisonline.map.main.mapLayers,function(b){b.multidimensionalInfo&&(b.layer&&b.layer.useMapDimensionValue)&&a.some(b.multidimensionalInfo.variables,function(b){a.some(b.dimensions,function(a){a.name===c&&(d=!0)})})});return d},
removeMdSlider:function(){arcgisonline.map.multiDimensions.removeHandles();var c=arcgisonline.map.multiDimensions.mdSlider.id,d=a.byId(c).parentNode;delete arcgisonline.map.multiDimensions.defaultDimension;arcgisonline.map.multiDimensions.mdSlider.destroy();arcgisonline.map.multiDimensions.mdSlider=null;arcgisonline.map.multiDimensions.mdSlider=null;a.style("mdSliderPassiveLbl","display","none");a.style("mdSliderPassiveLbl1","display","none");a.create("div",{id:c},d)},getDefaultVisibleDimension:function(){var c=
["StdZ","StdPressure"],d=arcgisonline.map.main.mapLayers,b,e,f;for(f=0;f<d.length;f++)b=d[f],b.layer&&(b.multidimensionalInfo&&b.layer.visible)&&a.some(b.multidimensionalInfo.variables,function(b){if(a.some(b.dimensions,function(b){if(0<=a.indexOf(c,b.name)&&(e=b.name,0===a.indexOf(c,b.name)))return!0;"StdTime"!==b.name&&(e=b.name)}))return!0});return arcgisonline.map.multiDimensions.defaultDimension=e},getDefaultDimension:function(){var c=["StdZ","StdPressure"],d=arcgisonline.map.main.mapLayers,
b,e,f;for(f=0;f<d.length;f++)b=d[f],b.layer&&b.multidimensionalInfo&&a.some(b.multidimensionalInfo.variables,function(b){if(a.some(b.dimensions,function(b){if(0<=a.indexOf(c,b.name)&&(e=b.name,0===a.indexOf(c,b.name)))return!0;"StdTime"!==b.name&&(e=b.name)}))return!0});return arcgisonline.map.multiDimensions.defaultDimension=e},getMultidimensionalInfo:function(c){function d(){e.getMultidimensionalInfo().then(function(a){e.multidimensionalInfo=a;b.resolve(e)},function(a){b.reject(a)})}var b=new a.Deferred,
e=c.layer;if(!e)return b;c.multidimensionalInfo?(e.multidimensionalInfo=c.multidimensionalInfo,b.resolve(e)):d();return b},fetchMapMdInfo:function(){for(var c=arcgisonline.map.main.mapLayers,d,b=[],e=0;e<c.length;e++)d=c[e],d.layer&&d.layer.hasMultidimensions&&b.push(arcgisonline.map.multiDimensions.getMultidimensionalInfo(d));return new a.DeferredList(b)},displaySettings:function(){arcgisonline.sharing.dijit.dialog.MdSliderSettingsDlg.prototype.statics.getInstance().show(arcgisonline.map.main.mapLayers)},
getNumericDimensions:function(){var c=[],d=[],b;a.forEach(arcgisonline.map.main.mapLayers,function(e){e.multidimensionalInfo&&(e.multidimensionalInfo.variables&&e.layer&&e.layer.visible&&e.layer.useMapDimensionValue)&&a.forEach(e.multidimensionalInfo.variables,function(e){a.forEach(e.dimensions,function(e){b=this.getDimensionAlias(e.name);e.name&&(0>e.name.toLowerCase().indexOf("time")&&0>a.indexOf(d,e.name))&&(c.push({id:e.name,label:b?b:e.name}),d.push(e.name))},this)},this)},this);return c},getDimensionAlias:function(c){var d=
null,b;a.some(arcgisonline.map.main.mapLayers,function(e){if(e&&e.layer&&(b=e.layer,b.fields&&b.fields.length&&a.some(b.fields,function(a){if(a.name&&a.name===c&&a.alias)return d=a.alias,!0},this)))return!0},this);return d},toggleAnimateMode:function(){var a=arcgisonline.map.multiDimensions.mdSlider;a.playing?a.pause():a.play();arcgisonline.map.multiDimensions.updateUI()},updateUI:function(){arcgisonline.map.multiDimensions.mdSlider.playing?h.byId("mdSliderAnimateButton").set("iconClass","esriMdSliderPauseIcon"):
h.byId("mdSliderAnimateButton").set("iconClass","esriMdSliderAnimateIcon")},disableDimensionAnimation:function(a){},createDimensionValues:function(a,d){if(!d||!esri.isDefined(a)||!esri.isDefined(a[0])||!esri.isDefined(a[1]))return null;for(var b=[],e=Math.floor((a[1]-a[0])/d),f=0,g=a[0];f<=e;)b.push(g),f++,g+=d;return b},onMultidimensionalDefinitionChanged:function(){a.forEach(arcgisonline.map.main.mapLayers,function(c){c.layer&&(c.layer.activeMapDimensions&&a.indexOf(c.layer.activeMapDimensions,
arcgisonline.map.multiDimensions.mdSlider.dimension))&&(c.mosaicRuleChanged=!0)})},positionSlider:function(){a.style(a.byId("multidimensionalDiv"),"left",arcgisonline.map.main.map.width-97+"px");a.style(a.byId("multidimensionalDiv"),"right","5px");a.position(arcgisonline.map.main.map.root);a.style(a.byId("multidimensionalDiv"),"top","200px")},getUnit:function(c){var d=null,b=!1,e;a.forEach(arcgisonline.map.main.mapLayers,function(f){f&&(f.layer&&f.layer.multidimensionalInfo)&&(e=f.layer,a.forEach(e.multidimensionalInfo.variables,
function(e){a.forEach(e.dimensions,function(a){a.name===c&&a.unit&&(null==d&&!b?d=a.unit.replace("esri",""):esri.isDefined(a.unit)&&a.unit.replace("esri","").toLowerCase()!=d.toLowerCase()&&(d=null,b=!0))},this)},this))},this);return d},adjustSliderStyle:function(){var c=Math.min(0.7*arcgisonline.map.main.map.height,arcgisonline.map.main.map.height-210);a.style("multidimensionalDiv","height",c+"px");arcgisonline.map.multiDimensions.mdSlider?(arcgisonline.map.multiDimensions.positionSlider(),arcgisonline.map.multiDimensions.mdSlider.resizeSlider(c-
70,100)):(a.style("multidimensionalSliderRow","height",c-70+"px"),a.style("mdSlider","height",c-70+"px"));arcgisonline.map.multiDimensions.updatePassiveLabels()},toJson:function(){if(arcgisonline.map.multiDimensions.mdSliderProperties){var a={};arcgisonline.map.multiDimensions.mdSliderProperties.dimensionRange&&(a.dimensionRange=arcgisonline.map.multiDimensions.mdSliderProperties.dimensionRange);arcgisonline.map.multiDimensions.mdSliderProperties.dimension&&(a.dimension=arcgisonline.map.multiDimensions.mdSliderProperties.dimension);
arcgisonline.map.multiDimensions.mdSliderProperties.thumbMovingRate&&(a.thumbMovingRate=arcgisonline.map.multiDimensions.mdSliderProperties.thumbMovingRate);arcgisonline.map.multiDimensions.mdSliderProperties.dimensionInterval&&(a.dimensionInterval=arcgisonline.map.multiDimensions.mdSliderProperties.dimensionInterval);arcgisonline.map.multiDimensions.mdSliderProperties.useRanges&&(a.useRanges=arcgisonline.map.multiDimensions.mdSliderProperties.useRanges)}return a}}});