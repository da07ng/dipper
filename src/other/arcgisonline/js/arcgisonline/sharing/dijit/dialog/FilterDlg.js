// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/FilterDlg",["dijit","dojo","dojox","dojo/i18n!arcgisonline/nls/arcgisonline","dojo/require!dijit/_Widget,dijit/_Templated,dijit/form/Button,dojox/widget/Standby,dijit/layout/TabContainer,dojo/data/ItemFileWriteStore,dijit/form/DateTextBox,dojo/i18n,arcgisonline/sharing/dijit/SingleFilter,arcgisonline/sharing/dijit/SingleInteractiveFilter,arcgisonline/sharing/dijit/FilterSet,arcgisonline/sharing/dijit/dialog/GeneralDlg,arcgisonline/map/main,arcgisonline/sharing/util"],
function(k,d,v){d.provide("arcgisonline.sharing.dijit.dialog.FilterDlg");d.require("dijit._Widget");d.require("dijit._Templated");d.require("dijit.form.Button");d.require("dojox.widget.Standby");d.require("dijit.layout.TabContainer");d.require("dojo.data.ItemFileWriteStore");d.require("dijit.form.DateTextBox");d.require("dojo.i18n");d.requireLocalization("arcgisonline","arcgisonline");d.require("arcgisonline.sharing.dijit.SingleFilter");d.require("arcgisonline.sharing.dijit.SingleInteractiveFilter");
d.require("arcgisonline.sharing.dijit.FilterSet");d.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");d.require("arcgisonline.map.main");d.require("arcgisonline.sharing.util");d.declare("arcgisonline.sharing.dijit.dialog.FilterDlg",[k._Widget,k._Templated],{widgetsInTemplate:!0,templateString:d.cache("arcgisonline.sharing.dijit.dialog","templates/FilterDlg.html",'\x3cdiv dojoAttachPoint\x3d"containerNode" dojoType\x3d"dijit.layout.BorderContainer" class\x3d"esriItemLinks" gutters\x3d"false" design\x3d"headline" region\x3d"center"\x3e\r\n  \x3cdiv dojoType\x3d"dijit.layout.TabContainer" dojoAttachPoint\x3d"_tabContainer" region\x3d"center" style\x3d"width:100%;height:100%;overflow:hidden;"\x3e\r\n    \x3cdiv dojoType\x3d"dijit.layout.ContentPane" id\x3d"ViewChangeTab" title\x3d"${i18n.view}" dojoAttachPoint\x3d"_tabView" class\x3d"tabContainerContent"\x3e\r\n      \x3cdiv dojoAttachPoint\x3d"interactiveDiv" class\x3d"interactiveSection" style\x3d"display:none;"\x3e\r\n        \x3cdiv dojoAttachPoint\x3d"allInteractiveExpr"\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv class\x3d"esriFloatLeading" style\x3d"margin-top:5px; margin-bottom:15px;"\x3e\r\n          \x3cdiv dojoType\x3d"dijit.form.Button" type\x3d"button" id\x3d"applyInteractiveFilterButton" dojoAttachEvent\x3d"onClick:onApplyInteractiveFilter" label\x3d"${i18n.applyFilterBtn}"\x3e\r\n          \x3c/div\x3e\r\n          \x3cdiv dojoType\x3d"dijit.form.Button" type\x3d"button" id\x3d"applyInteractiveFilterAndZoomButton" dojoAttachEvent\x3d"onClick:onApplyInteractiveFilterAndZoom" label\x3d"${i18n.applyFilterAndZoomBtn}" style\x3d"display:none;"\x3e\r\n          \x3c/div\x3e\r\n        \x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv dojoAttachPoint\x3d"friendlyText" class\x3d"friendlyText"\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv dojoAttachPoint\x3d"friendlyTextButton" class\x3d"esriFloatLeading" style\x3d"margin-top:5px;padding:0 10px;"\x3e\r\n        \x3cdiv dojoType\x3d"dijit.form.Button" type\x3d"button" dojoAttachEvent\x3d"onClick:onRemoveFilter" label\x3d"${i18n.removeFilterBtn}"\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv dojoType\x3d"dijit.form.Button" class\x3d"primary" type\x3d"button" dojoAttachEvent\x3d"onClick:onClose" label\x3d"${i18n.close}"\x3e\r\n        \x3c/div\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3cdiv dojoType\x3d"dijit.layout.ContentPane" id\x3d"CreateEditTab" title\x3d"${i18n.edit}" dojoAttachPoint\x3d"_tabEdit" class\x3d"tabContainerContent"\x3e\r\n      \x3cdiv class\x3d"esriFloatTrailing"\x3e\r\n        \x3ca href\x3d"JavaScript:void(0);" dojoAttachPoint\x3d"addExpressionLink"\x3e\r\n        \t\x3cspan class\x3d"esriAGOFilterAddExpIcon" title\x3d"${i18n.addAnotherExpression}"\x3e\x3c/span\x3e\r\n\t\t\t\t\t\x3cspan\x3e${i18n.addAnotherExpression}\x3c/span\x3e\r\n\t\t\t\t\x3c/a\x3e\r\n\t\t\t\t\x3ca class\x3d"esriLeadingMargin1" href\x3d"JavaScript:void(0);" dojoAttachPoint\x3d"addSetLink"\x3e\r\n\t\t\t\t\t\x3cspan class\x3d"esriAGOFilterAddSetIcon" title\x3d"${i18n.addSetTooltip}"\x3e\x3c/span\x3e\r\n\t\t\t\t\t\x3cspan\x3e${i18n.addSet}\x3c/span\x3e\r\n\t\t\t\t\x3c/a\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv style\x3d"clear:both;"\x3e\r\n        \x3cdiv id\x3d"match1Msg" class\x3d"matchMsg"\x3e\r\n          ${i18n.match1Msg}\r\n        \x3c/div\x3e\r\n        \x3cdiv id\x3d"matchMsg" class\x3d"matchMsg" style\x3d"display:none;"\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv class\x3d"allExpsBox" style\x3d"background-color:rgb(247, 247, 243);"\x3e\r\n          \x3cdiv dojoAttachPoint\x3d"allExps" class\x3d"allExps"\x3e\r\n          \x3c/div\x3e\r\n        \x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv style\x3d"margin-top:20px; display:none;"\x3e\r\n        \x3cdiv class\x3d"title"\x3e\r\n          ${i18n.applyFilter}\r\n        \x3c/div\x3e\r\n        \x3ctable cellspacing\x3d"0" cellpadding\x3d"10"\x3e\r\n          \x3ctbody\x3e\r\n            \x3ctr\x3e\r\n              \x3ctd\x3e\r\n                \x3cinput type\x3d"radio" name\x3d"action" value\x3d"thislayer" id\x3d"thislayer" checked\x3d"checked" dojoAttachEvent\x3d"onChange:toggleNewLayerNameTextBox" /\x3e\r\n                \x3clabel for\x3d"this"\x3e\r\n                  ${i18n.toThisLayer}\r\n                \x3c/label\x3e\r\n              \x3c/td\x3e\r\n              \x3ctd\x3e\r\n                \x3cinput type\x3d"radio" name\x3d"action" value\x3d"new" id\x3d"new" dojoAttachEvent\x3d"onChange:toggleNewLayerNameTextBox" disabled\x3d"true"/\x3e\r\n                \x3clabel for\x3d"new"\x3e\r\n                  ${i18n.toNewLayer}\r\n                \x3c/label\x3e\r\n                \x3cinput style\x3d"margin-left:10px; width:350px;display:none;" id\x3d"newLayerName" placeholder\x3d"${i18n.newLayerName}" type\x3d"text"/\x3e\r\n              \x3c/td\x3e\r\n            \x3c/tr\x3e\r\n          \x3c/tbody\x3e\r\n        \x3c/table\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"submitButtons dijitDialogPaneActionBar esriFloatTrailing" style\x3d"margin-top:5px;"\x3e\r\n        \x3cdiv dojoType\x3d"dijit.form.Button" type\x3d"button" class\x3d"primary" id\x3d"applyFilterButton" dojoAttachEvent\x3d"onClick:onApplyFilter" label\x3d"${i18n.applyFilterBtn}"\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv dojoType\x3d"dijit.form.Button" type\x3d"button" class\x3d"primary" id\x3d"applyFilterAndZoomButton" dojoAttachEvent\x3d"onClick:onApplyFilterAndZoom" label\x3d"${i18n.applyFilterAndZoomBtn}" style\x3d"display:none;"\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv dojoType\x3d"dijit.form.Button" type\x3d"button" class\x3d"cancel" dojoAttachEvent\x3d"onClick:onClose" label\x3d"${i18n.close}"\x3e\r\n        \x3c/div\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e\r\n'),
isLayoutContainer:!0,baseClass:"esriAGOFilterForm",partsObj:null,fieldDomains:{},fieldsStore:null,fieldsInfo:{stringFieldsCount:0,numberFieldsCount:0,dateFieldsCount:0},stringOperatorStore:null,dateOperatorStore:null,numberOperatorStore:null,uniqueValuesStore:null,expressionCount:1,interactiveExpressionCount:1,dayInMS:86399E3,uniqueValuesResults:{},disableCheckOk:!0,isHosted:!1,postMixInProperties:function(){this.inherited(arguments);this.i18n=d.i18n.getLocalization("arcgisonline","arcgisonline").common;
this.i18n=d.mixin(this.i18n,d.i18n.getLocalization("arcgisonline","arcgisonline").GeneralDlg);this.i18n=d.mixin(this.i18n,d.i18n.getLocalization("arcgisonline","arcgisonline").FilterDlg)},startup:function(){this.inherited(arguments);this._loadConnections()},resize:function(){this._tabContainer&&this._tabContainer.resize()},_loadConnections:function(){this.user=arcgisonline.sharing.util.getUser();this._dlgConnect=d.connect(this.dialog,"hide",d.hitch(this,function(){this.destroy()}));this.addExprHandler=
d.connect(this.addExpressionLink,"onclick",this,"onAddExpressionClick");this.addSetHandler=d.connect(this.addSetLink,"onclick",this,"onAddSetClick");this.exprChangeHandler=d.subscribe("onExprChange",d.hitch(this,function(a){this.checkOK()}));this.ineractiveExprChangeHandler=d.subscribe("onInteractiveExprChange",d.hitch(this,function(a){this.checkInteractiveOK()}));var a=this.i18n.matchMsg.indexOf("${any_or_all}"),b=a+13,a=this.i18n.matchMsg.substring(0,a)+'\x3cselect id\x3d"allAny"\x3e\x3coption value\x3d"AND" selected\x3e'+
this.i18n.all+'\x3c/option\x3e\x3coption value\x3d"OR"\x3e'+this.i18n.any+"\x3c/option\x3e\x3c/select\x3e "+this.i18n.matchMsg.substring(b);d.byId("matchMsg").innerHTML=a},start:function(a,b,c){this.mapLayer=a;this.layerInfo=b;arcgisonline.map.main.hasDynamicLayers(this.mapLayer)&&d.forEach(this.mapLayer.layersInfo.layers,function(a){a.id==this.layerInfo.source.mapLayerId&&(this.serviceLayerInfo=a)},this);(this.isHosted=arcgisonline.sharing.util.isHostedService(this.mapLayer.url))&&this.mapLayer.layer.getMap()?
(d.style(k.byId("applyFilterAndZoomButton").domNode,"display",""),d.style(k.byId("applyInteractiveFilterAndZoomButton").domNode,"display","")):(d.style(k.byId("applyFilterAndZoomButton").domNode,"display","none"),d.style(k.byId("applyInteractiveFilterAndZoomButton").domNode,"display","none"));this.disableCheckOk=!0;this.readCodedValues();var e=null,f=a=null;(this.mapLayer.layer instanceof esri.layers.FeatureLayer||this._isImageServiceLayer(this.mapLayer.layer))&&this.mapLayer.layerDefinition&&this.mapLayer.layerDefinition.definitionExpression?
(e=this.mapLayer.layerDefinition.definitionExpression,a=this.mapLayer.layer.getDefinitionExpression(),f=this.mapLayer.definitionEditor):(this.mapLayer.layer.layerDefinitions&&(a=this.mapLayer.layer.layerDefinitions[this.layerInfo.id]),this.mapLayer.itemLayers&&d.forEach(this.mapLayer.itemLayers,function(a){a.id==this.layerInfo.id&&(e=a.layerDefinition?a.layerDefinition.definitionExpression:null,a.definitionEditor&&a.id==this.layerInfo.id&&(f=a.definitionEditor))},this));e?this.prepFriendlyView():
this.prepCreateView();this.createOperatorStores();this.createFieldsStore();if(this.fieldsStore){if(e)c=null,e!==a&&(c=this.parseDefinitionExpression(a)),this.partsObj=this.parseDefinitionExpression(e),this.hasErrors(this.partsObj)?(arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:this.i18n.error.cantParseExpression}),this.prepCreateView(),this.addExpression()):(this.parseDefinitionEditor(f),this.buildInteractiveChangeUI(c),
this.buildFriendlyText(),this.buildEditUI(),this.buildInteractiveEditUI());else{var g=this.addExpression({fieldName:c});setTimeout(d.hitch(this,function(){this.defaultToValueOrUnique(null,g)}),1E3)}setTimeout(d.hitch(this,function(){this.disableCheckOk=!1;this.checkOK()}),1E3)}},onClose:function(){d.style(this.dialog.domNode,"display","none");this.dialog&&this.dialog.hide()},destroy:function(){d.disconnect(this.addExprHandler);d.disconnect(this.addSetHandler);d.unsubscribe(this.exprChangeHandler);
d.unsubscribe(this.ineractiveExprChangeHandler);this.inherited(arguments)},onRemoveFilter:function(){if(this.mapLayer.layer instanceof esri.layers.FeatureLayer||this._isImageServiceLayer(this.mapLayer.layer)){if(this.mapLayer.layerDefinition&&this.mapLayer.layerDefinition.definitionExpression){this.mapLayer.layer.setDefinitionExpression("");if(this.mapLayer.itemId&&this.mapLayer.origItemLayers){for(var a=!1,b=0;b<this.mapLayer.origItemLayers.length;b++){var c=this.mapLayer.origItemLayers[b];if(c.id===
this.layerInfo.id&&c.layerDefinition&&esri.isDefined(c.layerDefinition.definitionExpression)){a=!0;this.mapLayer.layerDefinition.definitionExpression="";break}}a||delete this.mapLayer.layerDefinition.definitionExpression}else delete this.mapLayer.layerDefinition.definitionExpression;this.mapLayer.defExpChanged=!0}delete this.mapLayer.definitionEditor}else{if((c=this.mapLayer.layer.layerDefinitions)&&c[this.layerInfo.id])delete c[this.layerInfo.id],this.mapLayer.layer.setLayerDefinitions(c),this.mapLayer.defExpChanged=
!0;if(this.mapLayer.itemLayers)for(c=0;c<this.mapLayer.itemLayers.length;c++)if(a=this.mapLayer.itemLayers[c],a.id==this.layerInfo.id){delete a.definitionEditor;if(this.mapLayer.origItemLayers)for(b=0;b<this.mapLayer.origItemLayers.length;b++)c=this.mapLayer.origItemLayers[b],c.id==this.layerInfo.id&&c.layerDefinition&&(a.layerDefinition.definitionExpression="");else delete a.layerDefinition.definitionExpression,d.json.stringify(a.layerDefinition)==d.json.stringify({})&&delete a.layerDefinition,d.json.stringify(a)==
d.json.stringify({id:this.layerInfo.id})&&this.mapLayer.itemLayers.splice(c,1),this.mapLayer.itemLayers.length||delete this.mapLayer.itemLayers;break}}arcgisonline.map.table.refreshTable(this.mapLayer,this.layerInfo?this.layerInfo.id:null,"filter");this.onClose()},onApplyFilter:function(a){a.preventDefault();arcgisonline.map.main.map.infoWindow.clearFeatures();arcgisonline.map.main.map.infoWindow.hide();this.mapLayer.layer instanceof esri.layers.FeatureLayer&&this.mapLayer.layer.clearSelection();
var b=this.toJson();if(b.expr){if(this.mapLayer.layer instanceof esri.layers.FeatureLayer||this._isImageServiceLayer(this.mapLayer.layer)){if(this.mapLayer.layer instanceof esri.layers.StreamLayer){var c=d.connect(this.mapLayer.layer,"onFilterChange",d.hitch(this,function(a){d.disconnect(c);a.refresh()},this.mapLayer.layer));this.mapLayer.layer.setFilter(d.mixin(this.mapLayer.layer.getFilter(),{where:b.expr}))}else this.mapLayer.layer.setDefinitionExpression(b.expr);this.mapLayer.layerDefinition=
this.mapLayer.layerDefinition||{};this.mapLayer.layerDefinition.definitionExpression=b.expr;var e=this.buildDefinitionEditorJson(b);e?this.mapLayer.definitionEditor=e:delete this.mapLayer.definitionEditor}else if(a=this.mapLayer.layer.layerDefinitions||[],a[this.layerInfo.id]=b.expr,this.mapLayer.layer.setLayerDefinitions(a),d.publish("onFilterChanged",[this.mapLayer,this.layerInfo.id,b.expr]),e=this.buildDefinitionEditorJson(b),this.mapLayer.itemLayers){var f=!1;d.forEach(this.mapLayer.itemLayers,
function(a){a.id==this.layerInfo.id&&(a.layerDefinition=a.layerDefinition||{},a.layerDefinition.definitionExpression=b.expr,e?a.definitionEditor=e:delete a.definitionEditor,f=!0)},this);f||(a={id:this.layerInfo.id,layerDefinition:{definitionExpression:b.expr}},e&&(a.definitionEditor=e),this.mapLayer.itemLayers.push(a))}else a={id:this.layerInfo.id,layerDefinition:{definitionExpression:b.expr}},e&&(a.definitionEditor=e),this.mapLayer.itemLayers=[a];this.mapLayer.defExpChanged=!0;arcgisonline.map.table.refreshTable(this.mapLayer,
this.layerInfo?this.layerInfo.id:null,"filter");this.onClose()}else arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:this.i18n.error.missingValue}),this.disableOK()},onApplyFilterAndZoom:function(a){this.onApplyFilter(a);this.zoom()},onApplyInteractiveFilter:function(){var a;(this.mapLayer.layer instanceof esri.layers.FeatureLayer||this._isImageServiceLayer(this.mapLayer.layer))&&this.mapLayer.layerDefinition&&
this.mapLayer.layerDefinition.definitionExpression?a=this.mapLayer.definitionEditor:this.mapLayer.itemLayers&&d.forEach(this.mapLayer.itemLayers,function(b){b.definitionEditor&&b.id==this.layerInfo.id&&(a=b.definitionEditor)},this);var b=a.parameterizedExpression,c=d.query(".singleInteractiveFilter",this.allInteractiveExpr);d.forEach(c,function(a){a=k.byNode(a);var c=a.getValue();if(esri.isDefined(c.value)){var d=c.value;"date"==c.shortType?d=this.formatDate(c.value):"string"==c.shortType&&(d=d.replace(/\'/g,
"''"));b=b.replace("{"+c.parameterId+"}",d);if("date"==a.part.fieldObj.shortType&&(a.part.operator==this.i18n.dateOperatorIsOn||a.part.operator==this.i18n.dateOperatorIsNotOn))d=this.formatDate(this.addDay(c.value)),b=b.replace("{"+(c.parameterId+1)+"}",d)}else d=c.value1,"date"==c.shortType?d=this.formatDate(c.value1):"string"==c.shortType&&(d=d.replace(/\'/g,"''")),b=b.replace("{"+c.parameterId+"}",d),d=c.value2,"date"==c.shortType?d=this.formatDate(this.addDay(c.value2)):"string"==c.shortType&&
(d=d.replace(/\'/g,"''")),b=b.replace("{"+(c.parameterId+1)+"}",d)},this);console.log("interactive where clause: "+b);this.mapLayer.layer instanceof esri.layers.FeatureLayer||this._isImageServiceLayer(this.mapLayer.layer)?this.mapLayer.layer instanceof esri.layers.StreamLayer?this.mapLayer.layer.setFilter(d.mixin(this.mapLayer.layer.getFilter(),{where:b})):this.mapLayer.layer.setDefinitionExpression(b):(c=this.mapLayer.layer.layerDefinitions||[],c[this.layerInfo.id]=b,this.mapLayer.layer.setLayerDefinitions(c));
arcgisonline.map.table.refreshTable(this.mapLayer,this.layerInfo?this.layerInfo.id:null,"filter");this.onClose()},onApplyInteractiveFilterAndZoom:function(){this.onApplyInteractiveFilter();this.zoom()},onAddExpressionClick:function(){var a=this.addExpression();setTimeout(d.hitch(this,function(){this.defaultToValueOrUnique(null,a)}),1E3)},onAddSetClick:function(){var a=this.addSet();setTimeout(d.hitch(this,function(){d.query(".singleFilter",a.allSetExpr).forEach(function(a){this.defaultToValueOrUnique(null,
k.byNode(a))},this)}),1E3)},zoom:function(){if(arcgisonline.sharing.util.isHostedService(this.mapLayer.url)){var a=function(a){a&&(arcgisonline.map.main.sameSpatialReference(arcgisonline.map.main.map.spatialReference,a.spatialReference)?arcgisonline.map.main.map.setExtent(a,!0):arcgisonline.map.main.projectToMapSpatialReference(a,d.hitch(this,function(b,c){b&&(0<b.length&&b[0]&&"extent"==b[0].type)&&(a=b[0],arcgisonline.map.main.map.setExtent(a,!0))})))},b=new esri.tasks.QueryTask(this.mapLayer.url),
c=new esri.tasks.Query,e=this.mapLayer.layer.getDefinitionExpression();c.where=e?e:"1\x3d1";b.executeForExtent(c,d.hitch(this,function(b,c){b.extent&&b.extent instanceof esri.geometry.Extent?a(b.extent):b.extent&&a(new esri.geometry.Extent(b.extent))}),d.hitch(this,function(a){console.log("could not get extent of hosted feature layer.",a)}))}},disableOK:function(){k.byId("applyFilterButton").set("disabled",!0);k.byId("applyFilterAndZoomButton").set("disabled",!0)},enableOK:function(){k.byId("applyFilterButton").set("disabled",
!1);k.byId("applyFilterAndZoomButton").set("disabled",!1)},checkOK:function(){if(!this.disableCheckOk){var a=this.toJson();a.expr?(console.log("whereClause: ",a.expr),this.enableOK()):this.disableOK()}},checkInteractiveOK:function(){var a=!0,b=d.query(".singleInteractiveFilter",this.allInteractiveExpr);d.forEach(b,function(b){k.byNode(b).getValue().isValid||(k.byId("applyInteractiveFilterButton").set("disabled",!0),k.byId("applyInteractiveFilterAndZoomButton").set("disabled",!0),a=!1)});a&&(k.byId("applyInteractiveFilterButton").set("disabled",
!1),k.byId("applyInteractiveFilterAndZoomButton").set("disabled",!1))},createFieldsStore:function(){this.fieldsInfo={stringFieldsCount:0,numberFieldsCount:0,dateFieldsCount:0};var a=arcgisonline.map.popup.getPopupInfo(this.mapLayer,this.mapLayer.layer instanceof esri.layers.FeatureLayer?null:this.layerInfo.id),b=function(b){if(a)for(var c=0;c<a.fieldInfos.length;c++){var e=a.fieldInfos[c];if(e.fieldName==b)return e.label}return null};lInfo=this.serviceLayerInfo||this.layerInfo;if(!lInfo.fields||!lInfo.fields.length){var c=
arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();c.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:d.string.substitute(this.i18n.error.noFilterFields,{name:this.mapLayer.title})});this.onClose()}else{c=d.clone(lInfo.fields);arcgisonline.map.main.hasDynamicLayers(this.mapLayer)&&(this.mapLayer.thematicGroup&&this.mapLayer.thematicGroup.fieldNames&&this.mapLayer.thematicGroup.fieldNames.length)&&(c=d.filter(c,function(a){return d.some(this.mapLayer.thematicGroup.fieldNames,
function(b){return b===a.name},this)},this));var c=c.sort(function(a,c){a.label=b(a.name)||a.alias||a.name;c.label=b(c.name)||c.alias||c.name;return a.label<c.label?-1:a.label>c.label?1:0}),e=10.2<=this.mapLayer.layer.version&&lInfo.useStandardizedQueries,c=d.filter(c,function(a,b){return"esriFieldTypeOID"===a.type||"esriFieldTypeString"===a.type||"esriFieldTypeDouble"===a.type||"esriFieldTypeSingle"===a.type||"esriFieldTypeInteger"===a.type||"esriFieldTypeSmallInteger"===a.type||"esriFieldTypeDate"===
a.type&&(this.isHosted||e)?!0:!1},this),c=d.map(c,function(a,b){var c;switch(a.type){case "esriFieldTypeString":c="string";this.fieldsInfo.stringFieldsCount++;break;case "esriFieldTypeDate":c="date";this.fieldsInfo.dateFieldsCount++;break;case "esriFieldTypeOID":c="oid";break;default:c="number",this.fieldsInfo.numberFieldsCount++}return{id:b,label:a.label,shortType:c,alias:a.alias,editable:a.editable,name:a.name,nullable:a.nullable,type:a.type}},this);c.length?this.fieldsStore=new d.data.ItemFileWriteStore({data:{identifier:"id",
label:"label",items:c}}):(c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),c.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:d.string.substitute(this.i18n.error.noFilterFields,{name:this.mapLayer.title})}),this.onClose())}},createOperatorStores:function(){var a=[];a.push({name:this.i18n.stringOperatorIs,name_:this.i18n.stringOperatorIs,id:0});a.push({name:this.i18n.stringOperatorIsNot,name_:this.i18n.stringOperatorIsNot,id:1});a.push({name:this.i18n.stringOperatorStartsWith,
name_:this.i18n.stringOperatorStartsWith,id:2});a.push({name:this.i18n.stringOperatorEndsWith,name_:this.i18n.stringOperatorEndsWith,id:3});a.push({name:this.i18n.stringOperatorContains,name_:this.i18n.stringOperatorContains,id:4});a.push({name:this.i18n.stringOperatorDoesNotContain,name_:this.i18n.stringOperatorDoesNotContain,id:5});a.push({name:this.i18n.stringOperatorIsBlank,name_:this.i18n.stringOperatorIsBlank,id:6});a.push({name:this.i18n.stringOperatorIsNotBlank,name_:this.i18n.stringOperatorIsNotBlank,
id:7});this.stringOperatorStore=new d.data.ItemFileWriteStore({data:{label:"name",identifier:"id",items:a}});a=[];a.push({name:this.i18n.dateOperatorIsOn,id:0});a.push({name:this.i18n.dateOperatorIsNotOn,id:1});a.push({name:this.i18n.dateOperatorIsBefore,id:2});a.push({name:this.i18n.dateOperatorIsAfter,id:3});a.push({name:this.i18n.dateOperatorIsBetween,id:6});a.push({name:this.i18n.dateOperatorIsNotBetween,id:7});a.push({name:this.i18n.dateOperatorIsBlank,id:8});a.push({name:this.i18n.dateOperatorIsNotBlank,
id:9});this.dateOperatorStore=new d.data.ItemFileWriteStore({data:{label:"name",identifier:"id",items:a}});a=[];a.push({name:this.i18n.numberOperatorIs,name_:this.i18n.numberOperatorIs,id:0});a.push({name:this.i18n.numberOperatorIsNot,name_:this.i18n.numberOperatorIsNot,id:1});a.push({name:this.i18n.numberOperatorIsAtLeast,name_:this.i18n.numberOperatorIsAtLeast,id:2});a.push({name:this.i18n.numberOperatorIsLessThan,name_:this.i18n.numberOperatorIsLessThan,id:3});a.push({name:this.i18n.numberOperatorIsAtMost,
name_:this.i18n.numberOperatorIsAtMost,id:4});a.push({name:this.i18n.numberOperatorIsGreaterThan,name_:this.i18n.numberOperatorIsGreaterThan,id:5});a.push({name:this.i18n.numberOperatorIsBetween,name_:this.i18n.numberOperatorIsBetween,id:6});a.push({name:this.i18n.numberOperatorIsNotBetween,name_:this.i18n.numberOperatorIsNotBetween,id:7});a.push({name:this.i18n.numberOperatorIsBlank,name_:this.i18n.numberOperatorIsBlank,id:8});a.push({name:this.i18n.numberOperatorIsNotBlank,name_:this.i18n.numberOperatorIsNotBlank,
id:9});this.numberOperatorStore=new d.data.ItemFileWriteStore({data:{label:"name",identifier:"id",items:a}})},getFieldItemByName:function(a,b,c){this.fieldsStore.fetch({query:a,onComplete:d.hitch(this,function(a){a&&a.length?b(a[0]):c()})})},getOperatorItemByName:function(a,b,c,e){a.fetch({query:b,onComplete:d.hitch(this,function(a){a&&a.length?c(a[0]):e()})})},onChangeField:function(a,b,c){b.part&&b.part.valueObj&&delete b.part.valueObj;var e=b.getOperatorList();switch(this.fieldsStore.getValue(a.item,
"type")){case "esriFieldTypeString":var d=null;a=this.fieldsStore.getValue(a.item,"name");this.getCodedValues(a)&&(d=this.i18n.stringOperatorStartsWith,d+="|"+this.i18n.stringOperatorEndsWith,d+="|"+this.i18n.stringOperatorContains,d+="|"+this.i18n.stringOperatorDoesNotContain,d={name_:RegExp("^(?!("+d+")$)")});e.attr("value")===this.i18n.stringOperatorIs?(b.fillOperatorList(this.stringOperatorStore,this.i18n.stringOperatorIs,d),this.onChangeOperator(e,b,c)):b.fillOperatorList(this.stringOperatorStore,
this.i18n.stringOperatorIs,d);b.createValueString(this.getCodedValues(a));break;case "esriFieldTypeDate":b.fillOperatorList(this.dateOperatorStore,this.i18n.dateOperatorIsOn);b.createValueDate();break;case "esriFieldTypeOID":b.fillOperatorList(this.numberOperatorStore,this.i18n.numberOperatorIs,d);b.createValueOID();break;default:d=null,a=this.fieldsStore.getValue(a.item,"name"),this.getCodedValues(a)&&(d=this.i18n.numberOperatorIsBetween,d+="|"+this.i18n.numberOperatorIsNotBetween,d+="|"+this.i18n.numberOperatorIsAtLeast,
d+="|"+this.i18n.numberOperatorIsLessThan,d+="|"+this.i18n.numberOperatorIsAtMost,d+="|"+this.i18n.numberOperatorIsGreaterThan,d={name_:RegExp("^(?!("+d+")$)")}),e.attr("value")===this.i18n.numberOperatorIs?(b.fillOperatorList(this.numberOperatorStore,this.i18n.numberOperatorIs,d),this.onChangeOperator(e,b,c)):b.fillOperatorList(this.numberOperatorStore,this.i18n.numberOperatorIs,d),b.createValueNumber(this.getCodedValues(a))}"date"==this.fieldsStore.getValue(b.getFieldsList().item,"shortType")?b.disableInteractiveCheck():
b.enableInteractiveCheck();this.updateUIOptions(b,b.toJson());this.defaultToValueOrUnique(null,b,c);this.disableOK()},onChangeOperator:function(a,b,c){var e,d;b instanceof arcgisonline.sharing.dijit.SingleInteractiveFilter?(c=b.part.fieldObj.name,a=b.part.fieldObj.shortType,d=b.part.interactiveObj.value):(e=a.item?a.item.name[0]:a.value,a=this.fieldsStore.getValue(b.getFieldsList().item,"shortType"),c=this.fieldsStore.getValue(b.getFieldsList().item,"name"),b.part&&b.part.valueObj&&(d=b.part.valueObj.value));
if(("date"==a||"number"==a||"oid"==a)&&(e==this.i18n.dateOperatorIsBetween||e==this.i18n.numberOperatorIsBetween||e==this.i18n.dateOperatorIsNotBetween||e==this.i18n.numberOperatorIsNotBetween))"date"==a?b.createValueBetweenDate():"oid"==a?b.createValueBetweenOID():b.createValueBetweenNumber();else if("date"==a&&(e==this.i18n.dateOperatorInTheLast||e==this.i18n.dateOperatorNotInTheLast))b.createValueInTheLastDate();else if(e==this.i18n.stringOperatorIsBlank||e==this.i18n.dateOperatorIsBlank||e==this.i18n.numberOperatorIsBlank||
e==this.i18n.stringOperatorIsNotBlank||e==this.i18n.dateOperatorIsNotBlank||e==this.i18n.numberOperatorIsNotBlank)b.createValueIsBlank();else switch(a){case "string":b.createValueString(this.getCodedValues(c),d);break;case "date":b.createValueDate(d);break;case "oid":b.createValueOID(d);break;default:b.createValueNumber(this.getCodedValues(c),d)}b instanceof arcgisonline.sharing.dijit.SingleInteractiveFilter||(this.updateUIOptions(b,b.toJson()),this.checkOK())},updateUIOptions:function(a,b){var c=
b.fieldObj.shortType,e=b.operator;("date"==c||"number"==c||"oid"==c)&&(e==this.i18n.dateOperatorIsBetween||e==this.i18n.numberOperatorIsBetween||e==this.i18n.dateOperatorIsNotBetween||e==this.i18n.numberOperatorIsNotBetween)?(a.disableOptions(),"date"==c?a.disableInteractiveCheck():a.enableInteractiveCheck()):"date"==c&&(e==this.i18n.dateOperatorInTheLast||e==this.i18n.dateOperatorNotInTheLast)?(a.disableOptions(),a.disableInteractiveCheck()):e==this.i18n.stringOperatorIsBlank||e==this.i18n.dateOperatorIsBlank||
e==this.i18n.numberOperatorIsBlank||e==this.i18n.stringOperatorIsNotBlank||e==this.i18n.dateOperatorIsNotBlank||e==this.i18n.numberOperatorIsNotBlank?(a.disableOptions(),a.disableInteractiveCheck()):this._isImageServiceLayer(this.mapLayer.layer)?a.disableUniqueOption():("string"==c&&(e==this.i18n.stringOperatorStartsWith||e==this.i18n.stringOperatorEndsWith||e==this.i18n.stringOperatorContains||e==this.i18n.stringOperatorDoesNotContain)?a.disableOptions():(a.enableOptions(),("string"==c&&2>this.fieldsInfo.stringFieldsCount||
"date"==c&&2>this.fieldsInfo.dateFieldsCount||"number"==c&&2>this.fieldsInfo.numberFieldsCount||"oid"==c)&&a.disableFieldOption()),"date"==c?a.disableInteractiveCheck():a.enableInteractiveCheck(),this.getCodedValues(b.fieldObj.name)&&a.disableFieldOption())},addInteractiveExpression:function(a,b){var c="interactiveExpr_"+this.interactiveExpressionCount,e=new arcgisonline.sharing.dijit.SingleInteractiveFilter({id:c,"class":"interactiveFilterSegment",owner:this,parameterId:a.interactiveObj.parameterId,
part:a},d.create("div",{},d.create("div",{"class":"interactiveExpression",id:"interactiveExpression_"+this.interactiveExpressionCount},this.allInteractiveExpr,"last")));this.interactiveExpressionCount++;e.setPrompt(a.interactiveObj.prompt);e.setHint(a.interactiveObj.hint);b&&(esri.isDefined(b.valueObj.value)&&(a.interactiveObj.value=b.valueObj.value),esri.isDefined(b.valueObj.value1)&&(a.interactiveObj.value1=b.valueObj.value1),esri.isDefined(b.valueObj.value2)&&(a.interactiveObj.value2=b.valueObj.value2));
if("string"==a.fieldObj.shortType)e.createValueString(this.getCodedValues(a.fieldObj.name),b?b.valueObj.value:a.valueObj.value);else if("number"==a.fieldObj.shortType)switch(a.operator){case this.i18n.numberOperatorIs:case this.i18n.numberOperatorIsNot:case this.i18n.numberOperatorIsAtLeast:case this.i18n.numberOperatorIsLessThan:case this.i18n.numberOperatorIsAtMost:case this.i18n.numberOperatorIsGreaterThan:e.createValueNumber(this.getCodedValues(a.fieldObj.name),b?b.valueObj.value:a.valueObj.value);
break;case this.i18n.numberOperatorIsBetween:case this.i18n.numberOperatorIsNotBetween:e.createValueBetweenNumber(b?b.valueObj.value1:a.valueObj.value1,b?b.valueObj.value2:a.valueObj.value2)}else if("oid"==a.fieldObj.shortType)switch(a.operator){case this.i18n.numberOperatorIs:case this.i18n.numberOperatorIsNot:case this.i18n.numberOperatorIsAtLeast:case this.i18n.numberOperatorIsLessThan:case this.i18n.numberOperatorIsAtMost:case this.i18n.numberOperatorIsGreaterThan:e.createValueOID(b?b.valueObj.value:
a.valueObj.value);break;case this.i18n.numberOperatorIsBetween:case this.i18n.numberOperatorIsNotBetween:e.createValueBetweenOID(b?b.valueObj.value1:a.valueObj.value1,b?b.valueObj.value2:a.valueObj.value2)}else switch(a.operator){case this.i18n.dateOperatorIsOn:case this.i18n.dateOperatorIsNotOn:e.createValueDate(b?b.valueObj.value:a.valueObj.value);break;case this.i18n.dateOperatorIsBetween:case this.i18n.dateOperatorIsNotBetween:e.createValueBetweenDate(b?b.valueObj.value1:a.valueObj.value1,b?b.valueObj.value2:
a.valueObj.value2);break;case this.i18n.dateOperatorIsBefore:case this.i18n.dateOperatorIsAfter:e.createValueDate(b?b.valueObj.value:a.valueObj.value)}if(this.uniqueValuesResults[this.mapLayer.id+"_"+this.layerInfo.id+"_"+a.fieldObj.name])if(a.valueObj){var f=-1;"date"===a.fieldObj.shortType?d.forEach(this.uniqueValuesResults[this.mapLayer.id+"_"+this.layerInfo.id+"_"+a.fieldObj.name],function(b,c){(new Date(a.valueObj.value)).toString()===(new Date(b+" UTC")).toString()&&(f=c)}):f=d.indexOf(this.uniqueValuesResults[this.mapLayer.id+
"_"+this.layerInfo.id+"_"+a.fieldObj.name],a.valueObj.value);if(-1<f){k.byId(c+".radioUnique").set("checked",!0);var g=k.byId(c+".valueUnique");g?this.showUniqueList(null,e,set,a.fieldObj):(this.onGenerateRendererResults(e,null,this.uniqueValuesResults[this.mapLayer.id+"_"+this.layerInfo.id+"_"+a.fieldObj.name]),g=k.byId(c+".valueUnique"));"date"===a.fieldObj.shortType?d.forEach(g.store._arrayOfAllItems,function(b){this.formatFriendlyDate(b.value[0])===this.formatFriendlyDate(a.interactiveObj.value)&&
g.set("value",b.id[0])},this):g.store.fetch({query:{value:a.interactiveObj.value},onComplete:d.hitch(this,function(a){a&&a.length&&g.set("value",a[0].id[0])})})}}else k.byId(c+".radioUnique").set("checked",!0),this.showUniqueList(null,expr,set,a.fieldObj);return e},addExpression:function(a){var b=new arcgisonline.sharing.dijit.SingleFilter({id:"expr_"+this.expressionCount,"class":"filterSegment",owner:this,version:this.mapLayer.layer instanceof esri.layers.StreamLayer?10:this.mapLayer.layer.version,
part:a&&a.part,enableEvents:a&&!1===a.enableEvents?!1:!0},d.create("div",{},d.create("div",{"class":"expression",id:"expression_"+this.expressionCount},this.allExps,"last")));this.expressionCount++;b.fillFieldsList(this.fieldsStore);a&&a.fieldName&&this.getFieldItemByName({name:a.fieldName},d.hitch(this,function(a){b.getFieldsList().set("value",a.id[0])}));b.showDeleteIcon();this.checkDeletetIcons();this.disableOK();return b},deleteExpression:function(a){var b=a.domNode.parentNode;a.destroy();d.destroy(b);
this.checkDeletetIcons();this.checkOK()},addSet:function(a){a=new arcgisonline.sharing.dijit.FilterSet({id:"set_"+this.expressionCount,"class":" filterSegment",owner:this,version:this.mapLayer.layer.version,addEmptySet:a&&a.addEmptySet?!0:!1,enableEvents:a&&!1===a.enableEvents?!1:!0},d.create("div",{},this.allExps,"last"));this.expressionCount++;this.checkDeletetIcons();this.disableOK();return a},deleteSet:function(a){a.destroy();this.checkDeletetIcons();this.checkOK()},checkDeletetIcons:function(){var a=
d.query(".filterSegment",this.allExps);1<a.length?(d.style(d.byId("match1Msg"),"display","none"),d.style(d.byId("matchMsg"),"display","block"),k.byNode(a[0]).showDeleteIcon()):(d.style(d.byId("match1Msg"),"display","block"),d.style(d.byId("matchMsg"),"display","none"),k.byNode(a[0]).hideDeleteIcon())},defaultToValueOrUnique:function(a,b,c){if(!1===k.byId(b.id+".radioUnique").get("disabled")&&b.getFieldsList()&&b.getFieldsList().item){var e=this.fieldsStore.getValue(b.getFieldsList().item,"name"),
f=this.uniqueValuesResults[this.mapLayer.id+"_"+this.layerInfo.id+"_"+e];if(f&&f.length)if(b.part&&b.part.valueObj){var g=-1;"date"===b.part.fieldObj.shortType?d.forEach(this.uniqueValuesResults[this.mapLayer.id+"_"+this.layerInfo.id+"_"+e],function(a,c){(new Date(b.part.valueObj.value)).toString()===(new Date(a+" UTC")).toString()&&(g=c)}):g=d.indexOf(this.uniqueValuesResults[this.mapLayer.id+"_"+this.layerInfo.id+"_"+e],b.part.valueObj.value);if(-1<g){k.byId(b.id+".radioUnique").set("checked",!0);
var h=k.byId(b.id+".valueUnique");h?this.showUniqueList(a,b,c):(this.onGenerateRendererResults(b,a,this.uniqueValuesResults[this.mapLayer.id+"_"+this.layerInfo.id+"_"+e]),h=k.byId(b.id+".valueUnique"));"date"===b.part.fieldObj.shortType?d.forEach(h.store._arrayOfAllItems,function(a){this.formatFriendlyDate(a.value[0])===this.formatFriendlyDate(b.part.valueObj.value)&&h.set("value",a.id[0])},this):h.store.fetch({query:{value:b.part.valueObj.value},onComplete:d.hitch(this,function(a){a&&a.length&&h.set("value",
a[0].id[0])})})}}else k.byId(b.id+".radioUnique").set("checked",!0),this.showUniqueList(a,b,c)}},showValueInput:function(a,b,c){b.onChangeOperator(a,b,c);b.enableInteractiveCheck();this.checkOK()},showFields:function(a,b,c){c=b.getFieldsList().item;a=this.fieldsStore.getValue(c,"shortType");c=this.fieldsStore.getValue(c,"name");b.createValueFields(this.fieldsStore,{shortType:a,name:RegExp("^(?!"+c+"$)")},c);b.disableInteractiveCheck();this.checkOK()},showUniqueList:function(a,b,c){this.uniqueValuesStore&&
delete this.uniqueValuesStore;var e;b instanceof arcgisonline.sharing.dijit.SingleInteractiveFilter?(c=b.part.fieldObj.name,e=b.part.fieldObj.shortType):(e=b.getFieldsList().item,c=this.fieldsStore.getValue(e,"name"),e=this.fieldsStore.getValue(e,"shortType"));if(10.1<=this.mapLayer.layer.version){var f=null;this.mapLayer.queryServiceUrl?f=this.mapLayer.queryServiceUrl:this.mapLayer.itemLayers&&d.forEach(this.mapLayer.itemLayers,function(a){a.id===this.layerInfo.id&&a.layerUrl&&(f=a.layerUrl)},this);
f||(f=this.mapLayer.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer?this.mapLayer.layer.url+"/"+this.layerInfo.id:this.mapLayer.layer.url);if(this.uniqueValuesResults[this.mapLayer.id+"_"+this.layerInfo.id+"_"+c])this.onGenerateRendererResults(b,a,this.uniqueValuesResults[this.mapLayer.id+"_"+this.layerInfo.id+"_"+c]);else this.generateRendererUniqueValues(c,e,f,d.hitch(this,"onGenerateRendererResults",b,a),d.hitch(this,function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:this.i18n.error.generateRendererFailed});this.showValueInput(a,b)}));b.enableInteractiveCheck();this.checkOK()}else arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:this.i18n.error.generateRendererFailed}),this.showValueInput(a,b)},onGenerateRendererResults:function(a,b,c){var e,f,g;if(a instanceof arcgisonline.sharing.dijit.SingleInteractiveFilter)e=a.part.fieldObj.name,f=a.part.fieldObj.shortType,d.forEach(this.fieldsStore._arrayOfAllItems,
function(a){a.name.toString()===e&&(g=a.type.toString())});else{var h=a.getFieldsList().item;e=this.fieldsStore.getValue(h,"name");f=this.fieldsStore.getValue(h,"shortType");g=this.fieldsStore.getValue(h,"type")}var p=null,h=this.serviceLayerInfo||this.layerInfo;d.forEach(h.fields,function(a){a.name===e&&a.domain&&(p=a.domain)});var r=h.types,k=h.typeIdField;c=d.filter(c,function(a,b){return a?"string"===f?"\x3cNull\x3e"!==a&&""!==a.trim():"\x3cNull\x3e"!==a&&""!==a:!1});this.uniqueValuesResults[this.mapLayer.id+
"_"+this.layerInfo.id+"_"+e]=c;if(c.length){"date"===f?(c=d.map(c,function(a){return new Date(a+" UTC")}),c=c.sort(function(a,b){var c=a.getTime(),e=b.getTime();return c<e?-1:c>e?1:0})):"number"===f||"oid"===f?(c=d.map(c,function(a){return"esriFieldTypeDouble"==g||"esriFieldTypeSingle"==g?parseFloat(a):parseInt(a)}),c=c.sort(function(a,b){return a<b?-1:a>b?1:0})):c=c.sort(function(a,b){return a<b?-1:a>b?1:0});var n=function(a,b,c,e){for(var d=!1,f=0;f<c.codedValues.length;f++){var g=c.codedValues[f];
a==g.code&&(d=!0,e.push({id:e.length,name:g.name||b,value:a}))}d||e.push({id:e.length,name:""+b,value:a})},l=[];d.forEach(c,function(a){var b=""+a;"string"===f?b=""===a?"\x3c"+this.i18n.emptyString+"\x3e":a:"date"===f&&(b=this.formatFriendlyDate(a));if(k&&r){var c=!1;if(k===e)for(var h=0;h<r.length;h++){var m=r[h];m.id===a&&(l.push({id:l.length,name:m.name||b,value:a}),c=!0)}else for(h=0;h<r.length;h++)if(m=r[h],m.domains&&m.domains[e]&&"inherited"===m.domains[e].type){if(p&&p.codedValues)for(m=0;m<
p.codedValues.length;m++){var q=p.codedValues[m];if(a==q.code){var c=!0,s=!1;d.forEach(l,function(b){b.value===a&&(s=!0,-1===(", "+b.name+",").indexOf(", "+q.name+",")&&(b.name+=", "+q.name))});s||l.push({id:l.length,name:q.name||b,value:a})}}}else if(m.domains&&m.domains[e]&&m.domains[e].codedValues)for(var u=m.domains[e].codedValues,m=0;m<u.length;m++)q=u[m],a==q.code&&(c=!0,s=!1,d.forEach(l,function(b){b.value===a&&(s=!0,-1===(", "+b.name+",").indexOf(", "+q.name+",")&&(b.name+=", "+q.name))}),
s||l.push({id:l.length,name:q.name||b,value:a}));else c=!0,s=!1,d.forEach(l,function(b){b.value===a&&(s=!0)}),s||l.push({id:l.length,name:b,value:a});!c&&p&&p.codedValues?n(a,b,p,l):c||l.push({id:l.length,name:b,value:a})}else if(p&&p.codedValues)n(a,b,p,l);else{if("esriFieldTypeDouble"==g||"esriFieldTypeSingle"==g)b=d.number.format(a,{pattern:"#####0.##########"});l.push({id:l.length,name:""+b,value:a})}},this);this.uniqueValuesStore=new d.data.ItemFileWriteStore({data:{label:"name",identifier:"id",
items:l}});a.createValueUnique(this.uniqueValuesStore)}else arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:this.i18n.error.noUniqueValues}),this.showValueInput(b,a)},generateRendererUniqueValues:function(a,b,c,e,f){a instanceof Array&&(a=a.toString());if("date"!==b){var g=this.mapLayer.layer;if(g instanceof esri.layers.FeatureLayer)g.getDefinitionExpression()&&(g=new esri.layers.FeatureLayer(g.url,{outFields:["*"],
mode:esri.layers.FeatureLayer.MODE_SELECTION,resourceInfo:this.mapLayer.serviceInfo}));else{var h,p;arcgisonline.map.main.hasDynamicLayers(this.mapLayer)?(c=this.mapLayer.url+"/dynamicLayer",d.forEach(this.mapLayer.layersInfo.layers,function(a){a.id===this.layerInfo.source.mapLayerId&&(p=a)}),h=this.layerInfo.source):d.forEach(this.mapLayer.layersInfo.layers,function(a){a.id===this.layerInfo.id&&(p=a)});g=new esri.layers.FeatureLayer(c,{outFields:["*"],mode:esri.layers.FeatureLayer.MODE_SELECTION,
resourceInfo:p,source:h})}g.addPlugin("esri/plugins/FeatureLayerStatistics").then(function(){g.statisticsPlugin.getUniqueValues({includeAllCodedValues:!1,field:a}).then(function(a){a=d.map(a.uniqueValueInfos,function(a){return a.value});e(a)},function(a){f()})},function(a){f()})}else h=new esri.tasks.UniqueValueDefinition,h.attributeField=a,b=new esri.tasks.GenerateRendererParameters,b.classificationDefinition=h,c=arcgisonline.map.main.hasDynamicLayers(this.mapLayer)?new esri.tasks.GenerateRendererTask(this.mapLayer.url+
"/dynamicLayer",{source:this.layerInfo.source}):new esri.tasks.GenerateRendererTask(c),esri.config.defaults.io.timeout=1E4,c.execute(b,function(a){esri.config.defaults.io.timeout=6E4;a=d.map(a.infos,function(a){return a.value});e(a)},d.hitch(this,function(a){esri.config.defaults.io.timeout=6E4;f()}))},getFieldType:function(a){a=d.query(".attributeField",a.domNode.parentElement.parentElement.parentElement)[0];return a.options(a.selectedIndex).value},toggleNewLayerNameTextBox:function(){d.byId("new").checked?
d.byId("newLayerName").style.display="inline":d.byId("newLayerName").style.display="none"},toJson:function(){var a={logicalOperator:d.byId("allAny").value,parts:[]};d.query(".filterSegment",this.allExps).forEach(function(b){a.parts.push(k.byNode(b).toJson())});a.expr=this.builtCompleteFilter(a);return a},buildDefinitionEditorJson:function(a){var b=null,c="",e="",f=0;if(1==a.parts.length){var g=this.buildInputParams(a.parts[0],f);g&&(b={inputs:[]},b.inputs.push(g),g=this.builtSingleFilterString(a.parts[0],
f),c+=e+g.whereClause)}else d.forEach(a.parts,function(d){if(d.parts){for(var g="",k="",t=0;t<d.parts.length;t++){var n=d.parts[t],l=this.buildInputParams(n,f);l?(b=b||{inputs:[]},b.inputs.push(l),n=this.builtSingleFilterString(n,f),k+=g+n.whereClause,f+=l.parameters.length):(n=this.builtSingleFilterString(n),k+=g+n.whereClause);g=" "+d.logicalOperator+" "}c+=e+"("+k+")"}else(l=this.buildInputParams(d,f))?(b=b||{inputs:[]},b.inputs.push(l),n=this.builtSingleFilterString(d,f),c+=e+"("+n.whereClause+
")",f+=l.parameters.length):(n=this.builtSingleFilterString(d),c+=e+"("+n.whereClause+")");e=" "+a.logicalOperator+" "},this);b&&(b.parameterizedExpression=c,console.log(d.json.stringify(b)));return b},buildInputParams:function(a,b){if(a.interactiveObj&&a.interactiveObj.prompt&&a.interactiveObj.hint&&(esri.isDefined(a.valueObj.value)||esri.isDefined(a.valueObj.value1)&&esri.isDefined(a.valueObj.value2))){var c={hint:a.interactiveObj.hint,prompt:a.interactiveObj.prompt,parameters:[]};if(esri.isDefined(a.valueObj.value)){var e=
{type:a.fieldObj.type,fieldName:a.fieldObj.name,parameterId:b,defaultValue:a.valueObj.value};"date"===a.fieldObj.shortType&&("string"==typeof a.valueObj.value&&(a.valueObj.value=new Date(a.valueObj.value)),e.defaultValue=this.formatDate(a.valueObj.value),e.utcValue=a.valueObj.value.getTime());c.parameters.push(e)}else if(esri.isDefined(a.valueObj.value1)&&esri.isDefined(a.valueObj.value2)){var e={type:a.fieldObj.type,fieldName:a.fieldObj.name,parameterId:b,defaultValue:a.valueObj.value1},d={type:a.fieldObj.type,
fieldName:a.fieldObj.name,parameterId:b+1,defaultValue:a.valueObj.value2};"date"===a.fieldObj.shortType&&("string"==typeof a.valueObj.value1&&(a.valueObj.value1=new Date(a.valueObj.value1),a.valueObj.value2=new Date(a.valueObj.value2)),e.defaultValue=this.formatDate(a.valueObj.value1),d.defaultValue=this.formatDate(a.valueObj.value2),e.utcValue=a.valueObj.value1.getTime(),d.utcValue=a.valueObj.value2.getTime());c.parameters.push(e);c.parameters.push(d)}return c}return null},parseDefinitionEditor:function(a){if(a){var b=
this.parseDefinitionExpression(a.parameterizedExpression);a.inputs&&a.inputs.length&&d.forEach(b.parts,function(b,e){if(b.parts)d.forEach(b.parts,function(b,c){if(b.isInteractive){var d=0,d=esri.isDefined(b.valueObj.value)?parseInt(b.valueObj.value.substring(1,b.valueObj.value.length-1)):parseInt(b.valueObj.value1.substring(1,b.valueObj.value1.length-1)),f=this.partsObj.parts[e].parts[c];f.interactiveObj=this.getInteractiveObj(a.inputs[d],f.fieldObj.shortType)}},this);else if(b.isInteractive){var f=
0,f=esri.isDefined(b.valueObj.value)?parseInt(b.valueObj.value.substring(1,b.valueObj.value.length-1)):parseInt(b.valueObj.value1.substring(1,b.valueObj.value1.length-1)),g;d.forEach(a.inputs,function(a){d.forEach(a.parameters,function(b){b.parameterId===f&&(g=a)})});var h=this.partsObj.parts[e];h.interactiveObj=this.getInteractiveObj(g,h.fieldObj.shortType)}},this);console.log("definitionEditor "+d.json.stringify(this.partsObj))}},getInteractiveObj:function(a,b){var c={prompt:a.prompt,hint:a.hint,
parameterId:a.parameters[0].parameterId};1==a.parameters.length?c.value="date"==b?this.parseDate(a.parameters[0].defaultValue):a.parameters[0].defaultValue:(c.value1="date"==b?this.parseDate(a.parameters[0].defaultValue):a.parameters[0].defaultValue,c.value2="date"==b?this.parseDate(a.parameters[1].defaultValue):a.parameters[1].defaultValue);return c},builtCompleteFilter:function(a){if(a.expr)return a.expr;var b="";if(1===a.parts.length)b=this.builtFilterString(a.parts[0]);else for(var c="",e=0;e<
a.parts.length;e++){var d=this.builtFilterString(a.parts[e]);if(!esri.isDefined(d))return null;b+=c+"("+d+")";c=c||" "+a.logicalOperator+" "}return a.expr=b},builtFilterString:function(a){var b="";if(a.parts)for(var c="",e=0;e<a.parts.length;e++){var d=a.parts[e],g=this.builtSingleFilterString(d);d.expr=g.whereClause;if(!esri.isDefined(g.whereClause))return null;b+=c+g.whereClause;c=" "+a.logicalOperator+" "}else b=this.builtSingleFilterString(a).whereClause;return a.expr=b},builtSingleFilterString:function(a,
b){if(esri.isDefined(a.valueObj.isValid)&&!a.valueObj.isValid)return{whereClause:null};var c=a.valueObj.value,e=a.valueObj.value1,d=a.valueObj.value2,g=!1;if(a.interactiveObj){if(!a.interactiveObj.prompt||!a.interactiveObj.hint)return{whereClause:null};esri.isDefined(b)&&(g=!0,esri.isDefined(a.valueObj.value)&&(c="{"+b+"}"),esri.isDefined(a.valueObj.value1)&&(e="{"+b+"}"),esri.isDefined(a.valueObj.value2)&&(d="{"+(b+1)+"}"))}var h="";if("string"==a.fieldObj.shortType)switch(e="",g&&this.isHosted?
e="N":c&&"field"!==a.valueObj.type&&this.isHosted&&this.containsNonLatinCharacter(c)&&(e="N"),a.operator){case this.i18n.stringOperatorIs:h="field"===a.valueObj.type?a.fieldObj.name+" \x3d "+c:a.fieldObj.name+" \x3d "+e+"'"+c.replace(/\'/g,"''")+"'";break;case this.i18n.stringOperatorIsNot:h="field"===a.valueObj.type?a.fieldObj.name+" \x3c\x3e "+c:a.fieldObj.name+" \x3c\x3e "+e+"'"+c.replace(/\'/g,"''")+"'";break;case this.i18n.stringOperatorStartsWith:h=a.fieldObj.name+" LIKE "+e+"'"+c.replace(/\'/g,
"''")+"%'";break;case this.i18n.stringOperatorEndsWith:h=a.fieldObj.name+" LIKE "+e+"'%"+c.replace(/\'/g,"''")+"'";break;case this.i18n.stringOperatorContains:h=a.fieldObj.name+" LIKE "+e+"'%"+c.replace(/\'/g,"''")+"%'";break;case this.i18n.stringOperatorDoesNotContain:h=a.fieldObj.name+" NOT LIKE "+e+"'%"+c.replace(/\'/g,"''")+"%'";break;case this.i18n.stringOperatorIsBlank:h=a.fieldObj.name+" IS NULL";break;case this.i18n.stringOperatorIsNotBlank:h=a.fieldObj.name+" IS NOT NULL"}else if("number"==
a.fieldObj.shortType||"oid"==a.fieldObj.shortType)switch(a.operator){case this.i18n.numberOperatorIs:h=a.fieldObj.name+" \x3d "+c;break;case this.i18n.numberOperatorIsNot:h=a.fieldObj.name+" \x3c\x3e "+c;break;case this.i18n.numberOperatorIsAtLeast:h=a.fieldObj.name+" \x3e\x3d "+c;break;case this.i18n.numberOperatorIsLessThan:h=a.fieldObj.name+" \x3c "+c;break;case this.i18n.numberOperatorIsAtMost:h=a.fieldObj.name+" \x3c\x3d "+c;break;case this.i18n.numberOperatorIsGreaterThan:h=a.fieldObj.name+
" \x3e "+c;break;case this.i18n.numberOperatorIsBetween:h=a.fieldObj.name+" BETWEEN "+e+" AND "+d;break;case this.i18n.numberOperatorIsNotBetween:h=a.fieldObj.name+" NOT BETWEEN "+e+" AND "+d;break;case this.i18n.numberOperatorIsBlank:h=a.fieldObj.name+" IS NULL";break;case this.i18n.numberOperatorIsNotBlank:h=a.fieldObj.name+" IS NOT NULL"}else switch(esri.isDefined(c)&&("field"!==a.valueObj.type&&"string"==typeof c)&&(c=this.parseFriendlyDate(c)),a.operator){case this.i18n.dateOperatorIsOn:h="field"===
a.valueObj.type?a.fieldObj.name+" \x3d "+c:g?a.fieldObj.name+" BETWEEN "+(this.isHosted?"":"timestamp ")+"'{"+b+"}' AND "+(this.isHosted?"":"timestamp ")+"'{"+(b+1)+"}'":a.fieldObj.name+" BETWEEN "+(this.isHosted?"":"timestamp ")+"'"+this.formatDate(c)+"' AND "+(this.isHosted?"":"timestamp ")+"'"+this.formatDate(this.addDay(c))+"'";break;case this.i18n.dateOperatorIsNotOn:h="field"===a.valueObj.type?a.fieldObj.name+" \x3c\x3e "+c:g?a.fieldObj.name+" NOT BETWEEN "+(this.isHosted?"":"timestamp ")+"'{"+
b+"}' AND "+(this.isHosted?"":"timestamp ")+"'{"+(b+1)+"}'":a.fieldObj.name+" NOT BETWEEN "+(this.isHosted?"":"timestamp ")+"'"+this.formatDate(c)+"' AND "+(this.isHosted?"":"timestamp ")+"'"+this.formatDate(this.addDay(c))+"'";break;case this.i18n.dateOperatorIsBefore:h="field"===a.valueObj.type?a.fieldObj.name+" \x3c "+c:a.fieldObj.name+" \x3c "+(this.isHosted?"":"timestamp ")+"'"+this.formatDate(c)+"'";break;case this.i18n.dateOperatorIsAfter:h="field"===a.valueObj.type?a.fieldObj.name+" \x3e "+
c:a.fieldObj.name+" \x3e "+(this.isHosted?"":"timestamp ")+"'"+this.formatDate(this.addDay(c))+"'";break;case this.i18n.dateOperatorIsBetween:h=g?a.fieldObj.name+" BETWEEN '"+e+"' AND '"+d+"'":a.fieldObj.name+" BETWEEN "+(this.isHosted?"":"timestamp ")+"'"+this.formatDate(e)+"' AND "+(this.isHosted?"":"timestamp ")+"'"+this.formatDate(this.addDay(d))+"'";break;case this.i18n.dateOperatorIsNotBetween:h=g?a.fieldObj.name+" NOT BETWEEN '"+e+"' AND '"+d+"'":a.fieldObj.name+" NOT BETWEEN "+(this.isHosted?
"":"timestamp ")+"'"+this.formatDate(e)+"' AND "+(this.isHosted?"":"timestamp ")+"'"+this.formatDate(this.addDay(d))+"'";break;case this.i18n.dateOperatorIsBlank:h=a.fieldObj.name+" IS NULL";break;case this.i18n.dateOperatorIsNotBlank:h=a.fieldObj.name+" IS NOT NULL"}return{whereClause:h}},formatDate:function(a){a=new Date(a);return""+a.getUTCFullYear()+"-"+d.number.format(a.getUTCMonth()+1,{pattern:"00"})+"-"+d.number.format(a.getUTCDate(),{pattern:"00"})+" "+d.number.format(a.getUTCHours(),{pattern:"00"})+
":"+d.number.format(a.getUTCMinutes(),{pattern:"00"})+":"+d.number.format(a.getSeconds(),{pattern:"00"})},formatFriendlyDate:function(a){return d.date.locale.format(a,{formatLength:"short",selector:"date"})},parseFriendlyDate:function(a){return d.date.locale.parse(a,{formatLength:"short",selector:"date"})},parseDate:function(a){var b=new Date;b.setUTCFullYear(a.substring(0,4));b.setUTCMonth(parseInt(a.substring(5,7))-1);b.setUTCDate(a.substring(8,10));b.setUTCHours(a.substring(11,13));b.setUTCMinutes(a.substring(14,
16));b.setSeconds(a.substring(17,19));return b},addDay:function(a){return new Date(a.getTime()+this.dayInMS)},subtractDay:function(a){return new Date(a.getTime()-this.dayInMS)},parseDefinitionExpression:function(a){if(a){var b=this.replaceStrings(a);a=b.defExpr;var c=this.findParts(a,"AND");1==c.parts.length&&(c=this.findParts(a,"OR"),1==c.parts.length&&(c.logicalOperator="AND"));d.forEach(c.parts,function(a){a.expr=a.expr.trim();if(a.expr.startsWith("(")&&-1<a.expr.search(/\)$/)){var b=a.expr.substring(1,
a.expr.length-1),c=b.indexOf("("),d=b.indexOf(")");if(-1==c&&-1==d||c<d)a.expr=b}b=this.findParts(a.expr,"AND");1==b.parts.length&&(b=this.findParts(a.expr,"OR"));1<b.parts.length&&(a.parts=b.parts,a.logicalOperator=b.logicalOperator)},this);this.parseExpr(c);this.reReplaceStrings(b,c);console.log(d.json.stringify(c));return c}},findParts:function(a,b){for(var c=a.toLowerCase(),e=" "+b.toLowerCase()+" ",d=[],g=0,h=c.indexOf(e);0<h;){var k=a.substring(g,h),r=k.toLowerCase(),t=k.count("("),n=k.count(")"),
l=k.count("'");t!=n||1===l%2?h=c.indexOf(e,h+1):-1<r.indexOf(" between ")&&-1==r.indexOf(" and ")?h=c.indexOf(e,h+1):(d.push({expr:k}),g=h+e.length,h=c.indexOf(e,g))}d.push({expr:a.substring(g)});for(c=d.length-1;0<=c;c--)k=d[c].expr,!this.hasOperator(k)&&0<c&&(d[c-1].expr+=" "+b+" "+d[c].expr,d.splice(c,1));return{expr:a,parts:d,logicalOperator:b}},parseExpr:function(a){d.forEach(a.parts,function(a){a.parts?this.parseExpr(a):this.parseSingleExpr(a)},this)},parseSingleExpr:function(a){var b=a.expr.trim(),
c=b.indexOf(" "),d=b.substring(0,c);a.fieldObj={name:d};a.valueObj={};this.getFieldItemByName({name:d},function(b){a.fieldObj.shortType=b.shortType[0];a.fieldObj.label=b.label[0]},function(){a.error={msg:"unknown field name ("+d+")",code:1}});b=b.substring(c+1).trim();c=b.toLowerCase();c.startsWith("\x3d ")?(b="date"==a.fieldObj.shortType&&-1<b.indexOf(" timestamp ")&&!this.isHosted?b.substring(12).trim():b.substring(2).trim(),this.storeValue(b,a),a.operator="date"==a.fieldObj.shortType?this.i18n.dateOperatorIsOn:
"string"==a.fieldObj.shortType?this.i18n.stringOperatorIs:this.i18n.numberOperatorIs):c.startsWith("\x3c ")?(b="date"==a.fieldObj.shortType&&-1<b.indexOf(" timestamp ")&&!this.isHosted?b.substring(12).trim():b.substring(2).trim(),this.storeValue(b,a),"date"==a.fieldObj.shortType?a.operator=this.i18n.dateOperatorIsBefore:"number"==a.fieldObj.shortType||"oid"==a.fieldObj.shortType?a.operator=this.i18n.numberOperatorIsLessThan:a.error={msg:"operator ("+c+") not supported for string",code:3}):c.startsWith("\x3e ")?
(b="date"==a.fieldObj.shortType&&-1<b.indexOf(" timestamp ")&&!this.isHosted?b.substring(12).trim():b.substring(2).trim(),this.storeValue(b,a),"date"==a.fieldObj.shortType?a.operator=this.i18n.dateOperatorIsAfter:"number"==a.fieldObj.shortType||"oid"==a.fieldObj.shortType?a.operator=this.i18n.numberOperatorIsGreaterThan:a.error={msg:"operator ("+c+") not supported for string",code:3}):c.startsWith("\x3c\x3e ")?(b="date"==a.fieldObj.shortType&&-1<b.indexOf(" timestamp ")&&!this.isHosted?b.substring(13).trim():
b.substring(3).trim(),this.storeValue(b,a),a.operator="date"==a.fieldObj.shortType?this.i18n.dateOperatorIsNotOn:"string"==a.fieldObj.shortType?this.i18n.stringOperatorIsNot:this.i18n.numberOperatorIsNot):c.startsWith("\x3c\x3d ")?(this.storeValue(b.substring(3).trim(),a),a.operator=this.i18n.numberOperatorIsAtMost):c.startsWith("\x3e\x3d ")?(this.storeValue(b.substring(3).trim(),a),a.operator=this.i18n.numberOperatorIsAtLeast):c.startsWith("like ")?(b=b.substring(5).trim(),b.startsWith("N'")&&(b=
b.substring(1,b.length)),b.startsWith("'%")&&b.endsWith("%'")?(this.storeValue(b.substring(2,b.length-2),a),a.operator=this.i18n.stringOperatorContains):b.startsWith("'%")&&b.endsWith("'")?(this.storeValue(b.substring(2,b.length-1),a),a.operator=this.i18n.stringOperatorEndsWith):b.startsWith("'")&&b.endsWith("%'")?(this.storeValue(b.substring(1,b.length-2),a),a.operator=this.i18n.stringOperatorStartsWith):a.error={msg:"value ("+c+") not supported for LIKE",code:3}):c.startsWith("not like ")?(b=b.substring(9).trim(),
b.startsWith("N'")&&(b=b.substring(1,b.length)),b.startsWith("'%")&&b.endsWith("%'")?(this.storeValue(b.substring(2,b.length-2),a),a.operator=this.i18n.stringOperatorDoesNotContain):a.error={msg:"value ("+c+") not supported for NOT LIKE",code:3}):c.startsWith("between ")?(b="date"==a.fieldObj.shortType&&-1<b.indexOf(" timestamp ")&&!this.isHosted?b.substring(18).trim():b.substring(8).trim(),c=b.toLowerCase().indexOf(" and "),-1<c?(this.storeValue1(b.substring(0,c).trim(),a),"date"==a.fieldObj.shortType&&
!this.isHosted?this.storeValue2(b.substring(c+15).trim(),a):this.storeValue2(b.substring(c+5).trim(),a)):a.error={msg:"missing AND operator for BETWEEN",code:3},"date"==a.fieldObj.shortType?"string"==typeof a.valueObj.value1?a.operator=this.i18n.dateOperatorIsBetween:1E3>Math.abs(this.subtractDay(a.valueObj.value2).getTime()-a.valueObj.value1.getTime())?(a.valueObj.value=a.valueObj.value1,delete a.valueObj.value1,delete a.valueObj.value2,a.operator=this.i18n.dateOperatorIsOn):a.operator=this.i18n.dateOperatorIsBetween:
"number"==a.fieldObj.shortType||"oid"==a.fieldObj.shortType?a.operator=this.i18n.numberOperatorIsBetween:a.error={msg:"string field not supported for BETWEEN",code:3}):c.startsWith("not between ")?(b="date"==a.fieldObj.shortType&&-1<b.indexOf(" timestamp ")&&!this.isHosted?b.substring(22).trim():b.substring(12).trim(),c=b.toLowerCase().indexOf(" and "),-1<c?(this.storeValue1(b.substring(0,c).trim(),a),"date"==a.fieldObj.shortType&&!this.isHosted?this.storeValue2(b.substring(c+15).trim(),a):this.storeValue2(b.substring(c+
5).trim(),a)):a.error={msg:"missing AND operator for NOT BETWEEN",code:3},"date"==a.fieldObj.shortType?"string"==typeof a.valueObj.value1?a.operator=this.i18n.dateOperatorIsNotBetween:1E3>Math.abs(this.subtractDay(a.valueObj.value2).getTime()-a.valueObj.value1.getTime())?(a.valueObj.value=a.valueObj.value1,delete a.valueObj.value1,delete a.valueObj.value2,a.operator=this.i18n.dateOperatorIsNotOn):a.operator=this.i18n.dateOperatorIsNotBetween:"number"==a.fieldObj.shortType||"oid"==a.fieldObj.shortType?
a.operator=this.i18n.numberOperatorIsNotBetween:a.error={msg:"string field not supported for NOT BETWEEN",code:3}):"is null"==c?(a.valueObj.value=null,a.operator="date"==a.fieldObj.shortType?this.i18n.dateOperatorIsBlank:"string"==a.fieldObj.shortType?this.i18n.stringOperatorIsBlank:this.i18n.numberOperatorIsBlank):"is not null"==c?(a.valueObj.value=null,a.operator="date"==a.fieldObj.shortType?this.i18n.dateOperatorIsNotBlank:"string"==a.fieldObj.shortType?this.i18n.stringOperatorIsNotBlank:this.i18n.numberOperatorIsNotBlank):
a.error={msg:"unknown operator ("+c+")",code:2};if(esri.isDefined(a.valueObj.value)&&"string"==typeof a.valueObj.value&&a.valueObj.value.startsWith("{")&&a.valueObj.value.endsWith("}")||esri.isDefined(a.valueObj.value1)&&"string"==typeof a.valueObj.value1&&a.valueObj.value1.startsWith("{")&&a.valueObj.value1.endsWith("}"))a.isInteractive=!0},hasOperator:function(a){a=a.toLowerCase();return-1<a.indexOf("{")&&-1<a.indexOf("}")||-1<a.indexOf(" \x3d ")||-1<a.indexOf(" \x3c ")||-1<a.indexOf(" \x3e ")||
-1<a.indexOf(" \x3c\x3e ")||-1<a.indexOf(" \x3c\x3d ")||-1<a.indexOf(" \x3e\x3d ")||-1<a.indexOf(" like ")||-1<a.indexOf(" between ")||-1<a.indexOf(" date")||-1<a.indexOf(" is null")||-1<a.indexOf(" is not null")?!0:!1},storeValue:function(a,b){if(a.startsWith("{")&&a.endsWith("}"))b.valueObj.value=a;else if(a.startsWith("'{")&&a.endsWith("}'"))b.valueObj.value=a.substring(1,a.length-1);else if("date"==b.fieldObj.shortType)if(a.startsWith("'")&&a.endsWith("'")){var c=a.substring(1,a.length-1);b.valueObj.value=
this.parseDate(c)}else b.valueObj.value=a,b.valueObj.type="field",this.getFieldItemByName({name:a},function(a){b.valueObj.label=a.label[0]},function(){b.error={msg:"unknown field name ("+a+")",code:1}});else"string"==b.fieldObj.shortType?(a.startsWith("#")||a.startsWith("%#"))&&(a.endsWith("#")||a.endsWith("#%"))?b.valueObj.value=a:a.startsWith("'")&&a.endsWith("'")?b.valueObj.value=a.substring(1,a.length-1).replace(/\'\'/g,"'"):(b.valueObj.value=a,b.valueObj.type="field",this.getFieldItemByName({name:a},
function(a){b.valueObj.label=a.label[0]},function(){b.error={msg:"unknown field name ("+a+")",code:1}})):(b.valueObj.value=a,isNaN(a)&&(b.valueObj.type="field",this.getFieldItemByName({name:a},function(a){b.valueObj.label=a.label[0]},function(){b.error={msg:"unknown field name ("+a+")",code:1}})))},storeValue1:function(a,b){if(a.startsWith("{")&&a.endsWith("}"))b.valueObj.value1=a;else if(a.startsWith("'{")&&a.endsWith("}'"))b.valueObj.value1=a.substring(1,a.length-1);else if("date"==b.fieldObj.shortType)if(a.startsWith("'")&&
a.endsWith("'")){var c=a.substring(1,a.length-1);b.valueObj.value1=this.parseDate(c)}else b.valueObj.value1=a,b.valueObj.type="field";else b.valueObj.value1=a,isNaN(a)&&(b.valueObj.type="field")},storeValue2:function(a,b){if(a.startsWith("{")&&a.endsWith("}"))b.valueObj.value2=a;else if(a.startsWith("'{")&&a.endsWith("}'"))b.valueObj.value2=a.substring(1,a.length-1);else if("date"==b.fieldObj.shortType)if(a.startsWith("'")&&a.endsWith("'")){var c=a.substring(1,a.length-1);b.valueObj.value2=this.parseDate(c)}else b.valueObj.value2=
a,b.valueObj.type="field";else b.valueObj.value2=a,isNaN(a)&&(b.valueObj.type="field")},replaceStrings:function(a){for(var b=a,c=function(a,b,d){var e=-1,e=a.indexOf("'",d+1);return e==d+1?(e=a.indexOf("'",e+1),c(a,b,e)):d},d=[],f=a.indexOf("'");-1<f;){var g=f,f=a.indexOf("'",f+1),h=0,f=c(a,g,f);"%"==a[g+1]&&g++;"%"==a[f-1]&&(f-=1,h++);var k=a.substring(g+1,f);"N"==a[g-1]&&(a=a.substring(0,g-1)+a.substring(g),g-=1,f-=1);!this.isDateString(k)&&-1==k.indexOf("{")?(d.push(k),a=a.substring(0,g+1)+"#"+
(d.length-1)+"#"+a.substring(f),f=a.indexOf("'",a.lastIndexOf("#")+2+h)):f=a.indexOf("'",f+1+h)}return{origDefExpr:b,defExpr:a,savedStrings:d}},reReplaceStrings:function(a,b){var c=a.savedStrings;if(c.length&&c.length){var e=function(a,b){if("string"!==a.fieldObj.shortType||!esri.isDefined(a.valueObj.value))return!1;var c=a.valueObj.value.indexOf("#"),d=a.valueObj.value.lastIndexOf("#");return esri.isDefined(a.valueObj.value)&&-1<c?(a.valueObj.value=b[parseInt(a.valueObj.value.substring(c+1,d))].replace(/\'\'/g,
"'"),this.builtSingleFilterString(a),!0):!1},e=d.hitch(this,e),f=!1;d.forEach(b.parts,function(a){if(a.parts){var b=!1;d.forEach(a.parts,function(a){b=e(a,c)||b});b&&(f=b,a.expr=this.builtFilterString(a))}else(f=e(a,c)||f)&&this.builtFilterString(a)},this);f&&(b.expr=null,this.builtCompleteFilter(b))}},buildFriendlyText:function(){var a=!1;d.forEach(this.partsObj.parts,function(b){b.parts&&(a=!0);d.forEach(b.parts,function(a){})});var b="\x3cdiv\x3e",c="";1<this.partsObj.parts.length&&("AND"==this.partsObj.logicalOperator?
(b+="\x3ci\x3e"+this.i18n.friendlyAnd+"\x3c/i\x3e\x3cBR/\x3e",c=a?"\x3ci\x3e"+this.i18n.and+"\x3c/i\x3e\x3cBR/\x3e":""):(b+="\x3ci\x3e"+this.i18n.friendlyOr+"\x3c/i\x3e\x3cBR/\x3e",c=a?"\x3ci\x3e"+this.i18n.or+"\x3c/i\x3e\x3cBR/\x3e":""));d.forEach(this.partsObj.parts,function(a,d){b=1<this.partsObj.parts.length?b+"\x3cdiv class\x3d'esriLeadingMargin1'\x3e":b+"\x3cdiv\x3e";b=a.parts?b+this.buildFriendlyTextSet(a):b+this.buildFriendlyTextExpr(a);b+="\x3c/div\x3e";d<this.partsObj.parts.length-1&&(b+=
"\x3cdiv\x3e"+c+"\x3c/div\x3e")},this);b+="\x3c/div\x3e";this.friendlyText.innerHTML=b},buildFriendlyTextSet:function(a){var b="",c;c="AND"==a.logicalOperator?"\x26nbsp;\x26nbsp;\x26nbsp;\x3ci\x3e"+this.i18n.and+"\x3c/i\x3e\x3cBR/\x3e":"\x26nbsp;\x26nbsp;\x26nbsp;\x3ci\x3e"+this.i18n.or+"\x3c/i\x3e\x3cBR/\x3e";d.forEach(a.parts,function(d,f){b+=this.buildFriendlyTextExpr(d);f<a.parts.length-1&&(b+=c)},this);return b},buildFriendlyTextExpr:function(a){var b=this.i18n.expressionTemplate,c=function(a,
c,e){return d.string.substitute(b,{field_dropdown:a,operator_dropdown:c,values_input:e})};if(!1===a.valueObj.isValid)return"\x26lt;expression is missing value\x26gt;";var e="";if("string"==a.fieldObj.shortType)a.operator==this.i18n.stringOperatorIsBlank||a.operator==this.i18n.stringOperatorIsNotBlank?e=c(a.fieldObj.label,a.operator,""):"field"===a.valueObj.type?e=c(a.fieldObj.label,a.operator,a.valueObj.label):(e=this.getDecodedValue(a.interactiveObj?a.interactiveObj.value:a.valueObj.value,a.fieldObj.name),
e=c(a.fieldObj.label,a.operator,"'"+e+"'"));else if("number"==a.fieldObj.shortType||"oid"==a.fieldObj.shortType)if(a.operator==this.i18n.numberOperatorIsBetween||a.operator==this.i18n.numberOperatorIsNotBetween)e=a.interactiveObj?a.interactiveObj.value2:a.valueObj.value2,e=c(a.fieldObj.label,a.operator,d.number.format(a.interactiveObj?a.interactiveObj.value1:a.valueObj.value1,{pattern:"#####0.##########"})+" "+this.i18n.andBetweenValues+" "+d.number.format(e,{pattern:"#####0.##########"}));else if(a.operator==
this.i18n.numberOperatorIsBlank||a.operator==this.i18n.numberOperatorIsNotBlank)e=c(a.fieldObj.label,a.operator,"");else if("field"===a.valueObj.type)e=c(a.fieldObj.label,a.operator,a.valueObj.label);else var e=a.interactiveObj?a.interactiveObj.value:a.valueObj.value,f=this.getDecodedValue(e,a.fieldObj.name),e=c(a.fieldObj.label,a.operator,e!=f?"'"+f+"'":d.number.format(e,{pattern:"#####0.##########"}));else esri.isDefined(a.valueObj.value)&&("field"!==a.valueObj.type&&"string"==typeof a.valueObj.value)&&
(a.valueObj.value=new Date(a.valueObj.value)),e=a.operator==this.i18n.dateOperatorIsBetween||a.operator==this.i18n.dateOperatorIsNotBetween?c(a.fieldObj.label,a.operator,(a.interactiveObj?this.formatFriendlyDate(a.interactiveObj.value1):this.formatFriendlyDate(a.valueObj.value1))+" "+this.i18n.andBetweenValues+" "+(a.interactiveObj?this.formatFriendlyDate(a.interactiveObj.value2):this.formatFriendlyDate(a.valueObj.value2))):a.operator==this.i18n.dateOperatorIsBlank||a.operator==this.i18n.dateOperatorIsNotBlank?
c(a.fieldObj.label,a.operator,""):"field"===a.valueObj.type?c(a.fieldObj.label,a.operator,a.valueObj.label):c(a.fieldObj.label,a.operator,a.interactiveObj?this.formatFriendlyDate(a.interactiveObj.value):this.formatFriendlyDate(a.valueObj.value));return e},prepFriendlyView:function(){this._tabView.attr("title",this.i18n.view);this._tabEdit.attr("title",this.i18n.edit);this._tabView.attr("selected",!0);d.style(this.interactiveDiv,"display","none");this._tabContainer.selectedChildWidget=null;this._tabContainer.selectChild(k.byId("ViewChangeTab"))},
prepCreateView:function(){this._tabEdit.attr("title",this.i18n.create);this._tabContainer.removeChild(this._tabView);this._tabView.destroy();this._tabEdit.attr("selected",!0)},buildEditUI:function(){d.byId("allAny").value=this.partsObj.logicalOperator;d.forEach(this.partsObj.parts,function(a){a.parts?this.buildEditUISet(a,this.addSet({addEmptySet:!0,enableEvents:!1})):this.buildEditUIField(a,this.addExpression({enableEvents:!1,part:a}))},this)},buildEditUISet:function(a,b){d.byId(b.id+".allAnySet").value=
a.logicalOperator;d.forEach(a.parts,function(a){var d=b.addExpression({part:a});this.buildEditUIField(a,d,b)},this)},buildEditUIField:function(a,b,c){this.getFieldItemByName({name:a.fieldObj.name},d.hitch(this,function(d){b.getFieldsList().set("value",d.id[0]);this.buildEditUIOperator(a,b,c)}),d.hitch(this,function(){b.getFieldsList().set("value",0);this.buildEditUIOperator(a,b,c)}))},buildEditUIOperator:function(a,b,c){switch(a.fieldObj.shortType){case "string":var e=null;this.getCodedValues(a.fieldObj.name)&&
(e=this.i18n.stringOperatorStartsWith,e+="|"+this.i18n.stringOperatorEndsWith,e+="|"+this.i18n.stringOperatorContains,e+="|"+this.i18n.stringOperatorDoesNotContain,e={name_:RegExp("^(?!("+e+")$)")});b.fillOperatorList(this.stringOperatorStore,a.operator,e);break;case "date":b.fillOperatorList(this.dateOperatorStore,a.operator);break;default:e=null,this.getCodedValues(a.fieldObj.name)&&(e=this.i18n.numberOperatorIsBetween,e+="|"+this.i18n.numberOperatorIsNotBetween,e+="|"+this.i18n.numberOperatorIsAtLeast,
e+="|"+this.i18n.numberOperatorIsLessThan,e+="|"+this.i18n.numberOperatorIsAtMost,e+="|"+this.i18n.numberOperatorIsGreaterThan,e={name_:RegExp("^(?!("+e+")$)")}),b.fillOperatorList(this.numberOperatorStore,a.operator,e)}this.getOperatorItemByName(b.getOperatorList().store,{name:a.operator},d.hitch(this,function(d){b.getOperatorList().set("value",d.id[0]);this.buildEditUIValue(a,b,c)}),d.hitch(this,function(){b.getOperatorList().set("value",0);this.buildEditUIValue(a,b,c)}))},buildEditUIValue:function(a,
b,c){var e=a.operator;this.onChangeOperator(b.getOperatorList(),b);e==this.i18n.stringOperatorIsBlank||e==this.i18n.dateOperatorIsBlank||e==this.i18n.numberOperatorIsBlank||e==this.i18n.stringOperatorIsNotBlank||e==this.i18n.dateOperatorIsNotBlank||e==this.i18n.numberOperatorIsNotBlank?b.createValueIsBlank():"field"==a.valueObj.type?(b.createValueFields(this.fieldsStore,{shortType:a.fieldObj.shortType,name:RegExp("^(?!"+a.fieldObj.name+"$)")}),b.checkFieldOption(),this.getFieldItemByName({name:a.valueObj.value},
d.hitch(this,function(a){b.setValueFieldById(a.id[0])}),d.hitch(this,function(){b.setValueFieldById(0)}))):esri.isDefined(a.valueObj.value1)?(b.setValue1(a.valueObj.value1),b.setValue2(a.valueObj.value2)):b.setValue(a.valueObj.value,this.getCodedValues(a.fieldObj.name));this.updateUIOptions(b,a);this.defaultToValueOrUnique(null,b,c);setTimeout(d.hitch(this,function(){b.enableOnFieldChange();b.enableOnOperatorChange();c&&(c.enableEvents=!0);this.checkOK()}),1E3)},buildInteractiveEditUI:function(){d.query(".singleFilter",
this.allExps).forEach(function(a){a=k.byNode(a);a.part&&a.part.interactiveObj&&a.setInteractiveSection(!0,a.part.interactiveObj.prompt,a.part.interactiveObj.hint)})},buildInteractiveChangeUI:function(a){var b=!1;d.forEach(this.partsObj.parts,function(c,e){c.parts?d.forEach(c.parts,function(c,g){c.interactiveObj&&(b||(this._tabView.attr("title",this.i18n.change),d.style(this.interactiveDiv,"display","block"),b=!0),this.addInteractiveExpression(c,a?a.parts[e].parts[g]:null))},this):c.interactiveObj&&
(b||(this._tabView.attr("title",this.i18n.change),d.style(this.interactiveDiv,"display","block"),b=!0),this.addInteractiveExpression(c,a?a.parts[e]:null))},this)},readCodedValues:function(){var a=this.serviceLayerInfo||this.layerInfo,b=a.typeIdField,c=a.types;this.mapLayer.layer instanceof esri.layers.FeatureLayer&&(b=this.mapLayer.layer.typeIdField,c=this.mapLayer.layer.types);this.fieldDomains={};d.forEach(a.fields,function(a){if(b&&c){this.fieldDomains[a.name]=[];if(b===a.name)for(var f=0;f<c.length;f++){var g=
c[f];this.fieldDomains[a.name].push({code:g.id,name:g.name})}else for(f=0;f<c.length;f++)g=c[f],!g.domains||!g.domains[a.name]||g.domains&&g.domains[a.name]&&"inherited"===g.domains[a.name].type?a.domain&&a.domain.codedValues&&d.forEach(a.domain.codedValues,function(b){var c=!1;d.forEach(this.fieldDomains[a.name],function(a){a.code===b.code&&(c=!0,-1===a.name.indexOf(b.name)&&(a.name+=", "+b.name))});c||this.fieldDomains[a.name].push(d.clone(b))},this):g.domains&&(g.domains[a.name]&&g.domains[a.name].codedValues)&&
d.forEach(g.domains[a.name].codedValues,function(b){var c=!1;d.forEach(this.fieldDomains[a.name],function(a){a.code===b.code&&(c=!0,-1===a.name.indexOf(b.name)&&(a.name+=", "+b.name))});c||this.fieldDomains[a.name].push(d.clone(b))},this);this.fieldDomains[a.name]&&(!this.fieldDomains[a.name].length&&a.domain&&a.domain.codedValues)&&(this.fieldDomains[a.name]=a.domain.codedValues)}else a.domain&&a.domain.codedValues&&(this.fieldDomains[a.name]=a.domain.codedValues)},this)},getCodedValues:function(a){return this.fieldDomains[a]&&
this.fieldDomains[a].length?this.fieldDomains[a]:null},getDecodedValue:function(a,b){var c=this.getCodedValues(b);if(c)for(var d=0;d<c.length;d++){var f=c[d];if(f.code==a)return f.name}return a},containsNonLatinCharacter:function(a){for(var b=0;b<a.length;b++)if(255<a.charCodeAt(b))return!0;return!1},hasErrors:function(a){var b=!1;a.error?(console.log(a.expr+": "+a.error.msg),b=!0):d.forEach(a.parts,function(a){a.error?(console.log(a.expr+": "+a.error.msg),b=!0):a.parts&&d.forEach(a.parts,function(a){a.error&&
(console.log(a.expr+": "+a.error.msg),b=!0)})});return b?!0:!1},isDateString:function(a){return 19==a.length&&"-"==a.charAt(4)&&"-"==a.charAt(7)&&" "==a.charAt(10)&&":"==a.charAt(13)&&":"==a.charAt(16)?!0:!1},_isImageServiceLayer:function(a){return a instanceof esri.layers.ArcGISImageServiceLayer||a instanceof esri.layers.ArcGISImageServiceVectorLayer},testParser:function(){var a=this.parseDefinitionExpression("(COUNTY_NAME \x3d 'BOULDER') AND (CITY_NAME \x3d 'ADAMS' OR FID BETWEEN 1 AND 10 OR FIPS_CODE IS NOT NULL)");
this.buildEditUI(a)}})});