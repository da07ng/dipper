// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/Troubleshoot",["dijit","dojo","dojox","dojo/i18n!arcgisonline/nls/arcgisonline","dojo/require!dijit/_Widget,dijit/_Templated,dijit/layout/ContentPane,arcgisonline/sharing/util,arcgisonline/sharing/dijit/dialog/GeneralDlg"],function(d,b,f){b.provide("arcgisonline.sharing.dijit.Troubleshoot");b.require("dijit._Widget");b.require("dijit._Templated");b.require("dijit.layout.ContentPane");b.require("arcgisonline.sharing.util");b.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");
b.requireLocalization("arcgisonline","arcgisonline");b.declare("arcgisonline.sharing.dijit.Troubleshoot",[d._Widget,d._Templated],{widgetsInTemplate:!0,templateString:'\x3cdiv dojoAttachPoint\x3d"containerNode" class\x3d"esriItemLinks troubleshoot"\x3e\r\n        \x3cdiv class\x3d"sub-nav"\x3e\r\n          \x3cdiv class\x3d"container"\x3e\r\n            \x3ch1 class\x3d"sub-nav-title"\x3e${i18n.troubleshootTitle}\x3c/h1\x3e\r\n          \x3c/div\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv class\x3d"respond"\x3e\r\n        \x3cp id\x3d"instructions"\x3e${i18n.instructions}\x3c/p\x3e\r\n         \x3cdiv data-dojo-attach-point\x3d"_stackContainer" class\x3d"newStyles"\x3e\r\n          \x3cdiv data-dojo-attach-point\x3d"forgotUsername" class\x3d"contentPane"\x3e\r\n              \x3ch2\x3e${i18n.forgotUsername}\x3c/h2\x3e\r\n              \x3cp\x3e${!i18n.forgotUsernameInstructions}\x3c/p\x3e\r\n              \x3clabel class\x3d"esriFloatLeading" for\x3d"email"\x3e${i18n.emailLabel}\x26nbsp;\x3c/label\x3e\r\n              \x3cinput id\x3d"email" data-dojo-attach-point\x3d"_email" name\x3d"email" data-dojo-type\x3d"dijit/form/ValidationTextBox" trim\x3d"true"/\x3e\r\n              \x3cbr /\x3e\r\n              \x3cbutton data-dojo-type\x3d"dijit/form/Button" data-dojo-attach-event\x3d"onClick:_submitEmail" class\x3d"esriFloatLeading calcite blue"\x3e${i18n.send}\x3c/button\x3e\r\n              \x3cbr/\x3e\r\n          \x3c/div\x3e\r\n          \x3cdiv data-dojo-attach-point\x3d"forgotPassword" class\x3d"contentPane"\x3e\r\n              \x3ch2\x3e${i18n.forgotPassword}\x3c/h2\x3e\r\n              \x3cp\x3e${!i18n.forgotPasswordInstructions}\x3c/p\x3e\r\n              \x3clabel class\x3d"esriFloatLeading" for\x3d"username"\x3e${i18n.usernameLabel}\x26nbsp;\x3c/label\x3e\r\n              \x3cinput id\x3d"username" name\x3d"userName" data-dojo-attach-point\x3d"_userName" data-dojo-type\x3d"dijit/form/ValidationTextBox" trim\x3d"true"/\x3e\r\n              \x3cbr /\x3e\r\n              \x3cbutton data-dojo-attach-event\x3d"onClick:_submitUsername" data-dojo-type\x3d"dijit/form/Button" class\x3d"esriFloatLeading calcite blue"\x3e${i18n.customRoles.continueLabel}\x3c/button\x3e\r\n              \x3cbr /\x3e\r\n          \x3c/div\x3e\r\n         \x3cdiv class\x3d"contentPane newStyles" dojoAttachPoint\x3d"changePassword" style\x3d"display:none;"\x3e\r\n             \x3ch2\x3e${i18n.resetPassword}\x3c/h2\x3e\r\n             \x3cp class\x3d"securityQuestion"\x3e${i18n.securityQuestionInstructions}\x3c/p\x3e\r\n             \x3clabel class\x3d"securityQuestion esriFloatLeading" dojoAttachPoint\x3d"_securityQuestion"\x3e\x3c/label\x3e\r\n             \x3cinput dojoAttachPoint\x3d"_securityAnswer" name\x3d"answer" dojoType\x3d"dijit.form.ValidationTextBox" trim\x3d"true" class\x3d"ieFix securityQuestion" /\x3e\r\n             \x3cdiv class\x3d"prompt securityQuestion"\x3e${i18n.securityQuestionPrompt}\x3c/div\x3e\r\n             \x3cdiv class\x3d"portal-only" style\x3d"display:none;"\x3e\r\n                 \x3cbr/\x3e\r\n                 \x3cp\x3e${i18n.enterNewPassword}\x3c/p\x3e\r\n                 \x3cdiv class\x3d"password-1"\x3e\r\n                     \x3clabel\x3e${i18n.newPasswordLabel}\x3c/label\x3e\r\n                     \x3cinput name\x3d"password" dojoAttachPoint\x3d"_newPassword" type\x3d"password" dojotype\x3d"dijit.form.ValidationTextBox" trim\x3d"true" class\x3d"ieFix" /\x3e\r\n                 \x3c/div\x3e\r\n                 \x3cdiv class\x3d"password-2"\x3e\r\n                     \x3clabel\x3e${i18n.reenterPasswordLabel}\x3c/label\x3e\r\n                     \x3cinput name\x3d"verify" dojoAttachPoint\x3d"_verifyPassword" type\x3d"password" dojotype\x3d"dijit.form.ValidationTextBox" trim\x3d"true"/\x3e\r\n                     \x3cdiv class\x3d"prompt"\x3e${i18n.passwordHintText}\x3c/div\x3e\r\n                 \x3c/div\x3e\r\n             \x3c/div\x3e\r\n             \x3cbutton dojoAttachEvent\x3d"onClick:_submitReset" dojoType\x3d"dijit.form.Button" class\x3d"calcite blue esriFloatLeading indentBtn" style\x3d"margin-left: 205px;"\x3e${i18n.mosaicRulePanel.resetLabel}\x3c/button\x3e\r\n         \x3c/div\x3e\r\n          \x3cdiv data-dojo-attach-point\x3d"mfaHelp" class\x3d"contentPane"\x3e\r\n             \x3cbr /\x3e\r\n             \x3ch2\x3e${i18n.mfaHelpMsg}\x3c/h2\x3e\r\n             \x3cp\x3e${!i18n.mfaHelpInstructions}\x3c/p\x3e\r\n             \x3clabel class\x3d"esriFloatLeading" for\x3d"username"\x3e${i18n.usernameLabel}\x26nbsp;\x3c/label\x3e\r\n             \x3cinput id\x3d"mfa_username" name\x3d"userName" data-dojo-attach-point\x3d"_mfaUserName" data-dojo-type\x3d"dijit/form/ValidationTextBox" trim\x3d"true"/\x3e\r\n             \x3cbr /\x3e\r\n             \x3cbutton data-dojo-attach-event\x3d"onClick:_submitMfaUsername" data-dojo-type\x3d"dijit/form/Button" class\x3d"esriFloatLeading calcite blue"\x3e${i18n.customRoles.continueLabel}\x3c/button\x3e\r\n             \x3cbr /\x3e\r\n          \x3c/div\x3e\r\n         \x3cdiv class\x3d"contentPane newStyles" dojoAttachPoint\x3d"disableMfa" style\x3d"display:none;clear:both;"\x3e\r\n             \x3cbr /\x3e\r\n             \x3ch2\x3e${i18n.mfaSecurityQuestionTitle}\x3c/h2\x3e\r\n             \x3cp class\x3d"securityQuestion"\x3e${i18n.mfaSecurityQuestionMsg}\x3c/p\x3e\r\n             \x3clabel class\x3d"mfaSecurityQuestion esriFloatLeading" dojoAttachPoint\x3d"_mfaSecurityQuestion"\x3e\x3c/label\x3e\r\n             \x3cinput dojoAttachPoint\x3d"_mfaSecurityAnswer" name\x3d"answer" dojoType\x3d"dijit.form.ValidationTextBox" trim\x3d"true" class\x3d"ieFix securityQuestion" /\x3e\r\n             \x3cdiv class\x3d"prompt mfaSecurityQuestion"\x3e${i18n.securityQuestionPrompt}\x3c/div\x3e\r\n             \x3cbutton dojoAttachEvent\x3d"onClick:_submitMfaReset" dojoType\x3d"dijit.form.Button" class\x3d"calcite blue esriFloatLeading indentBtn" style\x3d"margin-left: 205px;"\x3e${i18n.send}\x3c/button\x3e\r\n         \x3c/div\x3e\r\n          \x3cdiv data-dojo-attach-point\x3d"register" title\x3d"${i18n.links.register}" style\x3d"display:none;"\x3e\r\n            \x3cp class\x3d"marginless"\x3e\x3cb\x3e${i18n.signInWidget.agsTrial}\x3c/b\x3e\x3c/p\x3e\r\n            \x3cp\x3e${i18n.signInWidget.agsSubscriptionInfo}\x3c/p\x3e\r\n            \x3ca class\x3d"calcite btn small blue" href\x3d"/about/free-trial.html?origin\x3darcgis"\x3e${i18n.signInWidget.ags30DayTrial}\x3c/a\x3e\x3cbr/\x3e\r\n            \x3cp\x3e\x3cb\x3e${i18n.signInWidget.agsNoTrial}\x3c/b\x3e\x3c/p\x3e\r\n            \x3cp\x3e${i18n.signInWidget.agsCreatePersonalMsg}.\x3c/p\x3e\r\n            \x3cp\x3e${i18n.signInWidget.agsHavePersonal}\x3c/p\x3e\r\n            \x3ca id\x3d"registerBtn" class\x3d"calcite btn small light"\x3e${i18n.signInWidget.agsRegisterPersonalBtn}\x3c/a\x3e\x3cbr/\x3e\r\n            \x3cp\x3e${i18n.signInWidget.agsCreatePersonal}\x3c/p\x3e\r\n            \x3ca id\x3d"createBtn" class\x3d"calcite btn small light"\x3e${i18n.signInWidget.agsCreatePersonalBtn}\x3c/a\x3e\r\n          \x3c/div\x3e\r\n          \x3cbr /\x3e\r\n          \x3cp data-dojo-attach-point\x3d"gotoStart" class\x3d"indent notstart" style\x3d"display:none;"\x3e${i18n.otherQuestions}\x26nbsp;\x26nbsp;\x3ca target\x3d"_blank" data-dojo-attach-event\x3d"onclick:_troubleshoot"\x3e${i18n.seeTroubleshooting}\x3c/a\x3e\x3c/p\x3e\r\n      \x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3cbr /\x3e\r\n      \x3cbr /\x3e\r\n\x3c/div\x3e',
baseClass:"esriTroubleshoot",_util:arcgisonline.sharing.util,_account:arcgisonline.sharing.geow.Account,postMixInProperties:function(){this.inherited(arguments);b.mixin(this,b.queryToObject(window.location.search.slice(1)));if(this.returnUrl){var a=window.location.host.split(".").slice(-2).join(".")+"/";-1===this.returnUrl.indexOf(a)&&(-1===this.returnUrl.indexOf("arcgis.com/")&&-1===this.returnUrl.indexOf("esri.com/"))&&(this.returnUrl=null)}this.i18n=b.mixin({},b.i18n.getLocalization("arcgisonline",
"arcgisonline").common);b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").troubleshoot);b.mixin(this.i18n,{customRoles:b.i18n.getLocalization("arcgisonline","arcgisonline").customRoles});b.mixin(this.i18n,{mosaicRulePanel:b.i18n.getLocalization("arcgisonline","arcgisonline").mosaicRulePanel});b.mixin(this.i18n,{signInWidget:b.i18n.getLocalization("arcgisonline","arcgisonline").signInWidget});this.i18n.errors=b.mixin(b.i18n.getLocalization("arcgisonline","arcgisonline").common.errors,
b.i18n.getLocalization("arcgisonline","arcgisonline").troubleshoot.errors);this.i18n.questions=b.mixin(b.i18n.getLocalization("arcgisonline","arcgisonline").securityQuestions,{"0":this.i18n.questions.question0})},startup:function(){this.inherited(arguments);this._connects=[];esri.config.defaults.io.proxyUrl=esriGeowConfig.proxyServer;this._errorDlg=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();this._svcUrl=esriGeowConfig.restBaseUrl+(esriGeowConfig.restBaseUrl.lastIndexOf("/")===
esriGeowConfig.restBaseUrl.length-1?"":"/");this._communityUrl=this._svcUrl+"community/";this._userUrl=this._communityUrl+"users/";this._requestParams={f:"json"};this.connect(b.byId("registerBtn"),"onclick",b.hitch(this,function(){window.location=esriGeowConfig.signup}));this.connect(b.byId("createBtn"),"onclick",b.hitch(this,function(){window.location=esriGeowConfig.createAccount}));this.connect(this._stackContainer,"onClick",b.hitch(this,function(){b.style(this.changePassword,"display","none")}));
this._initHelpMgr();this._troubleshoot()},destroy:function(){this.inherited(arguments);b.forEach(this._connects,b.disconnect)},_initHelpMgr:function(){var a=arcgisonline.sharing.dijit.HelpManager.prototype.statics.getInstance(),c=setInterval(b.hitch(this,function(){if(a.isLoaded())if(clearInterval(c),esriGeowConfig&&esriGeowConfig.self&&esriGeowConfig.self.isPortal)b.query(".helpLink").forEach(esri.hide),b.query("#instructions").forEach(function(a){b.style(a,"visibility","hidden")});else{var e=a.getHelpUrl("120000466");
b.query(".helpLink").attr("href",e)}}),200)},_switchPane:function(b){},_forgotPassword:function(){b.attr(this._forgotPasswordTitle,"innerHTML",this.i18n.forgotPassword);this._switchPane(this.forgotPassword);this._userName.focus()},_changePassword:function(){b.attr(this._forgotPasswordTitle,"innerHTML",this.i18n.resetPassword);this._switchPane(this.forgotPassword);this._userName.focus()},_forgotUsername:function(){this._switchPane(this.forgotUsername);this._email.focus()},_troubleshoot:function(){this._account.getSelf(b.hitch(this,
function(a){!1===esriGeowConfig.showForgotUsername&&this._stackContainer.removeChild(this.forgotUsername);this.isPortal=a&&a.isPortal;if(a&&(a.isPortal||a.urlKey))this._stackContainer.removeChild(this.register),this.isPortal&&(b.query(".portal-only").forEach(esri.show),this._stackContainer.removeChild(this.mfaHelp));this._clear();this._securityQuestionIdx=-1;this._switchPane(this._start)}))},_redirectToSignin:function(){window.location=this.returnUrl||"signin.html"},_submitEmail:function(a){a.preventDefault();
if(!this._checkRequired([this._email]))return a=this._communityUrl+"forgotUsername",this._disable(!0),this._request(a,{email:this._email.get("value")}).then(b.hitch(this,function(){this._redirectToSignin()}))},_submitUsername:function(a){a.preventDefault();this._newPassword.set("value","");this._verifyPassword.set("value","");if(!this._checkRequired([this._userName]))return a=this._userUrl+this._userName.get("value")+"/forgotPassword",this._disable(!0),this._request(a,{}).then(b.hitch(this,function(a){a=
a||{};"arcgis"===a.provider?(this._securityQuestionIdx=(-1===a.securityQuestionIdx?0:a.securityQuestionIdx)||0,b.attr(this._securityQuestion,"innerHTML",this.i18n.questions[a.securityQuestionIdx]),this._securityQuestionIdx||this._showError(this.i18n.errors.noSecurity),b.query(".securityQuestion",this.domNode).style("display",""),b.style(this.changePassword,"display",this._securityQuestionIdx?"":"none"),this._securityAnswer.focus()):"enterprise"===a.provider?this._showError(this.i18n.errors.administrator):
(this._isEcas=!0,b.query(".securityQuestion",this.domNode).style("display","none"),b.style(this.changePassword,"display",""))}))},_submitMfaUsername:function(a){a.preventDefault();if(!this._checkRequired([this._mfaUserName]))return a=this._userUrl+this._mfaUserName.get("value")+"/forgotPassword",this._disable(!0),this._mfaUserNameCheck=!0,this._request(a,{}).then(b.hitch(this,function(a){a=a||{};this._securityQuestionIdx=(-1===a.securityQuestionIdx?0:a.securityQuestionIdx)||0;b.attr(this._mfaSecurityQuestion,
"innerHTML",this.i18n.questions[a.securityQuestionIdx]);this._securityQuestionIdx||this._showError(this.i18n.errors.noSecurity);b.query(".disableMfa",this.domNode).style("display","");b.style(this.disableMfa,"display",this._securityQuestionIdx?"":"none");this._mfaSecurityAnswer.focus()}))},_submitMfaReset:function(a){a.preventDefault();a={securityAnswer:this._mfaSecurityAnswer.get("value"),securityQuestionIdx:this._securityQuestionIdx};if(!this._checkRequired([this._mfaSecurityAnswer])){var c=this._util.getSecureUrl(this._userUrl)+
this._mfaUserName.get("value")+"/disableMfaRequest";this._disable(!0);return this._request(c,a).then(b.hitch(this,function(a){var c=b.connect(this._errorDlg,"onHide",b.hitch(this,function(){c.remove();this._redirectToSignin()}));this._showError(this.i18n.errors.mfaEmailSent)}))}},_submitReset:function(a){a.preventDefault();a={securityAnswer:this._securityAnswer.get("value"),securityQuestionIdx:this._securityQuestionIdx};if(this.isPortal){var c=[this._newPassword,this._verifyPassword];this._isEcas||
c.unshift(this._securityAnswer);if(this._checkRequired(c))return;c=this._newPassword.get("value");if(c!==this._verifyPassword.get("value"))return this._verifyPassword.focus(),this._showError(this.i18n.errors.passwordsNotMatch);if(c&&!this._util.meetsPasswordStrength(c))return this._newPassword.focus(),!this._showError(b.mixin(this.i18n.errors.invalidPassword,{message:this.i18n.passwordHintText}));a.newPassword=this._newPassword.get("value")}else{c=[this._securityAnswer];if(this._checkRequired(c))return;
a.email=!0}c=this._util.getSecureUrl(this._userUrl)+this._userName.get("value")+"/reset";this._disable(!0);return this._request(c,a).then(b.hitch(this,function(a){if(this.isPortal)this._redirectToSignin();else{var c=b.connect(this._errorDlg,"onHide",b.hitch(this,function(){c.remove();this._redirectToSignin()}));this._showError(this.i18n.errors.emailSent)}}))},_disable:function(a){b.query(".esriTroubleshoot .dijitTextBox, .esriTroubleshoot .dijitButton").map(d.byNode).forEach(function(b){b.set("disabled",
a)})},_clear:function(){b.query(".esriTroubleshoot .dijitTextBox").map(d.byNode).forEach(function(a){a.set("value","")})},_checkRequired:function(a){return(a=b.filter(a,b.hitch(this,function(a){return this._isEmpty(a)})))&&a.length?(a[0].focus(),this._showError(this.i18n.errors.required[a[0].name])):!1},_isEmpty:function(a){a=a.get("value");return(this.trim?/^\s*$/:/^$/).test(a)},_request:function(a,c){return this._util.request({url:a,content:c},{usePost:!0}).then(b.hitch(this,function(a){this._mfaUserNameCheck=
!1;this._disable(!1);return a.error?this._showError(a.error):a}),b.hitch(this,function(a){this._disable(!1);a&&"COM_0018"===a.messageCode&&this._userName?(a=this._mfaUserNameCheck?this._mfaUserName.get("value"):this._userName.get("value"),a={message:esri.substitute({username:this._util.stripHTML(a)},this.i18n.errors.COM_0018)}):a&&"COM_1037"===a.messageCode?a={message:this.i18n.errors.COM_1037}:a&&"COM_1059"===a.messageCode?a={message:this.i18n.errors.COM_1059}:a&&"COM_1055"===a.messageCode?a={message:this.i18n.errors.COM_1055}:
a&&"DB_0003"===a.messageCode?a={message:this.i18n.errors.DB_0003}:a&&"DB_0002"===a.messageCode&&(a={message:this.i18n.errors.DB_0002});this._showError(a);this._mfaUserNameCheck=!1;throw a;}))},_showError:function(a){a.message=a.message&&a.message.replace(/[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi,"")||"";a.message=this._util.stripHTML(a.message);a=a.error||a||{};a.code=a.code||0;a=b.mixin(b.mixin({},this.i18n.errors.error),a);this._errorDlg.show(a);return!0}})});