// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/GroupTemplatesGrid",["dijit","dojo","dojox","dojo/require!arcgisonline/sharing/geow/Content,arcgisonline/sharing/geow/Community,arcgisonline/sharing/dijit/Gallery,arcgisonline/sharing/dijit/views,arcgisonline/sharing/util,dojo/mouse"],function(m,a,q){a.provide("arcgisonline.sharing.dijit.GroupTemplatesGrid");a.require("arcgisonline.sharing.geow.Content");a.require("arcgisonline.sharing.geow.Community");a.require("arcgisonline.sharing.dijit.Gallery");a.require("arcgisonline.sharing.dijit.views");
a.require("arcgisonline.sharing.util");a.require("dojo.mouse");a.declare("arcgisonline.sharing.dijit.GroupTemplatesGrid",[m._Widget,m._Templated],{templateString:"\x3cdiv dojoAttachPoint\x3d'containerNode'\x3e\x3c/div\x3e",i18n:null,sortField:null,sortOrder:null,showThumbnail:!0,templatesGroupId:null,groupQuery:null,galleryNodes:4,textMenus:[],_views:arcgisonline.sharing.dijit.views,_util:arcgisonline.sharing.util,_gallery:null,_galleryPane:null,_detailsPane:null,_detailsTextPane:null,_detailsIconPane:null,
_detailsTimer:null,onPublish:function(){},onPreview:function(){},_getTemplates:function(){var c={q:"group:"+this.templatesGroupId+' AND type:"Web Mapping Application"',sortField:this.sortField,num:"50"};this.sortOrder&&(c.sortOrder=this.sortOrder);arcgisonline.sharing.geow.Content.search(esriGeowConfig.restBaseUrl+"search",c,a.hitch(this,this._handleTemplatesResponse),a.hitch(this,this._handleTemplatesResponse))},refresh:function(){this._getTemplates()},postMixInProperties:function(){this.inherited(arguments);
this.i18n=a.i18n.getLocalization("arcgisonline","arcgisonline").common;a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").templatesGridWidget)},postCreate:function(){this._gallery=new arcgisonline.sharing.dijit.Gallery({id:this.id+"_Gallery",nodesPerPage:this.galleryNodes,showNodeLabels:!0,showToolTip:!1,noResultsMessage:"\x3cp class\x3d'esriItemLinks'\x3e\x3cspan\x3e"+this.i18n.noItemsToDisplay+"\x3c/span\x3e\x3c/p\x3e"},a.create("div",null,this.domNode));this._user=arcgisonline.sharing.util.getUser();
var c=this;a.mixin(this._gallery,{_buildNodeLayout:function(b,h){var e=a.create("div",{id:"galleryNode_"+b.id,"class":this.nodeClass,style:"position:relative;"});a.addClass(e,h?"large":"small");if(this.showNodeLabels){var k=a.create("div",{"class":"galleryLabelContainer"},e),d=b.title||"";a.create("span",{innerHTML:d,alt:d,title:d},k)}var k=void 0!==esriGeowConfig.isMultiTenant&&null!==esriGeowConfig.isMultiTenant&&!1===esriGeowConfig.isMultiTenant,g=b.url,g=0===g.indexOf("http")||0===g.indexOf("//")?
g:window.location.protocol+"//"+window.location.host+g;c&&c._user&&c._user.accountId?g=k?c._getPortalPreviewUrl(b,g):g.replace("/hosted/","/apps/"):c&&k&&(g=c._getPortalPreviewUrl(b,g));k=a.create("a",{href:"JavaScript:void(0);"},e);a.create("img",{"class":this.thumbClass,src:b.thumbnail?this._getThumbailUrl(b):arcgisonline.sharing.util.relativeToExplicitUrl("images/transparent.gif")},k);a.create("br",null,e);var d=a.create("div",{"class":"linksDiv"},e),d=a.create("div",{"class":"esriItemLinks"},
d),m=a.create("div",{"class":"esriFloatLeading"},d),l=a.create("a",{href:"JavaScript:void(0);",style:"text-decoration: none;"},m);a.connect(l,"onclick",a.hitch(this,function(a){a.preventDefault();a.stopPropagation()}));a.create("span",{innerHTML:this.i18n.publish},l);a.create("div",{"class":"dijitReset dijitInline esriArrows"},l);arcgisonline.sharing.geow.Content.getApplicationCode(b,a.hitch(this,function(f){var d=a.filter(f.relatedItems&&0<f.relatedItems.length?f.relatedItems:[f],function(a){return null!==
a.url});d&&d.length?(f=d[0],a.query(".toolbar .codeAttachment").style("display","none")):f=f.relatedItems&&0<f.relatedItems.length?f.relatedItems[0]:f;d=[];d.push({label:this.i18n.publish,onClick:a.hitch(c,"onPublish",{url:b.url,id:b.id})});f.id&&d.push({label:this.i18n.download,onClick:a.hitch(c,"onDownload",f.url||esriGeowConfig.restBaseUrl+"content/items/"+f.id+"/data",f.url?!0:!1)});d.push({label:this.i18n.preview,onClick:a.hitch(c,"onPreview",{url:g,id:f.id})});f=new arcgisonline.sharing.dijit.TextMenu({triggerNode:l,
labelNode:l,textMenuItems:d});c.textMenus.push(f)}));a.create("span",{innerHTML:"\x26nbsp;",style:"width:0;"},d);d=b.snippet||"";145<d.length&&(d=d.substring(0,140)+"...");var d=a.create("div",{id:"tooltip"+b.id,className:"templatesGridTooltip",innerHTML:'\x3cp class\x3d"title ellipsis"\x3e'+b.title+"\x3c/p\x3e\x3cp\x3e"+d+"\x3c/p\x3e"},e,"first"),n=function(c){(c=a.byId(c))&&a.style(c,{opacity:0,display:"none"})},p=function(b,d){var e=a.byId(b);esri.show(e);var g=a.coords(e),h=a.coords(a.byId(d).parentNode);
g.w+g.x>h.w+h.x&&(a.style(e,"left","auto"),a.style(e,"right",a.isIE?"10px":"0"));a.fadeIn({node:e}).play();a.forEach(c.textMenus,function(a){a.hide()})};/ipad|android|android 3.0|xoom|sch-i800|playbook|tablet|kindle/i.test(navigator.userAgent.toLowerCase())?a.connect(k,"onclick",function(){var c=a.byId("tooltip"+b.id);c&&"block"===a.getStyle(c,"display")?n("tooltip"+b.id):p("tooltip"+b.id,"galleryNode_"+b.id);a.query(".templatesGridTooltip").forEach(function(a){a.id!=="tooltip"+b.id&&n(a.id)})}):
(a.connect(k,a.mouse.enter,function(){a.query(".templatesGridTooltip").forEach(function(a){n(a.id)});p("tooltip"+b.id,"galleryNode_"+b.id)}),a.connect(d,a.mouse.leave,function(){n("tooltip"+b.id)}));return e}});this._gallery.startup()},_getPortalPreviewUrl:function(a,b){var h=arcgisonline.sharing.util.parseUrl(b);"/"===a.url.substring(0,1)&&-1<esriGeowConfig.baseUrl.indexOf(h.host)&&(b=window.location.protocol+"//"+window.location.host+arcgisonline.sharing.util.getHomeAppContext()+a.url);return b=
"https:"===window.location.protocol?arcgisonline.sharing.util.getSecureUrl(b):arcgisonline.sharing.util.getHttpUrl(b)},onDownload:function(a,b,h){h.preventDefault();b?window.open(a):window.location=a},_setGroupQueryAttr:function(c){(this.groupQuery=c)&&0<this.groupQuery.length&&arcgisonline.sharing.geow.Community.searchGroups(this.groupQuery,a.hitch(this,this._handleGetGroup),a.hitch(this,this._handleGetGroup))},_setGroupIdAttr:function(a){null===a||0===a.length||(this.pageCount=0,this.templatesGroupId=
a,this._getTemplates())},_handleTemplatesResponse:function(c){for(var b,h=[],e=0;e<c.results.length;e++)b=c.results[e],b.url&&h.push(b);a.attr(this._gallery,"items",h)},_handleGetGroup:function(a,b){this._groupDoesntExist=!1;a&&1==a.total?(this.templatesGroupId=a.results[0].id,a.results[0].sortField&&(this.sortField=a.results[0].sortField),a.results[0].sortOrder&&(this.sortOrder=a.results[0].sortOrder),this._setGroupIdAttr(a.results[0].id)):a&&1<a.total?console.error("TemplatesGrid: group query '"+
this.groupQuery+"' returned more than 1 result."):(this._groupDoesntExist=!0,console.error('TemplatesGrid: group with query "'+this.groupQuery+'" does not exist.'))},nextPage:function(){this._gallery.nextPage()},prevPage:function(){this._gallery.prevPage()},doNothing:function(a){a.preventDefault();a.stopPropagation()}})});