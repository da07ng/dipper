// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/AttachCodeDlg",["dijit","dojo","dojox","dojo/require!arcgisonline/sharing/util,arcgisonline/sharing/dijit/dialog/GeneralDlg,dijit/form/Button,dijit/_Widget,dijit/_Templated"],function(f,b,g){b.provide("arcgisonline.sharing.dijit.dialog.AttachCodeDlg");b.require("arcgisonline.sharing.util");b.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");b.require("dijit.form.Button");b.require("dijit._Widget");b.require("dijit._Templated");b.declare("arcgisonline.sharing.dijit.dialog.AttachCodeDlg",
[f._Widget,f._Templated],{util:arcgisonline.sharing.util,community:arcgisonline.sharing.geow.Community,content:arcgisonline.sharing.geow.Content,widgetsInTemplate:!0,templateString:'\x3cdiv class\x3d"widgetContainer"  dojoAttachPoint\x3d"containerNode"\x3e\r\n  \x3cdiv dojotype\x3d"dijit.Dialog" dojoAttachPoint\x3d"dialog" title\x3d"${titleLabel}" execute\x3d""\x3e\r\n    \x3ctable\x3e\r\n      \x3ctbody\x3e\r\n        \x3ctr\x3e\r\n          \x3ctd\x3e\r\n\t\t\t      \x3cdiv id\x3d"code_upload_message" style\x3d"margin-bottom:10px;"\x3e\r\n\t\t\t        ${messageLabel}\r\n\t\t\t      \x3c/div\x3e\r\n          \x3c/td\x3e\r\n        \x3c/tr\x3e\r\n        \x3ctr\x3e\r\n          \x3ctd\x3e\r\n\t\t\t      \x3cform dojoAttachPoint\x3d"form" action\x3d"" enctype\x3d"multipart/form-data" method\x3d"post" onSubmit\x3d"return false;"\x3e\r\n\t\t\t        \x3cinput type\x3d"file" name\x3d"file" dojoAttachPoint\x3d"fileInput" size\x3d"50" /\x3e\r\n              \x3cinput type\x3d"hidden" name\x3d"title" value\x3d"" /\x3e\r\n\t\t\t        \x3cinput type\x3d"hidden" name\x3d"type" value\x3d"" /\x3e\r\n\t\t\t        \x3cinput type\x3d"hidden" name\x3d"typekeywords" value\x3d"" /\x3e\r\n\t\t\t        \x3cinput type\x3d"hidden" name\x3d"overwrite" value\x3d"false" /\x3e\r\n              \x3cinput type\x3d"hidden" name\x3d"relationshipType" value\x3d"" /\x3e\r\n              \x3cinput type\x3d"hidden" name\x3d"originItemId" value\x3d"" /\x3e\r\n              \x3cinput type\x3d"hidden" name\x3d"async" value\x3d"true" /\x3e\r\n\t\t\t\r\n\t\t\t        \x3c!-- this is complicated... need some way of automating this --\x3e\r\n\t\t\t        \x3c!--\x3cdiv id\x3d"add-item-callback" name\x3d"callback.html" dojotype\x3d"dijit.form.TextBox" type\x3d"hidden" value\x3d"textarea"\x3e\x3c/div\x3e --\x3e\r\n\t\t\t      \x3c/form\x3e\r\n          \x3c/td\x3e\r\n        \x3c/tr\x3e\r\n        \x3ctr\x3e\r\n          \x3ctd align\x3d"right" style\x3d"padding-top:2em;"\x3e\r\n\t\t    \x3cbutton dojoAttachPoint\x3d"cancelButton" dojoType\x3d"dijit.form.Button" class\x3d"esriFloatTrailing cancel" type\x3d"button" dojoAttachEvent\x3d"onClick:_cancelButtonClick"\x3e\r\n\t\t      ${i18n.cancel}\r\n\t        \x3c/button\x3e\r\n\t\t    \x3cbutton dojoAttachPoint\x3d"uploadButton" dojoType\x3d"dijit.form.Button" class\x3d"esriFloatTrailing primary"  type\x3d"button" dojoAttachEvent\x3d"onClick:_uploadButtonClick"\x3e\r\n\t\t      ${i18n.uploadLabel}  \r\n\t\t    \x3c/button\x3e\r\n            \x3cspan id\x3d"code_upload-waiting" class\x3d"esriFloatTrailing" style\x3d"display:none;padding-top:8px;"\x3e\x3c/span\x3e\r\n\t\t    \x3cspan class\x3d"esriFloatLeading error" dojoAttachPoint\x3d"errorLabelNode" style\x3d"padding-top:8px;"\x3e\x3c/span\x3e\r\n\t      \x3c/td\x3e\r\n\t    \x3c/tr\x3e\r\n\t  \x3c/tbody\x3e\r\n\t\x3c/table\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e\r\n',
dialog:null,fileInput:null,cancelButton:null,uploadButton:null,cancelButton:null,clearFormOnHide:!0,codeAttachment:null,titleLabel:"",messageLabelUpdate:"",messageLabel:"",messageErrorUpdate:"",errorLabelNode:null,type:"Code Attachment",typeKeywords:"Code",item:null,sharing:null,fileName:null,_lastUploaded:null,i18n:null,postMixInProperties:function(){this.inherited(arguments);this.i18n=b.i18n.getLocalization("arcgisonline","arcgisonline").common;b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline",
"arcgisonline").attachCodeDlg);this.titleLabel=this.i18n.attachCode;this.messageLabelUpdate=this.i18n.messageLabelUpdateString;this.messageLabel=this.i18n.messageLabelString;this.messageErrorUpdate=this.i18n.messageErrorUpdateString},postCreate:function(){this.fileInput&&b.connect(this.fileInput,"onchange",this,function(){this.errorLabelNode.innerHTML=""})},statics:{_instance:null,getInstance:function(){null==this._instance&&(this._instance=new arcgisonline.sharing.dijit.dialog.AttachCodeDlg);return this._instance}},
clear:function(){this.fileInput&&(this.fileInput.value="")},hide:function(){this.dialog&&(this.dialog.hide(),this.clearFormOnHide&&this.clear())},show:function(a){(this.codeAttachment=a)&&this.codeAttachment.name?(this.messageLabelUpdate=b.string.substitute(this.messageLabelUpdate,{fileName:this.codeAttachment.name}),b.byId("code_upload_message").innerHTML=this.messageLabelUpdate,b.byId("dijit_Dialog_0_title").innerHTML=this.i18n.updateCode):(b.byId("code_upload_message").innerHTML=this.messageLabel,
b.byId("dijit_Dialog_0_title").innerHTML=this.i18n.attachCode);this.dialog&&this.dialog.show()},_cancelButtonClick:function(a){this.hide()},_uploadButtonClick:function(a){(a=this.fileInput.value)&&0<a.length&&this.util.endsWith(a,".zip")?(this.uploadButton.set("disabled",!0),this.cancelButton.set("disabled",!0),b.style(b.byId("code_upload-waiting"),"display","inline-block"),this.doUpload()):this.errorLabelNode.innerHTML=this.i18n.fileZipFormat},doUpload:function(){if(null==this.item||null===this.item.id)console.error(this.i18n.itemIdRequired),
this.uploadButton.set("disabled",!1),this.cancelButton.set("disabled",!1),b.style(b.byId("code_upload-waiting"),"display","none");else{var a=this.fileInput.value,d=a.lastIndexOf("\\");-1<d&&(a=a.substring(d+1,a.length));if(this.codeAttachment){var c=this.codeAttachment.name.lastIndexOf("."),d=a.lastIndexOf("."),c=[this.codeAttachment.name.substring(0,c),this.codeAttachment.name.substring(c).toLowerCase()],a=[a.substring(0,d),a.substring(d).toLowerCase()];c[0]!==a[0]||c[1]!==a[1]?(arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.updateCodeError,
message:b.string.substitute(this.messageErrorUpdate,{fileName:this.codeAttachment.name})}),this.uploadButton.set("disabled",!1),this.cancelButton.set("disabled",!1),b.style(b.byId("code_upload-waiting"),"display","none")):this._updateCodeItem()}else this._createCodeItem()}},_createCodeItem:function(){if(this.form){this.form.type.value=this.type;this.form.typekeywords.value=this.typeKeywords;this.form.relationshipType.value="WMA2Code";"Mobile Application"===this.item.type&&(this.form.relationshipType.value=
"MobileApp2Code");this.form.originItemId.value=this.item.id;var a=this.fileInput.value,d=a.lastIndexOf("\\");-1<d&&(a=a.substring(d+1,a.length));this.fileName=a;this.form.title.value=a;a=this.form.title.value.lastIndexOf("\\");-1<a&&(this.form.title.value=this.form.title.value.substring(a+1,this.form.title.value.length));a=this.form.title.value.lastIndexOf("/");-1<a&&(this.form.title.value=this.form.title.value.substring(a+1,this.form.title.value.length));this.content.addItem(null,this.form,b.hitch(this,
this._handle_addItem),b.hitch(this,this._handle_addItem))}},_updateCodeItem:function(){if(this.form){this.form.type.value=this.type;this.form.typekeywords.value=this.typeKeywords;this.form.overwrite.value="true";var a=this.fileInput.value,d=a.lastIndexOf("\\");-1<d&&(a=a.substring(d+1,a.length));this.fileName=a;this.form.title.value=a;this.content.updateItem(this.codeAttachment,this.form,b.hitch(this,this._handle_addItem),b.hitch(this,this._handle_addItem))}},_handle_addItem:function(a,d){var c=!1;
-1<d.url.indexOf("/status")&&(c=!0);if(!c&&a.success||c&&"completed"===a.status)this._lastUploaded=b.clone(a),this._lastUploaded.title=this._lastUploaded.name=this.form.title.value,this.onUpload(this._lastUploaded);else{c=this.i18n.attachementFailedUpload;a&&a.error&&a.error.message?c=a.error.message:a&&a.statusMessage&&(c=a.statusMessage);var e=this.i18n.cannotAddAttachment;-1<c.indexOf("already exists")?(c=this.i18n.sameZipFileName,e=this.i18n.duplicateFileName):-1<c.indexOf("The request size is greater than the max allowed of 1024MB")&&
(c=this.i18n.fileSizeExceeds);this.hide();arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:e,message:c})}this.uploadButton.set("disabled",!1);this.cancelButton.set("disabled",!1);b.style(b.byId("code_upload-waiting"),"display","none")},_handle_updateItem:function(a,d){if(a.success)this.uploadButton.set("disabled",!1),this.cancelButton.set("disabled",!1),b.style(b.byId("code_upload-waiting"),"display","none"),this.hide();else{var c=this.i18n.attachementFailedUpload;
a&&(a.error&&a.error.message)&&(c=a.error.message);var e=this.i18n.cannotAddAttachment;-1<c.indexOf("already exists")?(c=this.i18n.sameZipFileName,e=this.i18n.duplicateFileName):-1<c.indexOf("The request size is greater than the max allowed of 1024MB")&&(c=this.i18n.fileSizeExceeds);this.hide();arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:e,message:c});this.uploadButton.set("disabled",!1);this.cancelButton.set("disabled",!1);b.style(b.byId("code_upload-waiting"),
"display","none")}},onUpload:function(a){}})});