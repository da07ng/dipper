// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("dojo/_base/lang dojo/_base/json dojo/_base/url dojo/cookie dojo/_base/Deferred dojo/io-query esri/identity/IdentityManager".split(" "),function(k,g,l,e,m,h,b){var n={portal:"http://qaext.arcgis.com",popupCallbackPage:window.location.protocol+"//"+window.location.host+window.location.pathname.replace(/\/[^\/]+$/,"")+"/oauth-callback.html",init:function(a){k.mixin(this,a);this.portalUrl=this.portal+"/sharing/rest";this.checkOAuthResponse(window.location.href,!0);this.checkCookie();this.overrideIdentityManager()},
isSignedIn:function(){return!!b.findCredential(this.portalUrl)},signIn:function(){var a=this.deferred=new m;if(0<b.credentials.length)setTimeout(function(){a.resolve(b.credentials[0])},0);else{var d={client_id:this.appId,response_type:"token",expiration:this.expiration,redirect_uri:this.popup?this.popupCallbackPage:window.location.href.replace(/#.*$/,"")},d=this.portal.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize?"+h.objectToQuery(d);this.popup?window.open(d,"esrioauth","width\x3d480,height\x3d320,location\x3dyes,status\x3dyes,scrollbars\x3dyes"):
window.location=d}return a},signOut:function(a){e("arcgis_auth",null,{expires:-1,path:"/",domain:document.domain});a||window.location.reload()},checkOAuthResponse:function(a,b){var c=this.parseFragment(a);if(c)if(b&&(window.location.hash=""),c.error){var f=Error(c.error);f.details=[c.error_description];this.deferred&&this.deferred.reject(f)}else f=this.registerToken(c),c.persist&&(e("arcgis_auth",g.toJson(c),{expires:new Date(c.expires_at),path:"/",domain:document.domain}),console.log("[Cookie] Write: ",
e("arcgis_auth"))),this.deferred&&this.deferred.resolve(f)},checkCookie:function(){var a=e("arcgis_auth");a&&(console.log("[Cookie] Read: ",a),a=g.fromJson(a),this.registerToken(a))},registerToken:function(a){b.registerToken({server:this.portalUrl,userId:a.username,token:a.access_token,expires:a.expires_at,ssl:a.ssl});a=b.findCredential(this.portalUrl,a.username);console.log("Token registered with Identity Manager: ",a);return a},parseFragment:function(a){a=new l(a);if(a=a.fragment?h.queryToObject(a.fragment):
null)return a.access_token?(console.log("[OAuth Response]: ",a),a.expires_in=Number(a.expires_in),a.expires_at=(new Date).getTime()+1E3*a.expires_in,a.ssl="true"===a.ssl):a.error&&console.log("[OAuth Error]: ",a.error," - ",a.error_description),a},overrideIdentityManager:function(){var a=b.signIn,d=b.getCredential,c=this;b.getCredential=function(a,b){return-1!==a.indexOf(".arcgis.com")?c.signIn():d.apply(this,arguments)};b.signIn=function(b,d,e){return-1!==d.server.indexOf(".arcgis.com")?c.signIn():
a.apply(this,arguments)}}};return window.OAuthHelper=n});