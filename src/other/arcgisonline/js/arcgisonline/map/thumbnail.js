// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/thumbnail",["dijit","dojo","dojox","dojo/require!arcgisonline/map/main"],function(s,c,t){c.provide("arcgisonline.map.thumbnail");c.require("arcgisonline.map.main");arcgisonline.map.thumbnail={buildThumbnailURLFromWebMap:function(a,f,e,b){var d=function(a,b){e(b);arcgisonline.map.thumbnail._destroyHiddenMap(a)};arcgisonline.map.thumbnail._createHiddenMap(a,f,c.hitch(this,function(a){arcgisonline.map.thumbnail._createThumbnailImage(a,c.hitch(this,d,a),b)}),b)},buildThumbnailURLFromMap:function(a,
f){arcgisonline.map.thumbnail._createThumbnailImage(arcgisonline.map.main.map,c.hitch(this,function(c){a(c)}),f)},buildThumbnailURLFromFSUrl:function(a,c){return arcgisonline.map.thumbnail.buildThumbnailURLFromFSItem({url:a,extent:c})},buildThumbnailURLFromFSItem:function(a,f,e){var b={};b.baseMap=esriGeowConfig.defaultBasemap||esriGeowConfig.self.defaultBasemap;b.baseMap.title="basemap";for(var d=b.baseMap.baseMapLayers.length,g=0;g<d;g++){var h=b.baseMap.baseMapLayers[g];if(!h.isReference){if((esriGeowConfig.allSSL||
"https:"==location.protocol)&&(arcgisonline.sharing.util.isHostedService(h.url)||arcgisonline.sharing.util.supportsHttps(h.url)))h.url=h.url.replace("http:","https:");h.visibility=!1;b.baseMap.baseMapLayers=[h];break}}b.operationalLayers=[];var k=new c.Deferred,d=function(d,g){g?d&&c.forEach(d,function(a){c.forEach(g,function(b,d){b.id===a.id&&(b[d]=a)})}):g=[];arcgisonline.map.layer.getServiceInfo(a.url,"",c.hitch(this,function(d,h){for(var e=d.layers.length-1;0<=e;e--){for(var m=d.layers[e],l=esri.id.findCredential(arcgisonline.sharing.util.urlToObject(a.url).path),
l={url:a.url+"/"+m.id+(l?"?token\x3d"+l.token:""),id:(a.id||Math.random())+"_"+m.id,opacity:1,title:(a.title||"title")+"_"+m.id,visibility:!0},p=!1,n=0;n<g.length;n++)if(g[n].id===m.id){p=!0;l.layerDefinition=g[n].layerDefinition;break}(!g.length||g.length&&p)&&b.operationalLayers.push(l)}var q=function(a){k.callback(a)},r=function(a){k.errback(a)};1===b.operationalLayers.length?(e=new esri.layers.FeatureLayer(b.operationalLayers[0].url),c.connect(e,"onLoad",c.hitch(this,function(d){arcgisonline.map.thumbnail.getExtentWithFeatures({layer:d},
f||a.extent).then(c.hitch(this,function(a,b){arcgisonline.map.thumbnail.buildThumbnailURLFromWebMap(a,b,c.hitch(this,q),c.hitch(this,r))},b))}))):arcgisonline.map.thumbnail.buildThumbnailURLFromWebMap(b,f||a.extent,c.hitch(this,q),c.hitch(this,r))}),c.hitch(this,function(a){k.errback(a)}))};e?arcgisonline.map.thumbnail._getItemData(a.id,c.hitch(this,d,e),c.hitch(this,d)):a.id?arcgisonline.map.thumbnail._getItemData(a.id,c.hitch(this,d,null),c.hitch(this,d)):d();return k},buildThumbnailURLFromKMLItem:function(a,
f){var e={};e.baseMap=esriGeowConfig.defaultBasemap||esriGeowConfig.self.defaultBasemap;e.baseMap.title="basemap";e.operationalLayers=[];var b=a.url;!b&&"KML"===a.type&&(b=esriGeowConfig.restBaseUrl+"content/items/"+a.id+"/data");var d=(new c._Url(esriGeowConfig.restBaseUrl)).authority;-1<b.indexOf(d)&&(d=arcgisonline.sharing.util.getToken())&&(b+="?token\x3d"+d);e.operationalLayers.push({url:b,id:"KML_"+Math.random(),opacity:1,title:a.title,visibility:!0,type:"KML"});var g=new c.Deferred,b=f;b||
("string"==typeof a.extent?(b=a.extent.split(","),b=[[parseFloat(b[0]),parseFloat(b[1])],[parseFloat(b[2]),parseFloat(b[3])]]):b=a.extent&&0<a.extent.length?a.extent:[[-180,-90],[180,90]]);arcgisonline.map.thumbnail.buildThumbnailURLFromItemWebMap(e,b,new esri.SpatialReference({wkid:4326}),c.hitch(this,function(a){g.callback(a)}),c.hitch(this,function(a){g.errback(a)}));return g},buildThumbnailURLFromItemWebMap:function(a,f,e,b,d){a=c.clone(a);c.forEach(a.baseMap.baseMapLayers,function(a){delete a.resourceInfo});
a.mapOptions={showAttribution:!1,extent:{xmin:f[0][0],ymin:f[0][1],xmax:f[1][0],ymax:f[1][1],spatialReference:{wkid:4326}},spatialReference:e};a.exportOptions={dpi:96,outputSize:[200,133]};a.layoutOptions={};f=new esri.tasks.Geoprocessor(esriGeowConfig.self.helperServices.printTask.url);e={Web_Map_as_JSON:c.json.stringify(a),Format:"PNG32",Layout_Template:"MAP_ONLY"};f.execute(e).then(c.hitch(this,function(a){if(a){for(var c=!1,f=0;f<a.length;f++)if("Output_File"==a[f].paramName){b(a[f].value.url);
c=!0;break}!c&&d&&d()}else d&&d()}),c.hitch(this,function(a){d&&d()}))},buildThumbnailURLFromLayerOnMap:function(a,f){var e=new c.Deferred,b=[[-180,-90],[180,90]];f&&(b=f.split(","),b=[[b[0],b[1]],[b[2],b[3]]]);if(arcgisonline.map.featColl.isFeatureCollection(a)||a.layer instanceof esri.layers.CSVLayer){var d=arcgisonline.map.storage.buildWebMapText();delete d.widgets;for(var g=d.baseMap.baseMapLayers.length,h=0;h<g;h++){var k=d.baseMap.baseMapLayers[h];if(!k.isReference){k.visibility=!1;d.baseMap.baseMapLayers=
[k];break}}g=d.operationalLayers.length;for(h=0;h<g;h++)if(k=d.operationalLayers[h],k.id==a.id){a.itemId&&(k.featureCollection=arcgisonline.map.featColl.buildFeatureCollectionJson(a));delete k.itemId;d.operationalLayers=[k];break}arcgisonline.map.thumbnail.getExtentWithFeatures(a,b).then(c.hitch(this,function(a,b,d){arcgisonline.map.thumbnail.buildThumbnailURLFromWebMap(a,d,function(a){b.resolve(a)},function(){b.resolve(null)})},d,e))}else if(a.layer&&(a.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer||
a.layer instanceof esri.layers.ArcGISTiledMapServiceLayer||a.layer instanceof esri.layers.VectorTileLayer||a.layer instanceof esri.layers.ArcGISImageServiceLayer||a.layer instanceof esri.layers.FeatureLayer)){d=arcgisonline.map.storage.buildWebMapText();delete d.widgets;g=d.operationalLayers.length;for(h=0;h<g;h++)if(k=d.operationalLayers[h],k.id==a.id){delete k.itemId;d.baseMap.baseMapLayers=[k];d.operationalLayers=[];break}arcgisonline.map.thumbnail.getExtentWithFeatures(a,b).then(c.hitch(this,
function(a,b,d){arcgisonline.map.thumbnail.buildThumbnailURLFromWebMap(a,d,function(a){b.resolve(a)},function(){b.resolve(null)})},d,e))}return e},_getItemData:function(a,f,e){var b=function(){var b=arcgisonline.map.itemData.itemDataContents[a];b&&b.layers?f(b.layers):e&&e()};if(arcgisonline.map.itemData.itemDataContents[a])if(arcgisonline.map.itemData.itemDataContents[a]&&arcgisonline.map.itemData.itemDataContents[a].loading)var d=setInterval(c.hitch(this,function(){!0!==arcgisonline.map.itemData.itemDataContents[a].loading&&
(clearInterval(d),b())}),500);else b();else arcgisonline.map.itemData.itemDataContents[a]={loading:!0},arcgisonline.sharing.util.request({url:esriGeowConfig.restBaseUrl+"content/items/"+a+"/data"},{disableIdentityLookup:!0}).then(c.hitch(this,function(d){arcgisonline.map.itemData.itemDataContents[a]=d||{};b()}),c.hitch(this,function(a){b()}))},_createThumbnailImage:function(a,f,e){for(var b=200,d=133,g=function(b){return arcgisonline.map.main.mapLods&&(b=arcgisonline.map.main.getScaleForExtent(a.extent,
b),arcgisonline.map.main.mapLods[0].scale<b)?!1:!0};!g(b)&&!(b*=2,d*=2,1600<=b););g=new esri.tasks.PrintTemplate;g.layout="MAP_ONLY";g.format="png32";g.preserveScale=!1;g.showAttribution=!1;g.showLabels=!1;g.exportOptions={width:b,height:d,dpi:96};arcgisonline.map.mapUtil.printTask||(arcgisonline.map.mapUtil.printTask=new esri.tasks.PrintTask(esriGeowConfig.self.helperServices.printTask.url,{}));b=new esri.tasks.PrintParameters;b.map=a;b.template=g;esri.config.defaults.io.timeout=12E4;arcgisonline.map.mapUtil.printTask.execute(b,
c.hitch(this,function(a){esri.config.defaults.io.timeout=6E4;f(a.url)}),c.hitch(this,function(a){esri.config.defaults.io.timeout=6E4;console.log(a.message?a.message:a);e&&e(a)}))},_createHiddenMap:function(a,f,e,b){var d=c.byId("hiddenMapDiv");c.byId("hiddenMapDiv")||(d=c.create("div",{id:"hiddenMapDiv",style:{position:"absolute",left:"-1000px",top:"-1000px",width:"200px",height:"130px"}},document.body));c.create("div",{id:"hiddenMap",style:{width:"200px",height:"130px"}},d);d={item:{}};d.item.extent=
f;d.itemData=a;a=esri.arcgis.utils.createMap(d,"hiddenMap",{mapOptions:{nav:!1},bingMapsKey:esriGeowConfig.self.bingKey});a.addCallback(function(a){var b=function(a){var b=new c.Deferred;a._heatmapManager?c.aspect.after(a._heatmapManager,"recalculateHeatmap",function(){b.callback()}):b.callback();return b},d=function(a){var b=new c.Deferred;a.updating?c.connect(a,"onUpdateEnd",function(){b.callback()}):b.callback();return b},f=[];c.forEach(a.map.graphicsLayerIds,function(c){c=a.map.getLayer(c);c.renderer&&
"heatmap"===c.renderer.type?f.push(b(c)):c.updating&&f.push(d(c))});f.length?(new c.DeferredList(f)).addCallback(function(b){setTimeout(function(){e(a.map)},1E3)}):e(a.map)});a.addErrback(function(a){console.log("Map creation failed: ",c.json.stringify(a));b&&b(a)})},_destroyHiddenMap:function(a){a.destroy();c.byId("hiddenMapDiv").removeChild(c.byId("hiddenMap"))},recreateItemThumbnail:function(a){arcgisonline.map.thumbnail.hasCustomThumbnail(a)||function(a,e){var b;arcgisonline.map.featColl.isFeatureCollection(a)?
(b=arcgisonline.map.featColl.buildConfig(a),b=b.featureCollection?b.featureCollection.layers:null):a.layer&&a.layer.renderer&&(b=a.layerDefinition||{},b.drawingInfo={renderer:a.layer.renderer.toJson()},b=[{id:a.url?parseInt(a.url.substring(a.url.lastIndexOf("/")+1)):a.layer.id.substring(a.layer.id.lastIndexOf("_")+1),layerDefinition:b}]);arcgisonline.map.thumbnail.buildThumbnailURLFromFSItem(a.itemCard,e,b).then(c.hitch(this,function(b){var e=arcgisonline.sharing.util.getUser(),h=function(a,c){var e=
esriGeowConfig.restBaseUrl+"content/users/"+c.email,e=e+(a.itemCard.ownerFolder?"/"+a.itemCard.ownerFolder:""),e=e+("/items/"+a.itemCard.id+"/update");arcgisonline.sharing.util.postJson({thumbnailURL:b},e)};void 0===a.itemCard.ownerFolder?arcgisonline.sharing.geow.Content.getItem(a.itemCard.id,c.hitch(this,function(b){a.itemCard=b;h(a,e)})):h(a,e)}))}(a)},getExtentWithFeatures:function(a,f){var e=new c.Deferred;if(!(a.layer instanceof esri.layers.FeatureLayer)||a.layer instanceof esri.layers.StreamLayer)return e.callback(f),
e;var b=a.layer;a.layers&&(b=a.layers[0]);b.addPlugin("esri/plugins/FeatureLayerStatistics").then(function(){b.statisticsPlugin.getSuggestedScaleRange({map:arcgisonline.map.main.map}).then(function(a){if(a.center){var b=arcgisonline.map.main.getExtentFromCenter(a.center,1280,a.minScale);if(0<a.relaxedMinScale)for(var c=arcgisonline.map.main.getScaleForExtent(b,200),k=800;c>a.relaxedMinScale&&!(b=arcgisonline.map.main.getExtentFromCenter(a.center,k,a.minScale),c=arcgisonline.map.main.getScaleForExtent(b,
200),k-=200,0>=k););arcgisonline.map.main.projectExtent(b,new esri.SpatialReference({wkid:4326}),function(a){f=[[a[0].xmin,a[0].ymin],[a[0].xmax,a[0].ymax]];e.callback(f)},function(){e.callback(f)})}else e.callback(f)},function(a){e.callback(f)})},function(a){e.callback(f)});return e},hasCustomThumbnail:function(a){return!a||!a.itemCard||a.itemCard&&(!a.itemCard.thumbnail||"thumbnail/ago_downloaded.png"==a.itemCard.thumbnail)?!1:!0}}});