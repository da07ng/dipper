// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("esri/core/declare dojo/dom-class dojo/on dojo/dom-geometry dojo/Evented ./LayerWidget ./LayerItemEditable dojo/topic dojox/mdnd/AreaManager dojox/mdnd/DropIndicator dojox/mdnd/dropMode/OverDropMode dojo/i18n!../nls/widgets".split(" "),function(l,k,m,n,p,q,r,s,t,u,v,w){var x=l([v],{addArea:function(a,d){try{var h=n.position(d.node,!0);d.coords={x:h.x,y:h.y};a.push(d)}catch(b){console.warn(b)}return a},_checkInterval:function(a,d,h,b){var c=a[d];a=c.coords;d=a.x2;var g=a.y,c=g+c.node.offsetHeight-
-25;return a.x<=h&&h<=d&&g<=b&&b<=c?!0:!1}}),y=l([t,p],{findCurrentIndexArea:function(a,d){this._dropMode.updateAreas(this._areaList);this._areaList.forEach(function(a){k.contains(a.node,"layers")&&(a.coords.y+=-25)});this._oldIndexArea=this._currentIndexArea;var h=this._areaList;k.contains(this._dragItem.item.node,"GroupLayerItem")&&(h=[this._areaList[this._areaList.length-1]]);var b=this._dropMode.getTargetArea(h,a);this._currentIndexArea=h!=this._areaList&&0===b?this._areaList.length-1:b;if(this._currentIndexArea!=
this._oldIndexArea){if(-1!=this._oldIndexArea)this.onDragExit(a,d);if(-1!=this._currentIndexArea)this.onDragEnter(a,d)}return this._currentIndexArea},placeDropIndicator:function(a,d){this._dropMode.updateAreas(this._areaList);this._areaList[this._currentIndexArea].initItems=!1;this.emit("drop_indicator_added",{parentNode:this._areaList[this._currentIndexArea]});return this.inherited(arguments)},onDragExit:function(a,d){this.emit("drop_indicator_removed",{parentNode:this._areaList[this._oldIndexArea]});
return this.inherited(arguments)}});return l([q],{editor:void 0,postCreate:function(){k.add(this.domNode,"LayerWidgetEditable");this._initDragAndDrop();this.inherited(arguments)},_initDragAndDrop:function(){this._dragManager=new y;this._dragManager._dropIndicator=new u;this._dragManager._dropMode=new x;this._onHandles.push(m(this._dragManager,"drop_indicator_added",function(a){this._removePlaceholder(a)}.bind(this)));this._onHandles.push(m(this._dragManager,"drop_indicator_removed",function(a){this._addPlaceholder(a)}.bind(this)));
var a=s.subscribe("/dojox/mdnd/drop",function(a,h,b){setTimeout(function(){var c,g,f;h.node===this.domNode&&(f="map");this._layerItems.some(function(b){b.domNode===a?(g="map",c=b.layer):b.isGroupLayer&&b._layerItems.some(function(b){return b.domNode===a?(g=b.parentGroup,c=b.layer,!0):!1});if(!c)return!1}.bind(this));if(c){"map"!==f&&this._layerItems.some(function(a){return h.node.parentNode===a.domNode?(f=a.layer,!0):!1}.bind(this));var e=0,e=this.map.layers.reduce(function(a,b){return a+("SilentContentLayer"===
b.id||"__basemapErrorFallbackLayer__"===b.id?1:0)},0);if(0<e&&this.map.layers.length>e){var k=function(a,b){for(var c=a.layers.getAll(),d=0;d<c.length-1;d++)if(c[d].id===b){a.reorder(c[d],c.length-1);break}};k(this.map,"__basemapErrorFallbackLayer__");k(this.map,"SilentContentLayer")}this.editor.setWebSceneChanged();"map"===g?"map"===f?(e=this.map.layers.get("length")-b-1-e,console.log("moving '"+(c.title||c.id)+"' from map to map. new idx\x3d"+e),this.map.reorder(c,e)):(b=0<b?b-1:b,e=f.layers.get("length")-
b,console.log("moving '"+(c.title||c.id)+"' from map to '"+(f.title||f.id)+"'. new idx\x3d"+e),f.add(c,e)):"map"===f?(e=this.map.layers.get("length")-b-e,console.log("moving '"+(c.title||c.id)+"' from '"+(g.title||g.id)+"' to map. new idx\x3d"+e),this.map.add(c,e)):g===f?(e=f.layers.get("length")-b,console.log("moving '"+(c.title||c.id)+"' within '"+(g.title||g.id)+"'. new idx\x3d"+e),g.reorder(c,e)):(b=0<b?b-1:b,e=f.layers.get("length")-b,console.log("moving '"+(c.title||c.id)+"' from '"+(g.title||
g.id)+"' to '"+(f.title||f.id)+"'. new idx\x3d"+e),f.add(c,e))}}.bind(this),0)}.bind(this));this._onHandles.push(a)},_destroyAllLayerItems:function(){this._unregisterDragAreas();this.inherited(arguments)},_setupAllLayerItems:function(){for(var a=this.map.layers.get("length")-1;0<=a;a--){var d=this.map.layers.getItemAt(a);"SilentContentLayer"===d.id||"__basemapErrorFallbackLayer__"===d.id||this._addLayerItem(d)}0<this._layerItems.length&&this._registerDragAreas()},_unregisterDragAreas:function(){this._layerItems.forEach(function(a){a.isGroupLayer&&
this._dragManager.unregister(a.layersDomNode)}.bind(this));this._dragManager.unregister(this.domNode)},_registerDragAreas:function(){this._layerItems.forEach(function(a){a.isGroupLayer&&this._dragManager.registerByNode(a.layersDomNode)}.bind(this));this._dragManager.registerByNode(this.domNode)},_createLayerItem:function(a){return new r({view:this.view,layer:a,layerWidget:this,editor:this.editor})},_removePlaceholder:function(a){a=a.parentNode.node;-1<a.className.indexOf("layers emptyPlaceholder")&&
(a.textContent="",k.remove(a,"emptyPlaceholder"))},_addPlaceholder:function(a){a=a.parentNode.node;-1<a.className.indexOf("layers")&&0===a.childNodes.length-1&&(a.textContent=w.layerItemEditable.dragHere,k.add(a,"emptyPlaceholder"))},focusAddedGroupTitle:function(a){this._layerItems.forEach(function(d){d.isGroupLayer&&d.layer===a&&(d.titleInlineEditBox.set("disabled",!1),d.titleInlineEditBox.edit())}.bind(this))}})});