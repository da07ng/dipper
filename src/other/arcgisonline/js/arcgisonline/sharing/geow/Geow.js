// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/geow/Geow",["dijit","dojo","dojox","dojo/require!arcgisonline/sharing/util"],function(n,c,p){c.provide("arcgisonline.sharing.geow.Geow");c.require("arcgisonline.sharing.util");arcgisonline.sharing.geow.Geow={util:arcgisonline.sharing.util,generatetoken:function(a,b,c){var f=esriGeowConfig.restBaseUrl.replace("http:","https:")+"generatetoken",g=document.domain,d=g.split(".");1<d.length&&(g=d[d.length-2]+"."+d[d.length-1]);a.referer=g;this._tokenExpiration=a.expiration;
this.util.postJson(a,f,b,c)},signup:function(a,c,e){var f=esriGeowConfig.restBaseUrl+"community/signup",g=document.domain,d=g.split(".");1<d.length&&(g=d[d.length-2]+"."+d[d.length-1]);a.referer=g;this.util.postJson(a,f,c,e)},signin:function(a,b,e){this.generatetoken(a,c.hitch(arcgisonline.sharing.geow.Geow,"signInHandler",a.username,b,e),e)},setAuthCookie:function(a,b){var e=document.domain,f={path:"/"};a.persistent&&(f.expires=new Date(a.expires));"https:"===window.location.protocol&&a.allSSL&&
(f.secure=!0);c.cookie("esri_auth",c.json.stringify(c.mixin({portalApp:!0},a)),c.mixin(f,{domain:e}));a.portalApp&&delete a.portalApp;!esriGeowConfig.isDebug&&esriGeowConfig.self&&!esriGeowConfig.self.isPortal&&esriGeowConfig.self.urlKey?(a.urlKey=esriGeowConfig.self&&esriGeowConfig.self.urlKey,a.customBaseUrl=esriGeowConfig.self&&esriGeowConfig.self.urlKey&&esriGeowConfig.self.customBaseUrl||esriGeowConfig.self.portalHostname||window.location.hostname,c.cookie("esri_auth",c.json.stringify(a),c.mixin(f,
{domain:"arcgis.com"}))):!esriGeowConfig.isDebug&&esriGeowConfig.self&&!esriGeowConfig.self.isPortal?(a.customBaseUrl=esriGeowConfig.self&&esriGeowConfig.self.portalHostname||window.location.hostname,c.cookie("esri_auth",c.json.stringify(a),c.mixin(f,{domain:"arcgis.com"}))):b&&(esriGeowConfig.self.isPortal||c.cookie("esri_auth",c.json.stringify(a),c.mixin(f,{domain:"arcgis.com"})));if((e=arcgisonline.sharing.util._cookies)&&e.esri_auth)e.esri_auth=null,arcgisonline.sharing.util.getCookie("esri_auth")},
signInHandler:function(a,b,e,f,g){var d=new Date,m=new Date(d.setMinutes(d.getMinutes()+(this._tokenExpiration||120))),d=c.hitch(this,function(a,e){a.culture&&(a.culture=a.culture.toLowerCase());var d={email:a.username,privacy:a.privacy,token:f.token,ssl:f.ssl,culture:a.culture,region:a.region,expires:m.getTime()};a.orgId&&a.role&&(d.accountId=a.orgId,d.role=a.role);this.setAuthCookie(d);if(a.preferredView&&null!==a.preferredView)this.util.userPreferences({contentMode:a.preferredView},esriGeowConfig.contentModeCookieName);
else{var h=this.util.userPreferences(null,esriGeowConfig.contentModeCookieName);if(h&&h.contentMode){var k=c.create,l=k("form",{method:"POST"},c.body());k("input",{type:"hidden",name:"preferredView",value:h.contentMode},l);k("input",{type:"hidden",name:"clearEmptyFields",value:"false"},l);arcgisonline.sharing.geow.Community.updateProfile(l,function(a){})}}d=c.mixin(d,a);b&&b(d,g);c.publish("onSignIn",[d])});this.util.getJson(this.util.useSSL(esriGeowConfig.restBaseUrl+"community/users/"+a+"?token\x3d"+
f.token),c.hitch(this,d),e)},signInHandler2:function(a){var b=esriGeowConfig.restBaseUrl+"community/users/"+a.username+"?token\x3d"+a.token,e=new Date,f=!a.persist?Math.min(7200,Number(a.expires_in)):Number(a.expires_in),g=new Date(e.setSeconds(e.getSeconds()+Number(f))),d=a&&!!a.ssl;return this.util.getJson(this.util.useSSL(b)).then(c.hitch(this,"_hasSecurityQuestion")).then(c.hitch(this,function(b){var e={email:b.username,privacy:b.privacy,token:a.token,culture:b.culture&&b.culture.toLowerCase()||
"",region:b.region,expires:g&&g.getTime()||null,persistent:a.persist?!0:void 0,allSSL:d};b.orgId&&b.role&&(e.accountId=b.orgId,e.role=b.role);b.preferredView&&this.util.userPreferences({contentMode:b.preferredView},esriGeowConfig.contentModeCookieName);this.setAuthCookie(e);e=c.mixin(e,b);c.publish("onSignIn",[e]);return e}))},_hasSecurityQuestion:function(a){var b=new c.Deferred;a.validateUserProfile=!0;a&&!a.idpUsername&&("arcgisonly"===a.userType||"both"===a.userType)&&a.validateUserProfile?b=
this.util.request({url:esriGeowConfig.restBaseUrl+"community/users/"+a.username+"/forgotPassword",content:{}},{}).then(c.hitch(this,function(b){b&&("enterprise"!==b.provider&&-1===b.securityQuestionIdx)&&(a.noSecurityQuestion=!0);return a})):b.resolve(a);return b},signout:function(a){esriGeowConfig.userInfo=null;esriGeowConfig.userPreferences=null;c.cookie("esri_auth",null,{expires:-1,path:"/",domain:document.domain});arcgisonline.map&&arcgisonline.map.storage.deleteMapStorageNoFeedback();c.publish("onSignOut",
[]);a=a||window.location.href;window.location=arcgisonline.sharing.util.getSecureUrl(esriGeowConfig.restBaseUrl+"oauth2/signout")+(a?"?client_id\x3darcgisonline\x26redirect_uri\x3d"+a:"")},checkSharedCookie:function(){var a=this.util.getCookie("esri_auth"),b=!1;a&&(!a.urlKey&&location.hostname.match(/\.+\maps.*\..+\..+/i))&&(b=!0);!b&&(a&&a.customBaseUrl&&-1===document.domain.toLowerCase().indexOf(a.customBaseUrl.toLowerCase())&&-1===a.customBaseUrl.toLowerCase().indexOf(document.domain.toLowerCase()))&&
(b=!0);!b&&(a&&a.urlKey&&-1===window.location.hostname.toLowerCase().indexOf(a.urlKey.toLowerCase()+"."))&&(b=!0);b&&(c.cookie("esri_auth",null,{expires:-1,path:"/",domain:".arcgis.com"}),arcgisonline.sharing.util&&(arcgisonline.sharing.util._cookies&&arcgisonline.sharing.util._cookies.esri_auth)&&delete arcgisonline.sharing.util._cookies.esri_auth)},setCookies:function(a){var b=this.util.getCookie("esri_auth");!a.isPortal&&b&&(!esriGeowConfig.isDebug&&a.urlKey&&-1===window.location.hostname.toLowerCase().indexOf(a.urlKey.toLowerCase())?
(a=window.location.href.replace(window.location.hostname,a.urlKey+"."+a.customBaseUrl),window.location=this.util.getBridgeUrl(a,b)):b.urlKey?(delete b.urlKey,delete b.customBaseUrl,this.setAuthCookie(b)):b.urlKey||esriGeowConfig.isDebug||this.setAuthCookie(b))}}});