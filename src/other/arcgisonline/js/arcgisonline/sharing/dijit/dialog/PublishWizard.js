// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/PublishWizard","dojo/_base/declare dojo/_base/lang dojo/dom-class dojo/dom-style dojo/dom-attr dojo/dom-construct dojo/query dojo/cookie dojo/on dojo/json dojo/number dojo/_base/array dijit/_Widget dijit/_Templated dijit/form/RadioButton dijit/form/Select dijit/form/TextBox dojo/Deferred dojo/promise/all dojo/aspect dojo/Evented put-selector/put dgrid/OnDemandGrid dgrid/Selection dgrid/editor dojo/store/Memory dojo/store/Observable dojox/widget/Wizard dojox/widget/WizardPane dojo/_base/event dojo/keys dojo/topic arcgisonline/sharing/geow/Account arcgisonline/sharing/geow/Folder arcgisonline/sharing/util arcgisonline/sharing/dijit/dialog/GeneralDlg arcgisonline/sharing/dijit/dialog/BrowseItemsDlg arcgisonline/sharing/dijit/dialog/ItemPropertiesDlg arcgisonline/sharing/dijit/dialog/PluginLayerTemplates arcgisonline/sharing/dijit/dialog/PluginFeatureServices arcgisonline/sharing/dijit/dialog/PublishTileServiceDlg esri/dijit/Tags esri/layers/ArcGISTiledMapServiceLayer esri/layers/ImageParameters esri/map esri/geometry/Extent esri/geometry/webMercatorUtils dojo/i18n!arcgisonline/nls/arcgisonline".split(" "),
function(x,c,l,D,E,f,q,W,m,s,p,h,X,Y,Z,$,aa,r,y,F,ba,w,G,H,z,I,J,K,t,A,B,C,L,M,N,O,v,P,ca,da,Q,ea,R,S,T,U,V,u){return x("arcgisonline.sharing.dijit.dialog.PublishWizard",[K],{baseClass:"esriPublishingWizard esriItemLinks",hideDisabled:!0,onDone:function(){},postMixInProperties:function(){this.inherited(arguments);this.i18n=c.mixin({},u.common);this.i18n=c.mixin(this.i18n,u.publishWizard);this.i18n=c.mixin(this.i18n,u.publishTileServiceDlg);this.i18n2=c.mixin({},u.addItemFrm);this.i18n.errors.serviceNameExists=
this.i18n2.errors.serviceNameExists;this.i18n.errors.invalidCharactersService=this.i18n2.errors.invalidCharactersService;this.previousButtonLabel=this.i18n.previousButtonLabel;this.nextButtonLabel=this.i18n.nextButtonLabel;this.doneButtonLabel=this.i18n.doneButtonLabel;this.cancelButtonLabel=this.i18n.cancelButtonLabel},postCreate:function(){this._account=L;this._util=N;this._folder=M;this._errorDlg=O.prototype.statics.getInstance();this._init();l.add(this.nextButton.domNode,["calcite","primary"]);
l.add(this.cancelButton.domNode,["calcite","cancel"]);l.add(this.previousButton.domNode,["calcite","default"]);l.add(this.doneButton.domNode,["calcite","primary"]);this._spinner=f.create("span",{"class":"spinner hide",innerHTML:this.i18n.pleaseWait},q(".dojoxWizardButtons",this.domNode)[0],"first");this.inherited(arguments)},destroy:function(){for(var a;a=this._connects.pop();)a.remove();for(;a=this._panes.pop();)this.removeChild(a),a.destroyRecursive();this.inherited(arguments)},_init:function(){this._account.getSelf(c.hitch(this,
function(){esri.config.defaults.io.proxyUrl=esriGeowConfig.proxyServer;this._connects=[];this._panes=[];this._loadConnections();this._user=this._util.getUser();this._restBaseUrl=esriGeowConfig.allSSL?esriGeowConfig.restBaseUrl.replace("http:/","https:/"):esriGeowConfig.restBaseUrl;this._restBaseUrl+=this._restBaseUrl.lastIndexOf("/")===this._restBaseUrl.length-1?"":"/";this._contentUrl=this._restBaseUrl+"content";this._publishUrl=this._contentUrl+"/users/"+this._user.username;this._defaultExtent=
esriGeowConfig.self.defaultExtent;this._tileGalleryQueryParams={query:'type:"Feature Service" AND typekeywords:"Hosted Service" AND -typekeywords:"webmap_2.1" AND orgid:"'+this._user.accountId+'" AND owner:"'+this._user.username+'"'};this._svcQueryParams={q:'type:"Feature Service" AND typekeywords: "Hosted Service" AND orgid:'+esriGeowConfig.userInfo.accountId,num:100,start:0,sortField:"title",sortOrder:"asc"};this._tQueryParams={q:'type:"Layer Template" AND typekeywords: "Service template"',num:100,
start:0,sortField:"title",sortOrder:"asc"};this._editingInfo={hasStaticData:!1,capabilities:"Query,Editing,Create,Update,Delete",allowGeometryUpdates:!0};this.addChild(this._galleryPane(this.itemType));"features"===this.itemType?(this.addChild(this._layersPane()),this.addChild(this._extentPane()),this.addChild(this._itemDetailsPane())):this.addChild(this._tilesPane())}),null)},_loadConnections:function(){this.own(C.subscribe("/esri/disable",c.hitch(this,function(a,c){this._disable(a,c||u.common.pleaseWait)})),
C.subscribe("/esri/browseitems/close",dojo.hitch(this,function(a){if("on-next"===a)this.nextButton.onClick();else"on-view-item"===a&&window.open("item.html?id\x3d"+this._browseDlg.get("selection").id)})));F.after(this,"_checkButtons",function(){this.selectedChildWidget.isFirstChild&&"fromUrl"!==this._selectedTab&&(this.nextButton.domNode.style.display="none")})},_galleryPane:function(a){return"features"===a?this._galleryPaneFeatures():this._galleryPaneTiles()},_galleryPaneFeatures:function(a){a=new t({canGoBack:!1});
var d=document.createDocumentFragment(),b,e,k,g;this._browseDlg=g=new v({message:this.i18n.selectTemplate,item:c.mixin(this.item,{tags:""}),"class":"esriBrowseItemsDlg"});this._isTemplateSelected=!0;this._selectedTab="fromTemplate";b=f.create("div",{id:"galleryTabs","class":"galleryTabs"},d);f.create("a",{"class":"esriPublishTab selected",id:"fromTemplate",href:"#",innerHTML:this.i18n.fromTemplate},b);f.create("a",{"class":"esriPublishTab",id:"fromExisting",href:"#",innerHTML:this.i18n.fromLayer},
b);f.create("a",{"class":"esriPublishTab",id:"fromUrl",href:"#",innerHTML:this.i18n.fromUrl},b);e=f.create("div",{id:"templateContent","class":"templateContent withTabs"},d);k=f.create("div",{id:"fromUrl","class":"fromUrl hide"},d);g.addPlugin("arcgisonline/sharing/dijit/dialog/PluginLayerTemplates");f.place(g.domNode,e);f.create("p",{innerHTML:this.i18n.chooseUrl},k);f.create("label",{"for":"url","class":"esriTrailingMargin1",innerHTML:this.i18n.urlItemLbl},k);var n=new dijit.form.TextBox({name:"url",
trim:"true",placeHolder:this.i18n.urlItemPlaceHolder},f.create("span",{},k));m(b,"click",c.hitch(this,function(a){a.preventDefault();q("a",b).forEach(function(a){l.remove(a,"selected")});l.add(a.target,"selected");l.add(e,"hide");l.add(k,"hide");this._selectedService=null;this._isTemplateSelected="fromTemplate"===a.target.id;g&&(g.destroyRecursive(),g=null);this._selectedTab=a=a.target.id;this.nextButton.domNode.style.display="fromUrl"!==a?"none":"";"fromExisting"===a?(this._browseDlg=g=new v({message:this.i18n.selectTemplate,
item:c.mixin(this.item,{tags:""}),"class":"esriBrowseItemsDlg"}),g.addPlugin("arcgisonline/sharing/dijit/dialog/PluginFeatureServices"),f.place(g.domNode,e),l.remove(e,"hide"),g.set("message",this.i18n.selectExistingLayer)):"fromTemplate"===a?(this._browseDlg=g=new v({message:this.i18n.selectTemplate,item:c.mixin(this.item,{tags:""}),"class":"esriBrowseItemsDlg"}),g.addPlugin("arcgisonline/sharing/dijit/dialog/PluginLayerTemplates"),f.place(g.domNode,e),l.remove(e,"hide"),g.set("message",this.i18n.selectTemplate)):
(l.remove(k,"hide"),n.set("value",""))}));this._connect(n,"change",c.hitch(this,function(a){if(a){var b=/(http|https):\/\/?/,c=/(\/(FeatureServer)).*/ig;a=a.split("?")[0];var e=a.replace(/http.+\/(arcgis\/rest\/services|arcgis\/services)\/?/ig,"").match(c),e=e&&e.length?e[0].split("/")[1]:null,d=a.toLowerCase().indexOf("/featureserver");e?(a=a.substring(0,d)+"/FeatureServer",b.exec(a)||(a="http://"+a),n.set("value",a),this._selectedService={name:a.replace(c,"").replace(/^.*\//,"").replace(/\?.*$/,
""),svcUrl:a}):(this._svcErr={id:a,error:this.i18n.errors.unknownService},this._showError(this.i18n.errors.unknownService))}}));a.passFunction=c.hitch(this,function(){var a=g&&g.get("selection")||this._selectedService;return a?(this._selectedService=this._isTemplateSelected?c.mixin(a,{svcUrl:this._restBaseUrl+"content/items/"+a.id+"/data"}):c.mixin(a,{svcUrl:a.svcUrl||a.url}),!0):this._showError("fromExisting"===this._selectedTab?this.i18n.errors.noSelectedService:"fromTemplate"===this._selectedTab?
this.i18n.errors.noSelectedTemplate:this.i18n.errors.noLayerUrl)});a.set("content",d);this._panes.push(a);return a},_galleryPaneTiles:function(){var a=new t({canGoBack:!1}),d=document.createDocumentFragment(),b,e;b=f.create("div",{id:"templateContent","class":"templateContent"},d);this._browseDlg=e=new v({message:this.i18n.errors.noSelectedService.message,itemQuery:this._tileGalleryQueryParams,item:c.mixin(this.item,{tags:""}),"class":"esriBrowseItemsDlg"});f.place(e.domNode,b);e.set("message",this.i18n.errors.noSelectedService.message);
a.passFunction=c.hitch(this,function(){var a=e&&e.get("selection")||this._selectedService;return a&&a.url?(a.url!==(this._selectedService&&this._selectedService.url)&&(this._featureServiceJson=null,this._isUserDefinedTileInfo=!1,this.userDefinedTileInfo=null,this._selectedService=c.mixin(a,{svcUrl:a.svcUrl||a.url})),!0):a?this._showError(this.i18n.errors.noItemUrl):this._showError(this.i18n.errors.noSelectedService)});a.set("content",d);this._panes.push(a);return a},_tilesPane:function(){var a=new t({canGoBack:!0}),
d=document.createDocumentFragment(),b=new Q({message:this.i18n.itemDetails,showFolders:!0,type:"tiles"});f.place(b.domNode,d);m(a,"show",c.hitch(this,function(){this._fetchItem(this._selectedService.id).then(c.hitch(this,function(a){this._selectedService=c.mixin(this._selectedService,a);b.set("item",this._selectedService)}),c.hitch(this,function(a){this._showError(a)}))}));m(b.domNode,"keyup",c.hitch(this,function(b){b.keyCode===B.ENTER&&(A.stop(b),a.doneFunction())}));a.doneFunction=c.hitch(this,
function(){this._disable(!0,u.publishTileServiceDlg.publishingTileService);b._validate().then(c.hitch(this,function(){b.publishTileService().then(c.hitch(this,function(a){this.onDone(a)}))}))});a.set("content",d);this._panes.push(a);return a},_setCalculatedScales:function(a,c,b){var e=b.lods,k=b.minLevel+2<e.length?b.minLevel+2:e.length-1;c.set("value",e[-1<b.maxLevel-2?b.maxLevel-2:0].level);a.set("value",e[k].level)},_layersPane:function(){var a=new t({canGoBack:!0}),d=document.createDocumentFragment(),
b;f.create("div",{innerHTML:this.i18n.details},d);f.create("br",{},d);var e=f.create("div",{"class":"layerDetails"},d),k=f.create("div",{"class":"grid layerGrid"},e);f.create("label",{innerHTML:this.i18n.layersLbl},k);var g=[z({field:"visible",autoSave:!0},"checkbox"),z({field:"name",editOn:"click",autoSave:!0},"text")];this._layerStore=new J(new I({data:[]}));this._layersGrid=new (x([G,H]))({selectionMode:"none",store:this._layerStore,showHeader:!1,pagingLinks:2,loadingMessage:this.i18n.loadingMessage,
columns:g},f.create("div",{},k));this._layersGrid.startup();f.create("br",{},e);m(a,"show",c.hitch(this,function(){b!==this._selectedService.svcUrl&&(b=this._selectedService.svcUrl,this._updateServiceDetails(b))}));a.passFunction=c.hitch(this,function(){return this._svcErr||!this._featureServiceJson?this._showError(this.i18n.errors.selectService):this._layerStore&&0>=this._layerStore.query({visible:!0}).length?this._showError(this.i18n.errors.selectLayers):!0});a.set("content",d);this._panes.push(a);
return a},_showLoadingMessage:function(a){a?(this._loadingNode=w(this._layersGrid.preload.node,"-div.dgrid-loading[style\x3dheight:20px]"),w(this._loadingNode,"div.dgrid-below").innerHTML=this._layersGrid.loadingMessage):w(this._loadingNode,"!")},_extentPane:function(){var a=new t({canGoBack:!0}),d=document.createDocumentFragment(),b=f.create("div",{"class":"extentDetails"},d);f.create("div",{innerHTML:this.i18n.extentDetails,"class":"extentDetails"},b);f.create("br",{},b);var e=f.create("div",{"class":"esriLeadingMargin15",
style:{width:"595px",height:"369px"}},b);f.create("br",{},b);b=f.create("fieldset",{},b);f.create("label",{"for":"extentLeft",innerHTML:this.i18n.extentLeftLbl},b);var k=new dijit.form.NumberTextBox({name:"extentLeft",trim:"true","class":"extent",constraints:{min:-180,max:180,pattern:"###.###"},invalidMessage:this.i18n.errors.errorLon,rangeMessage:this.i18n.errors.errorLon,required:!0,placeHolder:this.i18n.extentLeftPlaceHolder},f.create("input",{},b));f.create("label",{"for":"extentRight",innerHTML:this.i18n.extentRightLbl},
b);var g=new dijit.form.NumberTextBox({name:"extentRight",trim:"true","class":"extent",constraints:{min:-180,max:180,pattern:"###.###"},invalidMessage:this.i18n.errors.errorLon,rangeMessage:this.i18n.errors.errorLon,required:!0,placeHolder:this.i18n.extentRightPlaceHolder},f.create("input",{},b));f.create("br",{},b);f.create("label",{"for":"extentTop",innerHTML:this.i18n.extentTopLbl},b);var n=new dijit.form.NumberTextBox({name:"extentTop",trim:"true",constraints:{min:-90,max:90,pattern:"##.###"},
invalidMessage:this.i18n.errors.errorLat,rangeMessage:this.i18n.errors.errorLat,required:!0,"class":"extent",placeHolder:this.i18n.extentTopPlaceHolder},f.create("input",{},b));f.create("label",{"for":"extentBottom",innerHTML:this.i18n.extentBottomLbl},b);var h=new dijit.form.NumberTextBox({name:"extentBottom",trim:"true",constraints:{min:-90,max:90,pattern:"##.###"},invalidMessage:this.i18n.errors.errorLat,rangeMessage:this.i18n.errors.errorLat,required:!0,"class":"extent",placeHolder:this.i18n.extentBottomPlaceHolder},
f.create("input",{},b));a.passFunction=c.hitch(this,function(){var a=!1,a=q(".extent").map(dijit.byNode).every(function(a){return!isNaN(a.get("value"))&&a.isValid()});return!a?this._showError(this.i18n.errors.invalidExtent):a});m(a,"show",c.hitch(this,function(){if(!this.map){this.map=new T(e,{showAttribution:!1,extent:this._serviceExtent,wrapAround180:!0});this._connect(this.map,"extent-change",c.hitch(this,function(a){a=this.map.extent;4326!==a.spatialReference.wkid&&(a=this._fixExtent(a));this._serviceExtent=
this._clipExtent(a);k.set("value",this._serviceExtent.xmin,!1);h.set("value",this._serviceExtent.ymin,!1);g.set("value",this._serviceExtent.xmax,!1);n.set("value",this._serviceExtent.ymax,!1)}));var a=new S;a.format="png24";a=new R(esriGeowConfig.extentService,{imageParameters:a});this.map.addLayer(a);this._connect(a,"update",c.hitch(this,function(){this.map.reposition()}));a=function(a,b,c){isNaN(c)||!a.isValid()?a.set("value",this._serviceExtent[b]):this._serviceExtent[b]!==c&&(this._serviceExtent.update(k.get("value"),
h.get("value"),g.get("value"),n.get("value"),this._serviceExtent.spatialReference),this.map.setExtent(this._serviceExtent))};m(k,"change",c.hitch(this,a,k,"xmin"));m(h,"change",c.hitch(this,a,h,"ymin"));m(g,"change",c.hitch(this,a,g,"xmax"));m(n,"change",c.hitch(this,a,n,"ymax"));k.focus()}}));a.set("content",d);this._panes.push(a);return a},_itemDetailsPane:function(){var a=new t({canGoBack:!0}),d=document.createDocumentFragment(),b=new P({message:this.i18n.itemDetails,typeInfo:"featureserver",showFolders:!0,
showFile:!1,showUrl:!1,item:{}});f.place(b.domNode,d);m(b.domNode,"keyup",c.hitch(this,function(b){b.keyCode===B.ENTER&&(b.target&&!l.contains(b.target,"dijitTextArea"))&&(A.stop(b),a.doneFunction())}));m(a,"show",c.hitch(this,function(){var a=this._selectedService;b.set("summary",a.snippet||a.description||"");b.set("tags",a.tags);b.set("focus","title")}));a.doneFunction=c.hitch(this,function(){b._validate().then(c.hitch(this,function(a){var d=b.get("item");if(/(:|&|<|>|%|#|\?|\\|\"|\/|\+)/.test(d.title))return this._showError(this.i18n.errors.invalidCharactersService);
this._content={title:d.title,snippet:d.snippet,tags:d.tags,folder:d.folderId,extent:this._extent2String(this._serviceExtent||this._selectedService.extent),thumbnailURL:this._getThumbnailUrl(this._serviceExtent||this._selectedService.extent)};var g=this._selectedService.typeKeywords||[],n;h.forEach(["Singlelayer","Multilayer","Table"],c.hitch(this,function(a){n=h.indexOf(g,a);0<=n&&g.splice(n,1)}));this._selectedService.typeKeywords=g;this._userContentUrl=this._publishUrl+(this._content.folder&&"/"!==
this._content.folder?"/"+this._content.folder:"");if("features"===this.itemType){if(this._selectedService&&this._selectedService.typeKeywords&&(this._content.typeKeywords=this._selectedService.typeKeywords.join(","),-1!==h.indexOf(this._selectedService.typeKeywords,"Service Template")||-1!==h.indexOf(this._selectedService.typeKeywords,"Collector")))this._editingInfo=c.mixin(this._editingInfo,{capabilities:"Query,Editing,Create,Update,Delete,Sync",syncEnabled:!0});this._util.isPortal()&&this._isTemplateSelected&&
(this._content.typeKeywords+=",providerSDS")}this._disable(!0,"features"===this.itemType?this.i18n.pleaseWait:this.i18n.creatingTileLayer);this._serviceNameAvailable(d.title).then(c.hitch(this,function(){"features"===this.itemType?this._isTemplateSelected?this._publishService():this._getItemData(this._selectedService).then(c.hitch(this,"_publishService")):this._publishTileService(d)}))}),c.hitch(this,function(a){return this._showError(a)}))});a.set("content",d);this._panes.push(a);return a},_publishService:function(a){var d=
new esri.geometry.Extent(esri.geometry.geographicToWebMercator(this._serviceExtent).toJson()),b=this._featureServiceJson.service.editorTrackingInfo||{},e=this._userContentUrl,k=this._unique(this._editingInfo.capabilities.split(",").concat(this._featureServiceJson.service.capabilities.split(",")));this._featureServiceJson.service=c.mixin(this._featureServiceJson.service,c.mixin(this._editingInfo,{capabilities:k.join(",")}));-1!==h.indexOf(this._selectedService.typeKeywords,"Service Template")||-1!==
h.indexOf(this._selectedService.typeKeywords,"Collector")?c.mixin(this._featureServiceJson.service.editorTrackingInfo||{},{enableEditorTracking:!0,enableOwnershipAccessControl:!1,allowOthersToUpdate:!0,allowOthersToDelete:!0}):c.mixin(this._featureServiceJson.service.editorTrackingInfo||{},{allowOthersToDelete:esri._isDefined(b.allowOthersToDelete)?b.allowOthersToDelete:!0,allowOthersToUpdate:esri._isDefined(b.allowOthersToUpdate)?b.allowOthersToUpdate:!0});this._selectedLayerIds=[];this._layers=
h.map(this._layerStore.query({visible:!0}),c.hitch(this,function(a){var b=c.mixin({},a);this._selectedLayerIds.push(b.id);b=c.mixin(b,this._editingInfo);h.forEach(["_ssl","visible","__isDirty"],c.hitch(this,function(a){delete b[a]}));"Feature Layer"===b.type&&(b.extent=d.toJson(),b.name=this._layerStore.get(a.id).name,b.adminLayerInfo={geometryField:{name:"Shape",srid:d.spatialReference.wkid}});return b}));delete this._featureServiceJson.service.fullExtent;delete this._featureServiceJson.service.initialExtent;
delete this._featureServiceJson.service.spatialReference;if(a){if(a=this._fixLayerIds(a))this._content.text=s.stringify(a)}else this._layers=this._fixLayerIds({layers:this._layers}).layers;this._featureServiceJson.service=c.mixin(this._featureServiceJson.service,{name:this._content.title.replace(/ /g,"_")});delete this._featureServiceJson.service.layers;delete this._content.folder;this._disable(!0);this._createService(e+"/createService",{createParameters:s.stringify(this._featureServiceJson.service),
targetType:"featureService"}).then(c.hitch(this,function(a){this._disable(!1);this.onDone(this._service)}),c.hitch(this,function(a){this._deleteService();this._disable(!1);throw a;}))},_createService:function(a,d){var b=this._request(a,d,{usePost:!0});return b.then(c.hitch(this,function(a){this._service=c.mixin(a,{id:a.itemId});return this._addLayers(this._service)}),c.hitch(this,function(a){this._showError(a,b);throw a;}))},_addLayers:function(a){var d=a.encodedServiceURL.replace("rest/services",
"rest/admin/services"),b=this._layers,e,k=[],g;h.forEach(this._layers,c.hitch(this,function(a){a.relationships&&a.relationships.length&&(k.push({id:a.id,name:a.name,relationships:c.clone(a.relationships)}),delete a.relationships)}));e=h.filter(b,c.hitch(this,function(a){return a&&"Table"===a.type}));b=h.filter(b,c.hitch(this,function(a){return a&&"Feature Layer"===a.type}));return this._updateService(this._service,this._content).then(c.hitch(this,function(){return this._request(d+"/addToDefinition",
{addToDefinition:s.stringify({layers:b,tables:e})},{usePost:!0}).then(c.hitch(this,function(d){return this._enableEditorTracking(a).then(c.hitch(this,function(){g=h.map(k,c.hitch(this,function(b){return this._addRelationships(a,b)}));this._isTemplateSelected&&-1!==h.indexOf(this._selectedService.typeKeywords,"Location Tracking")&&(g=g.concat(h.map(b,c.hitch(this,function(b){return this._enableTime(a,b)}))));return y(g||[]).then(c.hitch(this,function(a){return d}))}))}),c.hitch(this,function(a){this._showError(a);
throw a;}))}))},_enableEditorTracking:function(a){var d=new r,b=a.encodedServiceURL.replace("rest/services","rest/admin/services"),e={editorTrackingInfo:{enableEditorTracking:!0}};this._isTemplateSelected?this._request(b+"/updateDefinition",{updateDefinition:s.stringify(e)},{usePost:!0}).then(c.hitch(this,function(a){d.resolve(a)}),c.hitch(this,function(a){this._showError(a);d.cancel()})):d.resolve(a);return d},_enableTime:function(a,d){var b=new r,e={timeInfo:{startTimeField:"CreationDate",endTimeField:"",
trackIdField:"",timeExtent:[],timeReference:{timeZone:"UTC",respectDaylightSaving:!1},timeInterval:0,timeIntervalUnits:"",exportOptions:{useTime:!1,timeDataCumulative:!1,TimeOffset:0,timeOffsetUnits:"esriTimeUnitsCenturies"},hasLiveData:!0}},k=a.encodedServiceURL.replace("rest/services","rest/admin/services");this._isTemplateSelected&&-1!==h.indexOf(this._selectedService.typeKeywords,"Location Tracking")?this._request(k+"/"+d.id+"/updateDefinition",{updateDefinition:s.stringify(e)},{usePost:!0}).then(c.hitch(this,
function(a){b.resolve(a)}),c.hitch(this,function(a){this._showError(a);b.cancel()})):b.resolve(a);return b},_addRelationships:function(a,d){var b=new r,e=a.encodedServiceURL.replace("rest/services","rest/admin/services"),k=d.relationships;k&&k.length?this._request(e+"/"+d.id+"/addToDefinition",{addToDefinition:s.stringify({relationships:d.relationships})},{usePost:!0}).then(c.hitch(this,function(a){b.resolve(a)}),c.hitch(this,function(a){this._showError(a);b.cancel()})):b.resolve(a);return b},_updateService:function(a,
d){var b=this._userContentUrl+"/items/"+a.id+"/update",e=new r;this._request(b,d,{usePost:!0}).then(c.hitch(this,function(a){e.resolve(a)}),c.hitch(this,function(a){this._showError(a);e.reject(a)}));return e},_deleteService:function(){var a=this._service&&this._service.itemId;if(a)return a=this._userContentUrl+"/items/"+a+"/delete",this._request(a,{},{usePost:!0})},_fetchItem:function(a){return this._request(esriGeowConfig.restBaseUrl+"content/items/"+a)},_serviceNameAvailable:function(a){a={name:a.replace(/ /g,
"_"),type:"features"!==this.itemType?"Map Service":"Feature Service"};return this._request(this._restBaseUrl+"portals/"+this._user.accountId+"/isServiceNameAvailable",a).then(c.hitch(this,function(a){if(a.available)return!0;this._showError(this.i18n.errors.serviceNameExists);throw!1;}))},_updateServiceDetails:function(a){this._layerStore.setData([]);this._layersGrid.refresh();this._showLoadingMessage(!0);a&&"1"!==a&&this._copyServiceSchema(a).then(c.hitch(this,function(a){this._showLoadingMessage(!1);
this._featureServiceJson=a;this._intialExtent=new esri.geometry.Extent(esriGeowConfig.self.defaultExtent||this._featureServiceJson.service.initialExtent);this._serviceExtent=this._fixExtent(this._intialExtent);this._disable(!1)}))},_fixExtent:function(a){a=V.webMercatorToGeographic(new U(a));var c=a.spatialReference._getInfo();if(c&&a.xmin>a.xmax){var b=c.valid[1]-a.xmin,e=a.xmax-c.valid[0];b>e?a.xmax=c.valid[1]+e:a.xmin=c.valid[0]-b}return this._clipExtent(a)},_copyServiceSchema:function(a){var d=
new r,b={},e={addToken:!1};!this._util.isHostedService(a)&&!this._util.isAgolService(a)&&(e.addSSL=!1,e.addToken=!1);q(".dijitButton",this.domNode).map(dijit.byNode).forEach(function(a){a.set("disabled",!0)});this._svcErr=!0;this._request(a,{},c.mixin({timeout:6E4},e)).then(c.hitch(this,function(d){if(!d)return this._showError({message:esri.substitute({url:a},this.i18n.errors.serviceNotExist.message)});this._svcErr=null;b.service=d;delete d.id;this._selectedService=c.mixin(this._selectedService,d);
d=h.map(d.layers.concat(d.tables||[]),c.hitch(this,function(b){var c;b&&b.fields?(c=new r,c.resolve(b)):c=this._request(a+"/"+b.id,{},e);return c}));return y(d).then(c.hitch(this,function(a){this._layerStore.setData([]);b.layers=h.map(a,c.hitch(this,function(a){this._layerStore.add(c.mixin(c.mixin({},a),{visible:!0}));return a}))}))}),c.hitch(this,function(b){this._svcErr={id:a,error:b};this._showLoadingMessage(!1);this._showError({message:esri.substitute({url:a},this.i18n.errors.serviceNotExist.message)});
throw b;})).then(c.hitch(this,function(){d.resolve(b)}));return d},_getThumbnailUrl:function(a){return"http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/export?size\x3d200,133\x26bboxSR\x3d4326\x26format\x3dpng24\x26f\x3dimage\x26bbox\x3d"+a.xmin+","+a.ymin+","+a.xmax+","+a.ymax},_getItemData:function(a){var c=this._contentUrl+"/items/"+a.id+"/data";!a||!a.id?(a=new r,a.resolve(null)):a=this._request(c);return a},_fixLayerIds:function(a){var d={},b=a.layers&&a.layers.length?
a.layers.sort(function(a,b){return parseInt(a.id,10)-parseInt(b.id,10)}):[],e=this._selectedLayerIds,b=h.map(h.filter(b,function(a){return 0<=h.indexOf(e,a.id)}),function(a,b){d[a.id]=b;a.id=b;return a});return this._fixRelationshipIds(c.mixin(a,{layers:b}),d)},_fixRelationshipIds:function(a,d){h.forEach(a.layers||[],c.hitch(this,function(a){a.relationships=h.filter(a.relationships||[],c.hitch(this,function(a){return-1<h.indexOf(this._selectedLayerIds,a.relatedTableId)?(a.relatedTableId=esri.isDefined(d[a.relatedTableId])?
d[a.relatedTableId]:a.relatedTableId,!0):!1}))}));return a},_disable:function(a,c){q(".dijit, .dijitTextArea, .dojoxGrid",this.domNode).map(dijit.byNode).forEach(function(b){b.set("disabled",a)});q("a",this.domNode)[a?"addClass":"removeClass"]("disabledLink");q("label",this.domNode)[a?"addClass":"removeClass"]("disabled");a&&c&&E.set(this._spinner,"innerHTML",c);D.set(this._spinner,"display",a?"inline-block":"none")},_unique:function(a){var c={};return h.filter(a,function(a){return c[a]?!1:c[a]=!0})},
_isEmpty:function(a){return(this.trim?/^\s*$/:/^$/).test(a)},_clipExtent:function(a){a.ymax=85<a.ymax?85:p.round(a.ymax,3);a.ymin=-85>a.ymin?-85:p.round(a.ymin,3);a.xmax=180<a.xmax?180:p.round(a.xmax,3);a.xmin=-180>a.xmin?-180:p.round(a.xmin,3);return a},_checkStatus:function(a,d,b){a?this._request(this._userContentUrl+"/items/"+a.id+"/status",{jobId:a.jobId}).then(c.hitch(this,function(e){e=e||{status:"failed"};if("completed"===e.status)return d.resolve(a);if("failed"===e.status||""===e.status)return d.reject({message:e.statusMessage});
b=(b||500)+250;setTimeout(c.hitch(this,function(){this._checkStatus(a,d,b)}),b)}),c.hitch(this,function(a){d.reject(a)})):d.reject()},_request:function(a,c,b){return this._util.request({url:a,content:c},b)},_extent2String:function(a,c){c=c||4;var b="";if(a&&this._isValidNum(a.xmin)&&this._isValidNum(a.ymin)&&this._isValidNum(a.xmax)&&this._isValidNum(a.ymax))var b=p.round(a.xmin,c),e=p.round(a.ymin,c),f=p.round(a.xmax,c),g=p.round(a.ymax,c),b=!isNaN(b)&&!isNaN(e)&&!isNaN(f)&&!isNaN(g)?b+","+e+","+
f+","+g:"";return b},_isValidNum:function(a){return!isNaN(a)&&void 0!==a&&null!==a},_connect:function(a,d,b){a=m(a,d,c.hitch(this,b));this._connects.push(a);return a},_showError:function(a,d){if(!d||!d.canceled){a&&!a.message&&(a=this.i18n.errors.error);a=a&&a.error||a||this.i18n.errors.error;a.code=a.code||0;a=this.i18n.errors[a.code]||a;a.details=a.details&&a.details.length?h.filter(a.details,"return item !\x3d\x3d null"):null;a.details&&a.details.length&&(a.details=a.details.join("\x3cbr /\x3e"),
a.message=a.message?a.message+"\x3cbr /\x3e"+a.details:a.details);var b=c.mixin(c.mixin({},this.i18n.errors.error),a);this._errorDlg.show(b)}this._disable(!1);return!1}})});