// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/featColl",["dijit","dojo","dojox","dojo/require!arcgisonline/map/main"],function(q,d,r){d.provide("arcgisonline.map.featColl");d.require("arcgisonline.map.main");arcgisonline.map.featColl={addFeatureLayers:function(a,b,c){if(a.itemId&&(!a.featureCollection||!a.featureCollection.layers||!a.featureCollection.layers[0].featureSet))arcgisonline.map.featColl.mergeFeatureCollectionItem(a,b,c,d.hitch(arcgisonline.map.featColl,"addFeatureLayers"));else{d.forEach(a.featureCollection.layers,
function(a){a.layerDefinition.capabilities||(a.layerDefinition.capabilities="Query")});var f=Math.floor(10001*Math.random()),e={layer:null,id:a.id?a.id:"featColl_"+f,type:"user",title:b?b:a.title,defaultVisibility:null!=a.visibility?a.visibility:!0,defaultOpacity:null!=a.opacity?a.opacity:1,snippet:"",visibility:null!=a.visibility?a.visibility:!0,identify:!1};a.featureCollection&&!0!==a.featureCollection.showLegend&&(e.showLegend=!1);!a.featureCollection&&!1===a.showLegend&&(e.showLegend=!1);if(a.itemId||
c&&c.itemId)e.itemId=a.itemId||c.itemId;a.url&&(e.url=a.url);if(a.itemCard||c&&c.itemCard)e.itemCard=a.itemCard||c.itemCard;a.locationInfo&&(e.locationInfo=a.locationInfo);a.columnDelimiter&&(e.columnDelimiter=a.columnDelimiter);esri.isDefined(a.visibleLayers)&&(e.visibleLayers=a.visibleLayers.toString(),0<a.visibleLayers.length&&isNaN(a.visibleLayers[0])&&(visibleLayers=d.map(a.visibleLayers,function(a){return a.substring(a.lastIndexOf("_")+1)}),e.visibleLayers=visibleLayers.toString()));arcgisonline.map.mapNotes.isMapNotesLayer(a)&&
(e.fieldInfos=arcgisonline.map.mapNotes.getFieldInfos(),e.type="mapNotes");c&&(e=d.mixin(e,c));var g=!1;d.forEach(a.featureCollection.layers,function(a){if(!a.layerDefinition||"Table"!==a.layerDefinition.type)g=!0});g?(c=arcgisonline.map.layer.getLayerPosition(e),arcgisonline.map.main.mapLayers.splice(c.list,0,e),arcgisonline.map.featColl.addFeatureLayersfromCollection(e,a.featureCollection,b,c.map)):(arcgisonline.map.featColl.addFeatureLayersfromCollection(e,a.featureCollection,b,0),arcgisonline.map.main.mapTables=
arcgisonline.map.main.mapTables||[],d.forEach(e.tables,function(b,c){var f={layer:b,id:b.id,title:e.title+" - "+b.name,featureCollection:a.featureCollection};e.itemId&&(f.itemId=e.itemId,f.itemCard=e.itemCard);esri.isDefined(e.popupChanged)&&(f.popupChanged=e.popupChanged);arcgisonline.map.main.mapTables.push(f);d.publish("layerAdded",[e.id])}),d.publish("onLayerUpdate",[""]));return e}},addFeatureLayersfromCollection:function(a,b,c,f){var e=0,g=0,h=[],m=[];d.forEach(b.layers,function(a){a.layerDefinition&&
"Table"===a.layerDefinition.type?(g++,m.push(a)):(e++,h.push(a))});if(1<e+g){a.layers=[];var k=h.concat(m);b.layers=k}for(k=0;k<b.layers.length;k++){var l=b.layers[k],n=a.id+(1<b.layers.length?"_"+k:"");if(l.layerDefinition&&"Table"===l.layerDefinition.type){var p=new esri.layers.FeatureLayer(d.json.parse(d.json.stringify(l)),{id:n,outFields:["*"]});p.name=l.layerDefinition.name;l.popupInfo&&(p.__popupInfo=l.popupInfo,p.setInfoTemplate(new esri.dijit.PopupTemplate(l.popupInfo)));a.tables=a.tables||
[];a.tables.push(p)}else l.layerDefinition.name||(l.layerDefinition.name=a.title),p=null,!1===l.showLegend&&(p=!1),delete l.showLegend,n=arcgisonline.map.featColl.addFeatureLayer(l,a.defaultVisibility,a.defaultOpacity,n),!1===p&&(n.__showLegend=!1),a.layers?((""==a.visibleLayers||a.visibleLayers&&-1==(","+a.visibleLayers+",").indexOf(","+k+","))&&n.hide(),a.layers.push(n)):(a.layer=n,l.popupInfo&&(a.popupInfo=l.popupInfo))}if(!a.itemId&&c&&0<c.length&&(a.layer&&a.layer.isEditable()||a.layers&&a.layers[0].isEditable()))"editStack"===
arcgisonline.map.leftPanel.getLeftContentPanelStack()?setTimeout(function(){q.byId("editPanel").recreateEditor()},0):(arcgisonline.map.leftPanel.openLeftEditPanel(),arcgisonline.map.edit.enableEditButton());a.layers?d.forEach(a.layers,function(a,b){arcgisonline.map.main.map.addLayer(a,f+b)}):arcgisonline.map.main.map.addLayer(a.layer,f);d.publish("layerAdded",[a.id])},addFeatureLayer:function(a,b,c,f){var e=null;a.popupInfo&&(e=new esri.dijit.PopupTemplate(a.popupInfo));arcgisonline.map.main.checkUnsupportedRendererType(a);
b=new esri.layers.FeatureLayer(d.json.parse(d.json.stringify(a)),{id:f,infoTemplate:e,outFields:["*"],visible:b,opacity:c,displayOnPan:9>d.isIE?!1:!0});b.labelingInfo&&arcgisonline.map.labels.addLabelsForLayer(b);a.popupInfo&&(b.__popupInfo=a.popupInfo);return b},addFeatureCollectionByUrl:function(a){var b=arcgisonline.sharing.util.urlToObject(document.URL),c=b.query&&b.query.supportsProjection,f=a,e=null;"true"==(b.query&&b.query.supportsJSONP)?e="callback":f=(0===a.indexOf("https://")?esri.config.defaults.io.proxyUrl.replace("http:",
"https:"):esri.config.defaults.io.proxyUrl)+"?"+a;"true"==c&&(b=arcgisonline.map.main.map&&arcgisonline.map.main.map.spatialReference?arcgisonline.map.main.map.spatialReference:arcgisonline.map.main.defaultExtent.spatialReference,f+=(-1<a.indexOf("?")?"\x26":"?")+"outsr\x3d"+(b.wkid?b.wkid:b.wkt));var g=a.substring(a.lastIndexOf("/")+1,a.length);-1<g.indexOf("?")&&(g=g.substring(0,g.indexOf("?")));-1<a.indexOf("option\x3dfootprints")&&(-1<a.indexOf("/rest/services?")?(g=a.substring(a.indexOf("://")+
3,a.length),g=g.substring(0,g.indexOf("/"))+" - "+esri.i18nBundle.viewer.featColl.footprints):-1<a.indexOf("/rest/services/")&&(-1<a.indexOf("Server?")?(g=a.substring(0,a.indexOf("Server?")),g=g.substring(0,g.lastIndexOf("/")),g=g.substring(g.lastIndexOf("/")+1,g.length)):(g=a.substring(a.indexOf("/rest/services/")+15,a.indexOf("?")),-1<g.indexOf("/")&&(g=g.substring(g.lastIndexOf("/")+1,g.length))),g+=" - "+esri.i18nBundle.viewer.featColl.footprints));esri.request({url:f,callbackParamName:e,load:function(b){if(b.layerDefinition)b.layerDefinition.name&&
(g=b.layerDefinition.name),arcgisonline.map.featColl.checkLayerDefinitionSR(b,g,a);else if(b.featureCollection)1==b.featureCollection.layers.length&&b.featureCollection.layers[0].layerDefinition.name&&(g=b.featureCollection.layers[0].layerDefinition.name),arcgisonline.map.featColl.checkFeatureCollectionSR(b.featureCollection,g,d.hitch(arcgisonline.map.featColl,"addAndZoom",g,a));else{b=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();var c=d.string.substitute(esri.i18nBundle.viewer.featColl.featureCollectionNoLayers,
{url:a});b.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:c})}},error:function(b){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:d.string.substitute(esri.i18nBundle.viewer.featColl.featureCollectionNotAccessible,{url:a})})}},{usePost:!1})},addFeatureCollectionItem:function(a){var b=function(a,b){console.log(a);d.publish("ServiceAnswerReceived",[]);d.publish("layerAddFailed",[]);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:esri.i18nBundle.viewer.error.layerFailedToLoad})};arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+a.id+"/data",d.hitch(this,function(c,f){d.publish("ServiceAnswerReceived",[]);(!c.featureCollection||!c.featureCollection.layers)&&!c.layers&&b(c,f);c.layers&&(c.featureCollection={layers:c.layers},delete c.layers,esri.isDefined(c.showLegend)&&(c.featureCollection.showLegend=c.showLegend,delete c.showLegend));arcgisonline.map.featColl.loadFeatCollFromItemData(c||
{},a,d.hitch(this,function(){null!=arcgisonline.map.save_open.itemCard&&null!=a&&arcgisonline.map.save_open.itemCard.id===a.id?(null===arcgisonline.map.save_open.webMapInfo&&arcgisonline.map.main.setTitle(a.title),arcgisonline.map.leftPanel.recreateAboutStack(),arcgisonline.map.leftPanel.openLeftTOCPanel()):null===arcgisonline.map.save_open.webMapInfo&&null===arcgisonline.map.save_open.itemCard&&arcgisonline.map.main.setTitle(esri.i18nBundle.viewer.defaultMapTitle)}))}),d.hitch(this,b))},loadFeatCollFromItemData:function(a,
b,c){arcgisonline.map.featColl.checkFeatureCollectionSR(a.featureCollection,b.title,function(f){arcgisonline.map.save_open.itemCard&&arcgisonline.map.save_open.itemCard.id===b.id?(arcgisonline.map.main.setTitle(b.title),arcgisonline.map.leftPanel.recreateAboutStack()):null===arcgisonline.map.save_open.webMapInfo&&arcgisonline.map.main.setTitle(esri.i18nBundle.viewer.defaultMapTitle);arcgisonline.map.featColl.fixCapabilities(a.featureCollection,b);f=arcgisonline.map.featColl.addFeatureLayers(a,b.title,
{itemId:b.id,itemCard:b});f.itemCard=b;f.origItemDataProps=d.clone(a);d.forEach(f.origItemDataProps.featureCollection.layers,function(a){delete a.featureSet;delete a.nextObjectId});c()})},addFeatCollByReferenceLayerFromJson:function(a){a&&arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+a.itemId,d.hitch(this,function(a,c){arcgisonline.map.featColl.addFeatureLayers(a,null,{itemId:a.itemId,itemCard:c})},a),d.hitch(this,function(a,c){console.log(a);d.publish("layerAddFailed",
[]);setTimeout(function(){arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.layerFailedToLoad})},5E3)}))},mergeFeatureCollectionItem:function(a,b,c,f){!arcgisonline.sharing.util.getUser()||a.itemCard?arcgisonline.map.featColl.mergeFeatureCollectionItem_part2(a,b,c,f):arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+a.itemId,d.hitch(this,function(e){a.itemCard=
e;arcgisonline.map.featColl.mergeFeatureCollectionItem_part2(a,b,c,f)}),d.hitch(this,function(e,d){console.log(e);a.itemCard={owner:null};arcgisonline.map.featColl.mergeFeatureCollectionItem_part2(a,b,c,f)}))},mergeFeatureCollectionItem_part2:function(a,b,c,f){var e=function(a,b){console.log(a);d.publish("layerAddFailed",[]);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.layerFailedToLoad})};
arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+a.itemId+"/data",d.hitch(this,function(c,h,m){if(!h.featureCollection&&!h.layers)e(h,m);else{h.layers&&(h.featureCollection={layers:h.layers},delete h.layers,esri.isDefined(h.showLegend)&&(h.featureCollection.showLegend=h.showLegend,delete h.showLegend));var k=d.filter(h.featureCollection.layers,function(a){return a.layerDefinition&&"Table"===a.layerDefinition.type?!1:!0}),l=d.filter(h.featureCollection.layers,function(a){return a.layerDefinition&&
"Table"===a.layerDefinition.type?!0:!1});h.featureCollection.layers=k.concat(l);a.featureCollection&&a.featureCollection.layers&&h.featureCollection.layers.length!==a.featureCollection.layers.length?e({msg:(b||a.title)+": FeatureCollection layer in web map has less layers than on item."},m):arcgisonline.map.featColl.checkFeatureCollectionSR(h.featureCollection,b||a.title,d.hitch(this,function(c,e){c=c||{};c.origItemData=d.clone(h);esri.isDefined(a.visibleLayers)?c.visibleLayersChanged=!0:h.visibleLayers&&
(a.visibleLayers=h.visibleLayers.toString());h.featureCollection=e;a.featureCollection&&a.featureCollection.layers?(0<k.length&&a.featureCollection.showLegend!==h.featureCollection.showLegend&&(c.legendChanged=!0),d.forEach(h.featureCollection.layers,function(b,f){var e=a.featureCollection.layers[f];if(e.popupInfo&&!b.popupInfo||!e.popupInfo&&b.popupInfo||e.popupInfo&&b.popupInfo&&d.json.stringify(e.popupInfo)!==d.json.stringify(b.popupInfo))c.popupChanged=!0;if(e.layerDefinition){if(e.layerDefinition.minScale!==
b.layerDefinition.minScale||e.layerDefinition.maxScale!==b.layerDefinition.maxScale)c.scaleChanged=!0;delete b.layerDefinition.minScale;delete b.layerDefinition.maxScale;e.layerDefinition.drawingInfo&&d.json.stringify(e.layerDefinition.drawingInfo)!==d.json.stringify(b.layerDefinition.drawingInfo)&&(c.rendererChanged=!0,delete b.layerDefinition.drawingInfo);e.layerDefinition.showLegend!==b.layerDefinition.showLegend&&(c.legendChanged=!0,delete b.layerDefinition.showLegend);e.layerDefinition=d.mixin(e.layerDefinition,
b.layerDefinition)}else e.layerDefinition=b.layerDefinition;e.featureSet=b.featureSet;e.nextObjectId=b.nextObjectId})):(a.featureCollection=a.featureCollection||{},a.featureCollection=d.mixin(a.featureCollection,h.featureCollection));arcgisonline.map.featColl.fixCapabilities(a.featureCollection,a.itemCard);f(a,b,c)},c))}},c||{}),d.hitch(this,e))},fixCapabilities:function(a,b){var c=arcgisonline.sharing.util.getUser(),f=!1;c&&b.owner===c.email&&(f=!0);d.forEach(a.layers,function(a){if(f){if(!a.layerDefinition.capabilities&&
(a.layerDefinition.capabilities="Query",!a.featureSet||!a.featureSet.features||!a.featureSet.features.length))a.layerDefinition.capabilities="Query, Editing"}else if(a.layerDefinition.capabilities){var b=a.layerDefinition.capabilities.split(","),c=[];d.forEach(b,function(a){var b=a.toLowerCase();"editing"!==b&&("create"!==b&&"update"!==b&&"delete"!==b)&&c.push(a)});a.layerDefinition.capabilities=c.toString()}else a.layerDefinition.capabilities="Query"})},checkFeatureCollectionSR:function(a,b,c){for(var f=
!1,e=[],g=0;g<a.layers.length;g++){var h=a.layers[g];if(h.layerDefinition&&"Table"===h.layerDefinition.type)f=!0;else{var m=arcgisonline.map.featColl.getSR(h);m&&e.push(function(){var b=new d.Deferred;arcgisonline.map.featColl.projectFeatureSet(h,m,d.hitch(this,function(a,c,f){c.layers[a]=f;b.callback()},g,a));return b}())}}e.length?(new d.DeferredList(e)).addCallback(function(){if(arcgisonline.map.main.map.extent&&isNaN(arcgisonline.map.main.map.extent.xmin)){arcgisonline.map.main.map.setExtent(arcgisonline.map.main.defaultExtent);
var b=d.connect(arcgisonline.map.main.map,"onExtentChange",d.hitch(this,function(){d.disconnect(b);c(a)}))}else c(a)}):(e=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),a.layers.length?f?c(a):(b=d.string.substitute(esri.i18nBundle.viewer.featColl.featureCollectionNoSR,{url:b}),e.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:b})):(b=d.string.substitute(esri.i18nBundle.viewer.featColl.featureCollectionNoLayers,{url:b}),e.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:b})))},addAndZoom:function(a,b,c){a=arcgisonline.map.featColl.addFeatureLayers({featureCollection:c},a);a.layer?-1<b.indexOf("option\x3dfootprints")&&-1<b.indexOf("/rest/services")&&(a.layer.__isFootprintLayer=!0):d.forEach(a.layers,function(a){-1<b.indexOf("option\x3dfootprints")&&-1<b.indexOf("/rest/services")&&(a.__isFootprintLayer=!0)});var f=null;d.forEach(c.layers,function(a){a.layerDefinition.extent&&(f=f?f.union(new esri.geometry.Extent(a.layerDefinition.extent)):new esri.geometry.Extent(a.layerDefinition.extent))},
this);f?arcgisonline.map.main.projectToMapSpatialReference(f,function(a){arcgisonline.map.main.map.setExtent(a[0],!0)}):(f=arcgisonline.map.featColl.getFullExtent(a))&&arcgisonline.map.main.map.setExtent(f,!0)},checkLayerDefinitionSR:function(a,b,c){var f=arcgisonline.map.featColl.getSR(a);f?arcgisonline.map.featColl.projectFeatureSet(a,f,d.hitch(this,function(a){if(arcgisonline.map.main.map.extent&&isNaN(arcgisonline.map.main.map.extent.xmin)){arcgisonline.map.main.map.setExtent(arcgisonline.map.main.defaultExtent);
var f=d.connect(arcgisonline.map.main.map,"onExtentChange",d.hitch(this,function(){d.disconnect(f);arcgisonline.map.featColl.addAndLayerDefZoom(a,b,c)}))}else arcgisonline.map.featColl.addAndLayerDefZoom(a,b,c)})):(a=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),f=d.string.substitute(esri.i18nBundle.viewer.featColl.featureCollectionNoSR,{url:c}),a.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:f}))},addAndLayerDefZoom:function(a,b,c){a.layerDefinition.capabilities||
(a.layerDefinition.capabilities="Query");var f={layer:null,id:"featColl_"+Math.floor(10001*Math.random()),type:"user",title:b?b:a.name,defaultVisibility:!0,defaultOpacity:1,snippet:"",visibility:!0,identify:!1},d=arcgisonline.map.layer.getLayerPosition(f);arcgisonline.map.main.mapLayers.splice(d.list,0,f);d=d.map;-1<c.indexOf("option\x3dfootprints")&&-1<c.indexOf("/rest/services")&&(f.layer.__isFootprintLayer=!0);a.layerDefinition.name||(a.layerDefinition.name=f.title);c=arcgisonline.map.featColl.addFeatureLayer(a,
f.defaultVisibility,f.defaultOpacity,f.id);f.layer=c;a.popupInfo&&(f.popupInfo=a.popupInfo);!f.itemId&&(b&&0<b.length&&f.layer&&f.layer.isEditable())&&("editStack"===arcgisonline.map.leftPanel.getLeftContentPanelStack()?setTimeout(function(){q.byId("editPanel").recreateEditor()},0):(arcgisonline.map.leftPanel.openLeftEditPanel(),arcgisonline.map.edit.enableEditButton()));arcgisonline.map.main.map.addLayer(f.layer,d);b=null;a.layerDefinition.extent&&(b=b?b.union(new esri.geometry.Extent(a.layerDefinition.extent)):
new esri.geometry.Extent(a.layerDefinition.extent));b&&arcgisonline.map.main.projectToMapSpatialReference(b,function(a){arcgisonline.map.main.map.setExtent(a[0],!0)})},generateDefaultPopupInfo:function(a){var b={esriFieldTypeDouble:1,esriFieldTypeSingle:1},c={esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1},f={esriFieldTypeDate:1},e=null;a=d.map(a.layerDefinition.fields,d.hitch(this,function(a){"NAME"===a.name.toUpperCase()&&(e=a.name);var h="esriFieldTypeOID"!==a.type&&"esriFieldTypeGlobalID"!==
a.type&&"esriFieldTypeGeometry"!==a.type,m=null;if(h){var k=a.name.toLowerCase();if(-1<",stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,".indexOf(","+k+",")||-1<k.indexOf("shape")||-1<k.indexOf("perimeter")||-1<k.indexOf("objectid")||k.indexOf("_")==k.length-1||k.indexOf("_i")==k.length-2&&1<k.length)h=!1;a.type in c?m={places:0,digitSeparator:!0}:a.type in b?m={places:2,digitSeparator:!0}:a.type in f&&(m={dateFormat:"longMonthDayYear"})}return d.mixin({},
{fieldName:a.name,label:a.alias,isEditable:esri.isDefined(a.editable)?a.editable:!0,tooltip:"",visible:esri.isDefined(a.visible)?a.visible:h,format:m,stringFieldOption:"textbox"})}));return{title:e?"{"+e+"}":"",fieldInfos:a,description:null,showAttachments:!1,mediaInfos:[]}},buildInfoTemplate:function(a){var b={content:"\x3ctable\x3e",title:a.title.replace("{","${")};d.forEach(a.fieldInfos,function(c){-1===a.title.indexOf("{"+c.fieldName+"}")&&c.visible&&(b.content+="\x3ctr\x3e\x3ctd valign\x3d'top'\x3e"+
c.label+": \x3c/td\x3e\x3ctd valign\x3d'top'\x3e${"+c.fieldName+"}\x3c/td\x3e\x3c/tr\x3e")});b.content+="\x3c/table\x3e";return b},getFullExtent:function(a){var b=null;a.layer?b=arcgisonline.map.featColl.getLayerFullExtent(a.layer):d.forEach(a.layers,function(a){(a=arcgisonline.map.featColl.getLayerFullExtent(a))&&(b=!b?a:b.union(a))},this);return b},getLayerFullExtent:function(a){var b=null;d.forEach(a.graphics,function(a,f){var d=arcgisonline.map.featColl.getExtent(a.geometry);d&&(b=b?b.union(d):
d)},this);return b},getExtent:function(a){if(!a)return null;var b=null;if("esri.geometry.Extent"==a.declaredClass)b=a;else if("esri.geometry.Point"==a.declaredClass)b=new esri.geometry.Extent(a.x-1E-4,a.y-1E-4,a.x+1E-4,a.y+1E-4,a.spatialReference);else if(b=a.getExtent())b.spatialReference=new esri.SpatialReference(a.spatialReference.toJson());return b},getFeatureSetFullExtent:function(a,b){var c=null;if(a&&"esriGeometryPoint"===a.geometryType&&a.features&&1===a.features.length&&b&&b.layerDefinition&&
b.layerDefinition.extent)return b.layerDefinition.extent;d.forEach(a.features,function(b){if(b.geometry){var e=esri.geometry.getGeometryType(a.geometryType),g=b.geometry.spatialReference||a.spatialReference;b=new e(d.mixin(b.geometry,{spatialReference:{wkid:g.wkid,latestWkid:g.latestWkid,wkt:g.wkt}}));(b="esri.geometry.Extent"==b.declaredClass?b:"esri.geometry.Point"==b.declaredClass?new esri.geometry.Extent(b.x-1E-4,b.y-1E-4,b.x+1E-4,b.y+1E-4,b.spatialReference):b.getExtent())&&(c=c?c.union(b):b)}},
this);return c},projectFeatureSet:function(a,b,c){if(!a.featureSet||!a.featureSet.features||0===a.featureSet.features.length)c(a);else if(newSpatialReference=arcgisonline.map.main.map.spatialReference,arcgisonline.map.main.sameSpatialReference(newSpatialReference,b))a.layerDefinition.extent=arcgisonline.map.featColl.getFeatureSetFullExtent(a.featureSet,a),c(a);else{var f=function(b){d.forEach(a.featureSet.features,function(a,c){b[c]&&(a.geometry=b[c])},this);a.layerDefinition.extent=arcgisonline.map.featColl.getFeatureSetFullExtent(a.featureSet,
a);c(a)},e=function(c,e){console.log("error projecting featureSet ("+a.layerDefinition.name+"). Try one more time.");arcgisonline.map.main.projectJsonGeometries(h,a.featureSet.geometryType,b,newSpatialReference,d.hitch(this,f),d.hitch(this,g))},g=function(b,d){console.log("error projecting featureSet ("+a.layerDefinition.name+"). Final try.");c(a)};if(a.featureSet.features&&0<a.featureSet.features.length){var h=[];d.forEach(a.featureSet.features,function(a){h.push(a.geometry)});arcgisonline.map.main.projectJsonGeometries(h,
a.featureSet.geometryType,b,newSpatialReference,d.hitch(this,f),d.hitch(this,e))}else c(a)}},roundFeatureSetCoordinates:function(a){d.forEach(a.featureSet.features,function(a){a=a.geometry;a.xmin?(a.xmin=Math.round(a.xmin),a.xmax=Math.round(a.xmax),a.ymin=Math.round(a.ymin),a.ymax=Math.round(a.ymax)):a.rings?d.forEach(a.rings,function(a){d.forEach(a,function(a){a[0]=Math.round(a[0]);a[1]=Math.round(a[1])},this)},this):a.paths?d.forEach(a.paths,function(a){d.forEach(a,function(a){a[0]=Math.round(a[0]);
a[1]=Math.round(a[1])},this)},this):a.x&&(a.x=Math.round(a.x),a.y=Math.round(a.y))});a.layerDefinition.extent&&(a.layerDefinition.extent.xmax=Math.round(a.layerDefinition.extent.xmax),a.layerDefinition.extent.xmin=Math.round(a.layerDefinition.extent.xmin),a.layerDefinition.extent.ymax=Math.round(a.layerDefinition.extent.ymax),a.layerDefinition.extent.ymin=Math.round(a.layerDefinition.extent.ymin))},isFeatureCollection:function(a){return a.layer?arcgisonline.map.featColl.isFeatureCollectionLayer(a.layer):
a.layers||a.tables?!0:!1},isFeatureCollectionLayer:function(a){return"esri.layers.FeatureLayer"==a.declaredClass&&!a.url?!0:!1},getSR:function(a){var b=null;if(a.featureSet&&a.featureSet.features&&a.featureSet.features.length&&a.featureSet.features[0].geometry&&a.featureSet.features[0].geometry.spatialReference)b=new esri.SpatialReference(a.featureSet.features[0].geometry.spatialReference);else if(a.featureSet&&a.featureSet.spatialReference)b=new esri.SpatialReference(a.featureSet.spatialReference);
else if(a.layerDefinition&&a.layerDefinition.extent&&a.layerDefinition.extent.spatialReference)b=new esri.SpatialReference(a.layerDefinition.extent.spatialReference);else if((!a.featureSet||!a.featureSet.features||!a.featureSet.features.length)&&(!a.layerDefinition||!a.layerDefinition.extent||!a.layerDefinition.extent.spatialReference))b=new esri.SpatialReference({wkid:4326});return b},buildConfig:function(a){var b={layerType:"ArcGISFeatureLayer"};a.id&&"undefined"!==a.id&&(b.id=a.id);b.title=a.title;
b.featureCollection=arcgisonline.map.featColl.buildFeatureCollectionJson(a);if(a.layers)if(b.opacity=a.layers[0].opacity||0===a.layers[0].opacity?a.layers[0].opacity:1,b.visibility=!1==a.visibility?!1:!0,""==a.visibleLayers)b.visibleLayers=[];else{if(esri.isDefined(a.visibleLayers)&&(!a.itemId||a.itemId&&a.visibleLayersChanged))b.visibleLayers=d.map(a.visibleLayers.split(","),function(a){return parseInt(a)})}else b.visibility=a.layer.visible,b.opacity=a.layer.opacity||0===a.layer.opacity?a.layer.opacity:
1;a.url&&(b.type="CSV",b.layerType="CSV",b.url=a.url,b.layerDefinition=b.featureCollection.layers[0].layerDefinition,b.popupInfo=b.featureCollection.layers[0].popupInfo,b.locationInfo=a.locationInfo?a.locationInfo:null,b.columnDelimiter=a.columnDelimiter?a.columnDelimiter:",",delete b.featureCollection,!1===a.showLegend&&(b.showLegend=!1));a.itemId&&(b.type="Feature Collection",b.layerType="ArcGISFeatureLayer",b.itemId=a.itemId,b.featureCollection.showLegend=!1===a.showLegend?!1:!0,!a.popupChanged&&
!a.scaleChanged&&!a.rendererChanged&&!a.legendChanged?delete b.featureCollection:d.forEach(b.featureCollection.layers,function(a){delete a.featureSet;delete a.nextObjectId;if("Table"===a.layerDefinition.type)delete a.layerDefinition;else{var b={drawingInfo:a.layerDefinition.drawingInfo};esri.isDefined(a.layerDefinition.minScale)&&(b.minScale=a.layerDefinition.minScale);esri.isDefined(a.layerDefinition.maxScale)&&(b.maxScale=a.layerDefinition.maxScale);!1===a.layerDefinition.showLegend&&(b.showLegend=
!1);a.layerDefinition=b}}),d.json.stringify(a.origItemDataProps)===d.json.stringify({featureCollection:b.featureCollection})&&delete b.featureCollection);a.disablePopup&&a.itemId&&(b.disablePopup=!0);return b},buildFeatureCollectionJson:function(a){var b=!1;if("mapNotes"==a.type){var c=[102113,102100,3857],f=arcgisonline.map.main.map.spatialReference.wkid;esri.isDefined(f)&&arcgisonline.map.main.contains(c,f)&&(b=!0)}c=a.layers;a.tables&&(c=c.concat(a.tables));var e={layers:[]};c?d.forEach(c,function(a){var c=
a.toJson();a.labelingInfo&&!arcgisonline.map.labels.hasLayer(a)&&delete c.layerDefinition.drawingInfo.labelingInfo;b&&arcgisonline.map.featColl.roundFeatureSetCoordinates(c);a.__popupInfo?c.popupInfo=a.__popupInfo:delete c.popupInfo;a.minScale||a.maxScale?(c.layerDefinition.minScale=a.minScale?a.minScale:0,c.layerDefinition.maxScale=a.maxScale&&1!==a.maxScale?a.maxScale:0,c.layerDefinition.minScale===Number.POSITIVE_INFINITY&&(c.layerDefinition.minScale=0),0===c.layerDefinition.minScale&&0===c.layerDefinition.maxScale&&
(delete c.layerDefinition.minScale,delete c.layerDefinition.maxScale,esri.isEmpty(c.layerDefinition)&&delete c.layerDefinition)):(delete c.layerDefinition.minScale,delete c.layerDefinition.maxScale);delete c.showLegend;!1===a.__showLegend?c.showLegend=!1:!0===a.__showLegend&&(c.showLegend=!0);c.layerDefinition.extent=arcgisonline.map.featColl.getFeatureSetFullExtent(c.featureSet,c);e.layers.push(c)},this):(c=a.layer.toJson(),a.layer.labelingInfo&&!arcgisonline.map.labels.hasLayer(a.layer)&&delete c.layerDefinition.drawingInfo.labelingInfo,
a.popupInfo?c.popupInfo=a.popupInfo:a.layer.__popupInfo?c.popupInfo=a.layer.__popupInfo:delete c.popupInfo,a.layer.minScale||a.layer.maxScale?(c.layerDefinition.minScale=a.layer.minScale,c.layerDefinition.maxScale=a.layer.maxScale,c.layerDefinition.minScale===Number.POSITIVE_INFINITY&&(c.layerDefinition.minScale=0),!c.layerDefinition.minScale&&!c.layerDefinition.maxScale&&(delete c.layerDefinition.minScale,delete c.layerDefinition.maxScale,esri.isEmpty(c.layerDefinition)&&delete c.layerDefinition)):
(delete c.layerDefinition.minScale,delete c.layerDefinition.maxScale,esri.isEmpty(c.layerDefinition)&&delete c.layerDefinition),c.layerDefinition.extent=arcgisonline.map.featColl.getFeatureSetFullExtent(c.featureSet,c),e.layers.push(c));e.showLegend=!1===a.showLegend?!1:!0;return e}}});