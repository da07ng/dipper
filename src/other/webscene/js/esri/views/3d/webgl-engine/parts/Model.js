// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("dojo/string ../lib/Light ../lib/ModelContentType ../lib/ModelDirtySet ../lib/RenderGeometry ../lib/Util ../lib/gl-matrix".split(" "),function(B,p,d,C,D,g,k){var f=g.assert,E=g.verify,t=k.vec3,F=k.mat4d,G=g.logWithBase;g=function(){function g(a,b){var c=Array.prototype.slice.call(arguments);c.shift();m.forEach(function(b){void 0!==b[a]&&b[a].apply(this,c)})}var n=new C(this),q=function(){var a={},b;for(b in d)a[d[b]]={};return a}(),k=new p.AmbientLight([1,1,1],0.3,!0,0.5,5,3,16),u=new p.DirectionalLight([1,
1,1],0.7,t.normalize([1,1,1]),0.5,!0),r,v,m=[];this.getAll=function(a){a=q[a];f(void 0!==a);return a};this.get=function(a,b){return this.getAll(a)[b]};this.add=function(a,b){var c=q[a];f(void 0!==c);var e=b.getId();f(void 0===c[e],"Model/Stage already contains object to be added");c[e]=b;a===d.LAYER&&this.notifyDirty(a,b,"layerAdded");g("contentAdded",a,b)};this.remove=function(a,b){var c=q[a];f(void 0!==c);var e=c[b];f(void 0!==e,"Model/Stage doesn't contain object to be removed");delete c[b];a===
d.TEXTURE&&e.unload();a===d.LAYER&&this.notifyDirty(a,e,"layerRemoved");g("contentRemoved",a,e);return e};this.getDirtySet=function(){return n};this.notifyDirty=function(a,b,c,e){n.handleUpdate(b,c,e)};this.getAmbientLight=function(){return k};this.setAmbientLight=function(a){k.set(a)};this.getDirectionalLight=function(){return u};this.setDirectionalLight=function(a){u.set(a)};this.getSelection=function(){return r};this.setSelection=function(a,b){r=a;v=b};this.getSelectionFaceRange=function(){return v};
var z={},H=0,s={},A=function(a,b,c){var e=0;b=b*(c||10)/1E4;1<b&&(e=Math.ceil(G(b,2)));b=1E4*Math.pow(2,e);c=Math.round(a[0]/b);var d=Math.round(a[1]/b);a=Math.round(a[2]/b);var e=e+"_"+c+"_"+d+"_"+a,f=s[e];void 0===f&&(f={vec3:t.createFrom(c*b,d*b,a*b),id:e},s[e]=f);return f};this.getOrigin=A;this.getGeometryRenderGeometries=function(a,b,c,e){e=a.getId();for(var d=b.geometry,f=d.getData(),g=!!d.singleUse,k=f.getFaces(),m=f.getVertexAttr(),f=f.getId(),n=b.materials,q=b.instanceParameters,p=a.getCombinedTransformation(b),
t=F.maxScale(p),u=b.origin,r=a.getVisibleIndexRanges(b),h=0,v=d.getNumGroups();h<v;++h){var l=d.getBoundingInfo(h),x=b.getId()+"#"+h,w=z[x];void 0===w&&(w=H++,z[x]=w);var s={},y;for(y in k[h].indices)s[y]=m[y];l=new D({faces:k[h],vertexAttr:s,id:f+"#"+h},l,n[h],p,t,a.getCastShadow(),g,e,x,w,h);l.origin=u||A(l.center,l.radius);l.displayedIndexRange=r?r[h]:null;l.instanceParameters=q?b.instanceParameters[h]:null;c.push(l)}};this.formatDebugInfo=function(a){var b=[],c;if(a){b[0]="\x3ctable\x3e";for(c in d)a=
d[c],b[0]+="\x3ctr\x3e\x3ctd\x3e"+a+'\x3c/td\x3e\x3ctd style\x3d"text-align: right"\x3e'+Object.keys(this.getAll(a)).length+"\x3c/td\x3e\x3c/tr\x3e";b[0]+="\x3c/table\x3e";b[1]=n.formatDebugInfo(!0)}else{b[0]="";for(c in d)a=d[c],b[0]+=B.pad(String(Object.keys(this.getAll(a)).length),6," ")+" "+a+", ";b[1]=n.formatDebugInfo(!1)}return b};this.validateContent=function(){var a=this.getAll(d.OBJECT),b;for(b in a)this.validateObject(a[b]);a=this.getAll(d.LAYER);for(b in a)this.validateLayer(a[b]);a=this.getAll(d.MATERIAL);
for(b in a)this.validateMaterial(a[b])};this.validateObject=function(a){a=a.getGeometryRecords();for(var b=0;b<a.length;++b){var c=a[b];f(null!=this.get(d.GEOMETRY,c.geometry.getId()));var e=c.geometry.getNumGroups();f(e<=c.materials.length,"object materials do not match geometry groups");E(e==c.materials.length,"object materials do not match geometry groups");for(var g=0;g<e;++g)f(null!=this.get(d.MATERIAL,c.materials[g].getId()))}};this.validateLayer=function(a){a=a.getObjects();for(var b=0;b<a.length;++b){var c=
this.get(d.OBJECT,a[b].getId());f(null!=c)}};this.validateMaterial=function(a){a=a.getAllTextureIds();for(var b=0;b<a.length;++b){var c=this.get(d.TEXTURE,a[b]);f(null!=c)}};this.addModelListener=function(a){f(-1===m.indexOf(a));m.push(a)};this.removeModelListener=function(a){a=m.indexOf(a);f(-1!==a);m.splice(a,a)}};g.ContentType=d;return g});