// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/_PublishTileServiceDlgMixin",["dijit","dojo","dojox","dojo/require!dojo/promise/all,dojo/Deferred,esri/geometry/Extent,arcgisonline/sharing/util"],function(g,b,h){b.provide("arcgisonline.sharing.dijit.dialog._PublishTileServiceDlgMixin");b.require("dojo.promise.all");b.require("dojo.Deferred");b.require("esri.geometry.Extent");b.require("arcgisonline.sharing.util");b.declare("arcgisonline.sharing.dijit.dialog._PublishTileServiceDlgMixin",null,{_util:arcgisonline.sharing.util,
tileCacheInfo:{spatialReference:{wkid:102100,latestWkid:3857},origin:{x:-2.0037508342787E7,y:2.0037508342787E7},rows:256,cols:256,dpi:96,preciseDpi:96,lods:[{level:0,resolution:156543.033928,scale:5.91657527591555E8},{level:1,resolution:78271.5169639999,scale:2.95828763795777E8},{level:2,resolution:39135.7584820001,scale:1.47914381897889E8},{level:3,resolution:19567.8792409999,scale:7.3957190948944E7},{level:4,resolution:9783.93962049996,scale:3.6978595474472E7},{level:5,resolution:4891.96981024998,
scale:1.8489297737236E7},{level:6,resolution:2445.98490512499,scale:9244648.868618},{level:7,resolution:1222.99245256249,scale:4622324.434309},{level:8,resolution:611.49622628138,scale:2311162.217155},{level:9,resolution:305.748113140558,scale:1155581.108577},{level:10,resolution:152.874056570411,scale:577790.554289},{level:11,resolution:76.4370282850732,scale:288895.277144},{level:12,resolution:38.2185141425366,scale:144447.638572},{level:13,resolution:19.1092570712683,scale:72223.819286},{level:14,
resolution:9.55462853563415,scale:36111.909643},{level:15,resolution:4.77731426794937,scale:18055.954822},{level:16,resolution:2.38865713397468,scale:9027.977411},{level:17,resolution:1.19432856685505,scale:4513.988705},{level:18,resolution:0.597164283559817,scale:2256.994353},{level:19,resolution:0.298582141647617,scale:1128.497176}]},tileImageInfo:{format:"PNG",compressionQuality:0,antialiasing:!0},cacheStorageInfo:{storageFormat:"esriMapCacheStorageModeExploded",packetSize:128},lods:[{level:0,
label:"1:591,657,528",scale:5.91657527591555E8},{level:1,label:"1:295,828,764",scale:2.95828763795777E8},{level:2,label:"1:147,914,382",scale:1.47914381897889E8},{level:3,label:"1:73,957,191",scale:7.3957190948944E7},{level:4,label:"1:36,978,595",scale:3.6978595474472E7},{level:5,label:"1:18,489,298",scale:1.8489297737236E7},{level:6,label:"1:9,244,649",scale:9244648.868618},{level:7,label:"1:4,622,324",scale:4622324.434309},{level:8,label:"1:2,311,162",scale:2311162.217155},{level:9,label:"1:1,155,581",
scale:1155581.108577},{level:10,label:"1:577,791",scale:577790.554289},{level:11,label:"1:288,895",scale:288895.277144},{level:12,label:"1:144,448",scale:144447.638572},{level:13,label:"1:72,224",scale:72223.819286},{level:14,label:"1:36,112",scale:36111.909643},{level:15,label:"1:18,056",scale:18055.954822},{level:16,label:"1:9,028",scale:9027.977411},{level:17,label:"1:4,514",scale:4513.988705},{level:18,label:"1:2,257",scale:2256.994353},{level:19,label:"1:1,128",scale:1128.497176}],statusCheckIntervalTime:2500,
_fetchFSInfo:function(a){var c=new b.Deferred,d=a&&a.url,e=a?esriGeowConfig.restBaseUrl+"content/items/"+a.id+"/data":null;d&&e?b.promise.all([this._fetchServiceInfo(d),this._fetchItemData(e,a)]).then(b.hitch(this,function(a){c.resolve({serviceInfo:a[0],itemData:a[1]})})):c.reject(this.i18n.publishWizard.errors.noItemUrl||{message:"Item does not specify a url."});return c},_fetchServiceInfo:function(a){return this._util.request({url:a})},_fetchItemData:function(a,c){return this._util.request({url:a}).then(b.hitch(this,
function(a){var e=[],f;b.forEach(a&&a.layers||[],b.hitch(this,function(a,d){a&&a.popupInfo&&(f=b.mixin({},{id:d,showLegend:a.showLegend?!0:!1,layerUrl:c.url+"/"+a.id,layerItemId:c.id,popupInfo:a.popupInfo}));e.push(f)}));return e&&e.length?b.mixin(a,{layers:e}):null}))},_computeScale:function(a,b){var d={width:esri.config.defaults.map.width,extent:new esri.geometry.Extent(a),spatialReference:a.spatialReference||b};return esri.geometry.getScale(d)},_fetchTileLayerInfo:function(a){var c=new b.Deferred;
-1<a.indexOf("/MapServer")?this._util.request({url:a,timeout:1E4},{useProxy:-1<window.location.href.indexOf("https:")&&a&&-1<a.indexOf("http:"),addToken:!1}).then(b.hitch(this,function(a){a&&a.singleFusedMapCache&&a.tileInfo?c.resolve(this._addScaleLabels(a.tileInfo)):c.reject({title:this.i18n.common.notice,message:this.i18n.publishTileServiceDlg.noTilingSchemeFound})}),b.hitch(this,function(a){c.reject({title:this.i18n.common.notice,message:this.i18n.publishTileServiceDlg.mapServiceError})})):c.reject({title:this.i18n.common.notice,
message:this.i18n.publishTileServiceDlg.badMapServiceUrl});return c},_addScaleLabels:function(a){if(a&&a.lods)return b.forEach(a&&a.lods||[],b.hitch(this,function(a){a.label="1:"+b.number.format(Math.round(a.scale),{pattern:"#,###,###,##0"})})),a},_computeMinAndMaxScales:function(a,c){var d,e={lods:a,maxLevel:0,minLevel:a[a.length-1].level};c&&(d=b.filter(a,b.hitch(this,function(a){return a.scale>=c})),e.maxLevel=d[0].level||0,d=b.filter(a,b.hitch(this,function(a){return a.scale<=c})),e.minLevel=
d[0].level||d[a.length-1].level);return e}})});