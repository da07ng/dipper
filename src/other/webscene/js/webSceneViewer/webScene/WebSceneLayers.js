// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("dojo/_base/lang dojo/_base/array dojo/promise/all dojo/Deferred dojo/request/xhr esri/request esri/config esri/geometry/Extent esri/geometry/SpatialReference webSceneViewer/spatialReferenceUtils esri/layers/SceneLayer esri/layers/FeatureLayer esri/layers/ArcGISTiledLayer esri/layers/ArcGISDynamicLayer esri/layers/ArcGISElevationLayer esri/layers/GroupLayer esri/layers/OpenStreetMapLayer esri/layers/support/TileInfo esri/views/3d/terrain/TilingScheme esri/views/3d/terrain/TerrainSurface dojo/i18n!webSceneViewer/nls/viewer".split(" "),
function(J,K,L,w,M,s,t,z,m,q,A,x,y,B,C,D,N,u,O,P,g){function Q(a){t.geometryService&&require(["dojo/on","esri/geometry/support/webMercatorUtils"],function(b,c){b.once(a,"load",function(){var b=a.fullExtent;b&&(102100===b.spatialReference.wkid||(3857===b.spatialReference.wkid||4326===b.spatialReference.wkid)||require(["esri/tasks/GeometryService","esri/tasks/support/ProjectParameters"],function(c,g){var f=t.geometryService,h=new g;h.geometries=[b];h.outSR=m.WebMercator;f.project(h).then(function(b){b&&
0<b.length&&a.set("fullExtent",b[0])})}))})})}function R(a){var b=null,c=a.search(/\/rest\/services\//i);0<c&&(b=a.substring(0,c+6));return b}function E(a){var b=document.createElement("a");b.href=a;a=b.hostname;for(var b=[".arcgis.com",".arcgisonline.com"],c=0;c<b.length;c++){var d=b[c];if(-1!==a.indexOf(d,a.length-d.length))return!0}return!1}function F(a){a instanceof u||(a=u.fromJSON(a));return O.WebMercatorAuxiliarySphere.compatibleWith(a)}function G(a,b){a instanceof u||(a=u.fromJSON(a));var c=
b.basemapTerrain&&b.basemapTerrain.tilingScheme;return c?c.compatibleWith(a):!0}function H(a,b){var c=P.checkUnsupported(a.tileInfo,a.fullExtent);if(c)return b.reject({msg:S(c)+h(a)}),!0}function S(a){switch(a.name){case "tilingscheme:gaps":return g.messages.tilingSchemeGaps;case "tilingscheme:power-of-two":return g.messages.tilingSchemePowerOfTwo;case "tilingscheme:tile-size":return g.messages.tilingSchemeTileSize;case "terrainsurface:num-root-tiles":return a.message;default:return g.messages.tilingSchemeGeneric}}
function T(a,b,c,d,e){if(b.tileInfo){a=E(a);if(!a&&10.22>c.currentVersion)return d.reject({msg:g.messages.tiledMapServicesMinVersion+h(b)}),!1;if(!a&&10.22===c.currentVersion&&!c._isCorsPatchDetected)return d.reject({msg:g.messages.tiledMapServicesMinVersionPatch+" "+g.messages.patchRequired+"\x3cbr\x3eArcGIS 10.2.2 for Server Patch - View Map and Image Services in the ArcGIS Online Scene Viewer"}),!1;c=window._webSceneViewerView;a=b.spatialReference instanceof m?b.spatialReference.clone():m.fromJSON(b.spatialReference);
var l=c.map.spatialReference,f="planar"===c.globeMode&&1===e;e=2===e;if(!e&&(!f||"spherical"===c.globeMode)&&!a.equals(l))return e=l.isWebMercator()?g.messages.tiledMapServicesSR+" Create a new local scene to add this layer.":g.messages.tiledMapServicesSRGeneric+" ("+l.wkid+")",d.reject({msg:e+h(b)}),!1;if(q.isGeographicCRS(a))return d.reject({msg:g.messages.tiledMapServiceSRGCS+h(b)}),!1;if("spherical"===c.globeMode){if(!e&&!F(b.tileInfo))return d.reject({msg:g.messages.tiledMapServicesTilingScheme+
h(b)}),!1}else if(!e&&!f&&!G(b.tileInfo,c))return d.reject({msg:g.messages.tiledMapServicesSRGeneric+h(b)}),!1;return H(b,d)?!1:"ArcGISTiledMapServiceLayer"}return"ArcGISMapServiceLayer"}function h(a){return a.name&&""!==a.name?"\x3cbr\x3e"+g.messages.serviceName+": "+a.name:""}function U(a,b,c){if(a.tileInfo){var d=a.spatialReference instanceof m?a.spatialReference.clone():m.fromJSON(a.spatialReference),e="LERC"===a.tileInfo.format,l=window._webSceneViewerView,f=l.map.spatialReference,k="planar"===
l.globeMode&&1===c;c=2===c;if(!c&&(!k||"spherical"===l.globeMode)&&!d.equals(f))return d=e?"spherical"===l.globeMode?g.messages.elevationImageServicesSR+" Create a new local scene to add this layer.":g.messages.tiledElevationServicesSRGeneric+" ("+f.wkid+")":"spherical"===l.globeMode?g.messages.imageServicesSR+" Create a new local scene to add this layer.":g.messages.tiledImageServicesSRGeneric+" ("+f.wkid+")",b.reject({msg:d+h(a)}),!1;if(q.isGeographicCRS(d))return b.reject({msg:g.messages.tiledMapServiceSRGCS+
h(a)}),!1;if("spherical"===l.globeMode){if(!c&&!F(a.tileInfo))return d=e?g.messages.elevationImageServicesTilingScheme:g.messages.tiledImageServicesTilingScheme,b.reject({msg:d+h(a)}),!1}else if(!k&&!c&&!G(a.tileInfo,l))return d=e?g.messages.tiledElevationServicesSRGeneric+h(a):g.messages.tiledImageServicesSRGeneric+h(a),b.reject({msg:d}),!1;return H(a,b)?!1:e?"ArcGISTiledElevationServiceLayer":"ArcGISTiledImageServiceLayer"}d=e?g.messages.elevationImageServicesCached:g.messages.imageServicesCached;
b.reject({msg:d+h(a)});return!1}function V(a,b,c){if(a){var d;d=J.exists("spatialReference.wkid",a)?new m(a.spatialReference.wkid):new m(4326);var e=window._webSceneViewerView,l=e.map.spatialReference,f="planar"===e.globeMode&&1===c;if(c=2!==c){if(f=!f||"spherical"===e.globeMode)f=d.equals(l)?!0:l.isWebMercator()&&4326===d.wkid?!0:!1,f=!f;c=f}return c?(d="spherical"===e.globeMode?g.messages.sceneLayerSRWM+" Create a new local scene to add this layer.":g.messages.sceneLayerSR+" ("+l.wkid+")",b.reject({msg:d+
h(a)}),!1):"planar"===e.globeMode&&q.isGeographicCRS(d)?(b.reject({msg:g.messages.sceneLayerSRGCS+h(a)}),!1):(d=a.drawingInfo&&a.drawingInfo.renderer&&a.drawingInfo.renderer.type)&&!k.isFeatureServiceRendererSupported(d)?(b.reject({msg:g.messages.featureServiceNotSupportedRendererType+" "+d+h(a)}),!1):!0}}function W(a,b,c){if(a.type&&"Table"===a.type)return c.reject({msg:g.messages.featureServiceNotSupportedTable+h(a)}),!1;if(a.geometryType&&"esriGeometryMultiPatch"===a.geometryType)return c.reject({msg:g.messages.featureServiceNotSupportedMultipatch+
h(a)}),!1;if(a.geometryType&&"esriGeometryMultipoint"===a.geometryType)return c.reject({msg:"Multipoint Feature Services are not supported"+h(a)}),!1;var d=a.drawingInfo&&a.drawingInfo.renderer&&a.drawingInfo.renderer.type;if(!d)return c.reject({msg:g.messages.featureServiceNotSupportedNoRenderer+h(a)}),!1;if(!k.isFeatureServiceRendererSupported(d))return c.reject({msg:g.messages.featureServiceNotSupportedRendererType+" "+d+h(a)}),!1;if(b.count>I)c.reject({msg:g.messages.featureServiceNotSupportedMaxFeatures+
" "+b.count+"/"+I+h(a)});else return!0}function n(a){return a&&a.replace(/_/g," ").replace(/\/$/,"")}var I=2E3,X=["simple","classBreaks","uniqueValue"],k={create:function(a){for(var b,c=0;c<k.layerHandlers.length;c++)if(k.layerHandlers[c].condition(a)){b=k.layerHandlers[c].create(a);break}return b},addHandler:function(a){k.layerHandlers.push(a)},getHandlers:function(){return k.layerHandlers},layerHandlers:[{name:"ArcGISSceneServiceLayer",condition:function(a){return a.hasOwnProperty("layerType")&&
"ArcGISSceneServiceLayer"===a.layerType},create:function(a){return new A(a.url,k.evalOptions(a))}},{name:"ArcGISFeatureLayer",condition:function(a){return a.hasOwnProperty("layerType")&&"ArcGISFeatureLayer"===a.layerType},create:function(a){var b=k.evalOptions(a);b.mode=x.MODE_SNAPSHOT;b.returnZ=!0;b.outFields=["*"];a=new x(a.url,b);"spherical"===window._webSceneViewerView.globeMode?Q(a):q.projectLayerExtentToSceneSR(a);return a}},{name:"ArcGISMapServiceLayer",condition:function(a){return a.hasOwnProperty("layerType")&&
"ArcGISMapServiceLayer"===a.layerType},create:function(a){return new B(a.url,k.evalOptions(a))}},{name:"ArcGISTiledMapServiceLayer",condition:function(a){return a.hasOwnProperty("layerType")&&"ArcGISTiledMapServiceLayer"===a.layerType},create:function(a){return new y(a.url,k.evalOptions(a))}},{name:"ArcGISTiledImageServiceLayer",condition:function(a){return a.hasOwnProperty("layerType")&&"ArcGISTiledImageServiceLayer"===a.layerType},create:function(a){return new y(a.url,k.evalOptions(a))}},{name:"GroupLayer",
condition:function(a){return a.hasOwnProperty("layerType")&&"GroupLayer"===a.layerType},create:function(a){a=k.evalOptions(a);return new D(a)}},{name:"ArcGISTiledElevationServiceLayer",condition:function(a){return a.hasOwnProperty("layerType")&&"ArcGISTiledElevationServiceLayer"===a.layerType},create:function(a){var b=k.evalOptions(a);0<a.url.indexOf("s3-eu-west-1.amazonaws.com")&&(void 0===a.resourceInfo&&(console.warn("missing s3 elevation info"),a.resourceInfo={}),b.resourceInfo=a.resourceInfo,
void 0===a.resourceInfo.tileInfo&&(b.resourceInfo.tileInfo={lods:Y}),b.resourceInfo.fullExtent=void 0===a.resourceInfo||void 0===a.resourceInfo.fullExtent?new z(-2.103750722959434E7,-2.197186888040859E7,2.103750722959434E7,2.1971868880408563E7,m.WebMercator):new z(a.resourceInfo.fullExtent));return new C(a.url,b)}}],evalOptions:function(a){var b={visible:void 0===a.visibility?!0:a.visibility,title:a.title};a.id&&(b.id=a.id);void 0!==a.opacity&&(b.opacity=a.opacity);void 0!==a.visibilityMode&&(b.visibilityMode=
a.visibilityMode);b.showLegend=void 0===a.showLegend?!0:a.showLegend;void 0!==a.listMode&&(b.listMode=a.listMode);a.layerDefinition&&a.layerDefinition.definitionExpression&&(b.definitionExpression=a.layerDefinition.definitionExpression);return b},isFeatureServiceRendererSupported:function(a){return-1!==X.indexOf(a)},prepareFromServiceUrl:function(a,b){var c=new w;if(!a)return c.reject({msg:g.messages.invalidUrl}),c.promise;var d=k.validateServerUrl(a),e=d.serviceType,l=d.hasLayer;if(!d.isValidUrl)return c.reject({msg:g.messages.invalidUrl+
" "+a}),c.promise;if("MapServer"===e&&l)d.serviceType="FeatureServer";else if("ImageServer"===e&&l)return c.reject({msg:g.messages.unsupportedUrl+" "+a}),c.promise;var f={url:a,params:b,serviceDetails:d};d.needsGetLayer?s({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}).then(function(a,l){if("SceneServer"===e){var f;(f=l.serviceVersion)?(f=f.split("."),f=!f||1>f.length?!1:"1"===f[0]):f=!1;if(!f){c.reject({msg:g.messages.sceneLayerVersion});return}}f=a.url;for(var h=[],v=0;v<
l.layers.length;v++){var k="SceneServer"===e?f+"/layers/"+l.layers[v].id:f+("/"===f.substr(f.length-1,1)?"":"/")+l.layers[v].id;h.push({url:k,params:b,serviceDetails:d})}c.resolve({services:h})}.bind(this,f),function(a){console.log("serviceInfo query on "+f.serviceType+" failed");c.reject(a)}):c.resolve({services:[f]});return c.promise},prepareOpLayerFromService:function(a,b){b=void 0===b?0:b;var c=new w,d=a.serviceDetails,e=d.serviceType,g=a.params,f=a.url,h=[],m=f;if("SceneServer"!==e)if("SceneServerLocal"===
e)e=document.createElement("a"),e.href=f,e=e.host,0>t.request.corsEnabledServers.indexOf(e)&&t.request.corsEnabledServers.push(e),d.hasLayer||(m=f+"/nodes/0/");else if("FeatureServer"===e)d=s({url:f+"/query",content:{f:"json",where:g&&g.layerDefinition&&g.layerDefinition.definitionExpression||"1\x3d1",returnCountOnly:!0},handleAs:"json",callbackParamName:"callback"}),h.push(d);else if("MapServer"===e&&!1===E(f)){var q=R(f);if(q){var r=new w;s({url:q+"services/",content:{f:"json"},handleAs:"json",
callbackParamName:"callback"}).then(function(a){10.22===a.currentVersion?M(q+"self?f\x3djson",{headers:{"X-Requested-With":null},timeout:1E4,handleAs:"json"}).then(function(b){a._isCorsPatchDetected=!b||b.error?!1:!0;r.resolve(a)},function(b){a._isCorsPatchDetected=!1;r.resolve(a)}):r.resolve(a)},r.reject.bind(r));h.push(r)}}a.layer?h.unshift(a.layer.then(function(){return a.layer})):(m=s({url:m,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),h.unshift(m));L(h).then(function(a,d,
e){var f,h=a.serviceDetails.serviceType,m=e[0],p;if("MapServer"===h){if(e=T(d,m,e[1],c,b))f=e,p=a.params.title||k.parseTitleFromLayerUrl(g.url)}else if("ImageServer"===h){if(e=U(m,c,b))f=e,p=a.params.title||n(m.name)}else"FeatureServer"===h?W(m,e[1],c)&&(f="ArcGISFeatureLayer",p=a.serviceDetails.needsGetLayer?(a.params.title||n(a.serviceDetails.serverName))+" - "+n(e[0].name):a.params.title||n(a.serviceDetails.serverName)+" - "+n(e[0].name)):"SceneServer"===h?V(m,c,b)&&(f="ArcGISSceneServiceLayer",
p=e[0].alias||e[0].name,p=a.serviceDetails.needsGetLayer?(a.params.title||n(a.serviceDetails.serverName))+" - "+n(p):a.params.title||n(a.serviceDetails.serverName)+" - "+n(p)):"SceneServerLocal"===h&&(p=f="ArcGISSceneServiceLayer");f?c.resolve({layerType:f,title:p,url:d,serviceInfo:m}):setTimeout(function(){c.reject({msg:"Unsupported service "+d})},50)}.bind(this,a,f),function(a,b){c.reject({msg:b.message,details:a})}.bind(this,f));return c},validateServerUrl:function(a){a=a.replace(/\/$/,"");a=a.split("?")[0];
var b=a.replace(/http.+\/(arcgis\/rest\/services|arcgis\/services)\/?/ig,"").match(/(\/(MapServer|GeocodeServer|GPServer|GeometryServer|ImageServer|NAServer|FeatureServer|GeoDataServer|GlobeServer|MobileServer|WMServer|SceneServer|SceneServerLocal)).*/ig);if(null==b)return{isValidUrl:!1};var c;b&&b[0]&&(c=a.split(b)[0].split("/").pop(),b=b[0].substr(1));b=b&&b.length?b.split("/"):!1;a=b[0];var b=b.splice(1),d=!1,e=!1,g=!1;"SceneServerLocal"===a&&(d=0===b.length||2===b.length&&"layers"===b[0]&&!isNaN(b[1]),
e=2===b.length,g=!e);if("SceneServer"===a)d=0===b.length||2===b.length&&"layers"===b[0]&&!isNaN(b[1]),e=2===b.length,g=!e;else if("FeatureServer"===a)d=0===b.length||1===b.length&&!isNaN(b[0]),e=1===b.length,g=!e;else if("MapServer"===a||"ImageServer"===a)d=0===b.length||1===b.length&&!isNaN(b[0]),e=1===b.length,g=!1;return{serviceType:a,hasLayer:e,isValidUrl:d,needsGetLayer:g,serverName:c}},extrapolateTypeFromLayerInstance:function(a){if(a instanceof A)return"ArcGISSceneServiceLayer";if(a instanceof
x)return"ArcGISFeatureLayer";if(a instanceof y)return a.capabilities?-1!==a.capabilities.split(",").indexOf("Map")?"ArcGISTiledMapServiceLayer":"ArcGISTiledImageServiceLayer":a.url?"ImageServer"===k.validateServerUrl(a.url).serviceType?"ArcGISTiledImageServiceLayer":"ArcGISTiledMapServiceLayer":"ArcGISTiledMapServiceLayer";if(a instanceof B)return"ArcGISMapServiceLayer";if(a instanceof C)return"ArcGISTiledElevationServiceLayer";if(a instanceof D)return"GroupLayer";if(a instanceof N)return"OpenStreetMap"},
URL_REGEXP:"^https?://[^/]+/([^/]+/)*(((SceneServer|MapServer|FeatureServer|ImageServer)((/layers)?/[0-9]+)?/?)|(SceneServerLocal(/([^/]+/?)*)?))$",parseTitleFromLayerUrl:function(a){var b=RegExp(k.URL_REGEXP);a=b.test(a)?n(a.replace(b,"$1")):k.parseIdFromLayerUrl(a);return a.charAt(0).toUpperCase()+a.slice(1)},parseIdFromLayerUrl:function(a,b){var c;c=RegExp(k.URL_REGEXP);c.test(a)?c=b?a.replace(c,"$2__")+b.replace(" ","_").toLowerCase():a.replace(c,"$2__$1"):(c=new URL(a),c=c.pathname.length<c.hostname.length?
c.pathname.replace("/","_"):c.hostname.replace(".","_"));return c},useSSLIfRequired:function(a,b){(function(a){if(!a||!b)return!1;var d=!1;K.forEach(("undefined"===typeof window.esriGeowConfig?{httpsDomains:["arcgis.com","arcgisonline.com"]}:window.esriGeowConfig).httpsDomains,function(b){if(-1<a.indexOf("."+b+"/")||-1<a.indexOf("/"+b+"/"))d=!0});!d&&-1<a.indexOf(b.portalHostname)&&(d=!0);return d})(a)&&(a=b.portalUtil.useSSL(window.location.protocol,a));return a}},Y=[{level:0,resolution:156543.03392800014,
scale:5.91657527591555E8},{level:1,resolution:78271.51696399994,scale:2.95828763795777E8},{level:2,resolution:39135.75848200009,scale:1.47914381897889E8},{level:3,resolution:19567.87924099992,scale:7.3957190948944E7},{level:4,resolution:9783.93962049996,scale:3.6978595474472E7},{level:5,resolution:4891.96981024998,scale:1.8489297737236E7},{level:6,resolution:2445.98490512499,scale:9244648.868618},{level:7,resolution:1222.992452562495,scale:4622324.434309},{level:8,resolution:611.4962262813797,scale:2311162.217155},
{level:9,resolution:305.74811314055756,scale:1155581.108577},{level:10,resolution:152.87405657041106,scale:577790.554289},{level:11,resolution:76.43702828507324,scale:288895.277144},{level:12,resolution:38.21851414253662,scale:144447.638572},{level:13,resolution:19.10925707126831,scale:72223.819286},{level:14,resolution:9.554628535634155,scale:36111.909643},{level:15,resolution:4.77731426794937,scale:18055.954822},{level:16,resolution:2.388657133974685,scale:9027.977411},{level:17,resolution:1.1943285668550503,
scale:4513.988705},{level:18,resolution:0.5971642835598172,scale:2256.994353},{level:19,resolution:0.29858214164761665,scale:1128.497176}];return k});