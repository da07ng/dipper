// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/TemplatesGrid",["dijit","dojo","dojox","dojo/require!arcgisonline/sharing/geow/Content,arcgisonline/sharing/geow/Community,arcgisonline/sharing/dijit/Gallery,arcgisonline/sharing/dijit/views,arcgisonline/sharing/util,dojo/mouse"],function(l,a,t){a.provide("arcgisonline.sharing.dijit.TemplatesGrid");a.require("arcgisonline.sharing.geow.Content");a.require("arcgisonline.sharing.geow.Community");a.require("arcgisonline.sharing.dijit.Gallery");a.require("arcgisonline.sharing.dijit.views");
a.require("arcgisonline.sharing.util");a.require("dojo.mouse");a.declare("arcgisonline.sharing.dijit.TemplatesGrid",[l._Widget,l._Templated],{_gallery:null,_galleryPane:null,_detailsPane:null,_detailsTextPane:null,_detailsIconPane:null,_detailsTimer:null,templatesGroupId:null,groupQuery:null,galleryNodes:4,_views:arcgisonline.sharing.dijit.views,_util:arcgisonline.sharing.util,sortField:null,sortOrder:null,showThumbnail:!0,templateString:"\x3cdiv dojoAttachPoint\x3d'containerNode'\x3e\x3c/div\x3e",
textMenus:[],i18n:null,onPublish:function(){},_getTemplates:function(){var c;c=' AND type:"Web Mapping Application"';esriGeowConfig.self.user&&!esriGeowConfig.self.user.accountId&&(c+=' AND -typekeywords:"requiresOrganizationUser"');c={q:"group:"+this.templatesGroupId+c,sortField:this.sortField,num:"50"};this.sortOrder&&(c.sortOrder=this.sortOrder);arcgisonline.sharing.geow.Content.search(esriGeowConfig.restBaseUrl+"search",c,a.hitch(this,this._handleTemplatesResponse),a.hitch(this,this._handleTemplatesResponse))},
refresh:function(){this._getTemplates()},postMixInProperties:function(){this.inherited(arguments);this.i18n=a.i18n.getLocalization("arcgisonline","arcgisonline").common;a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").templatesGridWidget)},postCreate:function(){this._gallery=new arcgisonline.sharing.dijit.Gallery({id:this.id+"_Gallery",nodesPerPage:this.galleryNodes,showNodeLabels:!0,showToolTip:!1,noResultsMessage:"\x3cp class\x3d'esriItemLinks'\x3e\x3cspan\x3e"+this.i18n.noItemsToDisplay+
"\x3c/span\x3e\x3c/p\x3e"},a.create("div",null,this.domNode));this._user=arcgisonline.sharing.util.getUser();var c=this;a.mixin(this._gallery,{_buildNodeLayout:function(b,k){var g=a.create("div",{id:"galleryNode_"+b.id,"class":this.nodeClass,style:"position:relative;"});a.addClass(g,k?"large":"small");if(this.showNodeLabels){var d=a.create("div",{"class":"galleryLabelContainer"},g),e=b.title||"";a.create("span",{innerHTML:e,alt:e,title:e},d)}var d=void 0!==esriGeowConfig.isMultiTenant&&null!==esriGeowConfig.isMultiTenant&&
!1===esriGeowConfig.isMultiTenant,f=b.url,f=0===f.indexOf("http")||0===f.indexOf("//")?f:window.location.protocol+"//"+window.location.host+f;c&&c._user&&c._user.accountId?f=d?c._getPortalPreviewUrl(b,f):f.replace("/hosted/","/apps/"):c&&d&&(f=c._getPortalPreviewUrl(b,f));var l=b&&-1<a.indexOf(b.typeKeywords,"requiresOrganizationUser"),s=c._user&&"account_publisher"!==c._user.role&&"account_admin"!==c._user.role;arcgisonline.sharing.util.getGalleryMainLinkInfo(b);d=a.create("a",{href:"JavaScript:void(0);"},
g);a.create("img",{"class":this.thumbClass,src:b.thumbnail?this._getThumbailUrl(b):arcgisonline.sharing.util.relativeToExplicitUrl("images/transparent.gif")},d);a.create("br",null,g);var e=a.create("div",{"class":"linksDiv"},g),e=a.create("div",{"class":"esriItemLinks"},e),q=a.create("div",{"class":"esriFloatLeading"},e),n=a.create("a",{style:"text-decoration: none;"},q);b&&a.indexOf(b.typeKeywords,"requiresOrganizationUser")&&a.create("span",{innerHTML:this.i18n.publish},n);a.create("div",{"class":"dijitReset dijitInline esriArrows"},
n);q=a.hitch(this,function(h){var e=[],m=h.relatedItems&&0<h.relatedItems.length?h.relatedItems:h,d=a.filter(m,function(a){return a&&null!==a.url});h=d&&d.length?d[0]:m&&0<m.length?m[0]:h;(!l||l&&!s)&&e.push({label:this.i18n.publish,onClick:a.hitch(c,"onPublish",{template:b})});h.id&&(m=h.url||arcgisonline.sharing.util.getItemDataPath(h),e.push({label:this.i18n.download,onClick:a.hitch(c,"onDownload",m,h.url?!0:!1)}));e.push({label:this.i18n.preview,onClick:a.hitch(arcgisonline.map.mapUtil,"previewTemplate",
f,b.id)});e=new arcgisonline.sharing.dijit.TextMenu({triggerNode:n,labelNode:n,textMenuItems:e});c.textMenus.push(e)});arcgisonline.sharing.geow.Content.getApplicationCode(b,q);a.create("span",{innerHTML:"\x26nbsp;",style:"width:0;"},e);e=b.snippet||"";145<e.length&&(e=e.substring(0,140)+"...");var e=a.create("div",{id:"tooltip"+b.id,className:"templatesGridTooltip",innerHTML:'\x3cp class\x3d"title ellipsis"\x3e'+b.title+"\x3c/p\x3e\x3cp\x3e"+e+"\x3c/p\x3e"},g,"first"),p=function(c){(c=a.byId(c))&&
a.style(c,{opacity:0,display:"none"})},r=function(b,e){var d=a.byId(b);esri.show(d);var f=a.coords(d),g=a.coords(a.byId(e).parentNode);esriGeowConfig.isRightToLeft&&f.x+f.l<g.x+g.l?(a.style(d,"right","auto"),a.style(d,"left",10>a.isIE?"10px":"0")):f.w+f.x>g.w+g.x&&(a.style(d,"left","auto"),a.style(d,"right",10>a.isIE?"10px":"0"));a.fadeIn({node:d}).play();a.forEach(c.textMenus,function(a){a.hide()})};/ipad|android|android 3.0|xoom|sch-i800|playbook|tablet|kindle/i.test(navigator.userAgent.toLowerCase())?
a.connect(d,"onclick",function(){var c=a.byId("tooltip"+b.id);c&&"block"===a.getStyle(c,"display")?p("tooltip"+b.id):r("tooltip"+b.id,"galleryNode_"+b.id);a.query(".templatesGridTooltip").forEach(function(a){a.id!=="tooltip"+b.id&&p(a.id)})}):(a.connect(d,a.mouse.enter,function(){a.query(".templatesGridTooltip").forEach(function(a){p(a.id)});r("tooltip"+b.id,"galleryNode_"+b.id)}),a.connect(e,a.mouse.leave,function(){p("tooltip"+b.id)}));return g}});this._gallery.startup()},_getPortalPreviewUrl:function(a,
b){var k=arcgisonline.sharing.util.parseUrl(b);"/"===a.url.substring(0,1)&&-1<esriGeowConfig.baseUrl.indexOf(k.host)&&(b=window.location.protocol+"//"+window.location.host+arcgisonline.sharing.util.getHomeAppContext()+a.url);return b="https:"===window.location.protocol?arcgisonline.sharing.util.getSecureUrl(b):arcgisonline.sharing.util.getHttpUrl(b)},onDownload:function(a,b,k){k.preventDefault();b?window.open(a):window.location=a;l.byId("share-map-stack")&&l.byId("share-map-stack").selectChild(l.byId("share-map-application-help"))},
onAbout:function(a,b){b.preventDefault();arcgisonline.map.storage.saveMapInCookie(null,!0);window.location=a},_setGroupQueryAttr:function(c){(this.groupQuery=c)&&0<this.groupQuery.length&&arcgisonline.sharing.geow.Community.searchGroups(this.groupQuery,a.hitch(this,this._handleGetGroup),a.hitch(this,this._handleGetGroup))},_setGroupIdAttr:function(a){null===a||0===a.length||(this.pageCount=0,this.templatesGroupId=a,this._getTemplates())},_handleTemplatesResponse:function(c,b){for(var k,g=[],d=0;d<
c.results.length;d++)k=c.results[d],k.url&&g.push(k);a.attr(this._gallery,"items",g)},_handleGetGroup:function(a,b){this._groupDoesntExist=!1;a&&1==a.total?(this.templatesGroupId=a.results[0].id,a.results[0].sortField&&(this.sortField=a.results[0].sortField),a.results[0].sortOrder&&(this.sortOrder=a.results[0].sortOrder),this._setGroupIdAttr(a.results[0].id)):a&&1<a.total?console.error("TemplatesGrid: group query '"+this.groupQuery+"' returned more than 1 result."):(this._groupDoesntExist=!0,console.error('TemplatesGrid: group with query "'+
this.groupQuery+'" does not exist.'))},nextPage:function(){this._gallery.nextPage()},prevPage:function(){this._gallery.prevPage()}})});