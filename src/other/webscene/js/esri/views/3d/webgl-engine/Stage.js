// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("./parts/Model ./parts/View ./lib/Selector ./lib/Camera ./lib/gl-matrix ./lib/Util".split(" "),function(v,E,w,B,p,q){var t=q.assert,F=p.vec2d,G=p.vec2,l=p.vec3d,h=function(p,H){var x=!0,u=w.DEFAULT_TOLERANCE;this.needsRender=function(){return x};this.setNeedsRender=function(){x=!0};this.resetNeedsRender=function(){x=!1};this.dispose=function(){e.dispose();f=e=null};this.setSelectionObject=function(a,b,c){f.setSelection(a,c);e.setSelectionObject(void 0!==a?a.getId():void 0,c);if(!b)this.onSelectionChange(a,
c)};this.getSelectionObject=function(){return f.getSelection()};this.setHighlightObjects=function(a,b){e.setHighlightObjects(a,b);this.highlightedObjectIds=b&&-1===b.holdTime?a:void 0};this.frame=function(a,b){var c=B.frameCenterRadiusWithPadding(a.getCenter(),a.getBSRadiusApprox(),b),d=this.getCamera(),e=d.computeDirection(),f=1.5*c.radius/Math.tan(d.fov);l.scale(e,-f);l.set(c.center,d.center);l.add(c.center,e,d.eye);d=new B(d.eye,d.center,d.up);this.setCamera(d)};this.beginMod=function(){h.DebugSettings.fineGrainedContentValidation&&
f.validateContent()};this.add=function(a,b){f.add(a,b);"function"==typeof b.addParentStage&&b.addParentStage(this)};this.remove=function(a,b){var c=f.remove(a,b);"function"==typeof c.removeParentStage&&c.removeParentStage(this);return c};this.endMod=function(a){h.DebugSettings.fineGrainedContentValidation&&!a&&f.validateContent()};this.notifyDirty=function(a,b,c,d){f.notifyDirty(a,b,c,d)};this.processDirty=function(){var a=f.getDirtySet(),b=a.getDirtyMaterials();if(a.hasDirtyGeometryRecords()||b){h.DebugSettings.endFrameContentValidation&&
f.validateContent();h.DebugSettings.logDirtySet&&console.log("Dirty set: "+f.getDirtySet().formatDebugInfo(!1));t(0===g[1].length,"Method not implemented for multiple visualizers");var c=a.getAddRemoveUpdateListFilteredByLayers(g[0],!0);(0<c[0].length+c[1].length+c[2].length||b)&&e.modify(c[0],c[1],c[2],b,0);h.DebugSettings.logDirtySet&&(console.log("RGs add: "+c[0].map(function(a){return a.uniqueName})),console.log("RGs remove: "+c[1].map(function(a){return a.uniqueName})));a.getAddRemoveUpdateList(!0);
this._updateViewExtent();a.clearDirtyMaterials();x=!0}};this.processDirtyLayer=function(a){t(0===g[1].length,"Method not implemented for multiple visualizers");var b=f.getDirtySet(),c=b.getDirtyMaterials();a=b.getAddRemoveUpdateListFilteredByLayers([a],!0);(0<a[0].length+a[1].length+a[2].length||c)&&e.modify(a[0],a[1],a[2],c,0);b.clearDirtyMaterials()};this.get=function(a,b){return f.get(a,b)};this.getAll=function(a){return f.getAll(a)};this.addTextureListener=function(a){e.addTextureListener(a)};
this.removeTextureListener=function(a){e.removeTextureListener(a)};this.getContainer=function(){return C};this.getCamera=function(){return e.getCamera()};this.setCamera=function(a){e.setCamera(a)};this.getViewParams=function(a){return e.getViewParams(a)};this.setViewParams=function(a){e.setViewParams(a);void 0!==a.fovX&&this._updateViewExtent();void 0!==a.viewMode&&(e.setLights(f.getAmbientLight(),f.getDirectionalLight()),g=[[],[]])};this.getLayers=function(){return f.getAll(h.ModelContentType.LAYER)};
this.getAmbientLight=function(){return f.getAmbientLight()};this.getDirectionalLight=function(){return f.getDirectionalLight()};this.setAmbientLight=function(a){f.setAmbientLight(a);e.setLights(f.getAmbientLight(),f.getDirectionalLight())};this.setDirectionalLight=function(a){f.setDirectionalLight(a);e.setLights(f.getAmbientLight(),f.getDirectionalLight())};this.getCanvas=function(){return e.getCanvas()};this.setRenderParams=function(a){e.setRenderParams(a)};this.getRenderParams=function(){return e.getRenderParams()};
this.has=function(a){return e.has(a)};this.getViewContent=function(a){return g[a||0].slice(0)};this.setViewContent=function(a,b){b||(b=0);t(0<=b&&b<g.length,"Stage.setViewContent: invalid index");var c=q.array2object(g[b]),d=q.array2object(a),m=q.subtractObjects(d,c),c=q.subtractObjects(c,d);this.processDirty();d=f.getDirtySet();m=d.getResidentRenderGeometriesFilteredByLayers(q.object2array(m));c=d.getResidentRenderGeometriesFilteredByLayers(q.object2array(c));e.modify(m,c,{},b);g[b]=a.slice(0)};
this.addToViewContent=function(a,b){b||(b=0);t(0<=b&&b<g.length,"Stage.addToViewContent: invalid index");for(var c=[],d=0;d<a.length;d++)-1===g[b].indexOf(a[d])&&c.push(a[d]);0<a.length&&(this.processDirty(),d=f.getDirtySet().getResidentRenderGeometriesFilteredByLayers(c),e.modify(d,[],{},b),g[b].push.apply(g[b],c))};this.removeFromViewContent=function(a,b){b||(b=0);t(0<=b&&b<g.length,"Stage.RemoveFromViewContent: invalid index");this.processDirty();for(var c=f.getDirtySet(),d=g[b],m=[],y=0;y<a.length;y++){var h=
d.indexOf(a[y]);-1<h&&(d[h]=d[d.length-1],d.pop(),m.push(a[y]))}c=c.getResidentRenderGeometriesFilteredByLayers(m);e.modify([],c,{},b)};this.getViewFrustumObjects=function(){return e.getFrustumObjects()};this.getLocalOrigin=function(a,b,c){return f.getOrigin(a,b,c)};this.resize=function(){return e.resize()};this.onReady=function(){};this.onRender=function(){};this.onSelectionChange=function(){};this.onGeometryPicked=function(){};this.onViewExtentUpdated=function(){};this.addModelListener=function(a){return f.addModelListener(a)};
this.removeModelListener=function(a){f.removeModelListener(a)};this.addFPSListener=function(a){e.addFPSListener(a)};this.removeFPSListener=function(a){e.removeFPSListener(a)};this.renderScreenshots=function(a,b,c){return e.renderScreenshots(a,b,c)};this.getFrameTask=function(){return e.getFrameTask()};this.requestScreenCapture=function(a,b){e.requestScreenCapture(a,b)};this.getAllTexturesLoaded=function(){return e.getAllTexturesLoaded()};this.getTextureLoaded=function(a){return e.getTextureLoaded(a)};
this.addExternalRenderer=function(a,b){"function"===typeof b.intersect&&n.push(b);return e.addExternalRenderer(a,b)};this.removeExternalRenderer=function(a,b){var c=n.indexOf(b);-1<c&&(n[c]=n[n.length-1],n.pop());return e.removeExternalRenderer(a,b)};this.getContentDebugStrings=function(a){return f.formatDebugInfo(a)};this.getRenderStats=function(){return e.getCombinedStats()};this.getRenderStatString=function(a){var b=this.getRenderStats(),c="";if(a){var c=c+"\x3ctable\x3e",d;for(d in b)c+="\x3ctr\x3e\x3ctd\x3e"+
d+'\x3c/td\x3e\x3ctd style\x3d"text-align: right"\x3e'+Math.round(b[d])+"\x3c/td\x3e\x3c/tr\x3e";c+="\x3c/table\x3e"}else for(d in b)c+=d+": "+b[d]+"\n";return c};this._pick=function(a,b,c,d,f){var g=l.create(),h=l.create();e.getPickRay(a,g,h);return this.pickRay(g,h,a,a,b,c,d,f)}.bind(this);this.pickRayWithBeginPoint=function(a,b,c,d,f){e.pickRayWithBeginPoint(a,b,c,d,f)};var I=F.create(),s=G.create(),A=l.create(),z=new w;this.pickRay=function(a,b,c,d,m,g,h,r){var k;k=d?e.getSideIndexForPoint(d):
0;var l=e.getCamera();c||(c=I,l.projectPoint(b,c));if(m){d=Array(m.length);for(k=0;k<d.length;k++)d[k]=f.get(v.ContentType.LAYER,m[k])}else{d=[];m=this.getViewContent(k);var q=f.getAll(v.ContentType.LAYER);for(k=0;k<m.length;k++){var p=q[m[k]];p&&"VISIBLE"===p.getState()&&d.push(p)}}r?r.init(d,g,a,b,c,l,u,h):r=new w(d,g,a,b,c,l,u,h);for(k=0;k<n.length;k++)n[k].intersect(r,a,b,c);if(r.getHudResults().length){b=r.getHudResults();b.sort(function(a,b){return b.dist-a.dist});b=b[b.length-1];l.projectPoint(b.center,
s);s[0]=Math.round(s[0]);s[1]=Math.round(s[1]);e.getPickRay(s,a,A);z.init(d,g,a,A,s,l,u,!1);for(k=0;k<n.length;k++)n[k].intersect(z,a,A,s);if(null==z.getMinResult().dist||b.dist<=z.getMinResult().dist)r.getMinResult().set(b.object,b.name,b.dist,b.normal,b.priority),r.getMinResult().setIntersector("stage")}return r}.bind(this);var D=new w;D.mode="select";this.getIntersectTolerance=function(){return u};this.setIntersectTolerance=function(a){null==a&&(a=1E-5);u=a};this._select=function(a){var b=this._pick(a,
this.highlightedObjectIds,null,!0,D).getMinResult(),c=b.object;this.onGeometryPicked(c,a,b);if(c&&(a=c.getParentLayer(),c===f.getSelection()||a&&"PICKABLE"!==a.getInteraction())){var d=c.getFaceRangeFromTriangleNr(b.triangleNr);if(null==d||null!=f.getSelectionFaceRange()&&JSON.stringify(d)===JSON.stringify(f.getSelectionFaceRange()))c=void 0}this.selectionState&&this.setSelectionObject(c,!1,d)};this.getViewExtent=function(){var a=Number.MAX_VALUE,a={min:l.create([a,a,a]),max:l.create([-a,-a,-a])},
b=f.getAll(h.ModelContentType.LAYER),c;for(c in b)if(0<b[c].getObjects().length){var d=b[c].getFullExtent();if(void 0!==d)for(var e=0;3>e;++e)a.min[e]=Math.min(a.min[e],d[0][e]),a.max[e]=Math.max(a.max[e],d[1][e])}return a};this._updateViewExtent=function(){var a=null;this.onViewExtentUpdated(function(){null===a&&(a=this.getViewExtent());return a}.bind(this))};this.getTextureGraphicsRenderer=function(){return e.getTextureGraphicsRenderer()};this._getModule=function(a){switch(a){case "model":return f;
case "view":return e;default:return e._getModule(a)}};var C=p,f=new v,e=new E(C,this,f.getDirtySet(),H),g=[[],[]],n=[];e.setLights(f.getAmbientLight(),f.getDirectionalLight());this._debugHideFaceRange=function(a,b){var c=this.getAll("objects")[a];c.hideFaceRange(c.getGeometryRecords()[0],0,[c.getMetadata().faceRanges[b]])};this._debugHideAllFaceRange=function(a){a=this.getAll("objects")[a];for(var b in a.getMetadata().faceRanges)a.hideFaceRange(a.getGeometryRecords()[0],0,[a.getMetadata().faceRanges[b]])};
this._debugUnhideFaceRange=function(a,b){this.getAll("objects")[a].unhideAllFaceRange()};this.registerMaterial=function(a){e.registerMaterial(a)}};h.DebugSettings={fineGrainedContentValidation:!1,endFrameContentValidation:!1,logDirtySet:!1};h.ModelContentType=v.ContentType;return h});