// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/Folders",["dijit","dojo","dojox","dojo/require!dijit/Tree,dijit/Toolbar,dijit/form/Button,dijit/Menu,dijit/_Widget,dijit/_Templated,dojo/cookie,arcgisonline/sharing/util,arcgisonline/sharing/geow/Folder,arcgisonline/sharing/geow/Content,arcgisonline/sharing/geow/Account,arcgisonline/sharing/geow/Community,arcgisonline/sharing/dijit/dialog/FolderDlg,arcgisonline/sharing/dijit/dialog/GeneralDlg"],function(e,a,n){a.provide("arcgisonline.sharing.dijit.Folders");a.require("dijit.Tree");
a.require("dijit.Toolbar");a.require("dijit.form.Button");a.require("dijit.Menu");a.require("dijit._Widget");a.require("dijit._Templated");a.require("dojo.cookie");a.require("arcgisonline.sharing.util");a.require("arcgisonline.sharing.geow.Folder");a.require("arcgisonline.sharing.geow.Content");a.require("arcgisonline.sharing.geow.Account");a.require("arcgisonline.sharing.geow.Community");a.require("arcgisonline.sharing.dijit.dialog.FolderDlg");a.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");
a.declare("arcgisonline.sharing.dijit.Folders",[e._Widget,e._Templated],{filters:{all:{},maps:{},layers:{},scenes:{},apps:{},tools:{},files:{}},maps:{all_maps:{},webmaps:{},mapFiles:{}},scenes:{all_scenes:{},webscenes:{}},layers:{all_layers:{},weblayers:{},layerFiles:{}},weblayers:{all_weblayers:{},features:{},tiles:{},mapservice:{},imagery:{},tables:{}},apps:{all_apps:{},web:{},mobile:{},desktop:{}},files:{all_files:{},document:{},image:{},pdf:{}},folder:arcgisonline.sharing.geow.Folder,content:arcgisonline.sharing.geow.Content,
account:arcgisonline.sharing.geow.Account,community:arcgisonline.sharing.geow.Community,folderDlg:arcgisonline.sharing.dijit.dialog.FolderDlg,util:arcgisonline.sharing.util,widgetsInTemplate:!0,templateString:'\x3cdiv id\x3d"esriWidgetFolders" class\x3d"esriFloatLeading"\x3e\r\n  \x3cul dojoType\x3d"dijit.Menu" id\x3d"tree_menu" style\x3d"display: none;"\x3e\r\n    \x3cli dojoType\x3d"dijit.MenuItem" class\x3d"new-folder-button" class\x3d"calcite transparent" iconClass\x3d"esriNewFolderIcon" dojoAttachEvent\x3d"onClick: createFolder"\x3e${i18n.newFolder}\x3c/li\x3e\r\n    \x3c!--\x3cli dojoType\x3d"dijit.MenuItem" class\x3d"upload-item-button" class\x3d"calcite transparent" iconClass\x3d"esriUploadIcon" dojoAttachEvent\x3d"onClick: addItem"\x3e${i18n.addItem}\x3c/li\x3e--\x3e\r\n    \x3cli dojotype\x3d"dijit.MenuItem" id\x3d"delete-folder-mnu-btn" class\x3d"calcite transparent delete-folder-button" iconClass\x3d"esriFolderDeleteIcon" dojoAttachEvent\x3d"onClick: confirmDelete"\x3e${i18n.deleteFolder}\x3c/li\x3e\r\n  \x3c/ul\x3e\r\n  \x3cdiv class\x3d"folderHeader"\x3e${i18n.folders}\x3c/div\x3e\r\n  \x3cdiv dojotype\x3d"dijit.Toolbar" class\x3d"esriToolbar" style\x3d"overflow:hidden; white-space:nowrap;"\x3e\r\n    \x3cbutton dojotype\x3d"dijit.form.Button" class\x3d"calcite transparent" type\x3d"button" id\x3d"new-folder-btn" iconClass\x3d"esriNewFolderIcon" dojoAttachEvent\x3d"onClick: createFolder"\x3e${i18n.newLabel}\x3c/button\x3e\r\n    \x3cbutton dojoType\x3d"dijit.form.Button" class\x3d"calcite transparent" type\x3d"button" disabled\x3d"true"  class\x3d"delete-folder-button" id\x3d"delete-folder-btn" iconClass\x3d"esriFolderDeleteIcon" dojoAttachEvent\x3d"onClick: confirmDelete"\x3e${i18n.deleteLabel}\x3c/button\x3e\r\n  \x3c/div\x3e\r\n  \x3cdiv id\x3d"_folderTree"\x3e\x3c/div\x3e\r\n  \x3cdiv class\x3d"folderHeader" style\x3d"clear:both;"\x3e${i18n.show}\x3c/div\x3e\r\n  \x3cdiv id\x3d"_filters" style\x3d"overflow:hidden;" class\x3d"esriFloatLeading"\x3e\x3c/div\x3e\r\n  \x3cdiv id\x3d"_subFilters" style\x3d"overflow:hidden;"\x3e\x3c/div\x3e\r\n\x3c/div\x3e \r\n\r\n',
folderPane:null,selectedFolderNode:null,selectedFolderId:"",selectedFolderName:null,folders:null,startupStarted:!1,user:null,contentUser:null,organization:null,isAdmin:!1,accountAdminRole:"account_admin",_rightClickedNode:null,i18n:null,onFilterChange:function(){},postMixInProperties:function(){this.inherited(arguments);this._errorDlg=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();this.i18n=a.i18n.getLocalization("arcgisonline","arcgisonline").common;a.mixin(this.i18n,
a.i18n.getLocalization("arcgisonline","arcgisonline").folders);a.mixin(this.i18n,a.i18n.getLocalization("arcgisonline","arcgisonline").siteHeader);a.mixin(this.i18n,{desktop:a.i18n.getLocalization("arcgisonline","arcgisonline").addItemFrm.desktop})},postCreate:function(){this.loadConnections();this.createFolderPane();this.createFilters()},startup:function(){this.startupStarted||(this.startupStarted=!0,(this.user=this.util.getUser())&&this.user.accountId&&0<this.user.accountId.length?this.account.getSelf(a.hitch(this,
this.handleGetAccount),a.hitch(this,this.handleGetAccount)):this.initialize())},_setRoleFlags:function(){this._roleCanViewUsers=(this._isCustomRole=esriGeowConfig.userRole&&esriGeowConfig.userRole.isCustom())&&esriGeowConfig.userRole.canViewUsers();this._roleCanViewItems=this._isCustomRole&&esriGeowConfig.userRole.canViewOrgItems();this._roleCanUpdateItems=this._isCustomRole&&esriGeowConfig.userRole.canUpdateOrgItems();this._roleCanDeleteItems=this._isCustomRole&&esriGeowConfig.userRole.canDeleteOrgItems();
this._roleCanReassignItems=this._isCustomRole&&esriGeowConfig.userRole.canReassignOrgItems();this._roleCanCreateItem=this._isCustomRole&&esriGeowConfig.userRole.canCreateItem();this._roleCanPublishFeatures=this._isCustomRole&&esriGeowConfig.userRole.canPublishFeatures();this._roleCanPublishTiles=this._isCustomRole&&esriGeowConfig.userRole.canPublishTiles();this._roleCanShareToGroup=this._isCustomRole&&esriGeowConfig.userRole.canShareItemToGroup();this._roleCanShareGroupToOrg=this._isCustomRole&&esriGeowConfig.userRole.canShareItemToOrg();
this._roleCanShareGroupToPublic=this._isCustomRole&&esriGeowConfig.userRole.canShareItemToPublic()},handleGetAccount:function(c){c&&c.id&&c.id===this.user.accountId?(this.organization=c,this.isAdmin=esriGeowConfig.userRole&&esriGeowConfig.userRole.isAdmin(),this._setRoleFlags(),(c=a.queryToObject(window.location.search.slice(1)).user)&&(this.isAdmin||this._roleCanViewUsers&&this._roleCanViewItems)?this.community.getProfile(c,a.hitch(this,this.handleGetContentUser),a.hitch(this.handleGetContentUser)):
(this.isAdmin=!1,this.initialize())):(this.isAdmin=!1,this.initialize())},handleGetContentUser:function(a,b){a&&a.username&&a.orgId&&this.user.accountId===a.orgId&&this.user.email!==a.username?this.contentUser=a:this.isAdmin=!1;this.initialize()},initialize:function(){var c=this.util.getCookie("ESRI_Content");this.selectedFolderId=(!this.isAdmin||!(this._roleCanViewUsers&&this._roleCanViewItems)&&this.contentUser)&&c&&c.folderId||"/";this.selectedFolderId=a.queryToObject(window.location.search.slice(1)).f||
this.selectedFolderId;this.refreshFolders().then(a.hitch(this,function(b){a.publish("folderClicked","/"===this.selectedFolderId?[b]:[this.selectedFolderId,this.selectedFolderName])}));this._isCustomRole&&!this._roleCanCreateItem&&(e.byId("new-folder-btn").set("disabled",!0),e.byId("delete-folder-btn").set("disabled",!0))},createFolderPane:function(){this.folderPane=a.byId("_folderTree")},confirmDelete:function(){var c=e.byId("itemsWidget"),b=arcgisonline.sharing.dijit.dialog.DeleteWarningDlg.prototype.statics.getInstance();
c._getFolderItemCount(this._rightClickedNode||this.selectedFolder).then(a.hitch(this,function(d){var c=a.mixin(this._rightClickedNode||this.selectedFolder,{numItems:d});d=esri.substitute(c,d?this.i18n.deleteItemsNum:this.i18n.deleteMessage);b.showMsg(d,a.hitch(this,"deleteFolder"))}))},deleteFolder:function(){var c=function(){var b=this.util.getCookie("ESRI_Content"),b=a.mixin(b,{folderId:"/"});a.cookie("ESRI_Content",a.json.stringify(b),{path:"/"});this.selectedFolderId="/";this.refreshFolders().then(a.hitch(this,
function(b){this.selectedFolderId="/";this._rightClickedNode=this.selectedFolder=this.selectedFolderName=null;a.publish("folderClicked",[b])}))},b=e.byId("folderTree"),b=this._rightClickedNode||b.lastFocused;this.isAdmin||this._roleCanUpdateItems&&this.contentUser?this.folder.deleteFolderByUser(this.contentUser.username,b.item.id,a.hitch(this,c),a.hitch(this,function(b){b&&b.messageCode&&(b=a.mixin(this.i18n.errors.genericError,{message:this.i18n.errors.deleteProtectedItemsInFolder}),this._errorDlg.show(b))})):
this.folder.deleteFolder(b.item.id,a.hitch(this,c),a.hitch(this,function(b){b&&b.messageCode&&(b=a.mixin(this.i18n.errors.genericError,{message:this.i18n.errors.deleteProtectedItemsInFolder}),this._errorDlg.show(b))}))},createFilters:function(){esriGeowConfig.sceneViewerEnabled||(delete this.filters.scenes,delete this.weblayers.scenelayers);this._buildFilterList("filters",a.byId("_filters"),!0,"filter");this.i18n.apps.desktop=this.i18n.desktop;for(var c in this.filters)this.i18n[c]&&this._buildFilterList(c,
a.byId("_filters"),!1,"subfilter");this._buildFilterList("weblayers",a.byId("_filters"),!1,"subfilter");a.addClass(a.byId("filter_all"),"selected");a.query(".filter a, .subfilter a",this.domNode).connect("onclick",a.hitch(this,function(a){a.preventDefault();var c=a.target.id.split("_")[1],e=a.target.id.split("_")[2];"filter_all_weblayers"===a.target.id&&(c="weblayers");this.onFilterChange(e||c)}));a.query(".subfilter a",this.domNode).connect("onclick",a.hitch(this,function(b){b.preventDefault();a.query(".subfilter .selected",
this.domNode).removeClass("selected");a.addClass(b.target,"selected");("filter_layerFiles"===b.target.id||"filter_all_layers"===b.target.id)&&a.query(".filter_weblayers",this.domNode).style("display","none");"filter_weblayers"===b.target.id&&(a.addClass(a.byId("filter_all_weblayers"),"selected"),a.query(".filter_weblayers",this.domNode).style("display",""))}));a.query(".filter a",this.domNode).connect("onclick",a.hitch(this,function(b){b.preventDefault();var c=b.target.id.split("_")[1],e;a.query(".selected",
this.domNode).removeClass("selected");a.addClass(b.target,"selected");this.i18n.filters[c]&&((e=a.byId("filter_all_"+c))&&a.addClass(a.byId("filter_all_"+c),"selected"),a.query(".subfilter",this.domNode).style("display","none"));a.query("."+b.target.id,this.domNode).style("display","")}))},_buildFilterList:function(c,b,e,k){e="\x3cul class\x3d'filter_"+c+" "+k+(!e?"' style\x3d'display:none;'":"")+"'\x3e";for(var f in this[c])e+="\x3cli class\x3d'"+f+"' \x3e\x3ca href\x3d'#' id\x3d'filter_"+f+"' \x3e"+
this.i18n[c][f]+"\x3c/a\x3e\x3c/li\x3e";a.place(e+"\x3c/ul\x3e",b)},refreshFolders:function(c){var b=new a.Deferred,d=function(c){var f;this.folders=a.clone(c.folders);var g=this.folder.foldersToStore(c.folders);if(null!==g){var d=!1;for(f=0;f<this.folders.length;f++)if(this.folders[f].id===this.selectedFolderId){d=!0;break}d||(this.selectedFolderId="/",d=this.util.getCookie("ESRI_Content"),d=a.mixin(d||{},{folderId:this.selectedFolderId||"/"}),a.cookie("ESRI_Content",a.json.stringify(d),{path:"/"}));
var d=this.util.getUser(),l=null,m=e.byId("folderTree");m&&(l=m.lastSelected,m.destroyRecursive());g=new e.tree.TreeStoreModel({store:g});(this.isAdmin||this._roleCanViewItems&&this._roleCanUpdateItems)&&this.contentUser?this.folder.updateMoveToMenuByUser(this.contentUser.username,this.folders,this.selectedFolderId||"/",this.selectedFolderName,a.hitch(this,"moveItem")):this.folder.updateMoveToMenu(this.folders,this.selectedFolderId||"/",this.selectedFolderName,a.hitch(this,"moveItem"));var h=new e.Tree({id:"folderTree",
model:g,style:{"overflow-x":"hidden"},label:((this.isAdmin||this._roleCanViewUsers&&this._roleCanViewItems)&&this.contentUser?this.contentUser.username:d.email)+" ("+this.i18n.home_link+")",persist:!1,_nodePixelIndent:0,getIconClass:function(a,b){return"customTreeIcon"},onClick:a.hitch(this,function(b,c){var d=c.getParent()===c.tree?null:b.id.toString(),f=null===c.getParent()?null:b.title;a.publish("folderClicked",[d,f]);a.query(".selected",this.domNode).removeClass("selected");a.addClass(a.byId("filter_all"),
"selected");a.query(".subfilter",this.domNode).style("display","none");if(!this.isAdmin||!this._isCustomRole||(!this._roleCanViewUsers||!this._roleCanViewItems)&&this.contentUser)if(a.cookie("ESRI_Content")){var g=this.util.getCookie("ESRI_Content");a.mixin(g,{folderId:d});a.cookie("ESRI_Content",a.json.stringify(g),{path:"/"})}else a.cookie("ESRI_Content",a.json.stringify({folderId:d}),{path:"/"});e.byId("delete-folder-btn").set("disabled",null===d);g=e.byId("folderTree");this.selectedFolder&&this.selectedFolder!==
c&&this.selectedFolder.setSelected(!1);this.selectedFolder=c||g.rootNode;this.selectedFolderId=d;this.selectedFolderName=f}),onKeyUp:a.hitch(this,function(){e.byId("delete-folder-btn").set("disabled",void 0===e.byId("folderTree").lastFocused.getParent())})},a.create("div",{},a.byId("_folderTree")));a.connect(h,"onLoad",a.hitch(this,function(){var d=a.getContentBox(h.domNode),g=d.h+500;a.style(e.byId("main-content").domNode,{"min-height":825>g?"825px":d.h+500+"px"});e.byId("main-content").resize();
b.resolve(c);d=e.byId("tree_menu");d.selector=".dijitTreeNode";d.bindDomNode(h.domNode);a.connect(d,"_openMyself",this,function(b){b=e.getEnclosingWidget(b.target);null===b.getParent()?a.addClass(a.byId("delete-folder-mnu-btn"),"hide"):a.removeClass(a.byId("delete-folder-mnu-btn"),"hide");this._rightClickedNode=b});if(0<this.selectedFolderId.length&&"/"!==this.selectedFolderId&&(null===l||!l)){d=h.rootNode.getChildren();for(f=0;f<d.length;f++)if(d[f].item.id[0]===this.selectedFolderId){l=h.rootNode.getChildren()[f];
this.selectedFolderName=h.rootNode.getChildren()[f].item.title;this.selectedFolder=h.rootNode.getChildren()[f];this.selectedFolder.setSelected(!0);h.focusNode(this.selectedFolder);break}}else this.selectedFolderName="",this.selectedFolder=h.rootNode,this.selectedFolder.setSelected(!0),h.focusNode(this.selectedFolder);e.byId("delete-folder-btn").set("disabled",""===this.selectedFolderName)}))}};(this.isAdmin||this._roleCanViewUsers&&this._roleCanViewItems)&&this.contentUser?this.folder.getFoldersByUser(this.contentUser.username,
a.hitch(this,d),!c&&"/"===this.selectedFolderId):this.folder.getFolders(a.hitch(this,d),!c&&"/"===this.selectedFolderId);return b},selectedGridItems:function(){var c=[],b=new a.Deferred,d=e.byId("contentNode")._grid,k=d&&d.store;if(d)for(var f in d.selection)d.selection[f]&&c.push(k.get(f));b.resolve(c);return b},moveItem:function(c){this.selectedGridItems().then(a.hitch(this,function(b){if(null===b||0>=b.length)return this._errorMessage(this.i18n.selectItemMove);var d=function(b){var c;b&&(b.results&&
b.results.length)&&(c=a.filter(b.results,function(a){return!1===a.success}));c.length&&k(c[0].error);c.length!==b.results.length&&(a.publish("folderClicked",[this.selectedFolderId,this.selectedFolderName]),b=e.byId("folderTree"),b.focusNode(this.selectedFolder||b.rootNode))},k=a.hitch(this,function(a){var b=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();a.message&&-1<a.message.indexOf("already exists")?b.show({title:this.i18n.moveError,message:this.i18n.itemAlready}):
(b.show({title:this.i18n.moveError,message:this.i18n.errorInMoving}),console.log(a.message))}),f={folder:c.id};this.isAdmin||this._roleCanViewItems&&this._roleCanUpdateItems&&this.contentUser?this.content.moveItemsByUser(this.contentUser.username,b,f,a.hitch(this,d),k):this.content.moveItems(b,f,a.hitch(this,d),k)}))},loadConnections:function(){a.subscribe("folderClicked",this,"refreshMoveToMenu");a.subscribe("refreshFolders",this,"refreshFolders")},addItem:function(){if(null!==this._rightClickedNode){var c=
this._rightClickedNode,b=c.item;a.publish("addItemInFolder",[null===c.getParent()?null:b.id,b.title])}},createFolder:function(){var a=this._folderDlg||new this.folderDlg({});this._folderDlg=a;this.isAdmin||this._roleCanUpdateItems&&this.contentUser?a.show(this.folders,this.contentUser):a.show(this.folders)},refreshMoveToMenu:function(c,b){this.isAdmin||this._roleCanUpdateItems&&this.contentUser?this.folder.updateMoveToMenuByUser(this.contentUser.username,this.folders,c,b,a.hitch(this,"moveItem")):
this.folder.updateMoveToMenu(this.folders,c,b,a.hitch(this,"moveItem"))}})});