// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("esri/core/declare dojo/_base/lang dojo/dom-construct dojo/dom-class dojo/on dijit/form/ValidationTextBox ./WebSceneEditorPaneBase esri/widgets/Tags dojo/Deferred ../../widgets/Switch/Switch ../../basemapUtils esri/views/3d/support/canvas3dUtils dojo/i18n!../nls/editor".split(" "),function(q,k,c,l,g,m,r,s,t,n,h,u,e){function p(a,b,d,c){a.set("value",d.get(b));a.initialSetup=!0;g(a,"change",function(a){null==a||""===a?this.set("value",d.get(b)):d.set(b,a);this.initialSetup?this.initialSetup=
!1:c.setWebSceneChanged()});d.watch(b,function(b){a.set("value",b)})}return q(r,{thumbnailFileObject:void 0,_onHandles:void 0,constructor:function(){k.mixin(this,{id:"properties",title:e.panes.properties,actionButton:{title:e.buttons.done,action:"_navBackBtnNodeClickHandler"}});this._onHandles=[];this._updateContent()},destroy:function(){this._onHandles.forEach(function(a){a.remove()});this._onHandles.length=0},_updateThumbnail:function(){var a=this.editor.webScene;if(a.portalItemProperties&&a.portalItemProperties._thumbnailFileObject)this.thumbnailFileObject=
a.portalItemProperties._thumbnailFileObject,this.thumbnailImage.src=this.thumbnailFileObject.dataURI;else if(a.portalItemProperties.thumbnailUrl){var b=a.portalItemProperties.thumbnailUrl;try{if("public"!==a.portalItemProperties.access&&-1===b.indexOf("token\x3d")&&this.editor.portal&&this.editor.portal.isSignedIn()){var d=this.editor.portal.getPortalUser().credential.token;a.portalItemProperties.thumbnailUrl+="?token\x3d"+d}}catch(c){}this.thumbnailImage.src=a.portalItemProperties.thumbnailUrl;this.thumbnailFileObject=
void 0}else this.editor.view&&this._requestThumbnail(this.editor.view).then(function(a){this.thumbnailFileObject=a;this.thumbnailImage.src=a.dataURI}.bind(this))},_updateContentThumbnail:function(a){var b=c.create("tr",{},a);a=c.create("td",{className:"topAlignment"},b);b=c.create("td",{},b);c.create("h3",{className:"paneSectionTitle",title:e.sceneProperties.thumbnail},a).textContent=e.sceneProperties.thumbnail;a=c.create("div",{className:"thumbnailContainer"},b);this.thumbnailImage=c.create("img",
{className:"scenePropertiesInput","data-dojo-attach-point":"thumbnailBox",id:"${id}_thumbnailBox","data-dojo-props":"required: true"},a);a=c.create("div",{className:"iconRefreshContainer",title:e.sceneProperties.updateThumbnail},a);c.create("div",{className:"iconRefresh"},a);g(a,"click",function(){this._thumbnailUpdateClickHandler()}.bind(this))},_updateContentTitle:function(a,b){var d=c.create("tr",{className:"separator"},a),f=c.create("td",{},d),d=c.create("td",{},d);c.create("h3",{className:"paneSectionTitle",
title:e.sceneProperties.title},f).textContent=e.sceneProperties.title;this._titleTextBox=new m({className:"paneTextBox",placeHolder:e.sceneProperties.placeholderEnterTitle,required:!0,trim:!0,maxLength:60});this._titleTextBox.invalidMessage=e.saveDialog.invalidTitle;this._titleTextBox.validator=function(a){return this._validateTitle(a)}.bind(this);p(this._titleTextBox,"title",b,this.editor);this._titleTextBox.placeAt(d)},_updateContentSummary:function(a,b){var d=c.create("tr",{className:"separator"},
a),f=c.create("td",{},d),d=c.create("td",{},d);c.create("h3",{className:"paneSectionTitle",title:e.sceneProperties.summary},f).textContent=e.sceneProperties.summary;this._descriptionTextBox=new m({className:"paneTextBox",placeHolder:e.sceneProperties.placeholderEnterSummary,value:b.portalItemProperties.description,required:!1,maxLength:250});this._descriptionTextBox.invalidMessage=e.saveDialog.invalidSummary;this._descriptionTextBox.validator=function(a){return this._validateTitle(a)}.bind(this);
p(this._descriptionTextBox,"snippet",b,this.editor);this._descriptionTextBox.placeAt(d)},_updateContentTags:function(a,b){var d=c.create("tr",{className:"separator"},a),f=c.create("td",{},d),d=c.create("td",{},d);c.create("h3",{className:"paneSectionTitle",title:e.sceneProperties.tags},f).textContent=e.sceneProperties.tags;this._tagsWidget=new s({minWidth:"220px",maxWidth:"220px",placeHolder:e.sceneProperties.placeholderEnterTags});this._tagsWidget.startup();this._tagsWidget.placeAt(d);this.initialTagsSetup=
!1;this._onHandles.push(g(this._tagsWidget,"tags-add",function(a){this.initialTagsSetup||(this.editor.setWebSceneChanged(),b.set("tags",this._tagsWidget.get("value")))}.bind(this)));this._onHandles.push(g(this._tagsWidget,"tags-remove",function(a){this.editor.setWebSceneChanged();b.set("tags",this._tagsWidget.get("value"))}.bind(this)))},_updateContentElevation:function(a){var b=c.create("tr",{className:"separator"},a);a=c.create("td",{className:"topAlignment"},b);b=c.create("td",{},b);c.create("h3",
{className:"paneSectionTitle",title:e.sceneProperties.elevation},a).textContent=e.sceneProperties.elevation;a=k.exists("editor.map.basemap.elevationLayers",this)?0<this.editor.map.basemap.elevationLayers.length:!0;this._elevationSwitch=new n({switchOn:a});this._onHandles.push(g(this._elevationSwitch,"toggle",function(a){a.on?h.turnOnElevation(this.editor.map):h.turnOffElevation(this.editor.map);this.editor.setWebSceneChanged()}.bind(this)));this._elevationSwitch.placeAt(b);this._elevationSwitch.startup();
this._elevationWarningContainer=c.create("div",{className:"elevationWarning hide"},b);this._elevationWarningIcon=c.create("div",{className:"warningIcon"},this._elevationWarningContainer);this._elevationWarning=c.create("div",{className:"shareMessageText"},this._elevationWarningContainer);this._elevationWarning.innerHTML=e.sceneProperties.elevationUnsupported;k.exists("editor.view.basemapTerrain.tilingScheme",this)&&this._compareElevationWithMapSR();this._onHandles.push(this.editor.view.watch("basemapTerrain.tilingScheme",
function(){this._compareElevationWithMapSR()}.bind(this)))},_compareElevationWithMapSR:function(){try{h._checkDefaultElevationCompatibility(this.editor.view),this._elevationSwitch.enable(),l.add(this._elevationWarningContainer,"hide")}catch(a){this._elevationSwitch.turnOff(),h.turnOffElevation(this.editor.map),this._elevationSwitch.disable(),this._elevationSwitch.SwitchContainer.title=e.sceneProperties.elevationUnsupported,l.remove(this._elevationWarningContainer,"hide")}},_updateContentClipping:function(a,
b){var d=c.create("tr",{className:"separator"},a),f=c.create("td",{className:"topAlignment"},d),d=c.create("td",{},d);c.create("h3",{className:"paneSectionTitle",title:e.sceneProperties.clipping},f).textContent=e.sceneProperties.clipping;this._clippingSwitch=new n({switchOn:b.clippingArea?b.clippingArea.clip:!1,className:"extent switch"});this._onHandles.push(g(this._clippingSwitch,"toggle",function(a){a.on?(b.clippingArea=!b.clippingArea?{geometry:this.editor.view.extent}:b.clippingArea,this.editor.view.clippingArea=
b.clippingArea.geometry,b.clippingArea.clip=!0,b.clippingArea.geometry.intersects(this.editor.view.extent)||this.editor.view.animateTo(b.clippingArea.geometry)):(this.editor.view.clippingArea=null,b.clippingArea.clip=!1);this.editor.setWebSceneChanged()}.bind(this)));this._clippingSwitch.placeAt(d);this._clippingSwitch.startup();f=c.create("div",{className:"updateClippingExtentLink"},d);d=c.create("div",{className:"iconContainer",title:e.sceneProperties.currentView},f);c.create("div",{className:"iconRefresh"},
d);c.create("div",{className:"clippingText"},f).textContent=e.sceneProperties.currentView;this._onHandles.push(g(f,"click",function(){this.editor.view.clippingArea=this.editor.view.extent.clone();b.clippingArea=!b.clippingArea?{geometry:this.editor.view.extent}:b.clippingArea;b.clippingArea.geometry=this.editor.view.extent.clone();b.clippingArea.clip=!0;this._clippingSwitch.turnOn()}.bind(this)))},_updateContent:function(){var a=c.create("div",{className:"webScenePropertiesPane"});if(null==this.editor.webScene)c.place("\x3cp\x3einitialization problem\x3c/p\x3e",
a);else{var b=this.editor.webScene,d=c.create("table",{className:"propertiesTable"},a);this._updateContentThumbnail(d);this._updateContentTitle(d,b);this._updateContentSummary(d,b);this._updateContentTags(d,b);this._updateContentElevation(d);"planar"===this.editor.view.globeMode&&this._updateContentClipping(d,b);this.editor.view.watch("globeMode",function(a){"planar"===a&&this._updateContentClipping(d,b)}.bind(this))}this._addToContentNode(a)},_thumbnailUpdateClickHandler:function(){this._requestThumbnail(this.editor.view).then(function(a){this.thumbnailFileObject=
a;this.thumbnailImage.src=a.dataURI;this.editor.webScene.portalItemProperties._thumbnailFileObject=this.thumbnailFileObject}.bind(this));this.editor.setWebSceneChanged()},_requestThumbnail:function(a){var b=new t;a.takeScreenshot({format:"jpeg",quality:80,width:200,height:133}).then(function(a){b.resolve({data:u.dataURItoBlob(a.dataURL),identifier:"thumbnail",name:"thumbnail",dataURI:a.dataURL})},b.reject);return b},onPaneSelected:function(){this._updateThumbnail();this.editor.portal&&this.editor.portal.getPortalUser().getTags().then(function(a){this._tagsWidget.set("knownTags",
a);this.editor.webScene.portalItemProperties&&(this.initialTagsSetup=!0,this._tagsWidget.set("value",this.editor.webScene.portalItemProperties.tags),this.initialTagsSetup=!1)}.bind(this),function(a){console.error(a)});this.editor.webScene.portalItemProperties&&(this._titleTextBox.set("value",this.editor.webScene.portalItemProperties.title),this._descriptionTextBox.set("value",this.editor.webScene.portalItemProperties.snippet),this.initialTagsSetup=!0,this._tagsWidget.set("value",this.editor.webScene.portalItemProperties.tags),
this.initialTagsSetup=!1);this.editor.webScene&&this._clippingSwitch&&this.editor.webScene.clippingArea&&(this.editor.webScene.clippingArea.clip?this._clippingSwitch.turnOn():this._clippingSwitch.turnOff())},_navBackBtnNodeClickHandler:function(){var a=this.editor.webScene;if(a.portalItemProperties&&!a.portalItemProperties._thumbnailFileObject&&!a.portalItemProperties.thumbnailUrl||!a.portalItemProperties)a.portalItemProperties._thumbnailFileObject=this.thumbnailFileObject,this.thumbnailFileObject.dataURI=
this.thumbnailImage.src,this.editor.webScene.portalItemProperties._thumbnailFileObject=this.thumbnailFileObject,this.editor.setWebSceneChanged();this.inherited(arguments)},_validateTitle:function(a){return-1!==a.indexOf("\x3e")||-1!==a.indexOf("\x3c")?!1:!0}})});