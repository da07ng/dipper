// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/SignUpInternal",["dijit","dojo","dojox","dojo/require!dijit/_Widget,dijit/_Templated,dijit/form/Button,dijit/form/ValidationTextBox,dojo/data/ItemFileReadStore,arcgisonline/sharing/util,arcgisonline/sharing/dijit/dialog/GeneralDlg,arcgisonline/sharing/geow/Account,arcgisonline/sharing/geow/Geow"],function(l,b,n){b.provide("arcgisonline.sharing.dijit.SignUpInternal");b.require("dijit._Widget");b.require("dijit._Templated");b.require("dijit.form.Button");b.require("dijit.form.ValidationTextBox");
b.require("dojo.data.ItemFileReadStore");b.require("arcgisonline.sharing.util");b.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");b.require("arcgisonline.sharing.geow.Account");b.require("arcgisonline.sharing.geow.Geow");b.declare("arcgisonline.sharing.dijit.SignUpInternal",[l._Widget,l._Templated],{util:arcgisonline.sharing.util,geow:arcgisonline.sharing.geow.Geow,widgetsInTemplate:!0,templateString:'\x3cdiv class\x3d"widgetContent"\x3e\r\n  \x3cdiv id\x3d"sign-up-form" class\x3d"newStyles grid-50"\x3e\r\n    \x3c!--\x3ch1\x3e${i18n.signUpInternalTitle}\x3c/h1\x3e--\x3e\r\n    \x3cbr/\x3e\x3cdiv id\x3d"register-error"\x3e\x3c/div\x3e\r\n    \x3cform data-dojo-type\x3d"dijit.form.Form" id\x3d"signup-form" method\x3d"POST" action\x3d""\x3e\r\n      \x3cp\x3e${i18n.enterAccountInfo}\x3c/p\x3e\r\n      \x3c!--\x3cdiv class\x3d"formBlock"\x3e--\x3e\r\n        \x3c!--\x3clabel class\x3d"requiredLabel" for\x3d"register_fullname"\x3e${i18n.fullNameLabel}\x3c/label\x3e--\x3e\r\n        \x3c!--\x3cinput id\x3d"register_fullname" name\x3d"register_fullname" data-dojo-attach-point\x3d"_fullname" data-dojo-type\x3d"dijit.form.TextBox" data-dojo-props\x3d"trim:true"/\x3e--\x3e\r\n      \x3c!--\x3c/div\x3e--\x3e\r\n      \x3cdiv class\x3d"formBlock" id\x3d"first-name-block"\x3e\r\n        \x3clabel class\x3d"requiredLabel" for\x3d"register_firstname"\x3e${i18n.firstNameLabel}\x3c/label\x3e\r\n        \x3cinput id\x3d"register_firstname" name\x3d"register_firstname" data-dojo-attach-point\x3d"_firstname" data-dojo-type\x3d"dijit.form.TextBox" data-dojo-props\x3d"trim:true"/\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"formBlock" id\x3d"last-name-block"\x3e\r\n        \x3clabel class\x3d"requiredLabel" for\x3d"register_lastname"\x3e${i18n.lastNameLabel}\x3c/label\x3e\r\n        \x3cinput id\x3d"register_lastname" name\x3d"register_lastname" data-dojo-attach-point\x3d"_lastname" data-dojo-type\x3d"dijit.form.TextBox" data-dojo-props\x3d"trim:true"/\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"formBlock"\x3e\r\n        \x3clabel class\x3d"requiredLabel" for\x3d"register_email"\x3e${i18n.currentEmailAdr}\x3c/label\x3e\r\n        \x3cinput id\x3d"register_email" name\x3d"register_email" data-dojo-attach-point\x3d"_email" data-dojo-type\x3d"dijit.form.TextBox" data-dojo-props\x3d"trim:true"/\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"formBlock"\x3e\r\n        \x3clabel class\x3d"requiredLabel" for\x3d"confirm_register_email"\x3e${i18n.confirmEmailAdr}\x3c/label\x3e\r\n        \x3cinput id\x3d"confirm_register_email" name\x3d"confirm_register_email" data-dojo-attach-point\x3d"_confirmEmail" data-dojo-type\x3d"dijit.form.TextBox" data-dojo-props\x3d"trim:true"/\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"formBlock"\x3e\r\n        \x3clabel class\x3d"requiredLabel" for\x3d"register_username"\x3e${i18n.yourUserName}\x3c/label\x3e\r\n        \x3cinput id\x3d"register_username" name\x3d"register_username" data-dojo-attach-point\x3d"_username" data-dojo-type\x3d"dijit.form.TextBox" data-dojo-attach-event\x3d"onChange:onUsernameChange" data-dojo-props\x3d"trim:true"/\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"formBlock"\x3e\r\n        \x3clabel class\x3d"requiredLabel" for\x3d"register_password"\x3e${i18n.choosePwd}\x3c/label\x3e\r\n        \x3cinput id\x3d"register_password" name\x3d"register_password" data-dojo-attach-point\x3d"_pwd" type\x3d"password" data-dojo-type\x3d"dijit.form.TextBox" data-dojo-props\x3d"trim:true"/\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"formBlock"\x3e\r\n        \x3clabel class\x3d"requiredLabel" for\x3d"register_password2"\x3e${i18n.renterPwd}\x3c/label\x3e\r\n        \x3cinput id\x3d"register_password2" name\x3d"register_password2" data-dojo-attach-point\x3d"_verifyPwd" type\x3d"password" data-dojo-type\x3d"dijit.form.TextBox" data-dojo-props\x3d"trim:true"/\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"formBlock"\x3e\r\n        \x3clabel class\x3d"requiredLabel" for\x3d"identity_question"\x3e${i18n.identityQLabel}\x3c/label\x3e\r\n        \x3cdiv id\x3d"identity_question" data-dojo-attach-point\x3d"_identityQuestion" data-dojo-type\x3d"dijit.form.ComboBox"\r\n             data-dojo-attach-event\x3d"onChange:onIdentityQuestionChange" style\x3d"width:350px;margin-left:0;margin-right:0;"\r\n             data-dojo-props\x3d"trim:true"\x3e\x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"formBlock"\x3e\r\n        \x3clabel class\x3d"requiredLabel" for\x3d"identity_answer"\x3e${i18n.identityALabel}\x3c/label\x3e\r\n        \x3cinput id\x3d"identity_answer" data-dojo-attach-point\x3d"_identityAnswer" data-dojo-type\x3d"dijit.form.TextBox" data-dojo-props\x3d"trim:true"/\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"bottom-buttons"\x3e\r\n        \x3cbutton id\x3d"button_create_account" class\x3d"calcite blue" type\x3d"submit" data-dojo-attach-point\x3d"_createAccountBtn" data-dojo-type\x3d"dijit.form.Button"\x3e${i18n.createAcc}\x3c/button\x3e\r\n        \x3cbutton id\x3d"button_cancel" class\x3d"calcite transparent" type\x3d"button" data-dojo-attach-event\x3d"onClick:onCancel" data-dojo-type\x3d"dijit.form.Button"\x3e${i18n.cancel}\x3c/button\x3e\r\n      \x3c/div\x3e\r\n    \x3c/form\x3e\r\n  \x3c/div\x3e\r\n\x3c/div\x3e\r\n',
redirectUrl:esriGeowConfig.baseUrl.replace("https:","http:")+"index.html",orgRedirectUrl:esriGeowConfig.baseUrl.replace("https:","http:")+"organization.html",isValidUsername:!1,invitation:null,invitationOrgName:null,identityQuestions:null,accountMode:"arcgis",i18n:null,postMixInProperties:function(){this.inherited(arguments);this.i18n=b.mixin({},b.i18n.getLocalization("arcgisonline","arcgisonline").common);b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").signUpInternalWidget);
this.i18n.securityQuestions=b.i18n.getLocalization("arcgisonline","arcgisonline").securityQuestions;var a=b.i18n.getLocalization("arcgisonline","arcgisonline").organizationInvite.step2Create.invalid;this.i18n.invalid={usernameTooShort:a.usernameTooShort,usernameTooLong:a.usernameTooLong,usernameInvalidChars:a.usernameInvalidChars}},postCreate:function(){esriGeowConfig.passwordPolicyEnabled&&this.getPasswordPolicy()},startup:function(){this.inherited(arguments);b.mixin(this,b.queryToObject(window.location.search.slice(1)));
esri.config.defaults.io.proxyUrl=esriGeowConfig.proxyServer;this._svcUrl=esriGeowConfig.restBaseUrl+(esriGeowConfig.restBaseUrl.lastIndexOf("/")===esriGeowConfig.restBaseUrl.length-1?"":"/");this._communityUri=this._svcUrl+"community/";b.attr(b.byId("registerYour"),"innerHTML",this.i18n.signUpInternalTitle);this.setupQuestions();this.loadConnections();this.checkInvitation();setTimeout(b.hitch(this,function(){this._firstname.focus()}),50);b.subscribe("registerUser",this,"registerUser");this.adjustNameRows()},
adjustNameRows:function(){"ja"===b.locale&&b.place(b.byId("first-name-block"),b.byId("last-name-block"),"after")},setupQuestions:function(){this.identityQuestions=[{id:1,name:this.i18n.securityQuestions[1]},{id:2,name:this.i18n.securityQuestions[2]},{id:3,name:this.i18n.securityQuestions[3]},{id:4,name:this.i18n.securityQuestions[4]},{id:5,name:this.i18n.securityQuestions[5]},{id:6,name:this.i18n.securityQuestions[6]},{id:7,name:this.i18n.securityQuestions[7]},{id:8,name:this.i18n.securityQuestions[8]},
{id:9,name:this.i18n.securityQuestions[9]},{id:10,name:this.i18n.securityQuestions[10]},{id:11,name:this.i18n.securityQuestions[11]},{id:12,name:this.i18n.securityQuestions[12]},{id:13,name:this.i18n.securityQuestions[13]},{id:14,name:this.i18n.securityQuestions[14]}];this._identityQuestion.set("store",new b.data.ItemFileReadStore({data:{identifier:"name",label:"id",items:this.identityQuestions}}));this._identityQuestion.set("value",this.i18n.securityQLabel)},loadConnections:function(){b.connect(l.byId("signup-form"),
"onSubmit",this,"signUp")},getPasswordPolicy:function(){this.util.request({url:this.util.getSecureUrl(esriGeowConfig.restBaseUrl)+"portals/self/securityPolicy/passwordPolicy"}).then(b.hitch(this,function(a){this._passwordPolicy=a&&!a.code&&!a.messageCode?a:null}))},checkInvitation:function(){this.invitation&&this._fetchInvitation().then(b.hitch(this,function(a){this.invitationOrgName=a.account.name}))},signIn:function(a,g){esriGeowConfig.self=null;arcgisonline.sharing.geow.Account.getSelf(b.hitch(this,
this.routeUser))},routeUser:function(a,g){var c=this.util.getUser(),e=b.queryToObject(window.location.search.slice(1)).returnUrl;if(a&&!a.code&&!a.message){var h=a.allSSL,f=arcgisonline.sharing.util.usePortalSSL();this.redirectUrl=arcgisonline.sharing.util.getHttpUrl()+"index.html";this.orgRedirectUrl=arcgisonline.sharing.util.getHttpUrl()+"organization.html";e?(f=!!(-1<e.indexOf("https:")),window.location=h||f?arcgisonline.sharing.util.getSecureUrl(e):e):window.location="account_admin"===c.role?
h||f?arcgisonline.sharing.util.getSecureUrl()+"organization.html":this.orgRedirectUrl:h||f?arcgisonline.sharing.util.getSecureUrl()+"index.html":this.redirectUrl}else window.location=null!==e?e:arcgisonline.sharing.util.getHttpUrl()+"user.html?newUser\x3dtrue"},signUp:function(a){a.preventDefault();b.query("#register-error")&&(b.byId("register-error").innerHTML="",b.removeClass("register-error","error"));!1!==this.validateForm()&&(this._createAccountBtn.set("disabled",!0),this._createAccountBtn.set("label",
this.i18n.creatingAcc),this.registerUser(!0))},onUsernameChange:function(a){arcgisonline.sharing.geow.Account.checkUsernames([a],b.hitch(this,this._handleCheckUsername),b.hitch(this,this._handleCheckUsername))},_handleCheckUsername:function(a){this.isValidUsername=!1;if(a&&!a.code&&!a.message){if(a.usernames&&0<a.usernames.length){var b=this._username.get("value");b!==a.usernames[0].suggested?(b=arcgisonline.sharing.util.getSecureUrl(esriGeowConfig.baseUrl),a=esri.substitute({username:a.usernames[0].requested,
linkStart:"\x3cspan class\x3d'esriItemLinks'\x3e\x3ca href\x3d'"+b+esriGeowConfig.signin+window.location.search+"'\x3e",linkEnd:"\x3c/a\x3e\x3c/span\x3e"},this.i18n.error.usernameInUse),this.showError(a)):(this.isValidUsername=!0,this.clearError())}}else a.messageCode&&"DB_0006"===a.messageCode?this.showError(this.i18n.error.restrictedCharacters):b?this.showError(this.i18n.error.checkingUsername):(console.log("error checking usernames",a),this.isValidUsername=!0,this.clearError())},onIdentityQuestionChange:function(a){var g=
this._identityQuestion.get("store"),c;g.fetch({onComplete:b.hitch(this,function(b){for(c=0;c<b.length;c++)if(a==g.getValue(b[c],"name")){this._identityQuestionID=g.getValue(b[c],"id");break}})})},onCancel:function(a){a=esriGeowConfig.baseUrl.replace("http:","https:")+esriGeowConfig.signin;this.invitation&&(a+="?invitation\x3d"+this.invitation);window.location=a},usernameContainsAlphaNumeric:function(a){var b=/^[a-zA-Z0-9@_\.]+$/g;return a&&!!b.test(a)},validateForm:function(){var a=this._firstname.get("value"),
b=this._lastname.get("value"),c=this._email.get("value"),e=this._confirmEmail.get("value"),h=this._username.get("value"),f=this._pwd.get("value"),k=this._verifyPwd.get("value"),m=this._identityAnswer.get("value"),d=[];(!esri.isDefined(a)||""===a)&&d.push(this.i18n.error.firstNameReqd);(!esri.isDefined(b)||""===b)&&d.push(this.i18n.error.lastNameReqd);(!esri.isDefined(c)||""===c)&&d.push(this.i18n.error.emailReqd);!esri.isDefined(e)||""===e?d.push(this.i18n.error.confirmEmailReqd):c!==e&&d.push(this.i18n.error.confirmEmailNoMatch);
!esri.isDefined(h)||""===h?d.push(this.i18n.error.userReqd):6>h.length?d.push(this.i18n.invalid.usernameTooShort):128<h.length?d.push(this.i18n.invalid.usernameTooLong):this.usernameContainsAlphaNumeric(h)?this.isValidUsername||d.push(esri.substitute({username:h,linkStart:"\x3cspan class\x3d'esriItemLinks'\x3e\x3ca href\x3d'"+arcgisonline.sharing.util.getSecureUrl(esriGeowConfig.baseUrl)+esriGeowConfig.signin+window.location.search+"'\x3e",linkEnd:"\x3c/a\x3e\x3c/span\x3e"},this.i18n.error.usernameInUse)):
d.push(this.i18n.invalid.usernameInvalidChars);!esri.isDefined(f)||""===f?d.push(this.i18n.error.passReqd):esriGeowConfig.passwordPolicyEnabled&&this._passwordPolicy?(a=this.util.meetsPasswordPolicyStrength(this._passwordPolicy,f),a.meetsRequirements()||(a.minLength||d.push(esri.substitute({num:this._passwordPolicy.minLength},this.i18n.error.passwordLength)),a.minLetter||d.push(esri.substitute({num:this._passwordPolicy.minLetter},this.i18n.error.passwordLetter)),a.minUpper||d.push(esri.substitute({num:this._passwordPolicy.minUpper},
this.i18n.error.passwordUpper)),a.minLower||d.push(esri.substitute({num:this._passwordPolicy.minLower},this.i18n.error.passwordLower)),a.minDigit||d.push(esri.substitute({num:this._passwordPolicy.minDigit},this.i18n.error.passwordDigit)),a.minOther||d.push(esri.substitute({num:this._passwordPolicy.minOther},this.i18n.error.passwordOther)))):(8>f.length||28<f.length)&&d.push(this.i18n.error.invalidPassword);f!==k&&d.push(this.i18n.error.passwordsNotMatch);(!this._identityQuestionID||1>this._identityQuestionID)&&
d.push(this.i18n.error.questionSelection);(!esri.isDefined(m)||""===m)&&d.push(this.i18n.error.answerIsBlank);60<m.length&&d.push(this.i18n.error.answerTooLong);if(0===d.length)return!0;f="";for(k=0;k<d.length;k++)f+=d[k],f+="\x3cbr/\x3e";arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.notice,message:f});return!1},registerUser:function(a){a=this._firstname.get("value");var g=this._lastname.get("value"),c=this._email.get("value"),e=this._username.get("value"),
h=this._pwd.get("value"),f=this._identityAnswer.get("value"),k={fullname:"ja"===b.locale?g+" "+a:a+" "+g,firstname:a,lastname:g,email:c,username:e,password:h,securityQuestionIdx:this._identityQuestionID,securityAnswer:f};this.invitation&&(k.invitationId=this.invitation,k.provider=this.accountMode);this.geow.signup(k,b.hitch(this,function(a,c){null!=a.error&&""!==a.error?(this._createAccountBtn.set("disabled",!1),this._createAccountBtn.set("label",this.i18n.createAcc),a.error.messageCode&&"COM_1054"===
a.error.messageCode?arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:this.i18n.errorTitle,message:this.i18n.error.maxUsers}):this.errorHandler(a,c)):this.invitation?this.geow.signInHandler(k.username,b.hitch(this,"acceptInvitation",k),b.hitch(this,"signInError"),a,c):this.geow.signInHandler(k.username,b.hitch(this,"signIn"),b.hitch(this,"signInError"),a,c)}),b.hitch(this,"signUpError"))},acceptInvitation:function(a,g,c){arcgisonline.sharing.geow.Account.acceptInvitation(this.invitation,
b.hitch(this,function(){this.geow.signin({username:a.username,password:a.password,expiration:esriGeowConfig.tokenExpiration},b.hitch(this,"signIn"),b.hitch(this,"signInError"))}),b.hitch(this,this.onAcceptFail))},signUpError:function(a,b){l.byId("button_create_account").set("disabled",!1);l.byId("button_create_account").set("label",this.i18n.createAccount);var c=this.i18n.unableCreateAccount,e=this.i18n.contactAdmin;-1<a.message.indexOf("already registered")&&(e=this.i18n.error.emailInUse);-1<a.message.indexOf("Username '")&&
-1<a.message.indexOf("' not available.")&&(e=this.i18n.error.usernameInValid);c='\x3cb style\x3d"font-size:1.2em;line-height:30px;"\x3e'+c+'\x3c/b\x3e\x3cbr/\x3e\x3cspan style\x3d"color:#000000;"\x3e';c+=e;c+="\x3c/span\x3e\x3cbr/\x3e\x26nbsp;";this.showError(c)},signInError:function(a,b){l.byId("button_create_account").set("disabled",!1);l.byId("button_create_account").set("label",this.i18n.createAccount);var c="\x3cb style\x3d'font-size:1.2em;line-height:30px;'\x3e"+this.i18n.unableSignAuto+"\x3c/b\x3e\x3cbr/\x3e",
c=c+'\x3cspan style\x3d"color:#000000;"\x3e'+this.i18n.pleaseTrySignManually,c=c+"\x3c/span\x3e\x3cbr/\x3e\x26nbsp;";this.showError(c)},clearError:function(){b.removeClass("register-error","error");b.attr(b.byId("register-error"),"innerHTML","")},showError:function(a){b.addClass("register-error","error");b.attr(b.byId("register-error"),"innerHTML",a)},onFetchInvitation:function(a,g){var c;if(a&&a.code&&a.message&&403===a.code){var e="\x3cp\x3e"+this.i18n.emailInvitation+"\x3c/p\x3e\x3cp\x3e"+this.i18n.clickOkSignIn+
"\x3c/p\x3e";c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();c.onOkClick=b.hitch(this,function(a,b){a.hide();window.location=esriGeowConfig.baseUrl.replace("http:","https:")+esriGeowConfig.signin},c);c.show({title:this.i18n.notice,message:e})}else a&&a.code&&a.message&&400===a.code?(e="\x3cp\x3e"+this.i18n.invitationUsedMsg+"\x3c/p\x3e\x3cp\x3e"+this.i18n.clickOkSignIn+"\x3c/p\x3e",c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),c.onOkClick=
b.hitch(this,function(a,b){a.hide();window.location=arcgisonline.sharing.util.getSecureUrl()+esriGeowConfig.signin},c),c.show({title:this.i18n.notice,message:e})):a&&a.id&&a.id===this.invitation?this.invitationOrgName=a.account.name:this.invitation=null},onAcceptFail:function(a,g){var c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();c.onOkClick=b.hitch(this,function(a,b){a.hide();this._createAccount.set("disabled",!1);this._createAccount.set("label",this.i18n.createAcc)},
c);c.show({title:this.i18n.unableToJoin,message:this.i18n.problemJoining})},_fetchInvitation:function(){return this._request(this._communityUri+"invitations/"+this.invitation,null,{errBack:b.hitch(this,"onFetchInvitation")})},_acceptInvitation:function(){return this._request(esriGeowConfig.restBaseUrl+"community/invitations/"+this.invitation+"/accept",{token:this.util.getUser().token},{errBack:b.hitch(this,"onAcceptFail")})},_request:function(a,g,c){g=b.mixin(g||{},this._requestParams);return this.util.request({url:a,
content:g},c||{}).then(b.hitch(this,function(a){return a.error?c.errBack?c.errBack(a.error):this._showError(a.error):a}),b.hitch(this,function(a){c.errBack?c.errBack(a):this._showError(a);throw a;}))},_showError:function(a){a=a.error||a||{};a.code=a.code||0;a=this.i18n.errors[a.code]||a;a.details=a.details&&a.details.length?b.filter(a.details,"return item !\x3d\x3d null"):null;a.details&&a.details.length&&(a.details=a.details.join("\x3cbr /\x3e"),a.message=a.message?a.message+"\x3cbr /\x3e"+a.details:
a.details);a=b.mixin(b.mixin({},this.i18n.errors.error),a);b.addClass("register-error","error");b.attr(b.byId("register-error"),"innerHTML",a.message+"\x3cbr/\x3e");return!0}})});