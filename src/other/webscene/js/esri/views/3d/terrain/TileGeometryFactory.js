// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../webgl-engine/lib/Geometry ../webgl-engine/lib/GeometryData ../lib/glMatrix ../support/earthUtils ../support/mathUtils ./TerrainConst".split(" "),function(Z,$,aa,ba,J,ca){function N(a,e,g,m,b){a<m[0]&&(m[0]=a);a>b[0]&&(b[0]=a);e<m[1]&&(m[1]=e);e>b[1]&&(b[1]=e);g<m[2]&&(m[2]=g);g>b[2]&&(b[2]=g)}function P(a,e,g){for(var m=0;m<g.length;m++){var b=g[m];if(b){var c=b.safeWidth,B=b.width,r=b.pixels,h=J.clamp(b.dy*(b.y1-e),0,c),b=J.clamp(b.dx*(a-b.x0),0,c),c=Math.floor(h),w=Math.floor(b),t=c*
B+w,d=t+B,u=r[t],B=r[d],t=r[t+1],r=r[d+1];if(u+B+t+r<0.5*ca.ELEVATION_NODATA_VALUE)return h-=c,b-=w,a=u+(t-u)*b,a+(B+(r-B)*b-a)*h}}return null}function Q(a){K||a*a+4*(a-1)>L&&(a=1<<Math.floor(Math.log2(0.5*(-4+Math.sqrt(16+4*(4+L))))));return a}var R=ba.earthRadius,G=aa.vec3d,da=J.lerp,K=!1,ea=function(){var a=G.create(),e=G.create(),g=G.create(),m,b,c;this.init=function(B,r){b=B;c=r;G.subtract(g,e,a);m=0.5*G.length(a);G.lerp(e,g,0.5,a)};this.getCenter=function(){return a};this.getBSRadius=function(){return m};
this.getBBMin=function(){return e};this.getBBMax=function(){return g};this.getPosition=function(){return b};this.getIndices=function(){return c};this.getPrimitiveIndices=function(){};this.getChildren=function(){}},S=function(a,e,g,m){a*=R;for(var b=0;b<=e;b++)g[5*m]=0,g[5*m+1]=0,g[5*m+2]=a,m++},O=new function(){var a=Array(50),e=0,g={};this.get=function(b){var c=g[b];c||(c={ptr:0,data:Array(50)},g[b]=c);0<c.ptr?(m.vertexArrayHits++,b=c.data[--c.ptr],c.data[c.ptr]=null):(m.vertexArrayMisses++,b=new Float32Array(b));
if(0<e)return m.geometryHits++,c=a[--e],a[e]=null,c.getData().getVertexAttr().terrain.data=b,c;m.geometryMisses++;c={};c.terrain={size:5,data:b};b=new ea;return new Z(new $([{type:"triangle",indices:{terrain:null},positionKey:"terrain"}],c),"tile",[b])};this.put=function(b){var c=b.getData(),m=c.getVertexAttr(),r=m.terrain.data,h=g[r.length];50>h.ptr&&(h.data[h.ptr++]=r);m.terrain.data=null;c.getFaces()[0].indices.terrain=null;50>e&&(a[e++]=b)};var m={geometryHits:0,geometryMisses:0,vertexArrayHits:0,
vertexArrayMisses:0};this.stats=m;this._pools={geometry:a,vertexArray:g}},T=[],U=Array(257),V=Array(257),W=Array(257),X=Array(257),L=65536,fa={values:null,numSurfaceIndices:0,numSkirtIndices:0},M=function(a,e,g){g||(a.values=e.values);a.numSurfaceIndices=e.numSurfaceIndices;a.numSkirtIndices=e.numSkirtIndices;return a},Y=function(a,e,g,m,b){var c;c=fa;var B=g&2,r=e+(m?1024:0)+(B?2048:0),h=T[r];c||(c={});if(h)M(c,h);else{var h=e-1,w=e-1,t=e*e,d=2*h+2*w,u=6*h*w,y=6*d,C=6*(2*h+w-1);m&&(u*=2,y*=2,C*=
2);for(var d=K&&t+d>L?new Uint32Array(u+y):new Uint16Array(u+y),x=0,f=0,l=u,s,k,v,q,D=0,p=0;p<=w;p++){B&&(D=0===p?C:p===w?-C:0);for(var l=l+D,n=0;n<=h;n++)q=k=-1,0===p&&(k=t+n,n!==h&&(q=x+1)),n===h&&(k=t+h+p,p<w&&(q=x+h+1)),p===w&&(k=t+h+w+(h-n),0<n&&(q=x-1)),0===n&&0<p&&(k=t+2*h+w+(w-p),q=x-(h+1)),-1<k&&(v=0===n&&1===p?t:k+1,-1<q&&(s=x,m?(d[l+0]=s,d[l+1]=k,d[l+2]=k,d[l+3]=v,d[l+4]=v,d[l+5]=s,d[l+6]=v,d[l+7]=q,d[l+8]=q,d[l+9]=s,d[l+10]=s,d[l+11]=v,l+=12):(d[l+0]=s,d[l+1]=k,d[l+2]=v,d[l+3]=v,d[l+4]=
q,d[l+5]=s,l+=6))),++x,n<h&&p<w&&(s=p*(h+1)+n,k=s+1,v=k+(h+1),q=v-1,m?(d[f+0]=s,d[f+1]=k,d[f+2]=k,d[f+3]=v,d[f+4]=v,d[f+5]=s,d[f+6]=v,d[f+7]=q,d[f+8]=q,d[f+9]=s,d[f+10]=s,d[f+11]=v,f+=12):(d[f+0]=s,d[f+1]=k,d[f+2]=v,d[f+3]=v,d[f+4]=q,d[f+5]=s,f+=6));l-=D}c.values=d;c.numSurfaceIndices=u;c.numSkirtIndices=y;T[r]=M({},c)}B=a.getData();r=B.getVertexAttr();B.getFaces()[0].indices.terrain=c.values;a.getBoundingInfo(0).init(r.terrain,c.values);b||(b={});b.geometry=a;b.numWithoutSkirtIndices=c.numSurfaceIndices+
(g?6*(e-1)*(m?2:1):0);b.numVertsPerRow=e;return M(b,c,!0)};return{createPlanarGlobeTile:function(a,e,g,m,b,c,B){var r=e[0],h=e[1],w=e[2]-r;e=e[3]-h;var t=0.1*w;a=Q(a);var d=a-1,u=a-1,y=a*a,C=O.get(5*(y+(2*d+2*u))),x=C.getData().getVertexAttr().terrain.data,f,l,s=0;f=C.getBoundingInfo(0);var k=f.getBBMin(),v=f.getBBMax();G.set3(1E7,1E7,1E7,k);G.set3(-1E7,-1E7,-1E7,v);for(l=0;l<=u;l++){var q=l/u,D=h+q*e;c&&(D<c[1]?(D=c[1],q=(D-h)/e):D>c[3]&&(D=c[3],q=(D-h)/e));for(f=0;f<=d;f++){var p=f/d,n=r+p*w;c&&
(n<c[0]?(n=c[0],p=(n-r)/w):n>c[2]&&(n=c[2],p=(n-r)/w));var E=g?P(n,D,g)||0:0,n=n-m[0],H=D-m[1],E=E-m[2];N(n,H,E,k,v);x[5*s]=n;x[5*s+1]=H;x[5*s+2]=E;x[5*s+3]=p;x[5*s+4]=q;var z=-1;0===l&&(z=y+f);f===d&&(z=y+d+l);l===u&&(z=y+d+u+(d-f));0===f&&0<l&&(z=y+2*d+u+(u-l));-1<z&&(x[5*z]=n,x[5*z+1]=H,x[5*z+2]=E-t,x[5*z+3]=p,x[5*z+4]=q,N(n,H-t,E,k,v));++s}}return Y(C,a,0,b,B)},createSphericalGlobeTile:function(a,e,g,m,b,c,B,r){var h=g[0],w=g[1],t=g[2],d=g[3],u=Math.max(0.9,1-0.5*(t-h));a=Q(a);g=a-1;var y=a-1,
C=a*a,x=O.get(5*(C+(2*g+2*y))),f=x.getData().getVertexAttr().terrain.data,l=e[2]-e[0],s=e[3]-e[1],k,v=0,q=t-h,t=b[0],D=b[1];b=b[2];var p=x.getBoundingInfo(0),n=p.getBBMin(),p=p.getBBMax();G.set3(1E7,1E7,1E7,n);G.set3(-1E7,-1E7,-1E7,p);for(k=0;k<=g;k++){var E=k/g,H=h+E*q,z=e[0]+E*l;U[k]=Math.sin(H);V[k]=Math.cos(H);W[k]=E;X[k]=z}for(h=0;h<=y;h++){k=da(w,d,h/y);var l=Math.cos(k),q=Math.sin(k),H=R/2*Math.log((1+q)/(1-q)),J=(H-e[1])/s;for(k=0;k<=g;k++){var E=W[k],z=X[k],I=U[k],A=V[k],F=R;m&&(F+=P(z,H,
m)||0);var z=A*l*F,I=I*l*F,F=q*F,K=z-t,L=I-D,M=F-b;N(K,L,M,n,p);A=5*v;f[A+0]=K;f[A+1]=L;f[A+2]=M;f[A+3]=E;f[A+4]=J;A=-1;0===h&&(A=C+k);k===g&&(A=C+g+h);h===y&&(A=C+g+y+(g-k));0===k&&0<h&&(A=C+2*g+y+(y-h));-1<A&&(z=z*u-t,I=I*u-D,F=F*u-b,N(z,I,F,n,p),A*=5,f[A+0]=z,f[A+1]=I,f[A+2]=F,f[A+3]=E,f[A+4]=J);++v}}e=!!(c&2);c&1&&S(-1,g,f,C);e&&S(1,g,f,C+g+y);return Y(x,a,c,B,r)},releaseGeometry:O.put,elevationSampler:P,_geometryObjectPool:O,supportedNumVertsPerRow:Q,setSupportsUintIndices:function(a){K=a}}});