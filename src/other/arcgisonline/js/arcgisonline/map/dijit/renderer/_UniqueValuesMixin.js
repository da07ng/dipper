// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/dijit/renderer/_UniqueValuesMixin","dojo/_base/declare dojo/_base/lang dojo/_base/connect dojo/_base/array dojo/Deferred dojo/dom dojo/dom-construct esri/lang esri/symbols/jsonUtils esri/symbols/SimpleMarkerSymbol esri/styles/type esri/renderers/smartMapping esri/tasks/query esri/tasks/QueryTask esri/tasks/UniqueValueDefinition esri/tasks/GenerateRendererParameters esri/tasks/GenerateRendererTask esri/tasks/StatisticDefinition esri/renderers/UniqueValueRenderer esri/dijit/OpacitySlider".split(" "),
function(q,d,r,e,k,s,t,u,g,n,p,l,v,w,x,y,z,A,m,B){return{allUniqueValues:null,maxCount:200,defaultColors:"#ed5151 #149ece #a7c636 #9e559c #fc921f #ffde3e #f789d8 #b7814a #3caf99 #6b6bd6 #b54779 #7f7f7f".split(" "),buildUniqueRenderer:function(c){var a=new k;setTimeout(function(){a.progress(a)},1);if(this.isFeatColl||this.isCSV||this.hasDynamic)this.buildUniqueRendererGo(!1,c,a);else if("UniqueValueRenderer"!==this.renderer.declaredClass)if(this.isOwnerOfHostedFS){var b=this.layer.getEditCapabilities();
!this.layer.isEditable()||!b.canCreate&&(b.canUpdate||b.canDelete)||this.mapLayer.featureTemplatesChanged?this.buildUniqueRendererGo(!0,c,a):arcgisonline.map.edit.hasDefaultTypesAndTemplates(this.layer)?this.buildUniqueRendererGo(!0,c,a):(b=arcgisonline.sharing.dijit.dialog.ChoiceDlg.prototype.statics.getInstance(),b.show({title:this.i18n.warning,message:this.i18n.featureTypesAndTemplatesWarning,choiceOneTitle:this.i18n.yesLabel,choiceOneHandler:d.hitch(this,function(){this.buildUniqueRendererGo(!0,
c,a)}),choiceTwoTitle:this.i18n.noLabel,choiceTwoHandler:d.hitch(this,function(){a.reject()})}))}else this.buildUniqueRendererGo(!1,c,a);else attributeItem=this.getFieldForUniqueRenderer(),attributeItem.name!==this.renderer.attributeField?this.isOwnerOfHostedFS?(b=this.layer.getEditCapabilities(),!this.layer.isEditable()||!b.canCreate&&(b.canUpdate||b.canDelete)||this.mapLayer.featureTemplatesChanged?this.buildUniqueRendererGo(!0,c,a):arcgisonline.map.edit.hasDefaultTypesAndTemplates(this.layer)?
this.buildUniqueRendererGo(!0,params,a):(b=arcgisonline.sharing.dijit.dialog.ChoiceDlg.prototype.statics.getInstance(),b.show({title:this.i18n.warning,message:this.i18n.featureTypesAndTemplatesWarning,choiceOneTitle:this.i18n.yesLabel,choiceOneHandler:d.hitch(this,function(){this._onSaveRendererGo(!0,c,a)}),choiceTwoTitle:this.i18n.noLabel,choiceTwoHandler:d.hitch(this,function(){})}))):this.buildUniqueRendererGo(!1,c,a):this.isOwnerOfHostedFS?(b=this.layer.getEditCapabilities(),!this.layer.isEditable()||
!b.canCreate&&(b.canUpdate||b.canDelete)||this.mapLayer.featureTemplatesChanged?this.buildUniqueRendererGo(!0,c,a):arcgisonline.map.edit.hasDefaultTypesAndTemplates(this.layer)?this.buildUniqueRendererGo(!0,params,a):(b=arcgisonline.sharing.dijit.dialog.ChoiceDlg.prototype.statics.getInstance(),b.show({title:this.i18n.warning,message:this.i18n.featureTypesAndTemplatesWarning,choiceOneTitle:this.i18n.yesLabel,choiceOneHandler:d.hitch(this,function(){this._onSaveRendererGo(!0,c,a)}),choiceTwoTitle:this.i18n.noLabel,
choiceTwoHandler:d.hitch(this,function(){this._onSaveRendererGo(!1,c,a)})}))):this.buildUniqueRendererGo(!1,c,a);return a},buildUniqueRendererGo:function(c,a,b){arcgisonline.map.dynLayer.checkDynamicLayers(this.mapLayer);this.hasDynamic=arcgisonline.map.main.hasDynamicLayers(this.mapLayer);attributeItem=this.getFieldForUniqueRenderer();var f;this.isMultiAttributesRenderer&&"esriGeometryPolygon"===this.geometryType&&(f=renderer.infos[0].symbol);l.createTypeRenderer({layer:this.fLayer||this.layer,field:attributeItem.name,
theme:"default",basemap:this.getBasemapType(),scheme:this.scheme,numTypes:10,showOthers:!0,optimizeOutline:!0,includeAllCodedValues:!0,sortBy:"count"}).then(d.hitch(this,function(a){if(!b.isRejected()){this.scheme=a.scheme;c&&(arcgisonline.map.edit.removeTypesAndTemplatesOnLayer(this.mapLayer.layer),this.mapLayer.featureTemplatesChanged=!0);if(this.isMultiAttributesRenderer){if(a.renderer.setVisualVariables(this.renderer.visualVariables),a.renderer.backgroundFillSymbol=this.renderer.backgroundFillSymbol,
"esriGeometryPolygon"===this.geometryType){var h=[];e.forEach(a.renderer.infos,function(a){h.push(d.clone(a))});e.forEach(h,function(b){a.renderer.removeValue(b.value)});e.forEach(h,function(b){var c=g.fromJson(f.toJson());a.renderer.addValue({value:b.value,symbol:this.convertFillToMarkerSymbol(a.symbol,c.style,c.outline),label:b.label})},this);e.forEach(a.uniqueValueInfos,function(a){var b=g.fromJson(f.toJson());a.symbol=this.convertFillToMarkerSymbol(a.symbol,b.style,b.outline)},this)}}else delete this.authoringInfo;
this.allUniqueValues=a.uniqueValueInfos;-1===a.othersStartIndex&&this.allUniqueValues.length&&(this.defaultInfo={defaultSymbol:a.renderer.defaultSymbol,defaultLabel:a.renderer.defaultLabel},delete a.renderer.defaultSymbol,delete a.renderer.defaultLabel);b.resolve(a.renderer)}}),d.hitch(this,function(a){b.isRejected()||(this.handleError(a,"createTypeRenderer",!0),b.reject())}))},applyUniqueRenderer:function(c){var a=this.getRendererStyle((this.fLayer||this.layer).renderer);this.setRenderer(c);!this.hasDynamic&&
(a!==this.getRendererStyle(c)&&this.scheme&&esri.isDefined(this.scheme.opacity))&&(this.layer.setOpacity(this.scheme.opacity),this.transparencySlider&&this.transparencySlider.set("value",1-this.scheme.opacity));(arcgisonline.map.featColl.isFeatureCollection(this.mapLayer)||this.isCSV)&&arcgisonline.map.main.markMapAsChanged("onRendererChange");this.isOwnerOfHostedFS&&!this.layer.types.length&&arcgisonline.map.edit.createTypesAndTemplatesOnLayer(this.layer);this.updateLegendPopup()},updateUniqueRenderer:function(c){if(esri.isDefined(c)&&
"esriGeometryPolygon"===this.geometryType)if(c){var a=[];e.forEach(this.renderer.infos,function(b){a.push(d.clone(b))});e.forEach(a,function(a){this.renderer.removeValue(a.value)},this);e.forEach(a,function(a){this.renderer.addValue({value:a.value,symbol:this.setOutlineWidthOfSymbol(a.symbol,1),label:a.label})},this);this.portalPanel.lastUniqueDefaultSymbol=this.setOutlineWidthOfSymbol(this.portalPanel.lastUniqueDefaultSymbol,1);this.renderer.defaultSymbol&&(this.renderer.defaultSymbol=this.setOutlineWidthOfSymbol(this.renderer.defaultSymbol,
1));this.defaultInfo&&this.defaultInfo.defaultSymbol&&(this.defaultInfo.defaultSymbol=this.setOutlineWidthOfSymbol(this.defaultInfo.defaultSymbol,1));this.getSuggestedOutline().then(d.hitch(this,function(a){this.replaceVisualVariable("sizeInfo","outline",a.widthInfo,this.renderer);this.applyUniqueRenderer(this.renderer)}),d.hitch(this,function(a){a=this.getVisualVariablesExceptTypes([{type:"sizeInfo",target:"outline"}],this.renderer.visualVariables);this.renderer.setVisualVariables(a);this.applyUniqueRenderer(this.renderer)}))}else c=
this.getVisualVariablesExceptTypes([{type:"sizeInfo",target:"outline"}],this.renderer.visualVariables),this.renderer.setVisualVariables(c),this.applyUniqueRenderer(this.renderer);else this.applyUniqueRenderer(this.renderer)},ungroupUniqueValues:function(){var c=d.clone(this.allUniqueValues);attributeItem=this.getFieldForUniqueRenderer();var a;a=this.renderer.defaultSymbol&&this.renderer.defaultLabel?g.fromJson(this.renderer.defaultSymbol.toJson()):this.defaultInfo?g.fromJson(this.defaultInfo.defaultSymbol.toJson()):
this.getDefaultSymbol(this.geometryType);var b=new m(a,attributeItem.name);b.authoringInfo=dojo.clone(this.renderer.authoringInfo);this.renderer.backgroundFillSymbol&&(b.backgroundFillSymbol=this.renderer.backgroundFillSymbol);if(c.length>this.maxCount){if(c=c.slice(0,this.maxCount),!this.renderer.defaultSymbol||!this.renderer.defaultLabel)b.defaultSymbol=null}else b.defaultSymbol=null;e.forEach(this.renderer.infos,function(a){b.addValue(a);c=e.filter(c,function(b){return b.value!=a.value})});e.forEach(c,
function(a,c){null!==a.value&&b.addValue({value:a.value,symbol:a.symbol,label:a.label})},this);return b},reorderUniqueValues:function(c,a,b){attributeItem=this.getFieldForUniqueRenderer();b=this.getDefaultSymbol(this.geometryType);var f=new m(b,attributeItem.name);f.authoringInfo=dojo.clone(this.renderer.authoringInfo);f.defaultSymbol=null;this.renderer.backgroundFillSymbol&&(f.backgroundFillSymbol=this.renderer.backgroundFillSymbol);a&&(f.defaultSymbol=a.symbol,f.defaultLabel=a.label);e.forEach(c,
d.hitch(this,function(a){a.symbol?f.addValue({value:a.value,label:a.label,symbol:a.symbol}):e.forEach(this.allUniqueValues,function(b){b.value===a.value&&f.addValue({value:a.value,label:a.label,symbol:b.symbol})})}));return f},getAllUniqueValues:function(c){var a=new k;setTimeout(function(){a.progress(a)},1);if(this.allUniqueValues&&!c)a.resolve();else if(this.allUniqueValues)e.forEach(this.allUniqueValues,function(a,b){this.applyColorToSymbol(a.symbol,c[b%c.length])},this),a.resolve();else{var b=
null;c&&(b=p.getSchemes({theme:"default",basemap:this.getBasemapType(),geometryType:this.geometryType}).primaryScheme,b.colors=c);attributeItem=this.getFieldForUniqueRenderer();l.createTypeRenderer({layer:this.fLayer||this.layer,field:attributeItem.name,theme:"default",basemap:this.getBasemapType(),scheme:b,numTypes:0,showOthers:!1,optimizeOutline:!1,includeAllCodedValues:!0,sortBy:"count"}).then(d.hitch(this,function(b){if(!a.isRejected()){if(this.isMultiAttributesRenderer&&"esriGeometryPolygon"===
this.geometryType){var c=this.renderer.infos[0].symbol;c instanceof n||(c=null);e.forEach(b.uniqueValueInfos,function(a){var b=c&&g.fromJson(c.toJson());a.symbol=this.convertFillToMarkerSymbol(a.symbol,c&&b.style,c&&b.outline)},this)}this.allUniqueValues=b.uniqueValueInfos;a.resolve()}}),d.hitch(this,function(b){a.isRejected()||(this.handleError(b,"createTypeRenderer",!1),a.reject())}))}return a}}});