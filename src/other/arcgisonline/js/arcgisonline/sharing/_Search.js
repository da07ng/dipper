// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/_Search",["dijit","dojo","dojox","dojo/require!arcgisonline/sharing/util,arcgisonline/sharing/geow/Content"],function(g,e,h){e.provide("arcgisonline.sharing._Search");e.require("arcgisonline.sharing.util");e.require("arcgisonline.sharing.geow.Content");e.declare("arcgisonline.sharing._Search",null,{_content:arcgisonline.sharing.geow.Content,_queryStringParams:null,_lastQuery:null,keywords:null,_searchPage:esriGeowConfig.baseUrl+"search.html",_queryTypes:{content:{queryUrl:esriGeowConfig.restBaseUrl+
"search"},group:{queryUrl:esriGeowConfig.restBaseUrl+"search"},groups:{queryUrl:esriGeowConfig.restBaseUrl+"community/groups"}},_getSearchParams:function(){return e.queryToObject(window.location.search.slice(1))},goToSearch:function(a,b){window.location.href=this.getSearchUrl(a,b)},getSearchUrl:function(a,b){b||(b={});var d=e.queryToObject(window.location.search.slice(1));if(!b.clearParams){a.resetSort||delete d.resetSort;var c=d.q;a=e.mixin(d,a);"group"===a.t&&c!==a.q&&(a.sortField=null,a.sortOrder=
null,a.start=1)}var d=b.useCurrentPageLocation?window.location.href.substring(window.location.href.lastIndexOf("/")+1,window.location.href.indexOf(window.location.search)):this._searchPage,d=d+("?"+e.objectToQuery(a)),c=esriGeowConfig.self&&esriGeowConfig.self.allSSL,f=arcgisonline.sharing.util.usePortalSSL();return c||f?arcgisonline.sharing.util.getSecureUrl(d):arcgisonline.sharing.util.getHttpUrl(d)},doQuery:function(a){var b="";a.q&&(b=e.trim(a.q),this.keywords=e.trim(a.q));a.f&&(b=null!==b&&0<
b.length?"("+b+") "+e.trim(unescape(a.f)):b+(" "+e.trim(unescape(a.f))));if(null==b||0===b.length)b="all"==a.focus?"access:public":"";a.focus&&esriGeowConfig.filterQueries[a.focus]&&(b+=" "+esriGeowConfig.filterQueries[a.focus].f);var d=arcgisonline.sharing.util.getCookie("esri_search")||{},c={},f=-1<location.href.indexOf("search.html");c.q=b;void 0!==a.sortField?c.sortField=a.sortField:f&&(d.sortField&&!a.resetSort)&&(c.sortField=d.sortField);void 0!==a.sortOrder?c.sortOrder=a.sortOrder:f&&(d.sortOrder&&
!a.resetSort)&&(c.sortOrder=d.sortOrder);void 0!==a.start&&(c.start=a.start);0<this.resultsPerPage&&(c.num=this.resultsPerPage);this._lastQuery=c;this._content.search(a.t?this._queryTypes[a.t].queryUrl:this._queryTypes.content.queryUrl,c,e.hitch(this,this._onQueryResult));this.onQueryExecute(c,this._cleanQuery(c.q))},_onQueryResult:function(a){this.onQueryResult(a)},_cleanQuery:function(a){if((a=a.replace(/\s+/g," ").replace(/: /g,":"))&&0<=a.indexOf(":")){a=a.replace(/\(/g," ( ").replace(/\)/g," ) ");
a=a.split(" ");for(var b=[],d=0;d<a.length;d++){for(var c=a[d],e=c.replace(/[^"]/g,"").length;1==e%2&&d<a.length-1;)c+=" "+a[d+1],d++,e=c.replace(/[^"]/g,"").length;-1===c.indexOf(":")&&b.push(c)}b=this.checkLastKeyword(b);a=b.join(" ");a=a.replace(/  /g," ").replace(/ OR OR /g," OR ").replace(/\( /g,"(").replace(/ \)/g,")").replace(/\(OR OR /g,"(").replace(/ OR OR\)/g,")");a=a.replace(/\(OR/g,"(").replace(/OR\)/g,")").replace(/\( \)/g,"").replace(/\(\)/g,"").replace(/\s+$/,"").replace(/^\s+/,"")}return a},
checkLastKeyword:function(a){if(a&&0<a.length){var b=a[a.length-1];if(b.match(/^AND$/i)||b.match(/^OR$/i))return a.pop(),this.checkLastKeyword(a)}return a},onQueryExecute:function(a,b){},onQueryResult:function(a){}})});