// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/AddItemFromLayerDlg",["dijit","dojo","dojox","dojo/require!arcgisonline/sharing/util,arcgisonline/sharing/dijit/dialog/_AddItemDlgMixin,arcgisonline/sharing/dijit/dialog/GeneralDlg,arcgisonline/sharing/geow/Content,arcgisonline/sharing/geow/Folder,arcgisonline/map/mapUtil,dojo/data/ItemFileWriteStore,dijit/form/SimpleTextarea,dijit/form/TextBox,arcgisonline/sharing/dijit/ComboBox,dijit/Dialog,dijit/_Widget,dijit/_Templated,dijit/form/Form,dojo/cookie,esri/dijit/Tags"],
function(p,b,t){b.provide("arcgisonline.sharing.dijit.dialog.AddItemFromLayerDlg");b.require("arcgisonline.sharing.util");b.require("arcgisonline.sharing.dijit.dialog._AddItemDlgMixin");b.require("arcgisonline.sharing.dijit.dialog.GeneralDlg");b.require("arcgisonline.sharing.geow.Content");b.require("arcgisonline.sharing.geow.Folder");b.require("arcgisonline.map.mapUtil");b.require("dojo.data.ItemFileWriteStore");b.require("dijit.form.SimpleTextarea");b.require("dijit.form.TextBox");b.require("arcgisonline.sharing.dijit.ComboBox");
b.require("dijit.Dialog");b.require("dijit._Widget");b.require("dijit._Templated");b.require("dijit.form.Form");b.require("dojo.cookie");b.require("esri.dijit.Tags");b.declare("arcgisonline.sharing.dijit.dialog.AddItemFromLayerDlg",[p._Widget,p._Templated,arcgisonline.sharing.dijit.dialog._AddItemDlgMixin],{widgetsInTemplate:!0,templateString:'\x3cdiv\x3e\r\n  \x3cform dojotype\x3d"dijit.form.Form" dojoAttachPoint\x3d"_createItemFromLayerForm" enctype\x3d"multipart/form-data" name\x3d"create-item-form" action\x3d"" method\x3d"post" dojoAttachEvent\x3d"onSubmit:createItem"\x3e\x3c!--,onKeyDown:onKeyDown--\x3e\r\n    \x3cdiv id\x3d"create-item-content"\x3e\r\n      \x3ctable cellspacing\x3d"6"\x3e\r\n      \t\x3ctbody\x3e\r\n      \t\t\x3ctr\x3e\r\n      \t\t\t\x3ctd nowrap\x3e\r\n              \x3clabel for\x3d"create-item-title"\x3e\r\n                ${i18n.titleLabel}\r\n              \x3c/label\x3e\r\n      \t\t\t\x3c/td\x3e\r\n            \x3ctd width\x3d"100%"\x3e\r\n\t\t          \x3cdiv dojoAttachPoint\x3d"_createItemTitleInput" id\x3d"create-item-title" dojotype\x3d"dijit.form.TextBox" dojoAttachEvent\x3d"onFocus:focusTitle" trim\x3d"true" maxlength\x3d"250" required\x3d"true" style\x3d"width:100%;padding:2px 0 2px 0;"\x3e\r\n\t\t          \x3c/div\x3e\r\n            \x3c/td\x3e\r\n      \t\t\x3c/tr\x3e\r\n\t\t\t\t\t\x3ctr\x3e\r\n\t\t\t\t\t\t\x3ctd nowrap valign\x3d"top"\x3e\r\n\t            \x3clabel for\x3d"create-item-tags"\x3e\r\n\t              ${i18n.tagsLabel}\r\n\t            \x3c/label\x3e\r\n\t\t\t\t\t\t\x3c/td\x3e\r\n            \x3ctd\x3e\r\n\t\t          \x3cdiv data-dojo-attach-point\x3d"_createItemTagsInput" id\x3d"create-item-tags" data-dojo-type\x3d"esri/dijit/Tags" data-dojo-props\x3d"minWidth:\'343px\', maxWidth:\'343px\'"\x3e\r\n\t\t          \x3c/div\x3e\r\n            \x3c/td\x3e\r\n\t\t\t\t\t\x3c/tr\x3e\r\n          \x3ctr\x3e\r\n            \x3ctd nowrap\x3e\r\n\t            \x3clabel for\x3d"create-item-summary"\x3e\r\n\t              ${i18n.summaryLabel}\r\n\t            \x3c/label\x3e\r\n            \x3c/td\x3e\r\n            \x3ctd\x3e\r\n\t\t          \x3cdiv dojoAttachPoint\x3d"_createItemSummaryInput" id\x3d"create-item-summary" dojotype\x3d"dijit.form.TextBox" dojoAttachEvent\x3d"onFocus:focusSummary" trim\x3d"true" maxlength\x3d"250" style\x3d"width:100%;padding:2px 0 2px 0;"\x3e\r\n\t\t          \x3c/div\x3e\r\n            \x3c/td\x3e\r\n          \x3c/tr\x3e\r\n          \x3ctr\x3e\r\n            \x3ctd nowrap\x3e\r\n\t            \x3clabel for\x3d"create-item-folder"\x3e\r\n\t              ${i18n.saveFolder}\r\n\t            \x3c/label\x3e\r\n            \x3c/td\x3e\r\n            \x3ctd\x3e\r\n\t            \x3cdiv class\x3d"arrowSpaceMedium" dojoAttachPoint\x3d"_createItemFolderSelect" id\x3d"create-item-folder" dojotype\x3d"arcgisonline.sharing.dijit.ComboBox" trim\x3d"true" style\x3d"width:100%;"\x3e\r\n              \x3c/div\x3e\r\n            \x3c/td\x3e\r\n          \x3c/tr\x3e\r\n      \t\x3c/tbody\x3e\r\n\t\t\t\x3c/table\x3e\r\n      \x3cdiv style\x3d"clear:both;"\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv class\x3d"esriFloatTrailing"\x3e\r\n        \x3cdiv dojotype\x3d"dijit.form.Button" class\x3d"primary" dojoAttachPoint\x3d"_submitButton" dojoAttachEvent\x3d"onClick:createItem" type\x3d"submit" label\x3d"${i18n.createItemBtn}"\x3e\r\n        \x3c/div\x3e\r\n        \x3cdiv dojoType\x3d"dijit.form.Button" type\x3d"button" class\x3d"cancel" dojoAttachPoint\x3d"_cancelButton" dojoAttachEvent\x3d"onClick:onCancel" label\x3d"${i18n.cancel}"\x3e\r\n        \x3c/div\x3e\r\n      \x3c/div\x3e\r\n      \x3cbr/\x3e\r\n      \x3cdiv dojoAttachPoint\x3d"_waitingDiv" style\x3d"clear:both;display:none;"\x3e\r\n        ${i18n.creatingItemMsg}\r\n      \x3c/div\x3e\r\n      \x3cdiv dojoAttachPoint\x3d"_itemDescriptionInput" dojotype\x3d"dijit.form.TextBox" type\x3d"hidden" value\x3d""\x3e\r\n      \x3c/div\x3e\r\n      \x3cdiv style\x3d"clear:both;"\x3e\r\n      \x3c/div\x3e\r\n    \x3c/div\x3e\r\n  \x3c/form\x3e\r\n\x3c/div\x3e\r\n',
baseClass:"esriAGOAddItemFromLayerForm",mapLayers:null,mapExtent:null,folderId:"",allItemNames:[],init:!1,defaultTextTitle:"",defaultTextTags:"",defaultTextSummary:"",folders:{},foldersJson:null,itemType:"",_errorDiv:null,_saveMapBtn:null,_cancelButton:null,_createItemTitleInput:null,_createItemTagsInput:null,_createItemSummaryInput:null,_createItemFolderSelect:null,_itemDescriptionInput:null,_waitingDiv:null,i18n:null,statics:{_instance:null,getInstance:function(){null==this._instance&&(this._instance=
new arcgisonline.sharing.dijit.dialog.AddItemFromLayerDlg);return this._instance}},postMixInProperties:function(){this.inherited(arguments);this.i18n=b.i18n.getLocalization("arcgisonline","arcgisonline").common;this.i18n=b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").errorWidget);this.i18n=b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").GeneralDlg);this.i18n=b.mixin(this.i18n,b.i18n.getLocalization("arcgisonline","arcgisonline").AddItemFromLayerDlg);
this.defaultTextTitle=this.i18n.enterMapTitle;this.defaultTextTags=this.i18n.separateTags},postCreate:function(){this.init||(this.getFolders(),this.init=!0)},startup:function(){this.inherited(arguments);this._util=arcgisonline.sharing.util;this._loadConnections()},_loadConnections:function(){this.user=this._util.getUser();this._dlgConnect=b.connect(this.dialog,"hide",b.hitch(this,function(){this.destroy()}))},start:function(a){this.mapLayer=a;this.itemType=null;arcgisonline.map.featColl.isFeatureCollection(this.mapLayer)?
this.itemType="Feature Collection":this.mapLayer.layer instanceof esri.layers.WMSLayer?this.itemType="WMS":this.mapLayer.layer instanceof esri.layers.VectorTileLayer?this.itemType="Vector Tile Service":(a=this.mapLayer.url.toLowerCase(),-1<a.indexOf("/mapserver/")?this.itemType="Feature Service":-1<a.indexOf("/mapserver")?this.itemType="Map Service":-1<a.indexOf("/featureserver")?this.itemType="Feature Service":-1<a.indexOf("/streamserver")?this.itemType="Stream Service":-1<a.indexOf("/imageserver")&&
(this.itemType="Image Service"));this.clear();this._submitButton.set("disabled",!1);this._cancelButton.set("disabled",!1);b.style(this._waitingDiv,"display","none");this._util.loadUserTags(this.user.username).then(b.hitch(this,function(a){this._createItemTagsInput.set("knownTags",a);null==this.folderId?this._createItemFolderSelect.set("value",this.user.email):eval("this.folders.id"+this.folderId)?this._createItemFolderSelect.set("value",eval("this.folders.id"+this.folderId)):setTimeout(b.hitch(this,
"selectCurrentFolder",this.folderId,0),1E3);this._createItemTitleInput.set("value",this.mapLayer.title);this.mapLayer.oldItemCard&&(this._createItemTagsInput.set("value",this.mapLayer.oldItemCard.tags),this._createItemSummaryInput.set("value",this.mapLayer.oldItemCard.snippet),this._itemDescriptionInput.set("value",this.mapLayer.oldItemCard.description))}))},clear:function(){this.allItemNames=[]},onCancel:function(){this.dialog&&this.dialog.hide()},createItem:function(a){a.preventDefault();this._submitButton.get("disabled")||
(this._submitButton.set("disabled",!0),this._cancelButton.set("disabled",!0),b.style(this._waitingDiv,"display","inline-block"));this.mapLayer.oldItemCard&&(this._createItemTagsInput.get("value"),this._createItemSummaryInput.get("value"),this._itemDescriptionInput.get("value"));a=b.trim(this._createItemTitleInput.get("value"));if(null==a||0===a.length||a===this.defaultTextTitle)this._createItemFolderSelect.focus(),a=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),a.show({title:this.i18n.errorTitle,
message:this.i18n.error.provideTitle}),this._submitButton.set("disabled",!1),this._cancelButton.set("disabled",!1),b.style(this._waitingDiv,"display","none");else if(-1<a.indexOf("\x3c")||-1<a.indexOf("\x3e"))this._createItemFolderSelect.focus(),a=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),a.show({title:this.i18n.errorTitle,message:this.i18n.error.specialCharaters}),this._submitButton.set("disabled",!1),this._cancelButton.set("disabled",!1),b.style(this._waitingDiv,
"display","none");else{var d=this._createItemTagsInput.get("value");!d||0===d.length?(this._createItemFolderSelect.focus(),a=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),a.show({title:this.i18n.errorTitle,message:this.i18n.error.provideTitle}),this._submitButton.set("disabled",!1),this._cancelButton.set("disabled",!1),b.style(this._waitingDiv,"display","none")):this.createItem_afterTitleCheck(a)}},createItem_afterTitleCheck:function(a,d){var f=this._createItemSummaryInput.get("value");
f==this.defaultTextSummary&&(f="",this._createItemSummaryInput.set("value",""),b.style(this._createItemSummaryInput.domNode,"color","#000000"));var e=null,g=null,n=null,k=null,l=null;switch(this.itemType){case "Feature Service":e=this.itemInfo.featureserver;l=e.typeKeywords;l+=", Singlelayer";arcgisonline.map.main.isNewRendererType_2_1(this.mapLayer)&&arcgisonline.sharing.util.isHostedService(this.mapLayer.url)&&(l+=", webmap_2.1");var k=this.mapLayer.layer.url.lastIndexOf("/"),c=parseInt(this.mapLayer.layer.url.substring(k+
1)),n=-1<this.mapLayer.layer.url.toLowerCase().indexOf("/mapserver/")?this.mapLayer.layer.url:this.mapLayer.layer.url.substring(0,k),k=this.mapLayer.layer.fullExtent,h={};this.mapLayer.popupInfo&&(h.popupInfo=this.mapLayer.popupInfo);this.mapLayer.rendererChanged&&(h.layerDefinition={drawingInfo:{renderer:this.mapLayer.layer.renderer.toJson()}},this.mapLayer.layer.labelingInfo&&this.mapLayer.showLabels&&(h.layerDefinition.drawingInfo.labelingInfo=b.map(this.mapLayer.layer.labelingInfo,function(a){return a.toJson()}),
h.showLabels=!0));this.mapLayer.scaleChanged&&(h.layerDefinition=h.layerDefinition||{},h.layerDefinition.minScale=this.mapLayer.layer.minScale?this.mapLayer.layer.minScale:0,h.layerDefinition.maxScale=this.mapLayer.layer.maxScale&&1!==this.mapLayer.layer.maxScale&&this.mapLayer.layer.maxScale!==Number.POSITIVE_INFINITY?this.mapLayer.layer.maxScale:0);this.mapLayer.defExpChanged&&(h.layerDefinition=h.layerDefinition||{},h.layerDefinition.definitionExpression=this.mapLayer.layer.getDefinitionExpression(),
esri.isDefined(this.mapLayer.definitionEditor)&&(h.definitionEditor=this.mapLayer.definitionEditor));!1===this.mapLayer.showLegend&&(h.showLegend=!1);this.mapLayer.layer.refreshInterval&&(h.refreshInterval=this.mapLayer.layer.refreshInterval);this.mapLayer.layer.timeInfo&&(!this.mapLayer.layer.timeInfo.hasLiveData&&!1===this.mapLayer.layer.useMapTime)&&(h.timeAnimation=!1);if(this.mapLayer.opacityChanged){var p=this.mapLayer.layer.opacity||0===this.mapLayer.layer.opacity?this.mapLayer.layer.opacity:
1;1>p&&(h.layerDefinition=h.layerDefinition||{},h.layerDefinition.drawingInfo=h.layerDefinition.drawingInfo||{},h.layerDefinition.drawingInfo.transparency=100-100*p)}h.layerDefinition=h.layerDefinition||{};h.layerDefinition.defaultVisibility=this.mapLayer.layer.visible;esri.isEmpty(h)||(h.id=c,c={layers:[h]},g=b.json.stringify(c));break;case "Stream Service":e=this.itemInfo.streamserver;l=e.typeKeywords;l+=", Singlelayer";k=this.mapLayer.layerDefinition&&this.mapLayer.layerDefinition.definitionGeometry?
new esri.geometry.Extent(this.mapLayer.layerDefinition.definitionGeometry):new esri.geometry.Extent(-180,-90,180,90,new esri.SpatialReference({wkid:4326}));n=this.mapLayer.url;c={};this.mapLayer.popupInfo&&(c.popupInfo=this.mapLayer.popupInfo);this.mapLayer.rendererChanged&&(c.layerDefinition=c.layerDefinition||{},c.layerDefinition.drawingInfo={},c.layerDefinition.drawingInfo.renderer=this.mapLayer.layer.renderer.toJson());if(this.mapLayer.scaleChanged&&(this.mapLayer.layer.minScale||this.mapLayer.layer.maxScale))c.layerDefinition=
c.layerDefinition||{},c.layerDefinition.minScale=this.mapLayer.layer.minScale?this.mapLayer.layer.minScale:0,c.layerDefinition.maxScale=this.mapLayer.layer.maxScale&&1!==this.mapLayer.layer.maxScale&&this.mapLayer.layerDefinition.minScale!==Number.POSITIVE_INFINITY?this.mapLayer.layer.maxScale:0;this.mapLayer.defExpChanged&&(this.mapLayer.layerDefinition&&esri.isDefined(this.mapLayer.layerDefinition.definitionExpression))&&(c.layerDefinition=c.layerDefinition||{},c.layerDefinition.definitionExpression=
this.mapLayer.layerDefinition.definitionExpression,esri.isDefined(this.mapLayer.definitionEditor)&&(c.definitionEditor=this.mapLayer.definitionEditor));this.mapLayer.spatialFilterChanged&&(this.mapLayer.layerDefinition&&this.mapLayer.layerDefinition.definitionGeometry)&&(c.layerDefinition=c.layerDefinition||{},c.layerDefinition.definitionGeometry=this.mapLayer.layerDefinition.definitionGeometry);this.mapLayer.maximumTrackPointsChanged&&esri.isDefined(this.mapLayer.layerDefinition.maximumTrackPoints)&&
(c.layerDefinition=c.layerDefinition||{},c.layerDefinition.maximumTrackPoints=this.mapLayer.layerDefinition.maximumTrackPoints);!1===this.mapLayer.showLegend&&(c.showLegend=!1);c.visibility=this.mapLayer.layer.visible;c.opacity=this.mapLayer.layer.opacity||0===this.mapLayer.layer.opacity?this.mapLayer.layer.opacity:1;esri.isEmpty(h)||(g=b.json.stringify(c));break;case "Map Service":e=this.itemInfo.mapserver;l=e.typeKeywords;l=this.mapLayer.serviceInfo&&this.mapLayer.serviceInfo.singleFusedMapCache?
l+", Tiled":l+", Dynamic";n=this.mapLayer.layer.url;k=this.mapLayer.layer.fullExtent;c={};this.mapLayer.itemLayers&&(c.layers=this.mapLayer.itemLayers);this.mapLayer.layer.layerInfos&&(l+=1<this.mapLayer.layer.layerInfos.length?", Multilayer":", Singlelayer");if(this.mapLayer.scaleChanged&&(0!==this.mapLayer.layer.minScale||0!==this.mapLayer.layer.maxScale))c.minScale=this.mapLayer.layer.minScale?this.mapLayer.layer.minScale:0,c.maxScale=this.mapLayer.layer.maxScale&&1!==this.mapLayer.layer.maxScale?
this.mapLayer.layer.maxScale:0;esri.isDefined(this.mapLayer.visibleLayers)&&(""===this.mapLayer.visibleLayers?c.visibleLayers=[]:(h=this.mapLayer.visibleLayers.split(","),c.visibleLayers=b.map(h,function(a){return parseInt(a)})));c.visibility=this.mapLayer.layer.visible;c.opacity=this.mapLayer.layer.opacity||0===this.mapLayer.layer.opacity?this.mapLayer.layer.opacity:1;this.mapLayer.layer.refreshInterval&&(c.refreshInterval=this.mapLayer.layer.refreshInterval);this.mapLayer.layer.timeInfo&&(!this.mapLayer.layer.timeInfo.hasLiveData&&
!1===this.mapLayer.layer.useMapTime)&&(c.timeAnimation=!1);esri.isEmpty(c)||(g=b.json.stringify(c));break;case "Image Service":e=this.itemInfo.imageserver;l=e.typeKeywords;l+=", Singlelayer";n=this.mapLayer.layer.url;k=this.mapLayer.layer.fullExtent;c={};this.mapLayer.renderingRuleChanged&&(this.mapLayer.layer.bandIds&&(c.bandIds=this.mapLayer.layer.bandIds),this.mapLayer.layer.renderingRule&&(c.renderingRule=this.mapLayer.layer.renderingRule.toJson()));this.mapLayer.mosaicRuleChanged&&this.mapLayer.layer.mosaicRule&&
(c.mosaicRule=this.mapLayer.layer.mosaicRule.toJson());this.mapLayer.imageQualityChanged&&(this.mapLayer.layer.format&&(c.format=this.mapLayer.layer.format),this.mapLayer.layer.compressionQuality&&(c.compressionQuality=this.mapLayer.layer.compressionQuality));this.mapLayer.popupInfo&&this.mapLayer.popupChanged&&(c.popupInfo=this.mapLayer.popupInfo);this.mapLayer.defExpChanged&&(this.mapLayer.layerDefinition&&esri.isDefined(this.mapLayer.layerDefinition.definitionExpression))&&(c.layerDefinition=this.mapLayer.layerDefinition,
esri.isDefined(this.mapLayer.definitionEditor)&&(c.definitionEditor=this.mapLayer.definitionEditor));if(this.mapLayer.scaleChanged&&(0!==this.mapLayer.layer.minScale||0!==this.mapLayer.layer.maxScale))c.minScale=this.mapLayer.layer.minScale?this.mapLayer.layer.minScale:0,c.maxScale=this.mapLayer.layer.maxScale&&1!==this.mapLayer.layer.maxScale?this.mapLayer.layer.maxScale:0;!1===this.mapLayer.showLegend&&(c.showLegend=!1);this.mapLayer.layer.refreshInterval&&(c.refreshInterval=this.mapLayer.layer.refreshInterval);
this.mapLayer.layer.timeInfo&&(!this.mapLayer.layer.timeInfo.hasLiveData&&!1===this.mapLayer.layer.useMapTime)&&(c.timeAnimation=!1);c.visibility=this.mapLayer.layer.visible;c.opacity=this.mapLayer.layer.opacity||0===this.mapLayer.layer.opacity?this.mapLayer.layer.opacity:1;esri.isEmpty(c)||(g=b.json.stringify(c));break;case "Feature Collection":e={type:"Feature Collection",typeKeywords:"Data, Feature Collection"};l=e.typeKeywords;l=arcgisonline.map.mapNotes.isMapNotesMapLayer(this.mapLayer)?l+", Map Notes, Multilayer":
l+(this.mapLayer.layers?", Multilayer":", Singlelayer");k=arcgisonline.map.featColl.getFullExtent(this.mapLayer);c=arcgisonline.map.featColl.buildFeatureCollectionJson(this.mapLayer);this.mapLayer.layers?(c.opacity=this.mapLayer.layers[0].opacity||0===this.mapLayer.layers[0].opacity?this.mapLayer.layers[0].opacity:1,c.visibility=!1===this.mapLayer.visibility?!1:!0,esri.isDefined(this.mapLayer.visibleLayers)?""===this.mapLayer.visibleLayers?c.visibleLayers=[]:(h=this.mapLayer.visibleLayers.split(","),
h.length<this.mapLayer.layers.length&&(c.visibleLayers=b.map(h,function(a){return parseInt(a)}))):delete c.visibleLayers):(c.visibility=this.mapLayer.layer.visible,c.opacity=this.mapLayer.layer.opacity||0===this.mapLayer.layer.opacity?this.mapLayer.layer.opacity:1);g=b.json.stringify(c);break;case "Vector Tile Service":if(!this.mapLayer.oldItemCard&&!d&&(e=this.mapLayer.layer.styleUrl.indexOf("/content/items/"),k=this.mapLayer.layer.styleUrl.indexOf("/resources/styles/root.json"),-1<e&&-1<k)){var q=
this.mapLayer.layer.styleUrl.substring(e+15,k);esri.request({url:esriGeowConfig.restBaseUrl+"content/items/"+q+"?f\x3djson",callbackParamName:"callback",load:b.hitch(this,function(b,c){this.mapLayer.oldItemCard=b;this.createItem_afterTitleCheck(a,!0)}),error:b.hitch(this,function(b){this.createItem_afterTitleCheck(a,!0)})});return}e=this.itemInfo.vectortileserver;l=e.typeKeywords;n=this.mapLayer.layer.serviceUrl;this.mapLayer.oldItemCard&&(n=this.mapLayer.oldItemCard.url);k=this.mapLayer.layer.fullExtent}var m=
{item:this.toFileCharacters(a)+"_"+(new Date).getTime(),title:a,url:n,tags:this._createItemTagsInput.get("value"),snippet:f,description:this._itemDescriptionInput.get("value"),text:g,type:e.type,typeKeywords:l};if(f=this._createItemFolderSelect.item)this.folderId=this._createItemFolderSelect.store.getValue(f,"id");else{var s=this._createItemFolderSelect.get("value");b.forEach(this.foldersJson,function(a,b){a.title==s&&(this.folderId=a.id)},this)}if("Vector Tile Service"===e.type)if(this.mapLayer.oldItemCard){m.thumbnailURL=
this.mapLayer.oldItemCard&&this.mapLayer.oldItemCard.thumbnail&&esriGeowConfig.restBaseUrl+"content/items/"+this.mapLayer.oldItemCard.id+"/info/"+this.mapLayer.oldItemCard.thumbnail;if(m.thumbnailURL&&(f=arcgisonline.sharing.util.getToken()))m.thumbnailURL+="?token\x3d"+f;f=this.mapLayer.oldItemCard.extent;m.extent=f[0][0]+","+f[0][1]+","+f[1][0]+","+f[1][1];if(f=this.mapLayer.layer.style.glyphSource.url)e=f.indexOf("/content/items/"),k=f.indexOf("/",e+15),-1<e&&-1<k&&(q=f.substring(e+15,k));var f=
this.mapLayer.layer.style.sprite.base,r;f&&(e=f.indexOf("/content/items/"),k=f.indexOf("/",e+15),-1<e&&-1<k&&(r=f.substring(e+15,k)));m.relationshipType=q||r?"Style2Style":"Service2Style";q||r?(m.originItemId=q||r,this._addItemCall(m)):esri.request({url:esriGeowConfig.restBaseUrl+"content/items/"+this.mapLayer.oldItemCard.id+"/relatedItems?relationshipType\x3dService2Style\x26direction\x3dreverse\x26f\x3djson",callbackParamName:"callback",load:b.hitch(this,function(a,b){m.originItemId=a&&a.relatedItems&&
a.relatedItems.length?a.relatedItems[0].id:this.mapLayer.oldItemCard.id;this._addItemCall(m)}),error:b.hitch(this,function(a){m.originItemId=this.mapLayer.oldItemCard.id;this._addItemCall(m)})})}else k?this._projectExtent2WGS84(m,k).then(b.hitch(this,function(a){this._addItemCall(a)}),b.hitch(this,function(a){this._addItemCall(m)})).then():this._addItemCall(m);else k?this._projectExtent2WGS84(m,k).then(b.hitch(arcgisonline.map.thumbnail,"buildThumbnailURLFromLayerOnMap",this.mapLayer,m.extent)).then(b.hitch(this,
function(a){m.thumbnailURL=a;this._addItemCall(m)}),b.hitch(this,function(a){this._addItemCall(m)})).then():this._addItemCall(m)},_addItemCall:function(a){var d=arcgisonline.sharing.util.getUser(),d=esriGeowConfig.restBaseUrl+"content/users/"+d.email;esri.isDefined(this.folderId)&&this.folderId.length&&(d+="/"+this.folderId);arcgisonline.sharing.util.postJson(a,d+"/addItem",b.hitch(this,"itemSavedHandler",a),b.hitch(this,"itemSaveErrorHandler",a))},_projectExtent2WGS84:function(a,d){var f=new esri.SpatialReference({wkid:4326}),
e=new b.Deferred;arcgisonline.map.main.sameSpatialReference(f,d.spatialReference)?(a.extent=this._extent2String(d),e.resolve(a)):this._project(d,f).then(b.hitch(this,function(b){a.extent=this._extent2String(b);e.resolve(a)}));return e},_project:function(a,d){var f=new b.Deferred,e=b.hitch(this,function(a){f.resolve(a&&a.length&&a[0]&&a[0].type&&"extent"===a[0].type?a[0]:null)}),g=new esri.geometry.Extent(a);arcgisonline.map.main.projectExtent(g,d,e,e);return f},_extent2String:function(a,d){d=d||4;
var f="";if(a&&this._isValidNum(a.xmin)&&this._isValidNum(a.ymin)&&this._isValidNum(a.xmax)&&this._isValidNum(a.ymax))var f=b.number.round(a.xmin,d),e=b.number.round(a.ymin,d),g=b.number.round(a.xmax,d),n=b.number.round(a.ymax,d),f=!isNaN(f)&&!isNaN(e)&&!isNaN(g)&&!isNaN(n)?f+","+e+","+g+","+n:"";return f},_isValidNum:function(a){return!isNaN(a)&&void 0!==a&&null!==a?!0:!1},itemSavedHandler:function(a,d,f){d.success&&(this.mapLayer.itemId=d.id,this.mapLayer.itemCard={id:d.id,url:a.url,title:a.title,
owner:this.user.email,tags:a.tags.split(","),ownerFolder:d.folder,typeKeywords:a.typeKeywords.split(","),summary:a.summary,description:a.description,type:a.type,access:"private",extent:[],thumbnail:a.thumbnailURL?"thumbnail/ago_downloaded.jpg":null},a.extent&&(d=a.extent.split(","),this.mapLayer.itemCard.extent=[[parseFloat(d[0]),parseFloat(d[1])],[parseFloat(d[2]),parseFloat(d[3])]]),this.mapLayer.itemData=b.json.parse(a.text),delete this.mapLayer.popupChanged,delete this.mapLayer.legendChanged,
delete this.mapLayer.scaleChanged,delete this.mapLayer.defExpChanged,delete this.mapLayer.spatialFilterChanged,delete this.mapLayer.maximumTrackPointsChanged,delete this.mapLayer.renderingRuleChanged,delete this.mapLayer.mosaicRuleChanged,delete this.mapLayer.imageQualityChanged,delete this.mapLayer.refreshIntervalChanged,delete this.mapLayer.visibleLayersChanged,delete this.mapLayer.editableChanged,delete this.mapLayer.timeChanged,delete this.mapLayer.dataChanged,delete this.mapLayer.rendererChanged,
"Vector Tile Service"===a.type?this.addVectorTileStyle().then(b.hitch(this,function(){delete this.mapLayer.oldItemCard;this.dialog.hide()}),b.hitch(this,function(a){console.log("New Vector Tile Service item created, request to create style failed.",a&&a.message);delete this.mapLayer.oldItemCard})):(delete this.mapLayer.oldItemCard,this.dialog.hide()))},itemSaveErrorHandler:function(a,d,f){409==d.code?(this._createItemFolderSelect.focus(),f=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),
a.url?f.show({title:this.i18n.errorTitle,message:d.message}):f.show({title:this.i18n.errorTitle,message:b.string.substitute(this.i18n.error.itemTitleExists,[a.title])})):(this._createItemFolderSelect.focus(),f=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),f.show({title:this.i18n.errorTitle,message:b.string.substitute(this.i18n.error.requestFailed,[a.title,d.message])}));this._submitButton.set("disabled",!1);this._cancelButton.set("disabled",!1);b.style(this._waitingDiv,
"display","none")},addVectorTileStyle:function(){var a=new b.Deferred;esri.request({url:this.mapLayer.url+"?f\x3djson",callbackParamName:"callback",load:b.hitch(this,function(d,f){var e=this.mapLayer.layer.serviceUrl,g=null;if(this.mapLayer.oldItemCard)if(e=this.mapLayer.oldItemCard.url,-1<this.mapLayer.layer.styleUrl.indexOf(e))g=e+(e.endsWith("/")?"":"/")+"resources/styles/";else var g=esriGeowConfig.restBaseUrl+"content/items/"+this.mapLayer.oldItemCard.id+"/resources/styles/",n=g.indexOf("://"),
k=g.indexOf("/",n+3),g=g.substring(0,n+3)+esriGeowConfig.self.portalHostname+g.substring(k);d.glyphs&&!d.glyphs.startsWith("http")&&(d.glyphs=g?g+d.glyphs:this.mapLayer.layer.style.glyphSource.url);d.sprite&&!d.sprite.startsWith("http")&&(d.sprite=g?g+d.sprite:this.mapLayer.layer.style.sprite.base);d.sources&&(d.sources.esri&&d.sources.esri.url&&!d.sources.esri.url.startsWith("http"))&&(d.sources.esri.url=e);e={filename:"root.json",text:b.json.stringify(d),resourcesPrefix:"styles",f:"json"};if(g=
arcgisonline.sharing.util.getToken())e.token=g;g=esriGeowConfig.restBaseUrl+"content/users/"+this.mapLayer.itemCard.owner;this.mapLayer.itemCard.ownerFolder&&(g+="/"+this.mapLayer.itemCard.ownerFolder);g+="/items/"+this.mapLayer.itemId;arcgisonline.sharing.util.postJsonCheckProxy(e,g+"/addResources",b.hitch(this,function(a,c,d){this.mapLayer.url=esriGeowConfig.restBaseUrl+"content/items/"+this.mapLayer.itemId+"/resources/styles/root.json";a=this.mapLayer.url.indexOf("://");c=this.mapLayer.url.indexOf("/",
a+3);this.mapLayer.url=this.mapLayer.url.substring(0,a+3)+esriGeowConfig.self.portalHostname+this.mapLayer.url.substring(c);this.mapLayer.layer.styleUrl=this.mapLayer.url;this.dialog.hide();b.publish("onLayerUpdate",["reopen"])},g),b.hitch(this,function(a){console.log("New Vector Tile Service created, request to create style resource failed",a&&a.message)}));a.resolve()}),error:b.hitch(this,function(b){console.log("New Vector Tile Service created, request to get style failed",b&&b.message);a.reject()})});
return a},getFolders:function(){var a=arcgisonline.sharing.util.getUser();if(null!=a){var d=new b.data.ItemFileWriteStore({data:{identifier:"name",items:[]}});d.newItem({name:a.email,id:""});this._createItemFolderSelect.set("store",d);this._createItemFolderSelect.set("value",a.email);arcgisonline.sharing.geow.Folder.getFolders(b.hitch(this,function(a,e){var g=null;if(b.cookie("ESRI_Content")){var n=arcgisonline.sharing.util.getCookie("ESRI_Content");n.folderId&&(g=n.folderId)}this.foldersJson=a.folders;
b.forEach(a.folders,function(a,b){d.newItem({name:a.title,id:a.id});eval("this.folders.id"+a.id+' \x3d "'+a.title.replace(/\"/g,'\\"')+'"');g===a.id&&(this._createItemFolderSelect.set("value",a.title),this.folderId=g)},this)}),b.hitch(this,function(a,d){console.error("Search for all folders failed "+(a?b.json.stringify(a):a))}))}},selectCurrentFolder:function(a,d){!eval("this.folders.id"+a)&&10>d?setTimeout(b.hitch(this,"selectCurrentFolder",a,d+1),1E3):eval("this.folders.id"+a)&&this._createItemFolderSelect.set("value",
eval("this.folders.id"+a))},showUserTags:function(a){arcgisonline.sharing.dijit.dialog.TagsDlg.prototype.statics.getInstance().show()},focusTitle:function(a){this._createItemTitleInput.get("value")==this.defaultTextTitle&&(this._createItemTitleInput.set("value",""),b.style(b.byId("create-item-title"),"color","#000000"))},focusSummary:function(a){this._createItemSummaryInput.get("value")==this.defaultTextSummary&&(this._createItemSummaryInput.set("value",""),b.style(this._createItemSummaryInput.domNode,
"color","#000000"))},onHide:function(a){this.clear()},onKeyDown:function(a){var b;window.event?b=a.keyCode:a.which&&(b=a.which);13==b&&this.uploadItem(a)},toFileCharacters:function(a){a=a.replace(/\ /g,"_");return a=a.toLowerCase()},checkString:function(a){var b=!1;return b=/[\u0021-\u002f\u003a-\u0040\u005b-\u005e\u0060\u007b-\u007e]/g.test(a)}})});