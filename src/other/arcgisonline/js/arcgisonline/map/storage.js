// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/storage",["dijit","dojo","dojox","dojo/require!arcgisonline/map/main,arcgisonline/persist,arcgisonline/sharing/dijit/dialog/SaveWebMapDlg,dojo/cookie"],function(p,e,v){e.provide("arcgisonline.map.storage");e.require("arcgisonline.map.main");e.require("arcgisonline.persist");e.require("arcgisonline.sharing.dijit.dialog.SaveWebMapDlg");e.require("dojo.cookie");arcgisonline.map.storage={store:null,lastCookieSave:null,saveMapInCookie:function(b,c,l,a,g){if(arcgisonline.map.main.map&&
arcgisonline.map.main.map.extent){var f=arcgisonline.sharing.util.getUser(),d=new Date;if(c||!(arcgisonline.map.storage.lastCookieSave&&5E3>d.getTime()-arcgisonline.map.storage.lastCookieSave.getTime())){arcgisonline.map.storage.lastCookieSave=d;var k=arcgisonline.map.storage.buildWebMapText(!0),h=[];e.forEach(arcgisonline.map.main.mapLayers,function(a){if(a.editTrackingFilter&&(a.editTrackingFilter.user||a.editTrackingFilter.time))h.push({id:a.id,filter:a.editTrackingFilter}),k.editTrackingFilter=
h});var m=[];e.forEach(arcgisonline.map.main.mapLayers,function(a){if(a.layer&&"esri.layers.FeatureLayer"==a.layer.declaredClass&&a.layer.url&&(arcgisonline.sharing.util.isHostedService(a.layer.url)||10.1<=a.layer.version)&&!a.layer.queryPagination&&!a.featureLimitExceededHandler)m.push({id:a.id}),k.featureLimitReachedDlgDisabled=m});d=arcgisonline.map.main.map.extent;null!==arcgisonline.map.main.mapLods&&(d=d.expand(0.9));k.e1=d.xmin;k.e2=d.ymin;k.e3=d.xmax;k.e4=d.ymax;k.mapLods=arcgisonline.map.main.mapLods;
k.i=arcgisonline.map.save_open.webMapInfo;k.i&&(k.i.description&&0<k.i.description.length)&&(k.i.description="_r_");k.f=arcgisonline.map.save_open.folderId;k.t=document.getElementById("webmap-title-text").innerHTML;k.t==esri.i18nBundle.viewer.defaultMapTitle&&(k.t="");k.p=arcgisonline.map.leftPanel.getLeftContentPanelStack();"popupStack"===k.p&&(k.pi={},k.pi.type="view",k.pi.layerId=p.byId("popupPanel").layerId,k.pi.subLayerId=p.byId("popupPanel").subLayerId);k.pw=e.style(e.byId("leftDiv"),"width");
"addContentStack"==k.p&&(k.pt=p.byId("addContentSearchFrom").get("value"),k.pu=p.byId("addContentSearchURL").get("value"),k.px=p.byId("addContentSearchText").get("value"),k.px==esri.i18nBundle.addContentPanel.keywordSample&&(k.px=""),k.pe=p.byId("addContentPanel").queryExecuted);k.l=arcgisonline.map.geocode.getValue()||"";if(!f&&("save"==b||"saveAs"==b))k.s=b;k.c=arcgisonline.map.main.mapHasChanged;if((b=arcgisonline.sharing.util.urlToObject(document.URL).query)&&b.timeExtent)k.timeExtent=b.timeExtent;
k.geocoderIndex=arcgisonline.map.geocode.getActiveSource();b=arcgisonline.map.dijit.toc.analysis.getJobsList();esri.isDefined(b)&&0<b.length&&(k.runningAnalysisJobs=b);k.modifyMapAllowed="none"===e.style(e.byId("header_map_modifyMap"),"display");var n=function(a){a?q():g()},q=function(a){if(!a&&arcgisonline.map.main.mapHasChanged)if(arcgisonline.sharing.util.getUser())a=arcgisonline.sharing.dijit.dialog.ChoiceDlg.prototype.statics.getInstance(),a.show({title:esri.i18nBundle.viewer.webMap,message:esri.i18nBundle.viewer.save_open.leavingPageWarningSignedIn,
choiceOneTitle:esri.i18nBundle.viewer.save_open.leavingPageWarningSignedInYesBtn,choiceOneHandler:e.hitch(this,function(){g()}),choiceTwoTitle:esri.i18nBundle.viewer.save_open.leavingPageWarningSignedInNoBtn,choiceTwoHandler:e.hitch(this,function(){})});else{a=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();var b=e.connect(a,"onOkClick",e.hitch(this,function(){e.disconnect(b);g()}));a.show({title:esri.i18nBundle.viewer.webMap,message:esri.i18nBundle.viewer.save_open.leavingPageWarning})}else g()};
b=e.json.stringify(k);(e.isIE&&4864E3<b.length||5101E3<b.length)&&c?arcgisonline.map.main.mapHasChanged&&arcgisonline.map.save_open.webMapInfo&&f&&f.email&&arcgisonline.map.save_open.webMapInfo.owner===f.email?(arcgisonline.sharing.dijit.dialog.ChoiceDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.viewer.save_open.saveWebMapTitle,message:esri.i18nBundle.viewer.save_open.wantToLeave,choiceOneTitle:esri.i18nBundle.viewer.save_open.saveChangesBtn,choiceOneHandler:e.hitch(this,function(){if(arcgisonline.map.save_open.webMapInfo.owner==
f.email){var a=e.subscribe("onSaveExistingWebMap",function(b){e.unsubscribe(a);b==arcgisonline.map.save_open.webMapInfo.id&&l&&l();b==arcgisonline.map.save_open.webMapInfo.id&&g&&n()});arcgisonline.map.storage.saveExistingWebMap(!0)}else a=e.subscribe("onWebMapSave",function(b){e.unsubscribe(a);b==arcgisonline.map.save_open.webMapInfo.id&&l&&l();b==arcgisonline.map.save_open.webMapInfo.id&&g&&n()}),arcgisonline.map.storage.canSaveWithBing()&&arcgisonline.sharing.dijit.dialog.SaveWebMapDlg.prototype.statics.getInstance().addWebMapItem(arcgisonline.map.main.mapLayers,
arcgisonline.map.main.map.extent,arcgisonline.map.save_open.folderId,arcgisonline.map.save_open.webMapInfo)}),choiceTwoTitle:esri.i18nBundle.viewer.save_open.dontSaveChangesBtn,choiceTwoHandler:e.hitch(this,function(){k.webMapId=arcgisonline.map.save_open.webMapInfo.id;delete k.operationalLayers;delete k.baseMap;delete k.widgets;delete k.version;delete k.p;var b=e.json.stringify(k);arcgisonline.map.storage.deleteMapStorageNoFeedback();sessionStorage.setItem("Esri_webmap",b);a&&a(!0);g&&q(!0)})}),
c=esri.i18nBundle.viewer.save_open.saveChangesBtn.length+esri.i18nBundle.viewer.save_open.dontSaveChangesBtn.length,e.style(e.byId("choice-dialog"),"width",Math.min(10*c+150,650)+"px")):arcgisonline.map.save_open.webMapInfo&&f&&arcgisonline.map.save_open.webMapInfo.owner===f.email?(k.webMapId=arcgisonline.map.save_open.webMapInfo.id,delete k.operationalLayers,delete k.baseMap,delete k.widgets,delete k.version,b=e.json.stringify(k),arcgisonline.map.storage.deleteMapStorageNoFeedback(),sessionStorage.setItem("Esri_webmap",
b),l&&l(),g&&n()):arcgisonline.map.save_open.webMapInfo?(k.webMapId=arcgisonline.map.save_open.webMapInfo.id,delete k.operationalLayers,delete k.baseMap,delete k.widgets,delete k.version,b=e.json.stringify(k),arcgisonline.map.storage.deleteMapStorageNoFeedback(),sessionStorage.setItem("Esri_webmap",b),c=!1,arcgisonline.map.main.mapHasChanged&&(c=!0),l&&l(c),g&&n(c)):arcgisonline.map.main.mapHasChanged?(a&&a(),g&&q()):(l&&l(),g&&n()):e.isIE&&4864E3<b.length||5101E3<b.length?arcgisonline.map.save_open.webMapInfo?
(k.webMapId=arcgisonline.map.save_open.webMapInfo.id,delete k.operationalLayers,delete k.baseMap,delete k.widgets,delete k.version,b=e.json.stringify(k),arcgisonline.map.storage.deleteMapStorageNoFeedback(),sessionStorage.setItem("Esri_webmap",b),c=!1,arcgisonline.map.main.mapHasChanged&&(c=!0),l&&l(c),g&&n(c)):(a&&a(),g&&q()):(arcgisonline.map.storage.deleteMapStorageNoFeedback(),sessionStorage.setItem("Esri_webmap",b),l&&l(),g&&n())}}},openWebMapFromCookie:function(){arcgisonline.map.storage.getMapCookie(e.hitch(arcgisonline.map.storage,
"openWebMapFromCookie2"),e.hitch(arcgisonline.map.layer,"loadDefaultMap"))},openWebMapFromCookie2:function(b){e.style(p.byId("webmap-save").domNode,"display","none");b.i&&(arcgisonline.map.save_open.webMapInfo=b.i);b.f&&(arcgisonline.map.save_open.folderTitle="",arcgisonline.map.save_open.folderId=b.f);arcgisonline.map.main.mapHasChanged=b.c;0==b.t.length?arcgisonline.map.main.setTitle(esri.i18nBundle.viewer.defaultMapTitle):arcgisonline.map.main.setTitle(b.t);b.l&&0==b.l.length&&(b.l=esri.i18nBundle.viewer.findLocationText);
arcgisonline.map.geocode.setValue(b.l);esri.isDefined(b.geocoderIndex)&&arcgisonline.map.geocode.setActiveSource(b.geocoderIndex);b.p&&("none"==b.p?arcgisonline.map.leftPanel.hideLeftContentPanel():(leftPanel&&leftPanel.showStack("aboutStack"),arcgisonline.map.leftPanel.showLeftContentPanel(b.pw)));var c=new esri.geometry.Extent(b.e1,b.e2,b.e3,b.e4);c.spatialReference=null;if(b.mapLods){arcgisonline.map.main.mapLods=b.mapLods;arcgisonline.map.main.baseTilingSchemeScales="|";for(i=0;i<arcgisonline.map.main.mapLods.length;i++)arcgisonline.map.main.baseTilingSchemeScales+=
arcgisonline.map.main.mapLods[i].scale+"|"}b.runningAnalysisJobs&&(console.log(b.runningAnalysisJobs),arcgisonline.map.dijit.toc.analysis.setJobsList(b.runningAnalysisJobs),arcgisonline.map.dijit.toc.analysis.checkAnalysisJobs());b.modifyMapAllowed&&e.subscribe("onMapFullyLoaded",function(){arcgisonline.map.role.updateUserActionAfterModify()});if(b.webMapId){arcgisonline.map.save_open.webMapInfo&&arcgisonline.map.main.setTitle(arcgisonline.map.save_open.webMapInfo.title);var l=esriGeowConfig.restBaseUrl+
"content/items/"+b.webMapId+"/data",a=function(a,d){e.mixin(b,a||{});arcgisonline.map.save_open.openedWebMap=b;arcgisonline.map.save_open.startupWebMap(c,b)},g=function(a,b){console.log(a);arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.downloadFailed})};arcgisonline.sharing.util.getJson(l,e.hitch(this,a),e.hitch(this,g))}else!arcgisonline.map.save_open.webMapInfo&&1==b.operationalLayers.length&&
b.operationalLayers[0].itemId?(l=esriGeowConfig.restBaseUrl+"content/items/"+b.operationalLayers[0].itemId,a=function(a,d){arcgisonline.map.save_open.itemCard=a;arcgisonline.map.save_open.openedWebMap=b;arcgisonline.map.save_open.startupWebMap(c,b);"aboutStack"==arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.recreateAboutStack()},g=function(a,d){console.log(a);arcgisonline.map.save_open.openedWebMap=b;arcgisonline.map.save_open.startupWebMap(c,b)},arcgisonline.sharing.util.getJson(l,
e.hitch(this,a),e.hitch(this,g))):(arcgisonline.map.save_open.openedWebMap=b,arcgisonline.map.save_open.startupWebMap(c,b))},deleteMapCookie:function(){arcgisonline.map.storage.deleteMapStorageNoFeedback()},deleteMapStorageNoFeedback:function(){sessionStorage.removeItem("Esri_webmap");var b=arcgisonline.persist;e.cookie("ESRI_Webmap",null,{expires:-1,path:"/",domain:document.domain});arcgisonline.map.storage.store||(arcgisonline.map.storage.store=new b.Store("ESRI_Webmap"));try{arcgisonline.map.storage.store.set("webmap",
""),localStorage.removeItem("PSESRI__WebmapPSwebmap")}catch(c){}},getMapCookie:function(b,c){var l=sessionStorage.getItem("Esri_webmap");l&&l.length?b(e.json.parse(l)):(l=arcgisonline.persist,c||(c=b),arcgisonline.map.storage.store||(arcgisonline.map.storage.store=new l.Store("ESRI_Webmap")),arcgisonline.map.storage.store.get("webmap",function(a,g){a&&null!=g?0<g.toString().length?b(e.json.parse(g)):c(null):c(null)},function(a,g){a&&null!=g?0<g.toString().length?b(e.json.parse(g)):c(null):c(null)}))},
saveWebMapClick:function(b,c,l){"editStack"==arcgisonline.map.leftPanel.getLeftContentPanelStack()&&arcgisonline.map.leftPanel.openLeftTOCPanel();if(arcgisonline.sharing.util.isLoggedIn()){arcgisonline.map.storage.saveMapInCookie(b,!1);var a=arcgisonline.sharing.util.getUser();null==arcgisonline.map.save_open.webMapInfo||arcgisonline.map.save_open.webMapInfo.owner!==a.email&&"admin"!==arcgisonline.map.save_open.webMapInfo.itemControl&&"update"!==arcgisonline.map.save_open.webMapInfo.itemControl||
"saveAs"==b?arcgisonline.map.storage.canSaveWithBing()&&(b=arcgisonline.sharing.dijit.dialog.SaveWebMapDlg.prototype.statics.getInstance(),e.subscribe("onWebMapSave",null,e.hitch(arcgisonline.map.storage,"onWebMapSave")),b.addWebMapItem(arcgisonline.map.main.mapLayers,arcgisonline.map.main.map.extent,arcgisonline.map.save_open.folderId,arcgisonline.map.save_open.webMapInfo,c,l)):arcgisonline.map.storage.saveExistingWebMap(null,c,l)}else arcgisonline.map.main.signInWithPopupAndSave(b)},saveExistingWebMap:function(b,
c,l){var a=[];e.forEach(arcgisonline.map.main.mapLayers,function(b,c){arcgisonline.map.featColl.isFeatureCollection(b)&&b.dataChanged&&a.push(arcgisonline.map.itemData.uploadItemLayerInfos(b,null,!0))},this);a.length?(new e.DeferredList(a)).addCallback(function(a){arcgisonline.map.storage.saveExistingWebMap_AfterFCItemCheck(b,c,l)}):arcgisonline.map.storage.saveExistingWebMap_AfterFCItemCheck(b,c,l)},saveExistingWebMap_AfterFCItemCheck:function(b,c,l){var a=arcgisonline.map.main.map.extent;a.spatialReference._isWrappable()?
esri.geometry.normalizeCentralMeridian([a],null,e.hitch(this,function(g){if(g[0].rings){var f=(new esri.geometry.Polygon(a.spatialReference)).addRing(g[0].rings[0]).getExtent();g=(new esri.geometry.Polygon(a.spatialReference)).addRing(g[0].rings[1]).getExtent();a=f.getWidth()>g.getWidth()?f:g}else a=g[0];arcgisonline.map.main.extentToGCSString(a,e.hitch(arcgisonline.map.storage,"saveExistingWebMapPart2",b,c,l))})):arcgisonline.map.main.mapExtentToGCSString(e.hitch(arcgisonline.map.storage,"saveExistingWebMapPart2",
b,c,l))},saveExistingWebMapPart2:function(b,c,l,a){if("_r_"==arcgisonline.map.save_open.webMapInfo.description){var g=esriGeowConfig.restBaseUrl+"content/items/"+arcgisonline.map.save_open.webMapInfo.id;l=function(a,b){if(a&&400==a.code){arcgisonline.map.save_open.webMapInfo=null;arcgisonline.map.main.setTitle(esri.i18nBundle.viewer.defaultMapTitle);var c=arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance();c.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.mapIsDeleted})}else c=
arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance(),c.show({title:esri.i18nBundle.generalDlg.errorDlgTitle,message:esri.i18nBundle.viewer.error.mapNotAccessible})};arcgisonline.sharing.util.getJson(g,e.hitch(this,function(d,f){arcgisonline.map.save_open.webMapItemCard=d;e.mixin(arcgisonline.map.save_open.webMapInfo,{description:d.description});arcgisonline.map.storage.saveExistingWebMapPart2(b,c,l,a)}),e.hitch(this,l))}else{g=arcgisonline.map.storage.buildWebMapText();g.runningAnalysisJobs&&
delete g.runningAnalysisJobs;var f="Web Map, Explorer Web Map, Map, Online Map, ArcGIS Online";arcgisonline.map.save_open.webMapItemCard&&arcgisonline.map.save_open.webMapItemCard.typeKeywords&&(f=arcgisonline.map.save_open.webMapItemCard.typeKeywords.toString());f=arcgisonline.map.main.adjustWebMapTypeKeywords(f);g={item:arcgisonline.map.save_open.webMapInfo.item,name:arcgisonline.map.save_open.webMapInfo.name,title:arcgisonline.map.save_open.webMapInfo.title,description:arcgisonline.map.save_open.webMapInfo.description,
tags:arcgisonline.map.save_open.webMapInfo.tags.toString(),snippet:arcgisonline.map.save_open.webMapInfo.snippet,extent:a,text:e.json.stringify(g),type:"Web Map",typeKeywords:f,overwrite:!0};f=arcgisonline.sharing.dijit.dialog.WaitingDlg.prototype.statics.getInstance();f.show({title:esri.i18nBundle.common.save,message:esri.i18nBundle.viewer.save_open.savingMap});arcgisonline.map.storage.saveExistingWebMapPart3(g,b,f,c,l)}},saveExistingWebMapPart3:function(b,c,l,a,g){var f=function(b,d){l.hide();arcgisonline.map.main.unmarkMapAsChanged();
arcgisonline.map.storage.saveMapInCookie(null,!0==c?!0:!1);e.publish("onSaveExistingWebMap",[b.id]);a&&a(b.id);(null==arcgisonline.map.save_open.webMapInfo.thumbnail||-1<arcgisonline.map.save_open.webMapInfo.thumbnail.indexOf("thumbnail/ago_downloaded"))&&arcgisonline.map.thumbnail.buildThumbnailURLFromMap(e.hitch(this,function(a){var b=arcgisonline.sharing.util.getUser(),b=esriGeowConfig.restBaseUrl+"content/users/"+b.email;null!=arcgisonline.map.save_open.folderTitle&&("/"!=arcgisonline.map.save_open.folderTitle&&
esri.isDefined(arcgisonline.map.save_open.folderId)&&arcgisonline.map.save_open.folderId.length)&&(b+="/"+arcgisonline.map.save_open.folderId);b+="/items/"+arcgisonline.map.save_open.webMapInfo.id+"/update";arcgisonline.sharing.util.postJsonCheckProxy({thumbnailURL:a},b,e.hitch(this,function(a){arcgisonline.map.save_open.webMapInfo.thumbnail="thumbnail/ago_downloaded.png"}))}))},d=function(a,b){l.hide();arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.generalDlg.errorDlgTitle,
message:e.string.substitute(esri.i18nBundle.viewer.save_open.mapNotSaved,{title:arcgisonline.map.save_open.webMapInfo.title})});g&&g(a)};arcgisonline.map.storage.getItemFolder(e.hitch(this,function(a,c){var g=esriGeowConfig.restBaseUrl+"content/users/"+arcgisonline.map.save_open.webMapInfo.owner;null!=arcgisonline.map.save_open.folderTitle&&("/"!=arcgisonline.map.save_open.folderTitle&&esri.isDefined(arcgisonline.map.save_open.folderId)&&arcgisonline.map.save_open.folderId.length)&&(g+="/"+arcgisonline.map.save_open.folderId);
g+="/items/"+arcgisonline.map.save_open.webMapInfo.id+"/update";arcgisonline.sharing.util.postJsonCheckProxy(b,g,e.hitch(this,f),e.hitch(this,d))}),e.hitch(this,d))},saveNewWebMap:function(b,c,l){var a=new e.Deferred,g=arcgisonline.sharing.util.getUser();if(null==g){var f=Error("User must be logged in to save a map.");f.messageCode="VIEWER_0002";a.errback(f);return a}if(!b||!c)return f=Error("Must provide a title and tags for new Web Map."),f.messageCode="VIEWER_0003",a.errback(f),a;var d=function(a){a=
a.replace(/\ /g,"_");return a=a.toLowerCase()};(function(a){var b=function(e,f){for(i=0;i<e.results.length;i++)d.push(e.results[i].title);0<e.nextStart?arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+'search?num\x3d100\x26q\x3d%2Btype:"Web Map"%20%2Bitemtype:text%20%2Bowner:'+g.email+"\x26start\x3d"+e.nextStart,b,c):a(d)},c=function(b,c){console.log("Search for all maps failed ("+b.message+").");a(d)},d=[];arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+'search?num\x3d100\x26q\x3d%2Btype:"Web Map"%20%2Bitemtype:text%20%2Bowner:'+
g.email,b,c)})(function(f){if(-1<e.indexOf(f,b))f=Error("User already has an item with title '"+b+"'."),f.messageCode="VIEWER_0001",a.errback(f);else{var g=d(b)+"_"+(new Date).getTime(),m=arcgisonline.map.storage.buildWebMapText(),n={item:g,title:b,tags:c,snippet:null,description:null,accessInformation:null,licenseInfo:null,text:e.json.stringify(m),type:"Web Map",typeKeywords:"Web Map,Explorer Web Map,Map,Online Map,ArcGIS Online",overwrite:!1};arcgisonline.map.main.getGCSString().then(function(d){n.extent=
d;var f=arcgisonline.sharing.util.getUser();d=esriGeowConfig.restBaseUrl+"content/users/"+f.email;esri.isDefined(l)&&l.length&&(d+="/"+l);arcgisonline.sharing.util.postJsonCheckProxy(n,d+"/addItem").then(function(d,k){d.success&&(arcgisonline.map.save_open.openedWebMap=m,e.subscribe("onWebMapSave",null,e.hitch(arcgisonline.map.storage,"onWebMapSave")),e.publish("onWebMapSave",[d.id,f.email,g,g,b,"",c.split(","),"",null,null,null,l,["Web Map","Explorer Web Map","Map","Online Map","ArcGIS Online"]]),
arcgisonline.map.role.updateUIAfterSaveAs(),a.callback(d.id),arcgisonline.map.thumbnail.buildThumbnailURLFromMap(function(a){var b=esriGeowConfig.restBaseUrl+"content/users/"+f.email;esri.isDefined(l)&&l.length&&(b+="/"+l);b+="/items/"+arcgisonline.map.save_open.webMapInfo.id+"/update";arcgisonline.sharing.util.postJsonCheckProxy({thumbnailURL:a},b).then(function(a){arcgisonline.map.save_open.webMapInfo&&(arcgisonline.map.save_open.webMapInfo.thumbnail="thumbnail/ago_downloaded.png")})}))},function(b,
c){a.errback(b)})})}});return a},buildWebMapText:function(){var b=[],c={},l=[];c.baseMapLayers=l;if(null!=arcgisonline.map.main.mapLayers)for(i=0;i<arcgisonline.map.main.mapLayers.length;i++){var a=arcgisonline.map.main.mapLayers[i];if(arcgisonline.map.featColl.isFeatureCollection(a))b.push(arcgisonline.map.featColl.buildConfig(a));else if(a.layer instanceof esri.layers.CSVLayer){var g=a.layer.toJson();a.layer.minScale||a.layer.maxScale?(g.layerDefinition.minScale=a.layer.minScale,g.layerDefinition.maxScale=
a.layer.maxScale,g.layerDefinition.minScale===Number.POSITIVE_INFINITY&&(g.layerDefinition.minScale=0)):(delete g.layerDefinition.minScale,delete g.layerDefinition.maxScale);g.layerDefinition.extent=arcgisonline.map.featColl.getLayerFullExtent(a.layer);var f={};f.id=a.id;f.type="CSV";f.layerType="CSV";f.title=a.title;f.visibility=a.layer.visible;f.opacity=a.layer.opacity||0===a.layer.opacity?a.layer.opacity:1;f.url=a.url;f.layerDefinition=g.layerDefinition;f.popupInfo=a.popupInfo;f.locationInfo=a.locationInfo?
a.locationInfo:null;f.columnDelimiter=a.columnDelimiter?a.columnDelimiter:",";a.layer.refreshInterval&&(f.refreshInterval=a.layer.refreshInterval);!1===a.showLegend&&(f.showLegend=!1);b.push(f)}else if(a.layer instanceof esri.layers.GeoRSSLayer)b.push(arcgisonline.map.geoRSS.buildConfig(a));else if(a.layer instanceof esri.layers.WebTiledLayer)"base"==a.type||"labels"==a.type?l.push(arcgisonline.map.webTile.buildConfig(a)):b.push(arcgisonline.map.webTile.buildConfig(a));else if(a.layer instanceof esri.layers.VectorTileLayer)"base"==
a.type||"labels"==a.type?l.push(arcgisonline.map.vectorTile.buildConfig(a)):b.push(arcgisonline.map.vectorTile.buildConfig(a));else if(a.layer instanceof esri.layers.StreamLayer)b.push(arcgisonline.map.stream.buildConfig(a));else if("user"==a.type){if(a.layer){var d={};d.id=a.id;if(a.layer)switch(a.layer.declaredClass){case "esri.layers.FeatureLayer":d.layerType="ArcGISFeatureLayer";break;case "esri.layers.ArcGISDynamicMapServiceLayer":d.layerType="ArcGISMapServiceLayer";break;case "esri.layers.ArcGISTiledMapServiceLayer":-1<
a.layer.url.toLowerCase().indexOf("/imageserver")?d.layerType="ArcGISTiledImageServiceLayer":d.layerType="ArcGISTiledMapServiceLayer";break;case "esri.layers.ArcGISImageServiceLayer":d.layerType="ArcGISImageServiceLayer";break;case "esri.layers.ArcGISImageServiceVectorLayer":d.layerType="ArcGISImageServiceVectorLayer"}d.url=a.url;a.exclusionAreas&&(d.exclusionAreas=a.exclusionAreas);d.visibility=a.layer?a.layer.visible:a.defaultVisibility;esri.isDefined(a.visibleLayers)&&(f=[],""!==a.visibleLayers&&
(f=a.visibleLayers.split(",")),a.layer instanceof esri.layers.WMSLayer?d.visibleLayers=f:a.visibleLayersChanged&&(d.visibleLayers=e.map(f,function(a){return parseInt(a)})));a.layer&&a.layer.bandIds&&a.renderingRuleChanged?d.bandIds=a.layer.bandIds:null==a.layer&&null!=a.defaultBandIds&&(d.bandIds=a.defaultBandIds);a.layer&&(a.layer.format&&a.imageQualityChanged)&&(d.format=a.layer.format);a.layer&&(a.layer.compressionQuality&&a.imageQualityChanged)&&(d.compressionQuality=a.layer.compressionQuality);
a.layer&&esri.isDefined(a.layer.opacity)?d.opacity=a.layer.opacity:d.opacity=null==a.layer&&null!==a.defaultOpacity?a.defaultOpacity:1;null!=a.mode&&(d.mode=a.mode);d.title=a.title;a.infoTemplate&&(d.infoTemplate=a.infoTemplate);a.itemId&&(d.itemId=a.itemId);esri.isDefined(a.layer.refreshInterval)&&a.refreshIntervalChanged&&(d.refreshInterval=a.layer.refreshInterval||0);if(a.timeChanged)if(a.layer instanceof esri.layers.FeatureLayer)if(a.origItemLayers){var k=parseInt(a.layer.url.substring(a.layer.url.lastIndexOf("/")+
1));e.forEach(a.origItemLayers,function(b){b.id==k&&(!1==a.layer.useMapTime?esri.isDefined(b.timeAnimation)||(d.timeAnimation=!1):esri.isDefined(b.timeAnimation)&&(d.timeAnimation=!0))})}else!1==a.layer.useMapTime&&(d.timeAnimation=!1);else(f=arcgisonline.map.itemData.itemDataContents[a.itemId])?!1==a.layer.useMapTime?esri.isDefined(f.timeAnimation)||(d.timeAnimation=!1):esri.isDefined(f.timeAnimation)&&(d.timeAnimation=!0):!1==a.layer.useMapTime&&(d.timeAnimation=!1);a.layerDefinition&&(d.layerDefinition=
e.clone(a.layerDefinition));a.defExpChanged?d.layerDefinition&&(d.layerDefinition.definitionExpression&&a.definitionEditor)&&(d.definitionEditor=e.clone(a.definitionEditor)):d.layerDefinition&&(delete d.layerDefinition.definitionExpression,esri.isEmpty(d.layerDefinition)&&delete d.layerDefinition);a.layer instanceof esri.layers.FeatureLayer&&(a.rendererChanged?(d.layerDefinition=d.layerDefinition||{},d.layerDefinition.drawingInfo=d.layerDefinition.drawingInfo||{},d.layerDefinition.drawingInfo.renderer=
a.layer.renderer.toJson(),a.layer.labelingInfo&&a.showLabels&&(d.layerDefinition.drawingInfo.labelingInfo=e.map(a.layer.labelingInfo,function(a){return a.toJson()}),d.showLabels=!0)):d.layerDefinition&&(delete d.layerDefinition.drawingInfo,esri.isEmpty(d.layerDefinition)&&delete d.layerDefinition));if(a.scaleChanged)if(a.layer instanceof esri.layers.FeatureLayer){if(d.layerDefinition=d.layerDefinition||{},d.layerDefinition.minScale=a.layer.minScale?a.layer.minScale:0,d.layerDefinition.maxScale=a.layer.maxScale&&
1!==a.layer.maxScale&&d.layerDefinition.minScale!==Number.POSITIVE_INFINITY?a.layer.maxScale:0,0===d.layerDefinition.minScale&&0===d.layerDefinition.maxScale){var k=parseInt(a.layer.url.substring(a.layer.url.lastIndexOf("/")+1)),h=null;if(a.itemId&&a.origItemLayers)for(f=0;f<a.origItemLayers.length;f++){var m=a.origItemLayers[f];if(m.id===k){h=m;break}}f=a.serviceInfo;if(h&&h.layerDefinition&&esri.isDefined(h.layerDefinition.minScale)&&esri.isDefined(h.layerDefinition.maxScale))0!==h.layerDefinition.minScale||
0!==h.layerDefinition.maxScale||(delete d.layerDefinition.minScale,delete d.layerDefinition.maxScale);else if(f&&(esri.isDefined(f.minScale)&&esri.isDefined(f.maxScale))&&!(0!==f.minScale||0!==f.maxScale))delete d.layerDefinition.minScale,delete d.layerDefinition.maxScale;esri.isEmpty(d.layerDefinition)&&delete d.layerDefinition}}else if(a.layer instanceof esri.layers.WMSLayer||a.layer instanceof esri.layers.KMLLayer){if(a.layer.minScale||a.layer.maxScale)d.minScale=a.layer.minScale,d.maxScale=a.layer.maxScale}else a.layer instanceof
esri.layers.ArcGISDynamicMapServiceLayer||(d.minScale=a.layer.minScale?a.layer.minScale:0,d.maxScale=a.layer.maxScale&&1!==a.layer.maxScale?a.layer.maxScale:0);else a.layer instanceof esri.layers.WMSLayer&&(a.layer.minScale||a.layer.minScale)?(d.minScale=a.layer.minScale,d.maxScale=a.layer.maxScale):d.layerDefinition&&(delete d.layerDefinition.minScale,delete d.layerDefinition.maxScale,esri.isEmpty(d.layerDefinition)&&delete d.layerDefinition);if(a.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer&&
(a.scaleChanged||arcgisonline.map.main.hasDynamicLayers(a))){var h=a.layer.minScale,m=a.layer.maxScale,n=a.serviceInfo.minScale,q=a.serviceInfo.maxScale;if(f=arcgisonline.map.itemData.itemDataContents[a.itemId]){var p=f.minScale,f=f.maxScale;if(esri.isDefined(p)&&esri.isDefined(f)&&(h!==p||m!==f))d.minScale=a.layer.minScale?a.layer.minScale:0,d.maxScale=a.layer.maxScale&&1!==a.layer.maxScale?a.layer.maxScale:0;else if(h!==n||m!==q)d.minScale=a.layer.minScale?a.layer.minScale:0,d.maxScale=a.layer.maxScale&&
1!==a.layer.maxScale?a.layer.maxScale:0}else if(h!==n||m!==q)d.minScale=a.layer.minScale?a.layer.minScale:0,d.maxScale=a.layer.maxScale&&1!==a.layer.maxScale?a.layer.maxScale:0}a.popupInfo&&a.popupChanged&&(d.popupInfo=a.popupInfo);a.disablePopup&&a.popupChanged&&(d.disablePopup=!0);if(a.legendChanged)!1===a.showLegend?d.showLegend=!1:a.layer instanceof esri.layers.FeatureLayer&&(d.showLegend=!0);else if((a.layer instanceof esri.layers.ArcGISDynamicMapServiceLayer||a.layer instanceof esri.layers.ArcGISTiledMapServiceLayer)&&
!1===a.showLegend)d.showLegend=!1;if(a.itemLayers&&(!a.itemId||!a.origItemLayers||a.origItemLayers&&e.json.stringify(a.origItemLayers)!==e.json.stringify(a.itemLayers)))if(a.legendChanged||a.popupChanged||a.rendererChanged||a.scaleChanged||a.defExpChanged||a.layersChanged)a.itemLayers.length?(d.layers=e.map(a.itemLayers,function(a){delete a._layerInfo;return a}),a.thematicGroup&&(d.thematicGroup=a.thematicGroup)):a.origItemLayers&&(d.layers={});a.layer instanceof esri.layers.FeatureLayer&&(a.serviceInfo&&
a.serviceInfo._origCapabilities)&&(d.capabilities=a.layer.capabilities);a.layer instanceof esri.layers.WMSLayer?e.mixin(d,arcgisonline.map.wms.buildConfig(a.layer)):a.layer instanceof esri.layers.KMLLayer?e.mixin(d,arcgisonline.map.kml.buildConfig(a.layer)):a.layer instanceof esri.layers.ArcGISImageServiceLayer?(a.layer.renderingRule&&a.renderingRuleChanged&&(d.renderingRule=a.layer.renderingRule.toJson()),a.layer.mosaicRule&&a.mosaicRuleChanged&&(d.mosaicRule=a.layer.mosaicRule.toJson())):a.layer instanceof
esri.layers.ArcGISImageServiceVectorLayer&&(a.rendererChanged&&(d.symbolTileSize=a.layer.symbolTileSize||null,d.layerDefinition=d.layerDefinition||{},d.layerDefinition.drawingInfo=d.layerDefinition.drawingInfo||{},d.layerDefinition.drawingInfo.renderer=a.layer.renderer.toJson()),a.layer.mosaicRule&&a.mosaicRuleChanged&&(d.mosaicRule=a.layer.mosaicRule.toJson()));b[b.length]=d}}else if("base"==a.type){if(a.layer.visible){h={};h.id=a.layer.id;switch(a.layer.declaredClass){case "esri.layers.ArcGISDynamicMapServiceLayer":h.layerType=
"ArcGISMapServiceLayer";break;case "esri.layers.ArcGISTiledMapServiceLayer":-1<a.layer.url.toLowerCase().indexOf("/imageserver")?h.layerType="ArcGISTiledImageServiceLayer":h.layerType="ArcGISTiledMapServiceLayer";break;case "esri.layers.ArcGISImageServiceLayer":h.layerType="ArcGISImageServiceLayer"}esri.isDefined(a.layer.opacity)?h.opacity=a.layer.opacity:h.opacity=1;h.visibility=!0;if(a.layer instanceof esri.virtualearth.VETiledLayer){switch(a.layer.mapStyle){case esri.virtualearth.VETiledLayer.MAP_STYLE_ROAD:h.type=
"BingMapsRoad";h.layerType="BingMapsRoad";break;case esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL_WITH_LABELS:h.type="BingMapsHybrid";h.layerType="BingMapsHybrid";break;default:h.type="BingMapsAerial",h.layerType="BingMapsAerial"}esriGeowConfig.self.bingKey&&(h.portalUrl=esriGeowConfig.self.isPortal?location.protocol+"//"+esriGeowConfig.self.portalHostname+"/sharing/rest/portals/"+esriGeowConfig.self.id:location.protocol+"//"+esriGeowConfig.self.urlKey+"."+esriGeowConfig.self.customBaseUrl+"/sharing/rest/portals/"+
esriGeowConfig.self.id,h.portalUrl="https:"===location.protocol?arcgisonline.sharing.util.getSecureUrl(h.portalUrl):arcgisonline.sharing.util.getHttpUrl(h.portalUrl));c.title=a.title}else if(a.layer instanceof esri.layers.OpenStreetMapLayer)h.type="OpenStreetMap",h.layerType="OpenStreetMap",c.title=a.title;else{h.url=a.url;a.exclusionAreas&&(h.exclusionAreas=a.exclusionAreas);a.layer.bandIds&&(h.bandIds=a.layer.bandIds);c.title=a.title;a.itemId&&(h.itemId=a.itemId);esri.isDefined(a.minScale)&&(esri.isDefined(a.maxScale)&&
!(0==a.minScale&&0==a.maxScale))&&(h.minScale=a.minScale,h.maxScale=a.maxScale);a.displayLevels&&(h.displayLevels=a.displayLevels);a.visibleLayers&&(h.visibleLayers=a.visibleLayers);a.layer instanceof esri.layers.WMSLayer&&(e.mixin(h,arcgisonline.map.wms.buildConfig(a.layer)),esri.isDefined(a.visibleLayers)&&(h.visibleLayers=""===a.visibleLayers?[]:a.visibleLayers.split(",")));!0===a.showLegend&&(h.showLegend=!0);if(esri.isDefined(a.layer.refreshInterval)&&a.refreshIntervalChanged)if(m=a.layer.refreshInterval||
0,a.itemId)if(f=arcgisonline.map.itemData.itemDataContents[a.itemId]){if(!esri.isDefined(f.refreshInterval)||f.refreshInterval!==m)h.refreshInterval=m}else h.refreshInterval=m;else h.refreshInterval=m;a.timeChanged&&((f=arcgisonline.map.itemData.itemDataContents[a.itemId])?!1==a.layer.useMapTime?esri.isDefined(f.timeAnimation)||(h.timeAnimation=!1):esri.isDefined(f.timeAnimation)&&(h.timeAnimation=!0):h.timeAnimation=!1)}l[l.length]=h}}else if("labels"==a.type&&a.layer.visible){h={};h.id=a.layer.id;
switch(a.layer.declaredClass){case "esri.layers.ArcGISDynamicMapServiceLayer":h.layerType="ArcGISMapServiceLayer";break;case "esri.layers.ArcGISTiledMapServiceLayer":-1<a.layer.url.toLowerCase().indexOf("/imageserver")?h.layerType="ArcGISTiledImageServiceLayer":h.layerType="ArcGISTiledMapServiceLayer";break;case "esri.layers.ArcGISImageServiceLayer":h.layerType="ArcGISImageServiceLayer"}h.isReference=!0;esri.isDefined(a.layer.opacity)?h.opacity=a.layer.opacity:h.opacity=1;h.visibility=!0;h.url=a.url;
a.exclusionAreas&&(h.exclusionAreas=a.exclusionAreas);esri.isDefined(a.minScale)&&(esri.isDefined(a.maxScale)&&!(0==a.minScale&&0==a.maxScale))&&(h.minScale=a.minScale,h.maxScale=a.maxScale);a.layer.bandIds&&(h.bandIds=a.layer.bandIds);a.displayLevels&&(h.displayLevels=a.displayLevels);esri.isDefined(a.visibleLayers)&&(h.visibleLayers=a.visibleLayers);l[l.length]=h}}var t=[],r=[],h=[];e.forEach(arcgisonline.map.main.mapTables,function(a){a.itemId&&arcgisonline.map.featColl.isFeatureCollection(a)&&
(-1<e.indexOf(t,a.itemId)?-1===e.indexOf(r,a.itemId)&&r.push(a.itemId):t.push(a.itemId))});l=[];for(i=0;i<arcgisonline.map.main.mapTables.length;i++)if(a=arcgisonline.map.main.mapTables[i],arcgisonline.map.featColl.isFeatureCollection(a)){if(!(a.itemId&&-1<e.indexOf(h,a.itemId)))if(g=arcgisonline.map.featColl.buildConfig(a),a.layer&&("Table"===a.layer.type&&g.title.endsWith(" - "+a.layer.name))&&(g.title=g.title.substring(0,g.title.indexOf(" - "+a.layer.name)),g.id=g.id.substring(0,g.id.lastIndexOf("_"))),
-1<e.indexOf(r,a.itemId)){var s=!1;e.forEach(arcgisonline.map.main.mapTables,function(b,c){b.itemId===a.itemId&&(s=s||b.popupChanged)});if(s)if(g.featureCollection&&g.featureCollection.layers)for(f=1;f<a.featureCollection.layers.length;f++)g.featureCollection.layers.push({});else{g.featureCollection=g.featureCollection||{};g.featureCollection.layers=g.featureCollection.layers||[];for(f=0;f<a.featureCollection.layers.length;f++)g.featureCollection.layers.push({});a.layer.infoTemplate&&(g.featureCollection.layers[0].popupInfo=
a.layer.infoTemplate.toJson())}e.forEach(arcgisonline.map.main.mapTables,function(b,c){c!==i&&b.itemId===a.itemId&&b.layer.infoTemplate&&(g.featureCollection.layers[c].popupInfo=b.layer.infoTemplate.toJson())});b.splice(0,0,g);h.push(a.itemId)}else b.splice(0,0,g)}else f={},f.url=a.url,f.id=a.layer.id,f.title=a.title,a.layerDefinition&&(f.layerDefinition=e.clone(a.layerDefinition),f.layerDefinition.definitionExpression&&a.definitionEditor&&(f.definitionEditor=e.clone(a.definitionEditor))),a.itemId&&
(f.itemId=a.itemId),a.popupInfo&&a.popupChanged&&(f.popupInfo=a.popupInfo),a.serviceInfo&&a.serviceInfo._origCapabilities&&(f.capabilities=a.layer.capabilities),l.push(f);f=null;if(arcgisonline.map.time.timeSliderProperties&&(f||(f={}),f.timeSlider={},h=arcgisonline.map.time.toJson()))f.timeSlider.properties=h;b={operationalLayers:b,baseMap:c,spatialReference:arcgisonline.map.main.map.spatialReference.toJson(),widgets:f};e.mixin(b,arcgisonline.map.mapUtil.getWebMapAuthoringInfo());l.length&&(b.tables=
l);arcgisonline.map.main.bookmarksTool?(c=arcgisonline.map.main.bookmarksTool.toJson(),0<c.length&&(b.bookmarks=c)):arcgisonline.map.save_open.openedWebMap&&arcgisonline.map.save_open.openedWebMap.bookmarks&&(b.bookmarks=arcgisonline.map.save_open.openedWebMap.bookmarks);b=arcgisonline.map.storage.addAppProperties(b);b=arcgisonline.map.storage.addWebMapSpecificInfo(b);(!b.widgets||esri.isEmpty(b.widget))&&delete b.widgets;return b},addAppProperties:function(b){var c=arcgisonline.map.save_open.openedWebMap,
l=arcgisonline.map.main.getMapLayerInfo();if(l.hasEditableLayer){b.applicationProperties={viewing:{routing:{enabled:!0},basemapGallery:{enabled:!0},measure:{enabled:!0}}};if(c&&c.applicationProperties){if(c.applicationProperties.editing&&c.applicationProperties.editing.locationTracking){var a=arcgisonline.map.main.getParameterListById(c.applicationProperties.editing.locationTracking.info.layerId);!a||!a.layer.isEditable()?delete c.applicationProperties.editing:b.applicationProperties.editing=e.clone(c.applicationProperties.editing)}c.applicationProperties.viewing&&
c.applicationProperties.viewing.routing&&(b.applicationProperties.viewing.routing=e.clone(c.applicationProperties.viewing.routing));c.applicationProperties.viewing&&c.applicationProperties.viewing.basemapGallery&&(b.applicationProperties.viewing.basemapGallery=e.clone(c.applicationProperties.viewing.basemapGallery));c.applicationProperties.viewing&&c.applicationProperties.viewing.measure&&(b.applicationProperties.viewing.measure=e.clone(c.applicationProperties.viewing.measure));c.applicationProperties.viewing&&
c.applicationProperties.viewing.search&&(c=arcgisonline.map.storage.checkSearchableLayers(c),b.applicationProperties.viewing.search=e.clone(c.applicationProperties.viewing.search))}if(l.trackingLayerId&&(a=arcgisonline.map.main.getParameterListById(l.trackingLayerId),a.layer.isEditable()&&(!b.applicationProperties.editing||!b.applicationProperties.editing.locationTracking)))b.applicationProperties.editing={locationTracking:{enabled:!1,info:{layerId:l.trackingLayerId,updateInterval:300}}}}else c&&
(c.applicationProperties&&c.applicationProperties.viewing?(delete c.applicationProperties.editing,c=arcgisonline.map.storage.checkSearchableLayers(c),b.applicationProperties=e.clone(c.applicationProperties)):delete c.applicationProperties);return b},checkSearchableLayers:function(b){if(b.applicationProperties.viewing&&b.applicationProperties.viewing.search&&b.applicationProperties.viewing.search.layers){var c=[];e.forEach(b.applicationProperties.viewing.search.layers,function(b,a){var g=!1;e.forEach(arcgisonline.map.main.mapLayers,
function(a){a.id===b.id&&(g=!0)});g||c.push(a)});c.reverse();e.forEach(c,function(c){b.applicationProperties.viewing.search.layers.splice(c,1)})}return b},addWebMapSpecificInfo:function(b){if(arcgisonline.map.save_open.openedWebMap){var c=e.json.parse(e.json.stringify(arcgisonline.map.save_open.openedWebMap));c.widgets&&(delete c.widgets.editor,delete c.widgets.timeSlider,e.mixin(c.widgets,b.widgets),esri.isEmpty(c.widgets)&&delete c.widgets);delete c.baseMap;delete c.operationalLayers;delete c.tables;
delete c.spatialReference;delete c.applicationProperties;delete c.bookmarks;delete c.version;delete c.authoringApp;delete c.authoringAppVersion;delete c.e1;delete c.e2;delete c.e3;delete c.e4;delete c.mapLods;delete c.i;delete c.f;delete c.t;delete c.pi;delete c.pw;delete c.p;delete c.pt;delete c.pu;delete c.px;delete c.pe;delete c.l;delete c.c;delete c.s;delete c.timeExtent;delete c.editTrackingFilter;delete c.featureLimitReachedDlgDisabled;delete c.geocoderIndex;delete c.modifyMapAllowed;delete c.runningAnalysisJobs;
e.mixin(b,c)}return b},onWebMapSave:function(b,c,e,a,g,f,d,k,h,m,n,q,u){arcgisonline.map.save_open.webMapInfo={id:b,owner:c,ownerFolder:q,item:e,name:a,title:g,description:f,tags:d,snippet:k,thumbnail:h,typeKeywords:u,accessInformation:m,licenseInfo:n,deleteExplorerSlides:!1};arcgisonline.map.save_open.folderTitle="";arcgisonline.map.save_open.folderId=q;arcgisonline.map.save_open.webMapItemCard=null;arcgisonline.map.main.setTitle(g);arcgisonline.map.main.unmarkMapAsChanged();arcgisonline.map.main.updateHeaderPresentationLink();
arcgisonline.map.storage.saveMapInCookie(null,!1);arcgisonline.map.edit.checkOnEditButton();"undefined"!=typeof leftPanel&&leftPanel.checkAboutStack();p.byId("webmap-save-save").set("disabled",!1);arcgisonline.sharing.dijit.dialog.ShareMapDlg.prototype.statics._instance&&(arcgisonline.sharing.dijit.dialog.ShareMapDlg.prototype.statics.getInstance().sharingInfo=null);"undefined"!==typeof history.pushState&&window.history.pushState(null,null,"?webmap\x3d"+b);setTimeout("arcgisonline.map.main.map.reposition()",
500)},getItemFolder:function(b){null!=arcgisonline.map.save_open.webMapInfo?arcgisonline.map.save_open.webMapInfo.ownerFolder?(arcgisonline.map.save_open.folderTitle="",arcgisonline.map.save_open.folderId=arcgisonline.map.save_open.webMapInfo.ownerFolder,b()):arcgisonline.sharing.util.getJson(esriGeowConfig.restBaseUrl+"content/items/"+arcgisonline.map.save_open.webMapInfo.id,e.hitch(this,function(c,l){e.mixin(arcgisonline.map.save_open.webMapInfo,{owner:c.owner,ownerFolder:c.ownerFolder,item:c.item,
url:c.url,name:c.name,title:c.title,description:c.description,tags:c.tags,snippet:c.snippet,thumbnail:c.thumbnail,typeKeywords:c.typeKeywords,accessInformation:c.accessInformation,licenseInfo:c.licenseInfo});arcgisonline.map.save_open.folderTitle="";arcgisonline.map.save_open.folderId=arcgisonline.map.save_open.webMapInfo.ownerFolder;b()}),e.hitch(this,function(b,e){console.log(b)})):(arcgisonline.map.save_open.folderTitle="/",arcgisonline.map.save_open.folderId=null,b())},canSaveWithBing:function(){if(arcgisonline.map.main.mapLayers[0].layer instanceof
esri.virtualearth.VETiledLayer){var b=arcgisonline.sharing.util.getUser();if(!b.accountId||b.accountId&&!esriGeowConfig.self.bingKey)return arcgisonline.sharing.dijit.dialog.GeneralDlg.prototype.statics.getInstance().show({title:esri.i18nBundle.common.notice,message:esri.i18nBundle.viewer.save_open.useOfBing}),!1}return!0}}});