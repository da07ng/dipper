// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("dojo/_base/event dojo/_base/lang dojo/_base/array dojo/_base/kernel dojo/on dojo/dom-attr dojo/dom-construct dojo/dom-style dojo/dom-class dojo/dom-geometry ../core/declare ../core/Collection ../core/lang ../geometry/SpatialReference ../geometry/support/webMercatorUtils ../geometry/Extent ./Widget".split(" "),function(t,h,k,u,v,q,r,l,m,s,w,x,p,y,z,A,B){return w([B],{declaredClass:"esri.widgets.Attribution",baseClass:"esri-attribution",itemDelimiter:" | ",map:null,view:null,_setViewAttr:function(a){this.view=
a;this._setupView(a)},listNode:null,itemNodes:{},css:{},maxWidth:100,_setMaxWidthAttr:function(a){this.maxWidth=a;this._updateMaxWidth(a)},_eventConnections:[],_layerViewEventConnections:[],_attributions:{},_pendingDfds:{},_activeLayerIds:[],_sharedLayers:[],_lastItem:null,constructor:function(a,b){this.attributionLayerViews=new x;this.css={openClass:"esri-attribution-open",listClass:"esri-attribution-list",itemClass:"esri-attribution-item",lastItemClass:"esri-attribution-last-item",delimiterClass:"esri-attribution-delim"}},
buildRendering:function(){this.inherited(arguments);q.set(this.domNode,"innerHTML","\x3cspan class\x3d'"+this.css.listClass+"'\x3e\x3c/span\x3e");this.listNode=u.query(".esri-attribution-list",this.domNode)[0];this.itemNodes={}},postCreate:function(){this.inherited(arguments);var a=this.view;a&&this._setupView(a)},destroy:function(){this.inherited(arguments);this._clearEventConnections();r.destroy(this.listNode);this.map=this.domNode=this._eventConnections=this._layerViewEventConnections=this.listNode=
this._attributions=this._pendingDfds=this.itemNodes=this._activeLayerIds=this._lastItem=this._sharedLayers=null;this._mapWatcher&&(this._mapWatcher.remove(),this._mapWatcher=null)},_setupView:function(a){a&&(this.map=null,this.view=a,a.map?(this.map=a.map,this._init()):(this._mapWatcher&&this._mapWatcher.remove(),this._mapWatcher=a.watch("map",function(a){this.map=a;this._init()}.bind(this))))},_init:function(){var a=this.map,b=this.view;this._clearEventConnections();this._eventConnections=[b.watch("stationary",
h.hitch(this,this._onViewExtentChange)),b.layerViewsFlat.on("change",h.hitch(this,this._updateLayers)),v(this.listNode.parentNode,"click",h.hitch(this,this._toggleOpenStateHandler))];a.then(h.hitch(this,function(a){a=b.layerViewsFlat.map(function(a){return a}).filter(function(a){return a.layer.hasAttributionData});this.set("attributionLayerViews",a);this._parseLayerViews()}))},_createNode:function(a,b){if(this.domNode){var c,d=this.view;c=d.get("extent");var f=d.get("zoom")||1,e=this._attributions[a],
g=(d=this._checkShareInfo(a))&&d.sharedWith,g=g&&this.itemNodes[g];c=h.isString(e)?e:this._getContributorsList(e,c,f);g?(this.itemNodes[a]=g,this._toggleItem(g,!0,d.index)):(c=this.itemNodes[a]=r.create("span",{"class":this.css.itemClass,innerHTML:c?c+this._getDelimiter():"",style:{display:"inline"}},this.listNode),this._setLastItem(c));this._adjustCursorStyle()}},_checkShareInfo:function(a){var b=this._attributions,c,d,f=-1,e=b[a],g;if(e&&h.isString(e)){for(d in b)if(c=b[d],d!==a&&c&&h.isString(c)&&
c.length===e.length&&c.toLowerCase()===e.toLowerCase()){g=d;break}b=this._sharedLayers;c=b.length;if(g){for(d=0;d<c;d++)if(e=b[d],-1!==k.indexOf(e,g)){f=d;e.push(a);break}-1===f&&(f=b.push([g,a])-1)}}return-1<f?{index:f,sharedWith:g}:null},_getGroupIndex:function(a){var b=this._sharedLayers,c,d=b.length,f=-1;for(c=0;c<d;c++)if(-1!==k.indexOf(b[c],a)){f=c;break}return f},_createIndexByLevel:function(a,b){var c=a.contributors,d,f,e,g,C=c?c.length:0,h,k,m=y.WGS84,l={},n;for(g=0;g<C;g++){d=c[g];k=(f=
d.coverageAreas)?f.length:0;for(h=0;h<k;h++){e=f[h];n=e.bbox;n={extent:z.geographicToWebMercator(new A(n[1],n[0],n[3],n[2],m)),attribution:d.attribution||"",zoomMin:e.zoomMin-(b&&e.zoomMin?1:0),zoomMax:e.zoomMax-(b&&e.zoomMax?1:0),score:p.isDefined(e.score)?e.score:100,objectId:g};for(e=n.zoomMin;e<=n.zoomMax;e++)l[e]=l[e]||[],l[e].push(n)}}return l},_getContributorsList:function(a,b,c){var d="";c=Math.round(c);c=Math.min(a.maxKey,c);if(b&&p.isDefined(c)&&-1<c){a=a[c];c=b.get("center").normalize();
for(var f=a?a.length:0,e=[],g={},d=0;d<f;d++)b=a[d],!g[b.objectId]&&b.extent.contains(c)&&(g[b.objectId]=1,e.push(b));e.sort(function(a,c){return c.score-a.score||a.objectId-c.objectId});f=e.length;for(d=0;d<f;d++)e[d]=e[d].attribution;d=e.join(", ")}return d},_adjustCursorStyle:function(){var a=this.listNode.parentNode,b=s.position(a,!0).h;m.contains(a,this.css.openClass)?(m.remove(a,this.css.openClass),b>s.position(a,!0).h?(l.set(a,"cursor","pointer"),m.add(a,this.css.openClass)):l.set(a,"cursor",
"default")):(m.add(a,this.css.openClass),b<s.position(a,!0).h?l.set(a,"cursor","pointer"):l.set(a,"cursor","default"),m.remove(a,this.css.openClass))},_toggleOpenState:function(){var a=this.listNode.parentNode;m.contains(a,this.css.openClass)?m.remove(a,this.css.openClass):a.scrollWidth>a.clientWidth&&m.add(a,this.css.openClass)},_toggleItem:function(a,b,c){if(-1<c&&!b){c=this._sharedLayers[c];var d,f=c.length,e=this._activeLayerIds;for(d=0;d<f;d++)if(-1!==k.indexOf(e,c[d]))return}l.set(a,"display",
b?"inline":"none");this._updateLastItem()},_updateLastItem:function(){var a=this.listNode.childNodes,b;b=a.length;var c;if(b)for(b-=1;0<=b;b--)if(c=a[b],"none"!==l.get(c,"display")){this._setLastItem(c);break}this._adjustCursorStyle()},_setLastItem:function(a){var b=this.css.itemClass,c=this.css.lastItemClass;this._lastItem&&m.replace(this._lastItem,b,c);a&&(m.replace(a,c,b),this._lastItem=a)},_getDelimiter:function(){var a=this.itemDelimiter;return a?"\x3cspan class\x3d'"+this.css.delimiterClass+
"'\x3e"+a+"\x3c/span\x3e":""},_updateMaxWidth:function(a){l.set(this.listNode.parentNode,"max-width",Math.floor(a)+"px");this._adjustCursorStyle()},_updateAttribution:function(a){},_toggleOpenStateHandler:function(a){t.stop(a);this._toggleOpenState()},_setAttributionLayerViewsAttr:function(a){this._set("attributionLayerViews",a);a.on("change",h.hitch(this,this._updateAttribution))},_parseLayerViews:function(){k.forEach(this.attributionLayerViews.items,h.hitch(this,function(a){this._onLayerAdd(a)}))},
_clearEventConnections:function(){k.forEach(this._eventConnections,h.hitch(this,function(a){a.remove()}));k.forEach(this._layerViewEventConnections,h.hitch(this,function(a){a.remove()}));this._eventConnections=this._layerViewEventConnections=[]},_onAttributionLoad:function(a,b,c){var d=a._attributions,f=b.layer,e=a._pendingDfds,g=f.id,h=b.id;if(e&&e[g]){delete e[g];delete e[h];if(!c||c instanceof Error)c="";d[h]=c?a._createIndexByLevel(c,-1!==f.declaredClass.toLowerCase().indexOf("vetiledlayer")):
f.copyright||f.copyrightText||"";d[h]?(b.suspended||(a._activeLayerIds.push(h),c=Object.keys(d[h]).map(function(a){return Number(a)}),d[h].maxKey=Math.max.apply(Math,c)),a._createNode(h,b)):a._onLayerRemove(b)}},_updateLayers:function(a){var b=k.filter(a.added,function(a){return a.layer.hasAttributionData}),b=k.map(b,h.hitch(this,function(a){this._layerViewEventConnections.push(a.watch("suspended",h.hitch(this,this._onLayerToggle)));this._onLayerAdd(a);return a}));this.attributionLayerViews.addItems(b);
a=k.map(a.removed,h.hitch(this,function(a){this._onLayerRemove(a);return a}));this.attributionLayerViews.removeItems(a)},_onLayerAdd:function(a){var b=a.layer,c=a.id,d=b.id,f=this._attributions;try{if(!p.isDefined(f[d])&&!p.isDefined(f[c])&&b.showAttribution)if(b.hasAttributionData){var e=b.getAttributionData();this._pendingDfds[d]=1;f[c]=e;e.then(h.partial(this._onAttributionLoad,this,a))}else f[c]=b.copyright||b.copyrightText||"",f[c]?(a.suspended||this._activeLayerIds.push(c),this._createNode(c,
a)):this._onLayerRemove(a)}catch(g){}},_onLayerRemove:function(a){var b=a.id,c=this.itemNodes,d,f=-1;try{this._onLayerToggle(!0,!1,"suspended",a),delete this._attributions[b],delete this._pendingDfds[b],d=this._getGroupIndex(b),-1!==d&&(f=k.indexOf(this._sharedLayers[d],b),-1!==f&&(this._sharedLayers[d].splice(f,1),1>=this._sharedLayers[d].length&&this._sharedLayers.splice(d,1))),c[b]&&-1===f&&r.destroy(c[b]),delete c[b],this._updateLastItem()}catch(e){}},_onLayerToggle:function(a,b,c,d){b=d.id;d=
this._attributions[b];c=this.itemNodes[b];var f=this.view,e=f.get("extent"),f=f.get("zoom");a?this._attributions[b]&&(a=k.indexOf(this._activeLayerIds,b),c=this.itemNodes[b],-1!==a&&this._activeLayerIds.splice(a,1),c&&this._toggleItem(c,!1,this._getGroupIndex(b))):d&&(-1===k.indexOf(this._activeLayerIds,b)&&this._activeLayerIds.push(b),c&&(a=h.isString(d)?d:this._getContributorsList(d,e,f),h.isString(d)||q.set(c,"innerHTML",a?a+this._getDelimiter():""),a&&this._toggleItem(c,!0,this._getGroupIndex(b))))},
_onViewExtentChange:function(a,b,c,d){if(a){a=this._activeLayerIds;b=this._attributions;c=this.itemNodes;var f=a.length||0,e,g,k;for(e=0;e<f;e++)if(g=a[e],k=b[g],(g=c[g])&&!h.isString(k))k=this._getContributorsList(k,d.get("extent"),d.get("zoom")),q.set(g,"innerHTML",k?k+this._getDelimiter():""),this._toggleItem(g,!!k,-1)}this._adjustCursorStyle()}})});