// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define(["dojo/_base/lang","./I3SUtil","../../support/PromiseLightweight"],function(m,k,l){var n=function(f,b,e){for(var a="",c=0,g=0,d=0,h=0;c<e;)if(g=f[b+c],128>g)a+=String.fromCharCode(g),c++;else if(191<g&&224>g){if(c+1>=e)throw Error("UTF-8 Decode failed. Two byte character was truncated.");d=f[b+c+1];a+=String.fromCharCode((g&31)<<6|d&63);c+=2}else{if(c+2>=e)throw Error("UTF-8 Decode failed. Multi byte character was truncated.");d=f[b+c+1];h=f[b+c+2];a+=String.fromCharCode((g&15)<<12|(d&63)<<
6|h&63);c+=3}return a},h={readBinaryHeader:function(f,b){for(var e={byteOffset:0,byteCount:0,fields:Object.create(null)},a=0,c=0;c<b.length;c++){var g=b[c],d=new k.valueType2TypedArrayClassMap[g.valueType||g.type](f,a,1);e.fields[g.property]=d[0];a+=d.byteLength}e.byteCount=a;return e},readStringArray:function(f,b,e){var a=[],c,g=0,d;for(d=0;d<f;d+=1){c=b[d];if(0<c){if(a.push(n(e,g,c-1)),0!==e[g+c-1])throw Error("invalid string array: missing null termination.");}else a.push(null);g+=c}return a},
createTypedView:function(f,b){return new k.valueType2TypedArrayClassMap[b.valueType](f,b.byteOffset,b.count)},createRawView:function(f,b){return new Uint8Array(f,b.byteOffset,b.byteCount)},createAttributeDataIndex:function(f,b,e){f={byteOffset:b.byteCount,byteCount:0,entries:Object.create(null)};for(var a=b.byteCount,c=0;c<e.ordering.length;c++){var g=e.ordering[c],d=m.clone(e[g]);d.count=b.fields.count;if("String"===d.valueType){if(d.byteOffset=a,d.byteCount=b.fields[g+"ByteCount"],"UTF-8"!==d.encoding)throw Error("Unsupported String encoding: '"+
d.encoding+"'.");}else if(k.isValueType(d.valueType)){var h=k.getBytesPerValue(d.valueType),a=a+(0!==a%h?h-a%h:0);d.byteOffset=a;d.byteCount=h*d.valuesPerElement*d.count}else throw Error("Unsupported valueType: '"+d.valueType+"'.");a+=d.byteCount;f.entries[g]=d}f.byteCount=a-f.byteOffset;return f},readBinary:function(f,b){var e=h.readBinaryHeader(b,f.header);f["attributeByteCounts "]&&!f.attributeByteCounts&&(console.error("Warning: Trailing space in 'attributeByteCounts '."),f.attributeByteCounts=
f["attributeByteCounts "]);var a=this.createAttributeDataIndex(b,e,f),e=a.byteOffset+a.byteCount;if(e>b.byteLength)throw Error("invalid attribute array length\n(expected: "+e+" bytes, got: "+b.byteLength+" bytes).");e<b.byteLength&&console.error("Warning: attribute array too long\n(expected: "+e+" bytes, got: "+b.byteLength+" bytes).");if(e=a.entries.attributeValues){if("String"===e.valueType){var a=a.entries.attributeByteCounts,c=h.createTypedView(b,a),e=h.createRawView(b,e);return h.readStringArray(a.count,
c,e)}return h.createTypedView(b,e)}throw Error("Bad attributeStorageInfo specification.");},loadAll:function(f,b,e,a){for(var c=a.length,g=[],d=0;d<c;d++)g.push(h.load(f,b,e[d],a[d]));return l.join(g)},load:function(f,b,e,a){var c=new l.Promise;b=k.concatUrl(b,a.href)+"/";a.hrefConcat=b;f.request(b,"binary").then(function(a,b){c.done(h.readBinary(e,b))},function(a){c.reject(a)});return c}};return h});