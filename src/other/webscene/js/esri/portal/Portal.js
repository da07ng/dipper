// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../core/Evented ../identity/IdentityManager ./PortalGroup ./PortalItem ./PortalListing ./PortalProvision ./PortalUser ./support/portalResult ./support/PortalUtil dojo/_base/array ../core/declare dojo/_base/Deferred dojo/_base/kernel dojo/_base/lang".split(" "),function(l,m,n,p,q,e,k,r,d,f,s,h,t,b){return s([l],{declaredClass:"esri.arcgis.Portal",esriPortal:null,portalUtil:null,emitError:function(a){this.emit("error",{error:a})},constructor:function(a){a=b.isObject(a)?a:{url:a};this.esriPortal=
{options:{disableIdentityLookup:!0},requestParams:{f:"json"}};this.portalUtil=new d(this);a.self?(this.esriPortal.self=a.self,b.mixin(this,{url:a.url||window.location.protocol+"//"+(a.self.urlKey?a.self.urlKey+"."+a.self.customBaseUrl:a.self.portalHostname)}),this.portalUrl=-1!==this.url.indexOf("/sharing")?this.url+"/":this.url+"/sharing/rest/",a=a.self.user?this.signIn():this.init(this.url)):(a.url&&b.mixin(this,{url:a.url}),a=this.init(this.url));a.then(b.hitch(this,function(){this.emit("ready");
this.emit("load")}))},init:function(a,c){a=(a||this.portalUrl).replace(/\/+$/,"");this.portalUrl=-1!==a.indexOf("/sharing")?a+"/":a+"/sharing/rest/";return this._getSelf(this.portalUrl).then(b.hitch(this,function(a){this.esriPortal.self=b.mixin({},a);if((a=a.user)&&c)this.esriPortal.currentToken=c&&c.token,this.esriPortal.loggedInUser=new k(b.mixin(a,{portal:this,credential:c}));this.esriPortal.self.id&&!1===this.esriPortal.self.canSearchPublic&&(this.esriPortal.extraQuery=" AND orgid:"+this.esriPortal.self.id);
b.mixin(this,this.esriPortal.self);this.thumbnailUrl=this.portalUtil.formatUrl(this.portalUrl+"accounts/self/resources/"+this.thumbnail);this.isOrganization=this.access&&this.access.length||!1;this.created=this.created?new Date(this.created):null;this.modified=this.modified?new Date(this.modified):null;return this}),b.hitch(this,function(a){this.emitError(a);throw a;}))},signIn:function(){var a=new h,c=b.hitch(this,function(){this._onSignIn().then(b.hitch(this,function(){a.resolve(this.esriPortal.loggedInUser)}),
b.hitch(this,function(b){a.reject(b)}))});if(!this.esriPortal||!this.esriPortal.self)this.on("load",b.hitch(this,function(){c()}));else this.esriPortal&&this.esriPortal.loggedInUser?a.resolve(this.esriPortal.loggedInUser):c();return a.promise},signOut:function(){this.esriPortal.loggedInUser.credential&&this.esriPortal.loggedInUser.credential.destroy();this.esriPortal.loggedInUser=null;this.esriPortal.options.disableIdentityLookup=!0;d.clearFieldsFromObject(this.esriPortal.self,this);this.esriPortal.self=
null;return this.init(this.url)},getPortalUser:function(){return this.esriPortal.loggedInUser},addResource:function(a,b){return this.portalUtil.request(this.portalUrl+"portals/self/addResource",{key:a,text:b},{usePost:!0})},update:function(a){return this.portalUtil.request(this.portalUrl+"portals/self/update",a,{usePost:!0})},queryGroups:function(a,b){return this._queryPortal(this.portalUrl+"community/groups",this.portalUtil.formatQueryParams({},a,b),n)},queryItems:function(a,b){return this._queryPortal(this.portalUrl+
"search",this.portalUtil.formatQueryParams({},a,b),p)},queryListings:function(a){a=this.portalUtil.formatQueryParams({},a,!0);var b="";a.q&&-1<a.q.toLowerCase().indexOf("mylistings:true")?(a.q=a.q.toLowerCase().replace("mylistings:true",""),b="?mylistings\x3dtrue"):a.q||(a.q='""');return this._queryPortal(this.portalUrl+"content/listings"+b,a,q)},getProvisions:function(){return this.getCustomers().then(b.hitch(this,function(a){return a.purchases}))},getInterests:function(){return this.getCustomers().then(b.hitch(this,
function(a){return a.interests}))},getTrials:function(){return this.getCustomers().then(b.hitch(this,function(a){return a.trials}))},getCustomers:function(a){return this.portalUtil.request(this.portalUrl+"portals/self/customers",{status:a||"all"})},queryCustomerList:function(a){a=d.formatQueryParams({},a,!0);return this._queryPortal(this.portalUrl+"portals/self/customersList",a)},getMyPurchases:function(){return this.getPurchases().then(function(a){return a.purchases})},getMyInterests:function(){return this.getPurchases().then(function(a){return a.interests})},
getPurchases:function(){return this.portalUtil.request(this.portalUrl+"portals/self/purchases").then(b.hitch(this,function(a){a.interests=f.map(a.interests,function(a){return b.mixin(a.provision,{listing:a.listing})});a.purchases=f.map(a.purchases,function(a){return b.mixin(a.provision,{listing:a.listing})});a.trials=f.map(a.trials,function(a){return b.mixin(a.provision,{listing:a.listing})});a.interests=d.resultsToTypedArray(e,{portal:this},a.interests);a.trials=d.resultsToTypedArray(e,{portal:this},
a.trials);a.purchases=d.resultsToTypedArray(e,{portal:this},a.purchases);return a}))},queryUsers:function(a,b){return this._queryPortal(this.portalUrl+"community/users",this.portalUtil.formatQueryParams({sortField:"username"},a,b),k)},_onSignIn:function(){this.esriPortal.options.disableIdentityLookup=!1;if(!this.esriPortal.self||!this.esriPortal.self.user)this.esriPortal.self=null;return m.getCredential(this.portalUrl).then(b.hitch(this,"init",this.url)).then(b.hitch(this,function(){return this.esriPortal.loggedInUser}),
b.hitch(this,function(a){this.esriPortal.options.disableIdentityLookup=!0;this.emitError(a);throw a;}))},_getSelf:function(a){a=a+"accounts/self?culture\x3d"+t.locale;return this.esriPortal.self?(a=new h,a.resolve(this.esriPortal.self),a.promise):this.portalUtil.request(a)},_queryPortal:function(a,c,e){var g=b.mixin({num:10,start:0,sortField:"title",sortOrder:"asc"},c),f=["start","query","num","nextStart"];a=this.portalUtil.request(a,g).then(b.hitch(this,function(a){a.results=d.resultsToTypedArray(e,
{portal:this},a);a.queryParams=b.mixin({},g);a.nextQueryParams=b.mixin(g,{start:a.nextStart});return d.clearFieldsFromObject(f,a)}));a=b.delegate(a);a.queryParams=b.mixin({},g);a.nextQueryParams=h.when(a,function(a){return a.nextQueryParams});return r(a)}})});