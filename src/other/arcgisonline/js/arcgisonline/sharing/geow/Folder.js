// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/geow/Folder",["dijit","dojo","dojox","dojo/require!arcgisonline/sharing/util"],function(l,e,m){e.provide("arcgisonline.sharing.geow.Folder");e.require("arcgisonline.sharing.util");arcgisonline.sharing.geow.Folder={util:arcgisonline.sharing.util,createFolder:function(b,d,c){var a=this.util.getUser();return a&&a.email?this.createFolderByUser(a.email,b,d,c):null},createFolderByUser:function(b,d,c,a){var f=this.util.getUser(),g=esriGeowConfig.restBaseUrl+"content/users/"+
b+"/createFolder";f&&this.util.request({url:g,content:d},{usePost:!0}).then(e.hitch(this,function(a){this._userFolders&&this._userFolders[b]&&(this._userFolders[b]=null);c(a)}),e.hitch(this,function(b){a(b)}))},deleteFolder:function(b,d,c){var a=this.util.getUser();return a&&a.email?this.deleteFolderByUser(a.email,b,d,c):null},deleteFolderByUser:function(b,d,c,a){d=esriGeowConfig.restBaseUrl+"content/users/"+b+"/"+d+"/delete";this.util.getUser()&&this.util.request({url:d},{usePost:!0}).then(e.hitch(this,
function(a){this._userFolders&&this._userFolders[b]&&(this._userFolders[b]=null);c(a)}),e.hitch(this,function(b){a(b)}))},getFolders:function(b,d,c){var a=this.util.getUser();return a&&a.email?this.getFoldersByUser(a.email,b,d,c):null},getFoldersByUser:function(b,d,c,a){if(this.util.getUser())if(this._isRequestingFolders)setTimeout(e.hitch(this,"getFoldersByUser",b,d,c,a),75);else{"function"!==typeof c&&(a=c,c=null);this._userFolders||(this._userFolders={});var f=esriGeowConfig.restBaseUrl+"content/users/"+
b;a={num:!a?1:100};f=this._userFolders[b]&&this._userFolders[b].folders&&e.clone(this._userFolders[b].folders)||this._fetchAllItems(f,a).then(e.hitch(this,function(a){this._userFolders[b]={folders:a};this._isRequestingFolders=!1;return e.clone(a)}),e.hitch(this,function(a){throw a;}));this._isRequestingFolders=!this._userFolders[b]||!this._userFolders[b].folders;e.when(f,d,c)}},_fetchAllItems:function(b,d){var c={};return this._fetchItems(b,d,c).then(e.hitch(this,function(a){if(1<d.num&&a.total>d.num){var f=
Math.ceil(a.total/d.num),g=a.nextStart,h=[];a&&1===a.start?c=a:c.items=c.items.concat(a.items);for(var k=0;k<f-1;k++)h.push(this._fetchItems(b,e.mixin(d,{start:g}),c)),g+=a.num;return e.promise.all(h).then(e.hitch(this,function(a){e.forEach(a,function(a){c.items=c.items.concat(a.items)});return c}))}return a}),e.hitch(this,function(a){throw a;}))},_fetchItems:function(b,d){return this.util.request({url:b,content:d}).then(e.hitch(this,function(b){return b}),e.hitch(this,function(b){throw b;}))},foldersToStore:function(b){return new e.data.ItemFileReadStore({data:{label:"title",
items:[{name:"Anonymous User",children:b}]}})},updateMoveToMenu:function(b,d,c,a,f){e.publish("updateItemToolbar",[{folders:b,folderId:d,folderName:c,onClickHandler:a,customMenuItem:f}])},updateMoveToMenuByUser:function(b,d,c,a,f){e.publish("updateItemToolbar",[{username:b,folders:d,folderId:c,folderName:a,onClickHandler:f}])}}});