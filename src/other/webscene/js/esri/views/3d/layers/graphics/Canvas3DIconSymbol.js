// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../../../../core/declare dojo/_base/lang dojo/when ./Canvas3DSymbolBase ./Canvas3DGraphic ./Canvas3DDrapedGraphic ./ElevationAligners ./Canvas3DSymbolCommonCode ../../../../core/urlUtils ../../../../core/screenUtils ../../../../config ../../../../Color ../../../../geometry/Polygon ../../support/projectionUtils ../../support/mathUtils ../../lib/glMatrix ../../webgl-engine/Stage ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Texture ../../webgl-engine/materials/HUDMaterial".split(" "),
function(q,H,w,I,J,K,x,n,y,L,M,N,O,P,Q,z,r,R,A,S,T,B){function t(a){return"cross"===a||"x"===a}function U(a){var b,f=u,d=f*C;"primitive:"===a.substring(0,10)&&(a=a.substring(10));switch(a){case p.PRIM_CIRCLE:b=new Uint8Array(4*f*f);for(var g=f/2-0.5,d=d/2,c=0;c<f;c++)for(var e=0;e<f;e++){var h=e+f*c,k=e-g,m=c-g,k=Math.sqrt(k*k+m*m)-d,k=k/f+0.5;v(k,b,4*h)}break;case p.PRIM_SQUARE:b=D(f,d,!1);break;case p.PRIM_KITE:b=D(f,d,!0);break;case p.PRIM_CROSS:b=E(f,d,!1);break;case p.PRIM_X:b=E(f,d,!0)}return new T(b,
"sdf_"+a,{mipmap:!1,wrapClamp:!0,width:u,height:u,components:4})}function v(a,b,f){a=Q.clamp(a,0,0.9999991);var d=a*l[0]-Math.floor(a*l[0]),g=a*l[1]-Math.floor(a*l[1]),c=a*l[2]-Math.floor(a*l[2]);a=a*l[3]-Math.floor(a*l[3]);b[f+0]=256*(d-d*s[0]);b[f+1]=256*(g-d*s[1]);b[f+2]=256*(c-g*s[2]);b[f+3]=256*(a-c*s[3])}function D(a,b,f){f&&(b/=Math.SQRT2);for(var d=new Uint8Array(4*a*a),g=0;g<a;g++)for(var c=0;c<a;c++){var e=c-0.5*(a-0.5),h=g-0.5*(a-0.5),k=g*a+c;if(f)var m=(e+h)/Math.SQRT2,h=(h-e)/Math.SQRT2,
e=m;e=Math.max(Math.abs(e),Math.abs(h))-0.5*b;e=e/a+0.5;v(e,d,4*k)}return d}function E(a,b,f){f&&(b*=Math.SQRT2);b*=0.5;for(var d=new Uint8Array(4*a*a),g=0;g<a;g++)for(var c=0;c<a;c++){var e=c-0.5*a-0.5,h=g-0.5*a-0.5,k=g*a+c;if(f)var m=(e+h)/Math.SQRT2,h=(h-e)/Math.SQRT2,e=m;e=Math.abs(e);h=Math.abs(h);e=e>h?e>b?Math.sqrt((e-b)*(e-b)+h*h):h:h>b?Math.sqrt(e*e+(h-b)*(h-b)):e;e=e/a+0.5;v(e,d,4*k)}return d}var V=z.vec3d,W=z.mat4d.identity(),F=[0,0,1],X=[0,0,0,0],G="center bottom top left right bottomLeft bottomRight topLeft topRight".split(" "),
u=128,C=0.5,p={PRIM_CIRCLE:"circle",PRIM_SQUARE:"square",PRIM_CROSS:"cross",PRIM_X:"x",PRIM_KITE:"kite"};q=q([I],{_prepareResources:function(){var a=this.symbol,b=null!=a.size?a.size:16;this._size=null;this._symbolTextureRatio=1;this._primitive=null;var f=this._getStageIdHint();this._isPropertyDriven("size")&&64>b&&(b=64);var d=a.resource||{primitive:"circle"},g={anchorPos:this._getAnchorPos(a)},c=d.href||d.dataURI;c?(g.color=this._getFillColor(a,null),g.outlineColor=this._getOutlineColor(a),g.outlineSize=
this._getOutlineSize(a,null),g.textureIsSignedDistanceField=!1,this._prepareImageResources(c,b,g,f)):(d=d.primitive||"circle",c="primitive:"+d,this._primitive=d,g.color=this._getFillColor(a,d),g.outlineColor=this._getOutlineColor(a),g.outlineSize=this._getOutlineSize(a,d),t(d)&&0===g.outlineSize?this.reject():(this.texture=this._context.sharedResources.textures.acquire(c,U),this._textureURI=c,g.textureIsSignedDistanceField=!0,g.textureId=this.texture.getId(),this._createMaterialsAndAddToStage(g,this._context.stage,
f),this._size=[b,b],this._symbolTextureRatio=1/C,this.resolve()))},_getOutlineDefaultSize:function(a){return t(a)?1.5:0},_getOutlineSize:function(a,b){return a.outline?null!=a.outline.size?a.outline.size:this._getOutlineDefaultSize(b):this._getOutlineDefaultSize(b)},_getOutlineColor:function(a){var b=this._getLayerOpacity();if(a.outline&&null!=a.outline.color){var f=N.toUnitRGB(a.outline.color);return[f[0],f[1],f[2],a.outline.color.a*b]}return[0,0,0,b]},_getFillColor:function(a,b){return t(b)?X:this._getMaterialOpacityAndColor()},
_getAnchorPos:function(a){return-1<G.indexOf(a.anchor)?a.anchor:"center"},_prepareImageResources:function(a,b,f,d){0===a.indexOf("http")&&"https:"===location.protocol&&(a=a.replace(/^http:/i,"https:"));var g=function(a){var c=a.params,e=c.width/c.height;this._size=b?1<e?[b,b/e]:[b*e,b]:[c.width,c.height];f.textureId=a.getId();this._createMaterialsAndAddToStage(f,this._context.stage,d);this.resolve()}.bind(this),c="data:image/svg"===a.substring(0,14),e=".svg"===a.substring(a.length-4,a.length);if(!c&&
!e)w(this._context.sharedResources.textures.acquire(a),g,function(){this.reject()}.bind(this)),this._textureURI=a;else{var h=new Image;c?h.src=a:y.canUseXhr(a)?(c=a,0===c.indexOf("//")&&(c=window.location.protocol+c),y.hasSameOrigin(c,window.location.href)||(h.crossOrigin="anonymous"),h.src=a):h.src=M.request.proxyUrl+"?"+a;h.onerror=function(){this.reject()}.bind(this);h.onload=function(){var a=h.width,c=h.height,d=1;a&&c&&(d=a/c);null!=b&&(1<d?(a=b,c=b/d):(c=b,a=b*d));d=document.createElement("canvas");
d.width=a;d.height=c;d.getContext("2d").drawImage(h,0,0,a,c);a=d.toDataURL();w(this._context.sharedResources.textures.acquire(a),g,function(){this.reject()});this.textureURI=a}.bind(this);h.onerror=function(){console.warn("Failed to create Icon primitive");this.reject()}.bind(this)}},_createMaterialsAndAddToStage:function(a,b,f){a.occlusionTest=!1;this._drapedMaterial=new B(a,f+"_iconDraped");b.add(r.ModelContentType.MATERIAL,this._drapedMaterial);a=H.clone(a);a.occlusionTest=!0;this._material=new B(a,
f+"_icon");b.add(r.ModelContentType.MATERIAL,this._material)},destroy:function(){this._material&&this._context.stage.remove(r.ModelContentType.MATERIAL,this._material.getId());this._drapedMaterial&&this._context.stage.remove(r.ModelContentType.MATERIAL,this._drapedMaterial.getId());this._textureURI&&this._context.sharedResources.textures.release(this._textureURI)},createCanvas3DGraphic:function(a,b,f){var d=a.geometry;"extent"===d.type&&(d=O.fromExtent(d));if("polyline"===d.type)d=n.placePointOnPolyline(d);
else if("polygon"===d.type)d=n.placePointOnPolygon(d);else if("point"!==d.type)return this._logWarning("unsupported geometry type for icon symbol: "+d.type),null;var g="graphic"+a.id,c=1;if(this._isPropertyDriven("size")&&b.size){for(var e=0;3>e;e++)b.size[e]&&(b.size[e]=L.pt2px(b.size[e]));e=this._size[0]>this._size[1]?this._size[0]:this._size[1];isFinite(b.size[0])?c=b.size[0]/e:"symbolValue"===b.size[0]?c=1:isFinite(b.size[2])&&(c=b.size[2]/e)}b=this._getVertexOpacityAndColor(b);c*=this._symbolTextureRatio;
c=[this._size[0]*c,this._size[1]*c];e=this._getGraphicElevationInfo(a);return e.mode===n.ELEV_MODES.ON_THE_GROUND?this._createAsOverlay(a,d,b,c,e,g,a.id,f):this._createAs3DShape(a,d,b,c,e,g,a.id,f)},layerPropertyChanged:function(a,b,f){if("opacity"===a)return b=this._getFillColor(this.symbol,this._primitive),this._drapedMaterial.setParameterValues({color:b}),this._material.setParameterValues({color:b}),b=this._getOutlineColor(this.symbol),this._drapedMaterial.setParameterValues({outlineColor:b}),
this._material.setParameterValues({outlineColor:b}),!0;if("elevationInfo"===a){var d=this._elevationInfo.mode;this._updateElevationInfo();a=this._elevationInfo.mode;var g=n.ELEV_MODES;if(d===g.ON_THE_GROUND&&a===g.ON_THE_GROUND)return!0;if(d!==a&&(d===g.ON_THE_GROUND||a===g.ON_THE_GROUND))return!1;var d=this._context.elevationProvider,c=this._context.renderCoordsHelper,e=this._context.mapCoordsHelper,h=x.perObjectElevationAligner,k;for(k in b){var m=b[k],l=m._graphics[f];l&&(m=this._getGraphicElevationInfo(m.graphic),
l.elevationAligner=a===g.RELATIVE_TO_GROUND?h:null,l.elevationInfo.set(m),h(l,d,c,e))}return!0}return!1},setDrawOrder:function(a,b){this._drapedMaterial&&(this._drapedMaterial.setRenderPriority(a),b[this._drapedMaterial.getId()]=!0)},_defaultElevationInfoNoZ:{mode:n.ELEV_MODES.RELATIVE_TO_GROUND,offset:0},_getGraphicElevationInfo:function(a){var b=this.inherited(arguments);b.mode===n.ELEV_MODES.RELATIVE_TO_GROUND&&(0===b.offset&&!a.geometry.get("hasZ"))&&(b.offset=1/this._context.mapCoordsHelper.mapUnitInMeters);
return b},_createAs3DShape:function(a,b,f,d,g,c,e){a=A.createPointGeometry(F,null,f,d);a=[new R(a,c)];f=this._context.layer.get("id");c=n.createStageObjectForPoint.call(this,b,a,[[this._material]],null,null,g,c,f,e);if(null===c)return null;e=null;g.mode===n.ELEV_MODES.RELATIVE_TO_GROUND&&(e=x.perObjectElevationAligner);g=new J(this,c,a,null,null,e,g);g.getScreenSize=function(a,b){return function(){return[a,b]}}(d[0]/this._symbolTextureRatio,d[1]/this._symbolTextureRatio);n.extendPointGraphicElevationInfo(g,
b,this._context.elevationProvider);return g},_createAsOverlay:function(a,b,f,d,g,c,e){this._drapedMaterial.setRenderPriority(this._symbolLayerOrder);a=V.create();P.pointToVector(b,a,this._context.overlaySR);a[2]=this._getDrapedZ();if((b=this._context.clippingExtent)&&!n.pointInBox2D(a,b))return null;f=A.createPointGeometry(F,a,f,d,!0);b=new S(f);b.material=this._drapedMaterial;b.center=a;b.bsRadius=0;b.transformation=W;b.name=c;b.uniqueName=c+"#"+f.id;c=new K(this,[b],null,null);c.getScreenSize=function(a,
b){return function(){return[a,b]}}(d[0]/this._symbolTextureRatio,d[1]/this._symbolTextureRatio);return c}});q.VALID_ANCHOR_STRINGS=G;var l=[16777216,65536,256,1],s=[0,1/256,1/256,1/256];return q});