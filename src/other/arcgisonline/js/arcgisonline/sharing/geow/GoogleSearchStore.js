// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/geow/GoogleSearchStore",["dijit","dojo","dojox","dojo/require!dojox/data/GoogleSearchStore"],function(B,d,A){d.provide("arcgisonline.sharing.geow.GoogleSearchStore");d.require("dojox.data.GoogleSearchStore");d.declare("arcgisonline.sharing.geow.GoogleSearchStore",A.data.GoogleSearchStore,{_totalCount:0,fetch:function(a){function w(h){x++;r.content.context=r.content.start=h.start;h=d.io.script.get(r);s.push(h.ioArgs.id);h.addErrback(function(d){a.onError&&a.onError.call(k,
d,a)})}a=a||{};var k=a.scope||d.global;if(!a.query&&a.onError)a.onError.call(k,Error(this.declaredClass+": A query must be specified."));else{var n={},g;for(g in this._queryAttrs)n[g]=a.query[g];a={query:n,onComplete:a.onComplete,onError:a.onError,onItem:a.onItem,onBegin:a.onBegin,start:a.start,count:a.count};var q="GoogleSearchStoreCallback_"+this._id+"_"+ ++this._requestCount,n=this._createContent(n,q,a);if("undefined"===typeof a.start||null===a.start)a.start=0;a.count||(a.count=8);g={start:a.start-
a.start%8};var t=this,u=this._googleUrl+this._type;"https:"===location.protocol&&(u=u.replace("http:","https:"));var r={url:u,preventCache:this.urlPreventCache,content:n},l=[],v=0,y=!1,p=a.start-1,x=0,s=[],z=function(h,f){0<s.length&&d.query("#"+s.splice(0,1)).forEach(d.destroy);if(!y){var e=t._getItems(f),b=f?f.cursor:null;b&&null!=b.estimatedResultCount?d.publish("gridCount",[b.estimatedResultCount,"Google"]):d.publish("gridCount",[0,"Google"]);if(e){for(var c=0;c<e.length&&c+h<a.count+a.start;c++)t._processItem(e[c],
f),l[c+h]=e[c];v++;if(1==v){var g=(c=b?b.pages:null)?Number(c[c.length-1].start):0;a.onBegin&&(e=(b=b?b.estimatedResultCount:e.length)?Math.min(b,g+e.length):g+e.length,a.onBegin.call(k,e,a));e=a.start-a.start%8+8;for(b=1;c&&c[b]&&!(Number(c[b].start)>=a.start+a.count);)Number(c[b].start)>=e&&w({start:c[b].start}),b++}if(a.onItem&&l[p+1]){do p++,a.onItem.call(k,l[p],a);while(l[p+1]&&p<a.start+a.count)}v==x&&(y=!0,d.global[q]=null,a.onItem?a.onComplete.call(k,null,a):(l=l.slice(a.start,a.start+a.count),
a.onComplete.call(k,l,a)))}}},f=[],m=g.start-1;d.global[q]=function(h,g,e,b){try{if(200!=e)a.onError&&a.onError.call(k,Error("Response from Google was: "+e),a),d.global[q]=function(){};else if(h==m+1){if(z(Number(h),g),m+=8,0<f.length)for(f.sort(t._getSort());0<f.length&&f[0].start==m+1;)z(Number(f[0].start),f[0].data),f.splice(0,1),m+=8}else f.push({start:h,data:g})}catch(c){a.onError.call(k,c,a)}};w(g)}}})});