// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("../support/mathUtils ../../../layers/support/LercCodec ./TileUtils ./TerrainConst ./TileGeometryFactory ./UpsampleInfo ../lib/glMatrix ../webgl-engine/lib/Util ../../../core/arrayUtils".split(" "),function(w,B,v,g,C,D,e,E,x){function y(a){this.waitingAgents=[];this.init(a)}var f=e.vec3d,s=e.vec2d,r=e.vec4d,z=E.assert,u=f.create(),k=r.create(),F=f.create(),n={},t=g.LayerClass.LAYER_CLASS_COUNT,G=g.LayerClass.MAP,m=g.LayerClass.ELEVATION,p=g.TileUpdateTypes;e=function(a,b,c){this.lij=[0,0,0];
this.extent=r.create();this.extentWGS84Rad=r.create();this.centerAtSeaLevel=f.create();this.center=f.create();this.tileUp=F;this.elevationBounds=s.create();this.children=[null,null,null,null];this.centerProjected=r.create();this.layerInfo=Array(t);this.intersectsClippingArea=this.isWithinClippingArea=!0;this.clippingArea=null};e.prototype.init=function(a,b,c){this.lij[0]=a[0];this.lij[1]=a[1];this.lij[2]=a[2];r.set4(0,0,0,0,this.extent);r.set4(0,0,0,0,this.extentWGS84Rad);this.intersectsClippingArea=
this.isWithinClippingArea=!0;this.clippingArea=null;this.radius=this.edgeLen=0;this.vlevel=a?a[0]:0;b&&b.elevationBounds?s.set(b.elevationBounds,this.elevationBounds):s.set2(0,0,this.elevationBounds);this.parent=b;for(a=0;4>a;a++)this.children[a]=null;this.pendingUpdates=0;this.renderData=null;this.renderOrder=this.screenDepth=0;this.visible=!1;this.parentSurface=c;for(a=0;a<t;a++)if(c){var d=c.numLayers(a),q;this.layerInfo[a]?(q=this.layerInfo[a],q.length=d):(q=Array(d),this.layerInfo[a]=q);for(var e=
0;e<d;e++)q[e]=A(a,q[e]),b&&a==m&&(q[e].elevationBounds=b.layerInfo[a][e].elevationBounds)}else this.layerInfo[a]=null};e.prototype.dispose=function(){for(var a=0;a<t;a++)for(var b=this.layerInfo[a],c=0;c<b.length;c++){var d=b[c];d.upsampleFromTile&&(D.Pool.release(d.upsampleFromTile),d.upsampleFromTile=null)}};e.prototype.shouldSplit=function(a,b){var c=this.lij[0];if(1>c)return p.SPLIT;f.subtract(this.center,b,u);var d=f.length(u),d=this.edgeLen/(2*a[0]*d);return d<a[1]?this.vlevel!==this.lij[0]?
(this.vlevel=this.lij[0],p.VSPLITMERGE):p.NONE:c>=a[4]?(c+=Math.ceil(-Math.log2(a[1]/d)),c!==this.vlevel?(this.vlevel=c,p.VSPLITMERGE):p.NONE):10<c&&(f.scale(this.tileUp,f.dot(this.tileUp,u),k),f.subtract(k,u),f.length2(k)>this.radius*this.radius&&(f.scale(k,this.radius/f.length(k)),f.add(k,this.centerAtSeaLevel),f.subtract(b,k,k),Math.abs(f.dot(k,this.tileUp)/f.length(k))*d<0.15*a[1]))?p.NONE:p.SPLIT};e.prototype.createElevationDataFromLERC=function(a){var b;try{var c=B.decode(a,{noDataValue:g.ELEVATION_NODATA_VALUE}),
d=c.width;b={bounds:[c.minValue,-3E38<c.maxValue?c.maxValue:0],samplerData:{dx:(d-1)/(this.extent[2]-this.extent[0]),dy:(d-1)/(this.extent[3]-this.extent[1]),x0:this.extent[0],y1:this.extent[3],width:d,pixels:c.pixelData,safeWidth:0.99999999*(d-1)}}}catch(e){console.warn("Error decoding %s: %s",a.url,e.message)}return b};e.prototype.getWGS84Extent=function(){return this.extentWGS84Rad.map(w.rad2deg)};e.prototype.load=function(a){for(var b=0;b<t;b++)this.layerInfo[b]&&this._createOrUpdateAgents(0,
b);a.loadTile(this)};e.prototype.unload=function(a){this.renderData&&a.unloadTile(this);for(a=0;a<t;a++)for(var b=this.layerInfo[a],c=0;c<b.length;c++){var d=b[c];d.loadingAgent&&d.loadingAgent!==n&&(d.loadingAgent.dispose(),this.parentSurface.agentTypeByLayerIndex(c,a).Pool.release(d.loadingAgent),d.loadingAgent=null);d.pendingUpdates=0}this.pendingUpdates&=~g.TileUpdateTypes.UPDATE_GEOMETRY;this.pendingUpdates&=~g.TileUpdateTypes.UPDATE_TEXTURE};e.prototype.updateClippingStatus=function(a){x.equals(a,
this.clippingArea)||(a?(this.intersectsClippingArea=this._intersectsExtent(a),this.isWithinClippingArea=this._isWithinExtent(a)):this.isWithinClippingArea=this.intersectsClippingArea=!0,this.clippingArea=a,this.renderData&&this.updateGeometry())};e.prototype.updateVisibility=function(a,b,c){a=c||this.isVisible(a,b)&&this.intersectsClippingArea;if(a!==this.visible){this.visible=a;b=this.layerInfo[0];for(c=0;c<b.length;c++){var d=b[c];d.loadingAgent&&d.loadingAgent!==n&&d.loadingAgent.setSuspension(!a)}}return a};
e.prototype.getLayerInfo=function(a,b){return this.layerInfo[b][a]};e.prototype.hasLayerData=function(a,b){var c=this.layerInfo[b][a];return c&&c.data};e.prototype.tileDataAvailable=function(a,b,c){return(b=this.layerInfo[c][b].tilemapData)?null!=b.dataValue?b.dataValue:b.isTileAvailable(a.lij[1],a.lij[2]):!0};e.prototype.requestLayerData=function(a,b,c){g.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d requested by tile %s",this.lij.toString(),b,a,c.tile.lij.toString());var d=this.layerInfo[b][a];
if(-1<d.waitingAgents.indexOf(c))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),c.tile.lij.toString(),b,a),!0;if(d.data)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),c.tile.lij.toString(),b,a),d.waitingAgents.push(c),setTimeout(c.dataArrived.bind(c,this),0),!0;d.waitingAgents.push(c);if(!d.requestPromise){var e=this.parentSurface.requestTileData(this,a,
b);a=function(){d.requestPromise===e&&(d.requestPromise=null)};d.requestPromise=e;e.then(a,a)}return d.requestPromise?!0:!1};e.prototype.descendants=function(a){a||(a=[]);for(var b=0;4>b;b++){var c=this.children[b];c&&(c.descendants(a),a.unshift(this.children[b]))}return a};e.prototype.isLij=function(a){return this.lij[0]===a[0]&&this.lij[1]===a[1]&&this.lij[2]==a[2]};e.prototype.findByLij=function(a){if(this.isLij(a))return this;for(var b=0;4>b;b++){var c=this.children[b];if(c&&(c=c.findByLij(a)))return c}return null};
e.prototype.unrequestLayerData=function(a,b,c){g.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d canceled by tile %s",this.lij.toString(),b,a,c.tile.lij.toString());var d=this.layerInfo[b][a],e=d.waitingAgents;c=e.indexOf(c);z(-1<c,"agent has not requested this piece of map data");e[c]=e[e.length-1];e.length--;1>e.length&&(z(d.requestPromise||d.rawData,"no pending operations on layerInfo that agents were waiting for"),d.requestPromise&&(this.parentSurface.cancelRequest(d.requestPromise),d.requestPromise=
null),d.rawData&&(d.rawData=null),g.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d request/loading canceled",this.lij.toString(),b,a))};e.prototype.dataArrived=function(a,b,c){a=this.layerInfo[b][a];a.data=c;for(c=0;c<a.waitingAgents.length;c++)a.waitingAgents[c].dataArrived(this);a.waitingAgents.length=0};e.prototype.dataMissing=function(a,b,c){c.notInTilemap||console.error("Tile %s layer %d/%d error",this.lij.toString(),b,a);a=this.layerInfo[b][a];for(b=0;b<a.waitingAgents.length;b++)a.waitingAgents[b].dataMissing(this);
a.waitingAgents.length=0};e.prototype.updateTexture=function(a){this.renderData&&(a?this.parentSurface._renderer.updateTileTexture(this):(this.pendingUpdates|=g.TileUpdateTypes.UPDATE_TEXTURE,this.parentSurface._pendingUpdates=!0))};e.prototype.updateElevationBounds=function(){s.set2(Number.MAX_VALUE,-Number.MAX_VALUE,this.elevationBounds);for(var a=this.layerInfo[m],b=!1,c=0;c<a.length;c++){var d=a[c];if(d.elevationBounds){var e=this.parentSurface.layerViewByIndex(c,m);v.fallsWithinLayer(this,e,
!1)&&(this.elevationBounds[0]=Math.min(this.elevationBounds[0],d.elevationBounds[0]),this.elevationBounds[1]=Math.max(this.elevationBounds[1],d.elevationBounds[1]),b=!0)}}b||s.set2(0,0,this.elevationBounds);this.updateRadiusAndCenter()};e.prototype.updateRadiusAndCenter=function(){var a=this.elevationBounds[1]-this.elevationBounds[0],b=this.edgeLen*Math.SQRT1_2;this.radius=Math.sqrt(b*b+a*a);f.scale(this.tileUp,this.elevationBounds[0]+0.5*a,k);f.add(this.centerAtSeaLevel,k,this.center)};e.prototype.setLayerElevationBounds=
function(a,b){var c=this.layerInfo[m][a];if(!c.elevationBounds||c.elevationBounds[2]<b[2])c.elevationBounds=b,this.updateElevationBounds()};e.prototype.updateGeometry=function(){this.pendingUpdates|=g.TileUpdateTypes.UPDATE_GEOMETRY;this.parentSurface._pendingUpdates=!0};e.prototype.modifyLayers=function(a,b,c){for(var d=b.length,e=this.layerInfo[c],f=Array(d),h=0;h<e.length;h++){var l=e[h];l.loadingAgent&&l.loadingAgent!==n&&(l.loadingAgent.dispose(),this.parentSurface.agentTypeByLayerIndex(h,c).Pool.release(l.loadingAgent),
l.loadingAgent=null);l.waitingAgents.length=0}if(c===G)for(h=0;h<e.length;h++)void 0===a[h]&&(l=e[h],l.data instanceof WebGLTexture&&this.parentSurface._renderer.releaseTileTexture(l.data));for(h=0;h<d;h++)a=b[h],f[h]=-1<a?e[a]:A(c);this.layerInfo[c]=f};e.prototype.restartAgents=function(a){if(this.renderData)if(this._createOrUpdateAgents(0,a),a===m){this.updateGeometry();a=this.layerInfo[a];for(var b=0;b<a.length;b++)a[b].pendingUpdates|=g.TileUpdateTypes.UPDATE_GEOMETRY;this.parentSurface._pendingUpdates=
!0}else this.updateTexture(!0)};e.prototype.updateAgents=function(a){if(this.renderData){for(var b=this.layerInfo[a],c=0;c<b.length;c++){var d=b[c];d.loadingAgent===n&&(d.loadingAgent=null)}this._createOrUpdateAgents(0,a)}};e.prototype.agentDone=function(a,b){var c=this.layerInfo[b],d=c[a];d.loadingAgent=n;!d.data&&!d.upsampleFromTile&&a<c.length-1&&this._createOrUpdateAgents(a+1,b)};e.prototype._createOrUpdateAgents=function(a,b){var c;c=b===m?!1:!this.visible;for(var d=a,e=this.layerInfo[b];d<e.length;){var f=
e[d],h=!1,l=this.parentSurface.layerViewByIndex(d,b);if(null!==f.loadingAgent&&f.loadingAgent!==n)h=f.loadingAgent.update();else if(f.loadingAgent!==n&&v.fallsWithinLayer(this,l,!1)){var g=this.parentSurface.agentTypeByLayerIndex(d,b),k=g.Pool.acquire();(h=k.init(this,d,b,c))?f.loadingAgent=k:(g.Pool.release(k),f.loadingAgent=n)}if(h&&!l.isTransparent())break;d++}};e.prototype.geometryState=function(a){var b,c=this._getElevationInfo(a?a.samplerData:null),d=this.lij[0],e=!1;c.samplerData?(b=this.vlevel-
d,b=Math.max(d-c.maxTileLevel,g.ELEVATION_DESIRED_RESOLUTION_LEVEL-b),b=w.clamp((256>>b)+1,2,257)):b=8>d?this._numSubdivisionsAtLevel[d]+1:2;b=C.supportedNumVertsPerRow(b);d=this.clippingArea;if(!this.intersectsClippingArea||this.isWithinClippingArea)d=null;a?(a.numVertsPerRow!==b&&(a.numVertsPerRow=b,e=!0),c.changed&&(a.samplerData=c.samplerData,e=!0),x.equals(a.clippingArea,d)||(a.clippingArea=d,e=!0),a.needsUpdate=e):a={numVertsPerRow:b,samplerData:c.samplerData,needsUpdate:!0,clippingArea:d};
return a};e.prototype._getElevationInfo=function(a){for(var b=this.layerInfo[m],c=b.length,d=Array(c),e=0,f=0,h=!1,l=0;l<c;l++){var g=b[l];if(g.upsampleFromTile){var g=g.upsampleFromTile.tile,k=g.layerInfo[m][l].data;if(!a||a[e]!==k.samplerData)h=!0;d[e++]=k.samplerData;f=Math.max(f,g.lij[0])}else if(g.data&&(k=this.parentSurface.layerViewByIndex(l,m),v.fallsWithinLayer(this,k,!1))){if(!a||a[e]!==g.data.samplerData)h=!0;d[e++]=g.data.samplerData;f=this.lij[0]}}a&&a.length!==e&&(h=!0);0<e?d.length=
e:d=null;return{changed:h,samplerData:d,maxTileLevel:f}};e.prototype._isWithinExtent=function(a){var b=this.extent;return b[0]>=a[0]&&a[2]>=b[2]&&b[1]>=a[1]&&a[3]>=b[3]};e.prototype._intersectsExtent=function(a){var b=this.extent;return b[2]>=a[0]&&a[2]>=b[0]&&b[3]>=a[1]&&a[3]>=b[1]};y.prototype.init=function(a){this.waitingAgents.length=0;this.rawData=this.requestPromise=this.loadingAgent=this.upsampleFromTile=this.tilemapRequest=this.tilemapData=this.data=null;this.pendingUpdates=0;a===m&&(this.elevationBounds=
null)};var A=function(a,b){return b?(b.init(a),b):new y(a)};return e});