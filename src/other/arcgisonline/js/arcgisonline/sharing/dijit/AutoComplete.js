// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/AutoComplete","dojo/_base/array dojo/_base/declare dojo/_base/lang dojo/_base/window dojo/dom dojo/dom-attr dojo/dom-class dojo/dom-construct dojo/dom-style dojo/html dojo/json dojo/keys dojo/on dojo/query dojo/request dojo/string dijit/focus dijit/form/TextBox dijit/registry dijit/_OnDijitClickMixin dijit/_TemplatedMixin dijit/_WidgetBase dgrid/OnDemandGrid dgrid/Selection dgrid/Keyboard arcgisonline/sharing/util dojo/NodeList-traverse dojo/NodeList-manipulate".split(" "),
function(c,t,f,F,g,G,k,e,l,v,H,n,x,h,I,u,p,y,w,z,A,B,C,D,E,s){return t("arcgisonline.sharing.dijit.AutoComplete",[B,z,A],{_attachmentNode:"",_autocompleteList:"",_grid:"",_store:"",_matchParam:"",_idProperty:"",_gridId:"",_filterId:"",_placeHolder:"",_noDataMsg:"",_maxWidth:"",_minWidth:"",_inputTextBox:"",_gridHasFocus:!1,_metaKeyPressed:!1,_shiftKeyPressed:!1,_CSS_STYLES:{CLASS_SELECTOR:".",ALL_SELECTOR:"\x3e",MULTI:"select2-container select2-container-multi",CHOICES:"select2-choices",CHOICE:"select2-search-choice",
SEARCH_CHOICE_FOCUS:"select2-search-choice-focus",SEARCH_FIELD:"select2-search-field",CLOSE_ICON:"select2-search-choice-close"},values:[],_selRows:[],_CHOICE_SELECTOR:"",_CHOICE_FOCUS:"",_CHOICE_FOCUS_ALL:"",constructor:function(a,b){this._attachmentNode=b;this._idProperty=a.idProperty;this._gridId=a.gridId;this._filterId=a.filterId;this._store=a.store;this._placeHolder=a.placeholder;this._noDataMsg=a.noDataMsg;this._maxWidth=a.maxWidth;this._minWidth=a.minWidth;this._matchParam=a.matchParam;this.values=
[];this._selRows=[];this._CHOICE_ALL_SELECTOR=this._CSS_STYLES.CLASS_SELECTOR+this._CSS_STYLES.CHOICE+this._CSS_STYLES.ALL_SELECTOR;this._CHOICE_FOCUS=this._CSS_STYLES.CLASS_SELECTOR+this._CSS_STYLES.SEARCH_CHOICE_FOCUS;this._CHOICE_FOCUS_ALL=this._CHOICE_FOCUS+this._CSS_STYLES.ALL_SELECTOR},buildRendering:function(){this._createContainerNode();this._createTagList();this._createDropDownList();this._createInput();var a=f.hitch(this,function(b,a,d){a=this._inputTextBox?this._inputTextBox.get("value")+
"":"";if(1>a.length)return!0;if(!b.tag)return!1;b=(b.tag+"").toLowerCase().match(RegExp("^"+a.toLowerCase()));return null!==b&&0<b.length?!0:!1}),b=f.hitch(this,function(b,a,d){a=this._inputTextBox?this._inputTextBox.get("value")+"":"";return 1>a.length?!0:!b.tag?!1:~(b.tag+"").toLowerCase().indexOf(a.toLowerCase())?!0:!1}),d=[{field:this._idProperty}],m=[{attribute:this._idProperty,ascending:!0}];this._grid=new (t([C,D,E]))({store:this._store,showHeader:!1,noDataMessage:this._noDataMsg,selectionMode:"extended",
allowSelectAll:!0,cellNavigation:!1,columns:d,sort:m,renderRow:this._renderItem},this._gridId);k.add(this._gridId,"gridHeightLimiter");this._grid.query="first"===this._matchParam?a:b},postCreate:function(){var a;this._inputTextBox.watch("value",f.hitch(this,function(b,d,m){a&&(clearTimeout(a),a=null);this._grid.refresh()}));this._grid.on(".dgrid-row:click",f.hitch(this,function(b){var a="";!this._shiftKeyPressed&&!this._metaKeyPressed?(a=this._grid.row(b).data.tag,this._createTags(a),this._store.remove(a),
this._grid.refresh(),this._resetInputTextBox()):!b.shiftKey&&(!b.metaKey&&!b.ctrlKey)&&(a=this._selRows[0],this._createTags(a),this._store.remove(a),this._grid.refresh(),this._resetInputTextBox())}));this._grid.on("dgrid-deselect",f.hitch(this,function(a){this._selRows=[];for(var d in this._grid.selection)this._selRows.push(d)}));this._grid.on("dgrid-select",f.hitch(this,function(a){this._selRows=[];for(var d in this._grid.selection)this._selRows.push(d)}));this.connect(this.domNode,"keydown","_keydownHandler");
window.onkeydown=f.hitch(this,function(a){if(a.shiftKey||a.ctrlKey||224===a.keyCode)this._metaKeyPressed=!0});this.connect(document,"onkeydown",f.hitch(this,function(a){this._metaKeyPressed=this._shiftKeyPressed=!0}))},_keydownHandler:function(a){var b;void 0!==p.curNode.value&&(b=p.curNode.value.length);var d=h(this._CHOICE_FOCUS,g.byId(this.id)),m=h(this._CSS_STYLES.CLASS_SELECTOR+this._CSS_STYLES.CHOICE,g.byId(this.id)).last();switch(a.keyCode){case n.RIGHT_ARROW:this._navigate(d,b,m,"right");
this._hideGrid();break;case n.LEFT_ARROW:this._navigate(d,b,m,"left");this._hideGrid();break;case n.DOWN_ARROW:a.preventDefault();this._unhighlightTag(d);"none"===l.get(this._gridId,"display")&&this._showGrid();this._gridHasFocus||(this._grid.focus(this._setFocusOnFirstRow(this._grid,0)),this._gridHasFocus=!0);break;case n.UP_ARROW:break;case n.BACKSPACE:var q;if(0===b&&0===h(this._CHOICE_FOCUS_ALL).length&&void 0!==h(this._CHOICE_ALL_SELECTOR)[h(this._CHOICE_ALL_SELECTOR).length-1]&&(q=h(this._CHOICE_ALL_SELECTOR)[h(this._CHOICE_ALL_SELECTOR).length-
1].title,0<h("li",this._attachmentNode).length&&(e.destroy(m[0]),void 0!==q)))try{this._store.add({tag:q})}catch(k){}if(0<h(this._CHOICE_FOCUS_ALL).length&&(q=h(this._CHOICE_FOCUS_ALL).text(),e.destroy(d[0]),void 0!==q))try{this._store.add({tag:q})}catch(t){}this._grid.refresh();0===b&&this._hideGrid();this._removeTag(q);break;case n.CTRL:this._metaKeyPressed=!0;break;case n.META:this._metaKeyPressed=!0;break;case n.SHIFT:this._shiftKeyPressed=!0;break;case n.ENTER:if(0<b){b=s.stripHTML(p.curNode.value);
b=b.split(",");var r=[];c.forEach(b,function(a,b){-1===c.indexOf(r,a)&&r.push(u.trim(a))});c.forEach(r,f.hitch(this,function(a,b){this._isEmpty(a)||this._contains(this.values,a)||this._createTags(a)}))}else{for(b=0;b<this._selRows.length;b++)this._createTags(this._selRows[b]),this._store.remove(this._selRows[b]);this._metaKeyPressed=this._shiftKeyPressed=!1}this._resetInputTextBox();a.preventDefault();p.focus(g.byId(this._filterId));break;case n.TAB:if(!(p.curNode.id===this._filterId&&0===b)){if(0<
b)b=s.stripHTML(p.curNode.value),b=b.split(","),r=[],c.forEach(b,function(a,b){-1===c.indexOf(r,a)&&r.push(u.trim(a))}),c.forEach(r,f.hitch(this,function(a,b){this._isEmpty(a)||this._contains(this.values,a)||this._createTags(a)}));else{for(b=0;b<this._selRows.length;b++)this._createTags(this._selRows[b]),this._store.remove(this._selRows[b]);this._metaKeyPressed=this._shiftKeyPressed=!1}this._resetInputTextBox();a.preventDefault();p.focus(g.byId(this._filterId))}break;case n.ESCAPE:this._hideGrid();
break;default:-1<b&&("none"===l.get(g.byId(this._gridId),"display")&&this._showGrid(),this._unhighlightTag(d)),this._metaKeyPressed=!1}},_blurHandler:function(a,b,d){if(!this.focused){a=s.stripHTML(this._inputTextBox.value);if(0<a.length){var m=[];a=a.split(",");c.forEach(a,function(a,b){-1===c.indexOf(m,a)&&m.push(u.trim(a))});c.forEach(m,f.hitch(this,function(a,b){this._isEmpty(a)||this._contains(this.values,a)||this._createTags(a)}));this._resetInputTextBox()}this._hideGrid()}},_resetInputTextBox:function(){w.byId(this._filterId).set("value",
"")},_isEmpty:function(a){a=a.replace(/^\s+|\s+$/,"");return 0===a.length?!0:!1},_navigate:function(a,b,d,m){0<a.length&&1>b?("right"===m?this._hightlightTag(a.next()):this._hightlightTag(a.prev()),this._unhighlightTag(a)):1>b&&this._hightlightTag(d)},_contains:function(a,b){return 0<=c.indexOf(a,b)},_hightlightTag:function(a){a.addClass(this._CSS_STYLES.SEARCH_CHOICE_FOCUS)},_unhighlightTag:function(a){a.removeClass(this._CSS_STYLES.SEARCH_CHOICE_FOCUS)},_removeTag:function(a){a&&-1!==c.indexOf(this.values,
a)&&this.values.splice(c.indexOf(this.values,a),1)},_hideGrid:function(){g.byId(this._gridId)&&l.set(g.byId(this._gridId),"display","none");this._gridHasFocus=!1},_showGrid:function(){l.set(g.byId(this._gridId),"display","block");var a=l.get(g.byId(this._attachmentNode),"width");l.set(g.byId(this._gridId),"width",a+"px")},_setFocusOnFirstRow:function(a,b){return h(".dgrid-content .dgrid-cell",this._grid.domNode)[b]||h(".dgrid-content .dgrid-row",this._grid.domNode)[b]},_createTags:function(a){h(this._CHOICE_FOCUS,
g.byId(this.id)).removeClass("select2-search-choice-focus");var b=e.create("li",null,this._autocompleteList);k.add(b,this._CSS_STYLES.CHOICE);b=e.create("div",{title:a},b);v.set(b,s.htmlEncode(a));b=e.create("a",{href:"#"},b);k.add(b,this._CSS_STYLES.CLOSE_ICON);x(b,"click",f.hitch(this,function(a){var b=a.target.parentElement.innerText||a.target.parentElement.textContent;try{this._store.add({tag:b})}catch(c){}this._grid.refresh();this._removeTag(b);e.destroy(a.target.parentNode.parentNode);a.preventDefault()}));
b=w.byId(this._filterId);e.place(b.domNode,this._autocompleteList,"last");this._hideGrid();this.values.push(a)},_renderItem:function(a){return e.create("div",{innerHTML:a.tag})},_createContainerNode:function(){this.domNode=e.create("div",null,this._attachmentNode);k.add(this.domNode,this._CSS_STYLES.MULTI);l.set(this.domNode,"maxWidth",this._maxWidth);l.set(this.domNode,"minWidth",this._minWidth)},_createTagList:function(){this._autocompleteList=e.create("ul",null,this.domNode);k.add(this._autocompleteList,
this._CSS_STYLES.CHOICES)},_createInput:function(){var a=e.create("li",null,this._autocompleteList,"last");k.add(a,this._CSS_STYLES.SEARCH_FIELD);this._inputTextBox=new y({id:this._filterId,placeHolder:this._placeHolder,intermediateChanges:!0,trim:!0,style:{border:"none"}},a);k.add(this._inputTextBox,"inputTextBox");l.set(this._inputTextBox,"width",this._minWidth);p.watch("curNode",f.hitch(this,this._blurHandler))},_createDropDownList:function(){var a=e.create("div",{id:this._gridId},this.domNode);
k.add(a,"dropDownList");l.set(a,"width",this._minWidth)},prepopulate:function(a){c.forEach(a,f.hitch(this,function(a,d){this._createTags(a);this._store.remove(a)}))},clearTags:function(){var a=h(this._CSS_STYLES.CLASS_SELECTOR+this._CSS_STYLES.CHOICE,g.byId(this.id));0<a.length&&(c.forEach(a,f.hitch(this,function(a,d){try{this._store.add({tag:h(this._CHOICE_ALL_SELECTOR,g.byId(this.id))[0].title})}catch(c){}e.destroy(a)})),this.values=[])},addStyledTags:function(a,b){k.add(g.byId(b),this._CSS_STYLES.MULTI);
var d=e.create("ul",null,g.byId(b));k.add(d,this._CSS_STYLES.CHOICES);l.set(d,"border","none");c.forEach(a,function(a,b){var c=e.create("li",null,d);l.set(c,"padding","3px 5px 3px 5px");k.add(c,"select2-search-resultSet");c=e.create("div",{title:a},c);v.set(c,a)})}})});