// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/map/dijit/renderer/UniqueValuesGrid","dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/connect dojo/_base/html dojo/on dojo/dom dojo/query dojo/mouse dojo/has dojo/topic dojo/string dojo/dom-class dojo/dom-style dojo/dom-construct dojox/html/entities dijit/form/Button dijit/form/CheckBox dijit/Tooltip esri/symbols/jsonUtils esri/styles/type esri/lang dgrid/OnDemandGrid dgrid/Selection dgrid/editor dgrid/extensions/DnD dojo/dnd/Source dojo/dnd/Manager dojo/dnd/Avatar dojo/store/Memory dojo/store/Observable arcgisonline/map/dijit/renderer/_UniqueValuesMixin arcgisonline/map/dijit/renderer/_SymbolsMixin arcgisonline/map/dijit/renderer/_RendererMixin dojo/i18n!arcgisonline/nls/arcgisonline dijit/_Widget dijit/registry".split(" "),
function(x,g,h,k,v,y,n,l,P,w,z,A,p,u,f,r,Q,E,s,q,B,F,G,H,I,J,R,m,K,t,C,L,M,N,D,O,S){v=x([O],{declaredClass:"arcgisonline.map.dijit.renderer.UniqueValuesGrid",basePath:require.toUrl("arcgisonline/map/dijit/renderer"),baseClass:"esriAGOUniqueValuesGrid",i18n:null,id:"",grid:null,lastDefaultLabel:null,lastDefaultSymbol:null,ordersList:null,didDragFromSource:!1,symbolButton:null,otherCheckBox:null,scrollPos:0,batchCount:205,tooltips:[],headerTooltips:[],constructor:function(a,b){g.mixin(this,L);g.mixin(this,
N);g.mixin(this,M);null!=a&&(a.id&&(this.id=a.id),a.renderer&&(this.renderer=a.renderer),a.allUniqueValues&&(this.allUniqueValues=a.allUniqueValues),this.hasUniqueValuesCount=this.allUniqueValues&&this.allUniqueValues.length&&F.isDefined(this.allUniqueValues[0].count),a.style&&(this.style=a.style),a.onSymbolClick&&(this.onSymbolClick=a.onSymbolClick),a.onLabelClick&&(this.onLabelClick=a.onLabelClick),a.defaultInfo&&(this.defaultInfo=a.defaultInfo),a.backgroundSymbol&&(this.backgroundSymbol=a.backgroundSymbol),
a.params&&g.mixin(this,a.params))},postMixInProperties:function(){this.inherited(arguments);this.i18n=g.clone(D.common);g.mixin(this.i18n,D.rendererUniqueValuesPanel)},postCreate:function(){this.createGrid()},destroy:function(){this.onRendererItemChangeHandler&&z.unsubscribe(this.onRendererItemChangeHandler);h.forEach(this.tooltips,function(a){a.destroy()});h.forEach(this.headerTooltips,function(a){a.destroy()});this.grid&&(delete this.store,this.grid.destroy(),delete this.grid);this.inherited(arguments)},
resize:function(){l(".symbolCell").style("width",this.maxSymbolWidth+10+"px");this.adjustButtonColumn();this.grid.resize()},adjustButtonColumn:function(){100>l(".labelCell").style("width")[0]?(u.set(this.changeSymbolsText,"display","none"),u.set(this.ungroupText,"display","none")):(u.set(this.changeSymbolsText,"display",""),u.set(this.ungroupText,"display",""))},hide:function(){},updateGrid:function(a){this.renderer=a;h.forEach(this.tooltips,function(a){a.destroy()});this.hideMsgs();this.getData();
this.store=C(new t({data:this.data,idProperty:"id",put:g.partial(this.observerPutHandler,this),query:function(a,c){c=c||{};c.sort=[{attribute:"order"}];return t.prototype.query.call(this,a,c)}}));this.scrollPos=this.grid.bodyNode.scrollTop;this.grid.set("store",this.store)},createGrid:function(){this.grid?(h.forEach(this.tooltips,function(a){a.destroy()}),h.forEach(this.headerTooltips,function(a){a.destroy()}),this.scrollPos=this.grid.bodyNode.scrollTop,delete this.store,this.grid.destroy(),delete this.grid):
this.scrollPos=0;n.byId("_uniqueValuesRendererGrid")||f.create("div",{id:"_uniqueValuesRendererGrid"},this.domNode);this.maxSymbolWidth=30;this.getData();this.getColumns();this.store=C(new t({data:this.data,idProperty:"id",put:g.partial(this.observerPutHandler,this),query:function(a,b){b=b||{};b.sort=[{attribute:"order"}];return t.prototype.query.call(this,a,b)}}));this.grid=new (x([G,H,J]))({store:this.store,selectionMode:"single",columns:this.columns,style:this.style?this.style:"width: 200px;",
sort:[{attribute:"order"}],minRowsPerPage:this.batchCount,maxRowsPerPage:this.batchCount,showHeader:!0,dndParams:{withHandles:!0}},"_uniqueValuesRendererGrid");this.onDndStartHandler&&k.disconnect(this.onDndStartHandler);this.onMouseMoveHandler&&k.disconnect(this.onMouseMoveHandler);this.onDndCancelHandler&&k.disconnect(this.onDndCancelHandler);this.onDndStartHandler=k.connect(this.grid.dndSource,"onDndStart",g.hitch(this,"handleDragStart"));this.onMouseMoveHandler=k.connect(this.grid.dndSource,"onMouseMove",
g.hitch(this,"handleDragMove"));this.onDndCancelHandler=k.connect(this.grid.dndSource,"onDndCancel",g.hitch(this,"handleDragEnd"));this.grid.on("dgrid-editor-hide",g.hitch(this,function(a){this.handleLabelChange(a.cell.row.data,a.editor.value)}));this.grid.on("dgrid-error",g.hitch(this,function(a){console.log("dGrid error",a.error.message)}));this.grid.on("dgrid-refresh-complete",g.hitch(this,function(a){this.grid.scrollTo({y:this.scrollPos});this.displayMsgs();l(".symbolCell").style("width",this.maxSymbolWidth+
10+"px");this.adjustButtonColumn()}));this.resize()},getColumns:function(){this.columns={};this.columns.check={className:"checkCell",field:"check",label:"",sortable:!1,renderCell:g.hitch(this,function(a,b,c,d){if("otherCategory"===a.type)return a=f.create("div",{},c),this.otherCheckBox=new E({checked:this.renderer.defaultSymbol?!0:!1,onChange:g.hitch(this,"onOtherCheckChange")},a),this.otherCheckBox.startup(),this.tooltips.push(new s({connectId:[this.otherCheckBox.domNode],label:"\x3cdiv class\x3d'rendererTooltip'\x3e"+
this.i18n.otherTooltip+"\x3c/div\x3e"})),a;if(!a.type)return p.add(c,"dojoDndHandle"),a=f.create("div",{"class":"dndIcon esriFloatTrailing"})})};this.columns.symbol={className:"symbolCell",field:"symbol",label:"",sortable:!1,renderCell:g.hitch(this,function(a,b,c,d){if(b){var e=f.create("div",{style:"width:"+a.symbolSize.width+"px;height:"+a.symbolSize.height+"px;","class":"symbol"});y(c,"click",g.hitch(this,function(a){this.didDragFromSource||(this.grid.clearSelection&&this.grid.clearSelection(),
this.grid.dndSource&&this.grid.dndSource.selectNone(),this.onRowClickSymbolHandler(a))},a));this.tooltips.push(new s({connectId:[e],label:"\x3cdiv class\x3d'rendererTooltip'\x3e"+this.i18n.oneSymbolTooltip+"\x3c/div\x3e"}));9>w("ie")?setTimeout(g.hitch(this,function(a,b,c){this.isSymbolTransparent(b)?this.drawTransparentSymbol(a):(this.drawSymbol(a,b,c.symbolSize.width,c.symbolSize.height,null,1),this.updateBackgroundForAlmostWhite(b,a))},e,b,a),100):this.isSymbolTransparent(b)?this.drawTransparentSymbol(e):
(this.drawSymbol(e,b,a.symbolSize.width,a.symbolSize.height,null,1),this.updateBackgroundForAlmostWhite(b,e))}return e})};this.columns.label=I({className:"labelCell",field:"label",name:this.i18n.labelTitle,label:this.i18n.labelTitle,sortable:!1,canEdit:function(a){return!a.type||"otherCategory"===a.type},renderCell:g.hitch(this,function(a,b,c,d){return"otherCategory"===a.type?a=f.create("span",{innerHTML:r.encode(a.label),"class":"otherCategory"}):"other"===a.type?(b=f.create("div",{}),f.create("span",
{innerHTML:r.encode(a.label),"class":"other"},b),b):a="otherNoData"===a.type?f.create("span",{innerHTML:r.encode(a.label),"class":"otherNoData"}):f.create("span",{innerHTML:r.encode(a.label),"class":"info"})})},"text","click");if(this.hasUniqueValuesCount||1===this.data.length)this.columns.count={className:"countCell",field:"count",label:this.i18n.countTitle,sortable:!1,renderHeaderCell:g.hitch(this,function(a){return f.create("span",{innerHTML:this.i18n.countTitle,"class":"countHeader"},a)}),renderCell:g.hitch(this,
function(a,b,c,d){return"other"===a.type?f.create("span",{innerHTML:a.count||0,"class":"other"}):"otherNoData"===a.type?f.create("span",{innerHTML:a.count||0,"class":"otherNoData"}):f.create("span",{innerHTML:a.count||0})})};this.columns.button={className:"buttonCell",field:"button",label:"",sortable:!1,renderCell:g.hitch(this,function(a,b,c,d){if("otherCategory"===a.type){b=f.create("div",{},c);a=f.create("table",{cellpadding:0,cellspacing:0,style:"padding: 0 5px;"},b);d=f.create("tbody",{},a);d=
f.create("tr",{},d);var e=f.create("td",{},d);f.create("div",{click:g.hitch(this,"handleUngroupClick"),"class":"ungroupIcon",style:1<this.data.length?"cursor: pointer;":""},e);e=f.create("td",{},d);this.ungroupText=f.create("div",{click:g.hitch(this,"handleUngroupClick"),innerHTML:this.i18n.ungroup,style:"padding:0 5px;"+(1<this.data.length?"color: #21759B;cursor: pointer;":"color: #909090")},e);this.tooltips.push(new s({connectId:[a],label:"\x3cdiv class\x3d'rendererTooltip'\x3e"+this.i18n.ungroupTooltip+
"\x3c/div\x3e"}));return b}"other"===a.type&&(b=f.create("div",{style:"padding:0 5px;"},c),b=f.create("div",{"class":"othersArrowIcon",style:"cursor: pointer;"},b),y(b,"click",g.hitch(this,function(a){if(!this.didDragFromSource)return this.grid.clearSelection&&this.grid.clearSelection(),this.grid.dndSource&&this.grid.dndSource.selectNone(),this.onRowClickArrowHandler(a,c),!1},a)),this.tooltips.push(new s({connectId:[b],label:"\x3cdiv class\x3d'rendererTooltip'\x3e"+this.i18n.arrowTooltip+"\x3c/div\x3e"})))}),
renderHeaderCell:g.hitch(this,function(a){a=f.create("div",{},a);var b=f.create("table",{cellpadding:0,cellspacing:0,style:"padding: 0 5px;"},a),c=f.create("tbody",{},b),c=f.create("tr",{},c),d=f.create("td",{},c);f.create("div",{click:g.hitch(this,"handleChangeSymbols"),"class":"styleIcon",style:1<this.data.length?"cursor: pointer;":""},d);d=f.create("td",{},c);this.changeSymbolsText=f.create("div",{click:g.hitch(this,"handleChangeSymbols"),innerHTML:this.i18n.symbols,style:"padding:0 5px;"+(1<this.data.length?
"color: #21759B;cursor: pointer;":"color: #909090")},d);this.headerTooltips.push(new s({connectId:[b],label:"\x3cdiv class\x3d'rendererTooltip'\x3e"+this.i18n.symbolsTooltip+"\x3c/div\x3e"}));return a})}},getData:function(){var a=g.clone(this.allUniqueValues);this.data=h.map(this.renderer.infos,function(b,c){var d,e;for(e=0;e<a.length;e++)if(b.value==a[e].value){d=a[e].count;a.splice(e,1);break}e=this._calcSymbolWidthHeight(b.symbol);this.maxSymbolWidth=Math.max(this.maxSymbolWidth,e.width);return{symbol:b.symbol,
symbolSize:e,label:b.label,value:b.value,count:d,id:c,order:c+1}},this);if(!this.portalPanel.lastUniqueDefaultSymbol||!this.portalPanel.lastUniqueDefaultLabel)this.renderer.defaultSymbol&&this.renderer.defaultLabel?(this.portalPanel.lastUniqueDefaultSymbol=q.fromJson(this.renderer.defaultSymbol.toJson()),this.portalPanel.lastUniqueDefaultLabel=this.renderer.defaultLabel):this.defaultInfo?(this.portalPanel.lastUniqueDefaultSymbol=q.fromJson(this.defaultInfo.defaultSymbol.toJson()),this.portalPanel.lastUniqueDefaultLabel=
this.defaultInfo.defaultLabel):(this.portalPanel.lastUniqueDefaultSymbol=this.getDefaultSymbol(this.geometryType),this.portalPanel.lastUniqueDefaultLabel=this.i18n.others);var b=this.portalPanel.lastUniqueDefaultSymbol,c=this._calcSymbolWidthHeight(b);this.maxSymbolWidth=Math.max(this.maxSymbolWidth,c.width);b={type:"otherCategory",symbol:b,symbolSize:c,label:this.renderer.defaultLabel||this.portalPanel.lastUniqueDefaultLabel||this.i18n.other,value:"other",id:this.renderer.infos.length,order:this.renderer.infos.length+
1,count:0};this.data.push(b);var d=0;this.hasUniqueValuesCount&&(h.forEach(a,function(a,b){d+=a.count}),b.count=d);a.length+this.data.length-1>this.maxCount&&(a=a.slice(0,this.maxCount-(this.data.length-1)));var e=this.data.length,f=0,a=h.filter(a,function(a,b){return null===a.value?(this.hasUniqueValuesCount&&(f+=a.count),!1):!0},this),b=h.map(a,function(a,b){return{type:"other",label:a.label,value:a.value,count:a.count,id:b+e,order:b+1+e}});this.data=this.data.concat(b);f&&this.data.push({type:"otherNoData",
label:this.i18n.noData,value:null,count:f,id:this.data.length,order:this.data.length+1})},handleDragStart:function(a,b,c){if("rendererUniqueValuesStack"===leftPanel.visibleStack)if(this.sourceItem=this.grid.row(b[0]).data,"otherCategory"===this.sourceItem.type||"other"===this.sourceItem.type)z.publish("/dnd/cancel"),m.manager().stopDrag(),this.grid.clearSelection(),this.grid.dndSource.selectNone();else return this.ordersList=h.map(this.data,function(a){return a.order}),this.ordersList=this.ordersList.sort(function(a,
b){return a-b}),this.sourceOrdersPos=h.indexOf(this.ordersList,this.sourceItem.order),this.didDragFromSource=!1,K.prototype._generateText=g.partial(function(a){return"\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp;\x26nbsp;"+r.encode(a)+"\x26nbsp;\x26nbsp;"},this.sourceItem.label),m.manager().updateAvatar(),!0},handleDragMove:function(a){if("rendererUniqueValuesStack"===leftPanel.visibleStack&&this.sourceItem){var b=function(){9>w("ie")&&(!0!==m.manager().canDropFlag&&m.manager().avatar)&&(m.manager().canDropFlag=
!0,p.toggle(m.manager().avatar,"dojoDndAvatarCanDrop",m.manager().canDropFlag),m.manager().updateAvatar())};a=function(){!1!==m.manager().canDropFlag&&(m.manager().canDropFlag=!1,p.toggle(m.manager().avatar,"dojoDndAvatarCanDrop",m.manager().canDropFlag),m.manager().updateAvatar())};l(".canDragBefore",n.byId("renderer-unique-main")).forEach(function(a){p.remove(a,"canDragBefore")});l(".canDragAfter",n.byId("renderer-unique-main")).forEach(function(a){p.remove(a,"canDragAfter")});var c=!0;if(this.grid.dndSource.current){var d=
this.grid.row(this.grid.dndSource.current).data;!this.didDragFromSource&&d.id!==this.sourceItem.id&&(this.didDragFromSource=!0);this.ordersList[this.sourceOrdersPos]==d.order?(a(),c=!1):this.sourceOrdersPos<this.ordersList.length-1&&this.ordersList[this.sourceOrdersPos+1]==d.order?(d=l(".dojoDndItemBefore",n.byId("renderer-unique-main")),d.length?(a(),c=!1):b()):0<this.sourceOrdersPos&&this.ordersList[this.sourceOrdersPos-1]==d.order?(d=l(".dojoDndItemAfter",n.byId("renderer-unique-main")),d.length?
(a(),c=!1):b()):b();c&&b()}else h.forEach(this.data,function(a,c){b()},this);c&&(d=l(".dojoDndItemBefore",n.byId("renderer-unique-main")),d.length&&p.add(d[0],"canDragBefore"),d=l(".dojoDndItemAfter",n.byId("renderer-unique-main")),d.length&&p.add(d[0],"canDragAfter"))}},handleDragEnd:function(a,b,c,d){if("rendererUniqueValuesStack"===leftPanel.visibleStack){l(".canDragBefore",n.byId("renderer-unique-main")).forEach(function(a){p.remove(a,"canDragBefore")});l(".canDragAfter",n.byId("renderer-unique-main")).forEach(function(a){p.remove(a,
"canDragAfter")});var e=0;h.forEach(this.data,function(a){"otherCategory"===a.type&&(e=a.order)});if(this.sourceItem.order>e){h.forEach(this.data,function(a){a.id===this.sourceItem.id&&(a.type="other",delete a.symbol,delete a.symbolSize)},this);b=!1;for(a=0;a<this.data.length;a++)if(!this.data[a].type){b=!0;break}b||this.otherCheckBox.set("checked",!0)}this.ordersList=this.sourceOrdersPos=this.sourceItem=null;setTimeout(g.hitch(this,function(){this.didDragFromSource=!1}),1E3);this.orderRendererInfos()}},
handleUngroupClick:function(){k.publish("onUngroupUniqueValues")},onRowClickArrowHandler:function(a,b){h.forEach(this.data,function(b){b.id===a.id&&delete b.type},this);this.orderRendererInfos()},orderRendererInfos:function(){var a=h.filter(this.data,function(a){return!a.type}),a=a.sort(function(a,b){var e=a.order,f=b.order;return e==f?0:e<f?-1:1}),a=h.map(a,function(a){return{value:a.value,label:a.label,symbol:a.symbol}}),b=null;this.otherCheckBox.checked&&h.forEach(this.data,function(a){"otherCategory"===
a.type&&(b={label:a.label,symbol:a.symbol})},this);k.publish("onReorderUniqueValues",[a,b])},handleChangeSymbols:function(){if(1!==this.data.length){for(var a=this.renderer.infos[0].symbol,b=B.getSchemes({theme:"default",basemap:this.getBasemapType(),geometryType:this.geometryType}),c=[],d=!1,e=0;e<this.renderer.infos.length;e++)if("picturemarkersymbol"!==this.renderer.infos[e].symbol.type&&(d=!0),12>e)c.push(this.getSymbolColor(this.renderer.infos[e].symbol));else break;if(d){if("picturemarkersymbol"===
a.type){for(e=1;e<this.renderer.infos.length;e++)if("picturemarkersymbol"!==this.renderer.infos[e].symbol.type){a=this.renderer.infos[e].symbol;break}"picturemarkersymbol"===a.type&&(a=this.getDefaultSymbol(this.geometryType))}}else c=g.clone(b.primaryScheme.colors),a=this.getDefaultSymbol(this.geometryType);c=c.reverse();b.primaryScheme.colors.reverse();h.forEach(b.secondarySchemes,function(a){a.colors=a.colors.reverse()});d=null;"uniquesize"===this.getRendererStyle(this.renderer)&&(d={symbolDisplayMode:"default"});
this.showSymbolStyler(a,{externalSizing:"uniquesize"===this.getRendererStyle(this.renderer)?!0:!1,optimizeOutline:this.hasOptimizeOutline(this.renderer.visualVariables),schemes:b,tabOptions:d,colorRamp:{colors:c,numStops:c.length,scheme:this.scheme}},g.hitch(this,"onSymbolsChange"))}},onSymbolsChange:function(a,b,c,d){if(a&&b){b=b.reverse();var e=a.toJson();if("esriPMS"==a.type&&(0==e.url.length||"http://"==e.url))a=q.fromJson(this.getMarkerJson());var f=[];h.forEach(this.renderer.infos,function(a){f.push(g.clone(a))});
h.forEach(f,function(a){this.renderer.removeValue(a.value)},this);h.forEach(f,function(c,d){var e=this.applyColorToSymbol(q.fromJson(a.toJson()),dojo.clone(b[d%12]));this.renderer.addValue({value:c.value,symbol:e,label:c.label||c.value})},this);k.publish("onUpdateUniqueValueSymbols",[b,c,d])}},handleLabelChange:function(a,b){a.label=b.length?b:this.getLabel(parseInt(a.value));h.forEach(this.data,function(b){a.id==b.id&&(b.label=a.label)},this);k.publish("onUpdateUniqueValue",[{symbol:a.symbol,value:"otherCategory"===
a.type?null:a.value,label:a.label}])},onOtherCheckChange:function(a){if(a)h.forEach(this.data,function(a){"otherCategory"===a.type&&k.publish("onUpdateUniqueValueDefault",[{symbol:a.symbol,label:a.label}])});else{var b=!1;for(a=0;a<this.data.length;a++)if(!this.data[a].type){b=!0;break}b?(this.portalPanel.lastUniqueDefaultSymbol=q.fromJson(this.renderer.defaultSymbol.toJson()),this.portalPanel.lastUniqueDefaultLabel=this.renderer.defaultLabel,k.publish("onUpdateUniqueValueDefault",[null])):this.otherCheckBox.set("checked",
!0)}},onRowClickSymbolHandler:function(a,b){var c=B.getSchemes({theme:"default",basemap:this.getBasemapType(),geometryType:this.geometryType}),d=null;"uniquesize"===this.getRendererStyle(this.renderer)&&"otherCategory"!==a.type&&(d={excluded:["shape"]});this.showSymbolStyler(a.symbol,{externalSizing:!1,optimizeOutline:this.hasOptimizeOutline(this.renderer.visualVariables),schemes:c,tabOptions:d},g.hitch(this,"onSymbolChange",a))},onSymbolChange:function(a,b,c,d,e){c=this._calcSymbolWidthHeight(b);
var f={symbol:b,symbolSize:c,label:a.label};h.forEach(this.data,function(b){a.id==b.id&&(b=g.mixin(b,f),this.store.put(b))},this);this.maxSymbolWidth=this._calcTotalSymbolWidthHeight().width;"otherCategory"===a.type?(c={symbol:b,label:a.label},this.portalPanel.lastUniqueDefaultSymbol=q.fromJson(b.toJson()),k.publish("onUpdateUniqueValueDefault",[c,e])):(c={symbol:b,value:a.value,label:a.label},k.publish("onUpdateUniqueValue",[c,e]))},observerPutHandler:function(a,b,c){c&&a.ordersList&&(c.before?h.forEach(a.ordersList,
function(d,e){d===c.before.order&&(b.order=0===e?d/2:(d+a.ordersList[e-1])/2)},this):b.order=a.ordersList[a.ordersList.length-1]+1);return t.prototype.put.call(this,b,c)},displayMsgs:function(){this.allUniqueValues.length>this.maxCount?this.displayMsg(A.substitute(this.i18n.tooManyValues,{count:this.maxCount})):1===this.data.length&&this.displayMsg(A.substitute(this.i18n.noFeatures,{other:this.portalPanel.lastUniqueDefaultLabel}))},displayMsg:function(a){var b=l(".dgrid-preload")[1],b=f.create("div",
{"class":"footerMsgDiv"},b,"after");f.create("span",{innerHTML:a,"class":"footerMsg"},b)},hideMsgs:function(a){l(".dgrid-preload").forEach(f.empty)}});w("extend-esri")&&g.setObject("arcgisonline.map.dijit.renderer.UniqueValuesGrid",v);return v});