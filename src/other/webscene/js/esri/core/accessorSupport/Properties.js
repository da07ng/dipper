// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/4.0beta2/esri/copyright.txt for details.
//>>built
define("dojo/has ../ObjectPool ../ArrayPool ../Scheduler ../lang ./Cache ./OldValues ./Property ./once ./introspect ./chainWatch".split(" "),function(q,r,n,w,x,t,y,z,s,k,A){var B=Object.prototype.hasOwnProperty,u=new r(function(){this.fn=null;this.removed=this.isExecuting=!1},function(){this.fn=null}),v=new r(function(){this.callbacks=this.oldValue=null},function(){this.oldValue=null;this.callbacks=n.put(this.callbacks);this.callbacks=null});q=function(a){this.obj=a;this.properties=Object.create(k.getProperties(a));
this.cache=new t;this.watchers=Object.create(null);this.bindings=Object.create(null);this.defaults=null;this.access=Object.create(null);this._notificationsPool=new r(function(){},function(){});this.notifications=this._notificationsPool.get()};q.prototype={obj:null,properties:null,notifyHdls:null,cache:null,watchers:null,bindings:null,initialized:!1,notifications:null,ctorArgs:null,timer:null,_boundDispatch:null,initialize:function(){this.initialized=!0;this.notifyHdls=k.installPropertyNotifiers(this.obj);
this.dispatch()},destroy:function(){this.notifyHdls&&this.notifyHdls.forEach(function(a){return a.remove()},this);this.timer&&this.timer.remove();var a=this.watchers;Object.getOwnPropertyNames(a).forEach(function(b){a[b].callbacks.forEach(function(a){a.removed=!0})});this.cache.destroy();this.defaults&&this.defaults.destroy();this.access=this.defaults=this.notifications=this.bindings=this.watchers=this.cache=this.properties=this.notifyHdls=this.timer=this.obj=null},getFromCache:function(a){var b=
this.cache,d=this.defaults,c=this.properties[a];return b.has(a)?b.get(a):d&&d.has(a)?d.get(a):c.value},get:function(a,b){var d=this.cache,c=this.defaults;if(d.has(a)&&!d.isDirty(a))return d.get(a);var e=this.obj,h=this._defineProperty(a),g=h.getter,f=h.getterArity;if(d.has(a))!b&&this.propertyWillChange(a),c=d.get(a),g&&(c=f?g.call(e,c):g.call(e)),d.set(a,c),this.propertyHasChanged(a,c);else if(g)!b&&this.propertyWillChange(a),c=f?g.call(e,h.value):g.call(e),d.set(a,c),this.propertyHasChanged(a,c);
else return c&&c.has(a)?c.get(a):h.value;return c},set:function(a,b){var d=this._defineProperty(a),c=d.getter,e=d.setter,h=d.setterArity,g=this.obj,f=this.cache;this.propertyWillChange(a);b=this._ensureType(d,b);if(e){if(b=2===h?e.call(g,b,this.getFromCache(a)):e.call(g,b),void 0!==b||!c)f.set(a,b),this.propertyHasChanged(a,b)}else f.set(a,b),this.propertyHasChanged(a,b)},setDefault:function(a,b){var d=this.defaults;d||(this.defaults=d=new t);var c=this._defineProperty(a,!0),e=c.getter,h=c.setter,
g=c.getterArity,f=c.setterArity,l=this.obj,p=this.cache.has(a);b=this._ensureType(c,b);p&&d.set(a,b);p||(h&&(b=2===f?h.call(l,b,d.get(a)):h.call(l,b),e&&(b=g?e.call(l,void 0):e.call(l))),this.initialized||d.set(a,b),this.propertyWillChange(a),d.set(a,b),this.propertyHasChanged(a,b))},hasBindings:function(a){a=this.bindings[a];return null!=a&&0<a.length},hasWatchers:function(a){a=this.watchers[a];return null!=a&&0<a.callbacks.length},bind:function(a,b,d){var c=this.bindings[a],e={key:b,fn:d};c?c.push(e):
(this._defineProperty(a,!0),this.bindings[a]=c=[e]);return{remove:s(function(){e.removed=!0;c.splice(c.indexOf(e),1)})}},propertyWillChange:function(a){var b=this.properties[a].chain,d,c;if(b){d=0;for(c=b.length;d<c;d++)this._propertyWillChange(b[d])}this._propertyWillChange(a)},_propertyWillChange:function(a){var b=this.cache,d=this.bindings[a],c=this.watchers[a],e=c&&c.callbacks,h=c&&c.oldValues,g=this.notifications[a],f,l=e&&0<e.length,p=this.initialized&&!this.timer,m=null;b.has(a)&&Object.getNotifier&&
(f=Object.getNotifier(this.obj))&&f.notify({type:"update",name:a,oldValue:this.getFromCache(a)});if(d){f=0;for(m=d.length;f<m;f++)d[f].fn.call(this,d[f].key)}l&&(g||(g=this.notifications[a]=n.get(),c.isDirty=!0),c.isDirty&&(c.isDirty=!1,m=v.get(),m.oldValue=this.get(a,!0),m.callbacks=n.getCopy(e),g.push(m),h&&(b.set(a,h.add(this.obj[a])),b.setDirty(a))),p&&(this._boundDispatch||(this._boundDispatch=this.dispatch.bind(this)),this.timer=w.schedule(this._boundDispatch)));b.setDirty(a)},propertyHasChanged:function(a,
b){if(this.hasBindings(a))for(var d=this.bindings[a],c=0,e=d.length;c<e;c++)d[c].fn.call(this,d[c].key,b)},watch:function(a,b){var d=this.obj,c=this.properties,e=this.watchers[a],h;Array.isArray(a)?h=a:-1<a.indexOf(",")&&(h=a.split(/\s*,\s*/));if(h){for(var g=n.get(),d=0;a=h[d++];)g.push(this.watch(a,b));return{handles:g,remove:s(function(){for(var a=0,b=g.length;a<b;a++)g[a].remove();n.put(g)})}}if(-1<a.indexOf("."))return A(d,a,b);var f=u.get();f.fn=b;e?(e.isDirty=!0,e.callbacks.push(f)):(this._defineProperty(a),
this.get(a,!0),this.watchers[a]=e={isDirty:!0,callbacks:[f]},c[a].copy&&(e.oldValues=new y(c[a].copy)));return{remove:s(function(){f.removed=!0;e.callbacks.splice(e.callbacks.indexOf(f),1);u.put(f)})}},dispatch:function(){this.timer=null;var a=this.obj,b=this.notifications,d=this.watchers,c,e,h,g,f,l,p,m;this.notifications=this._notificationsPool.get();var k=n.get();for(e in b)if(g=b[e]){b[e]=null;k.length=0;p=this.get(e);m=d[e].oldValues;for(f=0;h=g[f];f++){if(!x.equals(h.oldValue,p))for(l=0;c=h.callbacks[l];l++)!c.isExecuting&&
(!c.removed&&-1===k.indexOf(c))&&(k.push(c),c.isExecuting=!0,c.fn.call(a,p,h.oldValue,e,a),c.isExecuting=!1);v.put(h)}m&&m.reset();n.put(g)}this._notificationsPool.put(b);n.put(k)},_defineProperty:function(a,b){var d=this.obj,c=this.properties,e=c[a],h,g=!1;if(e)return e;var f=k.getPropertyOwner(d,a);f&&(e=k(f).mixin.properties[a]);e||(B.call(this.obj,a)&&(h=this.obj[a],delete this.obj[a],g=!0),b?e=k.defineProperty(this.obj,a):(e=new z(a,{value:k.getPropertyOwnerValue(d,a)}),Object.defineProperty(d,
a,e.getDescriptor())),g&&this.cache.set(a,h));return c[a]=e},_ensureType:function(a,b){b&&(a.type&&!(b instanceof a.type))&&(b=new a.type(b));return b}};return q});