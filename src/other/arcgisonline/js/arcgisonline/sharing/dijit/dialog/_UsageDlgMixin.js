// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
//>>built
define("arcgisonline/sharing/dijit/dialog/_UsageDlgMixin",["dijit","dojo","dojox","dojo/require!dojox/lang/functional,dojo/store/Observable,dojo/store/Memory,dojox/charting/StoreSeries,dojox/charting/widget/Chart2D,dojox/charting/themes/ThreeD,dojox/charting/action2d/MouseZoomAndPan,dojox/charting/action2d/TouchZoomAndPan,dojox/charting/action2d/MouseIndicator,dojo/on,dojo/mouse"],function(l,c,h){c.provide("arcgisonline.sharing.dijit.dialog._UsageDlgMixin");c.require("dojox.lang.functional");c.require("dojo.store.Observable");
c.require("dojo.store.Memory");c.require("dojox.charting.StoreSeries");c.require("dojox.charting.widget.Chart2D");c.require("dojox.charting.themes.ThreeD");c.require("dojox.charting.action2d.MouseZoomAndPan");c.require("dojox.charting.action2d.TouchZoomAndPan");c.require("dojox.charting.action2d.MouseIndicator");c.require("dojo.on");c.require("dojo.mouse");c.declare("arcgisonline.sharing.dijit.dialog._UsageDlgMixin",null,{_prepareStores:function(){this._dateQueries=[{id:"last24hours",selected:!0,
label:this.i18n.last24Hours,value:"last24hours"},{id:"last7days",label:this.i18n.last7Days,value:"last7days"},{id:"last30days",label:this.i18n.last30Days,value:"last30days"},{id:"curmo",label:this.i18n.currentMonth,value:"curmo",param:{startTime:this._getFirstDay(),endTime:this._getToday(),period:(new Date).getDate()-1+"d"}}];this._creditFilterOptions="views"===this.stype?[{label:this.i18n.views,value:"num"}]:[{label:this.i18n.num,value:"num"},{label:this.i18n.stg,value:"stg"}];this._startQueryDate=
new Date((new Date).setDate((new Date(this._getToday())).getDate()-60));this._dataCollectionStartDate=new Date(this._startQueryDate);this._dateQueriesStore=new c.store.Memory({data:{identifier:"id",items:this._dateQueries}});this._creditDetailsStore=new c.store.Observable(new c.store.Memory({data:{label:"alias",identifier:"id",items:[]}}));this._seriesOrder=[];this._isAdmin=(this._currentUser=this._util.getUser())&&this._currentUser.accountId&&"account_admin"===this._currentUser.role},_prepareDateQueries:function(a){a=
new Date(this._getFirstDay(new Date(a)));a=a>=this._dataCollectionStartDate?a:this._dataCollectionStartDate;var b=new Date,d;d={};for(b.setMonth(b.getMonth()-1);a<b;)"ja"===c.locale?(d=c.date.locale.format(b,{selector:"date",formatLength:"long"}),d=d.substr(0,8<b.getMonth()?8:7)):d=c.date.locale.format(b,{selector:"date",formatLength:"short",datePattern:"MMMM_yyy"}),d={id:d,label:d.replace("_"," "),value:d,param:{startTime:this._getFirstDay(b),endTime:this._getLastDay(b),period:"1d"}},this._dateQueriesStore.put(d),
b.setMonth(b.getMonth()-1);this._dateQueriesStore.put({id:"custom",label:this.i18n.customDates,value:"custom"})},_getDateQuery:function(a){var b=null;switch(a){case "last24hours":b=c.mixin(this._getTime(24,"h"),{period:"1h"});break;case "last7days":b=c.mixin(this._getTime(7,"d"),{period:"1d"});break;case "last30days":b=c.mixin(this._getTime(30,"d"),{period:"1d"});break;case "curmo":b={startTime:this._getFirstDay(),endTime:this._getGMTEndToday(),period:"1d"};break;default:b=this._dateQueriesStore.get(a).param}return b},
_getGMTEndToday:function(){var a=new Date((new Date).getTime()+6E4*(new Date).getTimezoneOffset()),a=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate()));a.setTime(a.getTime()+864E5);return a.getTime()},_getTime:function(a,b,d){var c=d||new Date;d=new Date(c);c=new Date(c);"d"===b?(c=this._getGMTEndToday(),d=new Date(c-864E5*a)):"h"===b&&d.setHours(c.getHours()-a+1);return{startTime:(new Date(d)).getTime(),endTime:(new Date(c)).getTime()}},_getFirstDay:function(a){a=a||new Date;return Date.UTC(a.getFullYear(),
a.getMonth(),1)},_getLastDay:function(a){a=a||new Date;return Date.UTC(a.getFullYear(),a.getMonth()+1,1)},_getToday:function(a){a=a||new Date;return(new Date(a.getFullYear(),a.getMonth(),a.getDate()+1,0,0,0,-1)).getTime()},_getXAxisLabel:function(a,b){var d=new Date(a+6E4*(new Date).getTimezoneOffset()),e=d;-1<b.indexOf("m")?e=c.date.locale.format(d,{selector:"date",formatLength:"short",datePattern:"MMMM"}):-1<b.indexOf("d")?e=this._formatDayLabel(d):-1<b.indexOf("h")&&(e=c.date.locale.format(d,{selector:"date",
formatLength:"short",datePattern:"k"}));return e},_getXAxis:function(a){var b=new Date(a.startTime+6E4*(new Date).getTimezoneOffset()),d=new Date(a.endTime+6E4*(new Date).getTimezoneOffset());a=a.period;var e=1,f=[];if(-1<a.indexOf("y"))console.log("year");else if(-1<a.indexOf("m"))for(;b<=d;)f.push({value:c.date.locale.format(b,{selector:"date",formatLength:"short",datePattern:"MMMM"})}),b.setMonth(b.getMonth()+1);else if(-1<a.indexOf("d"))for(d=d.setDate(d.getDate()+1);b<=d;)f.push({value:e++,text:this._formatDayLabel(b)}),
b.setDate(b.getDate()+1);else if(-1<a.indexOf("h"))for(d=d.setHours(d.getHours()+1);b<=d;)f.push({value:e++,text:c.date.locale.format(b,{selector:"date",formatLength:"short",datePattern:"k"})}),b.setHours(b.getHours()+1);return{data:f,max:f.length,min:1}},_formatDayLabel:function(a){var b=c.date.locale.format(a,{selector:"date",formatLength:"short",datePattern:"d"});a=c.date.locale.format(a,{selector:"date",formatLength:"short",datePattern:"EEE"});return b+(c.isIE||7<=c.has("trident")&&void 0===c.isIE?
" - ":"\x3cbr/\x3e")+a},_getYAxis:function(a,b){var d=this._creditDetailsStore.get(a),e,f,d=d&&d[b]||[];"bw"===b&&(d=c.map(d,function(a){return!a?0:c.number.round(a/1048576,3)}));f=1.1*h.lang.functional.reduce(d,"Math.max(a,b)")||1;e=h.lang.functional.reduce(d,"Math.min(a,b)")||0;return{data:d,max:1>f?1:f,min:1>e?0:e}},_postProcessItem:function(a,b){a.id=a.name||this.i18n.all;c.forEach(b,c.hitch(this,function(b){a[b]=c.map(a[b],"return dojo.number.round(Number(item[1] || 0), 2);");a[b+"_total"]=c.number.round(h.lang.functional.reduce(a[b],
"+")||0,2)}));var d=this._creditDetailsStore.get(a.id);a=c.mixin(d,a);a.visible=a.visible||this._selectedServices&&-1!==c.indexOf(this._selectedServices,a.id)||!1;this._creditDetailsStore.put(a);return a},_clearUsageChart:function(){this._uChart&&(this._onMouseIndicatorChange.remove(),this._mouseIndicatorTooltip.close(),this._mouseIndicatorTooltip.destroy(),this._mouseIndicator.destroy(),this._uChart.destroy(),this._uChart=null)},_createUsageChart:function(a,b,d,e){this._uChart&&(this._onMouseOut.remove(),
this._onMouseIndicatorChange.remove(),this._mouseIndicatorTooltip.close(),this._mouseIndicatorTooltip.destroy(),this._mouseIndicator.destroy(),this._uChart.destroy(),this._uChart=null);var f=[],g=[],n=0;c.forEach(a[0][b],c.hitch(this,function(a){f.push(this._getXAxisLabel(Number(a[0]),d.period));g.push(Number(a[1]));Number(a[1])>n&&(n=Number(a[1]))}));var k=this._uChart=new h.charting.Chart2D(e);k.addPlot("default",{type:h.charting.plot2d.Lines,markers:!0});k.addAxis("x",{includeZero:!1,labels:f,
minorTicks:!1,fontColor:"#A6A6A6",font:"normal normal normal 1.0em 'Lucida Grande', 'Segoe UI', 'Arial', sans-serif",majorTickStep:1,stroke:{color:"#D5D5D5",width:1},max:f.length+0.5,labelFunc:c.hitch(this,function(a,b){return f[b-1]||" "})});k.addAxis("y",{vertical:!0,leftBottom:!0,includeZero:!0,majorLabels:!0,minorTicks:!1,minorLabels:!1,natural:!0,font:"normal normal normal 1.0em 'Lucida Grande', 'Segoe UI', 'Arial', sans-serif",fontColor:"#A6A6A6",max:Number(n+2)});k.addSeries("Series A",g,{stroke:{color:"#D4D4D4",
width:2},fill:"#56A5DB"});this._mouseIndicator=new h.charting.action2d.MouseIndicator(k,"default",{series:"Series A",lines:!1,labels:!1,markers:!1,start:!1,stroke:{type:"stroke",color:"#56A5DB",width:2},fill:"#56A5DB",fontColor:"#FFFFFF",markerFill:"#A6A6A6",markerOutline:{type:"stroke",color:"#56A5DB",width:2},mouseOver:!0});this._mouseIndicatorTooltip=new l.Tooltip;this._onMouseIndicatorChange=c.on(this._mouseIndicator,"Change",c.hitch(this,function(c){if(c.label){var d=k.getPlot("default").toPage({x:c.start.x,
y:p});d.w=1;d.h=1;this._mouseIndicatorTooltip.label=this._formatValue(c.start.y,a[0][b][c.start.x-1][0]);this._mouseIndicatorTooltip.position=["above-centered"];m?(l.Tooltip._masterTT.containerNode.innerHTML=this._mouseIndicatorTooltip.label,l.place.around(l.Tooltip._masterTT.domNode,d,["above-centered"])):(m=!0,this._mouseIndicatorTooltip.open(d))}else this._mouseIndicatorTooltip.close(),m=!1}));k.render();var p=k.getAxis("y").getScaler().bounds.to,m=!1;this._onMouseOut=c.on(e,c.mouse.leave,c.hitch(this,
function(a){this._mouseIndicatorTooltip.close();m=!1}))},_createLineChart:function(a){this._lineChart=(new h.charting.Chart2D(a)).setTheme(h.charting.themes.ThreeD).addAxis("y",{min:0,max:1,vertical:!0}).addPlot("default",{type:"Lines",markers:!0,tension:"S"});new h.charting.action2d.Tooltip(this._lineChart,"default",{text:c.hitch(this,function(a){var d,e=a.run&&a.run.data&&a.run.data[a.index],f=this._selectCredit?this._selectCredit.get("value"):"",g=this._creditDetails;g[f]&&(g[f][a.index]&&g[f][a.index].length)&&
(d=new Date(parseInt(g[f][a.index][0],10)+6E4*(new Date).getTimezoneOffset()),d.setDate(d.getDate()));g.stype=g.stype||this.stype;a=-1!==g.stype.indexOf("routing")?"routes":-1!==g.stype.indexOf("geocode")?"locations":-1!==g.stype.indexOf("tiles")?"tiles":-1!==g.stype.indexOf("features")?"features":-1!==g.stype.indexOf("demogmaps")?"maps":-1!==g.stype.indexOf("geoenrich")?"queries":-1!==g.stype.indexOf("views")?"viewstooltip":"";return this._formatCreditTooltip(f,c.number.format(e,{pattern:"#,###,###,###.##"}),
d,a)})});new h.charting.action2d.Magnify(this._lineChart,"default");esri.isTouchEnabled?new h.charting.action2d.TouchZoomAndPan(this._lineChart,"default"):new h.charting.action2d.MouseZoomAndPan(this._lineChart,"default");this._lineChart.render();this._lineLegend=new h.charting.widget.Legend({"class":"legend details esriFloatLeading",chart:this._lineChart,horizontal:2,outline:!1},this._lineLegend);return this._lineChart},_formatValue:function(a,b){var d=this._selectCredit?this._selectCredit.get("value"):
"",e=this._creditDetails;b&&(b=new Date(Number(b)+6E4*(new Date).getTimezoneOffset()),b.setDate(b.getDate()));e.stype=e.stype||this.stype;e=-1!==e.stype.indexOf("routing")?"routes":-1!==e.stype.indexOf("geocode")?"locations":-1!==e.stype.indexOf("tiles")?"tiles":-1!==e.stype.indexOf("features")?"features":-1!==e.stype.indexOf("demogmaps")?"maps":-1!==e.stype.indexOf("geoenrich")?"queries":-1!==e.stype.indexOf("views")?"viewstooltip":"";return this._formatCreditTooltip(d,c.number.format(a,{pattern:"#,###,###,###.##"}),
b,e)},_formatCreditTooltip:function(a,b,d,e){var f;d&&(f=c.date.locale.format(d,{datePattern:"yyyy-MM-dd",selector:"date"})+" GMT");"bw"===a?b=esri.substitute({units:b},this.i18n.mbyte):"num"===a?b=esri.substitute({units:b},this.i18n[e]||this.i18n.requeststooltip):"credits"===a?b=esri.substitute({units:b},this.i18n.creditstooltip):"views"===a&&(b=esri.substitute({units:b},this.i18n.viewstooltip));return'\x3cdiv style\x3d"text-align: center"\x3e'+b+(f?"\x3cbr /\x3e"+f:"")+"\x3c/div\x3e"},_formatNumber:function(a){return c.number.format(parseInt(a,
10),{pattern:"#,###,###,##0"})},_formatBytes:function(a,b){return c.number.format(b/("mbyte"===a?1048576:1073741824),{pattern:"#,###,###,###.##"})},_toFormat:function(a,b){if(b)return"num"===a?this._formatNumber(b):this._formatBytes(a,b)},_resetLineChart:function(){for(var a in this._lineChart.runs)this._lineChart.removeSeries(a)}})});